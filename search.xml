<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
    
    <entry>
      <title><![CDATA[k8s滚动升级(RollingUpdate)]]></title>
      <url>http://www.yfshare.vip/2018/05/28/k8s%E6%BB%9A%E5%8A%A8%E5%8D%87%E7%BA%A7-RollingUpdate/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>kubernets scheduler主要负责的工作是：接受API Server创建的新Pod，并为其安排一个主机，将信息写入etcd中。<br><a id="more"></a></p>
<h4 id="调度流程"><a href="#调度流程" class="headerlink" title="调度流程"></a>调度流程</h4><p>kubernetes调度器通过API Server查找还未分配主机的Pod，并尝试为这些Pod分配主机。  </p>
<ul>
<li>客户端提交创建请求，可以通过API Server的Restful API，也可以使用kubectl命令行工具。支持的数据类型包括JSON和YAML  </li>
<li>API Server处理用户请求，存储Pod数据到etcd  </li>
<li>调度器通过API Server查看未绑定的Pod。尝试为Pod分配主机  </li>
<li>过滤主机：调度器用一组规则过滤掉不符合要求的主机。比如Pod指定了所需要的资源量，那么可用资源比Pod需要的资源量少的主机会被过滤掉  </li>
<li>主机打分：对第一步筛选出的符合要求的主机进行打分，在主机打分阶段，调度器会考虑一些整体优化策略，比如把容一个Replication Controller的副本分布到不同的主机上，使用最低负载的主机等  </li>
<li>选择主机：选择打分最高的主机，进行binding操作，结果存储到etcd中  </li>
<li>所选主机对于的kubelet根据调度结果执行Pod创建操作  </li>
</ul>
<p>kubernetes中实现的过滤规则主要包括以下几种(在 <code>kubernetes/plugin/pkg/scheduler/algorithm/predicates</code> 中实现)：<br>参考：<a href="https://blog.csdn.net/horsefoot/article/details/51263364" target="_blank" rel="external">https://blog.csdn.net/horsefoot/article/details/51263364</a>  </p>
<ul>
<li><code>NoDiskConflict</code>：检查在此主机上是否存在卷冲突。如果这个主机已经挂载了卷，其它同样使用这个卷的Pod不能调度到这个主机上。  </li>
<li><code>NoVolumeZoneConflict</code>：检查给定的zone限制前提下，检查如果在此主机上部署Pod是否存在卷冲突。  </li>
<li><code>PodFitsResources</code>：检查主机的资源是否满足Pod的需求。根据实际已经分配的资源量做调度，而不是使用已实际使用的资源量做调度。  </li>
<li><code>PodFitsHostPorts</code>：检查Pod内每一个容器所需的HostPort是否已被其它容器占用。如果有所需的HostPort不满足需求，那么Pod不能调度到这个主机上。  </li>
<li><code>HostName</code>：检查主机名称是不是Pod指定的HostName。  </li>
<li><code>MatchNodeSelector</code>：检查主机的标签是否满足Pod的<em>nodeSelector</em>属性需求。  </li>
<li><code>MaxEBSVolumeCount</code>：确保已挂载的EBS存储卷不超过设置的最大值，默认值是39。它会检查直接使用的存储卷，和间接使用这种类型存储的PVC。计算不同卷的总目，如果新的Pod部署上去后卷的数目会超过设置的最大值，那么Pod不能调度到这个主机上。  </li>
<li><code>MaxGCEPDVolumeCount</code>：确保已挂载的GCE存储卷不超过设置的最大值，默认值是16。规则同上。  </li>
</ul>
<h4 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h4><p>环境：<br>　　　k8s v1.9.2<br>　　　centos v7.4<br>　　　tomcat v8.0/9.0<br>　　　docker v18.05.0-ce  </p>
<table>
<thead>
<tr>
<th>节点名称</th>
<th>IP</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>KUBE-MASTER+ETCD1</td>
<td>192.168.1.201</td>
<td>部署nginx反向代理</td>
</tr>
<tr>
<td>KUBE-ETCD2</td>
<td>192.168.1.202</td>
<td>-</td>
</tr>
<tr>
<td>KUBE-ETCD3</td>
<td>192.168.1.203</td>
<td>-</td>
</tr>
<tr>
<td>KUBE-NODE1</td>
<td>192.168.1.204</td>
<td>-</td>
</tr>
<tr>
<td>KUBE-NODE2</td>
<td>192.168.1.205</td>
<td>-</td>
</tr>
<tr>
<td>KUBE-NODE3</td>
<td>192.168.1.206</td>
<td>-</td>
</tr>
</tbody>
</table>
<h4 id="RollingUpdate"><a href="#RollingUpdate" class="headerlink" title="RollingUpdate"></a>RollingUpdate</h4><p>查看tomcat编排文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># cat tomcat.yml </span></div><div class="line">apiVersion: apps/v1beta2</div><div class="line">kind: Deployment</div><div class="line">metadata:</div><div class="line">  name: tomcat-deployment</div><div class="line">  namespace: web</div><div class="line">spec:</div><div class="line">  replicas: 2</div><div class="line">  selector:</div><div class="line">    matchLabels: </div><div class="line">      app: tomcat</div><div class="line">  template:</div><div class="line">    metadata:</div><div class="line">      labels: </div><div class="line">        app: tomcat</div><div class="line">    spec:</div><div class="line">      nodeSelector:</div><div class="line">        nodelabel: tomcat</div><div class="line">      containers:</div><div class="line">      - name: tomcat</div><div class="line">        image: tomcat:8.0</div><div class="line">        imagePullPolicy: Always</div><div class="line">        ports:</div><div class="line">          - containerPort: 8080</div><div class="line">        volumeMounts:</div><div class="line">          - name: time</div><div class="line">            mountPath: <span class="string">"/etc/localtime"</span></div><div class="line">            <span class="built_in">read</span>Only: <span class="literal">true</span></div><div class="line">      volumes:</div><div class="line">        - name: time</div><div class="line">          hostPath:</div><div class="line">            path: <span class="string">"/etc/localtime"</span></div><div class="line">---</div><div class="line">apiVersion: v1</div><div class="line">kind: Service</div><div class="line">metadata:</div><div class="line">  name: tomcat-service</div><div class="line">  namespace: web</div><div class="line">  labels:</div><div class="line">    app: tomcat-service</div><div class="line">spec:</div><div class="line">  <span class="built_in">type</span>: NodePort</div><div class="line">  selector:</div><div class="line">    app: tomcat</div><div class="line">  ports:</div><div class="line">  - port: 8080</div><div class="line">    nodePort: 38080</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>查看k8s节点信息：<br>这里应用<code>replicas: 2</code>且固定了端口，所以Node数必须比应用个数大一个，否则会失败<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># kubectl get nodes</span></div><div class="line">NAME            STATUS    ROLES     AGE       VERSION</div><div class="line">192.168.1.204   Ready     &lt;none&gt;    1d        v1.9.2</div><div class="line">192.168.1.205   Ready     &lt;none&gt;    1d        v1.9.2</div><div class="line">192.168.1.206   Ready     &lt;none&gt;    5h        v1.9.2</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>应用tomcat编排文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># kubectl label node 192.168.1.204 192.168.1.205 192.168.1.206 "nodelabel=tomcat"</span></div><div class="line">[root@localhost ~]<span class="comment"># kubectl create namespace web</span></div><div class="line">[root@localhost ~]<span class="comment"># kubectl apply -f tomcat.yml</span></div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment"># kubectl get pod  -n web -o wide</span></div><div class="line">NAME                                 READY     STATUS    RESTARTS   AGE       IP            NODE</div><div class="line">tomcat-deployment-5768d76c66-jwlhp   1/1       Running   0          46s       172.30.5.2    192.168.1.205</div><div class="line">tomcat-deployment-5768d76c66-sxcj6   1/1       Running   0          46s       172.30.79.2   192.168.1.204</div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line">[root@localhost ~]<span class="comment"># kubectl get svc  -n web -o wide</span></div><div class="line">NAME             TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE       SELECTOR</div><div class="line">tomcat-service   NodePort   172.16.30.72   &lt;none&gt;        8080:38080/TCP   21s       app=tomcat</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>查看应用部署状态：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># kubectl rollout status deployment tomcat-deployment --namespace=web</span></div><div class="line">deployment <span class="string">"tomcat-deployment"</span> successfully rolled out</div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#升级前tomcat为8.0版本</span></div><div class="line">[root@localhost ~]<span class="comment"># kubectl describe pod tomcat-deployment-5768d76c66-jwlhp -n web | grep -i 'image:'</span></div><div class="line">    Image:          tomcat:8.0</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>升级应用：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># kubectl set image deployment tomcat-deployment tomcat=tomcat:9.0 --namespace=web --record</span></div><div class="line">deployment <span class="string">"tomcat-deployment"</span> image updated</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>查看升级结果：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># kubectl get pod -n web -o wide</span></div><div class="line">NAME                                 READY     STATUS    RESTARTS   AGE       IP            NODE</div><div class="line">tomcat-deployment-54b6<span class="built_in">fc</span>9b99-6jr2x   1/1       Running   0          1m        172.30.79.3   192.168.1.204</div><div class="line">tomcat-deployment-54b6<span class="built_in">fc</span>9b99-c6rs9   1/1       Running   0          1m        172.30.27.2   192.168.1.206</div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line">[root@localhost ~]<span class="comment"># kubectl rollout status deployment tomcat-deployment --namespace=web</span></div><div class="line">Waiting <span class="keyword">for</span> rollout to finish: 1 out of 2 new replicas have been updated...</div><div class="line">Waiting <span class="keyword">for</span> rollout to finish: 1 out of 2 new replicas have been updated...</div><div class="line">Waiting <span class="keyword">for</span> rollout to finish: 1 out of 2 new replicas have been updated...</div><div class="line">Waiting <span class="keyword">for</span> rollout to finish: 1 old replicas are pending termination...</div><div class="line">Waiting <span class="keyword">for</span> rollout to finish: 1 old replicas are pending termination...</div><div class="line">deployment <span class="string">"tomcat-deployment"</span> successfully rolled out</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># kubectl describe deployment tomcat-deployment --namespace=web</span></div><div class="line">Name:                   tomcat-deployment</div><div class="line">Namespace:              web</div><div class="line">CreationTimestamp:      Mon, 28 May 2018 17:28:27 +0800</div><div class="line">Labels:                 app=tomcat</div><div class="line">Annotations:            deployment.kubernetes.io/revision=2</div><div class="line">                        kubectl.kubernetes.io/last-applied-configuration=&#123;<span class="string">"apiVersion"</span>:<span class="string">"apps/v1beta2"</span>,<span class="string">"kind"</span>:<span class="string">"Deployment"</span>,<span class="string">"metadata"</span>:&#123;<span class="string">"annotations"</span>:&#123;&#125;,<span class="string">"name"</span>:<span class="string">"tomcat-deployment"</span>,<span class="string">"namespace"</span>:<span class="string">"web"</span>&#125;,<span class="string">"spec"</span>:&#123;<span class="string">"replicas"</span>:2,<span class="string">"selec...                        kubernetes.io/change-cause=kubectl set image deployment tomcat-deployment tomcat=tomcat:9.0 --namespace=web --record=trueSelector:               app=tomcat</span></div><div class="line">Replicas:               2 desired | 2 updated | 2 total | 2 available | 0 unavailable</div><div class="line">StrategyType:           RollingUpdate</div><div class="line">MinReadySeconds:        0</div><div class="line">RollingUpdateStrategy:  25% max unavailable, 25% max surge</div><div class="line">Pod Template:</div><div class="line">  Labels:  app=tomcat</div><div class="line">  Containers:</div><div class="line">   tomcat:</div><div class="line">    Image:        tomcat:9.0</div><div class="line">    Port:         8080/TCP</div><div class="line">    Environment:  &lt;none&gt;</div><div class="line">    Mounts:</div><div class="line">      /etc/localtime from time (ro)</div><div class="line">  Volumes:</div><div class="line">   time:</div><div class="line">    Type:          HostPath (bare host directory volume)</div><div class="line">    Path:          /etc/localtime</div><div class="line">    HostPathType:  </div><div class="line">Conditions:</div><div class="line">  Type           Status  Reason</div><div class="line">  ----           ------  ------</div><div class="line">  Available      True    MinimumReplicasAvailable</div><div class="line">  Progressing    True    NewReplicaSetAvailable</div><div class="line">OldReplicaSets:  &lt;none&gt;</div><div class="line">NewReplicaSet:   tomcat-deployment-54b6fc9b99 (2/2 replicas created)</div><div class="line">Events:</div><div class="line">  Type    Reason             Age   From                   Message</div><div class="line">  ----    ------             ----  ----                   -------</div><div class="line">  Normal  ScalingReplicaSet  4m    deployment-controller  Scaled up replica set tomcat-deployment-5768d76c66 to 2</div><div class="line">  Normal  ScalingReplicaSet  1m    deployment-controller  Scaled up replica set tomcat-deployment-54b6fc9b99 to 1</div><div class="line">  Normal  ScalingReplicaSet  1m    deployment-controller  Scaled down replica set tomcat-deployment-5768d76c66 to 1</div><div class="line">  Normal  ScalingReplicaSet  1m    deployment-controller  Scaled up replica set tomcat-deployment-54b6fc9b99 to 2</div><div class="line">  Normal  ScalingReplicaSet  52s   deployment-controller  Scaled down replica set tomcat-deployment-5768d76c66 to 0</div><div class="line">[root@localhost ~]#</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#tomcat成功升级到9.0版本</span></div><div class="line">[root@localhost ~]<span class="comment"># kubectl describe pod tomcat-deployment-54b6fc9b99-6jr2x -n web | grep -i 'image:'</span></div><div class="line">    Image:          tomcat:9.0</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>查看deployments版本：<br>由于之前在升级(set image)时添加<code>-record</code>参数，故在查看历史版本时会记录操作的指令<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># kubectl rollout history deployment tomcat-deployment --namespace=web</span></div><div class="line">deployments <span class="string">"tomcat-deployment"</span></div><div class="line">REVISION  CHANGE-CAUSE</div><div class="line">1         &lt;none&gt;</div><div class="line">2         kubectl <span class="built_in">set</span> image deployment tomcat-deployment tomcat=tomcat:9.0 --namespace=web --record=<span class="literal">true</span></div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<h4 id="版本回滚"><a href="#版本回滚" class="headerlink" title="版本回滚"></a>版本回滚</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># kubectl rollout undo deployment tomcat-deployment --namespace=web --to-revision=1</span></div><div class="line">deployment <span class="string">"tomcat-deployment"</span></div><div class="line">[root@localhost ~]<span class="comment"># kubectl rollout history deployment tomcat-deployment --namespace=web</span></div><div class="line">deployments <span class="string">"tomcat-deployment"</span></div><div class="line">REVISION  CHANGE-CAUSE</div><div class="line">2         kubectl <span class="built_in">set</span> image deployment tomcat-deployment tomcat=tomcat:9.0 --namespace=web --record=<span class="literal">true</span></div><div class="line">3         &lt;none&gt;</div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>查看回滚版本结果：<br>tomcat成功回退到8.0版本了<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># kubectl get pod -n web -o wide</span></div><div class="line">NAME                                 READY     STATUS    RESTARTS   AGE       IP            NODE</div><div class="line">tomcat-deployment-5768d76c66-bjwlc   1/1       Running   0          3m        172.30.5.2    192.168.1.205</div><div class="line">tomcat-deployment-5768d76c66-bz5rf   1/1       Running   0          2m        172.30.79.2   192.168.1.204</div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line">[root@localhost ~]<span class="comment"># kubectl describe pod tomcat-deployment-5768d76c66-bjwlc -n web | grep -i 'image:'</span></div><div class="line">    Image:          tomcat:8.0</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>查看版本回滚历史：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># kubectl describe deployment tomcat-deployment --namespace=web</span></div><div class="line">Name:                   tomcat-deployment</div><div class="line">Namespace:              web</div><div class="line">CreationTimestamp:      Mon, 28 May 2018 17:28:27 +0800</div><div class="line">Labels:                 app=tomcat</div><div class="line">Annotations:            deployment.kubernetes.io/revision=3</div><div class="line">                        kubectl.kubernetes.io/last-applied-configuration=&#123;<span class="string">"apiVersion"</span>:<span class="string">"apps/v1beta2"</span>,<span class="string">"kind"</span>:<span class="string">"Deployment"</span>,<span class="string">"metadata"</span>:&#123;<span class="string">"annotations"</span>:&#123;&#125;,<span class="string">"name"</span>:<span class="string">"tomcat-deployment"</span>,<span class="string">"namespace"</span>:<span class="string">"web"</span>&#125;,<span class="string">"spec"</span>:&#123;<span class="string">"replicas"</span>:2,<span class="string">"selec...Selector:               app=tomcat</span></div><div class="line">Replicas:               2 desired | 2 updated | 2 total | 2 available | 0 unavailable</div><div class="line">StrategyType:           RollingUpdate</div><div class="line">MinReadySeconds:        0</div><div class="line">RollingUpdateStrategy:  25% max unavailable, 25% max surge</div><div class="line">Pod Template:</div><div class="line">  Labels:  app=tomcat</div><div class="line">  Containers:</div><div class="line">   tomcat:</div><div class="line">    Image:        tomcat:8.0</div><div class="line">    Port:         8080/TCP</div><div class="line">    Environment:  &lt;none&gt;</div><div class="line">    Mounts:</div><div class="line">      /etc/localtime from time (ro)</div><div class="line">  Volumes:</div><div class="line">   time:</div><div class="line">    Type:          HostPath (bare host directory volume)</div><div class="line">    Path:          /etc/localtime</div><div class="line">    HostPathType:  </div><div class="line">Conditions:</div><div class="line">  Type           Status  Reason</div><div class="line">  ----           ------  ------</div><div class="line">  Available      True    MinimumReplicasAvailable</div><div class="line">  Progressing    True    NewReplicaSetAvailable</div><div class="line">OldReplicaSets:  &lt;none&gt;</div><div class="line">NewReplicaSet:   tomcat-deployment-5768d76c66 (2/2 replicas created)</div><div class="line">Events:</div><div class="line">  Type    Reason              Age               From                   Message</div><div class="line">  ----    ------              ----              ----                   -------</div><div class="line">  Normal  ScalingReplicaSet   55m               deployment-controller  Scaled up replica set tomcat-deployment-54b6fc9b99 to 1</div><div class="line">  Normal  ScalingReplicaSet   55m               deployment-controller  Scaled down replica set tomcat-deployment-5768d76c66 to 1</div><div class="line">  Normal  ScalingReplicaSet   55m               deployment-controller  Scaled up replica set tomcat-deployment-54b6fc9b99 to 2</div><div class="line">  Normal  ScalingReplicaSet   54m               deployment-controller  Scaled down replica set tomcat-deployment-5768d76c66 to 0</div><div class="line">  Normal  ScalingReplicaSet   4m                deployment-controller  Scaled up replica set tomcat-deployment-5768d76c66 to 1</div><div class="line">  Normal  DeploymentRollback  4m                deployment-controller  Rolled back deployment "tomcat-deployment<span class="string">" to revision 1</span></div><div class="line">  Normal  ScalingReplicaSet   4m (x2 over 58m)  deployment-controller  Scaled up replica set tomcat-deployment-5768d76c66 to 2</div><div class="line">  Normal  ScalingReplicaSet   4m                deployment-controller  Scaled down replica set tomcat-deployment-54b6fc9b99 to 1</div><div class="line">  Normal  ScalingReplicaSet   3m                deployment-controller  Scaled down replica set tomcat-deployment-54b6fc9b99 to 0</div><div class="line">[root@localhost ~]#</div></pre></td></tr></table></figure></p>
<p>注：在升级容器应用版本和回滚时，测试发现会约有2-3秒时间会出现应用访问故障。<br>测试情况为：Nginx反向代理所有Node IP地址+应用端口号。这是建议该应用端口号在K8S集群全局唯一。  </p>
<p>参数说明：<br>参考：<a href="https://www.jianshu.com/p/6bc8e0ae65d1" target="_blank" rel="external">https://www.jianshu.com/p/6bc8e0ae65d1</a>  </p>
<ul>
<li><code>maxSurge</code>与<code>maxUnavailable</code><br> maxSurge: 1 表示滚动升级时会先启动1个pod；maxUnavailable: 1 表示滚动升级时允许的最大Unavailable的pod个数</li>
<li><code>terminationGracePeriodSeconds</code><br> k8s将会给应用发送SIGTERM信号，可以用来正确、优雅地关闭应用,默认为30秒。如果需要更优雅地关闭，则可以使用k8s提供的pre-stop lifecycle hook 的配置声明，将会在发送SIGTERM之前执行  </li>
<li><code>livenessProbe</code>与<code>readinessProbe</code><br> livenessProbe是kubernetes认为该pod是存活的，不存在则需要kill掉，然后再新启动一个，以达到replicas指定的个数；readinessProbe是kubernetes认为该pod是启动成功的，这里根据每个应用的特性，自己去判断，可以执行command，也可以进行httpGet  </li>
</ul>
<h4 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q &amp; A"></a>Q &amp; A</h4><p>Question1：<br>如果报下面的错误，是k8s在调度时发现无可用的Node，因应用需要的主机端口在Node上被占用，无法完成RollingUpdate。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Warning  FailedScheduling  12s (x26 over 6m)  default-scheduler  0/2 nodes are available: 2 PodFitsHostPorts.</div></pre></td></tr></table></figure></p>
<p>思考：<br>应用升级成功，升级后NodeIP改变，怎么访问容器应用？<br>Answer：直接通过POD的IP和端口号可以访问容器应用，但POD的IP地址是不可靠的，如：当POD所在Node发生故障时，POD会被K8S重新调度到另一个POD，这是POD的IP地址就发生了变化，应用将无法访问。部署分布式容器应用，多个实例同时提供服务，容器应用前面配置一个负载均衡来实现转发。K8S的<code>kind:server</code>就是用来解决这些核心问题的。<br>测试经过：<code>kind:Deployment+service</code>部署的应用，访问任何一个NodeIP+端口号都可以，<code>kind:Deloyment</code>部署应用，访问应用只能用所在的Node IP+端口号才可以。  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2018/05/28/k8s滚动升级-RollingUpdate/">http://www.yfshare.vip/2018/05/28/k8s滚动升级-RollingUpdate/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Ansible部署TLS K8S]]></title>
      <url>http://www.yfshare.vip/2018/05/21/Ansible%E9%83%A8%E7%BD%B2TLS-K8S/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>本文是基于Ansible批量部署kubernetes集群环境<br><a id="more"></a><br>支持部署k8s环境：  </p>
<ul>
<li>ETCD集群</li>
<li>kube-master</li>
<li>kube-node</li>
<li>kube-dashboard</li>
<li>vmware-harbor仓库</li>
</ul>
<h4 id="工具包测试环境信息"><a href="#工具包测试环境信息" class="headerlink" title="工具包测试环境信息"></a>工具包测试环境信息</h4><table>
<thead>
<tr>
<th>环境</th>
<th>ip</th>
</tr>
</thead>
<tbody>
<tr>
<td>ETCD1</td>
<td>192.168.1.201</td>
</tr>
<tr>
<td>ETCD2</td>
<td>192.168.1.202</td>
</tr>
<tr>
<td>ETCD3</td>
<td>192.168.1.203</td>
</tr>
<tr>
<td>KUBE-MASTER</td>
<td>192.168.1.201</td>
</tr>
<tr>
<td>KUBE-NODE1</td>
<td>192.168.1.204</td>
</tr>
<tr>
<td>KUBE-NODE2</td>
<td>192.168.1.205</td>
</tr>
<tr>
<td>KUBE-DASHBOARD</td>
<td>192.168.1.204</td>
</tr>
<tr>
<td>VMWARE-HARBOR</td>
<td>192.168.1.205</td>
</tr>
</tbody>
</table>
<h4 id="工具版本信息"><a href="#工具版本信息" class="headerlink" title="工具版本信息"></a>工具版本信息</h4><table>
<thead>
<tr>
<th>工具</th>
<th>版本</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>centos</td>
<td>7.4</td>
<td>7版本的系统对docker性能支持更好</td>
</tr>
<tr>
<td>Ansible</td>
<td>2.5.2</td>
<td>因有些语法较新，需要ansible大于2.4</td>
</tr>
<tr>
<td>kubernetes</td>
<td>1.9.2</td>
<td>当前官方最新版为1.10</td>
</tr>
<tr>
<td>docker</td>
<td>latest</td>
<td>-</td>
</tr>
<tr>
<td>etcd</td>
<td>v3.2.15</td>
<td>-</td>
</tr>
<tr>
<td>flannel</td>
<td>v0.10.0</td>
<td>-</td>
</tr>
<tr>
<td>heapster</td>
<td>1.5.3</td>
<td>-</td>
</tr>
<tr>
<td>grafana</td>
<td>v4.4.3</td>
<td>-</td>
</tr>
<tr>
<td>influxdb</td>
<td>v1.3.3</td>
<td>-</td>
</tr>
<tr>
<td>kube-dashboard</td>
<td>v1.8.3</td>
<td>-</td>
</tr>
<tr>
<td>vmware-harbor</td>
<td>v1.5.0</td>
<td>支持k8s集群部署和单机部署，支持ip和域名部署访问</td>
</tr>
</tbody>
</table>
<h4 id="Ansible工具包内容"><a href="#Ansible工具包内容" class="headerlink" title="Ansible工具包内容"></a>Ansible工具包内容</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># tree k8s</span></div><div class="line">k8s</div><div class="line">├── 01-kube-etcd-all.yml</div><div class="line">├── 02-kube-master.yml</div><div class="line">├── 03-kube-node.yml</div><div class="line">├── 04-clean-kube-node.yml</div><div class="line">├── 05-clean-kube-master-all.yml</div><div class="line">├── 06-kube-dashboard.yml</div><div class="line">├── 07-clean-kube-dashboard.yml</div><div class="line">├── 08-vmware-harbor.yml</div><div class="line">├── 09-clean-vmware-harbor.yml</div><div class="line">├── epel-release-latest-7.noarch.rpm</div><div class="line">├── hosts</div><div class="line">├── pics</div><div class="line">│   ├── harbor.png</div><div class="line">│   └── kube-dashboard.png</div><div class="line">├── python-babel-0.9.6-8.el7.noarch.rpm</div><div class="line">├── README.md</div><div class="line">└── roles</div><div class="line">    ├── ca</div><div class="line">    │   ├── files</div><div class="line">    │   │   ├── cfssl</div><div class="line">    │   │   ├── cfssl-certinfo</div><div class="line">    │   │   └── cfssljson</div><div class="line">    │   ├── tasks</div><div class="line">    │   │   └── main.yml</div><div class="line">    │   └── templates</div><div class="line">    │       ├── ca-config.json</div><div class="line">    │       └── ca-csr.json</div><div class="line">    ├── clean-dashboard</div><div class="line">    │   └── tasks</div><div class="line">    │       └── main.yml</div><div class="line">    ├── clean-etcd</div><div class="line">    │   └── tasks</div><div class="line">    │       └── main.yml</div><div class="line">    ├── clean-master</div><div class="line">    │   └── tasks</div><div class="line">    │       └── main.yml</div><div class="line">    ├── clean-node</div><div class="line">    │   └── tasks</div><div class="line">    │       └── main.yml</div><div class="line">    ├── clean-vmware-harbor</div><div class="line">    │   └── tasks</div><div class="line">    │       └── main.yml</div><div class="line">    ├── common</div><div class="line">    │   ├── files</div><div class="line">    │   │   └── epel-release-latest-7.noarch.rpm</div><div class="line">    │   ├── tasks</div><div class="line">    │   │   └── main.yml</div><div class="line">    │   └── templates</div><div class="line">    │       ├── 20-nproc.conf</div><div class="line">    │       └── limits.conf</div><div class="line">    ├── docker</div><div class="line">    │   ├── files</div><div class="line">    │   │   ├── daemon.json</div><div class="line">    │   │   ├── docker-ce.repo</div><div class="line">    │   │   └── docker.service</div><div class="line">    │   └── tasks</div><div class="line">    │       └── main.yml</div><div class="line">    ├── etcd</div><div class="line">    │   ├── files</div><div class="line">    │   │   └── etcd-v3.2.15-linux-amd64.tar.gz</div><div class="line">    │   ├── tasks</div><div class="line">    │   │   └── main.yml</div><div class="line">    │   └── templates</div><div class="line">    │       ├── etcd-csr.json.j2</div><div class="line">    │       └── etcd.service.j2</div><div class="line">    ├── flannel</div><div class="line">    │   ├── files</div><div class="line">    │   │   └── flannel-v0.10.0-linux-amd64.tar.gz</div><div class="line">    │   ├── tasks</div><div class="line">    │   │   └── main.yml</div><div class="line">    │   └── templates</div><div class="line">    │       ├── flanneld-csr.json</div><div class="line">    │       └── flanneld.service.j2</div><div class="line">    ├── kube-client</div><div class="line">    │   ├── files</div><div class="line">    │   │   └── kubernetes-client-linux-amd64-v1.9.2.tar.gz</div><div class="line">    │   ├── tasks</div><div class="line">    │   │   └── main.yml</div><div class="line">    │   └── templates</div><div class="line">    │       └── admin-csr.json</div><div class="line">    ├── kube-dashboard</div><div class="line">    │   ├── files</div><div class="line">    │   │   ├── heapster-1.5.3.tar.gz</div><div class="line">    │   │   ├── heapster-amd64_v1.5.3.tar.gz</div><div class="line">    │   │   ├── heapster-grafana-amd64_v4.4.3.tar.gz</div><div class="line">    │   │   ├── heapster-influxdb-amd64_v1.3.3.tar.gz</div><div class="line">    │   │   ├── kubernetes-dashboard-amd64_v1.8.3.tar.gz</div><div class="line">    │   │   └── pod-infrastructure_v3.6.173.0.49.tar.gz</div><div class="line">    │   ├── tasks</div><div class="line">    │   │   └── main.yml</div><div class="line">    │   └── templates</div><div class="line">    │       └── kubernetes-dashboard.yaml</div><div class="line">    ├── kube-master</div><div class="line">    │   ├── files</div><div class="line">    │   │   └── kubernetes-server-linux-amd64-v1.9.2.tar.gz</div><div class="line">    │   ├── tasks</div><div class="line">    │   │   └── main.yml</div><div class="line">    │   └── templates</div><div class="line">    │       ├── basic-auth.csv.j2</div><div class="line">    │       ├── kube-apiserver.service.j2</div><div class="line">    │       ├── kube-controller-manager.service.j2</div><div class="line">    │       ├── kubernetes-csr.json.j2</div><div class="line">    │       ├── kube-scheduler.service.j2</div><div class="line">    │       └── token.csv.j2</div><div class="line">    ├── kube-node</div><div class="line">    │   ├── files</div><div class="line">    │   │   ├── etcd</div><div class="line">    │   │   ├── etcdctl</div><div class="line">    │   │   ├── kubelet</div><div class="line">    │   │   ├── kube-proxy</div><div class="line">    │   │   └── README.txt</div><div class="line">    │   ├── tasks</div><div class="line">    │   │   └── main.yml</div><div class="line">    │   └── templates</div><div class="line">    │       ├── kubelet.service.j2</div><div class="line">    │       ├── kube-proxy-csr.json</div><div class="line">    │       └── kube-proxy.service.j2</div><div class="line">    ├── prepare</div><div class="line">    │   ├── files</div><div class="line">    │   │   ├── cfssl</div><div class="line">    │   │   ├── cfssl-certinfo</div><div class="line">    │   │   ├── cfssljson</div><div class="line">    │   │   ├── etcd</div><div class="line">    │   │   └── etcdctl</div><div class="line">    │   └── tasks</div><div class="line">    │       └── main.yml</div><div class="line">    └── vmware-harbor</div><div class="line">        ├── files</div><div class="line">        │   ├── csr</div><div class="line">        │   ├── docker-ce.repo</div><div class="line">        │   ├── docker-compose</div><div class="line">        │   ├── docker.service</div><div class="line">        │   └── harbor-offline-installer-v1.5.0.tgz</div><div class="line">        ├── tasks</div><div class="line">        │   └── main.yml</div><div class="line">        └── templates</div><div class="line">            ├── daemon.json.j2</div><div class="line">            ├── docker-compose.yml</div><div class="line">            └── harbor.cfg.j2</div><div class="line"></div><div class="line">55 directories, 84 files</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>工具包大小：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># du -sh k8s/</span></div><div class="line">2.1G	k8s/</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<h4 id="工具包README"><a href="#工具包README" class="headerlink" title="工具包README"></a>工具包README</h4><p>本ansible脚本测试执行环境为：centos 7.4，kubernetes v1.9.2<br>Author：Jack_wang<br>Blog：<a href="http://www.yfshare.vip">http://www.yfshare.vip</a>  </p>
<h5 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h5><ol>
<li>ansible当前服务器自己root互信  </li>
<li>ansible服务器和其他所有各个节点root互信<br>命令: <code>ssh-copy-id -i ~/.ssh/id_rsa.pub root@ip</code>  </li>
</ol>
<p>注：ansible需要使用2.4以上的版本，因有些语法2.4以下不支持.<br>当前ansible版本为2.5.2。  </p>
<h5 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum -y install https://mirrors.aliyun.com/epel/epel-release-latest-7.noarch.rpm</div><div class="line">yum -y install ansible</div></pre></td></tr></table></figure>
<p>注：这里安装ansible-2.5.2时，yum源里会缺少python-babel-0.9.6-8.el7.noarch.rpm包，可以在<a href="https://pkgs.org/download/python-babel" target="_blank" rel="external">https://pkgs.org/download/python-babel</a> 这里下载.在当前目录也提供了该依赖包.<br>按要求修改hosts文件相关参数<br>操作步骤：  </p>
<ol>
<li>ansible-playbook -i hosts 01-kube-etcd-all.yml  #部署etcd  </li>
<li>ansible-playbook -i hosts 02-kube-master.yml    #部署kube-master  </li>
<li>ansible-playbook -i hosts 03-kube-node.yml      #部署kube-node  </li>
</ol>
<p>部署成功后，可执行以下命令，查看是否安装成功.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">kubectl get componentstatuses</div><div class="line">kubectl get csr</div><div class="line">kubectl get nodes</div></pre></td></tr></table></figure></p>
<p>也可以安装POD测试<br>下面提供一个测试yml文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">apiVersion: apps/v1beta2</div><div class="line">kind: Deployment</div><div class="line">metadata:</div><div class="line">  name: nginx-deployment </div><div class="line">spec:</div><div class="line">  replicas: 1 </div><div class="line">  selector:</div><div class="line">    matchLabels: </div><div class="line">      app: nginx</div><div class="line">  template:</div><div class="line">    metadata:</div><div class="line">      labels: </div><div class="line">        app: nginx</div><div class="line">    spec:</div><div class="line">     containers:</div><div class="line">     - name: nginx</div><div class="line">       image: nginx:1.14</div><div class="line">       ports:</div><div class="line">       - containerPort: 80</div></pre></td></tr></table></figure></p>
<p>保存文件为nginx-deployment.yaml  </p>
<p>执行安装POD命令，等待安装完成.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kubectl apply <span class="_">-f</span> nginx-deployment.yaml</div></pre></td></tr></table></figure></p>
<h5 id="卸载Kubernetes集群步骤"><a href="#卸载Kubernetes集群步骤" class="headerlink" title="卸载Kubernetes集群步骤"></a>卸载Kubernetes集群步骤</h5><p>按要求修改hosts文件相关参数.  </p>
<ul>
<li><p>卸载 kube-node 操作步骤：<br>只删除指定的kube-node节点.  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible-playbook -i hosts 04-clean-kube-node.yml</div></pre></td></tr></table></figure>
</li>
<li><p>卸载整个Kubernetes集群集群步骤：<br>删除整个K8s集群，包括kube-node，kube-master，etcd。  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible-playbook -i hosts 05-clean-kube-master-all.yml</div></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="部署kube-dashboard"><a href="#部署kube-dashboard" class="headerlink" title="部署kube-dashboard"></a>部署kube-dashboard</h5><p>按要求修改hosts文件相关参数.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible-playbook -i hosts 06-kube-dashboard.yml</div></pre></td></tr></table></figure></p>
<p>安装完成后，访问<a href="https://ip:8443" target="_blank" rel="external">https://ip:8443</a> 打开kube-dashboard WEB页面。访问 <a href="http://ip:3000" target="_blank" rel="external">http://ip:3000</a> 打开Grafana WEB页面。<br>配置Grafana略.</p>
<h5 id="卸载kube-dashboard"><a href="#卸载kube-dashboard" class="headerlink" title="卸载kube-dashboard"></a>卸载kube-dashboard</h5><p>按要求修改hosts文件相关参数.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible-playbook -i hosts 07-clean-kube-dashboard.yml</div></pre></td></tr></table></figure></p>
<h5 id="部署vmware-harbor-docker仓库"><a href="#部署vmware-harbor-docker仓库" class="headerlink" title="部署vmware-harbor docker仓库"></a>部署vmware-harbor docker仓库</h5><p>按要求修改hosts文件相关参数.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible-playbook -i hosts 08-vmware-harbor.yml</div></pre></td></tr></table></figure></p>
<h5 id="卸载vmware-harbor-docker仓库"><a href="#卸载vmware-harbor-docker仓库" class="headerlink" title="卸载vmware-harbor docker仓库"></a>卸载vmware-harbor docker仓库</h5><p>按要求修改hosts文件相关参数.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible-playbook -i hosts 09-clean-vmware-harbor.yml</div></pre></td></tr></table></figure></p>
<h4 id="部署结果"><a href="#部署结果" class="headerlink" title="部署结果"></a>部署结果</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># kubectl get componentstatuses</span></div><div class="line">NAME                 STATUS    MESSAGE              ERROR</div><div class="line">controller-manager   Healthy   ok                   </div><div class="line">scheduler            Healthy   ok                   </div><div class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;   </div><div class="line">etcd-1               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;   </div><div class="line">etcd-2               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;   </div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># kubectl get nodes</span></div><div class="line">NAME            STATUS    ROLES     AGE       VERSION</div><div class="line">192.168.1.204   Ready     &lt;none&gt;    3h        v1.9.2</div><div class="line">192.168.1.205   Ready     &lt;none&gt;    2m        v1.9.2</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p><img src="https://note.youdao.com/yws/api/personal/file/5A97833F75F7451DB589CFFD10C850E3?method=download&amp;shareKey=0e95e5366f21b2d6077998885cb543e4" alt="kube-dashboard"><br><img src="https://note.youdao.com/yws/api/personal/file/FB115B2A772B4173813F29B9647714D7?method=download&amp;shareKey=9e42f21481013b1bcd8e899d1931ac75" alt="vmware-harbor">  </p>
<p>如想获取该Ansible工具包，请扫描下方微信支付宝付款二维码支持下作者(100元以上请备注<code>获取Ansible部署TLS K8S工具包</code>并留下联系方式)，谢谢  </p>
<p>遇到此工具包相关问题，可联系作者QQ：838554604  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2018/05/21/Ansible部署TLS-K8S/">http://www.yfshare.vip/2018/05/21/Ansible部署TLS-K8S/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[glusterfs做持久化存储]]></title>
      <url>http://www.yfshare.vip/2018/03/17/glusterfs%E5%81%9A%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><ul>
<li>Glusterfs简介<br>GlusterFS是Scale-Out存储解决方案Gluster的核心，它是一个开源的分布式文件系统，具有强大的横向扩展能力，通过扩展能够支持数PB存储容量和处理数千客户端。GlusterFS借助TCP/IP或InfiniBandRDMA网络将物理分布的存储资源聚集在一起，使用单一全局命名空间来管理数据  <a id="more"></a></li>
<li>Glusterfs特点  <ul>
<li>扩展性和高性能<br>GlusterFS利用双重特性来提供几TB至数PB的高扩展存储解决方案。Scale-Out架构允许通过简单地增加资源来提高存储容量和性能，磁盘、计算和I/O资源都可以独立增加，支持10GbE和InfiniBand等高速网络互联。Gluster弹性哈希（ElasticHash）解除了GlusterFS对元数据服务器的需求，消除了单点故障和性能瓶颈，真正实现了并行化数据访问</li>
<li>高可用性<br>GlusterFS可以对文件进行自动复制，如镜像或多次复制，从而确保数据总是可以访问，甚至是在硬件故障的情况下也能正常访问。自我修复功能能够把数据恢复到正确的状态，而且修复是以增量的方式在后台执行，几乎不会产生性能负载。GlusterFS没有设计自己的私有数据文件格式，而是采用操作系统中主流标准的磁盘文件系统（如EXT3、ZFS）来存储文件，因此数据可以使用各种标准工具进行复制和访问</li>
<li>弹性卷管理<br>数据储存在逻辑卷中，逻辑卷可以从虚拟化的物理存储池进行独立逻辑划分而得到。存储服务器可以在线进行增加和移除，不会导致应用中断。逻辑卷可以在所有配置服务器中增长和缩减，可以在不同服务器迁移进行容量均衡，或者增加和移除系统，这些操作都可在线进行。文件系统配置更改也可以实时在线进行并应用，从而可以适应工作负载条件变化或在线性能调优</li>
</ul>
</li>
</ul>
<h4 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h4><table>
<thead>
<tr>
<th>主机名</th>
<th>IP</th>
<th>Size</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>master1.example.com</td>
<td>192.168.1.195</td>
<td>50G</td>
<td>glusterfs</td>
</tr>
<tr>
<td>master2.example.com</td>
<td>192.168.1.196</td>
<td>50G</td>
<td>glusterfs</td>
</tr>
<tr>
<td>master3.example.com</td>
<td>192.168.1.197</td>
<td>50G</td>
<td>glusterfs</td>
</tr>
<tr>
<td>node1.example.com</td>
<td>192.168.1.198</td>
<td>50G</td>
<td>glusterfs</td>
</tr>
<tr>
<td>node2.example.com</td>
<td>192.168.1.199</td>
<td>50G</td>
<td>glusterfs</td>
</tr>
</tbody>
</table>
<p>环境：<br>　　　centos 7.4<br>　　　glusterfs v3.12.6<br>　　　k8s v1.8.4  </p>
<h4 id="部署glusterfs"><a href="#部署glusterfs" class="headerlink" title="部署glusterfs"></a>部署glusterfs</h4><p>以下操作所有准备做glusterfs存储的节点均要操作<br>同步时间<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># ntpdate time.windows.com</span></div></pre></td></tr></table></figure></p>
<p>安装gluster 源<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># yum install -y centos-release-gluster</span></div></pre></td></tr></table></figure></p>
<p>安装glusterfs 组件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># yum install -y glusterfs glusterfs-server glusterfs-fuse glust</span></div></pre></td></tr></table></figure></p>
<p>创建glusterfs 工作目录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># mkdir -p /opt/glusterd</span></div></pre></td></tr></table></figure></p>
<p>修改glusterd 工作目录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># sed -i 's/var\/lib/opt/g' /etc/glusterfs/glusterd.vol</span></div></pre></td></tr></table></figure></p>
<p>启动glusterfs<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># systemctl enable glusterd</span></div><div class="line">[root@master1 ~]<span class="comment"># systemctl start glusterd</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># netstat -tunlp | grep -i glusterd</span></div><div class="line">tcp        0      0 0.0.0.0:24007           0.0.0.0:*               LISTEN      25387/glusterd      </div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>配置glusterfs<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># tail -5 /etc/hosts</span></div><div class="line">192.168.1.195 master1.example.com master1</div><div class="line">192.168.1.196 master2.example.com master2</div><div class="line">192.168.1.197 master3.example.com master3</div><div class="line">192.168.1.198 node1.example.com node1</div><div class="line">192.168.1.199 node2.example.com node2</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>开放端口<br>如果有防火墙需要打开glusterd端口24007<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># iptables -I INPUT -p tcp --dport 24007 -j ACCEPT</span></div></pre></td></tr></table></figure></p>
<p>创建存储目录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># mkdir /data/gfs_data</span></div></pre></td></tr></table></figure></p>
<p>添加节点到集群<br>执行操作的本机不需要probe 本机<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># gluster peer probe master2.example.com</span></div><div class="line">[root@master1 ~]<span class="comment"># gluster peer probe master3.example.com</span></div><div class="line">[root@master1 ~]<span class="comment"># gluster peer probe node1.example.com</span></div><div class="line">[root@master1 ~]<span class="comment"># gluster peer probe node2.example.com</span></div></pre></td></tr></table></figure></p>
<h4 id="查看集群状态"><a href="#查看集群状态" class="headerlink" title="查看集群状态"></a>查看集群状态</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># gluster peer status</span></div><div class="line">Number of Peers: 4</div><div class="line"></div><div class="line">Hostname: master2.example.com</div><div class="line">Uuid: b91ba577-cccd-43cc-918a-44e001f3d7bf</div><div class="line">State: Peer <span class="keyword">in</span> Cluster (Connected)</div><div class="line"></div><div class="line">Hostname: master3.example.com</div><div class="line">Uuid: e0652345-9817-4a08-aec0-3673723002ed</div><div class="line">State: Peer <span class="keyword">in</span> Cluster (Connected)</div><div class="line"></div><div class="line">Hostname: node1.example.com</div><div class="line">Uuid: 34b3faed-9335-41ca-9ed5-734ed140f6f3</div><div class="line">State: Peer <span class="keyword">in</span> Cluster (Connected)</div><div class="line"></div><div class="line">Hostname: node2.example.com</div><div class="line">Uuid: f1ad8a8e-1469-4558-9a35<span class="_">-f</span>07cbbc679f2</div><div class="line">State: Peer <span class="keyword">in</span> Cluster (Connected)</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h4 id="配置volume"><a href="#配置volume" class="headerlink" title="配置volume"></a>配置volume</h4><p>GlusterFS 中的volume 的模式分为：  </p>
<ul>
<li>分布卷(默认模式)：即DHT, 也叫分布卷: 将文件已hash 算法随机分布到每台服务器节点中存储  </li>
<li>复制模式：即AFR, 创建volume 时带replica x 数量: 将文件复制到replica x 个节点中  </li>
<li>条带模式：即Striped, 创建volume 时带stripe x 数量： 将文件切割成数据块，分别存储到stripe x 个节点中( 类似raid 0 )  </li>
<li>分布式条带模式：最少需要4 台服务器才能创建。创建volume 时stripe 2 server = 4 个节点： 是DHT 与Striped 的组合型  </li>
<li>分布式复制模式：最少需要4 台服务器才能创建。创建volume 时replica 2 server = 4 个节点：是DHT 与AFR 的组合型  </li>
<li>条带复制卷模式：最少需要4 台服务器才能创建。创建volume 时stripe 2 replica 2 server = 4 个节点： 是Striped 与AFR 的组合型  </li>
<li>三种模式混合： 至少需要8 台服务器才能创建。stripe 2 replica 2 ，每4 个节点组成一个组  </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># gluster volume create k8s-volume master1.example.com:/data/gfs_data/ master2.example.com:/data/gfs_data/ master3.example.com:/data/gfs_data/ node1.example.com:/data/gfs_data/ node2.example.com:/data/gfs_data/ force</span></div></pre></td></tr></table></figure>
<p>查看volume 状态<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># gluster volume info</span></div><div class="line"> </div><div class="line">Volume Name: k8s-volume</div><div class="line">Type: Distribute</div><div class="line">Volume ID: e3bdd47a<span class="_">-d</span>166-4aef-827a-5cde1d6c7d91</div><div class="line">Status: Created</div><div class="line">Snapshot Count: 0</div><div class="line">Number of Bricks: 5</div><div class="line">Transport-type: tcp</div><div class="line">Bricks:</div><div class="line">Brick1: master1.example.com:/data/gfs_data</div><div class="line">Brick2: master2.example.com:/data/gfs_data</div><div class="line">Brick3: master3.example.com:/data/gfs_data</div><div class="line">Brick4: node1.example.com:/data/gfs_data</div><div class="line">Brick5: node2.example.com:/data/gfs_data</div><div class="line">Options Reconfigured:</div><div class="line">transport.address-family: inet</div><div class="line">nfs.disable: on</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>启动分布卷<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># gluster volume start k8s-volume</span></div></pre></td></tr></table></figure></p>
<h4 id="挂载测试"><a href="#挂载测试" class="headerlink" title="挂载测试"></a>挂载测试</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># mount -t glusterfs master1.example.com:k8s-volume /media/</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># df -h</span></div><div class="line">Filesystem                      Size  Used Avail Use% Mounted on</div><div class="line">master1.example.com:k8s-volume  250G  163M  250G   1% /media</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h4 id="配置endpoints"><a href="#配置endpoints" class="headerlink" title="配置endpoints"></a>配置endpoints</h4><p>参考：<a href="https://github.com/kubernetes/kubernetes/blob/master/examples/volumes/glusterfs/glusterfs-endpoints.json" target="_blank" rel="external">https://github.com/kubernetes/kubernetes/blob/master/examples/volumes/glusterfs/glusterfs-endpoints.json</a><br><a href="https://note.youdao.com/yws/api/personal/file/30B8D024D97E49FEA5499BDAE4371AB5?method=download&amp;shareKey=329ab32250e811641622497ddeba9b71" target="_blank" rel="external">glusterfs-endpoints.json</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># wget https://raw.githubusercontent.com/kubernetes/kubernetes/master/examples/volumes/glusterfs/glusterfs-endpoints.json</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># cat glusterfs-endpoints.json </span></div><div class="line">&#123;</div><div class="line">  <span class="string">"kind"</span>: <span class="string">"Endpoints"</span>,</div><div class="line">  <span class="string">"apiVersion"</span>: <span class="string">"v1"</span>,</div><div class="line">  <span class="string">"metadata"</span>: &#123;</div><div class="line">    <span class="string">"name"</span>: <span class="string">"gfs-cluster"</span>,</div><div class="line">    <span class="comment">#"namespace": "name"    #如果指定namespace，需要提前创建namespace，kubectl create namespace name</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"subsets"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="string">"addresses"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="string">"ip"</span>: <span class="string">"192.168.1.195"</span></div><div class="line">        &#125;</div><div class="line">      ],</div><div class="line">      <span class="string">"ports"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="string">"port"</span>: 1</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="string">"addresses"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="string">"ip"</span>: <span class="string">"192.168.1.196"</span></div><div class="line">        &#125;</div><div class="line">      ],</div><div class="line">      <span class="string">"ports"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="string">"port"</span>: 1</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="string">"addresses"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="string">"ip"</span>: <span class="string">"192.168.1.197"</span></div><div class="line">        &#125;</div><div class="line">      ],</div><div class="line">      <span class="string">"ports"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="string">"port"</span>: 1</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="string">"addresses"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="string">"ip"</span>: <span class="string">"192.168.1.198"</span></div><div class="line">        &#125;</div><div class="line">      ],</div><div class="line">      <span class="string">"ports"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="string">"port"</span>: 1</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="string">"addresses"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="string">"ip"</span>: <span class="string">"192.168.1.199"</span></div><div class="line">        &#125;</div><div class="line">      ],</div><div class="line">      <span class="string">"ports"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="string">"port"</span>: 1</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl create -f glusterfs-endpoints.json</span></div></pre></td></tr></table></figure>
<h4 id="查看endpoints-信息"><a href="#查看endpoints-信息" class="headerlink" title="查看endpoints 信息"></a>查看endpoints 信息</h4><p>默认所有应用全在default的namespace中<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get Endpoints --all-namespaces</span></div><div class="line">NAMESPACE           NAME                          ENDPOINTS                                         AGE</div><div class="line">default             gfs-cluster                   192.168.2.161:1,192.168.2.162:1,192.168.2.163:1   6d</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<h4 id="创建服务"><a href="#创建服务" class="headerlink" title="创建服务"></a>创建服务</h4><p>参考：<a href="https://github.com/kubernetes/kubernetes/blob/master/examples/volumes/glusterfs/glusterfs-service.json" target="_blank" rel="external">https://github.com/kubernetes/kubernetes/blob/master/examples/volumes/glusterfs/glusterfs-service.json</a><br><a href="https://note.youdao.com/yws/api/personal/file/6D6821D34984428EAEAFBCA17128ECEF?method=download&amp;shareKey=0229a4e5bf4c14222daf69325380e3a1" target="_blank" rel="external">glusterfs-service.json</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># wget https://raw.githubusercontent.com/kubernetes/kubernetes/master/examples/volumes/glusterfs/glusterfs-service.json</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># cat glusterfs-service.json </span></div><div class="line">&#123;</div><div class="line">  <span class="string">"kind"</span>: <span class="string">"Service"</span>,</div><div class="line">  <span class="string">"apiVersion"</span>: <span class="string">"v1"</span>,</div><div class="line">  <span class="string">"metadata"</span>: &#123;</div><div class="line">    <span class="string">"name"</span>: <span class="string">"gfs-cluster"</span>,</div><div class="line">    <span class="comment">#"namespace": "name"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"spec"</span>: &#123;</div><div class="line">    <span class="string">"ports"</span>: [</div><div class="line">      &#123;<span class="string">"port"</span>: 19999&#125;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl create -f glusterfs-service.json</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get svc -o wide</span></div><div class="line">NAME                TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)       AGE       SELECTOR</div><div class="line">glusterfs-cluster   ClusterIP   172.16.170.167   &lt;none&gt;        19999/TCP     1m        &lt;none&gt;</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h4 id="创建测试pod"><a href="#创建测试pod" class="headerlink" title="创建测试pod"></a>创建测试pod</h4><p>参考：<a href="https://github.com/kubernetes/kubernetes/blob/master/examples/volumes/glusterfs/glusterfs-pod.json" target="_blank" rel="external">https://github.com/kubernetes/kubernetes/blob/master/examples/volumes/glusterfs/glusterfs-pod.json</a><br><a href="https://note.youdao.com/yws/api/personal/file/31CE9F0796004E7EA6F340F746772ECF?method=download&amp;shareKey=6cea7b602a4333727c6c7478066b674e" target="_blank" rel="external">glusterfs-pod.json</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># wget https://raw.githubusercontent.com/kubernetes/kubernetes/master/examples/volumes/glusterfs/glusterfs-pod.json</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># cat glusterfs-pod.json </span></div><div class="line">&#123;</div><div class="line">    <span class="string">"apiVersion"</span>: <span class="string">"v1"</span>,</div><div class="line">    <span class="string">"kind"</span>: <span class="string">"Pod"</span>,</div><div class="line">    <span class="string">"metadata"</span>: &#123;</div><div class="line">        <span class="string">"name"</span>: <span class="string">"glusterfs"</span></div><div class="line">        <span class="comment">#"namespace": "name"</span></div><div class="line">    &#125;,</div><div class="line">    <span class="string">"spec"</span>: &#123;</div><div class="line">        <span class="string">"containers"</span>: [</div><div class="line">            &#123;</div><div class="line">                <span class="string">"name"</span>: <span class="string">"glusterfs"</span>,</div><div class="line">                <span class="string">"image"</span>: <span class="string">"nginx"</span>,</div><div class="line">                <span class="string">"volumeMounts"</span>: [</div><div class="line">                    &#123;</div><div class="line">                        <span class="string">"mountPath"</span>: <span class="string">"/mnt/glusterfs"</span>,</div><div class="line">                        <span class="string">"name"</span>: <span class="string">"glusterfsvol"</span></div><div class="line">                    &#125;</div><div class="line">                ]</div><div class="line">            &#125;</div><div class="line">        ],</div><div class="line">        <span class="string">"volumes"</span>: [</div><div class="line">            &#123;</div><div class="line">                <span class="string">"name"</span>: <span class="string">"glusterfsvol"</span>,</div><div class="line">                <span class="string">"glusterfs"</span>: &#123;</div><div class="line">                    <span class="string">"endpoints"</span>: <span class="string">"glusterfs-cluster"</span>,</div><div class="line">                    <span class="string">"path"</span>: <span class="string">"k8s-volume"</span>,     <span class="comment">#改成创建glusterfs卷时设置的名称</span></div><div class="line">                    <span class="string">"readOnly"</span>: <span class="literal">true</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        ]</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl create -f glusterfs-pod.json</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get pods -o wide</span></div><div class="line">NAME                               READY     STATUS    RESTARTS   AGE       IP            NODE</div><div class="line">glusterfs                          1/1       Running   0          6m        172.30.41.6   192.168.1.199</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl exec glusterfs mount | grep gluster</span></div><div class="line">192.168.1.195:k8s-volume on /mnt/glusterfs <span class="built_in">type</span> fuse.glusterfs (ro,relatime,user_id=0,group_id=0,default_permissions,allow_other,max_read=131072)</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h4 id="Glusterfs持久卷管理"><a href="#Glusterfs持久卷管理" class="headerlink" title="Glusterfs持久卷管理"></a>Glusterfs持久卷管理</h4><p>注：PV和PVC是一一对应的关系，一个PV只能绑定一个PVC，如果PVC删除，对应的PV状态也会变成<code>Released</code>或者<code>Failed</code>状态，这时如果新建PVC则不能注册到以前的PV上<br>如果一个PV状态从READY(Available)变成其他状态(Bound/Released/Failed)，则不可继续被申请<br>参考：<a href="https://www.slahser.com/2017/03/22/k8s%E5%90%8E%E6%97%A5%E8%B0%88-glusterfs%E4%B8%8Epv/" target="_blank" rel="external">https://www.slahser.com/2017/03/22/k8s%E5%90%8E%E6%97%A5%E8%B0%88-glusterfs%E4%B8%8Epv/</a>  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get pv,pvc</span></div><div class="line">No resources found.</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>PersistentVolume（PV，持久卷）：对存储抽象实现，使得存储作为集群中的资源<br>PersistentVolumeClaim（PVC，持久卷申请）：PVC消费PV的资源<br>PVC 是持久卷申请  pvc 消费 pv<br>PV和PVC类似于VG和LV关系  </p>
<table>
<thead>
<tr>
<th>存储Plugin</th>
<th>ReadWriteOnce</th>
<th>ReadOnlyMany</th>
<th>ReadWriteMany</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>AWSElasticBlockStore</td>
<td>支持</td>
<td>不支持</td>
<td>不支持</td>
<td></td>
</tr>
<tr>
<td>AzureFile</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
<td></td>
</tr>
<tr>
<td>AzureDisk</td>
<td>支持</td>
<td>不支持</td>
<td>不支持</td>
<td></td>
</tr>
<tr>
<td>Cinder</td>
<td>支持</td>
<td>不支持</td>
<td>不支持</td>
<td></td>
</tr>
<tr>
<td>FlexVolume</td>
<td>支持</td>
<td>支持</td>
<td>不支持</td>
<td></td>
</tr>
<tr>
<td>Flocker</td>
<td>支持</td>
<td>不支持</td>
<td>不支持</td>
<td></td>
</tr>
<tr>
<td>GCEPersistentDisk</td>
<td>支持</td>
<td>支持</td>
<td>不支持</td>
<td></td>
</tr>
<tr>
<td>PhotonPersistentDisk</td>
<td>支持</td>
<td>不支持</td>
<td>不支持</td>
<td></td>
</tr>
<tr>
<td>Quobyte</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
<td></td>
</tr>
<tr>
<td>PortworxVolume</td>
<td>支持</td>
<td>不支持</td>
<td>支持</td>
<td></td>
</tr>
<tr>
<td>ScaleIO</td>
<td>支持</td>
<td>支持</td>
<td>不支持</td>
<td></td>
</tr>
<tr>
<td>FC(Fibre Channel)</td>
<td>支持</td>
<td>支持</td>
<td>不支持</td>
<td></td>
</tr>
<tr>
<td>NFS</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
<td></td>
</tr>
<tr>
<td>ISCSI</td>
<td>支持</td>
<td>支持</td>
<td>不支持</td>
<td></td>
</tr>
<tr>
<td>RBD(Ceph Block Device)</td>
<td>支持</td>
<td>支持</td>
<td>不支持</td>
<td></td>
</tr>
<tr>
<td>CephFS</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
<td></td>
</tr>
<tr>
<td>Cinder(OpenStack Block Storage)</td>
<td>支持</td>
<td>不支持</td>
<td>不支持</td>
<td></td>
</tr>
<tr>
<td>Glusterfs</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
<td></td>
</tr>
<tr>
<td>VsphereVolume</td>
<td>支持</td>
<td>不支持</td>
<td>不支持</td>
<td></td>
</tr>
<tr>
<td>HostPath</td>
<td>支持</td>
<td>不支持</td>
<td>不支持</td>
<td>只支持单节点，不支持跨节点</td>
</tr>
</tbody>
</table>
<p>三种PV的访问模式  </p>
<ul>
<li>ReadWriteOnce：是最基本的方式，可读可写，但只支持被单个Pod挂载  </li>
<li>ReadOnlyMany：可以以只读的方式被多个Pod挂载  </li>
<li>ReadWriteMany：这种存储可以以读写的方式被多个Pod共享  </li>
</ul>
<p>参考：<a href="https://zhuanlan.zhihu.com/p/29706309" target="_blank" rel="external">https://zhuanlan.zhihu.com/p/29706309</a>  </p>
<p>卷的状态：  </p>
<ul>
<li>Available – a free resource that is not yet bound to a claim  </li>
<li>Bound – the volume is bound to a claim  </li>
<li>Released – the claim has been deleted, but the resource is not yet reclaimed by the cluster  </li>
<li>Failed – the volume has failed its automatic reclamation  </li>
</ul>
<p>参考：<a href="https://www.kubernetes.org.cn/pvpvcstorageclass" target="_blank" rel="external">https://www.kubernetes.org.cn/pvpvcstorageclass</a>  </p>
<p>glusterfs 创建pv<br><a href="https://note.youdao.com/yws/api/personal/file/7F506ED50381494E9202DE11D37986CA?method=download&amp;shareKey=9f4a718687f394aa7d8a09fdcaad1ce0" target="_blank" rel="external">gfs-pv.yml</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># cat gfs-pv.yml </span></div><div class="line">apiVersion: v1</div><div class="line">kind: PersistentVolume</div><div class="line">metadata:</div><div class="line">  name: <span class="string">"gluster-pv"</span></div><div class="line">  <span class="comment">#namespace: "name"</span></div><div class="line">spec:</div><div class="line">  capacity:</div><div class="line">    storage: 250Gi                   <span class="comment">#再挂载测试时可以看到gfs卷的大小</span></div><div class="line">  accessModes:</div><div class="line">    - ReadWriteMany</div><div class="line">  glusterfs:</div><div class="line">    endpoints: <span class="string">"glusterfs-cluster"</span>    <span class="comment">#通过kubectl get endpoints查询Name</span></div><div class="line">    path: <span class="string">"k8s-volume"</span>                <span class="comment">#通过gluster volume info查询Volume Name</span></div><div class="line">    <span class="built_in">read</span>Only: <span class="literal">false</span></div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl create -f gfs-pv.yml</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get pv,pvc</span></div><div class="line">NAME            CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM     STORAGECLASS   REASON    AGE</div><div class="line">pv/gluster-pv   250Gi      RWX            Retain           Available                                      12m</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>glusterfs  创建pvc<br><a href="https://note.youdao.com/yws/api/personal/file/51FD8C64D782486C9164A007629536D2?method=download&amp;shareKey=5f3a7944fb7663ed930f7441ebbbbd68" target="_blank" rel="external">gfs-pvc.yml</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># cat gfs-pvc.yml </span></div><div class="line">apiVersion: v1</div><div class="line">kind: PersistentVolumeClaim</div><div class="line">metadata:</div><div class="line">  name: <span class="string">"glusterfs-pvc"</span></div><div class="line">  <span class="comment">#namespace: "name"</span></div><div class="line">spec:</div><div class="line">  accessModes:</div><div class="line">    - ReadWriteMany</div><div class="line">  resources:</div><div class="line">    requests:</div><div class="line">      storage: 250Gi</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl create -f gfs-pvc.yml</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get pv,pvc --all-namespaces</span></div><div class="line">NAMESPACE   NAME        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS    CLAIM                       STORAGECLASS   REASON    AGE</div><div class="line">            pv/gfs-pv   300Gi      RWX            Retain           Bound     default/gfs-pvc                            7m</div><div class="line"></div><div class="line">NAMESPACE           NAME          STATUS    VOLUME    CAPACITY   ACCESS MODES   STORAGECLASS   AGE</div><div class="line">default   pvc/gfs-pvc   Bound     gfs-pv    300Gi      RWX                           6m</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p><img src="https://note.youdao.com/yws/api/personal/file/3D015DC3B0394554BA63094C30FD2DA0?method=download&amp;shareKey=e91cb9232660cfa2eec9fff50f1a8e99" alt="k8s-gfs">  </p>
<p>glusterfs 创建pod 应用<br><a href="https://note.youdao.com/yws/api/personal/file/D02C088CA5534C0F85671828732BE559?method=download&amp;shareKey=ca010761cd2d76392fa30b552c0b60c8" target="_blank" rel="external">gfs-pvc-pod.yml</a><br>yaml文件另一种写法：<a href="https://github.com/kubernetes/kubernetes/blob/master/examples/volumes/glusterfs/glusterfs-pod.json" target="_blank" rel="external">https://github.com/kubernetes/kubernetes/blob/master/examples/volumes/glusterfs/glusterfs-pod.json</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">apiVersion: v1</div><div class="line">kind: Pod</div><div class="line">metadata:</div><div class="line">  name: <span class="built_in">test</span></div><div class="line">  namespace: <span class="string">"dev-00-www-pphuishou-com"</span></div><div class="line">spec:</div><div class="line">  containers:</div><div class="line">    - name: nginx</div><div class="line">      image: nginx:1.13</div><div class="line">      volumeMounts:</div><div class="line">      - mountPath: <span class="string">"/var/log/nginx/"</span>   <span class="comment">#把glusterfs(k8s-volume)挂载到/usr/share/nginx/html/目录下</span></div><div class="line">        name: <span class="built_in">log</span></div><div class="line">  volumes:</div><div class="line">    - name: <span class="built_in">log</span></div><div class="line">      persistentVolumeClaim:</div><div class="line">        claimName: glusterfs-pvc</div><div class="line">---</div><div class="line">apiVersion: v1</div><div class="line">kind: Service</div><div class="line">metadata:</div><div class="line">  name: <span class="built_in">test</span>-nginx</div><div class="line">  labels:</div><div class="line">    app: nginx</div><div class="line">spec:</div><div class="line">  <span class="built_in">type</span>: NodePort</div><div class="line">  ports:</div><div class="line">  - port: 80</div><div class="line">    targetPort: 80</div><div class="line">    nodePort: 29000</div><div class="line">  selector:</div><div class="line">    app: nginx</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl create -f gfs-pvc-pod.yml</span></div></pre></td></tr></table></figure>
<p>验证<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get pods -o wide</span></div><div class="line">NAME                               READY     STATUS    RESTARTS   AGE       IP            NODE</div><div class="line">mypod-gfs                          1/1       Running   0          1d        172.30.57.3   192.168.1.198</div><div class="line">[root@master1 ~]<span class="comment"># kubectl get svc -o wide</span></div><div class="line">NAME                TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)       AGE       SELECTOR</div><div class="line">nginx-service       NodePort    172.16.215.237   &lt;none&gt;        88:8527/TCP   20d       app=nginx</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>gluster存储在宿主机<code>/data/gfs_data</code>目录下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># gluster volume info</span></div><div class="line">Volume Name: k8s-volume</div><div class="line">...</div><div class="line">Brick1: master1.example.com:/data/gfs_data</div><div class="line">Brick2: master2.example.com:/data/gfs_data</div><div class="line">Brick3: master3.example.com:/data/gfs_data</div><div class="line">Brick4: node1.example.com:/data/gfs_data</div><div class="line">Brick5: node2.example.com:/data/gfs_data</div><div class="line">...</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>向gluster存储目录上传文件(待验证用)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># cd /data/gfs_data/</span></div><div class="line">[root@master1 gfs_data]<span class="comment"># ls</span></div><div class="line">index.html</div><div class="line">[root@master1 gfs_data]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>验证通过<br>应用nginx-service使用的是gluster存储<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># docker ps -a</span></div><div class="line">CONTAINER ID        IMAGE      COMMAND                  CREATED          STATUS         PORTS          NAMES</div><div class="line">9dd7a0db5281        nginx      <span class="string">"nginx -g 'daemon of…"</span>   41 hours ago     Up 41 hours                   k8s_nginx_mypod-gfs_default_586a45c2-194d-11e8-b996-1e2d0a5bc3f5_0</div><div class="line">[root@node1 ~]<span class="comment"># docker exec -it 9dd7a0db5281 /bin/bash</span></div><div class="line">root@mypod-gfs:/<span class="comment"># df -h</span></div><div class="line">Filesystem                Size  Used Avail Use% Mounted on</div><div class="line">192.168.1.195:k8s-volume  250G  163M  250G   1% /usr/share/nginx/html</div><div class="line">root@mypod-gfs:/<span class="comment"># </span></div><div class="line">root@mypod-gfs:/<span class="comment"># cd /usr/share/nginx/html/</span></div><div class="line">root@mypod-gfs:/usr/share/nginx/html<span class="comment"># ls</span></div><div class="line">index.html</div><div class="line">root@mypod-gfs:/usr/share/nginx/html<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>Deployment写法<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">apiVersion: extensions/v1beta1</div><div class="line">kind: Deployment</div><div class="line">metadata:</div><div class="line">  name: <span class="string">"filebeat-deployment"</span></div><div class="line">  namespace: <span class="string">"name"</span></div><div class="line">spec:</div><div class="line">  replicas: 1</div><div class="line">  template:</div><div class="line">    metadata:</div><div class="line">      labels:</div><div class="line">        app: filebeat</div><div class="line">    spec:</div><div class="line">      nodeName: 192.168.2.161</div><div class="line">      containers:</div><div class="line">      - name: filebeat</div><div class="line">        image: yfshare/filebeat:6.2.2</div><div class="line">        imagePullPolicy: Always</div><div class="line">        ports:</div><div class="line">        env:</div><div class="line">        volumeMounts:</div><div class="line">          - name: filebeat-time</div><div class="line">            mountPath: <span class="string">"/etc/localtime"</span></div><div class="line">            <span class="built_in">read</span>Only: <span class="literal">true</span></div><div class="line">          - name: filebeat-yml</div><div class="line">            mountPath: <span class="string">"/etc/filebeat/filebeat.yml"</span></div><div class="line">            <span class="built_in">read</span>Only: <span class="literal">true</span></div><div class="line">          - name: filebeat-logs</div><div class="line">            mountPath: <span class="string">"/var/log/filebeat/"</span></div><div class="line">            <span class="built_in">read</span>Only: <span class="literal">false</span></div><div class="line">          - name: <span class="built_in">read</span>-logs</div><div class="line">            mountPath: <span class="string">"/data"</span></div><div class="line">            <span class="built_in">read</span>Only: <span class="literal">false</span></div><div class="line">      volumes:</div><div class="line">      - name: filebeat-time</div><div class="line">        hostPath:</div><div class="line">          path: <span class="string">"/etc/localtime"</span></div><div class="line">      - name: filebeat-yml</div><div class="line">        hostPath:</div><div class="line">          path: <span class="string">"/root/k8s_elk/filebeat/filebeat.yml"</span></div><div class="line">      - name: filebeat-logs</div><div class="line">        hostPath:</div><div class="line">          path: <span class="string">"/data/elk/filebeat"</span></div><div class="line">      - name: <span class="built_in">read</span>-logs</div><div class="line">        persistentVolumeClaim:</div><div class="line">          claimName: gfs-pvc</div></pre></td></tr></table></figure></p>
<h4 id="删除卷（Delete-Volume）"><a href="#删除卷（Delete-Volume）" class="headerlink" title="删除卷（Delete Volume）"></a>删除卷（Delete Volume）</h4><p>停止卷<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gluster volume stop VOLNAME</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gluster volume delete VOLNAME</div></pre></td></tr></table></figure>
<h4 id="glusterfs扩容卷（Expanding-Volume）"><a href="#glusterfs扩容卷（Expanding-Volume）" class="headerlink" title="glusterfs扩容卷（Expanding Volume）"></a>glusterfs扩容卷（Expanding Volume）</h4><p>把新增的存储服务器加入存储池<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gluster peer probe HOSTNAME</div></pre></td></tr></table></figure></p>
<p>把brick加入卷中<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gluster volume add-brick k8s-volume gfs1.example.com:/mnt/gfs_data force</div></pre></td></tr></table></figure></p>
<p>重新平衡卷<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gluster volume rebalance k8s-volume start</div></pre></td></tr></table></figure></p>
<p>检查rebalance状态<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gluster volume rebalance k8s-volume status</div></pre></td></tr></table></figure></p>
<h4 id="glusterfs缩小卷（Shrinking-Volume）"><a href="#glusterfs缩小卷（Shrinking-Volume）" class="headerlink" title="glusterfs缩小卷（Shrinking Volume）"></a>glusterfs缩小卷（Shrinking Volume）</h4><p>把brick从卷中移除<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gluster volume remove-brick k8s-volume gfs1.example.com:/mnt/gfs_data force</div></pre></td></tr></table></figure></p>
<p>重新平衡卷<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gluster volume rebalance k8s-volume start</div></pre></td></tr></table></figure></p>
<p>检查rebalance状态<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gluster volume rebalance k8s-volume status</div></pre></td></tr></table></figure></p>
<h4 id="在线迁移数据（Migrating-Data）"><a href="#在线迁移数据（Migrating-Data）" class="headerlink" title="在线迁移数据（Migrating Data）"></a>在线迁移数据（Migrating Data）</h4><p>迁移数据到另一个brick中<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gluster volume replace-brick VOLNAME BRICK NEWBRICK start</div></pre></td></tr></table></figure></p>
<p>查看迁移进度状态<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gluster volume replace-brick VOLNAME BRICK NEWBRICK status</div></pre></td></tr></table></figure></p>
<p>提交迁移数据<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gluster volume replace-brick VOLNAME BRICK NEWBRICK commit</div></pre></td></tr></table></figure></p>
<h4 id="gluster常用命令"><a href="#gluster常用命令" class="headerlink" title="gluster常用命令"></a>gluster常用命令</h4><p>列出集群中的所有卷<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gluster volume list</div></pre></td></tr></table></figure></p>
<p>查看集群中的卷信息<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gluster volume info [all]</div></pre></td></tr></table></figure></p>
<p>查看集群中的卷状态<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">gluster volume status [all]</div><div class="line">gluster volume status &lt;VOLNAME&gt; [detail| clients | mem | inode | fd]</div></pre></td></tr></table></figure></p>
<p>参考：<a href="http://blog.csdn.net/i_chips/article/details/12656527" target="_blank" rel="external">http://blog.csdn.net/i_chips/article/details/12656527</a>  </p>
<h4 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h4><p>查看pod的日志信息<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kubectl describe pods <span class="built_in">test</span></div></pre></td></tr></table></figure></p>
<p>如果报下面的错误，则检查下k8s的node节点是否支持glusterfs文件系统<br>通过下面命令可以检查，如果报<code>mount: 未知的文件系统类型“glusterfs”</code>，则说明不支持glusterfs文件系统<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># mount -t glusterfs gfs1.example.com:k8s_gfs /media/</span></div></pre></td></tr></table></figure></p>
<p>解决方法：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install -y glusterfs glusterfs-server glusterfs-fuse glust</div></pre></td></tr></table></figure></p>
<p><img src="https://note.youdao.com/yws/api/personal/file/FDF47AC0022C4443BFE638A118C76DEE?method=download&amp;shareKey=575fc1a22ea4fc9754df286701444026" alt="k8s_gfs_error">  </p>
<p>如果报下面的错误，则检查下k8s创建gfs-endpoint和gfs-server时配置文件是否正确<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#查看Volume Name</span></div><div class="line">gluster volume info</div><div class="line"></div><div class="line"><span class="comment">#创建test.yml时，检查创建pv,pvc时配置是否正确</span></div><div class="line">kubectl create <span class="_">-f</span> test.yml</div></pre></td></tr></table></figure></p>
<p><img src="https://note.youdao.com/yws/api/personal/file/091A4A4E1D484F0280C84A1B88B55ABB?method=download&amp;shareKey=a3608e79be82b6bccc2aa52dd30ef327" alt="k8s_gfs_error">  </p>
<p>正确配置如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl describe pods test</span></div><div class="line"></div><div class="line"><span class="comment"># kubectl get pods -o wide</span></div><div class="line">NAME        READY     STATUS    RESTARTS   AGE       IP             NODE</div><div class="line"><span class="built_in">test</span>        1/1       Running   0          29m       172.20.40.5    192.168.2.11</div><div class="line"><span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p><img src="https://note.youdao.com/yws/api/personal/file/BB6EB5193B4B48DE9ECB82A5EC7B15FF?method=download&amp;shareKey=ce136f4e0364397379cf13366b88586d" alt="k8s_gfs">  </p>
<p>如果报下面的错误，则需要检查下K8s Node节点状态和hosts解析<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#获取当前k8s的Node节点信息，需要看STATUS值是否是Ready</span></div><div class="line">kubectl get nodes</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#需要把gfs所有节点的域名做hosts解析，否则应用挂载时可能找不到gfs节点而导致挂载失败</span></div><div class="line">[root@master1 ~]<span class="comment"># tail -5 /etc/hosts</span></div><div class="line">192.168.1.195 master1.example.com master1</div><div class="line">192.168.1.196 master2.example.com master2</div><div class="line">192.168.1.197 master3.example.com master3</div><div class="line">192.168.1.198 node1.example.com node1</div><div class="line">192.168.1.199 node2.example.com node2</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p><img src="https://note.youdao.com/yws/api/personal/file/8104D32DA6294354A19B3AA7F11D1607?method=download&amp;shareKey=2b523d5d27edccaf2c7b0a7ff19d361b" alt="k8s_gfs_error"><br><img src="https://note.youdao.com/yws/api/personal/file/D8D9344A9F774080AFCAECA50D55C879?method=download&amp;shareKey=205ae14dcd36c6bdfcbdc135d67b436f" alt="k8s_gfs_error">  </p>
<p>参考：<a href="https://jimmysong.io/kubernetes-handbook/practice/using-glusterfs-for-persistent-storage.html" target="_blank" rel="external">https://jimmysong.io/kubernetes-handbook/practice/using-glusterfs-for-persistent-storage.html</a><br><a href="http://blog.csdn.net/i_chips/article/details/12656527" target="_blank" rel="external">http://blog.csdn.net/i_chips/article/details/12656527</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2018/03/17/glusterfs做持久化存储/">http://www.yfshare.vip/2018/03/17/glusterfs做持久化存储/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Prometheus监控TLS Kubernetes集群]]></title>
      <url>http://www.yfshare.vip/2018/03/14/Prometheus%E7%9B%91%E6%8E%A7TLS-Kubernetes%E9%9B%86%E7%BE%A4/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>当我们完成Kubernetes集群环境部署后，就需要提取Kubernets集群中POD的日志提取和监控。当集群内的N台服务器在Kubernets的管理下自动创建和销毁POD，但在这种情况下，我们就不方便及时获取所有POD和服务器的运行状态及资源消耗状态，给我们感觉是，驾驶着一辆没有仪表盘的跑车在高速公路上飙车，给人一种心慌的感觉。<br>在以前的工作中，用过Nagios，Cacti，zabbix等监控工具。但在Kubernets集群中，这些工具并不适用。因此，我们需要引入新的监控工具Prometheus。<br><a id="more"></a></p>
<h4 id="Prometheus简介"><a href="#Prometheus简介" class="headerlink" title="Prometheus简介"></a>Prometheus简介</h4><p>Prometheus是SoundCloud开源的一款监控软件。它的实现参考了Google内部的监控实现， 与同样源自Google的Kubernetes项目十分搭配。Prometheus集成了数据采集，存储，异常告警多项功能，是一款一体化的完整方案。它针对大规模的集群环境设计了拉取式的数据采集方式、多维度数据存储格式以及服务发现等创新功能。<br>与传统监控工具相比，Prometheus 可以通过服务发现掌握集群内部已经暴露的监控点，然后主动拉取所有监控数据。通过这样的架构设计，我们仅需要向Kubernetes集群中部署一份Prometheus实例，它就可以通过向<code>apiserver</code>查询集群状态，然后向所有已经支持Prometheus metrics的kubelet获取所有Pod的运行数据。如果我们想采集底层服务器运行状态，通过DaemonSet在所有服务器上运行配套的node-exporter之后，Prometheus就可以自动采集到新的这部分数据。<br>这种动态发现的架构，非常适合服务器和程序都不固定的Kubernetes集群环境，同时也大大降低了运维的负担。  </p>
<p>Prometheus官网：<a href="https://prometheus.io/" target="_blank" rel="external">https://prometheus.io/</a><br>Prometheus官方下载地址：<a href="https://prometheus.io/download/" target="_blank" rel="external">https://prometheus.io/download/</a><br>Prometheus官方文档地址：<a href="https://prometheus.io/docs/introduction/overview/" target="_blank" rel="external">https://prometheus.io/docs/introduction/overview/</a>  </p>
<h4 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h4><p>环境：<br>　　　Prometheus v2.2.0<br>　　　node-exporter v0.15.2<br>　　　Kubernetes v1.8.2<br>　　　Centos 7.4  </p>
<table>
<thead>
<tr>
<th>角色</th>
<th>IP</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>k8s master</td>
<td>192.168.1.195</td>
<td>k8s master</td>
</tr>
<tr>
<td>k8s node</td>
<td>192.168.1.198</td>
<td>k8s node、Prometheus、node-exporter</td>
</tr>
<tr>
<td>k8s node</td>
<td>192.168.1.199</td>
<td>k8s node、Prometheus、node-exporter</td>
</tr>
</tbody>
</table>
<h4 id="部署node-exporter"><a href="#部署node-exporter" class="headerlink" title="部署node-exporter"></a>部署node-exporter</h4><p>node-exporter可以用于监控底层的服务器指标<br>下面是官方解释：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Prometheus exporter <span class="keyword">for</span> hardware and OS metrics exposed by *NIX kernels, written <span class="keyword">in</span> Go with pluggable metric collectors.</div><div class="line">The WMI exporter is recommended <span class="keyword">for</span> Windows users.</div></pre></td></tr></table></figure></p>
<p>node-exporter Github：<a href="https://github.com/prometheus/node_exporter" target="_blank" rel="external">https://github.com/prometheus/node_exporter</a>  </p>
<p>为了能够收集每个节点的信息，这里使用<code>DaemonSet</code>的形式部署PODS  </p>
<p>node-exporter.yaml：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">---</div><div class="line">apiVersion: extensions/v1beta1</div><div class="line">kind: DaemonSet</div><div class="line">metadata:</div><div class="line">  name: node-exporter</div><div class="line">  namespace: kube-ops</div><div class="line">  labels:</div><div class="line">    k8s-app: node-exporter</div><div class="line">spec:</div><div class="line">  template:</div><div class="line">    metadata:</div><div class="line">      labels:</div><div class="line">        k8s-app: node-exporter</div><div class="line">    spec:</div><div class="line">      containers:</div><div class="line">      - image: prom/node-exporter:latest</div><div class="line">        name: node-exporter</div><div class="line">        ports:</div><div class="line">        - containerPort: 9100</div><div class="line">          hostPort: 9100</div><div class="line">          protocol: TCP</div><div class="line">          name: http</div><div class="line">        volumeMounts:</div><div class="line">          - name: time</div><div class="line">            mountPath: /etc/localtime</div><div class="line">            <span class="built_in">read</span>Only: <span class="literal">true</span></div><div class="line">      volumes:</div><div class="line">        - name: time</div><div class="line">          hostPath:</div><div class="line">            path: /etc/localtime</div><div class="line">---</div><div class="line">apiVersion: v1</div><div class="line">kind: Service</div><div class="line">metadata:</div><div class="line">  labels:</div><div class="line">    k8s-app: node-exporter</div><div class="line">  name: node-exporter</div><div class="line">  namespace: kube-ops</div><div class="line">spec:</div><div class="line">  ports:</div><div class="line">  - name: http</div><div class="line">    port: 9100</div><div class="line">    targetPort: 9100</div><div class="line">    protocol: TCP</div><div class="line">  selector:</div><div class="line">    k8s-app: node-exporter</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@localhost prometheus]<span class="comment"># kubectl create namespace kube-ops</span></div><div class="line">[root@localhost prometheus]<span class="comment"># kubectl apply -f node-exporter.yaml</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@localhost prometheus]<span class="comment"># kubectl get pod -o wide -n kube-ops</span></div><div class="line">NAME                         READY     STATUS    RESTARTS   AGE       IP            NODE</div><div class="line">node-exporter-8d66t          1/1       Running   0          1h        172.30.41.5   192.168.1.199</div><div class="line">node-exporter-xn5ss          1/1       Running   0          1h        172.30.57.6   192.168.1.198</div><div class="line">[root@localhost prometheus]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@localhost prometheus]<span class="comment"># kubectl get svc -o wide -n kube-ops</span></div><div class="line">NAME            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE       SELECTOR</div><div class="line">node-exporter   ClusterIP   172.16.152.14   &lt;none&gt;        9100/TCP   1h        k8s-app=node-exporter</div><div class="line">[root@localhost prometheus]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h4 id="部署Service-Account"><a href="#部署Service-Account" class="headerlink" title="部署Service Account"></a>部署Service Account</h4><p>Kubernetes在1.8.0之后启用了RBAC特性，因此我们需要先通过RBAC授权，然后Prometheus通过RBAC连接Kubernetes集群，否则被拒绝后，将无法连接到K8s的API-SERVER<br>参考：<a href="https://kubernetes.io/docs/admin/authorization/rbac/" target="_blank" rel="external">https://kubernetes.io/docs/admin/authorization/rbac/</a>  </p>
<p>prometheus-service-account.yml：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">apiVersion: v1</div><div class="line">kind: ServiceAccount</div><div class="line">metadata:</div><div class="line">  name: prometheus</div><div class="line">  namespace: kube-ops</div><div class="line">---</div><div class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</div><div class="line">kind: ClusterRole</div><div class="line">metadata:</div><div class="line">  name: prometheus</div><div class="line">  namespace: kube-ops</div><div class="line">rules:</div><div class="line">- apiGroups: [<span class="string">""</span>]</div><div class="line">  resources:</div><div class="line">  - nodes</div><div class="line">  - nodes/proxy</div><div class="line">  - services</div><div class="line">  - endpoints</div><div class="line">  - pods</div><div class="line">  verbs: [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>]</div><div class="line">- nonResourceURLs: [<span class="string">"/metrics"</span>]</div><div class="line">  verbs: [<span class="string">"get"</span>]</div><div class="line">---</div><div class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</div><div class="line">kind: ClusterRoleBinding</div><div class="line">metadata:</div><div class="line">  name: prometheus</div><div class="line">  namespace: kube-ops</div><div class="line">roleRef:</div><div class="line">  apiGroup: rbac.authorization.k8s.io</div><div class="line">  kind: ClusterRole</div><div class="line">  name: prometheus</div><div class="line">subjects:</div><div class="line">- kind: ServiceAccount</div><div class="line">  name: prometheus</div><div class="line">  namespace: kube-ops</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@localhost prometheus]<span class="comment"># kubectl apply -f prometheus-service-account.yml</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@localhost prometheus]<span class="comment"># kubectl get ServiceAccount -n kube-ops</span></div><div class="line">NAME         SECRETS   AGE</div><div class="line">default      1         1d</div><div class="line">prometheus   1         55m</div><div class="line">[root@localhost prometheus]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h4 id="部署Prometheus-alertmanager配置文件"><a href="#部署Prometheus-alertmanager配置文件" class="headerlink" title="部署Prometheus alertmanager配置文件"></a>部署Prometheus alertmanager配置文件</h4><p>使用ConfigMap的形式来设置Prometheus的配置文件<br>参考：<a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/" target="_blank" rel="external">https://prometheus.io/docs/prometheus/latest/configuration/configuration/</a>  </p>
<p>prometheus-alertmanager-config.yml：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">kind: ConfigMap</div><div class="line">apiVersion: v1</div><div class="line">metadata:</div><div class="line">  name: alertmanager</div><div class="line">  namespace: kube-ops</div><div class="line">data:</div><div class="line">  config.yml: |-</div><div class="line">    global:</div><div class="line">      smtp_smarthost: <span class="string">'smtp.exmail.qq.com:465'</span></div><div class="line">      smtp_from: <span class="string">'user1@example.com'</span></div><div class="line">      smtp_auth_username: <span class="string">'user1@example.com'</span></div><div class="line">      smtp_auth_password: <span class="string">'password'</span></div><div class="line">      smtp_require_tls: <span class="literal">false</span></div><div class="line">  </div><div class="line">      resolve_timeout: 5m</div><div class="line"></div><div class="line">    templates:</div><div class="line">      - <span class="string">'/etc/alertmanager/*.tmpl'</span></div><div class="line"></div><div class="line">    route:</div><div class="line">      receiver: email</div><div class="line">      group_wait: 30s</div><div class="line">      group_interval: 5m</div><div class="line">      repeat_interval: 10d</div><div class="line">      group_by: [alertname]</div><div class="line">      routes:</div><div class="line">      - receiver: email</div><div class="line">        group_wait: 10s</div><div class="line">        match:</div><div class="line">          team: node</div><div class="line">    receivers:</div><div class="line">    - name: email</div><div class="line">      email_configs:</div><div class="line">      - send_resolved: <span class="literal">true</span></div><div class="line">        to: <span class="string">'user2@example.com,user3@example.com'</span></div></pre></td></tr></table></figure></p>
<ul>
<li><code>repeat_interval</code>：指定告警发送间隔时间  </li>
<li><code>to: &#39;user2@example.com,user3@example.com&#39;</code>指定多个收件人，每个收件人邮箱之间用<code>逗号</code>隔开  </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@localhst prometheus]<span class="comment"># kubectl apply -f prometheus-alertmanager-config.yml</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@localhst prometheus]<span class="comment"># kubectl get ConfigMap -n kube-ops</span></div><div class="line">NAME                DATA      AGE</div><div class="line">alertmanager        2         21h</div><div class="line">[root@localhst prometheus]<span class="comment">#</span></div></pre></td></tr></table></figure>
<ul>
<li>需要修改<code>global.smtp*</code>和<code>receivers.name.email_configs</code>相关的邮件信息  </li>
</ul>
<h4 id="部署Prometheus的配置文件"><a href="#部署Prometheus的配置文件" class="headerlink" title="部署Prometheus的配置文件"></a>部署Prometheus的配置文件</h4><p>prometheus-config.yaml：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div></pre></td><td class="code"><pre><div class="line">apiVersion: v1</div><div class="line">kind: ConfigMap</div><div class="line">metadata:</div><div class="line">  name: prometheus-config</div><div class="line">  namespace: kube-ops</div><div class="line">data:</div><div class="line">  prometheus.yml: |</div><div class="line">    global:</div><div class="line">      scrape_interval: 30s</div><div class="line">      scrape_timeout: 30s</div><div class="line">    alerting:</div><div class="line">      alertmanagers:</div><div class="line">        - static_configs:</div><div class="line">            - targets: [<span class="string">"192.168.1.198:9093"</span>]</div><div class="line">    rule_files:</div><div class="line">      - <span class="string">"rules.yml"</span></div><div class="line">    scrape_configs:</div><div class="line">    - job_name: <span class="string">'prometheus'</span></div><div class="line">      static_configs:</div><div class="line">        - targets: [<span class="string">'localhost:9090'</span>]</div><div class="line"></div><div class="line">    - job_name: <span class="string">'kubernetes-apiservers'</span></div><div class="line">      kubernetes_sd_configs:</div><div class="line">      - role: endpoints</div><div class="line">      scheme: https</div><div class="line">      tls_config:</div><div class="line">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</div><div class="line">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</div><div class="line">      relabel_configs:</div><div class="line">      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</div><div class="line">        action: keep</div><div class="line">        regex: default;kubernetes;https</div><div class="line"></div><div class="line">    - job_name: <span class="string">'kubernetes-nodes'</span></div><div class="line">      scheme: https</div><div class="line">      tls_config:</div><div class="line">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</div><div class="line">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</div><div class="line">      kubernetes_sd_configs:</div><div class="line">      - role: node</div><div class="line">      relabel_configs:</div><div class="line">      - action: labelmap</div><div class="line">        regex: __meta_kubernetes_node_label_(.+)</div><div class="line">      - target_label: __address__</div><div class="line">        replacement: 10.100.100.10:6443</div><div class="line">      - source_labels: [__meta_kubernetes_node_name]</div><div class="line">        regex: (.+)</div><div class="line">        target_label: __metrics_path__</div><div class="line">        replacement: /api/v1/nodes/<span class="variable">$&#123;1&#125;</span>/proxy/metrics</div><div class="line"></div><div class="line">    - job_name: <span class="string">'kubernetes-cadvisor'</span></div><div class="line">      scheme: https</div><div class="line">      tls_config:</div><div class="line">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</div><div class="line">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</div><div class="line">      kubernetes_sd_configs:</div><div class="line">      - role: node</div><div class="line">      relabel_configs:</div><div class="line">      - action: labelmap</div><div class="line">        regex: __meta_kubernetes_node_label_(.+)</div><div class="line">      - target_label: __address__</div><div class="line">        replacement: 192.168.1.195:6443</div><div class="line">      - source_labels: [__meta_kubernetes_node_name]</div><div class="line">        regex: (.+)</div><div class="line">        target_label: __metrics_path__</div><div class="line">        replacement: /api/v1/nodes/<span class="variable">$&#123;1&#125;</span>/proxy/metrics/cadvisor</div><div class="line"></div><div class="line">    - job_name: <span class="string">'kubernetes-node-exporter'</span></div><div class="line">      scheme: http</div><div class="line">      tls_config:</div><div class="line">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</div><div class="line">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</div><div class="line">      kubernetes_sd_configs:</div><div class="line">      - role: node</div><div class="line">      relabel_configs:</div><div class="line">      - action: labelmap</div><div class="line">        regex: __meta_kubernetes_node_label_(.+)</div><div class="line">      - source_labels: [__meta_kubernetes_role]</div><div class="line">        action: replace</div><div class="line">        target_label: kubernetes_role</div><div class="line">      - source_labels: [__address__]</div><div class="line">        regex: <span class="string">'(.*):10250'</span></div><div class="line">        replacement: <span class="string">'$&#123;1&#125;:9100'</span></div><div class="line">        target_label: __address__</div><div class="line"></div><div class="line">  rules.yml: |</div><div class="line">    groups:</div><div class="line">    - name: rule</div><div class="line">      rules:</div><div class="line">      - alert: NodeFilesystemUsage</div><div class="line">        expr: (node_filesystem_size&#123;device=<span class="string">"rootfs"</span>&#125; - node_filesystem_free&#123;device=<span class="string">"rootfs"</span>&#125;) / node_filesystem_size&#123;device=<span class="string">"rootfs"</span>&#125; * 100 &gt; 80</div><div class="line">        <span class="keyword">for</span>: 2m</div><div class="line">        labels:</div><div class="line">          team: node</div><div class="line">        annotations:</div><div class="line">          summary: <span class="string">"&#123;&#123;<span class="variable">$labels</span>.instance&#125;&#125;: High Filesystem usage detected"</span></div><div class="line">          description: <span class="string">"&#123;&#123;<span class="variable">$labels</span>.instance&#125;&#125;: Filesystem usage is above 80% (current value is: &#123;&#123; <span class="variable">$value</span> &#125;&#125;"</span></div><div class="line">      - alert: NodeMemoryUsage</div><div class="line">        expr: (node_memory_MemTotal - (node_memory_MemFree+node_memory_Buffers+node_memory_Cached )) / node_memory_MemTotal * 100 &gt; 80</div><div class="line">        <span class="keyword">for</span>: 2m</div><div class="line">        labels:</div><div class="line">          team: node</div><div class="line">        annotations:</div><div class="line">          summary: <span class="string">"&#123;&#123;<span class="variable">$labels</span>.instance&#125;&#125;: High Memory usage detected"</span></div><div class="line">          description: <span class="string">"&#123;&#123;<span class="variable">$labels</span>.instance&#125;&#125;: Memory usage is above 80% (current value is: &#123;&#123; <span class="variable">$value</span> &#125;&#125;"</span></div><div class="line">      - alert: NodeCPUUsage</div><div class="line">        expr: (100 - (avg by (instance) (irate(node_cpu&#123;job=<span class="string">"kubernetes-node-exporter"</span>,mode=<span class="string">"idle"</span>&#125;[5m])) * 100)) &gt; 80</div><div class="line">        <span class="keyword">for</span>: 2m</div><div class="line">        labels:</div><div class="line">          team: node</div><div class="line">        annotations:</div><div class="line">          summary: <span class="string">"&#123;&#123;<span class="variable">$labels</span>.instance&#125;&#125;: High CPU usage detected"</span></div><div class="line">          description: <span class="string">"&#123;&#123;<span class="variable">$labels</span>.instance&#125;&#125;: CPU usage is above 80% (current value is: &#123;&#123; <span class="variable">$value</span> &#125;&#125;"</span></div></pre></td></tr></table></figure></p>
<ul>
<li><code>job_name: &#39;kubernetes-node-exporter&#39;</code>中替换31672端口为9100，该端口是<code>node-exporter</code>暴露的<code>NodePort</code>端口，这里需要根据实际情况填写<br>在前面node-exporter.yaml中指定了<code>targetPort: 9100</code>，所以这里的端口需要修改为9100  </li>
<li><code>kubernetes.default.svc:443</code>为k8s api地址，如果安装k8s时不是使用的默认DNS，则需要手动修改  </li>
<li>新增了Prometheus alertmanagers，需要修改<code>alerting.alertmanagers.static_configs.targets</code>的IP地址，这时Prometheus和alertmanagers是两个docker容器，IP为运行alertmanagers的宿主机的IP地址  </li>
<li>新增了Prometheus alertmanagers告警规则，添加<code>rule_files</code>(指定报警规则)，并增加三条规则(rules.yml)  </li>
<li>这里新增的三条报警规则分别是：节点的文件系统，节点内存，CPU的使用量。如果大于了80%的话就触发label为<code>team=node</code>的<code>receiver</code>(alertmanager  配置文件中配置)，可以看到上面的配置就会匹配<code>email</code>这个<code>receiver</code>  </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@localhost prometheus]<span class="comment"># kubectl apply -f prometheus-config.yaml</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@localhst prometheus]<span class="comment"># kubectl get ConfigMap -n kube-ops</span></div><div class="line">NAME                DATA      AGE</div><div class="line">alertmanager        2         21h</div><div class="line">prometheus-config   1         21h</div><div class="line">[root@localhst prometheus]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h4 id="部署prometheus"><a href="#部署prometheus" class="headerlink" title="部署prometheus"></a>部署prometheus</h4><p>使用Deployment的形式来设置Prometheus<br>参考：<a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" target="_blank" rel="external">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/</a>  </p>
<p>prometheus-deploy.yaml:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line">apiVersion: extensions/v1beta1</div><div class="line">kind: Deployment</div><div class="line">metadata:</div><div class="line">  labels:</div><div class="line">    k8s-app: prometheus</div><div class="line">  name: prometheus</div><div class="line">  namespace: kube-ops</div><div class="line">spec:</div><div class="line">  replicas: 1</div><div class="line">  template:</div><div class="line">    metadata:</div><div class="line">      labels:</div><div class="line">        k8s-app: prometheus</div><div class="line">    spec:</div><div class="line">      nodeSelector:</div><div class="line">        appNodes: pro-00-monitor</div><div class="line">      securityContext:</div><div class="line">        runAsUser: 0</div><div class="line">      serviceAccountName: prometheus</div><div class="line">      containers:</div><div class="line">      - image: prom/prometheus:v2.2.0</div><div class="line">        name: prometheus</div><div class="line">        <span class="built_in">command</span>:</div><div class="line">        - <span class="string">"/bin/prometheus"</span></div><div class="line">        args:</div><div class="line">        - <span class="string">"--config.file=/etc/prometheus/prometheus.yml"</span></div><div class="line">        - <span class="string">"--storage.tsdb.path=/prometheus"</span></div><div class="line">        - <span class="string">"--storage.tsdb.retention=15d"</span></div><div class="line">        ports:</div><div class="line">        - containerPort: 9090</div><div class="line">          hostPort: 9090</div><div class="line">          protocol: TCP</div><div class="line">          name: http</div><div class="line">        volumeMounts:</div><div class="line">        - mountPath: <span class="string">"/prometheus"</span></div><div class="line">          name: data</div><div class="line">          subPath: prometheus/data</div><div class="line">        - mountPath: <span class="string">"/etc/prometheus"</span></div><div class="line">          name: config-volume</div><div class="line">        - mountPath: <span class="string">"/etc/localtime"</span></div><div class="line">          name: time</div><div class="line">          <span class="built_in">read</span>Only: <span class="literal">true</span></div><div class="line">        resources:</div><div class="line">          requests:</div><div class="line">            cpu: 1</div><div class="line">            memory: 1Gi</div><div class="line">          limits:</div><div class="line">            cpu: 1</div><div class="line">            memory: 2Gi</div><div class="line">      - image: prom/alertmanager:v0.14.0</div><div class="line">        name: alertmanager</div><div class="line">        args: </div><div class="line">        - <span class="string">"--config.file=/etc/alertmanager/config.yml"</span></div><div class="line">        - <span class="string">"--storage.path=/alertmanager"</span></div><div class="line">        ports:</div><div class="line">        - containerPort: 9093</div><div class="line">          hostPort: 9093</div><div class="line">          protocol: TCP</div><div class="line">          name: http</div><div class="line">        volumeMounts:</div><div class="line">        - name: alertmanager-config-volume</div><div class="line">          mountPath: /etc/alertmanager</div><div class="line">        resources:</div><div class="line">          requests:</div><div class="line">            memory: 500Mi</div><div class="line">          limits:</div><div class="line">            memory: 1024Mi</div><div class="line"></div><div class="line">      volumes:</div><div class="line">      - name: data</div><div class="line">        hostPath:</div><div class="line">          path: <span class="string">"/data/monitor"</span></div><div class="line">      - name: time</div><div class="line">        hostPath:</div><div class="line">          path: <span class="string">"/etc/localtime"</span></div><div class="line">      - configMap:</div><div class="line">          name: prometheus-config</div><div class="line">        name: config-volume</div><div class="line">      - name: alertmanager-config-volume</div><div class="line">        configMap:</div><div class="line">          name: alertmanager</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@localhost prometheus]<span class="comment"># kubectl apply -f prometheus-deploy.yaml</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@localhost prometheus]<span class="comment"># kubectl get pod -o wide -n kube-ops</span></div><div class="line">prometheus-fc7685cc7-rwlc7   1/1       Running   0          34s       172.30.57.7   192.168.1.198</div><div class="line">[root@localhost prometheus]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@localhst ~]<span class="comment"># netstat -tunlp |egrep '9090|9093'</span></div><div class="line">tcp6       0      0 :::9090                 :::*                    LISTEN      4023/docker-proxy   </div><div class="line">tcp6       0      0 :::9093                 :::*                    LISTEN      3983/docker-proxy   </div><div class="line">[root@localhst ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h4 id="访问prometheus"><a href="#访问prometheus" class="headerlink" title="访问prometheus"></a>访问prometheus</h4><p>prometheus启动成功后，我们就可以打开prometheus dashboard查看了，访问 <a href="http://ip:9090/graph" target="_blank" rel="external">http://ip:9090/graph</a> ，点<code>status</code>–&gt;<code>Targets</code><br>可以看到prometheus已经成功访问到k8s api-server并获取到监控指标<br><img src="https://note.youdao.com/yws/api/personal/file/5A5C1E0628B743DFA4F4B2B73F2429EC?method=download&amp;shareKey=202dd33859c3cb11ad6ae23b375830c0" alt="prometheus_dashboard">  </p>
<h4 id="访问Alertmanager"><a href="#访问Alertmanager" class="headerlink" title="访问Alertmanager"></a>访问Alertmanager</h4><p>alertmanager启动后，我们可以打开alertmanager Dashboard查看，访问 <a href="http://ip:9093" target="_blank" rel="external">http://ip:9093</a><br>当然在prometheus dashboard也可以查看，在status –&gt; Runtime &amp; Build Information 最底部<br><img src="https://note.youdao.com/yws/api/personal/file/98EFE5C15FC540FA908C5C1497D91920?method=download&amp;shareKey=0b20c6a63adc15aeaa13dd0d4a5ea71b" alt="prometheus_dashboard"><br><img src="https://note.youdao.com/yws/api/personal/file/2D1F17C7438142699F963870A6390F11?method=download&amp;shareKey=2402d8b386b7043bd5f1f786f887a6d7" alt="alertmanager_dashboard">  </p>
<h4 id="告警规则"><a href="#告警规则" class="headerlink" title="告警规则"></a>告警规则</h4><p>在Prometheus定义的rules生效后，可以在Status –&gt;Rules 这里看到<br><img src="https://note.youdao.com/yws/api/personal/file/9B322CA7B9D94AC2A64A4D0F6EF7782E?method=download&amp;shareKey=ec1e3d77582b99329a81377f5b06af3c" alt="Prometheus_rules">  </p>
<ul>
<li>点击的<code>expr</code>会直接跳转到<code>Prometheus graph</code>页面查询，在制定报警规则的时候，可以先在Prometheus中测试表达式  </li>
</ul>
<p>在Prometheus的Alerts这里可以看到触发告警规则的状态<br><img src="https://note.youdao.com/yws/api/personal/file/BFEF5FDAB48243208845A6B9ECB73E82?method=download&amp;shareKey=cb282de4e9235539cfd9de06c25bb8f8" alt="Prometheus_alerts">  </p>
<p>目前有三台主机成功触发规则<br><img src="https://note.youdao.com/yws/api/personal/file/99BC064346EF4145B7BFC379074D6E95?method=download&amp;shareKey=dbb2f00e073c3decc6ac212e89afde20" alt="Prometheus_alerts"><br>一个报警信息在生命周期内有下面3中状态：  </p>
<ul>
<li><code>inactive</code>: 表示当前报警信息既不是<code>firing</code>状态也不是<code>pending</code>状态  </li>
<li><code>pending</code>: 表示在设置的阈值时间范围内被激活。这时Prometheus处于等待状态，大概等待3分钟左右，整合所有的告警条目，等待集中发送给Alertmanager  </li>
<li><code>firing</code>: 表示超过设置的阈值时间被激活。这时Prometheus处于发送告警到Alertmanager阶段，也是最终状态  </li>
</ul>
<p>触发规则后，也可以在Alertmanager Dashboard上看到<br><img src="https://note.youdao.com/yws/api/personal/file/286134D8EF3840CEA3007194B8DC3F94?method=download&amp;shareKey=0fed791095cd1092ac1edd0d5371afc2" alt="Alertmanager_dashboard">  </p>
<p>最后来一张，我们成功收到Alertmanager的告警邮件截图<br><img src="https://note.youdao.com/yws/api/personal/file/76A8767C9A4A4D918619F8FAEBC1D5C6?method=download&amp;shareKey=f1e80c27014145cc5690093c25dda3d1" alt="Alertmanager_mail">  </p>
<h5 id="查询监控数据"><a href="#查询监控数据" class="headerlink" title="查询监控数据"></a>查询监控数据</h5><p>Prometheus提供了<code>API</code>的方式进行数据查询，同样可以使用<code>query语言</code>进行复杂的查询任务<br>点<code>Graph</code><br>查询每个POD的CPU使用情况，输入：<br><code>sum by (pod_name)( rate(container_cpu_usage_seconds_total{image!=&quot;&quot;, pod_name!=&quot;&quot;}[1m] ) )</code><br><img src="https://note.youdao.com/yws/api/personal/file/B481FAA4C243432B866A7F842B360E5D?method=download&amp;shareKey=29a94a564c7abd86ff5f1317ffb76abe" alt="prometheus_dashboard"><br><img src="https://note.youdao.com/yws/api/personal/file/6ED534C0E64B4E12A72B5BD9E3851277?method=download&amp;shareKey=440bb39fc1c4e47e8e812b283553d30e" alt="prometheus_dashboard">  </p>
<p>更多查询条件参考：<br><a href="https://prometheus.io/docs/prometheus/latest/querying/basics/" target="_blank" rel="external">https://prometheus.io/docs/prometheus/latest/querying/basics/</a><br><a href="https://prometheus.io/docs/prometheus/latest/querying/api/" target="_blank" rel="external">https://prometheus.io/docs/prometheus/latest/querying/api/</a><br><a href="https://prometheus.io/docs/prometheus/latest/querying/examples/" target="_blank" rel="external">https://prometheus.io/docs/prometheus/latest/querying/examples/</a>  </p>
<h4 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h4><p>Question：<br>如果遇到下面的报错：<br><img src="https://note.youdao.com/yws/api/personal/file/8657660A593F4FFBBC965F98A79D973E?method=download&amp;shareKey=7eb28760c6b0ae77dabd41cadb223118" alt="prometheus_error"><br><img src="https://note.youdao.com/yws/api/personal/file/1CFA492189C44463B3D098625571B0BB?method=download&amp;shareKey=2b33b854b21704a8f10d677b3e645ee2" alt="prometheus_error">  </p>
<p>Answer：<br>在<code>prometheus-deploy.yaml</code>中<code>spec.spec.</code>下增加如下配置：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">securityContext:</div><div class="line">  runAsUser: 0</div></pre></td></tr></table></figure></p>
<p>详细配置参考上面prometheus-deploy.yaml配置文件<br>参考：<a href="https://github.com/prometheus/prometheus/issues/2939" target="_blank" rel="external">https://github.com/prometheus/prometheus/issues/2939</a>  </p>
<p>Question：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">level=error ts=2018-04-23T13:08:34.417214948Z <span class="built_in">caller</span>=notify.go:303 component=dispatcher msg=<span class="string">"Error on notify"</span> err=<span class="string">"dial t</span></div><div class="line">cp 14.18.245.164:25: getsockopt: connection timed out"level=error ts=2018-04-23T13:08:34.417316796Z <span class="built_in">caller</span>=dispatch.go:266 component=dispatcher msg=<span class="string">"Notify for alerts failed"</span> </div><div class="line">num_alerts=3 err=<span class="string">"dial tcp 14.18.245.164:25: getsockopt: connection timed out"</span></div></pre></td></tr></table></figure></p>
<p>Answer：<br>遇到上面的报错，首先先检查下docker容器是否联网，再测试下与smtp服务器是否正常通讯<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">telnet smtp.qq.com 25</div></pre></td></tr></table></figure></p>
<p>在测试过程中发现，腾讯邮箱(个人QQ邮件+企业邮箱)，只支持SMTP SSL 465端口，且不支持TLS，<code>smtp_require_tls</code>这个参数官方默认是<code>true</code>，这里需要设置为 <code>smtp_require_tls: false</code>，使用不同邮箱的SMTP 需要具体测试。  </p>
<h4 id="Prometheus监控Kubernetes-HTTP集群"><a href="#Prometheus监控Kubernetes-HTTP集群" class="headerlink" title="Prometheus监控Kubernetes HTTP集群"></a>Prometheus监控Kubernetes HTTP集群</h4><p>环境：<br>　　　Prometheus v1.0.1<br>　　　node-exporter v0.15.2<br>　　　Kubernetes v1.8.2  </p>
<p>服务器环境如上  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#获取k8s kube-apiserver地址和端口</span></div><div class="line">[root@localhost ~]<span class="comment"># netstat -tunlp |grep -i kube-apiserver</span></div><div class="line">tcp        0      0 192.168.1.195:6443      0.0.0.0:*               LISTEN      4555/kube-apiserver </div><div class="line">tcp        0      0 192.168.1.195:8080      0.0.0.0:*               LISTEN      4555/kube-apiserver </div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@localhost prometheus]<span class="comment"># kubectl apply -f node-exporter.yaml </span></div><div class="line">[root@localhost prometheus]<span class="comment"># kubectl apply -f prometheus-config.yaml </span></div><div class="line">[root@localhost prometheus]<span class="comment"># kubectl apply -f prometheus-deploy.yaml</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@localhost prometheus]<span class="comment"># kubectl get pod -n kube-ops -o wide</span></div><div class="line">NAME                          READY     STATUS    RESTARTS   AGE       IP            NODE</div><div class="line">node-exporter-hjgds           1/1       Running   0          23m       172.30.41.5   192.168.1.199</div><div class="line">node-exporter-zmlcg           1/1       Running   0          23m       172.30.57.6   192.168.1.198</div><div class="line">prometheus-5f86bc8bc5-tbnxp   1/1       Running   0          10m       172.30.41.6   192.168.1.199</div><div class="line">[root@localhost prometheus]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@localhost prometheus]<span class="comment"># kubectl get svc -n kube-ops -o wide</span></div><div class="line">NAME            TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE       SELECTOR</div><div class="line">node-exporter   ClusterIP   172.16.40.83   &lt;none&gt;        9100/TCP   24m       k8s-app=node-exporter</div><div class="line">[root@localhost prometheus]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@localhost prometheus]<span class="comment"># kubectl get ConfigMap -n kube-ops -o wide</span></div><div class="line">NAME                DATA      AGE</div><div class="line">prometheus-config   1         22m</div><div class="line">[root@localhost prometheus]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p><img src="https://note.youdao.com/yws/api/personal/file/15FCF902C5EB4A54A3728C01830296A5?method=download&amp;shareKey=29ebc89d7b0cc24633dbcf0918e2d9ab" alt="prometheus_dashboard_http">  </p>
<p>其他的同上，Prometheus监控Kubernetes HTTP集群配置文件见附件<br>注：经测试，目前只发现<code>Prometheus v1.0.1</code>支持，测试其他版本都有报错  </p>
<p>参考：<br><a href="https://blog.qikqiak.com/post/kubernetes-monitor-prometheus-grafana/" target="_blank" rel="external">https://blog.qikqiak.com/post/kubernetes-monitor-prometheus-grafana/</a><br><a href="https://blog.qikqiak.com/post/update-prometheus-2-in-kubernetes/" target="_blank" rel="external">https://blog.qikqiak.com/post/update-prometheus-2-in-kubernetes/</a><br><a href="https://github.com/cnych/k8s-repo/tree/master/prometheus" target="_blank" rel="external">https://github.com/cnych/k8s-repo/tree/master/prometheus</a><br><a href="https://blog.qikqiak.com/post/alertmanager-of-prometheus-in-practice/" target="_blank" rel="external">https://blog.qikqiak.com/post/alertmanager-of-prometheus-in-practice/</a><br><a href="https://blog.csdn.net/qq_21398167/article/details/76008594?locationnum=10&amp;fps=1" target="_blank" rel="external">https://blog.csdn.net/qq_21398167/article/details/76008594?locationnum=10&amp;fps=1</a><br><a href="https://segmentfault.com/a/1190000008695463" target="_blank" rel="external">https://segmentfault.com/a/1190000008695463</a><br><a href="https://prometheus.io/docs/alerting/overview/" target="_blank" rel="external">https://prometheus.io/docs/alerting/overview/</a>  </p>
<p>附件：<br><a href="https://note.youdao.com/yws/api/personal/file/E0F2C93038D3412091FDA362DB3B5C77?method=download&amp;shareKey=debbdb748ebf0483c64e3ee2e3e5eb0d" target="_blank" rel="external">Prometheus监控TLS K8S配置文件.zip</a><br><a href="https://note.youdao.com/yws/api/personal/file/E14D629E3CD24DB180F879AC4B8D89F3?method=download&amp;shareKey=ec648c66a75a232d80cd93ed540b3960" target="_blank" rel="external">Prometheus监控K8S HTTP配置文件.zip</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2018/03/14/Prometheus监控TLS-Kubernetes集群/">http://www.yfshare.vip/2018/03/14/Prometheus监控TLS-Kubernetes集群/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[部署TLS k8s]]></title>
      <url>http://www.yfshare.vip/2018/02/23/%E9%83%A8%E7%BD%B2TLS-k8s/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>Kubernetes是一个开源的，用于管理云平台中多个主机上的容器化的应用，Kubernetes的目标是让部署容器化的应用简单并且高效(powerful)，Kubernetes提供了应用部署，规划，更新，维护的一种机制。Kubernetes一个核心的特点就是能够自主的管理容器来保证云平台中的容器按照用户的期望状态运行。<br><a id="more"></a><br>环境：<br>　　　Centos 7.4.1708<br>　　　dockers 18.02.0-ce-rc1<br>　　　kubernetes v1.9.2<br>　　　etcd 3.2.15  </p>
<p>k8s下载地址：<a href="https://github.com/kubernetes/kubernetes/releases" target="_blank" rel="external">https://github.com/kubernetes/kubernetes/releases</a><br><a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.9.md#v192" target="_blank" rel="external">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.9.md#v192</a>  </p>
<h4 id="基础配置"><a href="#基础配置" class="headerlink" title="基础配置"></a>基础配置</h4><p>同步时间，所有节点均操作<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime -a</span></div><div class="line"><span class="comment"># ntpdate s1a.time.edu.cn</span></div><div class="line"><span class="comment"># crontab -l</span></div><div class="line">* */3 * * * ntpdate s1a.time.edu.cn &amp;&gt; /dev/null</div><div class="line"><span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>设置主机名<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># hostname master1.example.com</span></div><div class="line">[root@master2 ~]<span class="comment"># hostname master2.example.com</span></div><div class="line">[root@master3 ~]<span class="comment"># hostname master3.example.com</span></div><div class="line">[root@node1 ~]<span class="comment"># hostname node1.example.com</span></div><div class="line">[root@node2 ~]<span class="comment"># hostname node2.example.com</span></div><div class="line"></div><div class="line"><span class="comment">#三个节点均做hosts解析</span></div><div class="line"><span class="comment"># tail -5 /etc/hosts</span></div><div class="line">192.168.1.195 master1.example.com master1</div><div class="line">192.168.1.196 master2.example.com master2</div><div class="line">192.168.1.197 master3.example.com master3</div><div class="line">192.168.1.198 node1.example.com node1</div><div class="line">192.168.1.199 node2.example.com node2</div><div class="line"><span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>关闭防火墙和Selinux，所有节点都操作<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">iptables -F</div><div class="line">systemctl stop firewalld</div><div class="line">systemctl <span class="built_in">disable</span> firewalld</div><div class="line">setenforce 0</div></pre></td></tr></table></figure></p>
<h4 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h4><table>
<thead>
<tr>
<th>角色</th>
<th>IP</th>
<th>组件</th>
</tr>
</thead>
<tbody>
<tr>
<td>Master1 + ETCD1</td>
<td>192.168.1.195</td>
<td>etcd、kube-apiserver、kube-controller-manager、kube-scheduler、Flannel</td>
</tr>
<tr>
<td>ETCD2</td>
<td>192.168.1.196</td>
<td>etcd</td>
</tr>
<tr>
<td>ETCD3</td>
<td>192.168.1.197</td>
<td>etcd</td>
</tr>
<tr>
<td>Node1</td>
<td>192.168.1.198</td>
<td>kubelet、kube-proxy、docker、Flannel</td>
</tr>
<tr>
<td>Node2</td>
<td>192.168.1.199</td>
<td>kubelet、kube-proxy、docker、Flannel</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>名称</th>
<th>网段/地址</th>
<th>参数</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>Service_CIDR</td>
<td>172.16.0.0/16</td>
<td><code>--service-cluster-ip-range</code></td>
<td>服务 网段</td>
</tr>
<tr>
<td>Cluster_CIDR</td>
<td>172.30.0.0/16</td>
<td><code>--cluster-cidr</code></td>
<td>POD 网段</td>
</tr>
<tr>
<td>CLUSTER_KUBERNETES_SVC_IP</td>
<td>172.16.0.1</td>
<td>-</td>
<td>kubernetes 服务IP，SERVICE_CIDR 中第一个IP</td>
</tr>
<tr>
<td>CLUSTER_DNS_SVC_IP</td>
<td>172.16.0.2</td>
<td>-</td>
<td>集群DNS 服务IP，SERVICE_CIDR 中第二个IP</td>
</tr>
<tr>
<td>NODE_PORT_RANGE</td>
<td>8400-9000</td>
<td>服务端口 范围</td>
</tr>
<tr>
<td>CLUSTER_DNS_DOMAIN</td>
<td>-</td>
<td><code>cluster.local.</code></td>
<td>集群DNS域名</td>
</tr>
<tr>
<td>FLANNEL_ETCD_PREFIX</td>
<td>-</td>
<td><code>/kubernetes/network</code></td>
<td>flanneld 网络配置前缀</td>
</tr>
</tbody>
</table>
<p>安装Docker<br>在node1/node2这2个节点都安装docker引擎<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">yum remove docker docker-common docker-selinux docker-engine -y</div><div class="line">yum install -y yum-utils device-mapper-persistent-data lvm2</div><div class="line">yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</div><div class="line">yum-config-manager --enable docker-ce-edge</div><div class="line">yum-config-manager --enable docker-ce-test</div><div class="line">yum install docker-ce -y</div><div class="line">systemctl <span class="built_in">enable</span> docker</div><div class="line">systemctl start docker</div></pre></td></tr></table></figure></p>
<h4 id="创建-CA-证书和秘钥"><a href="#创建-CA-证书和秘钥" class="headerlink" title="创建 CA 证书和秘钥"></a>创建 CA 证书和秘钥</h4><p>kubernetes 系统各组件需要使用 TLS 证书对通信进行加密，这里使用 CloudFlare 的 PKI 工具集 cfssl 来生成 Certificate Authority (CA) 证书和秘钥文件，CA 是自签名的证书，用来签名后续创建的其它 TLS 证书  </p>
<h5 id="安装-CFSSL"><a href="#安装-CFSSL" class="headerlink" title="安装 CFSSL"></a>安装 CFSSL</h5><p>cfssl下载地址：<a href="https://github.com/cloudflare/cfssl/releases" target="_blank" rel="external">https://github.com/cloudflare/cfssl/releases</a><br><a href="https://note.youdao.com/yws/api/personal/file/E9CE8AF7520D47F69337DCE8F6DBAC9E?method=download&amp;shareKey=240e513d965d3476e1aeaae363ca8689" target="_blank" rel="external">cfssl R1.2工具包本地下载</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -O /usr/local/bin/cfssl</span></div><div class="line">[root@master1 ~]<span class="comment"># wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -O /usr/local/bin/cfssljson</span></div><div class="line">[root@master1 ~]<span class="comment"># wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 -O /usr/local/bin/cfssl-certinfo</span></div><div class="line">[root@master1 ~]<span class="comment"># chmod +x /usr/local/bin/cfssl*</span></div><div class="line">[root@master1 ~]<span class="comment"># mkdir ssl &amp;&amp; cd ssl</span></div><div class="line"></div><div class="line"><span class="comment">#测试</span></div><div class="line">[root@master1 ssl]<span class="comment"># cfssl print-defaults config &gt; config.json</span></div><div class="line">[root@master1 ssl]<span class="comment"># cfssl print-defaults csr &gt; csr.json</span></div></pre></td></tr></table></figure></p>
<h5 id="创建-CA-Certificate-Authority"><a href="#创建-CA-Certificate-Authority" class="headerlink" title="创建 CA (Certificate Authority)"></a>创建 CA (Certificate Authority)</h5><table>
<thead>
<tr>
<th>证书名称</th>
<th>配置文件</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>ca.pem</td>
<td>ca-config.json</td>
<td>CA 配置文件</td>
</tr>
<tr>
<td>etcd.pem</td>
<td>ca-csr.json</td>
<td>CA 证书</td>
</tr>
</tbody>
</table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># cat ca-config.json </span></div><div class="line">&#123;</div><div class="line">  <span class="string">"signing"</span>: &#123;</div><div class="line">    <span class="string">"default"</span>: &#123;</div><div class="line">      <span class="string">"expiry"</span>: <span class="string">"8760h"</span></div><div class="line">    &#125;,</div><div class="line">    <span class="string">"profiles"</span>: &#123;</div><div class="line">      <span class="string">"kubernetes"</span>: &#123;</div><div class="line">        <span class="string">"usages"</span>: [</div><div class="line">            <span class="string">"signing"</span>,</div><div class="line">            <span class="string">"key encipherment"</span>,</div><div class="line">            <span class="string">"server auth"</span>,</div><div class="line">            <span class="string">"client auth"</span></div><div class="line">        ],</div><div class="line">        <span class="string">"expiry"</span>: <span class="string">"8760h"</span></div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">[root@master1 ssl]<span class="comment">#</span></div></pre></td></tr></table></figure>
<ul>
<li>ca-config.json：可以定义多个 profiles，分别指定不同的过期时间、使用场景等参数；后续在签名证书时使用某个 profile；</li>
<li>signing：表示该证书可用于签名其它证书；生成的 ca.pem 证书中 CA=TRUE；</li>
<li>server auth：表示 client 可以用该 CA 对 server 提供的证书进行验证；</li>
<li>client auth：表示 server 可以用该 CA 对 client 提供的证书进行验证；</li>
</ul>
<h5 id="创建-CA-证书签名请求"><a href="#创建-CA-证书签名请求" class="headerlink" title="创建 CA 证书签名请求"></a>创建 CA 证书签名请求</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># cat ca-csr.json </span></div><div class="line">&#123;</div><div class="line">  <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</div><div class="line">  <span class="string">"key"</span>: &#123;</div><div class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</div><div class="line">    <span class="string">"size"</span>: 2048</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"names"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</div><div class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</div><div class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line">[root@master1 ssl]<span class="comment">#</span></div></pre></td></tr></table></figure>
<ul>
<li>“CN”：Common Name，kube-apiserver 从证书中提取该字段作为请求的用户名 (User Name)；浏览器使用该字段验证网站是否合法；</li>
<li>“O”：Organization，kube-apiserver 从证书中提取该字段作为请求用户所属的组 (Group)；</li>
</ul>
<h5 id="生成-CA-证书和私钥"><a href="#生成-CA-证书和私钥" class="headerlink" title="生成 CA 证书和私钥"></a>生成 CA 证书和私钥</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># cfssl gencert -initca ca-csr.json | cfssljson -bare ca</span></div><div class="line"></div><div class="line">[root@master1 ssl]<span class="comment"># ls ca*</span></div><div class="line">ca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem</div><div class="line">[root@master1 ssl]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h5 id="分发证书"><a href="#分发证书" class="headerlink" title="分发证书"></a>分发证书</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># mkdir -p /etc/kubernetes/ssl</span></div><div class="line">[root@master1 ssl]<span class="comment"># cp ca* /etc/kubernetes/ssl</span></div><div class="line">[root@master1 ssl]<span class="comment"># ls /etc/kubernetes/ssl/</span></div><div class="line">ca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem</div><div class="line">[root@master1 ssl]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># ssh root@192.168.1.196 "mkdir -p /etc/kubernetes/ssl"</span></div><div class="line">[root@master1 ssl]<span class="comment"># scp /etc/kubernetes/ssl/ca* root@192.168.1.196:/etc/kubernetes/ssl/</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># ssh root@192.168.1.197 "mkdir -p /etc/kubernetes/ssl"</span></div><div class="line">[root@master1 ssl]<span class="comment"># scp /etc/kubernetes/ssl/ca* root@192.168.1.197:/etc/kubernetes/ssl/</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># ssh root@192.168.1.198 "mkdir -p /etc/kubernetes/ssl"</span></div><div class="line">[root@master1 ssl]<span class="comment"># scp /etc/kubernetes/ssl/ca* root@192.168.1.198:/etc/kubernetes/ssl/</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># ssh root@192.168.1.199 "mkdir -p /etc/kubernetes/ssl"</span></div><div class="line">[root@master1 ssl]<span class="comment"># scp /etc/kubernetes/ssl/ca* root@192.168.1.199:/etc/kubernetes/ssl/</span></div></pre></td></tr></table></figure>
<h4 id="部署高可用-etcd-集群"><a href="#部署高可用-etcd-集群" class="headerlink" title="部署高可用 etcd 集群"></a>部署高可用 etcd 集群</h4><p>需要关闭 selinux，关闭防火墙，ntpdate 时间同步<br>kuberntes 系统使用 etcd 存储所有数据，这里和kuberntes master安装到一起<br>三个etcd分别取名为：etcd1、etcd2、etcd3  </p>
<table>
<thead>
<tr>
<th>集群名称</th>
<th>IP</th>
<th>集群地址</th>
</tr>
</thead>
<tbody>
<tr>
<td>etcd1</td>
<td>192.168.1.195</td>
<td><a href="https://192.168.1.195:2379" target="_blank" rel="external">https://192.168.1.195:2379</a></td>
</tr>
<tr>
<td>etcd2</td>
<td>192.168.1.196</td>
<td><a href="https://192.168.1.196:2379" target="_blank" rel="external">https://192.168.1.196:2379</a></td>
</tr>
<tr>
<td>etcd3</td>
<td>192.168.1.197</td>
<td><a href="https://192.168.1.197:2379" target="_blank" rel="external">https://192.168.1.197:2379</a></td>
</tr>
</tbody>
</table>
<h5 id="安装-Etcd"><a href="#安装-Etcd" class="headerlink" title="安装 Etcd"></a>安装 Etcd</h5><p><strong>三个节点master均安装</strong><br>etcd下载地址：<a href="https://github.com/coreos/etcd/releases" target="_blank" rel="external">https://github.com/coreos/etcd/releases</a><br><a href="https://note.youdao.com/yws/api/personal/file/A48C40B53E5442D0A87D037CF9683155?method=download&amp;shareKey=1925129c3689f9cf58802e996e8103bb" target="_blank" rel="external">etcd-v3.2.15本地下载</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># wget https://github.com/coreos/etcd/releases/download/v3.2.15/etcd-v3.2.15-linux-amd64.tar.gz</span></div><div class="line">[root@master1 ~]<span class="comment"># tar -zxf etcd-v3.2.15-linux-amd64.tar.gz</span></div><div class="line">[root@master1 ~]<span class="comment"># cp -a etcd-v3.2.15-linux-amd64/etcd* /usr/local/bin/</span></div></pre></td></tr></table></figure></p>
<h5 id="创建-TLS-秘钥和证书"><a href="#创建-TLS-秘钥和证书" class="headerlink" title="创建 TLS 秘钥和证书"></a>创建 TLS 秘钥和证书</h5><p>为了保证通信安全，客户端(如 etcdctl) 与 etcd 集群、etcd 集群之间的通信需要使用 TLS 加密  </p>
<p>创建 etcd 证书签名请求<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># mkdir -p ssl/</span></div><div class="line">[root@master1 ~]<span class="comment"># cd ssl/</span></div><div class="line">[root@master1 ssl]<span class="comment"># cat etcd-csr.json </span></div><div class="line">&#123;</div><div class="line">  <span class="string">"CN"</span>: <span class="string">"etcd"</span>,</div><div class="line">  <span class="string">"hosts"</span>: [</div><div class="line">    <span class="string">"127.0.0.1"</span>,</div><div class="line">    <span class="string">"192.168.1.195"</span>,</div><div class="line">    <span class="string">"192.168.1.196"</span>,</div><div class="line">    <span class="string">"192.168.1.197"</span></div><div class="line">  ],</div><div class="line">  <span class="string">"key"</span>: &#123;</div><div class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</div><div class="line">    <span class="string">"size"</span>: 2048</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"names"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</div><div class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</div><div class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line">[root@master1 ssl]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<ul>
<li>hosts 字段指定授权使用该证书的 etcd 节点 IP</li>
</ul>
<p>生成 etcd 证书和私钥<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># cfssl gencert -ca=/etc/kubernetes/ssl/ca.pem -ca-key=/etc/kubernetes/ssl/ca-key.pem -config=/etc/kubernetes/ssl/ca-config.json -profile=kubernetes etcd-csr.json | cfssljson -bare etcd</span></div><div class="line">[root@master1 ssl]<span class="comment"># ls etcd*</span></div><div class="line">etcd.csr  etcd-csr.json  etcd-key.pem  etcd.pem</div><div class="line">[root@master1 ssl]<span class="comment"># mkdir -p /etc/etcd/ssl</span></div><div class="line">[root@master1 ssl]<span class="comment"># cp etcd*.pem /etc/etcd/ssl/</span></div></pre></td></tr></table></figure></p>
<p>创建 etcd 的 systemd unit 文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># mkdir -p /var/lib/etcd</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># cat etcd.service </span></div><div class="line">[Unit]</div><div class="line">Description=Etcd Server</div><div class="line">After=network.target</div><div class="line">After=network-online.target</div><div class="line">Wants=network-online.target</div><div class="line">Documentation=https://github.com/coreos</div><div class="line"></div><div class="line">[Service]</div><div class="line">Type=notify</div><div class="line">WorkingDirectory=/var/lib/etcd/</div><div class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/etcd \</div><div class="line">  --name=etcd1 \</div><div class="line">  --cert-file=/etc/etcd/ssl/etcd.pem \</div><div class="line">  --key-file=/etc/etcd/ssl/etcd-key.pem \</div><div class="line">  --peer-cert-file=/etc/etcd/ssl/etcd.pem \</div><div class="line">  --peer-key-file=/etc/etcd/ssl/etcd-key.pem \</div><div class="line">  --trusted-ca-file=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  --peer-trusted-ca-file=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  --initial-advertise-peer-urls=https://192.168.1.195:2380 \</div><div class="line">  --listen-peer-urls=https://192.168.1.195:2380 \</div><div class="line">  --listen-client-urls=https://192.168.1.195:2379,http://127.0.0.1:2379 \</div><div class="line">  --advertise-client-urls=https://192.168.1.195:2379 \</div><div class="line">  --initial-cluster-token=etcd-cluster-0 \</div><div class="line">  --initial-cluster=etcd1=https://192.168.1.195:2380,etcd2=https://192.168.1.196:2380,etcd3=https://192.168.1.197:2380 \</div><div class="line">  --initial-cluster-state=new \</div><div class="line">  --data-dir=/var/lib/etcd</div><div class="line">Restart=on-failure</div><div class="line">RestartSec=5</div><div class="line">LimitNOFILE=65536</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<ul>
<li>指定 etcd 的工作目录和数据目录为<code>/var/lib/etcd</code>，需在启动服务前创建这个目录</li>
<li><code>--name</code>为当前etcd的名称，<strong>每个etcd节点名字不能相同</strong></li>
<li><code>--initial-advertise-peer-urls</code>，<code>--listen-peer-urls</code>，<code>--listen-client-urls</code>，<code>--advertise-client-urls</code>这四个参数需要修改为<strong>当前节点的IP地址</strong>  </li>
<li><code>--initial-cluster</code>参数为，etcd集群所有节点的IP地址</li>
<li>为了保证通信安全，需要指定 etcd 的公私钥(<code>cert-file</code>和<code>key-file</code>)、Peers 通信的公私钥和 CA 证书(<code>peer-cert-file</code>、<code>peer-key-file</code>、<code>peer-trusted-ca-file</code>)、客户端的CA证书（<code>trusted-ca-file</code>）</li>
<li><code>--initial-cluster-state</code>值为 new 时，<code>--name</code> 的参数值必须位于 <code>--initial-cluster</code> 列表中</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># mv etcd.service /etc/systemd/system/</span></div></pre></td></tr></table></figure>
<p>分发etcd证书<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># ssh root@192.168.1.196 "mkdir -p /var/lib/etcd"</span></div><div class="line">[root@master1 ~]<span class="comment"># ssh root@192.168.1.196 "mkdir -p /etc/etcd/ssl"</span></div><div class="line">[root@master1 ~]<span class="comment"># scp /etc/etcd/ssl/etcd* root@192.168.1.196:/etc/etcd/ssl/</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># ssh root@192.168.1.197 "mkdir -p /var/lib/etcd"</span></div><div class="line">[root@master1 ~]<span class="comment"># ssh root@192.168.1.197 "mkdir -p /etc/etcd/ssl"</span></div><div class="line">[root@master1 ~]<span class="comment"># scp /etc/etcd/ssl/etcd* root@192.168.1.197:/etc/etcd/ssl/</span></div></pre></td></tr></table></figure>
<p>分发etcd.service<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># scp /etc/systemd/system/etcd.service root@192.168.1.196:/etc/systemd/system/</span></div><div class="line">[root@master1 ~]<span class="comment"># scp /etc/systemd/system/etcd.service root@192.168.1.197:/etc/systemd/system/</span></div></pre></td></tr></table></figure></p>
<p>启动 etcd 服务<br>依次启动所有节点的etcd服务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">systemctl daemon-reload</div><div class="line">systemctl <span class="built_in">enable</span> etcd</div><div class="line">systemctl start etcd</div></pre></td></tr></table></figure></p>
<ul>
<li>最先启动的 etcd 进程会卡住一段时间，再等待其它节点上的 etcd 进程加入集群，这是正常现象</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># export ETCDCTL_API=3</span></div><div class="line">[root@master1 ~]<span class="comment"># etcdctl --cacert=/etc/kubernetes/ssl/ca.pem --cert=/etc/etcd/ssl/etcd.pem --key=/etc/etcd/ssl/etcd-key.pem --endpoints=https://192.168.1.195:2379,https://192.168.1.196:2379,https://192.168.1.197:2379 endpoint health</span></div><div class="line">https://192.168.1.197:2379 is healthy: successfully committed proposal: took = 1.631081ms</div><div class="line">https://192.168.1.195:2379 is healthy: successfully committed proposal: took = 1.187637ms</div><div class="line">https://192.168.1.196:2379 is healthy: successfully committed proposal: took = 1.461928ms</div></pre></td></tr></table></figure>
<h4 id="部署Flannel-网络"><a href="#部署Flannel-网络" class="headerlink" title="部署Flannel 网络"></a>部署Flannel 网络</h4><p>Flannel是 CoreOS 团队针对 Kubernetes 设计的一个覆盖网络（Overlay Network）工具，其目的在于帮助每一个使用 Kuberentes 的 CoreOS 主机拥有一个完整的子网。简单来说，它的功能是让集群中的不同节点主机创建的Docker容器都具有全集群唯一的虚拟IP地址，因为在默认的Docker配置中，每个节点上的Docker服务会分别负责所在节点容器的IP分配。这样会导致一个问题，不同节点上容器可能获得相同的内外IP地址。Flannel的设计目的就是为集群中的所有节点重新规划IP地址的使用规则，从而使得不同节点上的容器能够获得“同属一个内网”且”不重复的”IP地址，并让属于不同节点上的容器能够直接通过内网IP通信。   </p>
<p>Flannel通过Etcd服务维护了一张节点间的路由表<br>参考：<a href="http://dockone.io/article/618" target="_blank" rel="external">http://dockone.io/article/618</a>  </p>
<p>flannel下载地址：<a href="https://github.com/coreos/flannel/releases" target="_blank" rel="external">https://github.com/coreos/flannel/releases</a><br><a href="https://note.youdao.com/yws/api/personal/file/5447ED8CA54D48EF86FB0668FDE54DFF?method=download&amp;shareKey=a9a38141e456fc88a678fdc1309a3dc9" target="_blank" rel="external">flannel-v0.10.0本地下载</a>  </p>
<table>
<thead>
<tr>
<th>节点名称</th>
<th>节点IP</th>
<th>分配地址</th>
</tr>
</thead>
<tbody>
<tr>
<td>node1</td>
<td>192.168.1.198</td>
<td>172.30.57.0</td>
</tr>
<tr>
<td>node2</td>
<td>192.168.1.199</td>
<td>172.30.41.0</td>
</tr>
</tbody>
</table>
<p>在安装有cfssl工具的服务器上操作  </p>
<h5 id="创建-TLS-秘钥和证书-1"><a href="#创建-TLS-秘钥和证书-1" class="headerlink" title="创建 TLS 秘钥和证书"></a>创建 TLS 秘钥和证书</h5><p>etcd 集群启用了双向 TLS 认证，所以需要为 flanneld 指定与 etcd 集群通信的 CA 和秘钥  </p>
<p>创建 CA 配置文件<br>创建 flanneld 证书签名请求<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># cat flanneld-csr.json </span></div><div class="line">&#123;</div><div class="line">  <span class="string">"CN"</span>: <span class="string">"flanneld"</span>,</div><div class="line">  <span class="string">"hosts"</span>: [],</div><div class="line">  <span class="string">"key"</span>: &#123;</div><div class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</div><div class="line">    <span class="string">"size"</span>: 2048</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"names"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</div><div class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</div><div class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line">[root@master1 ssl]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<ul>
<li>hosts 字段为空  </li>
</ul>
<p>生成 flanneld 证书和私钥<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># cfssl gencert -ca=/etc/kubernetes/ssl/ca.pem -ca-key=/etc/kubernetes/ssl/ca-key.pem -config=/etc/kubernetes/ssl/ca-config.json -profile=kubernetes flanneld-csr.json | cfssljson -bare flanneld</span></div><div class="line">[root@master1 ssl]<span class="comment"># ls flanneld*</span></div><div class="line">flanneld.csr  flanneld-csr.json  flanneld-key.pem  flanneld.pem</div><div class="line">[root@master1 ssl]<span class="comment"># mkdir -p /etc/flanneld/ssl</span></div><div class="line">[root@master1 ssl]<span class="comment"># cp -a flanneld*.pem /etc/flanneld/ssl</span></div></pre></td></tr></table></figure></p>
<p>分发flanneld证书<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># ssh root@192.168.1.198 "mkdir -p /etc/flanneld/ssl"</span></div><div class="line">[root@master1 ssl]<span class="comment"># scp /etc/flanneld/ssl/flanneld* root@192.168.1.198:/etc/flanneld/ssl/</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># ssh root@192.168.1.199 "mkdir -p /etc/flanneld/ssl"</span></div><div class="line">[root@master1 ssl]<span class="comment"># scp /etc/flanneld/ssl/flanneld* root@192.168.1.199:/etc/flanneld/ssl/</span></div></pre></td></tr></table></figure>
<p>向 etcd 写入集群 Pod 网段信息<br>使用 etcd v2 API 写入配置<br>前面执行了<code>export ETCDCTL_API=3</code>，这个命令会调用<code>etcd v3 API</code>，所以需要重新打开一个xshell窗口，否则会报错<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># etcdctl --endpoints=https://192.168.1.195:2379,https://192.168.1.195:2379,https://192.168.1.195:2379 --ca-file=/etc/kubernetes/ssl/ca.pem --cert-file=/etc/flanneld/ssl/flanneld.pem --key-file=/etc/flanneld/ssl/flanneld-key.pem set /kubernetes/network/config '&#123;"Network":"'172.30.0.0/16'", "SubnetLen": 24, "Backend": &#123;"Type": "vxlan"&#125;&#125;'</span></div><div class="line">&#123;<span class="string">"Network"</span>:<span class="string">"172.30.0.0/16"</span>, <span class="string">"SubnetLen"</span>: 24, <span class="string">"Backend"</span>: &#123;<span class="string">"Type"</span>: <span class="string">"vxlan"</span>&#125;&#125;</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#查看POD网段信息</span></div><div class="line">[root@master1 ~]<span class="comment"># etcdctl --endpoints=https://192.168.1.195:2379,https://192.168.1.195:2379,https://192.168.1.195:2379 --ca-file=/etc/kubernetes/ssl/ca.pem --cert-file=/etc/flanneld/ssl/flanneld.pem --key-file=/etc/flanneld/ssl/flanneld-key.pem get /kubernetes/network/config</span></div><div class="line">&#123;<span class="string">"Network"</span>:<span class="string">"172.30.0.0/16"</span>, <span class="string">"SubnetLen"</span>: 24, <span class="string">"Backend"</span>: &#123;<span class="string">"Type"</span>: <span class="string">"vxlan"</span>&#125;&#125;</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>安装和配置 flanneld<br>在node1/node2节点安装，master不安装flannel<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># wget https://github.com/coreos/flannel/releases/download/v0.10.0/flannel-v0.10.0-linux-amd64.tar.gz</span></div><div class="line">[root@node1 ~]<span class="comment"># mkdir flannel</span></div><div class="line">[root@node1 ~]<span class="comment"># tar -zxf flannel-v0.10.0-linux-amd64.tar.gz -C flannel</span></div><div class="line">[root@node1 ~]<span class="comment"># cp -a flannel/&#123;flanneld,mk-docker-opts.sh&#125; /usr/local/bin/</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># cat flanneld.service </span></div><div class="line">[Unit]</div><div class="line">Description=Flanneld overlay address etcd agent</div><div class="line">After=network.target</div><div class="line">After=network-online.target</div><div class="line">Wants=network-online.target</div><div class="line">After=etcd.service</div><div class="line">Before=docker.service</div><div class="line"></div><div class="line">[Service]</div><div class="line">Type=notify</div><div class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/flanneld \</div><div class="line">  -etcd-cafile=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  -etcd-certfile=/etc/flanneld/ssl/flanneld.pem \</div><div class="line">  -etcd-keyfile=/etc/flanneld/ssl/flanneld-key.pem \</div><div class="line">  -etcd-endpoints=https://192.168.1.195:2379,https://192.168.1.195:2379,https://192.168.1.195:2379 \</div><div class="line">  -etcd-prefix=/kubernetes/network</div><div class="line">ExecStartPost=/usr/<span class="built_in">local</span>/bin/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS <span class="_">-d</span> /run/flannel/docker</div><div class="line">Restart=on-failure</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div><div class="line">RequiredBy=docker.service</div><div class="line">[root@node1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<ul>
<li>mk-docker-opts.sh脚本将分配给 flanneld 的 Pod 子网网段信息写入到 /run/flannel/docker 文件中，后续 docker 启动时使用这个文件中参数值设置 docker0 网桥；</li>
<li>flanneld 使用系统缺省路由所在的接口和其它节点通信，对于有多个网络接口的机器（如，内网和公网），可以用 –iface 选项值指定通信接口(上面的 systemd unit 文件没指定这个选项)，如本着 Vagrant + Virtualbox，就要指定–iface=enp0s8；</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># cp flanneld.service /etc/systemd/system/</span></div></pre></td></tr></table></figure>
<p>启动 flanneld<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">systemctl daemon-reload</div><div class="line">systemctl <span class="built_in">enable</span> flanneld</div><div class="line">systemctl start flanneld</div></pre></td></tr></table></figure></p>
<h6 id="docker集成flanneld网络"><a href="#docker集成flanneld网络" class="headerlink" title="docker集成flanneld网络"></a>docker集成flanneld网络</h6><p>让docker0网卡使用flanneld网络网段地址<br><a href="https://note.youdao.com/yws/api/personal/file/2137351870BB4393A12F4BEC6388DA44?method=download&amp;shareKey=c2e7067c0a4236332b684c8de6881018" target="_blank" rel="external">docker.service-yum</a>安装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># grep -iv '#' /usr/lib/systemd/system/docker.service</span></div><div class="line">[Unit]</div><div class="line">Description=Docker Application Container Engine</div><div class="line">Documentation=https://docs.docker.com</div><div class="line">After=network-online.target firewalld.service</div><div class="line">Wants=network-online.target</div><div class="line"></div><div class="line">[Service]</div><div class="line">Type=notify</div><div class="line"></div><div class="line"><span class="comment">#新增下面两个参数</span></div><div class="line">ExecStart=/usr/bin/dockerd <span class="variable">$DOCKER_NETWORK_OPTIONS</span></div><div class="line">EnvironmentFile=/run/flannel/docker</div><div class="line"></div><div class="line">ExecReload=/bin/<span class="built_in">kill</span> <span class="_">-s</span> HUP <span class="variable">$MAINPID</span></div><div class="line">LimitNOFILE=infinity</div><div class="line">LimitNPROC=infinity</div><div class="line">LimitCORE=infinity</div><div class="line">TimeoutStartSec=0</div><div class="line">Delegate=yes</div><div class="line">KillMode=process</div><div class="line">Restart=on-failure</div><div class="line">StartLimitBurst=3</div><div class="line">StartLimitInterval=60s</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div><div class="line">[root@node1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># systemctl restart docker</span></div></pre></td></tr></table></figure>
<p>检查 flanneld 服务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># ifconfig flannel.1</span></div><div class="line">flannel.1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1450</div><div class="line">        inet 172.30.57.0  netmask 255.255.255.255  broadcast 0.0.0.0</div><div class="line">        inet6 fe80::7890:e0ff:fe20:836e  prefixlen 64  scopeid 0x20&lt;link&gt;</div><div class="line">        ether 7a:90:e0:20:83:6e  txqueuelen 0  (Ethernet)</div><div class="line">        RX packets 0  bytes 0 (0.0 B)</div><div class="line">        RX errors 0  dropped 0  overruns 0  frame 0</div><div class="line">        TX packets 0  bytes 0 (0.0 B)</div><div class="line">        TX errors 0  dropped 8 overruns 0  carrier 0  collisions 0</div><div class="line"></div><div class="line">[root@node1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<ul>
<li>其他节点安装flanneld同上</li>
</ul>
<p>检查分配给各 flanneld 的 Pod 网段信息<br>查看集群 Pod 网段(/16)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># etcdctl --endpoints=https://192.168.1.195:2379,https://192.168.1.195:2379,https://192.168.1.195:2379 --ca-file=/etc/kubernetes/ssl/ca.pem --cert-file=/etc/flanneld/ssl/flanneld.pem --key-file=/etc/flanneld/ssl/flanneld-key.pem get /kubernetes/network/config</span></div><div class="line">&#123;<span class="string">"Network"</span>:<span class="string">"172.30.0.0/16"</span>, <span class="string">"SubnetLen"</span>: 24, <span class="string">"Backend"</span>: &#123;<span class="string">"Type"</span>: <span class="string">"vxlan"</span>&#125;&#125;</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>查看已分配的 Pod 子网段列表(/24)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># etcdctl --endpoints=https://192.168.1.195:2379,https://192.168.1.195:2379,https://192.168.1.195:2379 --ca-file=/etc/kubernetes/ssl/ca.pem --cert-file=/etc/flanneld/ssl/flanneld.pem --key-file=/etc/flanneld/ssl/flanneld-key.pem ls /kubernetes/network/subnets</span></div><div class="line">/kubernetes/network/subnets/172.30.57.0-24</div></pre></td></tr></table></figure></p>
<p>查看某一 Pod 网段对应的 flanneld 进程监听的 IP 和网络参数<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># etcdctl --endpoints=https://192.168.1.195:2379,https://192.168.1.195:2379,https://192.168.1.195:2379 --ca-file=/etc/kubernetes/ssl/ca.pem --cert-file=/etc</span></div><div class="line">/flanneld/ssl/flanneld.pem --key-file=/etc/flanneld/ssl/flanneld-key.pem get /kubernetes/network/subnets/172.30.57.0-24</div><div class="line">&#123;<span class="string">"PublicIP"</span>:<span class="string">"192.168.1.198"</span>,<span class="string">"BackendType"</span>:<span class="string">"vxlan"</span>,<span class="string">"BackendData"</span>:&#123;<span class="string">"VtepMAC"</span>:<span class="string">"7a:90:e0:20:83:6e"</span>&#125;&#125;</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>确保各节点间 Pod 网段能互联互通<br>在各节点上部署完 Flannel 后，查看已分配的 Pod 子网段列表(/24)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># etcdctl --endpoints=https://192.168.1.195:2379,https://192.168.1.195:2379,https://192.168.1.195:2379 --ca-file=/etc/kubernetes/ssl/ca.pem --cert-file=/etc/flanneld/ssl/flanneld.pem --key-file=/etc/flanneld/ssl/flanneld-key.pem ls /kubernetes/network/subnets</span></div><div class="line">/kubernetes/network/subnets/172.30.41.0-24</div><div class="line">/kubernetes/network/subnets/172.30.57.0-24</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>当前两个节点分配的 Pod 网段分别是：172.30.42.0-24、172.30.100.0-24<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># ip a | egrep -i 'docker0|flannel.1'</span></div><div class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN </div><div class="line">    inet 172.30.57.1/24 brd 172.30.57.255 scope global docker0</div><div class="line">4: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN </div><div class="line">    inet 172.30.57.0/32 scope global flannel.1</div><div class="line">[root@node1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@node2 ~]<span class="comment"># ip a | egrep -i 'docker0|flannel.1'</span></div><div class="line">3: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN </div><div class="line">    inet 172.30.42.0/32 scope global flannel.1</div><div class="line">4: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN </div><div class="line">    inet 172.30.42.1/24 brd 172.30.41.255 scope global docker0</div><div class="line">[root@node2 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>在各节点上分配 ping 这两个网段的网关地址，确保能通<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># ping 172.30.57.0 -c 4</span></div><div class="line">[root@node1 ~]<span class="comment"># ping 172.30.42.0 -c 4</span></div></pre></td></tr></table></figure></p>
<h4 id="部署-k8s-master-节点"><a href="#部署-k8s-master-节点" class="headerlink" title="部署 k8s master 节点"></a>部署 k8s master 节点</h4><p>kubernetes master 节点包含的组件:  </p>
<ul>
<li>kube-apiserver</li>
<li>kube-scheduler</li>
<li>kube-controller-manager</li>
</ul>
<p>这三个组件需要部署在同一台机器上  </p>
<ul>
<li><code>kube-scheduler</code>、<code>kube-controller-manager</code> 和 <code>kube-apiserver</code> 三者的功能紧密相关；</li>
<li>同时只能有一个 <code>kube-scheduler</code>、<code>kube-controller-manager</code> 进程处于工作状态，如果运行多个，则需要通过选举产生一个 leader；</li>
</ul>
<p>kubernetes发布版 tarball(下载脚本) 下载地址：<a href="https://github.com/kubernetes/kubernetes/releases" target="_blank" rel="external">https://github.com/kubernetes/kubernetes/releases</a><br>kubernetes CHANGELOG(server/client) 下载地址：<a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG.md" target="_blank" rel="external">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG.md</a>  </p>
<table>
<thead>
<tr>
<th>Service</th>
<th>通讯地址</th>
</tr>
</thead>
<tbody>
<tr>
<td>kube-apiserver</td>
<td>192.168.1.195:6443</td>
</tr>
<tr>
<td>kube-controll</td>
<td>127.0.0.1:10252</td>
</tr>
<tr>
<td>kube-schedule</td>
<td>127.0.0.1:10251</td>
</tr>
</tbody>
</table>
<p><a href="https://pan.baidu.com/s/1sngFMlZ" target="_blank" rel="external">百度网盘packages目录，密码：nwzk</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># wget https://dl.k8s.io/v1.9.2/kubernetes-server-linux-amd64.tar.gz -O kubernetes-server-linux-amd64-v1.9.2.tar.gz</span></div><div class="line">[root@master1 ~]<span class="comment"># tar -zxf kubernetes-server-linux-amd64-v1.9.2.tar.gz</span></div><div class="line">[root@master1 ~]<span class="comment"># cd kubernetes</span></div><div class="line">[root@master1 kubernetes]<span class="comment"># tar -zxf kubernetes-src.tar.gz </span></div><div class="line">[root@master1 kubernetes]<span class="comment"># cp -r server/bin/&#123;kube-apiserver,kube-controller-manager,kube-scheduler,kubectl,kube-proxy,kubelet&#125; /usr/local/bin/</span></div></pre></td></tr></table></figure></p>
<h5 id="创建-kubernetes-证书"><a href="#创建-kubernetes-证书" class="headerlink" title="创建 kubernetes 证书"></a>创建 kubernetes 证书</h5><p>创建 kubernetes 证书签名请求<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># cd ~/ssl/</span></div><div class="line">[root@master1 ssl]<span class="comment"># cat kubernetes-csr.json</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</div><div class="line">  <span class="string">"hosts"</span>: [</div><div class="line">    <span class="string">"127.0.0.1"</span>,</div><div class="line">    <span class="string">"192.168.1.195"</span>,</div><div class="line">    <span class="string">"172.16.0.1"</span>,</div><div class="line">    <span class="string">"kubernetes"</span>,</div><div class="line">    <span class="string">"kubernetes.default"</span>,</div><div class="line">    <span class="string">"kubernetes.default.svc"</span>,</div><div class="line">    <span class="string">"kubernetes.default.svc.cluster"</span>,</div><div class="line">    <span class="string">"kubernetes.default.svc.cluster.local"</span></div><div class="line">  ],</div><div class="line">  <span class="string">"key"</span>: &#123;</div><div class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</div><div class="line">    <span class="string">"size"</span>: 2048</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"names"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</div><div class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</div><div class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line">[root@master1 ssl]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<ul>
<li><code>192.168.1.195</code>为当前部署的 master 机器 IP  </li>
<li><code>172.16.0.1</code>kubernetes 服务 IP (预分配，一般是 SERVICE_CIDR 中第一个IP)  </li>
<li>如果 hosts 字段不为空则需要指定授权使用该证书的 IP 或域名列表，所以上面分别指定了当前部署的 master 节点主机 IP；  </li>
<li>还需要添加 kube-apiserver 注册的名为 kubernetes 的服务 IP (Service Cluster IP)，一般是 kube-apiserver –service-cluster-ip-range 选项值指定的网段的第一个IP，如 “172.16.0.1”；  </li>
</ul>
<p>生成 kubernetes 证书和私钥<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># cd ssl/</span></div><div class="line">[root@master1 ssl]<span class="comment"># cfssl gencert -ca=/etc/kubernetes/ssl/ca.pem -ca-key=/etc/kubernetes/ssl/ca-key.pem -config=/etc/kubernetes/ssl/ca-config.json -profile=kubernetes kubernetes-csr.json | cfssljson -bare kubernetes</span></div><div class="line">[root@master1 ssl]<span class="comment"># ls kubernetes*</span></div><div class="line">kubernetes.csr  kubernetes-csr.json  kubernetes-key.pem  kubernetes.pem</div><div class="line">[root@master1 ssl]<span class="comment"># mkdir -p /etc/kubernetes/ssl/</span></div><div class="line">[root@master1 ssl]<span class="comment"># mv kubernetes*.pem /etc/kubernetes/ssl/</span></div></pre></td></tr></table></figure></p>
<h5 id="配置和启动-kube-apiserver"><a href="#配置和启动-kube-apiserver" class="headerlink" title="配置和启动 kube-apiserver"></a>配置和启动 kube-apiserver</h5><p>创建 kube-apiserver 使用的客户端 token 文件<br>kubelet 首次启动时向 kube-apiserver 发送 TLS Bootstrapping 请求，kube-apiserver 验证 kubelet 请求中的 token 是否与它配置的 token.csv 一致，如果一致则自动为 kubelet生成证书和秘钥<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#生成TLS Bootstrapping 使用的 Token</span></div><div class="line">[root@master1 ~]<span class="comment"># head -c 16 /dev/urandom | od -An -t x | tr -d ' '</span></div><div class="line">6240b18d950d086ff9eb596e215d243f</div><div class="line">[root@master1 ssl]<span class="comment"># cat token.csv </span></div><div class="line">6240b18d950d086ff9eb596e215d243f,kubelet-bootstrap,10001,<span class="string">"system:kubelet-bootstrap"</span></div><div class="line">[root@master1 ssl]<span class="comment"># mv token.csv /etc/kubernetes/</span></div><div class="line">[root@master1 ssl]<span class="comment"># cat basic-auth.csv </span></div><div class="line">admin,admin@123,1</div><div class="line"><span class="built_in">readonly</span>,<span class="built_in">readonly</span>,2</div><div class="line">[root@master1 ssl]<span class="comment"># mv basic-auth.csv /etc/kubernetes/</span></div></pre></td></tr></table></figure></p>
<p>创建 kube-apiserver 的 systemd unit 文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># cat kube-apiserver.service </span></div><div class="line">[Unit]</div><div class="line">Description=Kubernetes API Server</div><div class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line">After=network.target</div><div class="line"></div><div class="line">[Service]</div><div class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/kube-apiserver \</div><div class="line">  --admission-control=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota \</div><div class="line">  --advertise-address=192.168.1.195 \</div><div class="line">  --bind-address=192.168.1.195 \</div><div class="line">  --insecure-bind-address=192.168.1.195 \</div><div class="line">  --authorization-mode=RBAC \</div><div class="line">  --runtime-config=rbac.authorization.k8s.io/v1alpha1 \</div><div class="line">  --kubelet-https=<span class="literal">true</span> \</div><div class="line">  --token-auth-file=/etc/kubernetes/token.csv \</div><div class="line">  --service-cluster-ip-range=172.16.0.0/16 \</div><div class="line">  --service-node-port-range=8400-9000 \</div><div class="line">  --tls-cert-file=/etc/kubernetes/ssl/kubernetes.pem \</div><div class="line">  --tls-private-key-file=/etc/kubernetes/ssl/kubernetes-key.pem \</div><div class="line">  --client-ca-file=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  --service-account-key-file=/etc/kubernetes/ssl/ca-key.pem \</div><div class="line">  --etcd-cafile=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  --etcd-certfile=/etc/kubernetes/ssl/kubernetes.pem \</div><div class="line">  --etcd-keyfile=/etc/kubernetes/ssl/kubernetes-key.pem \</div><div class="line">  --etcd-servers=https://192.168.1.195:2379,https://192.168.1.196:2379,https://192.168.1.197:2379 \</div><div class="line">  --enable-swagger-ui=<span class="literal">true</span> \</div><div class="line">  --allow-privileged=<span class="literal">true</span> \</div><div class="line">  --apiserver-count=3 \</div><div class="line">  --audit-log-maxage=30 \</div><div class="line">  --audit-log-maxbackup=3 \</div><div class="line">  --audit-log-maxsize=100 \</div><div class="line">  --audit-log-path=/var/lib/audit.log \</div><div class="line">  --event-ttl=1h \</div><div class="line">  --v=2</div><div class="line">Restart=on-failure</div><div class="line">RestartSec=5</div><div class="line">Type=notify</div><div class="line">LimitNOFILE=65536</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div><div class="line">[root@master1 ssl]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<ul>
<li><code>--bind-address=192.168.1.195</code>为当前部署的 master 机器 IP，但不能为 <code>127.0.0.1</code>  </li>
<li><code>--insecure-bind-address=192.168.1.195</code>为当前部署的 master 机器 IP  </li>
<li><code>--service-cluster-ip-range</code> 指定 Service Cluster IP 地址段，该地址段不能路由可达  </li>
<li><code>--service-node-port-range=&quot;8400-9000&quot;</code> 指定 NodePort 的端口范围  </li>
<li><code>--etcd-servers=&quot;https://192.168.1.195:2379,https://192.168.1.195:2379,https://192.168.1.195:2379&quot;</code>为etcd 集群服务地址列表  </li>
<li>kube-apiserver 1.6 版本开始使用 etcd v3 API 和存储格式  </li>
<li><code>--authorization-mode=RBAC</code> 指定在安全端口使用 RBAC 授权模式，拒绝未通过授权的请求  </li>
<li>kube-scheduler、kube-controller-manager 一般和 kube-apiserver 部署在同一台机器上，它们使用非安全端口和 kube-apiserver通信  </li>
<li>kube-proxy、kubectl 通过在使用的证书里指定相关的 User、Group 来达到通过 RBAC 授权的目的  </li>
<li>如果使用了 kubelet TLS Boostrap 机制，则不能再指定<code>--kubelet-certificate-authority</code>，<code>--kubelet-client-certificate</code>和<code>--kubelet-client-key</code>选项，否则后续 kube-apiserver 校验 kubelet 证书时出现 ”x509: certificate signed by unknown authority“ 错误  </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># cp -a kube-apiserver.service /etc/systemd/system/</span></div></pre></td></tr></table></figure>
<p>启动kube-apiserver<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># systemctl daemon-reload</span></div><div class="line">[root@master1 ~]<span class="comment"># systemctl enable kube-apiserver</span></div><div class="line">[root@master1 ~]<span class="comment"># systemctl start kube-apiserver</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># netstat -tunlp |grep kube-apiserve</span></div><div class="line">tcp        0      0 192.168.1.195:6443      0.0.0.0:*               LISTEN      19206/kube-apiserve </div><div class="line">tcp        0      0 192.168.1.195:8080      0.0.0.0:*               LISTEN      19206/kube-apiserve </div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#不能有任何报错</span></div><div class="line">[root@master1 ~]<span class="comment"># systemctl status kube-apiserver</span></div><div class="line">● kube-apiserver.service - Kubernetes API Server</div><div class="line">   Loaded: loaded (/etc/systemd/system/kube-apiserver.service; enabled; vendor preset: disabled)</div><div class="line">   Active: active (running) since Mon 2018-01-29 10:53:14 CST; 15min ago</div><div class="line">     Docs: https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line"> Main PID: 19206 (kube-apiserver)</div><div class="line">   CGroup: /system.slice/kube-apiserver.service</div><div class="line">           └─19206 /usr/<span class="built_in">local</span>/bin/kube-apiserver --admission-control=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota --advertise-address=...</div><div class="line"></div><div class="line">Jan 29 11:08:14 master1.example.com kube-apiserver[19206]: I0129 11:08:14.947346   19206 wrap.go:42] PUT /apis/apiregistration.k8s.io/v1beta1/apiservices/v1beta...95:42960]</div><div class="line">Jan 29 11:08:14 master1.example.com kube-apiserver[19206]: I0129 11:08:14.947470   19206 wrap.go:42] PUT /apis/apiregistration.k8s.io/v1beta1/apiservices/v1beta...95:42960]</div><div class="line">Jan 29 11:08:14 master1.example.com kube-apiserver[19206]: I0129 11:08:14.948643   19206 wrap.go:42] PUT /apis/apiregistration.k8s.io/v1beta1/apiservices/v1beta...95:42960]</div><div class="line">Jan 29 11:08:14 master1.example.com kube-apiserver[19206]: I0129 11:08:14.997905   19206 wrap.go:42] GET /api/v1/services: (1.191044ms) 200 [[kube-apiserver/v1....95:42960]</div><div class="line">Jan 29 11:08:15 master1.example.com kube-apiserver[19206]: I0129 11:08:15.003220   19206 wrap.go:42] GET /api/v1/services: (1.016741ms) 200 [[kube-apiserver/v1....95:42960]</div><div class="line">Jan 29 11:08:15 master1.example.com kube-apiserver[19206]: I0129 11:08:15.054109   19206 wrap.go:42] GET /api/v1/namespaces/kube-system: (1.388292ms) 200 [[kube...95:42960]</div><div class="line">Jan 29 11:08:15 master1.example.com kube-apiserver[19206]: I0129 11:08:15.055377   19206 wrap.go:42] GET /api/v1/namespaces/kube-public: (1.053295ms) 200 [[kube...95:42960]</div><div class="line">Jan 29 11:08:15 master1.example.com kube-apiserver[19206]: I0129 11:08:15.405477   19206 wrap.go:42] GET /api/v1/namespaces/default: (1.48537ms) 200 [[kube-apis...95:42960]</div><div class="line">Jan 29 11:08:15 master1.example.com kube-apiserver[19206]: I0129 11:08:15.407091   19206 wrap.go:42] GET /api/v1/namespaces/default/services/kubernetes: (1.0559...95:42960]</div><div class="line">Jan 29 11:08:15 master1.example.com kube-apiserver[19206]: I0129 11:08:15.408295   19206 wrap.go:42] GET /api/v1/namespaces/default/endpoints/kubernetes: (971.4….195:42960</div><div class="line">]Hint: Some lines were ellipsized, use <span class="_">-l</span> to show <span class="keyword">in</span> full.</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h5 id="配置和启动-kube-controller-manager"><a href="#配置和启动-kube-controller-manager" class="headerlink" title="配置和启动 kube-controller-manager"></a>配置和启动 kube-controller-manager</h5><p>创建 kube-controller-manager 的 systemd unit 文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># cat kube-controller-manager.service</span></div><div class="line">[Unit]</div><div class="line">Description=Kubernetes Controller Manager</div><div class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line"></div><div class="line">[Service]</div><div class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/kube-controller-manager \</div><div class="line">  --address=127.0.0.1 \</div><div class="line">  --master=http://192.168.1.195:8080 \</div><div class="line">  --allocate-node-cidrs=<span class="literal">true</span> \</div><div class="line">  --service-cluster-ip-range=172.16.0.0/16 \</div><div class="line">  --cluster-cidr=172.30.0.0/16 \</div><div class="line">  --cluster-name=kubernetes \</div><div class="line">  --cluster-signing-cert-file=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  --cluster-signing-key-file=/etc/kubernetes/ssl/ca-key.pem \</div><div class="line">  --service-account-private-key-file=/etc/kubernetes/ssl/ca-key.pem \</div><div class="line">  --root-ca-file=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  --leader-elect=<span class="literal">true</span> \</div><div class="line">  --v=2</div><div class="line">Restart=on-failure</div><div class="line">RestartSec=5</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div><div class="line">[root@master1 ssl]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<ul>
<li><code>--address</code>值必须为 127.0.0.1，因为当前 kube-apiserver 期望 scheduler 和 controller-manager 在同一台机器</li>
<li><code>--master=http://192.168.1.195:8080</code>：使用非安全 8080 端口与 kube-apiserver 通信</li>
<li><code>--cluster-cidr</code> 指定 Cluster 中 Pod 的 CIDR 范围，该网段在各 Node 间必须路由可达(flanneld保证)</li>
<li><code>--service-cluster-ip-range</code> 参数指定 Cluster 中 Service 的CIDR范围，该网络在各 Node 间必须路由不可达，必须和 kube-apiserver 中的参数一致</li>
<li><code>--cluster-signing-*</code> 指定的证书和私钥文件用来签名为 TLS BootStrap 创建的证书和私钥</li>
<li><code>--root-ca-file</code> 用来对 kube-apiserver 证书进行校验，指定该参数后，才会在Pod 容器的 ServiceAccount 中放置该 CA 证书文件</li>
<li><code>--leader-elect=true</code> 部署多台机器组成的 master 集群时选举产生一处于工作状态的 kube-controller-manager 进程</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># cp kube-controller-manager.service /etc/systemd/system/</span></div></pre></td></tr></table></figure>
<p>启动 kube-controller-manager<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># systemctl daemon-reload</span></div><div class="line">[root@master1 ~]<span class="comment"># systemctl enable kube-controller-manager</span></div><div class="line">[root@master1 ~]<span class="comment"># systemctl start kube-controller-manager</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># netstat -tunlp | grep -i kube-controll</span></div><div class="line">tcp        0      0 127.0.0.1:10252         0.0.0.0:*               LISTEN      19300/kube-controll </div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># systemctl status kube-controller-manager</span></div><div class="line">● kube-controller-manager.service - Kubernetes Controller Manager</div><div class="line">   Loaded: loaded (/etc/systemd/system/kube-controller-manager.service; enabled; vendor preset: disabled)</div><div class="line">   Active: active (running) since Thu 2018-02-01 14:57:01 CST; 41s ago</div><div class="line">     Docs: https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line"> Main PID: 7798 (kube-controller)</div><div class="line">   CGroup: /system.slice/kube-controller-manager.service</div><div class="line">           └─7798 /usr/<span class="built_in">local</span>/bin/kube-controller-manager --address=127.0.0.1 --master=http://192.168.1.195:8080 --allocate-node-cidrs=<span class="literal">true</span> --service-cluster-ip-range=172...</div><div class="line"></div><div class="line">Jan 29 11:10:14 master1.example.com kube-controller-manager[7798]: I0201 14:57:12.832889    7798 controller_utils.go:1019] Waiting <span class="keyword">for</span> caches to sync <span class="keyword">for</span> cidrall...ntroller</div><div class="line">Jan 29 11:10:14 master1.example.com kube-controller-manager[7798]: I0201 14:57:12.832920    7798 taint_controller.go:181] Starting NoExecuteTaintManager</div><div class="line">Jan 29 11:10:15 master1.example.com kube-controller-manager[7798]: I0201 14:57:12.932953    7798 controller_utils.go:1026] Caches are synced <span class="keyword">for</span> cidrallocator controller</div><div class="line">Jan 29 11:10:15 master1.example.com kube-controller-manager[7798]: I0201 14:57:13.549661    7798 resource_quota_controller.go:434] syncing resource quota control... &#123;apps v</div><div class="line">Jan 29 11:10:15 master1.example.com kube-controller-manager[7798]: I0201 14:57:13.549766    7798 controller_utils.go:1019] Waiting <span class="keyword">for</span> caches to sync <span class="keyword">for</span> resourc...ntroller</div><div class="line">Jan 29 11:10:15 master1.example.com kube-controller-manager[7798]: I0201 14:57:13.649852    7798 controller_utils.go:1026] Caches are synced <span class="keyword">for</span> resource quota controller</div><div class="line">Jan 29 11:10:15 master1.example.com kube-controller-manager[7798]: I0201 14:57:13.696714    7798 garbagecollector.go:182] syncing garbage collector with updated ...onregist</div><div class="line">Jan 29 11:10:15 master1.example.com kube-controller-manager[7798]: I0201 14:57:15.046578    7798 controller_utils.go:1019] Waiting <span class="keyword">for</span> caches to sync <span class="keyword">for</span> garbage...ntroller</div><div class="line">Jan 29 11:10:15 master1.example.com kube-controller-manager[7798]: I0201 14:57:15.146718    7798 controller_utils.go:1026] Caches are synced <span class="keyword">for</span> garbage collecto...ntroller</div><div class="line">Jan 29 11:10:15 master1.example.com kube-controller-manager[7798]: I0201 14:57:15.146731    7798 garbagecollector.go:219] synced garbage collector</div><div class="line">Hint: Some lines were ellipsized, use <span class="_">-l</span> to show <span class="keyword">in</span> full.</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h5 id="配置和启动-kube-scheduler"><a href="#配置和启动-kube-scheduler" class="headerlink" title="配置和启动 kube-scheduler"></a>配置和启动 kube-scheduler</h5><p>创建 kube-scheduler 的 systemd unit 文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># cat kube-scheduler.service </span></div><div class="line">[Unit]</div><div class="line">Description=Kubernetes Scheduler</div><div class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line"></div><div class="line">[Service]</div><div class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/kube-scheduler \</div><div class="line">  --address=127.0.0.1 \</div><div class="line">  --master=http://192.168.1.195:8080 \</div><div class="line">  --leader-elect=<span class="literal">true</span> \</div><div class="line">  --v=2</div><div class="line">Restart=on-failure</div><div class="line">RestartSec=5</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div><div class="line">[root@master1 ssl]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<ul>
<li><code>--address</code> 值必须为 127.0.0.1，因为当前 kube-apiserver 期望 scheduler 和 controller-manager 在同一台机器</li>
<li><code>--master=http:/192.168.1.195:8080</code>：使用非安全 8080 端口与 kube-apiserver 通信</li>
<li><code>--leader-elect=true</code>部署多台机器组成的 master 集群时选举产生一处于工作状态的 kube-controller-manager 进程</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># cp -a kube-scheduler.service /etc/systemd/system/</span></div></pre></td></tr></table></figure>
<p>启动 kube-scheduler<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># systemctl daemon-reload</span></div><div class="line">[root@master1 ~]<span class="comment"># systemctl enable kube-scheduler</span></div><div class="line">[root@master1 ~]<span class="comment"># systemctl start kube-scheduler</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># systemctl status kube-scheduler</span></div><div class="line">● kube-scheduler.service - Kubernetes Scheduler</div><div class="line">   Loaded: loaded (/etc/systemd/system/kube-scheduler.service; enabled; vendor preset: disabled)</div><div class="line">   Active: active (running) since Mon 2018-01-29 11:27:07 CST; 2min 34s ago</div><div class="line">     Docs: https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line"> Main PID: 19360 (kube-scheduler)</div><div class="line">   CGroup: /system.slice/kube-scheduler.service</div><div class="line">           └─19360 /usr/<span class="built_in">local</span>/bin/kube-scheduler --address=127.0.0.1 --master=http://192.168.1.195:8080 --leader-elect=<span class="literal">true</span> --v=2</div><div class="line"></div><div class="line">Jan 29 11:27:07 master1.example.com systemd[1]: Starting Kubernetes Scheduler...</div><div class="line">Jan 29 11:27:07 master1.example.com kube-scheduler[19360]: W0129 11:27:07.324795   19360 server.go:159] WARNING: all flags than --config are deprecated. Please ...ile ASAP.</div><div class="line">Jan 29 11:27:07 master1.example.com kube-scheduler[19360]: I0129 11:27:07.325298   19360 server.go:551] Version: v1.9.2</div><div class="line">Jan 29 11:27:07 master1.example.com kube-scheduler[19360]: I0129 11:27:07.325412   19360 factory.go:837] Creating scheduler from algorithm provider <span class="string">'DefaultProvider'</span></div><div class="line">Jan 29 11:27:07 master1.example.com kube-scheduler[19360]: I0129 11:27:07.325419   19360 factory.go:898] Creating scheduler with fit predicates <span class="string">'map[CheckNodeDi...&#123;&#125; NoDisk</span></div><div class="line">Jan 29 11:27:07 master1.example.com kube-scheduler[19360]: I0129 11:27:07.325564   19360 server.go:570] starting healthz server on 127.0.0.1:10251</div><div class="line">Jan 29 11:27:08 master1.example.com kube-scheduler[19360]: I0129 11:27:08.126353   19360 controller_utils.go:1019] Waiting for caches to sync for scheduler controller</div><div class="line">Jan 29 11:27:08 master1.example.com kube-scheduler[19360]: I0129 11:27:08.226450   19360 controller_utils.go:1026] Caches are synced for scheduler controller</div><div class="line">Jan 29 11:27:08 master1.example.com kube-scheduler[19360]: I0129 11:27:08.226468   19360 leaderelection.go:174] attempting to acquire leader lease...</div><div class="line">Jan 29 11:27:08 master1.example.com kube-scheduler[19360]: I0129 11:27:08.232415   19360 leaderelection.go:184] successfully acquired lease kube-system/kube-scheduler</div><div class="line">Hint: Some lines were ellipsized, use -l to show in full.</div><div class="line">[root@master1 ~]#</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># netstat -tunlp | grep -i kube-schedule</span></div><div class="line">tcp        0      0 127.0.0.1:10251         0.0.0.0:*               LISTEN      19360/kube-schedule </div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h4 id="部署-kubectl-client节点"><a href="#部署-kubectl-client节点" class="headerlink" title="部署 kubectl client节点"></a>部署 kubectl client节点</h4><p>kubernetes发布版 tarball(下载脚本) 下载地址：<a href="https://github.com/kubernetes/kubernetes/releases" target="_blank" rel="external">https://github.com/kubernetes/kubernetes/releases</a><br>kubernetes CHANGELOG(server/client) 下载地址：<a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG.md" target="_blank" rel="external">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG.md</a><br><a href="https://pan.baidu.com/s/1sngFMlZ" target="_blank" rel="external">百度网盘packages目录，密码：nwzk</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># wget https://dl.k8s.io/v1.9.2/kubernetes-client-linux-amd64.tar.gz -O kubernetes-client-linux-amd64-v1.9.2.tar.gz</span></div><div class="line">[root@master1 ~]<span class="comment"># tar -zxf kubernetes-client-linux-amd64-v1.9.2.tar.gz</span></div><div class="line">[root@master1 ~]<span class="comment"># cp -a kubernetes/client/bin/kube* /usr/local/bin/</span></div></pre></td></tr></table></figure></p>
<h5 id="创建-admin-证书"><a href="#创建-admin-证书" class="headerlink" title="创建 admin 证书"></a>创建 admin 证书</h5><p>kubectl 与 kube-apiserver 的安全端口通信，需要为安全通信提供 TLS 证书和秘钥  </p>
<p>创建 admin 证书签名请求<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># cat admin-csr.json</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"CN"</span>: <span class="string">"admin"</span>,</div><div class="line">  <span class="string">"hosts"</span>: [],</div><div class="line">  <span class="string">"key"</span>: &#123;</div><div class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</div><div class="line">    <span class="string">"size"</span>: 2048</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"names"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</div><div class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">      <span class="string">"O"</span>: <span class="string">"system:masters"</span>,</div><div class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>kube-apiserver</code> 使用 <code>RBAC</code> 对客户端(如 <code>kubelet</code>、<code>kube-proxy</code>、<code>Pod</code>)请求进行授权  </li>
<li><code>kube-apiserver</code> 预定义了一些 <code>RBAC</code> 使用的 <code>RoleBindings</code>，如 <code>cluster-admin</code> 将 Group <code>system:masters</code> 与 Role <code>cluster-admin</code> 绑定，该 Role 授予了调用<code>kube-apiserver</code> <strong>所有 API</strong>的权限  </li>
<li>O 指定该证书的 Group 为 <code>system:masters</code>，<code>kubelet</code> 使用该证书访问 <code>kube-apiserver</code> 时 ，由于证书被 CA 签名，所以认证通过，同时由于证书用户组为经过预授权的 <code>system:masters</code>，所以被授予访问所有 API 的权限  </li>
<li>hosts 属性值为空列表  </li>
</ul>
<p>生成admin证书和私钥<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># cfssl gencert -ca=/etc/kubernetes/ssl/ca.pem -ca-key=/etc/kubernetes/ssl/ca-key.pem -config=/etc/kubernetes/ssl/ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin</span></div><div class="line">[root@master1 ssl]<span class="comment"># ls admin*</span></div><div class="line">admin.csr  admin-csr.json  admin-key.pem  admin.pem</div><div class="line">[root@master1 ssl]<span class="comment"># mv admin*.pem /etc/kubernetes/ssl/</span></div></pre></td></tr></table></figure></p>
<p>创建 kubectl kubeconfig 文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 设置集群参数</span></div><div class="line">[root@master1 ~]<span class="comment"># kubectl config set-cluster kubernetes --certificate-authority=/etc/kubernetes/ssl/ca.pem --embed-certs=true --server=https://192.168.1.195:6443</span></div><div class="line"><span class="comment"># 设置客户端认证参数</span></div><div class="line">[root@master1 ~]<span class="comment"># kubectl config set-credentials admin --client-certificate=/etc/kubernetes/ssl/admin.pem --embed-certs=true --client-key=/etc/kubernetes/ssl/admin-key.pem</span></div><div class="line"><span class="comment"># 设置上下文参数</span></div><div class="line">[root@master1 ~]<span class="comment"># kubectl config set-context kubernetes --cluster=kubernetes --user=admin</span></div><div class="line"><span class="comment"># 设置默认上下文</span></div><div class="line">[root@master1 ~]<span class="comment"># kubectl config use-context kubernetes</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># ls ~/.kube/</span></div><div class="line">config</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<ul>
<li>设置集群参数和客户端认证参数时 <code>--embed-certs</code> 都为 <code>true</code>，这会将 <code>certificate-authority</code>、<code>client-certificate</code> 和 <code>client-key</code> 指向的证书文件内容写入到生成的 <code>kube-proxy.kubeconfig</code> 文件中  </li>
<li><code>kube-proxy.pem</code> 证书中 CN 为 <code>system:kube-proxy</code>，<code>kube-apiserver</code> 预定义的 RoleBinding <code>cluster-admin</code> 将User <code>system:kube-proxy</code> 与 Role <code>system:node-proxier</code> 绑定，该 Role 授予了调用 <code>kube-apiserver</code> Proxy 相关 API 的权限  </li>
<li><code>admin.pem</code> 证书 O 字段值为 <code>system:masters</code>，<code>kube-apiserver</code> 预定义的 RoleBinding <code>cluster-admin</code> 将 Group <code>system:masters</code> 与 Role <code>cluster-admin</code> 绑定，该 Role 授予了调用<code>kube-apiserver</code> 相关 API 的权限  </li>
<li>生成的 kubeconfig 被保存到 <code>~/.kube/config</code> 文件  </li>
</ul>
<p>分发 kubeconfig 文件<br>将 <code>~/.kube/config</code> 文件拷贝到运行 kubelet 命令的机器的 <code>~/.kube/</code> 目录下</p>
<p>其他服务器部署kubectl-client工具<br>先在需要解压安装kubernetes-client-linux-amd64-v1.9.2.tar.gz<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># ssh root@192.168.1.196 "mkdir -p /etc/kubernetes/ssl/"</span></div><div class="line">[root@master1 ~]<span class="comment"># scp /etc/kubernetes/ssl/admin* root@192.168.1.196:/etc/kubernetes/ssl/</span></div><div class="line">[root@master1 ~]<span class="comment"># ssh root@192.168.1.196 "mkdir -p ~/.kube/"</span></div><div class="line">[root@master1 ~]<span class="comment"># scp ~/.kube/config root@192.168.1.196:~/.kube/</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@master2 ~]<span class="comment"># kubectl get componentstatuses</span></div><div class="line">NAME                 STATUS    MESSAGE              ERROR</div><div class="line">controller-manager   Healthy   ok                   </div><div class="line">scheduler            Healthy   ok                   </div><div class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;   </div><div class="line">etcd-1               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;   </div><div class="line">etcd-2               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;   </div><div class="line">[root@master2 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>如果遇到下面的错误，需要检查kubectl是否可以与api-server通讯<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># kubectl get componentstatuses</span></div><div class="line">The connection to the server localhost:8080 was refused - did you specify the right host or port?</div></pre></td></tr></table></figure></p>
<h6 id="查看集群状态"><a href="#查看集群状态" class="headerlink" title="查看集群状态"></a>查看集群状态</h6><p>查看k8s 查看各组件信息<br>需要先安装kubectl命令(kubernetes-client)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get componentstatuses</span></div><div class="line">NAME                 STATUS    MESSAGE              ERROR</div><div class="line">controller-manager   Healthy   ok                   </div><div class="line">scheduler            Healthy   ok                   </div><div class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;   </div><div class="line">etcd-1               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;   </div><div class="line">etcd-2               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;   </div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>或<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl -s http://192.168.1.195:8080 get componentstatuses</span></div><div class="line">NAME                 STATUS    MESSAGE              ERROR</div><div class="line">scheduler            Healthy   ok                   </div><div class="line">controller-manager   Healthy   ok                   </div><div class="line">etcd-2               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;   </div><div class="line">etcd-1               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;   </div><div class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;   </div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>查看k8s svc地址(服务虚拟IP)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get svc kubernetes</span></div><div class="line">NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</div><div class="line">kubernetes   ClusterIP   172.16.0.1   &lt;none&gt;        443/TCP   1d</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>或<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get service</span></div><div class="line">NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</div><div class="line">kubernetes   ClusterIP   172.16.0.1   &lt;none&gt;        443/TCP   1d</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>查看集群信息<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl cluster-info</span></div><div class="line">Kubernetes master is running at https://192.168.1.195:6443</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<h4 id="部署-K8S-Node-节点"><a href="#部署-K8S-Node-节点" class="headerlink" title="部署 K8S Node 节点"></a>部署 K8S Node 节点</h4><p>kubernetes Node 节点包含如下组件：  </p>
<ul>
<li>flanneld</li>
<li>docker</li>
<li>kubelet</li>
<li>kube-proxy</li>
</ul>
<h5 id="安装和配置-kubelet"><a href="#安装和配置-kubelet" class="headerlink" title="安装和配置 kubelet"></a>安装和配置 kubelet</h5><p>kubelet 启动时向 <code>kube-apiserver</code> 发送 <code>TLS bootstrapping</code> 请求，需要先将 <code>bootstrap token</code> 文件中的 <code>kubelet-bootstrap</code> 用户赋予 <code>system:node-bootstrapper</code> 角色，然后 kubelet 才有权限创建认证请求(certificatesigningrequests)  </p>
<p><strong>kubelet 和kube-proxy 在node1/node2上部署</strong><br><a href="https://pan.baidu.com/s/1sngFMlZ" target="_blank" rel="external">百度网盘packages目录，密码：nwzk</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># wget https://dl.k8s.io/v1.9.2/kubernetes-server-linux-amd64.tar.gz -O kubernetes-server-linux-amd64-v1.9.2.tar.gz</span></div><div class="line">[root@node1 ~]<span class="comment"># tar -zxf kubernetes-server-linux-amd64-v1.9.2.tar.gz</span></div><div class="line">[root@node1 ~]<span class="comment"># cp -a kubernetes/server/bin/&#123;kube-proxy,kubelet&#125; /usr/local/bin/</span></div></pre></td></tr></table></figure></p>
<p>把在安装有cfssl 工具的服务器(这里是在master1)上生成的admin相关证书和key拷贝到node1上<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># ssh root@192.168.1.198 "mkdir -p /etc/kubernetes/ssl/"</span></div><div class="line">[root@master1 ~]<span class="comment"># scp /etc/kubernetes/ssl/admin* root@192.168.1.198:/etc/kubernetes/ssl/</span></div><div class="line">[root@master1 ~]<span class="comment"># ssh root@192.168.1.198 "mkdir -p ~/.kube/"</span></div><div class="line">[root@master1 ~]<span class="comment"># scp ~/.kube/config root@192.168.1.198:~/.kube/</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#如果kubectl命令没有，需要安装kubernetes-client-linux-amd64-v1.9.2.tar.gz</span></div><div class="line"><span class="comment">#如果有多个节点，这条命令只执行一次</span></div><div class="line">[root@node1 ~]<span class="comment"># kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --user=kubelet-bootstrap</span></div></pre></td></tr></table></figure>
<ul>
<li><code>--user=kubelet-bootstrap</code> 是master服务器文件 <code>/etc/kubernetes/token.csv</code> 中指定的用户名，同时也写入了文件 <code>/etc/kubernetes/bootstrap.kubeconfig</code> </li>
</ul>
<p>如果报下面错误，需要先安装kubectl工具，参考上面操作<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@node2 ~]<span class="comment"># kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --user=kubelet-bootstrap</span></div><div class="line">The connection to the server localhost:8080 was refused - did you specify the right host or port?</div><div class="line">[root@node2 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>创建 kubelet bootstrapping kubeconfig 文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 设置集群参数</span></div><div class="line">[root@node1 ~]<span class="comment"># kubectl config set-cluster kubernetes --certificate-authority=/etc/kubernetes/ssl/ca.pem --embed-certs=true --server=https://192.168.1.195:6443 --kubeconfig=bootstrap.kubeconfig</span></div><div class="line"><span class="comment"># 设置客户端认证参数</span></div><div class="line">[root@node1 ~]<span class="comment"># kubectl config set-credentials kubelet-bootstrap --token=6240b18d950d086ff9eb596e215d243f --kubeconfig=bootstrap.kubeconfig</span></div><div class="line"><span class="comment"># 设置上下文参数</span></div><div class="line">[root@node1 ~]<span class="comment"># kubectl config set-context default --cluster=kubernetes --user=kubelet-bootstrap --kubeconfig=bootstrap.kubeconfig</span></div><div class="line"><span class="comment"># 设置默认上下文</span></div><div class="line">[root@node1 ~]<span class="comment"># kubectl config use-context default --kubeconfig=bootstrap.kubeconfig</span></div><div class="line">[root@node1 ~]<span class="comment"># ls bootstrap.kubeconfig </span></div><div class="line">bootstrap.kubeconfig</div><div class="line">[root@node1 ~]<span class="comment"># mv bootstrap.kubeconfig /etc/kubernetes/</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># mkdir -p /var/lib/kubelet</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># cat kubelet.service </span></div><div class="line">[Unit]</div><div class="line">Description=Kubernetes Kubelet</div><div class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line">After=docker.service</div><div class="line">Requires=docker.service</div><div class="line"></div><div class="line">[Service]</div><div class="line">WorkingDirectory=/var/lib/kubelet</div><div class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/kubelet \</div><div class="line">  --address=192.168.1.198 \</div><div class="line">  --hostname-override=192.168.1.198 \</div><div class="line">  --pod-infra-container-image=registry.access.redhat.com/rhel7/pod-infrastructure:latest \</div><div class="line">  --experimental-bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig \</div><div class="line">  --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \</div><div class="line">  --require-kubeconfig \</div><div class="line">  --cert-dir=/etc/kubernetes/ssl \</div><div class="line">  --cluster-dns=223.5.5.5,223.6.6.6,8.8.8.8 \</div><div class="line">  --cluster-domain=aliyun.com. \</div><div class="line">  --hairpin-mode promiscuous-bridge \</div><div class="line">  --allow-privileged=<span class="literal">true</span> \</div><div class="line">  --serialize-image-pulls=<span class="literal">false</span> \</div><div class="line">  --logtostderr=<span class="literal">true</span> \</div><div class="line">  --v=2</div><div class="line"><span class="comment">#kubelet cAdvisor 默认在所有接口监听 4194 端口的请求, 以下iptables限制内网访问</span></div><div class="line">ExecStartPost=/sbin/iptables -A INPUT <span class="_">-s</span> 172.30.0.0/16 -p tcp --dport 4194 -j ACCEPT</div><div class="line">ExecStartPost=/sbin/iptables -A INPUT <span class="_">-s</span> 172.16.0.0/16 -p tcp --dport 4194 -j ACCEPT</div><div class="line">ExecStartPost=/sbin/iptables -A INPUT <span class="_">-s</span> 192.168.0.0/16 -p tcp --dport 4194 -j ACCEPT</div><div class="line">ExecStartPost=/sbin/iptables -A INPUT -p tcp --dport 4194 -j DROP</div><div class="line">Restart=on-failure</div><div class="line">RestartSec=5</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div><div class="line">[root@node1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<ul>
<li><code>--address</code> 不能设置为 <code>127.0.0.1</code>，否则后续 Pods 访问 kubelet 的 API 接口时会失败，因为 Pods 访问的 127.0.0.1 指向自己而不是 kubelet。<code>--address</code>设置为当前部署的节点 IP  </li>
<li>如果设置了 <code>--hostname-override</code> 选项，则 kube-proxy 也需要设置该选项，否则会出现找不到 Node 的情况。<code>--hostname-override</code>设置为当前部署的节点 IP  </li>
<li><code>--cluster-dns</code>设置为集群 DNS 服务 IP (从 SERVICE_CIDR 中预分配)，此环境中使用的 SERVICE_CIDR为172.16.0.0/16，可在master的kube-apiserver配置文件中看到  </li>
<li><code>--cluster-domain</code>设置为集群 DNS 域名  </li>
<li><code>--experimental-bootstrap-kubeconfig</code> 指向 bootstrap kubeconfig 文件，kubelet 使用该文件中的用户名和 token 向 kube-apiserver 发送 TLS Bootstrapping 请求  </li>
<li>管理员通过了 CSR 请求后，kubelet 自动在 <code>--cert-dir</code> 目录创建证书和私钥文件(<code>kubelet-client.crt</code> 和 <code>kubelet-client.key</code>)，然后写入 <code>--kubeconfig</code> 文件(自动创建 <code>--kubeconfig</code> 指定的文件)  </li>
<li>建议在 <code>--kubeconfig</code> 配置文件中指定 <code>kube-apiserver</code> 地址，如果未指定 <code>--api-servers</code> 选项，则必须指定 <code>--require-kubeconfig</code> 选项后才从配置文件中读取 kue-apiserver 的地址，否则 kubelet 启动后将找不到 kube-apiserver (日志中提示未找到 API Server），<code>kubectl get nodes</code> 不会返回对应的 Node 信息  </li>
<li><code>--cluster-dns</code> 指定 kubedns 的 Service IP(可以先分配，后续创建 kubedns 服务时指定该 IP)，<code>--cluster-domain</code> 指定域名后缀，这两个参数同时指定后才会生效  </li>
<li>kubelet cAdvisor 默认在<strong>所有接口</strong>监听 4194 端口的请求，对于有外网的机器来说不安全，<code>ExecStartPost</code> 选项指定的 iptables 规则只允许内网机器访问 4194 端口  </li>
<li><code>--cluster-dns</code>：集群DNS服务IP(从 SERVICE_CIDR 中预分配)。经测试，如果k8s内部没有搭建DNS，建议使用外部公共DNS地址。如果该DNS不存在，将会影响业务对域名的解析  </li>
<li><code>--cluster-domain</code>：集群 DNS 域名。经测试，此DNS域名后缀必须为真实域名后缀，k8s会写入到POD的/etc/resolv.conf文件中。如果使用默认的DNS后缀(cluster.local.)，因该DNS后缀不存在，故在解析DNS时会超时，会严重影响业务</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># mv kubelet.service /etc/systemd/system/kubelet.service</span></div></pre></td></tr></table></figure>
<p>启动 kubelet<br>v1.8版后，需要手动绑定 system:nodes组到 system:node的clusterrole<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#kubelet-node-clusterbinding为名称，可自定义。如果有多个节点加入，名称不能相同</span></div><div class="line">[root@master1 ~]<span class="comment"># kubectl create clusterrolebinding kubelet-node-clusterbinding --clusterrole=system:node --user=system:node:192.168.1.198</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#启动kubelet需要关闭swap分区  </span></div><div class="line">[root@node1 ~]<span class="comment"># swapoff -a</span></div><div class="line">[root@node1 ~]<span class="comment"># systemctl daemon-reload</span></div><div class="line">[root@node1 ~]<span class="comment"># systemctl enable kubelet</span></div><div class="line">[root@node1 ~]<span class="comment"># systemctl start kubelet</span></div></pre></td></tr></table></figure>
<p>需要关闭swap分区，否则会报下面的错误<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Feb  1 16:56:59 k8s-4 kubelet: error: failed to run Kubelet: Running with swap on is not supported, please <span class="built_in">disable</span> swap! or <span class="built_in">set</span> --fail-swap-on flag to false. /proc/swaps contained: [Filename<span class="comment">#011#011#011#011Type#011#011Size#011Used#011Priority /dev/dm-1 partition#0112097148#01116#011-1]</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># systemctl status kubelet</span></div><div class="line">● kubelet.service - Kubernetes Kubelet</div><div class="line">   Loaded: loaded (/etc/systemd/system/kubelet.service; enabled; vendor preset: disabled)</div><div class="line">   Active: active (running) since Thu 2018-02-01 16:41:49 CST; 7min ago</div><div class="line">     Docs: https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line">  Process: 30456 ExecStartPost=/sbin/iptables -A INPUT -p tcp --dport 4194 -j DROP (code=exited, status=0/SUCCESS)</div><div class="line">  Process: 30452 ExecStartPost=/sbin/iptables -A INPUT <span class="_">-s</span> 192.168.0.0/16 -p tcp --dport 4194 -j ACCEPT (code=exited, status=0/SUCCESS)</div><div class="line">  Process: 30451 ExecStartPost=/sbin/iptables -A INPUT <span class="_">-s</span> 172.16.0.0/16 -p tcp --dport 4194 -j ACCEPT (code=exited, status=0/SUCCESS)</div><div class="line">  Process: 30446 ExecStartPost=/sbin/iptables -A INPUT <span class="_">-s</span> 172.30.0.0/16 -p tcp --dport 4194 -j ACCEPT (code=exited, status=0/SUCCESS)</div><div class="line"> Main PID: 30445 (kubelet)</div><div class="line">   Memory: 11.7M</div><div class="line">   CGroup: /system.slice/kubelet.service</div><div class="line">           └─30445 /usr/<span class="built_in">local</span>/bin/kubelet --address=192.168.1.198 --hostname-override=192.168.1.198 --pod-infra-container-image=registry.access.redhat.com/rhel7/pod-infr...</div><div class="line"></div><div class="line">Feb 01 16:41:49 node1.example.com kubelet[30445]: I0201 16:41:49.807803   30445 controller.go:114] kubelet config controller: starting controller</div><div class="line">Feb 01 16:41:49 node1.example.com kubelet[30445]: I0201 16:41:49.807806   30445 controller.go:118] kubelet config controller: validating combination of defaults and flags</div><div class="line">Feb 01 16:41:49 node1.example.com kubelet[30445]: I0201 16:41:49.812805   30445 mount_linux.go:202] Detected OS with systemd</div><div class="line">Feb 01 16:41:49 node1.example.com kubelet[30445]: W0201 16:41:49.812875   30445 cni.go:171] Unable to update cni config: No networks found <span class="keyword">in</span> /etc/cni/net.d</div><div class="line">Feb 01 16:41:49 node1.example.com kubelet[30445]: I0201 16:41:49.815926   30445 server.go:182] Version: v1.9.2</div><div class="line">Feb 01 16:41:49 node1.example.com kubelet[30445]: I0201 16:41:49.815950   30445 feature_gate.go:220] feature gates: &amp;&#123;&#123;&#125; map[]&#125;</div><div class="line">Feb 01 16:41:49 node1.example.com kubelet[30445]: W0201 16:41:49.816011   30445 server.go:280] --require-kubeconfig is deprecated. Set --kubeconfig without usi...ubeconfig.</div><div class="line">Feb 01 16:41:49 node1.example.com kubelet[30445]: I0201 16:41:49.816019   30445 plugins.go:101] No cloud provider specified.</div><div class="line">Feb 01 16:41:49 node1.example.com kubelet[30445]: I0201 16:41:49.816025   30445 server.go:303] No cloud provider specified: <span class="string">""</span> from the config file: <span class="string">""</span></div><div class="line">Feb 01 16:41:49 node1.example.com kubelet[30445]: I0201 16:41:49.816036   30445 bootstrap.go:58] Using bootstrap kubeconfig to generate TLS client cert, key an...onfig file</div><div class="line">Hint: Some lines were ellipsized, use <span class="_">-l</span> to show <span class="keyword">in</span> full.</div><div class="line">[root@node1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h6 id="Q-amp-A-master日志报RBAC-DENY-user-“kubelet-bootstrap”-groups错误"><a href="#Q-amp-A-master日志报RBAC-DENY-user-“kubelet-bootstrap”-groups错误" class="headerlink" title="Q&amp;A master日志报RBAC DENY: user “kubelet-bootstrap” groups错误"></a>Q&amp;A master日志报RBAC DENY: user “kubelet-bootstrap” groups错误</h6><p>启动kubelet服务后，需要看master的kube-apiserver日志(/var/log/messages)中没有如下报错，才算启动成功。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Feb  1 03:41:53 master1 kube-apiserver: I0201 16:41:53.245112    8202 rbac.go:116] RBAC DENY: user <span class="string">"kubelet-bootstrap"</span> groups [<span class="string">"system:kubelet-bootstrap"</span> <span class="string">"system:authentica</span></div><div class="line">ted"] cannot <span class="string">"create"</span> resource <span class="string">"certificatesigningrequests.certificates.k8s.io/nodeclient"</span> cluster-wide</div></pre></td></tr></table></figure></p>
<p>如果在启动node时，master的/var/log/messages日志报上面的错误，原因如下：<br>1.8版本之前，开启<code>rbac</code>后，apiserver默认绑定<code>system:nodes</code>组到<code>system:node</code>的clusterrole。但v1.8之后，此绑定默认不存在，<strong>需要手工绑定</strong>，否则kubelet启动后会报认证错误，使用kubectl get nodes查看无法成为Ready状态。  </p>
<p>默认角色与默认角色绑定<br>API Server会创建一组默认的ClusterRole和<code>ClusterRoleBinding</code>对象。这些默认对象中有许多包含<code>system:前缀</code>，表明这些资源由Kubernetes基础组件“拥有”。 对这些资源的修改可能导致非功能性集群(<code>non-functional cluster</code>)<br>这个角色定义了kubelets的权限。如果这个角色被修改，可能会导致kubelets无法正常工作。<br>所有默认的<code>ClusterRole</code>和<code>ClusterRoleBinding</code>对象都会被标记为<code>kubernetes.io/bootstrapping=rbac-defaults</code>  </p>
<p><code>kubectl get clusterrolebinding</code>和<code>kubectl get clusterrole</code>可以查看系统中的角色与角色绑定<br><code>kubectl get clusterrolebindings system:node -o yaml</code>或<code>kubectl describe clusterrolebindings system:node</code>查看<code>system:node</code>角色绑定的详细信息  </p>
<p>查看 system:node 角色绑定的详细信息<br>system:node角色默认绑定为空<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl describe clusterrolebindings system:node</span></div><div class="line">Name:         system:node</div><div class="line">Labels:       kubernetes.io/bootstrapping=rbac-defaults</div><div class="line">Annotations:  rbac.authorization.kubernetes.io/autoupdate=<span class="literal">true</span></div><div class="line">Role:</div><div class="line">  Kind:  ClusterRole</div><div class="line">  Name:  system:node</div><div class="line">Subjects:</div><div class="line">  Kind  Name  Namespace</div><div class="line">  ----  ----  ---------</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>在整个集群范围内将 system:node ClusterRole 授予用户<code>system:node:192.168.1.198</code>或组<code>system:nodes</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl describe clusterrolebindings kubelet-node-clusterbinding  </span></div><div class="line">Name:         kubelet-node-clusterbinding</div><div class="line">Labels:       &lt;none&gt;</div><div class="line">Annotations:  &lt;none&gt;</div><div class="line">Role:</div><div class="line">  Kind:  ClusterRole</div><div class="line">  Name:  system:node</div><div class="line">Subjects:</div><div class="line">  Kind  Name                       Namespace</div><div class="line">  ----  ----                       ---------</div><div class="line">  User  system:node:192.168.1.198  </div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<h5 id="通过-kubelet-的-TLS-证书请求"><a href="#通过-kubelet-的-TLS-证书请求" class="headerlink" title="通过 kubelet 的 TLS 证书请求"></a>通过 kubelet 的 TLS 证书请求</h5><p>kubelet 首次启动时向 kube-apiserver 发送证书签名请求，必须通过后 kubernetes 系统才会将该 Node 加入到集群  </p>
<p>查看未授权的 CSR 请求:<br>下面如果没有获取到也代表kubelet没有启动成功<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get csr</span></div><div class="line">NAME                                                   AGE       REQUESTOR           CONDITION</div><div class="line">node-csr-DeFIxWS7IZimyAUaZGtIh8q4sp_CiNHL2bO1cwEm26U   9m        kubelet-bootstrap   Pending</div><div class="line">[root@master1 ~]<span class="comment"># </span></div><div class="line">[root@master1 ~]<span class="comment"># kubectl get nodes</span></div><div class="line">No resources found.</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>通过 CSR 请求:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl certificate approve node-csr-DeFIxWS7IZimyAUaZGtIh8q4sp_CiNHL2bO1cwEm26U</span></div><div class="line">certificatesigningrequest <span class="string">"node-csr-DeFIxWS7IZimyAUaZGtIh8q4sp_CiNHL2bO1cwEm26U"</span> approved</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get csr</span></div><div class="line">NAME                                                   AGE       REQUESTOR           CONDITION</div><div class="line">node-csr-DeFIxWS7IZimyAUaZGtIh8q4sp_CiNHL2bO1cwEm26U   13m       kubelet-bootstrap   Approved,Issued</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>自动生成了 kubelet kubeconfig 文件和公私钥<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># ls -l /etc/kubernetes/kubelet.kubeconfig</span></div><div class="line">-rw------- 1 root root 2280 Jan 31 19:19 /etc/kubernetes/kubelet.kubeconfig</div><div class="line">[root@node1 ~]<span class="comment"># ls -l /etc/kubernetes/ssl/kubelet*</span></div><div class="line">-rw-r--r-- 1 root root 1046 Jan 31 19:19 /etc/kubernetes/ssl/kubelet-client.crt</div><div class="line">-rw------- 1 root root  227 Jan 31 19:18 /etc/kubernetes/ssl/kubelet-client.key</div><div class="line">-rw-r--r-- 1 root root 1115 Jan 31 19:15 /etc/kubernetes/ssl/kubelet.crt</div><div class="line">-rw------- 1 root root 1675 Jan 31 19:15 /etc/kubernetes/ssl/kubelet.key</div><div class="line">[root@node1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>如果节点状态变为Ready才算成功，查看日志都已经正常<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get nodes</span></div><div class="line">NAME            STATUS    ROLES     AGE       VERSION</div><div class="line">192.168.1.198   Ready     &lt;none&gt;    25m       v1.9.2</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>参考：<a href="http://blog.csdn.net/zhaihaifei/article/details/79098564" target="_blank" rel="external">http://blog.csdn.net/zhaihaifei/article/details/79098564</a>  </p>
<h6 id="多个Node节点加入"><a href="#多个Node节点加入" class="headerlink" title="多个Node节点加入"></a>多个Node节点加入</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl describe clusterrolebindings kubelet-node199-clusterbinding  </span></div><div class="line">Name:         kubelet-node199-clusterbinding</div><div class="line">Labels:       &lt;none&gt;</div><div class="line">Annotations:  &lt;none&gt;</div><div class="line">Role:</div><div class="line">  Kind:  ClusterRole</div><div class="line">  Name:  system:node</div><div class="line">Subjects:</div><div class="line">  Kind  Name                       Namespace</div><div class="line">  ----  ----                       ---------</div><div class="line">  User  system:node:192.168.1.199  </div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get nodes</span></div><div class="line">NAME            STATUS    ROLES     AGE       VERSION</div><div class="line">192.168.1.198   Ready     &lt;none&gt;    3h        v1.9.2</div><div class="line">192.168.1.199   Ready     &lt;none&gt;    2m        v1.9.2</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h5 id="配置-kube-proxy"><a href="#配置-kube-proxy" class="headerlink" title="配置 kube-proxy"></a>配置 kube-proxy</h5><p>创建 kube-proxy 证书签名请求<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># cat kube-proxy-csr.json </span></div><div class="line">&#123;</div><div class="line">  <span class="string">"CN"</span>: <span class="string">"system:kube-proxy"</span>,</div><div class="line">  <span class="string">"hosts"</span>: [],</div><div class="line">  <span class="string">"key"</span>: &#123;</div><div class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</div><div class="line">    <span class="string">"size"</span>: 2048</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"names"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</div><div class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</div><div class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line">[root@master1 ssl]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<ul>
<li>CN 指定该证书的 User 为 <code>system:kube-proxy</code>；</li>
<li>kube-apiserver 预定义的 RoleBinding <code>system:node-proxier</code> 将User <code>system:kube-proxy</code> 与 Role <code>system:node-proxier</code> 绑定，该 Role 授予了调用 <code>kube-apiserver</code> Proxy 相关 API 的权限；</li>
<li>hosts 属性值为空列表</li>
</ul>
<p>生成 kube-proxy 客户端证书和私钥<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># cfssl gencert -ca=/etc/kubernetes/ssl/ca.pem -ca-key=/etc/kubernetes/ssl/ca-key.pem -config=/etc/kubernetes/ssl/ca-config.json -profile=kubernetes  kube-proxy-csr.json | cfssljson -bare kube-proxy</span></div><div class="line">[root@master1 ssl]<span class="comment"># ls kube-proxy*</span></div><div class="line">kube-proxy.csr  kube-proxy-csr.json  kube-proxy-key.pem  kube-proxy.pem</div><div class="line">[root@master1 ssl]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>把在安装有cfssl 工具的服务器(这里是在master1)上生成的kube-proxy 相关证书和key拷贝到node1上<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># scp kube-proxy*.pem root@192.168.1.198:/etc/kubernetes/ssl/</span></div></pre></td></tr></table></figure></p>
<p>创建 kube-proxy kubeconfig 文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 设置集群参数</span></div><div class="line">[root@node1 ~]<span class="comment"># kubectl config set-cluster kubernetes --certificate-authority=/etc/kubernetes/ssl/ca.pem --embed-certs=true --server=https://192.168.1.195:6443 --kubeconfig=kube-proxy.kubeconfig</span></div><div class="line"><span class="comment"># 设置客户端认证参数</span></div><div class="line">[root@node1 ~]<span class="comment"># kubectl config set-credentials kube-proxy --client-certificate=/etc/kubernetes/ssl/kube-proxy.pem --client-key=/etc/kubernetes/ssl/kube-proxy-key.pem --embed-certs=true --kubeconfig=kube-proxy.kubeconfig</span></div><div class="line"><span class="comment">#设置上下文参数</span></div><div class="line">[root@node1 ~]<span class="comment"># kubectl config set-context default --cluster=kubernetes --user=kube-proxy --kubeconfig=kube-proxy.kubeconfig</span></div><div class="line"><span class="comment">#设置默认上下文</span></div><div class="line">[root@node1 ~]<span class="comment"># kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># mv kube-proxy.kubeconfig /etc/kubernetes/</span></div></pre></td></tr></table></figure>
<ul>
<li>设置集群参数和客户端认证参数时 <code>--embed-certs</code> 都为 <code>true</code>，这会将 <code>certificate-authority</code>、<code>client-certificate</code> 和 <code>client-key</code> 指向的证书文件内容写入到生成的 <code>kube-proxy.kubeconfig</code> 文件中</li>
<li><code>kube-proxy.pem</code> 证书中 CN 为 <code>system:kube-proxy</code>，<code>kube-apiserver</code> 预定义的 RoleBinding <code>cluster-admin</code> 将User <code>system:kube-proxy</code> 与 Role <code>system:node-proxier</code> 绑定，该 Role 授予了调用 <code>kube-apiserver Proxy</code> 相关 API 的权限</li>
</ul>
<p>创建 kube-proxy 的 systemd unit 文件<br>创建工作目录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># mkdir -p /var/lib/kube-proxy</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># cat kube-proxy.service </span></div><div class="line">[Unit]</div><div class="line">Description=Kubernetes Kube-Proxy Server</div><div class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line">After=network.target</div><div class="line"></div><div class="line">[Service]</div><div class="line">WorkingDirectory=/var/lib/kube-proxy</div><div class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/kube-proxy \</div><div class="line">  --bind-address=192.168.1.198 \</div><div class="line">  --hostname-override=192.168.1.198 \</div><div class="line">  --cluster-cidr=172.30.0.0/16 \</div><div class="line">  --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig \</div><div class="line">  --logtostderr=<span class="literal">true</span> \</div><div class="line">  --v=2</div><div class="line">Restart=on-failure</div><div class="line">RestartSec=5</div><div class="line">LimitNOFILE=65536</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div><div class="line">[root@node1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<ul>
<li><code>--hostname-override</code> 参数值<strong>必须</strong>与 kubelet 的值一致，否则 kube-proxy 启动后会找不到该 Node，从而不会创建任何 iptables 规则  </li>
<li><code>--cluster-cidr</code> <strong>必须</strong>与 kube-controller-manager 的 <code>--cluster-cidr</code> 选项值一致，172.30.0.0/16  </li>
<li>kube-proxy 根据 <code>--cluster-cidr</code> 判断集群内部和外部流量，指定 <code>--cluster-cidr</code> 或 <code>--masquerade-all</code> 选项后 kube-proxy 才会对访问 Service IP 的请求做 SNAT  </li>
<li><code>--kubeconfig</code> 指定的配置文件嵌入了 kube-apiserver 的地址、用户名、证书、秘钥等请求和认证信息  </li>
<li>预定义的 RoleBinding <code>cluster-admin</code> 将User <code>system:kube-proxy</code> 与 Role <code>system:node-proxier</code> 绑定，该 Role 授予了调用 <code>kube-apiserver</code> Proxy 相关 API 的权限</li>
</ul>
<p>启动 kube-proxy<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># cp kube-proxy.service /etc/systemd/system/</span></div><div class="line">[root@node1 ~]<span class="comment"># systemctl daemon-reload</span></div><div class="line">[root@node1 ~]<span class="comment"># systemctl enable kube-proxy</span></div><div class="line">[root@node1 ~]<span class="comment"># systemctl start kube-proxy</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># systemctl status kube-proxy</span></div><div class="line">● kube-proxy.service - Kubernetes Kube-Proxy Server</div><div class="line">   Loaded: loaded (/etc/systemd/system/kube-proxy.service; enabled; vendor preset: disabled)</div><div class="line">   Active: active (running) since Fri 2018-02-02 14:24:10 CST; 15s ago</div><div class="line">     Docs: https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line"> Main PID: 3660 (kube-proxy)</div><div class="line">   Memory: 8.7M</div><div class="line">   CGroup: /system.slice/kube-proxy.service</div><div class="line">           ‣ 3660 /usr/<span class="built_in">local</span>/bin/kube-proxy --bind-address=192.168.1.198 --hostname-override=192.168.1.198 --cluster-cidr=172.30.0.0/16 --kubeconfig=/etc/kubernetes/kube...</div><div class="line"></div><div class="line">Feb 02 14:24:10 node1.example.com kube-proxy[3660]: I0202 14:24:10.223982    3660 conntrack.go:98] Set sysctl <span class="string">'net/netfilter/nf_conntrack_tcp_timeout_established'</span> to 86400</div><div class="line">Feb 02 14:24:10 node1.example.com kube-proxy[3660]: I0202 14:24:10.224981    3660 conntrack.go:98] Set sysctl <span class="string">'net/netfilter/nf_conntrack_tcp_timeout_close_wait'</span> to 3600</div><div class="line">Feb 02 14:24:10 node1.example.com kube-proxy[3660]: I0202 14:24:10.225415    3660 config.go:202] Starting service config controller</div><div class="line">Feb 02 14:24:10 node1.example.com kube-proxy[3660]: I0202 14:24:10.225427    3660 controller_utils.go:1019] Waiting <span class="keyword">for</span> caches to sync <span class="keyword">for</span> service config controller</div><div class="line">Feb 02 14:24:10 node1.example.com kube-proxy[3660]: I0202 14:24:10.225514    3660 config.go:102] Starting endpoints config controller</div><div class="line">Feb 02 14:24:10 node1.example.com kube-proxy[3660]: I0202 14:24:10.225523    3660 controller_utils.go:1019] Waiting <span class="keyword">for</span> caches to sync <span class="keyword">for</span> endpoints config controller</div><div class="line">Feb 02 14:24:10 node1.example.com kube-proxy[3660]: I0202 14:24:10.325575    3660 controller_utils.go:1026] Caches are synced <span class="keyword">for</span> service config controller</div><div class="line">Feb 02 14:24:10 node1.example.com kube-proxy[3660]: I0202 14:24:10.325624    3660 proxier.go:984] Not syncing iptables until Services and Endpoints have been re...om master</div><div class="line">Feb 02 14:24:10 node1.example.com kube-proxy[3660]: I0202 14:24:10.326087    3660 controller_utils.go:1026] Caches are synced <span class="keyword">for</span> endpoints config controller</div><div class="line">Feb 02 14:24:10 node1.example.com kube-proxy[3660]: I0202 14:24:10.326163    3660 proxier.go:329] Adding new service port <span class="string">"default/kubernetes:https"</span> at 172.16.0.1:443/TCP</div><div class="line">Hint: Some lines were ellipsized, use <span class="_">-l</span> to show <span class="keyword">in</span> full.</div><div class="line">[root@node1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h5 id="验证集群功能"><a href="#验证集群功能" class="headerlink" title="验证集群功能"></a>验证集群功能</h5><p>定义文件:<br><a href="https://note.youdao.com/yws/api/personal/file/DBEF82CCEFC040ACAE8F919C9E381633?method=download&amp;shareKey=8f85df5224bf4e4a7480fd6dd60fd5d6" target="_blank" rel="external">nginx-ds.yml</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># cat nginx-ds.yml </span></div><div class="line">apiVersion: v1</div><div class="line">kind: Service</div><div class="line">metadata:</div><div class="line">  name: nginx-ds</div><div class="line">  labels:</div><div class="line">    app: nginx-ds</div><div class="line">spec:</div><div class="line">  <span class="built_in">type</span>: NodePort</div><div class="line">  selector:</div><div class="line">    app: nginx-ds</div><div class="line">  ports:</div><div class="line">  - name: http</div><div class="line">    port: 80</div><div class="line">    targetPort: 80</div><div class="line"></div><div class="line">---</div><div class="line"></div><div class="line">apiVersion: extensions/v1beta1</div><div class="line">kind: DaemonSet</div><div class="line">metadata:</div><div class="line">  name: nginx-ds</div><div class="line">  labels:</div><div class="line">    addonmanager.kubernetes.io/mode: Reconcile</div><div class="line">spec:</div><div class="line">  template:</div><div class="line">    metadata:</div><div class="line">      labels:</div><div class="line">        app: nginx-ds</div><div class="line">    spec:</div><div class="line">      containers:</div><div class="line">      - name: my-nginx</div><div class="line">        image: nginx:1.7.9</div><div class="line">        ports:</div><div class="line">        - containerPort: 80</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl create -f nginx-ds.yml</span></div></pre></td></tr></table></figure>
<p>检查各 Node 上的 Pod IP 连通性<br>当前k8s上有两个Node，在nginx-ds.yml中使用的是<code>DaemonSet</code>模式，所以会在每个Node上启动这个Pod<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#DaemonSet官方解释</span></div><div class="line">A DaemonSet ensures that all (or some) Nodes run a copy of a Pod. As nodes are added to the cluster, Pods are added to them. As nodes are removed from the cluster, those Pods are garbage collected. Deleting a DaemonSet will clean up the Pods it created.</div></pre></td></tr></table></figure></p>
<p>参考：<a href="https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/#what-is-a-daemonset" target="_blank" rel="external">https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/#what-is-a-daemonset</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#两个nginx容器的IP地址不同</span></div><div class="line">[root@master1 ~]<span class="comment"># kubectl get pods  -o wide</span></div><div class="line">NAME             READY     STATUS    RESTARTS   AGE       IP            NODE</div><div class="line">nginx-ds-9p9pl   1/1       Running   0          4s        172.30.57.2   192.168.1.198</div><div class="line">nginx-ds-tvp6b   1/1       Running   0          4s        172.30.41.2   192.168.1.199</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>检查服务 IP 和端口可达性<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get svc |grep nginx-ds</span></div><div class="line">nginx-ds     NodePort    172.16.117.40   &lt;none&gt;        80:8446/TCP   5m</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<ul>
<li>服务IP：172.16.117.40</li>
<li>服务端口：80</li>
<li>NodePort端口：8446</li>
</ul>
<p>在所有 Node 上执行，IP为nginx-ds的CLUSTER-IP(执行<code>kubectl get svc |grep nginx-ds</code>命令获取)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># curl 172.16.117.40</span></div></pre></td></tr></table></figure></p>
<p>检查服务的 NodePort 可达性<br>在外部机器的浏览器访问 <a href="http://192.168.1.198:8446/" target="_blank" rel="external">http://192.168.1.198:8446/</a><br><img src="https://note.youdao.com/yws/api/personal/file/58CE3B07349943BCAF3AD33C2186D3E0?method=download&amp;shareKey=2d79cfcc3db594d9e8beac43af44de55" alt="k8s_nginx"><br>预期输出 nginx 欢迎页面内容</p>
<h4 id="部署-kubedns-插件"><a href="#部署-kubedns-插件" class="headerlink" title="部署 kubedns 插件"></a>部署 kubedns 插件</h4><p>官方文件目录：kubernetes/cluster/addons/dns<br><a href="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/#pods-dns-config" target="_blank" rel="external">https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/#pods-dns-config</a>  </p>
<h5 id="系统预定义的-RoleBinding"><a href="#系统预定义的-RoleBinding" class="headerlink" title="系统预定义的 RoleBinding"></a>系统预定义的 RoleBinding</h5><p>预定义的 RoleBinding <code>system:kube-dns</code> 将 kube-system 命名空间的 <code>kube-dns</code> ServiceAccount 与 <code>system:kube-dns</code> Role 绑定， 该 Role 具有访问 kube-apiserver DNS 相关 API 的权限<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get clusterrolebindings system:kube-dns -o yaml</span></div><div class="line">apiVersion: rbac.authorization.k8s.io/v1</div><div class="line">kind: ClusterRoleBinding</div><div class="line">metadata:</div><div class="line">  annotations:</div><div class="line">    rbac.authorization.kubernetes.io/autoupdate: <span class="string">"true"</span></div><div class="line">  creationTimestamp: 2018-01-31T11:03:07Z</div><div class="line">  labels:</div><div class="line">    kubernetes.io/bootstrapping: rbac-defaults</div><div class="line">  name: system:kube-dns</div><div class="line">  resourceVersion: <span class="string">"86"</span></div><div class="line">  selfLink: /apis/rbac.authorization.k8s.io/v1/clusterrolebindings/system%3Akube-dns</div><div class="line">  uid: 51871810-0676-11e8-8cb0-1e2d0a5bc3f5</div><div class="line">roleRef:</div><div class="line">  apiGroup: rbac.authorization.k8s.io</div><div class="line">  kind: ClusterRole</div><div class="line">  name: system:kube-dns</div><div class="line">subjects:</div><div class="line">- kind: ServiceAccount</div><div class="line">  name: kube-dns</div><div class="line">  namespace: kube-system</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p><code>kubedns-controller.yaml</code> 中定义的 Pods 时使用了 <code>kubedns-sa.yaml</code> 文件定义的 <code>kube-dns</code> ServiceAccount，所以具有访问 kube-apiserver DNS 相关 API 的权限  </p>
<h5 id="配置-kube-dns-服务"><a href="#配置-kube-dns-服务" class="headerlink" title="配置 kube-dns 服务"></a>配置 kube-dns 服务</h5><p><a href="https://note.youdao.com/yws/api/personal/file/71B930661BD94F2495278744F67152ED?method=download&amp;shareKey=9545d5ea1a76180ceb41f96c8ad20e88" target="_blank" rel="external">busybox.yaml</a><br><a href="https://note.youdao.com/yws/api/personal/file/12BDDDB36A4E4C40BFBFCF45CA3136F5?method=download&amp;shareKey=e3dfda08a42733a5c60b05e86ece7e75" target="_blank" rel="external">kube-dns.yaml</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@master1 dns]<span class="comment"># pwd</span></div><div class="line">/root/dns</div><div class="line">[root@master1 dns]<span class="comment"># ls</span></div><div class="line">busybox.yaml  kube-dns.yaml</div><div class="line">[root@master1 dns]<span class="comment"># egrep -i 'clusterIP|image|domain|server=/cluster' kube-dns.yaml </span></div><div class="line">  clusterIP: 172.16.0.2</div><div class="line">        image: registry.cn-hangzhou.aliyuncs.com/google_containers/k8s-dns-kube-dns-amd64:1.14.7</div><div class="line">        - --domain=cluster.local.</div><div class="line">        image: registry.cn-hangzhou.aliyuncs.com/google_containers/k8s-dns-dnsmasq-nanny-amd64:1.14.7</div><div class="line">        - --server=/cluster.local/127.0.0.1<span class="comment">#10053</span></div><div class="line">        image: registry.cn-hangzhou.aliyuncs.com/google_containers/k8s-dns-sidecar-amd64:1.14.7</div><div class="line">[root@master1 dns]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<ul>
<li>需要将 <code>clusterIP</code> 设置为集群环境变量中变量 <code>CLUSTER_DNS_SVC_IP</code> 值，这个 IP 需要和 kubelet 的 <code>—cluster-dns</code> 参数值一致；</li>
</ul>
<p>配置 kube-dns Deployment  </p>
<ul>
<li><code>--domain</code> 为集群环境文档 变量 CLUSTER_DNS_DOMAIN 的值  </li>
<li>使用系统已经做了 RoleBinding 的 <code>kube-dns</code> ServiceAccount，该账户具有访问 kube-apiserver DNS 相关 API 的权限</li>
</ul>
<p>创建DNS<br><code>kubectl create -f kube-dns.yaml</code>创建dns，<code>kubectl delete -f kube-dns.yaml</code>删除dns<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl create -f dns/busybox.yaml</span></div><div class="line"></div><div class="line">[root@master1 ~]<span class="comment"># kubectl get pods -o wide</span></div><div class="line">NAME                               READY     STATUS    RESTARTS   AGE       IP            NODE</div><div class="line">busybox                            1/1       Running   0          19s       172.30.57.2   192.168.1.198</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl create -f dns/kube-dns.yaml</span></div><div class="line">[root@master1 ~]<span class="comment"># </span></div><div class="line">[root@master1 ~]<span class="comment"># kubectl get pods -o wide -n kube-system</span></div><div class="line">NAME                                    READY     STATUS    RESTARTS   AGE       IP            NODE</div><div class="line">kube-dns-9d8b5fb76-vz6ll                3/3       Running   0          1h        172.30.41.5   192.168.1.199</div><div class="line">[root@master1 ~]<span class="comment"># </span></div><div class="line">[root@master1 ~]<span class="comment"># kubectl get svc -o wide -n kube-system</span></div><div class="line">NAME                   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE       SELECTOR</div><div class="line">kube-dns               ClusterIP   172.16.0.2       &lt;none&gt;        53/UDP,53/TCP   1h        k8s-app=kube-dns</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>如果报错了，可以通过这条命令查看报错日志<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl describe pod kube-dns-9d8b5fb76-vz6ll --namespace=kube-system</span></div></pre></td></tr></table></figure></p>
<h5 id="创建nginx-服务测试dns"><a href="#创建nginx-服务测试dns" class="headerlink" title="创建nginx 服务测试dns"></a>创建nginx 服务测试dns</h5><p><a href="https://note.youdao.com/yws/api/personal/file/8782A994D7724D0988B354247623586A?method=download&amp;shareKey=54f9b7b40dd83181ad97d0f87a541c48" target="_blank" rel="external">nginx-deployment.yaml</a><br><a href="https://note.youdao.com/yws/api/personal/file/D71364D682964ECCB6B291105F5004DE?method=download&amp;shareKey=12e6ed9da3fe5b732853490da4267c32" target="_blank" rel="external">nginx-service.yaml</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl create -f nginx-deployment.yaml</span></div><div class="line">[root@master1 ~]<span class="comment"># kubectl create -f nginx-service.yaml</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get pods -o wide</span></div><div class="line">NAME                               READY     STATUS    RESTARTS   AGE       IP            NODE</div><div class="line">nginx-deployment<span class="_">-d</span>8d99448f-rb57v   1/1       Running   0          11m       172.30.41.2   192.168.1.199</div><div class="line">[root@master1 ~]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@master1 ~]<span class="comment"># kubectl get svc -o wide</span></div><div class="line">NAME            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)       AGE       SELECTOR</div><div class="line">kubernetes      ClusterIP   172.16.0.1       &lt;none&gt;        443/TCP       7d        &lt;none&gt;</div><div class="line">nginx-service   NodePort    172.16.215.237   &lt;none&gt;        88:8527/TCP   2d        app=nginx</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl exec busybox -it nslookup nginx-service</span></div><div class="line">Server:    172.16.0.2</div><div class="line">Address 1: 172.16.0.2 kube-dns.kube-system.svc.cluster.local</div><div class="line"></div><div class="line">Name:      nginx-service</div><div class="line">Address 1: 172.16.215.237 nginx-service.default.svc.cluster.local</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h4 id="部署-heapster-插件"><a href="#部署-heapster-插件" class="headerlink" title="部署 heapster 插件"></a>部署 heapster 插件</h4><p>heapster release下载页面：<a href="https://github.com/kubernetes/heapster/releases" target="_blank" rel="external">https://github.com/kubernetes/heapster/releases</a><br><a href="https://note.youdao.com/yws/api/personal/file/1D279E2FC1834C328D2A32586B1BA43E?method=download&amp;shareKey=7466236d2b9cb7747d6657d0b2da0392" target="_blank" rel="external">heapster-v1.5.0.tar.gz</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># wget https://codeload.github.com/kubernetes/heapster/tar.gz/v1.5.0 -O heapster-v1.5.0.tar.gz</span></div><div class="line">[root@master1 ~]<span class="comment"># tar -zxf heapster-v1.5.0.tar.gz</span></div><div class="line">[root@master1 ~]<span class="comment"># cd heapster-1.5.0/deploy/kube-config/influxdb</span></div><div class="line">[root@master1 influxdb]<span class="comment"># ls</span></div><div class="line">grafana.yaml  heapster.yaml  influxdb.yaml</div><div class="line">[root@master1 influxdb]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<h5 id="配置rbac"><a href="#配置rbac" class="headerlink" title="配置rbac"></a>配置rbac</h5><p><a href="https://note.youdao.com/yws/api/personal/file/CD179F4A7D4B47CA9F0FF2A55F033F6D?method=download&amp;shareKey=d80b32bb27faf201ba5ede4282aff019" target="_blank" rel="external">heapster-rbac.yaml</a><br>无需修改配置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 influxdb]<span class="comment"># pwd</span></div><div class="line">/root/heapster-1.5.0/deploy/kube-config/influxdb</div><div class="line">[root@master1 influxdb]<span class="comment"># kubectl create -f ../rbac/heapster-rbac.yaml</span></div></pre></td></tr></table></figure></p>
<p>如果不执行heapster-rbac.yaml文件，则会报下面的错误：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">E0518 06:08:09.927460       1 reflector.go:190] k8s.io/heapster/metrics/util/util.go:30: Failed to list *v1.Node: nodes is forbidden: User <span class="string">"system:serviceaccount:kube-system:heapster"</span> cannot list nodes at the cluster scope</div></pre></td></tr></table></figure></p>
<p>如果在启动docker容器时，一直处于<code>ContainerCreating</code>状态，且最后报下面的错误：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Warning  FailedCreatePodSandBox  34s (x11 over 43s)  kubelet, 192.168.1.204  Failed create pod sandbox.</div><div class="line">Normal   SandboxChanged          33s (x11 over 43s)  kubelet, 192.168.1.204  Pod sandbox changed, it will be killed and re-created.</div></pre></td></tr></table></figure></p>
<p>执行<code>journalctl --since 01:02:00 -u kubelet</code>查看日志发现，正在下载<code>registry.access.redhat.com/rhel7/pod-infrastructure:latest</code>docker镜像。<br>解决办法是：kube-node节点缺少<code>registry.access.redhat.com/rhel7/pod-infrastructure:latest</code>docker镜像。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker pull registry.access.redhat.com/rhel7/pod-infrastructure:latest</div></pre></td></tr></table></figure></p>
<h5 id="配置-influxdb-deployment"><a href="#配置-influxdb-deployment" class="headerlink" title="配置 influxdb-deployment"></a>配置 influxdb-deployment</h5><p><a href="https://note.youdao.com/yws/api/personal/file/BD2A861AB9B54032889A0C3D1E983190?method=download&amp;shareKey=516e9d2b54547090128c4c6d5aa220b5" target="_blank" rel="external">influxdb.yaml</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master1 influxdb]<span class="comment"># egrep -i 'image|nodeport' influxdb.yaml </span></div><div class="line">        image: lvanneo/heapster-influxdb-amd64:v1.1.1        <span class="comment">#修改image镜像</span></div><div class="line">  <span class="built_in">type</span>: NodePort</div><div class="line">[root@master1 influxdb]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 influxdb]<span class="comment"># pwd</span></div><div class="line">/root/heapster-1.5.0/deploy/kube-config/influxdb</div><div class="line">[root@master1 influxdb]<span class="comment"># kubectl create -f influxdb.yaml</span></div></pre></td></tr></table></figure>
<p>查看influxdb数据库集群地址和端口<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master1 influxdb]<span class="comment"># kubectl get svc -o wide -n kube-system</span></div><div class="line">NAME                  TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)         AGE       SELECTOR</div><div class="line">monitoring-influxdb   NodePort    172.16.38.42   &lt;none&gt;        8086:8898/TCP   14s       k8s-app=influxdb</div><div class="line">[root@master1 influxdb]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<h5 id="配置-heapster-deployment"><a href="#配置-heapster-deployment" class="headerlink" title="配置 heapster-deployment"></a>配置 heapster-deployment</h5><p><a href="https://note.youdao.com/yws/api/personal/file/92E6D9F454164EA1A1EAB607CF87B17D?method=download&amp;shareKey=02e9edb636da9a1807d040d9fcb5e01a" target="_blank" rel="external">heapster.yaml</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@master1 influxdb]<span class="comment"># egrep -i 'image:|source|sink' heapster.yaml </span></div><div class="line">        image: lvanneo/heapster-amd64:v1.3.0-beta.1            <span class="comment">#修改image镜像</span></div><div class="line">        - --source=kubernetes:https://192.168.1.195:6443      <span class="comment">#指定kube-apiserver认证地址</span></div><div class="line">        - --sink=influxdb:http://172.16.38.42:8086       <span class="comment">#指定influxdb数据库CLUSTER-IP地址</span></div><div class="line">[root@master1 influxdb]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 influxdb]<span class="comment"># pwd</span></div><div class="line">/root/heapster-1.5.0/deploy/kube-config/influxdb</div><div class="line">[root@master1 influxdb]<span class="comment"># kubectl create -f heapster.yaml</span></div></pre></td></tr></table></figure>
<p>查看heapster集群地址和端口<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">    [root@master1 influxdb]<span class="comment"># kubectl get svc -o wide -n kube-system</span></div><div class="line">NAME                  TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE       SELECTOR</div><div class="line">heapster              ClusterIP   172.16.202.225   &lt;none&gt;        80/TCP          12s       k8s-app=heapster</div><div class="line">[root@master1 influxdb]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<h5 id="配置-grafana-deployment"><a href="#配置-grafana-deployment" class="headerlink" title="配置 grafana-deployment"></a>配置 grafana-deployment</h5><p><a href="https://note.youdao.com/yws/api/personal/file/F2F784AEBF0145E2964FC3C412F6AB73?method=download&amp;shareKey=b94e4b769899c636ae4761f33b97afde" target="_blank" rel="external">grafana.yaml</a><br>修改如下配置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@master1 influxdb]<span class="comment"># egrep -i 'image|value: /|type: nodeport' grafana.yaml </span></div><div class="line">        image: lvanneo/heapster-grafana-amd64:v4.0.2           <span class="comment">#修改image镜像</span></div><div class="line">          <span class="comment"># value: /api/v1/namespaces/kube-system/services/monitoring-grafana/proxy    #默认</span></div><div class="line">          value: /         <span class="comment">#默认</span></div><div class="line">  <span class="built_in">type</span>: NodePort           <span class="comment">#去掉注释</span></div><div class="line">[root@master1 influxdb]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 influxdb]<span class="comment"># pwd</span></div><div class="line">/root/heapster-1.5.0/deploy/kube-config/influxdb</div><div class="line">[root@master1 influxdb]<span class="comment"># kubectl create -f grafana.yaml</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 influxdb]<span class="comment"># kubectl get svc -o wide -n kube-system</span></div><div class="line">NAME                  TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE       SELECTOR</div><div class="line">monitoring-grafana     NodePort    172.16.207.209   &lt;none&gt;        80:8642/TCP     31m       k8s-app=grafana</div></pre></td></tr></table></figure>
<p>检查 Deployment<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get deployments -n kube-system | grep -E 'heapster|monitoring'</span></div><div class="line">heapster              1         1         1            1           25m</div><div class="line">monitoring-grafana    1         1         1            1           53s</div><div class="line">monitoring-influxdb   1         1         1            1           28m</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>检查 Pods<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get pods -n kube-system -o wide </span></div><div class="line">NAME                                    READY     STATUS    RESTARTS   AGE       IP            NODE</div><div class="line">heapster-5<span class="built_in">fc</span>8f648dc-pn4lm               1/1       Running   0          1h        172.30.57.4   192.168.1.198</div><div class="line">monitoring-grafana-57b8fcd7b4-67r2j     1/1       Running   0          28m       172.30.57.5   192.168.1.198</div><div class="line">monitoring-influxdb-68d87d45f5-5d7qs    1/1       Running   0          1h        172.30.41.3   192.168.1.199</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>需要逐一检查下各docker的logs有没有报错信息  </p>
<h6 id="访问grafana"><a href="#访问grafana" class="headerlink" title="访问grafana"></a>访问grafana</h6><p>访问 <a href="http://192.168.1.198:8642/" target="_blank" rel="external">http://192.168.1.198:8642/</a><br>配置influxdb-datasource<br><img src="https://note.youdao.com/yws/api/personal/file/A4614D24871C427489359C1827DC7548?method=download&amp;shareKey=abbb42575786c75c1b28c88c32d985b7" alt="grafana"><br><img src="https://note.youdao.com/yws/api/personal/file/91D96DCEF1D849729511049E94482122?method=download&amp;shareKey=55ebe8b0392e107d9344d58f3bd7ede1" alt="grafana"><br><img src="https://note.youdao.com/yws/api/personal/file/66317BF04C6A4C8281095808373DD48E?method=download&amp;shareKey=82c36a103ee293f3bdc6c03c3b997674" alt="grafana"><br><img src="https://note.youdao.com/yws/api/personal/file/534929F4400246E7ACA46CEB42D4540D?method=download&amp;shareKey=0a8aa8882c217c30dabb72e8f9050480" alt="grafana"><br><img src="https://note.youdao.com/yws/api/personal/file/E765DF64401B40A7BA3ACC9EF4BFFB98?method=download&amp;shareKey=9e289a2a510957a395f3abb799f2601f" alt="grafana">  </p>
<h4 id="部署-dashboard-插件"><a href="#部署-dashboard-插件" class="headerlink" title="部署 dashboard 插件"></a>部署 dashboard 插件</h4><p><a href="https://note.youdao.com/yws/api/personal/file/A1CFC0139B514BF7B6C0CD3D6F53531B?method=download&amp;shareKey=c70aa3e74b26c22fa42337538f8fba36" target="_blank" rel="external">kubernetes-dashboard.yaml</a><br>通过rbac 认证<code>kind: ServiceAccount</code>调用认证文件(<code>/etc/kubernetes/bootstrap.kubeconfig</code>和<code>/etc/kubernetes/kube-proxy.kubeconfig</code>)，访问的接口<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># egrep -i 'image|apiserver|heapster-host|nodeport' kubernetes-dashboard.yaml </span></div><div class="line">        image: k8scn/kubernetes-dashboard-amd64:v1.8.0</div><div class="line">          - --apiserver-host=http://192.168.1.195:8080</div><div class="line">          - --heapster-host=http://172.16.202.225</div><div class="line">  <span class="built_in">type</span>: NodePort</div><div class="line">      <span class="comment">#nodePort: 38443    #k8s kind:server 可以使用nodePort指定端口</span></div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl create -f kubernetes-dashboard.yaml</span></div></pre></td></tr></table></figure>
<p>查看kubernetes-dashboard分配的Node<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get pod -o wide -n kube-system</span></div><div class="line">NAME                                    READY     STATUS    RESTARTS   AGE       IP            NODE</div><div class="line">kubernetes-dashboard-666fbbf977-v9vsh   1/1       Running   0          49s       172.30.41.4   192.168.1.199</div></pre></td></tr></table></figure></p>
<p>查看kubernetes-dashboard分配的 NodePort<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get svc -o wide -n kube-system</span></div><div class="line">NAME                   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE       SELECTOR</div><div class="line">kubernetes-dashboard   NodePort    172.16.59.24     &lt;none&gt;        443:8847/TCP    39m       k8s-app=kubernetes-dashboard</div></pre></td></tr></table></figure></p>
<ul>
<li>NodePort 8847映射到 dashboard pod 80端口  </li>
</ul>
<p>检查 controller<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get deployment kubernetes-dashboard  -n kube-system</span></div><div class="line">NAME                   DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</div><div class="line">kubernetes-dashboard   1         1         1            1           15m</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>获取集群服务地址列表<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl cluster-info</span></div><div class="line">Kubernetes master is running at https://192.168.1.195:6443</div><div class="line">Heapster is running at https://192.168.1.195:6443/api/v1/namespaces/kube-system/services/heapster/proxy</div><div class="line">KubeDNS is running at https://192.168.1.195:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</div><div class="line">monitoring-grafana is running at https://192.168.1.195:6443/api/v1/namespaces/kube-system/services/monitoring-grafana/proxy</div><div class="line">monitoring-influxdb is running at https://192.168.1.195:6443/api/v1/namespaces/kube-system/services/monitoring-influxdb/proxy</div><div class="line"></div><div class="line">To further debug and diagnose cluster problems, use <span class="string">'kubectl cluster-info dump'</span>.</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<h5 id="访问dashboard"><a href="#访问dashboard" class="headerlink" title="访问dashboard"></a>访问dashboard</h5><p>kubernetes-dashboard 服务暴露了 NodePort，可以使用 <a href="http://NodeIP:nodePort" target="_blank" rel="external">http://NodeIP:nodePort</a> 地址访问 dashboard  </p>
<p>访问 <a href="https://192.168.1.199:8847" target="_blank" rel="external">https://192.168.1.199:8847</a> 访问k8s dashboard，经测试火狐浏览器可以，但360浏览器打不开，报404<br><img src="https://note.youdao.com/yws/api/personal/file/045DBC6BEB45413AAA3C638456310A02?method=download&amp;shareKey=f5da2b7cde024379197726cbd1cf86a5" alt="k8s-dashboard"><br><img src="https://note.youdao.com/yws/api/personal/file/C62DEA5E39544B70A3DE0F3C4286EAB6?method=download&amp;shareKey=0d549ebb275806b21dcfe84bfec751c2" alt="k8s-dashboard"><br><img src="https://note.youdao.com/yws/api/personal/file/64C58F5AE8284F75BEB4A3DACC7C9A8A?method=download&amp;shareKey=c60811cb5ac18d5a9bd86c903fdef485" alt="k8s-dashboard">  </p>
<p>如果不安装<code>Heapster/influxdb</code>等插件，k8s-dashboard不能展示<code>Pod</code>，<code>Nodes</code>的<code>CPU</code>，<code>内存</code>等 metric 图形  </p>
<h5 id="保存镜像"><a href="#保存镜像" class="headerlink" title="保存镜像"></a>保存镜像</h5><p>导出镜像<br><a href="https://pan.baidu.com/s/1sngFMlZ" target="_blank" rel="external">镜像保存在百度网盘packages目录，密码：nwzk</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">docker save k8scn/kubernetes-dashboard-amd64:v1.8.0 &gt; kubernetes-dashboard-amd64-v1.8.0.tar.gz</div><div class="line">docker save registry.cn-hangzhou.aliyuncs.com/google_containers/k8s-dns-sidecar-amd64:1.14.7 &gt; k8s-dns-sidecar-amd64-1.14.7.tar.gz</div><div class="line">docker save registry.cn-hangzhou.aliyuncs.com/google_containers/k8s-dns-kube-dns-amd64:1.14.7 &gt; k8s-dns-kube-dns-amd64-1.14.7.tar.gz</div><div class="line">docker save registry.cn-hangzhou.aliyuncs.com/google_containers/k8s-dns-dnsmasq-nanny-amd64:1.14.7 &gt; k8s-dns-dnsmasq-nanny-amd64-1.14.7.tar.gz</div><div class="line">docker save lvanneo/heapster-influxdb-amd64:v1.1.1 &gt; heapster-influxdb-amd64-v1.1.1.tar.gz</div><div class="line">docker save lvanneo/heapster-grafana-amd64:v4.0.2 &gt; heapster-grafana-amd64-v4.0.2.tar.gz</div><div class="line">docker save lvanneo/heapster-amd64:v1.3.0-beta.1 &gt; heapster-amd64-v1.3.0-beta.1.tar.gz</div><div class="line">docker save k8scn/kubernetes-dashboard-amd64:v1.8.0 &gt; kubernetes-dashboard-amd64-v1.8.0.tar.gz</div></pre></td></tr></table></figure></p>
<p>导入镜像<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker load -i kubernetes-dashboard-amd64-v1.8.0.tar.gz</div></pre></td></tr></table></figure></p>
<p>参考：<a href="https://github.com/opsnull/follow-me-install-kubernetes-cluster" target="_blank" rel="external">https://github.com/opsnull/follow-me-install-kubernetes-cluster</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2018/02/23/部署TLS-k8s/">http://www.yfshare.vip/2018/02/23/部署TLS-k8s/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[自建docker私有仓库(Vmware Harbor)]]></title>
      <url>http://www.yfshare.vip/2018/01/11/%E8%87%AA%E5%BB%BAdocker%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93-Vmware-Harbor/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>Harbor是一个用于存储和分发Docker镜像的企业级Registry服务器，通过添加一些企业必需的功能特性，例如安全、标识和管理等，扩展了开源Docker Distribution。作为一个企业级私有Registry服务器，Harbor提供了更好的性能和安全。提升用户使用Registry构建和运行环境传输镜像的效率。Harbor支持安装在多个Registry节点的镜像资源复制，镜像全部保存在私有Registry中，确保数据和知识产权在公司内部网络中管控。另外，Harbor也提供了高级的安全特性，诸如用户管理，访问控制和活动审计等。<br><a id="more"></a></p>
<ul>
<li>基于角色的访问控制 - 用户与Docker镜像仓库通过“项目”进行组织管理，一个用户可以对多个镜像仓库在同一命名空间（project）里有不同的权限。  </li>
<li>镜像复制 - 镜像可以在多个Registry实例中复制（同步）。尤其适合于负载均衡，高可用，混合云和多云的场景。  </li>
<li>图形化用户界面 - 用户可以通过浏览器来浏览，检索当前Docker镜像仓库，管理项目和命名空间。  </li>
<li>AD/LDAP 支持 - Harbor可以集成企业内部已有的AD/LDAP，用于鉴权认证管理。  </li>
<li>审计管理 - 所有针对镜像仓库的操作都可以被记录追溯，用于审计管理。  </li>
<li>国际化 - 已拥有英文、中文、德文、日文和俄文的本地化版本。更多的语言将会添加进来。  </li>
<li>RESTful API - RESTful API 提供给管理员对于Harbor更多的操控, 使得与其它管理软件集成变得更容易。  </li>
<li>部署简单 - 提供在线和离线两种安装工具， 也可以安装到vSphere平台(OVA方式)虚拟设备。  </li>
</ul>
<p>官网地址：<a href="https://vmware.github.io/harbor/cn/" target="_blank" rel="external">https://vmware.github.io/harbor/cn/</a><br>官方下载地址：<a href="https://github.com/vmware/harbor/releases" target="_blank" rel="external">https://github.com/vmware/harbor/releases</a><br><a href="https://pan.baidu.com/s/1gfeZEOb" target="_blank" rel="external">vmware harbor v1.3.0-rc4百度网盘，密码：m2mi</a><br>安装向导：<a href="https://github.com/vmware/harbor/blob/master/docs/installation_guide.md" target="_blank" rel="external">https://github.com/vmware/harbor/blob/master/docs/installation_guide.md</a><br>用户使用指南：<a href="https://github.com/vmware/harbor/blob/master/docs/user_guide.md" target="_blank" rel="external">https://github.com/vmware/harbor/blob/master/docs/user_guide.md</a><br>https配置：<a href="https://github.com/vmware/harbor/blob/master/docs/configure_https.md" target="_blank" rel="external">https://github.com/vmware/harbor/blob/master/docs/configure_https.md</a>  </p>
<h4 id="安装docker-compose"><a href="#安装docker-compose" class="headerlink" title="安装docker-compose"></a>安装docker-compose</h4><p>docker-compose版本需要大于<code>1.7.1+</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -L https://github.com/docker/compose/releases/download/1.18.0/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose</span></div><div class="line"><span class="comment"># chmod +x /usr/local/bin/docker-compose</span></div></pre></td></tr></table></figure></p>
<h4 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mkdir -p /data/cert</div><div class="line"><span class="built_in">cd</span> /data/cert</div><div class="line">openssl req -newkey rsa:4096 -nodes -sha256 -keyout ca.key -x509 -days 365 -out ca.crt</div><div class="line">openssl req -newkey rsa:4096 -nodes -sha256 -keyout server.key -out server.csr</div><div class="line"><span class="built_in">echo</span> subjectAltName = IP:192.168.1.196 &gt; extfile.cnf</div><div class="line">openssl x509 -req -days 365 -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -extfile extfile.cnf -out server.crt</div></pre></td></tr></table></figure>
<h4 id="部署Vmware-Harbor"><a href="#部署Vmware-Harbor" class="headerlink" title="部署Vmware Harbor"></a>部署Vmware Harbor</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># tar -zxf harbor-offline-installer-v1.3.0-rc4.tgz</span></div><div class="line"><span class="comment"># cd harbor</span></div><div class="line"><span class="comment"># grep -iv '^#' harbor.cfg | grep -iv '^$'</span></div><div class="line">hostname = 192.168.1.196          <span class="comment">#如果用购买的证书需要写域名</span></div><div class="line">ui_url_protocol = https           <span class="comment">#http改成https</span></div><div class="line">db_password = root123             <span class="comment">#密码不能改，否则有些容器起不来</span></div><div class="line">max_job_workers = 3</div><div class="line">customize_crt = on</div><div class="line">ssl_cert = /data/cert/server.crt  <span class="comment">#指定证书路径</span></div><div class="line">ssl_cert_key = /data/cert/server.key   <span class="comment">#同上，下面全默认即可</span></div><div class="line">secretkey_path = /data</div><div class="line">admiral_url = NA</div><div class="line">clair_db_password = password</div><div class="line">log_rotate_count = 50</div><div class="line">log_rotate_size = 200M</div><div class="line">email_identity = </div><div class="line">email_server = smtp.mydomain.com</div><div class="line">email_server_port = 25</div><div class="line">email_username = sample_admin@mydomain.com</div><div class="line">email_password = abc</div><div class="line">email_from = admin &lt;sample_admin@mydomain.com&gt;</div><div class="line">email_ssl = <span class="literal">false</span></div><div class="line">email_insecure = <span class="literal">false</span></div><div class="line">harbor_admin_password = Harbor12345</div><div class="line">auth_mode = db_auth</div><div class="line">ldap_url = ldaps://ldap.mydomain.com</div><div class="line">ldap_basedn = ou=people,dc=mydomain,dc=com</div><div class="line">ldap_uid = uid </div><div class="line">ldap_scope = 3 </div><div class="line">ldap_timeout = 5</div><div class="line">self_registration = on</div><div class="line">token_expiration = 30</div><div class="line">project_creation_restriction = everyone</div><div class="line">db_host = mysql</div><div class="line">db_port = 3306</div><div class="line">db_user = root</div><div class="line">uaa_endpoint = uaa.mydomain.org</div><div class="line">uaa_clientid= id</div><div class="line">uaa_clientsecret= secret</div><div class="line">uaa_ca_root= /path/to/uaa_ca.pem</div><div class="line"><span class="comment">#</span></div></pre></td></tr></table></figure>
<p>Docker版本大于<code>1.6.0</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cat /etc/docker/daemon.json</span></div><div class="line">&#123; <span class="string">"insecure-registries"</span>:[<span class="string">"192.168.1.196"</span>] &#125;           <span class="comment">#如果harbor.cfg里填的是域名，这里要保持一致</span></div><div class="line"><span class="comment">#</span></div><div class="line">systemctl <span class="built_in">enable</span> docker</div><div class="line">systemctl start docker</div><div class="line">./install.sh            <span class="comment">#安装Vmware Harbor</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># docker images | grep -i vmware</span></div><div class="line">vmware/harbor-log                                                 v1.3.0-rc4          58aa9393b1<span class="built_in">cd</span>        3 weeks ago         207MB</div><div class="line">vmware/harbor-jobservice                                          v1.3.0-rc4          b3664e837ab8        3 weeks ago         197MB</div><div class="line">vmware/harbor-ui                                                  v1.3.0-rc4          5f6e4c4b41da        3 weeks ago         211MB</div><div class="line">vmware/harbor-adminserver                                         v1.3.0-rc4          a907519f7baf        3 weeks ago         174MB</div><div class="line">vmware/harbor-db                                                  v1.3.0-rc4          83b013940805        3 weeks ago         586MB</div><div class="line">vmware/photon                                                     1.0                 7b154bf6f104        3 weeks ago         130MB</div><div class="line">vmware/clair                                                      v2.0.1-photon       7a633033c5b1        5 weeks ago         365MB</div><div class="line">vmware/postgresql                                                 9.6.5-photon        a5c79b0473d9        6 weeks ago         285MB</div><div class="line">vmware/registry                                                   2.6.2-photon        c38af846a0da        6 weeks ago         240MB</div><div class="line">vmware/mariadb-photon                                             10.2.10             eaaae71dea19        6 weeks ago         586MB</div><div class="line">vmware/notary-photon                                              signer-0.5.1        064b309ad822        6 weeks ago         246MB</div><div class="line">vmware/notary-photon                                              server-0.5.1        b8cc51024379        6 weeks ago         247MB</div><div class="line">vmware/nginx-photon                                               1.11.13             2971c92cc1ae        6 weeks ago         200MB</div><div class="line">vmware/harbor-db-migrator                                         1.3                 6cac2b89f086        6 weeks ago         1.11GB</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># docker ps -a | grep -i vmware</span></div><div class="line">ea6b2d79bd4b    vmware/nginx-photon:1.11.13           <span class="string">"nginx -g 'daemon of…"</span>   About a minute ago   Up About a minute        0.0.0.0:80-&gt;80/tcp, 0.0.0.0:443-&gt;443/tcp, 0.0.0.0:4443-&gt;4443/tcp   nginx</div><div class="line">3e1e767e3095    vmware/harbor-jobservice:v1.3.0-rc4   <span class="string">"/harbor/start.sh"</span>       About a minute ago   Up About a minute (healthy)  harbor-jobserviced</div><div class="line">08ae8e864d9     vmware/harbor-ui:v1.3.0-rc4           <span class="string">"/harbor/start.sh"</span>       About a minute ago   Up About a minute (healthy)  harbor-ui</div><div class="line">e2abd8a9f45d    vmware/harbor-db:v1.3.0-rc4           <span class="string">"/usr/local/bin/dock…"</span>   About a minute ago   Up About a minute (healthy)   3306/tcp    harbor-db</div><div class="line">5337d7d2cb0a    vmware/harbor-adminserver:v1.3.0-rc4  <span class="string">"/harbor/start.sh"</span>       About a minute ago   Up About a minute (healthy)   harbor-adminserver</div><div class="line">cf85ac001f1f    vmware/registry:2.6.2-photon          <span class="string">"/entrypoint.sh serv…"</span>   About a minute ago   Up About a minute (healthy)   5000/tcp    registry</div><div class="line">d6075f9aa12c    vmware/harbor-log:v1.3.0-rc4          <span class="string">"/bin/sh -c /usr/loc…"</span>   About a minute ago   Up About a minute (healthy)   127.0.0.1:1514-&gt;10514/tcp  harbor-log</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>登陆时如果报下面错误，则需要修改<code>/etc/docker/daemon.json</code>文件<br><code>Error response from daemon: Get https://192.168.1.196/v2/: x509: certificate signed by unknown authority</code><br>参考：<a href="https://github.com/vmware/harbor/blob/master/docs/user_guide.md#pulling-and-pushing-images-using-docker-client" target="_blank" rel="external">https://github.com/vmware/harbor/blob/master/docs/user_guide.md#pulling-and-pushing-images-using-docker-client</a>  </p>
<h4 id="上传镜像"><a href="#上传镜像" class="headerlink" title="上传镜像"></a>上传镜像</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># docker login 192.168.1.196</span></div><div class="line">Username: admin</div><div class="line">Password: </div><div class="line">Login Succeeded</div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># docker tag nginx:latest 192.168.1.196/library/nginx:latest</span></div><div class="line"><span class="comment"># docker push 192.168.1.196/library/nginx:latest</span></div></pre></td></tr></table></figure>
<h4 id="下载镜像"><a href="#下载镜像" class="headerlink" title="下载镜像"></a>下载镜像</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># docker rmi 192.168.1.196/library/nginx nginx</span></div><div class="line"><span class="comment"># docker pull 192.168.1.196/library/nginx:latest</span></div><div class="line"><span class="comment"># docker images | grep -i nginx</span></div><div class="line">192.168.1.196/library/nginx   latest              3f8a4339aadd        2 weeks ago         108MB</div><div class="line"><span class="comment">#</span></div></pre></td></tr></table></figure>
<h4 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h4><p>访问：<a href="https://192.168.1.196" target="_blank" rel="external">https://192.168.1.196</a> 打开vmware Harbor<br>默认用户名密码：<code>admin</code> / <code>Harbor12345</code><br><img src="https://note.youdao.com/yws/api/personal/file/FBB5CB4E422E45B09399E5629C336CD8?method=download&amp;shareKey=45cd553065ceb3c801443de38c483163" alt="vmware harbor"><br><img src="https://note.youdao.com/yws/api/personal/file/4620151E79EC49FA95D46FCFE61B81BB?method=download&amp;shareKey=335eab830fd98b9e0755722d8eb8a7e7" alt="vmware harbor"><br><img src="https://note.youdao.com/yws/api/personal/file/1F7BDB6EC9724BCE98FC027EEAE58356?method=download&amp;shareKey=698ec4f96d8d22df4b2aabb1de4f62e6" alt="vmware harbor"><br><img src="https://note.youdao.com/yws/api/personal/file/2C45B2D75C624C1E8E25FBB5700B7C17?method=download&amp;shareKey=e14797d51254c589aa2fbfba31fa4d4f" alt="vmware harbor"><br><img src="https://note.youdao.com/yws/api/personal/file/E9BC596839A8449E9BAB09B30E07D8E8?method=download&amp;shareKey=64519e8e82850773141cc6071cd2ddae" alt="vmware harbor"><br><img src="https://note.youdao.com/yws/api/personal/file/788558B5E45F4900B5E71109B1C6A7F7?method=download&amp;shareKey=13a6c8be4dc3ea68649e31a0ae91fc85" alt="vmware harbor"><br><img src="https://note.youdao.com/yws/api/personal/file/AD8A2E095F4A48EE8725E2036F521282?method=download&amp;shareKey=d79ca2bb925c020ee84ea719cc9c8637" alt="vmware harbor"><br><img src="https://note.youdao.com/yws/api/personal/file/354AC86784DB4B76AC72172F6AFDAF20?method=download&amp;shareKey=97c1afb9dddacd63de33499ce98a980d" alt="vmware harbor">  </p>
<h4 id="卸载"><a href="#卸载" class="headerlink" title="卸载"></a>卸载</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># pwd</span></div><div class="line">/root/harbor</div><div class="line"><span class="comment"># docker-compose -f docker-compose.yml down</span></div></pre></td></tr></table></figure>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2018/01/11/自建docker私有仓库-Vmware-Harbor/">http://www.yfshare.vip/2018/01/11/自建docker私有仓库-Vmware-Harbor/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[The Docker of Jira7.2.0 and Confluence6.0.0]]></title>
      <url>http://www.yfshare.vip/2017/12/20/The-Docker-of-Jira7-2-0-and-Confluence6-0-0/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>JIRA是一个缺陷跟踪管理系统，开发者是 Atlassian；<br>Confluence 是一个专业的企业知识管理与协同软件，可以用于构建企业wiki。<br>这里我把Jira7.2.0 和 Confluence6.0.0根据实际需求把它们封装成两个Docker容器，方便我们快速部署它们。<br><a id="more"></a></p>
<h4 id="主要变化"><a href="#主要变化" class="headerlink" title="主要变化"></a>主要变化</h4><ul>
<li>添加官方JIRA和Confluence容器宿主机debian9 中文支持</li>
<li>修改Mysql字符集为UTF8，默认是latin1</li>
</ul>
<h4 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h4><p>如果想分别单独部署 JIRA 和 Confluence，可以参考：<br>注：需要使用我提供的三个docker image，否则官网的image不支持中文  </p>
<ul>
<li>mysql：<a href="https://hub.docker.com/r/yfshare/mysql/" target="_blank" rel="external">https://hub.docker.com/r/yfshare/mysql/</a>  </li>
<li>JIRA：<a href="https://hub.docker.com/r/yfshare/jira/" target="_blank" rel="external">https://hub.docker.com/r/yfshare/jira/</a>  </li>
<li>Confluence：<a href="https://hub.docker.com/r/yfshare/confluence/" target="_blank" rel="external">https://hub.docker.com/r/yfshare/confluence/</a>  </li>
</ul>
<p>部署分两种方法：</p>
<ul>
<li>手动部署，按照步骤一步步来，可以参考：<ul>
<li>JIRA：<a href="http://www.yfshare.vip/2017/05/09/%E9%83%A8%E7%BD%B2JIRA-7-2-2-for-Linux/">http://www.yfshare.vip/2017/05/09/%E9%83%A8%E7%BD%B2JIRA-7-2-2-for-Linux/</a>  </li>
<li>Confluence：<a href="http://www.yfshare.vip/2017/06/25/%E9%83%A8%E7%BD%B2atlassian-confluence-6-1-2/">http://www.yfshare.vip/2017/06/25/%E9%83%A8%E7%BD%B2atlassian-confluence-6-1-2/</a>  </li>
</ul>
</li>
<li>Pull Docker<ul>
<li><code>docker pull yfshare/mysql:5.6</code>  </li>
<li><code>docker pull yfshare/jira:7.2.0</code>  </li>
<li><code>docker pull yfshare/confluence:6.0.0</code>  </li>
</ul>
</li>
</ul>
<p>这里提供了Docker-Compose，把JIRA和Confluence整合在一起了，和前面不同的是，这里只使用了一个数据库，前面直接拉会出现两个数据库。<br>但，由于The Docker of Mysql环境变量问题，所以Confluence需要手动初始化数据库，JIRA可以在Docker Compose里直接定义。  </p>
<h5 id="Docker-Compose"><a href="#Docker-Compose" class="headerlink" title="Docker Compose"></a>Docker Compose</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cat docker-jira-confluence-compose.yml </span></div><div class="line">version: <span class="string">'2'</span></div><div class="line">services:</div><div class="line">  db:</div><div class="line">    image: yfshare/mysql:5.6</div><div class="line">    container_name: atlassian_mysql</div><div class="line">    environment:</div><div class="line">      MYSQL_ROOT_PASSWORD: <span class="string">'20180223@Julend.com'</span></div><div class="line">      MYSQL_DATABASE: <span class="string">'jiradb'</span></div><div class="line">      MYSQL_USER: <span class="string">'jira'</span></div><div class="line">      MYSQL_PASSWORD: <span class="string">'jirapass@20180223'</span></div><div class="line">    ports:</div><div class="line">      - 3306:3306</div><div class="line">    volumes:</div><div class="line">      - /data/docker_mount/atlassian_mysql:/var/lib/mysql</div><div class="line">      - /etc/localtime:/etc/localtime:ro</div><div class="line">    restart: always</div><div class="line"></div><div class="line">  JIRA:</div><div class="line">    image: yfshare/jira:7.2.0</div><div class="line">    container_name: JIRA</div><div class="line">    ports:</div><div class="line">      - 8080:8080</div><div class="line">    volumes:</div><div class="line">      - /data/docker_mount/atlassian/Jira_Home:/var/atlassian/jira</div><div class="line">      - /etc/localtime:/etc/localtime:ro</div><div class="line">    links:</div><div class="line">      - db</div><div class="line">    restart: always</div><div class="line"></div><div class="line"><span class="comment">#Confluence数据需要自己手动创建</span></div><div class="line"><span class="comment">#mkdir -p /data/docker_mount/atlassian/&#123;Jira_Home,Confluence_Home&#125; &amp;&amp; chmod 777 /data/docker_mount/atlassian/ -R</span></div><div class="line"><span class="comment">#create database confluencedb default character set utf8 collate utf8_general_ci;</span></div><div class="line"><span class="comment">#create user 'confluenceuser'@'%' identified by 'a86b6913dd';</span></div><div class="line"><span class="comment">#grant all privileges on confluencedb.* to 'confluenceuser'@'%';</span></div><div class="line"><span class="comment">#flush privileges;</span></div><div class="line">  Confluence:</div><div class="line">    image: yfshare/confluence:6.0.0</div><div class="line">    container_name: Confluence</div><div class="line">    ports:</div><div class="line">      - 8090:8090</div><div class="line">    volumes:</div><div class="line">      - /data/docker_mount/atlassian/Confluence_Home:/var/atlassian/confluence</div><div class="line">      - /etc/localtime:/etc/localtime:ro</div><div class="line">    links:</div><div class="line">      - db</div><div class="line">    restart: always</div></pre></td></tr></table></figure>
<h5 id="手动初始化confluence数据库"><a href="#手动初始化confluence数据库" class="headerlink" title="手动初始化confluence数据库"></a>手动初始化confluence数据库</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mkdir -p /data/docker_mount/atlassian/&#123;Jira_Home,Confluence_Home&#125; &amp;&amp; chmod 777 /data/docker_mount/atlassian/ -R</div><div class="line">mysql -uroot -p<span class="string">'password'</span></div><div class="line">&gt; create database confluencedb default character <span class="built_in">set</span> utf8 collate utf8_general_ci;</div><div class="line">&gt; create user <span class="string">'confluenceuser'</span>@<span class="string">'%'</span> identified by <span class="string">'a86b6913dd'</span>;</div><div class="line">&gt; grant all privileges on confluencedb.* to <span class="string">'confluenceuser'</span>@<span class="string">'%'</span>;</div><div class="line">&gt; flush privileges;</div></pre></td></tr></table></figure>
<h5 id="启动容器"><a href="#启动容器" class="headerlink" title="启动容器"></a>启动容器</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker-compose <span class="_">-f</span> docker-jira-confluence-compose.yml up <span class="_">-d</span></div></pre></td></tr></table></figure>
<h5 id="初始化配置"><a href="#初始化配置" class="headerlink" title="初始化配置"></a>初始化配置</h5><p>JIRA访问：<code>http://localhost:8080</code><br>Confluence访问：<code>http://localhost:8090</code>  </p>
<h4 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h4><p><img src="https://note.youdao.com/yws/api/personal/file/40545D4B08214DFC9C24CEA80BD99057?method=download&amp;shareKey=09a20fe6e1d02d17c571dc81cb085994" alt="jira_login"><br><img src="https://note.youdao.com/yws/api/personal/file/67E688566D8742B8909EC22497EC5113?method=download&amp;shareKey=a348a3215c8edc63a8eb1b0f9096ca4a" alt="jira_issue">  </p>
<p><img src="https://note.youdao.com/yws/api/personal/file/44878F806D6D41C29ADE42983698F665?method=download&amp;shareKey=2f3342ab2a85e08cce3e896ab381ee31" alt="confluence_login"><br><img src="https://note.youdao.com/yws/api/personal/file/223D0600A1804DCDB3E1C23C0BE8E670?method=download&amp;shareKey=9bb3b45acf19a6f74e1982cd9c06a7e2" alt="confluence_issue">  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/12/20/The-Docker-of-Jira7-2-0-and-Confluence6-0-0/">http://www.yfshare.vip/2017/12/20/The-Docker-of-Jira7-2-0-and-Confluence6-0-0/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[自建docker私有仓库(Registry)]]></title>
      <url>http://www.yfshare.vip/2017/12/20/%E8%87%AA%E5%BB%BAdocker%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93-Registry/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>Docker Hub 存放着 Docker 及其组件的所有资源。它可以提供：  </p>
<ul>
<li>Docker 镜像主机</li>
<li>用户认证</li>
<li>自动镜像构建和工作流程工具，如构建触发器和 web hooks</li>
<li>整合了 GitHub 和 BitBucket</li>
</ul>
<p>但，有些场景我们需要一个私有仓库来管理自己的镜像，可以通过Registry来实现此目的。Registry作为Docker的核心组件之一负责镜像内容的存储与分发，客户端的docker pull以及push命令都将直接与registry进行交互。  </p>
<p>环境：<br>　　Docker 17.12.0-ce-rc4<br>　　Centos 7.3  </p>
<h4 id="部署Docker"><a href="#部署Docker" class="headerlink" title="部署Docker"></a>部署Docker</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># yum remove docker docker-common docker-selinux docker-engine -y</span></div><div class="line"><span class="comment"># yum install -y yum-utils device-mapper-persistent-data lvm2</span></div><div class="line"><span class="comment"># yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span></div><div class="line"><span class="comment"># yum-config-manager --enable docker-ce-edge</span></div><div class="line"><span class="comment"># yum-config-manager --enable docker-ce-test</span></div><div class="line"><span class="comment"># yum install docker-ce -y</span></div></pre></td></tr></table></figure>
<h4 id="自建证书"><a href="#自建证书" class="headerlink" title="自建证书"></a>自建证书</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># mkdir -p conf</span></div><div class="line"><span class="comment"># openssl req -new -newkey rsa:4096 -days 365 -subj "/CN=localhost" -nodes -x509 -keyout conf/auth.key -out conf/auth.cert</span></div></pre></td></tr></table></figure>
<h4 id="registry容器配置文件"><a href="#registry容器配置文件" class="headerlink" title="registry容器配置文件"></a>registry容器配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 启动registry容器需要用到</span></div><div class="line"><span class="comment"># cat registry-srv.yml</span></div><div class="line">version: 0.1</div><div class="line"><span class="built_in">log</span>:</div><div class="line">  fields:</div><div class="line">    service: registry</div><div class="line"></div><div class="line">storage:</div><div class="line">  delete:</div><div class="line">    enabled: <span class="literal">true</span></div><div class="line">  cache:</div><div class="line">    blobdescriptor: inmemory</div><div class="line">  filesystem:</div><div class="line">    rootdirectory: /var/lib/registry</div><div class="line"></div><div class="line">http:</div><div class="line">  addr: 0.0.0.0:5000   </div><div class="line">  headers:</div><div class="line">    X-Content-Type-Options: [nosniff]</div><div class="line"></div><div class="line">health:</div><div class="line">  storagedriver:</div><div class="line">    enabled: <span class="literal">true</span></div><div class="line">    interval: 10s</div><div class="line">    threshold: 3</div><div class="line"></div><div class="line">auth:</div><div class="line">  token:</div><div class="line">    <span class="comment"># external url to docker-web authentication endpoint</span></div><div class="line">    realm: http://registry-web:8080/api/auth</div><div class="line">    <span class="comment"># should be same as registry.name of registry-web</span></div><div class="line">    service: registry-srv:5000</div><div class="line">    <span class="comment"># should be same as registry.auth.issuer of registry-web</span></div><div class="line">    issuer: <span class="string">'my issuer'</span></div><div class="line">    <span class="comment"># path to auth certificate</span></div><div class="line">    rootcertbundle: /etc/docker/registry/auth.cert</div><div class="line"><span class="comment">#</span></div></pre></td></tr></table></figure>
<h4 id="registry-web容器配置文件"><a href="#registry-web容器配置文件" class="headerlink" title="registry-web容器配置文件"></a>registry-web容器配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 启动registry-web容器需要用到</span></div><div class="line"><span class="comment"># cat registry-web.yml </span></div><div class="line">registry:</div><div class="line">  <span class="comment"># Docker registry url</span></div><div class="line">  url: http://registry-srv:5000/v2</div><div class="line">  <span class="comment"># Docker registry fqdn</span></div><div class="line">  name: registry-srv:5000</div><div class="line">  <span class="comment"># To allow image delete, should be false</span></div><div class="line">  <span class="built_in">readonly</span>: <span class="literal">false</span></div><div class="line">  auth:</div><div class="line">    <span class="comment"># Enable authentication</span></div><div class="line">    enabled: <span class="literal">true</span></div><div class="line">    <span class="comment"># Token issuer</span></div><div class="line">    <span class="comment"># should equals to auth.token.issuer of docker registry</span></div><div class="line">    issuer: <span class="string">'my issuer'</span></div><div class="line">    <span class="comment"># Private key for token signing</span></div><div class="line">    <span class="comment"># certificate used on auth.token.rootcertbundle should signed by this key</span></div><div class="line">    key: /conf/auth.key</div><div class="line"><span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># tree docker-registry-web/</span></div><div class="line">docker-registry-web/</div><div class="line">└── conf</div><div class="line">    ├── auth.cert</div><div class="line">    ├── auth.key</div><div class="line">    ├── registry-srv.yml</div><div class="line">    └── registry-web.yml</div><div class="line"></div><div class="line">1 directory, 4 files</div></pre></td></tr></table></figure>
<h4 id="启动registry"><a href="#启动registry" class="headerlink" title="启动registry"></a>启动registry</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># /root/docker-registry-web/conf需要有上述四个文件(auth.cert,auth.key,registry-srv.yml,registry-web.yml)，文件内容见上面</span></div><div class="line"><span class="comment"># 如果配置文件改成了域名，在创建容器时CONTAINER NAME最好与配置文件一致</span></div><div class="line">docker run -v /root/docker-registry-web/conf/registry-srv.yml:/etc/docker/registry/config.yml:ro -v /root/docker-registry-web/conf/auth.cert:/etc/docker/registry/auth.cert:ro -v /data:/var/lib/registry/ -p 5000:5000 --restart=always --name registry-srv <span class="_">-d</span> registry:2.6.2</div></pre></td></tr></table></figure>
<h4 id="启动registry-web"><a href="#启动registry-web" class="headerlink" title="启动registry-web"></a>启动registry-web</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># /root/docker-registry-web/conf需要有上述四个文件(auth.cert,auth.key,registry-srv.yml,registry-web.yml)，文件内容见上面</span></div><div class="line"><span class="comment"># 如果配置文件改成了域名，在创建容器时CONTAINER NAME最好与配置文件一致</span></div><div class="line">docker run <span class="_">-d</span> -v /root/docker-registry-web/conf/registry-web.yml:/conf/config.yml:ro -v /root/docker-registry-web/conf/auth.key:/conf/auth.key -v /root/docker-registry-web/db:/data -it -p 8080:8080 --link registry-srv --restart=always --name registry-web hyper/docker-registry-web</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># docker images</span></div><div class="line">REPOSITORY                            TAG                 IMAGE ID            CREATED             SIZE</div><div class="line">docker.io/registry                    2.6.2               177391bcf802        2 weeks ago         33.26 MB</div><div class="line">docker.io/hyper/docker-registry-web   latest              0db5683824d8        14 months ago       598.6 MB</div><div class="line"><span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment"># docker ps -a</span></div><div class="line">CONTAINER ID        IMAGE                       COMMAND                  CREATED             STATUS              PORTS                    NAMES</div><div class="line">1b4c0efd8465        hyper/docker-registry-web   <span class="string">"start.sh"</span>               58 minutes ago      Up 58 minutes       0.0.0.0:8080-&gt;8080/tcp   registry-web</div><div class="line">2d475b4d0603        registry:2.6.2              <span class="string">"/entrypoint.sh /etc/"</span>   58 minutes ago      Up 17 minutes       0.0.0.0:5000-&gt;5000/tcp   registry-srv</div><div class="line"><span class="comment">#</span></div></pre></td></tr></table></figure>
<h4 id="hosts解析"><a href="#hosts解析" class="headerlink" title="hosts解析"></a>hosts解析</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># tail -2 /etc/hosts</span></div><div class="line">192.168.1.61 registry-srv</div><div class="line">192.168.1.61 registry-web</div></pre></td></tr></table></figure>
<h4 id="忽略认证"><a href="#忽略认证" class="headerlink" title="忽略认证"></a>忽略认证</h4><p>Question：如果报下面的错误<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># docker login http://registry-srv:5000</span></div><div class="line">Username (admin): admin</div><div class="line">Password: </div><div class="line">Error response from daemon: Get https://registry-srv:5000/v2/: http: server gave HTTP response to HTTPS client</div></pre></td></tr></table></figure></p>
<p>Answer：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># docker 1.12.6需要在这里修改</span></div><div class="line"><span class="comment"># grep -iv '^#' /etc/sysconfig/docker | grep -iv '^$'</span></div><div class="line">OPTIONS=<span class="string">'--selinux-enabled --log-driver=journald --signature-verification=false --insecure-registry registry-srv:5000'</span></div><div class="line"><span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$&#123;DOCKER_CERT_PATH&#125;</span>"</span> ]; <span class="keyword">then</span></div><div class="line">    DOCKER_CERT_PATH=/etc/docker</div><div class="line"><span class="keyword">fi</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#docker 17.12.0-ce-rc4需要这里修改</span></div><div class="line"><span class="comment"># cat /etc/docker/daemon.json </span></div><div class="line">&#123; <span class="string">"insecure-registries"</span>:[<span class="string">"registry-srv:5000"</span>] &#125;</div><div class="line"><span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># systemctl restart docker</span></div></pre></td></tr></table></figure>
<h4 id="上传镜像到docker-registry"><a href="#上传镜像到docker-registry" class="headerlink" title="上传镜像到docker registry"></a>上传镜像到docker registry</h4><p>Question：在<code>docker 17.12.0-ce-rc4</code>中登陆成功后，如果报下面的错误<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># docker push registry-srv:5000/mysql:5.6</span></div><div class="line">The push refers to a repository [registry-srv:5000/mysql]</div><div class="line"></div><div class="line">67ab9337620e: Preparing </div><div class="line">388e5e8563d4: Preparing </div><div class="line">000529f48f17: Preparing </div><div class="line">07d0b57bb93e: Preparing </div><div class="line">d59453e8d7bb: Waiting </div><div class="line">19aa284e9bf3: Waiting </div><div class="line">889744378e18: Waiting </div><div class="line">ae12d30e1dfc: Waiting </div><div class="line">4bcdffd70da2: Waiting </div><div class="line">unauthorized: authentication required</div><div class="line"><span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>Answer：需要登陆registry-web给当前登陆的用户授权<br><img src="https://note.youdao.com/yws/api/personal/file/31325BB5F8004B7EBA8475EEE9EB2D52?method=download&amp;shareKey=187c16347a2a2fc53c43bf618824e074" alt="Registry_Permissions"><br><img src="https://note.youdao.com/yws/api/personal/file/99A6312328FB498FA01065FC943CFED4?method=download&amp;shareKey=0a178de17ed865950e5f3aa12c5220a6" alt="Registry_Roles"><br>然后再登陆<code>docker login http://registry-srv:5000</code>即可成功上传  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># docker login registry-srv:5000</span></div><div class="line">Username (admin): admin</div><div class="line">Password: </div><div class="line">Login Succeeded</div><div class="line"><span class="comment"># docker tag docker.io/mysql:5.6 registry-srv:5000/mysql:5.6</span></div><div class="line"><span class="comment"># docker images</span></div><div class="line">REPOSITORY                TAG                 IMAGE ID            CREATED             SIZE</div><div class="line">registry-srv:5000/mysql   5.6                 1c7972822e0c        8 days ago          299 MB</div><div class="line">docker push registry-srv:5000/mysql:5.6</div><div class="line">The push refers to a repository [registry-srv:5000/mysql]</div><div class="line">67ab9337620e: Pushed </div><div class="line">388e5e8563d4: Pushed </div><div class="line">000529f48f17: Pushed </div><div class="line">07d0b57bb93e: Pushed </div><div class="line">324a3796c59a: Pushed </div><div class="line">d59453e8d7bb: Pushed </div><div class="line">19aa284e9bf3: Pushed </div><div class="line">889744378e18: Pushed </div><div class="line">ae12d30e1dfc: Pushed </div><div class="line">4bcdffd70da2: Pushed </div><div class="line">5.6: digest: sha256:92<span class="built_in">cd</span>157a4d73a00a56993bce76d467ae170a86b264d24536648834d7f7501cdd size: 2409</div><div class="line"><span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ls /data/</span></div><div class="line">docker</div><div class="line"><span class="comment"># du -sh /data/</span></div><div class="line">101M	/data/</div><div class="line"><span class="comment"># tree docker/</span></div><div class="line">docker/</div><div class="line">└── registry</div><div class="line">    └── v2</div><div class="line">        ├── blobs</div><div class="line">        │   └── sha256</div><div class="line">        │       ├── 1c</div><div class="line">        │       │   └── 1c7972822e0cfe7af284610af68fd23ab1c6e36566070199a2ecae0c540a6213</div><div class="line">        │       │       └── data</div><div class="line">        │       ├── 28</div><div class="line">        │       │   └── 28dd7bab809dc36871733509f298775d6e7e9a7b48411969fd40bbc5d42d4872</div><div class="line">        │       │       └── data</div><div class="line">        │       ├── 60</div><div class="line">        │       │   └── 60b597896d30e83b6451b5d287503c6ad5b966afcfe983beaac073<span class="built_in">cd</span>14d3327e</div><div class="line">        │       │       └── data</div><div class="line">        │       ├── 67</div><div class="line">        │       │   └── 67ee8c6f60b5ee191862ae0beee2e27<span class="built_in">fc</span>242c1548e724d42491aff9599783f14</div><div class="line">        │       │       └── data</div><div class="line">        │       ├── 74</div><div class="line">        │       │   └── 74616d0d8b72cce832e728b721a055ee94112f55d9152ea75c0c11df9255e5fe</div><div class="line">        │       │       └── data</div><div class="line">        │       ├── 78</div><div class="line">        │       │   └── 78032de49d65ab1151d278821068401fa7a8964c16b2f4441a3ef9ac8dd02229</div><div class="line">        │       │       └── data</div><div class="line">        │       ├── 83</div><div class="line">        │       │   └── 837546b20bc4af04c4<span class="built_in">cd</span>0b34ac6cb74418f0400fa80045d02d341aecbc70f928</div><div class="line">        │       │       └── data</div><div class="line">        │       ├── 8b</div><div class="line">        │       │   └── 8b95be8b8d363b4fd0d3de912d206a4a83f9f445e7a0761c61e4225b55aa3f6a</div><div class="line">        │       │       └── data</div><div class="line">        │       ├── 92</div><div class="line">        │       │   └── 92<span class="built_in">cd</span>157a4d73a00a56993bce76d467ae170a86b264d24536648834d7f7501cdd</div><div class="line">        │       │       └── data</div><div class="line">        │       ├── 9b</div><div class="line">        │       │   ├── 9b7ad7dfbf08cb21ae35a041aeceb634a80f6145d371fb793e18c9be75b491ce</div><div class="line">        │       │   │   └── data</div><div class="line">        │       │   └── 9b8316af6cc601a268bccfd58f93c2598e4a5f8a6b101cb9ffe365bcd467cb8e</div><div class="line">        │       │       └── data</div><div class="line">        │       └── f4</div><div class="line">        │           └── f49cf87b52c10aa83b4f4405800527a74400fb19ea1821d209293bc4d53966aa</div><div class="line">        │               └── data</div><div class="line">        └── repositories</div><div class="line">            └── mysql</div><div class="line">                ├── _layers</div><div class="line">                │   └── sha256</div><div class="line">                │       ├── 1c7972822e0cfe7af284610af68fd23ab1c6e36566070199a2ecae0c540a6213</div><div class="line">                │       │   └── link</div><div class="line">                │       ├── 28dd7bab809dc36871733509f298775d6e7e9a7b48411969fd40bbc5d42d4872</div><div class="line">                │       │   └── link</div><div class="line">                │       ├── 60b597896d30e83b6451b5d287503c6ad5b966afcfe983beaac073<span class="built_in">cd</span>14d3327e</div><div class="line">                │       │   └── link</div><div class="line">                │       ├── 67ee8c6f60b5ee191862ae0beee2e27<span class="built_in">fc</span>242c1548e724d42491aff9599783f14</div><div class="line">                │       │   └── link</div><div class="line">                │       ├── 74616d0d8b72cce832e728b721a055ee94112f55d9152ea75c0c11df9255e5fe</div><div class="line">                │       │   └── link</div><div class="line">                │       ├── 78032de49d65ab1151d278821068401fa7a8964c16b2f4441a3ef9ac8dd02229</div><div class="line">                │       │   └── link</div><div class="line">                │       ├── 837546b20bc4af04c4<span class="built_in">cd</span>0b34ac6cb74418f0400fa80045d02d341aecbc70f928</div><div class="line">                │       │   └── link</div><div class="line">                │       ├── 8b95be8b8d363b4fd0d3de912d206a4a83f9f445e7a0761c61e4225b55aa3f6a</div><div class="line">                │       │   └── link</div><div class="line">                │       ├── 9b7ad7dfbf08cb21ae35a041aeceb634a80f6145d371fb793e18c9be75b491ce</div><div class="line">                │       │   └── link</div><div class="line">                │       ├── 9b8316af6cc601a268bccfd58f93c2598e4a5f8a6b101cb9ffe365bcd467cb8e</div><div class="line">                │       │   └── link</div><div class="line">                │       └── f49cf87b52c10aa83b4f4405800527a74400fb19ea1821d209293bc4d53966aa</div><div class="line">                │           └── link</div><div class="line">                ├── _manifests</div><div class="line">                │   ├── revisions</div><div class="line">                │   │   └── sha256</div><div class="line">                │   │       └── 92<span class="built_in">cd</span>157a4d73a00a56993bce76d467ae170a86b264d24536648834d7f7501cdd</div><div class="line">                │   │           └── link</div><div class="line">                │   └── tags</div><div class="line">                │       └── 5.6</div><div class="line">                │           ├── current</div><div class="line">                │           │   └── link</div><div class="line">                │           └── index</div><div class="line">                │               └── sha256</div><div class="line">                │                   └── 92<span class="built_in">cd</span>157a4d73a00a56993bce76d467ae170a86b264d24536648834d7f7501cdd</div><div class="line">                │                       └── link</div><div class="line">                └── _uploads</div><div class="line"></div><div class="line">53 directories, 26 files</div><div class="line"><span class="comment">#</span></div></pre></td></tr></table></figure>
<h4 id="从docker-registry下载镜像"><a href="#从docker-registry下载镜像" class="headerlink" title="从docker registry下载镜像"></a>从docker registry下载镜像</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># docker pull registry-srv:5000/mysql:5.6</span></div><div class="line">Trying to pull repository registry-srv:5000/mysql ... </div><div class="line">Get http://registry-srv:5000/v2/mysql/manifests/5.6: unauthorized: authentication required</div><div class="line"><span class="comment"># docker login registry-srv:5000 -uadmin -padmin</span></div><div class="line">Login Succeeded</div><div class="line"><span class="comment"># docker pull registry-srv:5000/mysql:5.6</span></div><div class="line">Trying to pull repository registry-srv:5000/mysql ... </div><div class="line">5.6: Pulling from registry-srv:5000/mysql</div><div class="line">f49cf87b52c1: Pull complete </div><div class="line">78032de49d65: Pull complete </div><div class="line">837546b20bc4: Pull complete </div><div class="line">9b8316af6cc6: Pull complete </div><div class="line">28dd7bab809d: Pull complete </div><div class="line">8b95be8b8d36: Pull complete </div><div class="line">67ee8c6f60b5: Pull complete </div><div class="line">74616d0d8b72: Pull complete </div><div class="line">9b7ad7dfbf08: Pull complete </div><div class="line">60b597896d30: Pull complete </div><div class="line">Digest: sha256:92<span class="built_in">cd</span>157a4d73a00a56993bce76d467ae170a86b264d24536648834d7f7501cdd</div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># docker images</span></div><div class="line">REPOSITORY                TAG                 IMAGE ID            CREATED             SIZE</div><div class="line">registry-srv:5000/mysql                               5.6                 1c7972822e0c        8 days ago          299 MB</div></pre></td></tr></table></figure>
<h4 id="删除docker-registry仓库镜像"><a href="#删除docker-registry仓库镜像" class="headerlink" title="删除docker registry仓库镜像"></a>删除docker registry仓库镜像</h4><p>在2.4版本中对这一问题进行了解决，增加了一个垃圾回收命令，删除未被引用的层数据，操作如下：  </p>
<ul>
<li>在启动仓库时，需在配置文件中的storage配置中增加delete=true配置项，允许删除镜像  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#完整配置文件请参考 registry-srv.yml</span></div><div class="line">storage:</div><div class="line">  delete:</div><div class="line">    enabled: <span class="literal">true</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>先在registry-web上执行删除操作<br><img src="https://note.youdao.com/yws/api/personal/file/FB458A3AB2EA4EA5A58C3E0D76B959EF?method=download&amp;shareKey=b1cb0288408e3525dd20fc356e12d91a" alt="register_del"><br><img src="https://note.youdao.com/yws/api/personal/file/EC0B62B8C074467DB81C44B75AF8C940?method=download&amp;shareKey=5501ff8ed5e3e1139116a282c481178c" alt="register_del">  </p>
<p>这时数据并未完全删除，需要执行垃圾回收<br>命令：<code>registry garbage-collect config.yml</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 垃圾回收前</span></div><div class="line"><span class="comment"># du -sh *</span></div><div class="line">101M	docker</div><div class="line"><span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"># docker exec -it registry-srv registry garbage-collect /etc/docker/registry/config.yml</div><div class="line">mysql</div><div class="line"></div><div class="line"><span class="number">0</span> blobs marked, <span class="number">13</span> blobs eligible <span class="keyword">for</span> deletion</div><div class="line">blob eligible <span class="keyword">for</span> deletion: <span class="built_in">sha256</span>:<span class="number">9</span>b8316af6cc601a268bccfd58f93c2598e4a5f8a6b101cb9ffe365bcd467cb8e</div><div class="line">INFO[<span class="number">0000</span>] Deleting blo<span class="variable">b:</span> /docker/registry/v2/blobs/<span class="built_in">sha256</span>/<span class="number">9</span><span class="keyword">b</span>/<span class="number">9</span>b8316af6cc601a268bccfd58f93c2598e4a5f8a6b101cb9ffe365bcd467cb8e  <span class="keyword">go</span>.<span class="keyword">version</span>=go1.<span class="number">7.6</span> instance.id=<span class="number">1</span>cb0944e-c80c</div><div class="line">-<span class="number">4111</span>-<span class="number">9758</span>-df3ed7b72430blob eligible <span class="keyword">for</span> deletion: <span class="built_in">sha256</span>:<span class="number">67</span>ee8c6f60b5ee191862ae0beee2e27fc242c1548e724d42491aff9599783f14</div><div class="line">INFO[<span class="number">0000</span>] Deleting blo<span class="variable">b:</span> /docker/registry/v2/blobs/<span class="built_in">sha256</span>/<span class="number">67</span>/<span class="number">67</span>ee8c6f60b5ee191862ae0beee2e27fc242c1548e724d42491aff9599783f14  <span class="keyword">go</span>.<span class="keyword">version</span>=go1.<span class="number">7.6</span> instance.id=<span class="number">1</span>cb0944e-c80c</div><div class="line">-<span class="number">4111</span>-<span class="number">9758</span>-df3ed7b72430blob eligible <span class="keyword">for</span> deletion: <span class="built_in">sha256</span>:<span class="number">78032</span>de49d65ab1151d278821068401fa7a8964c16b2f4441a3ef9ac8dd02229</div><div class="line">INFO[<span class="number">0000</span>] Deleting blo<span class="variable">b:</span> /docker/registry/v2/blobs/<span class="built_in">sha256</span>/<span class="number">78</span>/<span class="number">78032</span>de49d65ab1151d278821068401fa7a8964c16b2f4441a3ef9ac8dd02229  <span class="keyword">go</span>.<span class="keyword">version</span>=go1.<span class="number">7.6</span> instance.id=<span class="number">1</span>cb0944e-c80c</div><div class="line">-<span class="number">4111</span>-<span class="number">9758</span>-df3ed7b72430blob eligible <span class="keyword">for</span> deletion: <span class="built_in">sha256</span>:<span class="number">60</span>b597896d30e83b6451b5d287503c6ad5b966afcfe983beaac073cd14d3327e</div><div class="line">INFO[<span class="number">0000</span>] Deleting blo<span class="variable">b:</span> /docker/registry/v2/blobs/<span class="built_in">sha256</span>/<span class="number">60</span>/<span class="number">60</span>b597896d30e83b6451b5d287503c6ad5b966afcfe983beaac073cd14d3327e  <span class="keyword">go</span>.<span class="keyword">version</span>=go1.<span class="number">7.6</span> instance.id=<span class="number">1</span>cb0944e-c80c</div><div class="line">-<span class="number">4111</span>-<span class="number">9758</span>-df3ed7b72430blob eligible <span class="keyword">for</span> deletion: <span class="built_in">sha256</span>:<span class="number">74616</span>d0d8b72cce832e728b721a055ee94112f55d9152ea75c0c11df9255e5fe</div><div class="line">INFO[<span class="number">0000</span>] Deleting blo<span class="variable">b:</span> /docker/registry/v2/blobs/<span class="built_in">sha256</span>/<span class="number">74</span>/<span class="number">74616</span>d0d8b72cce832e728b721a055ee94112f55d9152ea75c0c11df9255e5fe  <span class="keyword">go</span>.<span class="keyword">version</span>=go1.<span class="number">7.6</span> instance.id=<span class="number">1</span>cb0944e-c80c</div><div class="line">-<span class="number">4111</span>-<span class="number">9758</span>-df3ed7b72430blob eligible <span class="keyword">for</span> deletion: <span class="built_in">sha256</span>:<span class="number">837546</span>b20bc4af04c4cd0b34ac6cb74418f0400fa80045d02d341aecbc70f928</div><div class="line">INFO[<span class="number">0000</span>] Deleting blo<span class="variable">b:</span> /docker/registry/v2/blobs/<span class="built_in">sha256</span>/<span class="number">83</span>/<span class="number">837546</span>b20bc4af04c4cd0b34ac6cb74418f0400fa80045d02d341aecbc70f928  <span class="keyword">go</span>.<span class="keyword">version</span>=go1.<span class="number">7.6</span> instance.id=<span class="number">1</span>cb0944e-c80c</div><div class="line">-<span class="number">4111</span>-<span class="number">9758</span>-df3ed7b72430blob eligible <span class="keyword">for</span> deletion: <span class="built_in">sha256</span>:<span class="number">8</span>b95be8b8d363b4fd0d3de912d206a4a83f9f445e7a0761c61e4225b55aa3f6a</div><div class="line">INFO[<span class="number">0000</span>] Deleting blo<span class="variable">b:</span> /docker/registry/v2/blobs/<span class="built_in">sha256</span>/<span class="number">8</span><span class="keyword">b</span>/<span class="number">8</span>b95be8b8d363b4fd0d3de912d206a4a83f9f445e7a0761c61e4225b55aa3f6a  <span class="keyword">go</span>.<span class="keyword">version</span>=go1.<span class="number">7.6</span> instance.id=<span class="number">1</span>cb0944e-c80c</div><div class="line">-<span class="number">4111</span>-<span class="number">9758</span>-df3ed7b72430blob eligible <span class="keyword">for</span> deletion: <span class="built_in">sha256</span>:<span class="number">92</span>cd157a4d73a00a56993bce76d467ae170a86b264d24536648834d7f7501cdd</div><div class="line">INFO[<span class="number">0000</span>] Deleting blo<span class="variable">b:</span> /docker/registry/v2/blobs/<span class="built_in">sha256</span>/<span class="number">92</span>/<span class="number">92</span>cd157a4d73a00a56993bce76d467ae170a86b264d24536648834d7f7501cdd  <span class="keyword">go</span>.<span class="keyword">version</span>=go1.<span class="number">7.6</span> instance.id=<span class="number">1</span>cb0944e-c80c</div><div class="line">-<span class="number">4111</span>-<span class="number">9758</span>-df3ed7b72430blob eligible <span class="keyword">for</span> deletion: <span class="built_in">sha256</span>:<span class="number">9</span>b7ad7dfbf08cb21ae35a041aeceb634a80f6145d371fb793e18c9be75b491ce</div><div class="line">INFO[<span class="number">0000</span>] Deleting blo<span class="variable">b:</span> /docker/registry/v2/blobs/<span class="built_in">sha256</span>/<span class="number">9</span><span class="keyword">b</span>/<span class="number">9</span>b7ad7dfbf08cb21ae35a041aeceb634a80f6145d371fb793e18c9be75b491ce  <span class="keyword">go</span>.<span class="keyword">version</span>=go1.<span class="number">7.6</span> instance.id=<span class="number">1</span>cb0944e-c80c</div><div class="line">-<span class="number">4111</span>-<span class="number">9758</span>-df3ed7b72430blob eligible <span class="keyword">for</span> deletion: <span class="built_in">sha256</span>:<span class="number">1</span>c7972822e0cfe7af284610af68fd23ab1c6e36566070199a2ecae0c540a6213</div><div class="line">INFO[<span class="number">0000</span>] Deleting blo<span class="variable">b:</span> /docker/registry/v2/blobs/<span class="built_in">sha256</span>/<span class="number">1</span><span class="keyword">c</span>/<span class="number">1</span>c7972822e0cfe7af284610af68fd23ab1c6e36566070199a2ecae0c540a6213  <span class="keyword">go</span>.<span class="keyword">version</span>=go1.<span class="number">7.6</span> instance.id=<span class="number">1</span>cb0944e-c80c</div><div class="line">-<span class="number">4111</span>-<span class="number">9758</span>-df3ed7b72430blob eligible <span class="keyword">for</span> deletion: <span class="built_in">sha256</span>:<span class="number">28</span>dd7bab809dc36871733509f298775d6e7e9a7b48411969fd40bbc5d42d4872</div><div class="line">INFO[<span class="number">0000</span>] Deleting blo<span class="variable">b:</span> /docker/registry/v2/blobs/<span class="built_in">sha256</span>/<span class="number">28</span>/<span class="number">28</span>dd7bab809dc36871733509f298775d6e7e9a7b48411969fd40bbc5d42d4872  <span class="keyword">go</span>.<span class="keyword">version</span>=go1.<span class="number">7.6</span> instance.id=<span class="number">1</span>cb0944e-c80c</div><div class="line">-<span class="number">4111</span>-<span class="number">9758</span>-df3ed7b72430blob eligible <span class="keyword">for</span> deletion: <span class="built_in">sha256</span>:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4</div><div class="line">INFO[<span class="number">0000</span>] Deleting blo<span class="variable">b:</span> /docker/registry/v2/blobs/<span class="built_in">sha256</span>/a3/a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4  <span class="keyword">go</span>.<span class="keyword">version</span>=go1.<span class="number">7.6</span> instance.id=<span class="number">1</span>cb0944e-c80c</div><div class="line">-<span class="number">4111</span>-<span class="number">9758</span>-df3ed7b72430blob eligible <span class="keyword">for</span> deletion: <span class="built_in">sha256</span>:f49cf87b52c10aa83b4f4405800527a74400fb19ea1821d209293bc4d53966aa</div><div class="line">INFO[<span class="number">0000</span>] Deleting blo<span class="variable">b:</span> /docker/registry/v2/blobs/<span class="built_in">sha256</span>/f4/f49cf87b52c10aa83b4f4405800527a74400fb19ea1821d209293bc4d53966aa  <span class="keyword">go</span>.<span class="keyword">version</span>=go1.<span class="number">7.6</span> instance.id=<span class="number">1</span>cb0944e-c80c</div><div class="line">-<span class="number">4111</span>-<span class="number">9758</span>-df3ed7b72430</div><div class="line">#</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 垃圾回收后</span></div><div class="line"><span class="comment"># du -sh *</span></div><div class="line">204K	docker</div><div class="line"><span class="comment">#</span></div></pre></td></tr></table></figure>
<p>注：在执行垃圾回收后，需要重启registry-srv，否则当再次上传相同IMAGE时，将无法成功上传<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># docker restart registry-srv</span></div></pre></td></tr></table></figure></p>
<h4 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h4><p><img src="https://note.youdao.com/yws/api/personal/file/A798B6B8F24448C8BDDB28FC5613BFA7?method=download&amp;shareKey=b6384831be5d8a0bab732694c1fb4481" alt="register_login"><br><img src="https://note.youdao.com/yws/api/personal/file/9CBFFA18A90544D3A2E96A25B5C5FE2C?method=download&amp;shareKey=7d870422ba75dc1499af97e17cd7f464" alt="register_repositories"><br><img src="https://note.youdao.com/yws/api/personal/file/2FDDDEE2F7B14EAF92DFB78729596EB6?method=download&amp;shareKey=50afa53fa7c84b43e07dd132bb0f8d28" alt="register_tags"><br><img src="https://note.youdao.com/yws/api/personal/file/36A659C4EC7145C6800FCB6704BD2C55?method=download&amp;shareKey=bd67c52c0696a8f00c77a62b2eaed683" alt="register_image">  </p>
<p>参考：<br><a href="https://hub.docker.com/r/library/registry/" target="_blank" rel="external">https://hub.docker.com/r/library/registry/</a><br><a href="https://github.com/mkuchin/docker-registry-web" target="_blank" rel="external">https://github.com/mkuchin/docker-registry-web</a><br><a href="https://hub.docker.com/r/hyper/docker-registry-web/" target="_blank" rel="external">https://hub.docker.com/r/hyper/docker-registry-web/</a><br><a href="http://www.widuu.com/chinese_docker/index.html" target="_blank" rel="external">http://www.widuu.com/chinese_docker/index.html</a>  </p>
<p>附件：<br><a href="https://note.youdao.com/yws/api/personal/file/B44119A67B2644AEA0212B7DF58B88F8?method=download&amp;shareKey=5502a8f7d9e924c901d618ca7466ce83" target="_blank" rel="external">docker-registry-web.tar.gz</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/12/20/自建docker私有仓库-Registry/">http://www.yfshare.vip/2017/12/20/自建docker私有仓库-Registry/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[The Redmine_svn of docker]]></title>
      <url>http://www.yfshare.vip/2017/12/14/The-Redmine-svn-of-docker/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>The redmine + svn + apache2 of Docker 应用基于Debian系统部署，经改造后只需要 PULL+Compose后即可正常工作<br><a id="more"></a></p>
<h2 id="Supported-tags-and-respective-Dockerfile-links"><a href="#Supported-tags-and-respective-Dockerfile-links" class="headerlink" title="Supported tags and respective Dockerfile links"></a>Supported tags and respective Dockerfile links</h2><ul>
<li><code>latest</code>(<a href="https://github.com/yfshare/Docker/blob/master/Redmine_svn/Dockerfile" target="_blank" rel="external">latest/Dockerfile</a>)</li>
<li><code>3.4</code>(<a href="https://github.com/yfshare/Docker/blob/master/Redmine_svn/Dockerfile_3.4" target="_blank" rel="external">3.4/Dockerfile</a>)</li>
</ul>
<p>镜像地址：<a href="https://hub.docker.com/r/yfshare/redmine_svn/" target="_blank" rel="external">https://hub.docker.com/r/yfshare/redmine_svn/</a>  </p>
<h3 id="The-redmine-3-4-svn-apache2-of-Docker"><a href="#The-redmine-3-4-svn-apache2-of-Docker" class="headerlink" title="The redmine 3.4+svn+apache2 of Docker"></a>The redmine 3.4+svn+apache2 of Docker</h3><p>基于Docker hub里redmine 3.4（docker pull redmine:3.4）（<a href="https://hub.docker.com/_/redmine/" target="_blank" rel="external">https://hub.docker.com/_/redmine/</a> ）改造而成。</p>
<h4 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h4><p>使用到的环境变量有：  </p>
<ul>
<li><code>MYSQL_ROOT_PASSWORD</code>：MYSQL的ROOT密码，需要和REDMINE_DB_PASSWORD变量值一致</li>
<li><code>MYSQL_DATABASE</code>：MYSQL上创建存储redmine的库名</li>
<li><code>SVN_ROOT</code>：存储SVN REPO的父目录</li>
<li><code>SVN_DIR</code>：SVN REPO项目目录，一般放在变量SVN_ROOT下</li>
<li><code>REDMINE_DB_MYSQL</code>：存储REDMINE的MYSQL DOCKER容器名，建议不要修改；如果修改它同时也需要修改docker-compose</li>
<li><code>REDMINE_DB_PASSWORD</code>：REDMINE连接MYSQL Docker的密码，REDMINE_DB_PASSWORD需要和MYSQL_ROOT_PASSWORD密码一致</li>
<li><code>REDMINE_DB_ENCODING</code>：新建MYSQL库REDMINE的字符集</li>
<li><code>REDMINE_MAIL_ADDRESS</code>：发送REDMINE的邮件地址（configuration.yml）</li>
<li><code>REDMINE_MAIL_DOMAIN</code>：发送REDMINE的邮件域名（configuration.yml）</li>
<li><code>REDMINE_MAIL_USER</code>：发送REDMINE的邮件用户名（configuration.yml）</li>
<li><code>REDMINE_MAIL_PASSWD</code>：发送REDMINE的邮件密码（configuration.yml）</li>
<li>以上变量是在Dockerfile自定义的，如需要其他变量，请参考（<a href="https://hub.docker.com/_/redmine/" target="_blank" rel="external">https://hub.docker.com/_/redmine/</a> ） ，因调用的redmine:3.4，因此也支持它的变量</li>
</ul>
<h4 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cat Dockerfile</span></div><div class="line">FROM docker.io/redmine:3.4</div><div class="line">RUN apt-get update \</div><div class="line">    &amp;&amp; apt-get install -y subversion subversion-tools apache2 libapache2-svn apache2-utils vim \</div><div class="line">    &amp;&amp; useradd apache</div><div class="line"></div><div class="line">RUN <span class="built_in">echo</span> <span class="string">''</span> &gt;/tmp/main</div><div class="line">COPY configure /</div><div class="line"></div><div class="line">VOLUME /usr/src/redmine/files</div><div class="line"></div><div class="line">RUN <span class="built_in">echo</span> <span class="string">"[ ! -d \$&#123;SVN_DIR&#125; ] &amp;&amp; svnadmin create \$&#123;SVN_DIR&#125;"</span> &gt;&gt;/tmp/redmine_svn.sh \</div><div class="line">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"[ -d /Authconf ] &amp;&amp; mv /Authconf \$&#123;SVN_ROOT&#125;/ &amp;&amp; sed -i \"s#^password-db \= passwd#password-db \= \$&#123;SVN_ROOT&#125;\/Authconf\/passwd#g\" \$&#123;SVN_ROOT&#125;/Authconf/svnserve.conf &amp;&amp; sed -i \"s#^authz-db \= authz#authz-db \= \$&#123;SVN_ROOT&#125;\/Authconf\/authz#g\" \$&#123;SVN_ROOT&#125;/Authconf/svnserve.conf &amp;&amp; \mv \$&#123;SVN_ROOT&#125;/Authconf/svnserve.conf \$&#123;SVN_DIR&#125;/conf/"</span> &gt;&gt; /tmp/redmine_svn.sh \</div><div class="line">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"[ -f /dav_svn.conf ] &amp;&amp; mv /dav_svn.conf /etc/apache2/mods-enabled/ &amp;&amp; sed -i \"s#SVNPath SVN_DIR#SVNPath \$&#123;SVN_DIR&#125;#g\" /etc/apache2/mods-enabled/dav_svn.conf &amp;&amp; sed -i \"s#Location \/svn#Location \/\`echo \$&#123;SVN_DIR&#125; | awk -F '/' '&#123;print \$NF&#125;'\`#g\" /etc/apache2/mods-enabled/dav_svn.conf &amp;&amp; sed -i \"/Include the virtual host configurations/aServerName localhost\:80\" /etc/apache2/apache2.conf"</span> &gt;&gt; /tmp/redmine_svn.sh \</div><div class="line">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"[ -f /svnpass ] &amp;&amp;  mv /svnpass /etc/apache2/.svnpass"</span> &gt;&gt; /tmp/redmine_svn.sh \</div><div class="line">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"[ -f /dav_svn.authz ]&amp;&amp; mv /dav_svn.authz /etc/apache2/ &amp;&amp; sed -i \"s#SVN_DIR#\`echo \$&#123;SVN_DIR&#125; | awk -F '/' '&#123;print \$NF&#125;'\`#g\" /etc/apache2/dav_svn.authz"</span> &gt;&gt; /tmp/redmine_svn.sh \</div><div class="line">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"[ -f /configuration.yml ] &amp;&amp; \mv /configuration.yml /usr/src/redmine/config &amp;&amp; sed -i \"s#domain\: 'DOMAIN'#domain\: '\$&#123;REDMINE_MAIL_DOMAIN&#125;'#g\" /usr/src/redmine/config/configuration.yml &amp;&amp; sed -i \"s#address\: \\\"MAIL_ADDRESS\\\"#address\: \\\"\$&#123;REDMINE_MAIL_ADDRESS&#125;\\\"#g\" /usr/src/redmine/config/configuration.yml &amp;&amp; sed -i \"s#user_name\: 'MAILADDR'#user_name\: '\$&#123;REDMINE_MAIL_USER&#125;'#g\" /usr/src/redmine/config/configuration.yml &amp;&amp; sed -i \"s#password\: 'PASSWORD'#password\: '\$&#123;REDMINE_MAIL_PASSWD&#125;'#g\" /usr/src/redmine/config/configuration.yml"</span> &gt;&gt; /tmp/redmine_svn.sh \</div><div class="line">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"chown apache:apache \$&#123;SVN_ROOT&#125; -R &amp;&amp; chown apache:apache /etc/apache2 -R"</span> &gt;&gt; /tmp/redmine_svn.sh \</div><div class="line">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"/etc/init.d/apache2 start &amp;"</span> &gt;&gt; /tmp/redmine_svn.sh \</div><div class="line">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"svnserve -d -r \$&#123;SVN_ROOT&#125; --log-file \$&#123;SVN_ROOT&#125;/svn.log &amp;"</span> &gt;&gt;/tmp/redmine_svn.sh \</div><div class="line">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"sleep 5 &amp;&amp; /docker-entrypoint.sh rails server -b 0.0.0.0 &amp;"</span> &gt;&gt;/tmp/redmine_svn.sh \</div><div class="line">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"tail -f /tmp/main"</span> &gt;&gt;/tmp/redmine_svn.sh \</div><div class="line">    &amp;&amp; chmod +x /tmp/redmine_svn.sh</div><div class="line"></div><div class="line">EXPOSE 3000 3690 80</div><div class="line"></div><div class="line">ENTRYPOINT [<span class="string">"/bin/sh"</span>,<span class="string">"/tmp/redmine_svn.sh"</span>]</div><div class="line"><span class="comment">#</span></div></pre></td></tr></table></figure>
<h4 id="Docker-Compose"><a href="#Docker-Compose" class="headerlink" title="Docker Compose"></a>Docker Compose</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">version: <span class="string">'2'</span></div><div class="line">services:</div><div class="line">  db:</div><div class="line">    image: mysql:5.7</div><div class="line">    container_name: mysql</div><div class="line">    environment:</div><div class="line">      MYSQL_ROOT_PASSWORD: <span class="string">'example12'</span></div><div class="line">      MYSQL_DATABASE: redmine</div><div class="line">    ports:</div><div class="line">      - 3306:3306</div><div class="line">    volumes:</div><div class="line">      - /data/docker_mount/mysql:/var/lib/mysql</div><div class="line">    restart: always</div><div class="line"></div><div class="line">  redmine_svn:</div><div class="line">    image: yfshare/redmine_svn:3.4</div><div class="line">    container_name: redmine_svn</div><div class="line">    ports:</div><div class="line">      - 3000:3000</div><div class="line">      - 3690:3690</div><div class="line">      - 80:80</div><div class="line">    links:</div><div class="line">      - db</div><div class="line">    environment:</div><div class="line">      SVN_ROOT: <span class="string">'/usr/src/SvnRepos'</span></div><div class="line">      SVN_DIR: <span class="string">'/usr/src/SvnRepos/Soros'</span></div><div class="line">      REDMINE_DB_MYSQL: db</div><div class="line">      REDMINE_DB_PASSWORD: <span class="string">'example12'</span></div><div class="line">      REDMINE_DB_ENCODING: <span class="string">'utf8'</span></div><div class="line">      REDMINE_MAIL_ADDRESS: <span class="string">'smtp.exmail.qq.com'</span></div><div class="line">      REDMINE_MAIL_DOMAIN: <span class="string">'example.com'</span></div><div class="line">      REDMINE_MAIL_USER: <span class="string">'username'</span></div><div class="line">      REDMINE_MAIL_PASSWD: <span class="string">'password'</span></div><div class="line">    volumes:</div><div class="line">      - /data/docker_mount/redmine/files:/usr/src/redmine/files</div><div class="line">      - /data/docker_mount/SvnRepos:/usr/src/SvnRepos</div><div class="line">    restart: always</div></pre></td></tr></table></figure>
<h4 id="部署Docker"><a href="#部署Docker" class="headerlink" title="部署Docker"></a>部署Docker</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">docker pull yfshare/redmine_svn</div><div class="line">docker-compose <span class="_">-f</span> docker-redmine_svn_mysql.yml up <span class="_">-d</span></div></pre></td></tr></table></figure>
<h4 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h4><ul>
<li><p>在redmine载入默认配置时，请选择“English“，而不是”简体中文“ 否则报下面错误  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">无法载入默认设置：Mysql2::Error: Incorrect string value: <span class="string">'\xE7\xAE\xA1\xE7\x90\x86...'</span> <span class="keyword">for</span> column <span class="string">'name'</span> at row 1: INSERT INTO `roles` (`name`, `issues_visibility`, `position`) VALUES (<span class="string">'管理人员'</span>, <span class="string">'all'</span>, 1)</div></pre></td></tr></table></figure>
</li>
<li><p>redmine默认用户名密码为：<code>admin</code> / <code>admin</code></p>
</li>
<li>TortoiseSVN访问SVN默认用户名密码为：<code>svnadmin</code> / <code>administrator#!001</code></li>
<li>http访问SVN默认用户名密码为：<code>svnadmin</code> / <code>administrator#!001</code></li>
</ul>
<h3 id="The-redmine-latest-svn-apache2-of-Docker"><a href="#The-redmine-latest-svn-apache2-of-Docker" class="headerlink" title="The redmine latest+svn+apache2 of Docker"></a>The redmine latest+svn+apache2 of Docker</h3><h4 id="不同点"><a href="#不同点" class="headerlink" title="不同点"></a>不同点</h4><ul>
<li>其他与The redmine 3.4+svn+apache2 of Docker相同，不同的是在build时取消了FROM docker.io/redmine版本号，此时会拉取最新的版本，同时docker-compose也要去掉版本号即可</li>
</ul>
<h4 id="Docker-Compose-1"><a href="#Docker-Compose-1" class="headerlink" title="Docker Compose"></a>Docker Compose</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">version: <span class="string">'2'</span></div><div class="line">services:</div><div class="line">  db:</div><div class="line">    image: mysql</div><div class="line">    container_name: mysql</div><div class="line">    environment:</div><div class="line">      MYSQL_ROOT_PASSWORD: <span class="string">'example12'</span></div><div class="line">      MYSQL_DATABASE: redmine</div><div class="line">    ports:</div><div class="line">      - 3306:3306</div><div class="line">    volumes:</div><div class="line">      - /data/docker_mount/mysql:/var/lib/mysql</div><div class="line">    restart: always</div><div class="line"></div><div class="line">  redmine_svn:</div><div class="line">    image: yfshare/redmine_svn</div><div class="line">    container_name: redmine_svn</div><div class="line">    ports:</div><div class="line">      - 3000:3000</div><div class="line">      - 3690:3690</div><div class="line">      - 80:80</div><div class="line">    links:</div><div class="line">      - db</div><div class="line">    environment:</div><div class="line">      SVN_ROOT: <span class="string">'/usr/src/SvnRepos'</span></div><div class="line">      SVN_DIR: <span class="string">'/usr/src/SvnRepos/Soros'</span></div><div class="line">      REDMINE_DB_MYSQL: db</div><div class="line">      REDMINE_DB_PASSWORD: <span class="string">'example12'</span></div><div class="line">      REDMINE_DB_ENCODING: <span class="string">'utf8'</span></div><div class="line">      REDMINE_MAIL_ADDRESS: <span class="string">'smtp.exmail.qq.com'</span></div><div class="line">      REDMINE_MAIL_DOMAIN: <span class="string">'example.com'</span></div><div class="line">      REDMINE_MAIL_USER: <span class="string">'username'</span></div><div class="line">      REDMINE_MAIL_PASSWD: <span class="string">'password'</span></div><div class="line">    volumes:</div><div class="line">      - /data/docker_mount/redmine/files:/usr/src/redmine/files</div><div class="line">      - /data/docker_mount/SvnRepos:/usr/src/SvnRepos</div><div class="line">    restart: always</div></pre></td></tr></table></figure>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#编译Dockerfile生成Docker images</span></div><div class="line">docker build -t yfshare/redmine_svn <span class="_">-f</span> Dockerfile .</div><div class="line"></div><div class="line"><span class="comment">#拉取镜像</span></div><div class="line">docker pull yfshare/redmine_svn</div><div class="line"></div><div class="line"><span class="comment">#使用docker-compose 生成docker容器</span></div><div class="line">docker-compose <span class="_">-f</span> docker-redmine_svn_mysql.yml up <span class="_">-d</span></div></pre></td></tr></table></figure>
<p>然后</p>
<ul>
<li>通过 <code>http://localhost:3000</code>访问Redmine</li>
<li><code>http://localhost/SvnRepos</code>通过WEB界面访问SVN</li>
<li>通过 TortoiseSVN <code>svn://localhost:3690/SvnRepos</code> 访问SVN</li>
<li>通过<code>3306</code>端口访问mysql  </li>
</ul>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/12/14/The-Redmine-svn-of-docker/">http://www.yfshare.vip/2017/12/14/The-Redmine-svn-of-docker/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[关于kernel: nf_conntrack: table full, dropping packet问题]]></title>
      <url>http://www.yfshare.vip/2017/12/05/%E5%85%B3%E4%BA%8Ekernel-nf-conntrack-table-full-dropping-packet%E9%97%AE%E9%A2%98/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p><code>/var/log/messages</code>报错信息：<code>kernel: nf_conntrack: table full, dropping packet</code><br><a id="more"></a><br>问题背景：公司线上活动（可以理解为秒杀）瞬时流量比平时高好几倍，目前最高瞬时流量为25W/秒(requests)，最低时瞬时流量为6W/秒(requests)<br>而<code>/var/log/messages</code>日志一直报上述错误，直到活动结束  </p>
<p>当时，深刻了解到iptables的这个报错，会造成拒绝服务的问题。查资料后，需要关闭iptables，但服务器在阿里云VPC网络内，使用的是阿里云的安全组策略，故iptables没有打开。后排查，虽iptables和firewalld没开，但是Centos7 还是加载了这个<code>nf_conntrack</code>模块，而导致出现了上面这个问题。  </p>
<p>网上说有三种方法，分别为：  </p>
<ul>
<li>修改参数法</li>
<li>使用RAW表，跳过记录法</li>
<li>移除模块法</li>
</ul>
<p>因服务器没有使用iptables和firewalld，故采用的是<code>移除模块法</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># /sbin/lsmod | egrep 'ip_tables|conntrack'</span></div><div class="line">nf_conntrack_ipv4      19108  2 </div><div class="line">nf_defrag_ipv4         12729  1 nf_conntrack_ipv4</div><div class="line">xt_conntrack           12760  1 </div><div class="line">nf_conntrack          111302  5 nf_nat,nf_nat_ipv4,xt_conntrack,nf_nat_masquerade_ipv4,nf_conntrack_ipv4</div><div class="line">ip_tables              27115  2 iptable_filter,iptable_nat</div><div class="line"><span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p><code>state</code>模块和<code>nf_conntrack</code>之间是有依赖关系，想要卸载<code>nf_conntrack</code>模块的话，必须也要把<code>state</code>模块移除，不然，其会自动启用nf_conntrack模块。  </p>
<p>卸载模块前需要先关闭iptables和firewalld，如果发现firewalld或iptables没有启用，但是卸载模块时，还是提示模块正在使用，则把iptables或firewalld启动后再关闭，再尝试卸载模块。  </p>
<p>操作方法如下：  </p>
<ul>
<li>先将/etc/sysconfig/iptables 中包含state的语句移除，并restart iptables</li>
<li>执行语句<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#这里是参考文档作者的</span></div><div class="line">modprobe -r xt_NOTRACK nf_conntrack_netbios_ns nf_conntrack_ipv4 xt_state</div><div class="line">modprobe -r nf_conntrack</div><div class="line"></div><div class="line"><span class="comment">#这里是我实际卸载的模块</span></div><div class="line">modprobe -r nf_conntrack_netbios_ns xt_state</div><div class="line">modprobe -r nf_conntrack</div></pre></td></tr></table></figure>
</li>
</ul>
<p>执行完查看/proc/net/ 下面如果没用了 nf_conntrack ，就证明模块移除成功了  </p>
<p>总结（以下摘录原文作者）：<br>以上三种方法种，如果像<code>web这样的操作访问量并发不大</code>的情况下，建议通过第一种方法实现。因为nf_conntrack模块的作用不仅仅只用于记录状态，iptables还可以通过对该模块的使有达到动态过滤的作用。如我在用ab动测试的一台服务器上进行并发模拟时，在/var/log/message里发现如下的日志<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Apr 22 15:21:46 localhost kernel: possible SYN flooding on port 80. Sending cookies.</div><div class="line">Apr 22 15:22:46 localhost kernel: possible SYN flooding on port 80. Sending cookies.</div></pre></td></tr></table></figure></p>
<p>而此时iptables会智能的将发动SYN flood攻击的IP暂时拒绝掉<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ab -c 500 -n 5000 "http://192.168.10.177/"</span></div><div class="line">This is ApacheBench, Version 2.0.40-dev &lt;<span class="variable">$Revision</span>: 1.146 $&gt; apache-2.0</div><div class="line">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</div><div class="line">Copyright 2006 The Apache Software Foundation, http://www.apache.org/</div><div class="line">Benchmarking 192.168.10.177 (be patient)</div><div class="line">apr_socket_recv: Connection reset by peer (104)</div><div class="line">Total of 68 requests completed</div></pre></td></tr></table></figure></p>
<p>如上所以，我用ab操作时，其就会收到apr_socket_recv 的错误提示 。我在网上查询到其具体实现的原理如下：  </p>
<ul>
<li><p>传统的防火墙只能进行静态过滤，而 iptables 除了这个基本的功能之外还可以进行动态过滤，即可以对连接状态进行跟踪，通常称为 conntrack 。 但这不意味着它只能对 TCP 这样的面向连接的协议有效，它还可以对 UDP， ICMP 这种无连接的协议进行跟踪。  </p>
</li>
<li><p>iptables 中的连接跟踪是通过 state 模块来实现的，是在PREROUTING 链中完成的，除了本地主机产生的数据包，它们是在 OUTPUT 链中完成。 它把“连接”划分为四种状态：NEW， ESTABLISHED， RELATED 和 INVALID。连接跟踪当前的所有连接状态可以通过 /proc/net/nf_conntrack 来查看（注意，在一些稍微旧的 Linux 系统上是 /proc/net/ip_conntrack）  </p>
</li>
<li>当 conntrack 第一次看到相关的数据包时，就会把状态标记为 NEW ，比如 TCP 协议中收到第一个 SYN 数据包。当连接的双方都有数据包收发并且还将继续匹配到这些数据包时，连接状态就会变为 ESTABLISHED 。而 RELATED 状态是指一个新的连接，但这个连接和某个已知的连接有关系，比如 FTP 协议中的数据传输连接。INVALID 状态是说数据包和已知的任何连接都不匹配</li>
</ul>
<p>当然，仅仅利用iptables conntrack自动实现syn flood 等DDOS攻击时很弱的。而现成的动态过滤和DDOS防护的方法是很多的。比如netstat脚本实现，iptalbes限制每秒进行连接数，nginx/apache的连接数限制模块及fail2ban日志分析法………… ，所以在具有以上防护的情况下，非常推荐将web 、squid/varnish等应用所在的服务器配置为RAW方式 。我在现网一台150M/S 的cache server上将80和3128两个端口全部NOTRACK之后，conntrack hash表由瞬满直线下降到只有几百条。<br>最后，最不推荐使用的第三种方法，因为第三种方法会将state模块也一块儿移除掉。  </p>
<p>参考：<br><a href="http://www.361way.com/ip_conntrack-tablefull/1717.html" target="_blank" rel="external">http://www.361way.com/ip_conntrack-tablefull/1717.html</a><br><a href="http://www.361way.com/%E5%86%8D%E7%9C%8Bnf_conntrack-table-full%E9%97%AE%E9%A2%98/2404.html" target="_blank" rel="external">http://www.361way.com/%E5%86%8D%E7%9C%8Bnf_conntrack-table-full%E9%97%AE%E9%A2%98/2404.html</a><br><a href="http://jaseywang.me/2012/08/16/%E8%A7%A3%E5%86%B3-nf_conntrack-table-full-dropping-packet-%E7%9A%84%E5%87%A0%E7%A7%8D%E6%80%9D%E8%B7%AF/" target="_blank" rel="external">http://jaseywang.me/2012/08/16/%E8%A7%A3%E5%86%B3-nf_conntrack-table-full-dropping-packet-%E7%9A%84%E5%87%A0%E7%A7%8D%E6%80%9D%E8%B7%AF/</a><br><a href="https://wiki.khnet.info/index.php/Conntrack_tuning" target="_blank" rel="external">https://wiki.khnet.info/index.php/Conntrack_tuning</a><br><a href="http://blog.zol.com.cn/2608/article_2607945.html" target="_blank" rel="external">http://blog.zol.com.cn/2608/article_2607945.html</a><br><a href="http://blog.csdn.net/dog250/article/details/7262619" target="_blank" rel="external">http://blog.csdn.net/dog250/article/details/7262619</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/12/05/关于kernel-nf-conntrack-table-full-dropping-packet问题/">http://www.yfshare.vip/2017/12/05/关于kernel-nf-conntrack-table-full-dropping-packet问题/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[ElasticSearch集群(基础)]]></title>
      <url>http://www.yfshare.vip/2017/12/04/ElasticSearch%E9%9B%86%E7%BE%A4-%E5%9F%BA%E7%A1%80/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>这里分享的是ELK集群基础安装文档，<a href="http://www.yfshare.vip/2017/11/22/ELK%E5%AE%89%E8%A3%85-%E5%9F%BA%E7%A1%80/">这里是 ELK安装基础</a><br><a id="more"></a><br>环境：Centos 6.6<br>　　　ElasticSearch 5.1.1<br>　　　Logstash 5.1.1<br>　　　Kibana 5.1.1  </p>
<h4 id="安装集群管理软件"><a href="#安装集群管理软件" class="headerlink" title="安装集群管理软件"></a>安装集群管理软件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#安装ElasticSearch</span></div><div class="line">[root@ELK ~]<span class="comment"># yum -y install elasticsearch-5.1.1.rpm</span></div><div class="line"></div><div class="line"><span class="comment">#ELK node1配置</span></div><div class="line">[root@ELK ~]<span class="comment"># mkdir /etc/elasticsearch/data -p</span></div><div class="line">[root@ELK ~]<span class="comment"># id elasticsearch</span></div><div class="line">uid=498(elasticsearch) gid=499(elasticsearch) groups=499(elasticsearch)</div><div class="line">[root@ELK ~]<span class="comment"># chgrp elasticsearch /etc/elasticsearch/data/ -R</span></div><div class="line">[root@ELK ~]<span class="comment"># chmod 775 /etc/elasticsearch/data/ -R</span></div><div class="line">[root@ELK ~]<span class="comment"># java -version</span></div><div class="line">java version <span class="string">"1.8.0_112"</span></div><div class="line">Java(TM) SE Runtime Environment (build 1.8.0_112-b15)</div><div class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.112-b15, mixed mode)</div><div class="line">[root@ELK ~]<span class="comment"># ln -s /usr/local/jdk1.8.0_112/bin/java /usr/bin/</span></div><div class="line"></div><div class="line">[root@ELK ~]<span class="comment"># grep -v ^# /etc/elasticsearch/elasticsearch.yml | grep -v ^$</span></div><div class="line">cluster.name: <span class="string">"ES-cluster"</span></div><div class="line">node.name: <span class="string">"es-node01"</span></div><div class="line">node.master: <span class="literal">true</span></div><div class="line">node.data: <span class="literal">true</span></div><div class="line">http.enabled: <span class="literal">true</span></div><div class="line">path.data: /etc/elasticsearch/data</div><div class="line">path.logs: /var/<span class="built_in">log</span>/elasticsearch</div><div class="line">network.host: 0.0.0.0</div><div class="line">http.port: 9200</div><div class="line">http.cors.enabled: <span class="literal">true</span></div><div class="line">http.cors.allow-origin: <span class="string">"*"</span></div><div class="line">discovery.zen.ping.unicast.hosts: [<span class="string">"192.168.31.100"</span>, <span class="string">"192.168.31.110"</span>]</div><div class="line">discovery.zen.minimum_master_nodes: 1</div><div class="line"><span class="comment">#discovery.zen.minimum_master_nodes（默认是1）：这个参数控制的是，一个节点需要看到的具有master节点资格的最小数量，然后才能在集群中做操作。官方的推荐值是(N/2)+1，其中N是具有master资格的节点的数量（我们的情况是3，因此这个参数设置为2，但对于只有2个节点的情况，设置为2就有些问题了，一个节点DOWN掉后，你肯定连不上2台服务器了，这点需要注意）</span></div><div class="line">gateway.recover_after_nodes: 2</div><div class="line">[root@ELK ~]<span class="comment">#</span></div><div class="line">[root@ELK ~]<span class="comment"># /etc/init.d/elasticsearch start</span></div><div class="line">[root@ELK ~]<span class="comment"># netstat -tunlp | grep 9200</span></div><div class="line">tcp        0      0 :::9200                     :::*                        LISTEN      33156/java          </div><div class="line">[root@ELK ~]<span class="comment"># netstat -tunlp | grep 9300</span></div><div class="line">tcp        0      0 :::9300                     :::*                        LISTEN      33156/java          </div><div class="line">[root@ELK ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#ELK node2配置</span></div><div class="line"><span class="comment">#node2配置和node1配置相同(略)</span></div></pre></td></tr></table></figure>
<h4 id="测试集群状态"><a href="#测试集群状态" class="headerlink" title="测试集群状态"></a>测试集群状态</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">[root@ELK ~]<span class="comment"># curl localhost:9200/_cat/nodes?v     #获取集群中节点列表</span></div><div class="line">ip             heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name</div><div class="line">192.168.31.100            4          81  99    4.32    3.28     3.46 mdi       -      es-node01</div><div class="line">192.168.31.110            3          94   5    0.07    0.03     0.01 mdi       *      es-node02</div><div class="line">[root@ELK ~]<span class="comment"># </span></div><div class="line">[root@ELK ~]<span class="comment"># curl localhost:9200/_cat/health?v    #集群健康检查</span></div><div class="line">epoch      timestamp cluster    status node.total node.data shards pri relo init unassign pending_tasks max_task_wait_time active_shards_percent</div><div class="line">1482982586 11:36:26  ES-cluster green           2         2     22  11    0    0        0             0                  -                100.0%</div><div class="line">[root@ELK ~]<span class="comment">#</span></div><div class="line">[root@ELK ~]<span class="comment"># curl 'localhost:9200/_cat/indices?v'  #获取ElasticSearch索引</span></div><div class="line">health status index                       uuid                   pri rep docs.count docs.deleted store.size pri.store.size</div><div class="line">green  open   logstash-message-2016.12.29 qkvr3jmWQei1oBhEy9VnCA   5   1         28            0    376.3kb        188.1kb</div><div class="line">green  open   logstash-nginx-2016.12.29   B9p9qwjsTlaE4<span class="built_in">fc</span>ZcIgJag   5   1          5            0      104kb           52kb</div><div class="line">green  open   .kibana                     bNLdONDMRdWK2-HdYkUuAA   1   1          3            0     34.1kb           17kb</div><div class="line">[root@ELK ~]<span class="comment">#</span></div><div class="line"></div><div class="line">//注：当ElasticSearch配置完成后，node2会复制node1的索引</div><div class="line">[root@ELK2 ~]<span class="comment"># curl 'localhost:9200/_cat/indices?v'</span></div><div class="line">health status index                       uuid                   pri rep docs.count docs.deleted store.size pri.store.size</div><div class="line">green  open   logstash-message-2016.12.29 qkvr3jmWQei1oBhEy9VnCA   5   1         28            0    376.3kb        188.1kb</div><div class="line">green  open   .kibana                     bNLdONDMRdWK2-HdYkUuAA   1   1          3            0     34.1kb           17kb</div><div class="line">green  open   logstash-nginx-2016.12.29   B9p9qwjsTlaE4<span class="built_in">fc</span>ZcIgJag   5   1          5            0      104kb           52kb</div><div class="line">[root@ELK2 ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#ElasticSearch集群日志文件位置：</span></div><div class="line">[root@ELK ~]<span class="comment"># ls /var/log/elasticsearch/</span></div><div class="line">ES-cluster_deprecation.log             ES-cluster_index_search_slowlog.log</div><div class="line">ES-cluster_index_indexing_slowlog.log  ES-cluster.log</div><div class="line">[root@ELK ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h4 id="安装elasticsearch-head插件"><a href="#安装elasticsearch-head插件" class="headerlink" title="安装elasticsearch-head插件"></a>安装elasticsearch-head插件</h4><p>由于Elasticsearch 5.0 head插件不能以插件形式安装，因此需要单独安装<br>参考：<a href="https://github.com/mobz/elasticsearch-head" target="_blank" rel="external">https://github.com/mobz/elasticsearch-head</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">Running as a plugin of Elasticsearch</div><div class="line"></div><div class="line">Install elasticsearch-head:</div><div class="line">– <span class="keyword">for</span> Elasticsearch 5.x:</div><div class="line">site plugins are not supported. Run elasticsearch-head as a standalone server</div><div class="line">– <span class="keyword">for</span> Elasticsearch 2.x – 4.x:</div><div class="line">sudo elasticsearch/bin/plugin install mobz/elasticsearch-head</div><div class="line">– <span class="keyword">for</span> Elasticsearch 1.x:</div><div class="line">sudo elasticsearch/bin/plugin -install mobz/elasticsearch-head/1.x</div><div class="line">– <span class="keyword">for</span> Elasticsearch 0.9:</div><div class="line">sudo elasticsearch/bin/plugin -install mobz/elasticsearch-head/0.9</div><div class="line">open http://localhost:9200/_plugin/head/</div><div class="line"></div><div class="line">Running with built <span class="keyword">in</span> server：</div><div class="line"><span class="built_in">enable</span> cors by adding http.cors.enabled: <span class="literal">true</span> <span class="keyword">in</span> elasticsearch configuration. Don’t forget to also <span class="built_in">set</span> http.cors.allow-origin because no origin allowed by default. http.cors.allow-origin: <span class="string">"*"</span> is valid value, however it’s considered as a security risk as your cluster is open to cross origin from anywhere. Check Elasticsearch documentation on this parameter: https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-http.html<span class="comment">#modules-http</span></div><div class="line">git <span class="built_in">clone</span> git://github.com/mobz/elasticsearch-head.git</div><div class="line"><span class="built_in">cd</span> elasticsearch-head</div><div class="line">npm install</div><div class="line">grunt server</div><div class="line">open http://localhost:9100/</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#npm命令需要安装nodejs</span></div><div class="line">[root@ELK ~]<span class="comment"># wget https://nodejs.org/dist/v0.12.16/node-v0.12.16.tar.gz</span></div><div class="line">[root@ELK ~]<span class="comment"># tar -zxf node-v0.12.16.tar.gz </span></div><div class="line">[root@ELK ~]<span class="comment"># cd node-v0.12.16</span></div><div class="line">[root@ELK node-v0.12.16]<span class="comment">#</span></div><div class="line">[root@ELK node-v0.12.16]<span class="comment"># ./configure --prefix=/usr/local/node-v0.12.16</span></div><div class="line">[root@ELK node-v0.12.16]<span class="comment"># make &amp;&amp; make install</span></div><div class="line">[root@ELK ~]<span class="comment"># ls -l /usr/local/node-v0.12.16/bin/npm</span></div><div class="line">lrwxrwxrwx 1 root root 38 Dec 28 12:43 /usr/<span class="built_in">local</span>/node-v0.12.16/bin/npm -&gt; ../lib/node_modules/npm/bin/npm-cli.js</div><div class="line">[root@ELK ~]<span class="comment"># ln -s /usr/local/node-v0.12.16/bin/npm /usr/bin/</span></div><div class="line">[root@ELK ~]<span class="comment"># ll /usr/bin/npm </span></div><div class="line">lrwxrwxrwx 1 root root 32 Dec 28 14:31 /usr/bin/npm -&gt; /usr/<span class="built_in">local</span>/node-v0.12.16/bin/npm</div><div class="line">[root@ELK ~]<span class="comment">#</span></div><div class="line">[root@ELK ~]<span class="comment"># ln -s /usr/local/node-v0.12.16/bin/node /usr/bin/</span></div><div class="line">[root@ELK ~]<span class="comment"># ll /usr/bin/node </span></div><div class="line">lrwxrwxrwx 1 root root 33 Dec 28 15:06 /usr/bin/node -&gt; /usr/<span class="built_in">local</span>/node-v0.12.16/bin/node</div><div class="line">[root@ELK ~]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@ELK ~]<span class="comment"># yum -y install git</span></div><div class="line">[root@ELK ~]<span class="comment"># cd /usr/local/</span></div><div class="line">[root@ELK <span class="built_in">local</span>]<span class="comment"># git clone git://github.com/mobz/elasticsearch-head.git</span></div><div class="line">[root@ELK <span class="built_in">local</span>]<span class="comment"># cd elasticsearch-head</span></div><div class="line">[root@ELK elasticsearch-head]<span class="comment"># npm install</span></div><div class="line"><span class="comment">#如果在elasticsearch-head目录下node_modules/grunt下如果没有grunt二进制程序，则需要执行</span></div><div class="line">[root@ELK ~]<span class="comment"># cd /usr/local/elasticsearch-head/</span></div><div class="line">[root@ELK elasticsearch-head]<span class="comment"># npm install grunt --save</span></div><div class="line">[root@ELK elasticsearch-head]<span class="comment"># ls</span></div><div class="line">Dockerfile                          grunt_fileSets.js  node_modules                  README.textile  <span class="built_in">test</span></div><div class="line">elasticsearch-head.sublime-project  index.html         package.json                  _site</div><div class="line">Gruntfile.js                        LICENCE            plugin-descriptor.properties  src</div><div class="line">[root@ELK elasticsearch-head]<span class="comment"># ls -l node_modules/grunt/bin/grunt</span></div><div class="line">-rwxr-xr-x 1 root root 53 Apr  6  2016 node_modules/grunt/bin/grunt</div><div class="line">[root@ELK elasticsearch-head]<span class="comment">#</span></div><div class="line">[root@ELK elasticsearch-head]<span class="comment"># head -98 Gruntfile.js | tail -9</span></div><div class="line">		connect: &#123;</div><div class="line">			server: &#123;</div><div class="line">				options: &#123;</div><div class="line">					hostname: <span class="string">'0.0.0.0'</span>,   <span class="comment">#添加这行</span></div><div class="line">					port: 9100,</div><div class="line">					base: <span class="string">'.'</span>,</div><div class="line">					keepalive: <span class="literal">true</span></div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">[root@ELK elasticsearch-head]<span class="comment"># /usr/local/elasticsearch-head/node_modules/grunt/bin/grunt server  #如果执行报错看下面的解决办法</span></div><div class="line">Running <span class="string">"connect:server"</span> (connect) task</div><div class="line">Waiting forever...</div><div class="line">Started connect web server on http://localhost:9100</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#最新安装步骤</span></div><div class="line">yum -y install git make gcc gcc-c++ wget bzip2</div><div class="line">wget https://nodejs.org/dist/v8.9.3/node-v8.9.3.tar.gz</div><div class="line">tar -zxf node-v8.9.3.tar.gz</div><div class="line"><span class="built_in">cd</span> node-v8.9.3</div><div class="line">./configure --prefix=/usr/<span class="built_in">local</span>/node-v8.9.3</div><div class="line">make &amp;&amp; make install</div><div class="line">ln <span class="_">-s</span> /usr/<span class="built_in">local</span>/node-v8.9.3/bin/npm /usr/bin/</div><div class="line">ln <span class="_">-s</span> /usr/<span class="built_in">local</span>/node-v8.9.3/bin/node /usr/bin/</div><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/ &amp;&amp; git <span class="built_in">clone</span> https://github.com/mobz/elasticsearch-head.git</div><div class="line">mkdir -p /tmp/phantomjs/ &amp;&amp; wget https://github.com/Medium/phantomjs/releases/download/v2.1.1/phantomjs-2.1.1-linux-x86_64.tar.bz2 -O /tmp/phantomjs/phantomjs-2.1.1-linux-x86_64.tar.bz2</div><div class="line"><span class="built_in">cd</span> elasticsearch-head/ &amp;&amp; npm install</div><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/elasticsearch-head/ &amp;&amp; npm install grunt --save</div><div class="line">npm install grunt-contrib-clean --registry=https://registry.npm.taobao.org</div><div class="line">npm install grunt-contrib-concat --registry=https://registry.npm.taobao.org</div><div class="line">npm install grunt-contrib-watch --registry=https://registry.npm.taobao.org</div><div class="line">npm install grunt-contrib-connect --registry=https://registry.npm.taobao.org</div><div class="line">npm install grunt-contrib-copy --registry=https://registry.npm.taobao.org</div><div class="line">npm install grunt-contrib-jasmine --registry=https://registry.npm.taobao.org</div><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/elasticsearch-head/ &amp;&amp; sed -i <span class="string">"/port: 9100/ihostname: '0.0.0.0',"</span> Gruntfile.js</div><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/elasticsearch-head/ &amp;&amp; /usr/<span class="built_in">local</span>/elasticsearch-head/node_modules/grunt/bin/grunt server &amp;</div></pre></td></tr></table></figure>
<h4 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h4><p>听说有些依赖在国内解决不了，已经考虑使用Docker<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># docker pull salgat/elasticsearch-head</span></div><div class="line"><span class="comment"># docker run -d --name elasticsearch-head -p9100:9100 docker.io/salgat/elasticsearch-head</span></div></pre></td></tr></table></figure></p>
<p>官方也提供了elasticsearch-head在Docker容器中使用的方法<br>Running with docker<br>for Elasticsearch 5.x: <code>docker run -p 9100:9100 mobz/elasticsearch-head:5</code><br>for Elasticsearch 2.x: <code>docker run -p 9100:9100 mobz/elasticsearch-head:2</code><br>for Elasticsearch 1.x: <code>docker run -p 9100:9100 mobz/elasticsearch-head:1</code><br>for fans of alpine there is mobz/elasticsearch-head:5-alpine<br>open <code>http://localhost:9100/</code>  </p>
<h4 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q &amp; A"></a>Q &amp; A</h4><p>如果服务器重启了，有时发现执行<figure class="highlight plain"><figcaption><span>server```报错```Fatal error: Unable to find local grunt.```，需要重新按照Question1的解决方法操作一下，也可以执行下面的脚本  </span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">```bash</div><div class="line">[root@ELK ~]# cat check_es_head_grunt.sh </div><div class="line">#!/bin/bash</div><div class="line"># Auther: yfshare</div><div class="line"># Date:2016-12-29</div><div class="line">eshead_dir=&quot;/usr/local/elasticsearch-head&quot;</div><div class="line">grunt_dir=&quot;$eshead_dir/node_modules/grunt&quot;</div><div class="line">grunt_bin=&quot;$grunt_dir/bin/grunt&quot;</div><div class="line"></div><div class="line">kill -9 `ps -ef | grep -iw &apos;grunt&apos; | grep -v grep | awk &apos;&#123;print $2&#125;&apos;` &amp;&gt;/dev/null</div><div class="line">[ ! -x &quot;$grunt_bin&quot; ] &amp;&amp; chmod 755 &quot;$grunt_bin&quot;</div><div class="line">echo &apos;&apos;</div><div class="line">echo &apos;Please wait a moment.&apos;</div><div class="line">cd &quot;$eshead_dir&quot;</div><div class="line">npm install grunt --save-dev &amp;&gt; /dev/null</div><div class="line">cd &quot;$eshead_dir&quot;</div><div class="line">&quot;$grunt_bin&quot; server &amp;</div><div class="line">[ $? -eq 0 ] &amp;&amp; echo &apos;start ok.&apos;</div><div class="line">[root@ELK ~]#</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@ELK ~]<span class="comment"># sh check_es_head_grunt.sh </span></div><div class="line"></div><div class="line">Please <span class="built_in">wait</span> a moment.</div><div class="line">start ok.</div><div class="line">Running <span class="string">"connect:server"</span> (connect) task</div><div class="line">Waiting forever...</div><div class="line">Started connect web server on http://localhost:9100</div><div class="line"></div><div class="line">[root@ELK ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>Question1：如果报下面的错误：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@ELK ~]<span class="comment"># /usr/local/elasticsearch-head/node_modules/grunt/bin/grunt server  </span></div><div class="line">grunt-cli: The grunt <span class="built_in">command</span> line interface (v1.2.0)  </div><div class="line">Fatal error: Unable to find <span class="built_in">local</span> grunt.</div><div class="line">If you<span class="string">'re seeing this message, grunt hasn'</span>t been installed locally to</div><div class="line">your project. For more information about installing and configuring grunt,</div><div class="line">please see the Getting Started guide:  </div><div class="line">http://gruntjs.com/getting-started  </div><div class="line">[root@ELK ~]<span class="comment">#  </span></div><div class="line"></div><div class="line">Answer：  </div><div class="line">[root@ELK ~]<span class="comment"># cd /usr/local/elasticsearch-head/  </span></div><div class="line">[root@ELK elasticsearch-head]<span class="comment"># npm install grunt --save-dev  </span></div><div class="line">再执行/usr/<span class="built_in">local</span>/elasticsearch-head/node_modules/grunt/bin/grunt server就OK了</div></pre></td></tr></table></figure></p>
<p>Question2：<br>之前修改ElasticSearch 5.1的network.host的IP时，不管修改成什么(注释network.host除外)，重启均报错，开始以为是不能绑定IP地址。之前有注意到日志里的报错的<figure class="highlight plain"><figcaption><span>checks failed. max number of threads [1024] for user [elasticsearch] is too low, increase to at least [2048]```因为注释了network.host后ElasticSearch能起来，所以没意识到是它的问题  </span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">```bash</div><div class="line">#ElasticSearch日志报错</div><div class="line">[2016-12-28T16:57:23,190][INFO ][o.e.n.Node               ] [es-node01] starting ...</div><div class="line">[2016-12-28T16:57:24,616][INFO ][o.e.t.TransportService   ] [es-node01] publish_address &#123;192.168.31.100:9300&#125;, bound_addresses &#123;192.168.31.100:9300&#125;</div><div class="line">[2016-12-28T16:57:24,686][INFO ][o.e.b.BootstrapCheck     ] [es-node01] bound or publishing to a non-loopback or non-link-local address, enforcing bootstrap checks</div><div class="line">[2016-12-28T16:57:24,708][ERROR][o.e.b.Bootstrap          ] [es-node01] node validation exception</div><div class="line">bootstrap checks failed</div><div class="line">max number of threads [1024] for user [elasticsearch] is too low, increase to at least [2048]</div><div class="line">[2016-12-28T16:57:24,739][INFO ][o.e.n.Node               ] [es-node01] stopping ...</div><div class="line">[2016-12-28T16:57:25,275][INFO ][o.e.n.Node               ] [es-node01] stopped</div><div class="line">[2016-12-28T16:57:25,277][INFO ][o.e.n.Node               ] [es-node01] closing ...</div><div class="line">[2016-12-28T16:57:25,500][INFO ][o.e.n.Node               ] [es-node01] closed</div></pre></td></tr></table></figure></p>
<p>Answer：修改<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">关于ElasticSearch5.1的network.host设置  </div><div class="line">参考：https://www.elastic.co/guide/en/elasticsearch/reference/5.1/modules-network.html#common-network-settings</div><div class="line">```bash</div><div class="line">[root@ELK ~]# grep -v ^# /etc/security/limits.conf | grep -v ^$</div><div class="line">elasticsearch	soft	nproc	2048</div><div class="line">elasticsearch	hard	nproc	4096</div><div class="line">[root@ELK ~]#</div></pre></td></tr></table></figure></p>
<p>Question3：<br>如果执行<code>/usr/local/elasticsearch-head/node_modules/grunt/bin/grunt server</code>报下面的错误<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">[root@ELK-test ~]<span class="comment"># /usr/local/elasticsearch-head/node_modules/grunt/bin/grunt server</span></div><div class="line">grunt-cli: The grunt <span class="built_in">command</span> line interface (v1.2.0)</div><div class="line"></div><div class="line">Fatal error: Unable to find <span class="built_in">local</span> grunt.</div><div class="line"></div><div class="line">If you<span class="string">'re seeing this message, grunt hasn'</span>t been installed locally to</div><div class="line">your project. For more information about installing and configuring grunt,</div><div class="line">please see the Getting Started guide:</div><div class="line"></div><div class="line">http://gruntjs.com/getting-started</div><div class="line">[root@ELK-test ~]<span class="comment">#</span></div><div class="line"></div><div class="line">Answer：</div><div class="line"><span class="comment">#进入elasticsearch-head安装目录即可，因为在别的地方找不到Gruntfile.js文件</span></div><div class="line">[root@ELK-test ~]<span class="comment"># cd /usr/local/elasticsearch-head/</span></div></pre></td></tr></table></figure></p>
<p>Question4：<br>如果执行<code>/usr/local/elasticsearch-head/node_modules/grunt/bin/grunt server</code>报下面的错误<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">[root@ELK-test elasticsearch-head]<span class="comment"># /usr/local/elasticsearch-head/node_modules/grunt/bin/grunt server</span></div><div class="line">&gt;&gt; Local Npm module <span class="string">"grunt-contrib-clean"</span> not found. Is it installed?</div><div class="line">&gt;&gt; Local Npm module <span class="string">"grunt-contrib-concat"</span> not found. Is it installed?</div><div class="line">&gt;&gt; Local Npm module <span class="string">"grunt-contrib-watch"</span> not found. Is it installed?</div><div class="line">&gt;&gt; Local Npm module <span class="string">"grunt-contrib-connect"</span> not found. Is it installed?</div><div class="line">&gt;&gt; Local Npm module <span class="string">"grunt-contrib-copy"</span> not found. Is it installed?</div><div class="line">&gt;&gt; Local Npm module <span class="string">"grunt-contrib-jasmine"</span> not found. Is it installed?</div><div class="line">Warning: Task <span class="string">"connect:server"</span> not found. Use --force to continue.</div><div class="line"></div><div class="line">Aborted due to warnings.</div><div class="line">[root@ELK-test elasticsearch-head]<span class="comment">#</span></div><div class="line"></div><div class="line">Answer：</div><div class="line">出现以下提示，为Gruntfile.js引用的，缺少以下包</div><div class="line">[root@ELK-test elasticsearch-head]<span class="comment"># npm install grunt-contrib-clean --registry=https://registry.npm.taobao.org</span></div><div class="line">[root@ELK-test elasticsearch-head]<span class="comment"># npm install grunt-contrib-concat --registry=https://registry.npm.taobao.org</span></div><div class="line">[root@ELK-test elasticsearch-head]<span class="comment"># npm install grunt-contrib-watch --registry=https://registry.npm.taobao.org</span></div><div class="line">[root@ELK-test elasticsearch-head]<span class="comment"># npm install grunt-contrib-connect --registry=https://registry.npm.taobao.org</span></div><div class="line">[root@ELK-test elasticsearch-head]<span class="comment"># npm install grunt-contrib-copy --registry=https://registry.npm.taobao.org</span></div><div class="line">[root@ELK-test elasticsearch-head]<span class="comment"># npm install grunt-contrib-jasmine --registry=https://registry.npm.taobao.org</span></div><div class="line"></div><div class="line">[root@ELK-test elasticsearch-head]<span class="comment"># /usr/local/elasticsearch-head/node_modules/grunt/bin/grunt server &amp;</span></div><div class="line">[1] 22877</div><div class="line">[root@ELK-test elasticsearch-head]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>Question5：<br>如果在执行<code>npm install</code>时报如下错误  </p>
<p>Answer：可以先下载其所需的文件再执行<code>npm install</code>安装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mkdir -p /tmp/phantomjs/</div><div class="line">wget https://github.com/Medium/phantomjs/releases/download/v2.1.1/phantomjs-2.1.1-linux-x86_64.tar.bz2 -O /tmp/phantomjs/phantomjs-2.1.1-linux-x86_64.tar.bz2</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#npm install</span></div><div class="line">npm WARN deprecated coffee-script@1.10.0: CoffeeScript on NPM has moved to <span class="string">"coffeescript"</span> (no hyphen)</div><div class="line">npm WARN deprecated http2@3.3.7: Use the built-in module <span class="keyword">in</span> node 9.0.0 or newer, instead</div><div class="line"></div><div class="line">&gt; phantomjs-prebuilt@2.1.16 install /usr/<span class="built_in">local</span>/elasticsearch-head/node_modules/phantomjs-prebuilt</div><div class="line">&gt; node install.js</div><div class="line"></div><div class="line">PhantomJS not found on PATH</div><div class="line">Downloading https://github.com/Medium/phantomjs/releases/download/v2.1.1/phantomjs-2.1.1-linux-x86_64.tar.bz2</div><div class="line">Saving to /tmp/phantomjs/phantomjs-2.1.1-linux-x86_64.tar.bz2</div><div class="line">Receiving...</div><div class="line"></div><div class="line">Error making request.</div><div class="line">Error: connect ETIMEDOUT 52.216.82.152:443</div><div class="line">    at Object._errnoException (util.js:1024:11)</div><div class="line">    at _exceptionWithHostPort (util.js:1046:20)</div><div class="line">    at TCPConnectWrap.afterConnect [as oncomplete] (net.js:1182:14)</div><div class="line"></div><div class="line">Please report this full <span class="built_in">log</span> at https://github.com/Medium/phantomjs</div><div class="line">npm WARN elasticsearch-head@0.0.0 license should be a valid SPDX license expression</div><div class="line">npm WARN optional SKIPPING OPTIONAL DEPENDENCY: fsevents@1.1.3 (node_modules/fsevents):</div><div class="line">npm WARN notsup SKIPPING OPTIONAL DEPENDENCY: Unsupported platform <span class="keyword">for</span> fsevents@1.1.3: wanted &#123;<span class="string">"os"</span>:<span class="string">"darwin"</span>,<span class="string">"arch"</span>:<span class="string">"any"</span>&#125; (current: &#123;<span class="string">"os"</span>:<span class="string">"linux"</span>,<span class="string">"arch"</span>:<span class="string">"x64"</span>&#125;)</div><div class="line"></div><div class="line">npm ERR! code ELIFECYCLE</div><div class="line">npm ERR! errno 1</div><div class="line">npm ERR! phantomjs-prebuilt@2.1.16 install: `node install.js`</div><div class="line">npm ERR! Exit status 1</div><div class="line">npm ERR! </div><div class="line">npm ERR! Failed at the phantomjs-prebuilt@2.1.16 install script.</div><div class="line">npm ERR! This is probably not a problem with npm. There is likely additional logging output above.</div><div class="line"></div><div class="line">npm ERR! A complete <span class="built_in">log</span> of this run can be found <span class="keyword">in</span>:</div><div class="line">npm ERR!     /root/.npm/_logs/2017-12-16T02_18_46_188Z-debug.log</div></pre></td></tr></table></figure>
<p>注：集群配置完成后，需要把Logstash里的ElasticSearch的地址修改正确<br>即：Logstash配置文件的output关于ElasticSearch的配置<br><figure class="highlight puppet"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">output</span> &#123;</div><div class="line">        elasticsearch &#123;</div><div class="line">                <span class="attr">hosts</span> =&gt; [<span class="string">"192.168.31.100:9200"</span>]</div><div class="line">                <span class="attr">index</span> =&gt; <span class="string">"logstash-nginx-%&#123;+YYYY.MM.dd&#125;"</span></div><div class="line">        &#125;</div></pre></td></tr></table></figure></p>
<h4 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h4><p><img src="http://note.youdao.com/yws/api/personal/file/6034AE21E6DD472EA31F19BACF3BB39C?method=download&amp;shareKey=c1e28da86983aaae6e3d6961ab74b314" alt="image"><br><img src="http://note.youdao.com/yws/api/personal/file/0B60DD50A74C4E5D99F9BF97C0FB2FD1?method=download&amp;shareKey=f5bdfc6cc8fa4cbac65d30607cd1463e" alt="image"><br><img src="http://note.youdao.com/yws/api/personal/file/03465D12C20840FDB100ACD61C2AB152?method=download&amp;shareKey=49f66cf16d4ed5a8c37ff7e91d9558c7" alt="image"><br><img src="http://note.youdao.com/yws/api/personal/file/3EB4A9FD353C46A5BD1C99AB94D2B5A2?method=download&amp;shareKey=201db35f0c4ca938b4e844ca7d964b7a" alt="image"><br><img src="http://note.youdao.com/yws/api/personal/file/66D98E66A0EA48DC8E763C15E8A90D77?method=download&amp;shareKey=9dbeb81b55fa0717d16179e04fe8b32d" alt="image"><br><img src="http://note.youdao.com/yws/api/personal/file/C675C13D627D4035967A809951E48D73?method=download&amp;shareKey=610e0f92a9d468b21df21f3f12b03b93" alt="image">  </p>
<p>2台elasticsearch，显示一台master和一台slave才是正常的<br><img src="http://note.youdao.com/yws/api/personal/file/C0E9213A27E1487D8D8B2C1E2A625861?method=download&amp;shareKey=cb8459b1788cd846bf9f7cd73196dcb2" alt="es_cluster">  </p>
<p>本文参考：<a href="https://www.chinasa.net/archives/325.html" target="_blank" rel="external">https://www.chinasa.net/archives/325.html</a><br>　　　　　<a href="http://zerosre.com/2016/12/20/k8s日志管理-三/" target="_blank" rel="external">http://zerosre.com/2016/12/20/k8s日志管理-三/</a><br>　　　　　<a href="http://hnr520.blog.51cto.com/4484939/1867033" target="_blank" rel="external">http://hnr520.blog.51cto.com/4484939/1867033</a><br>nodejs下载地址：<a href="https://nodejs.org/en/blog/release/v0.12.16/" target="_blank" rel="external">https://nodejs.org/en/blog/release/v0.12.16/</a>  </p>
<p>附件：<br><a href="http://note.youdao.com/yws/api/personal/file/9DF4FD46C39F4D198FA28E31175946FF?method=download&amp;shareKey=fb14484fc213e29de7d11fb267bd073b" target="_blank" rel="external">yum.repo</a><br><a href="http://note.youdao.com/yws/api/personal/file/7394DDCE364F4C47A2059C3B977A0173?method=download&amp;shareKey=33a242bfa78c38aa6e2eec84967633cc" target="_blank" rel="external">elasticsearch-head.zip</a><br><a href="http://note.youdao.com/yws/api/personal/file/E85D6B24C1944F5BB7FF562141E542C2?method=download&amp;shareKey=4b9be8a44632f563f29c6aa9e4eee9db" target="_blank" rel="external">node-v0.12.16.tar.gz</a><br><a href="http://note.youdao.com/yws/api/personal/file/10CB6262193249F8ABB874BDCA4AF1F8?method=download&amp;shareKey=19b78be82de892d54a42a473a212cee5" target="_blank" rel="external">phantomjs-2.1.1-linux-x86_64.tar.bz2</a><br><a href="http://note.youdao.com/yws/api/personal/file/46615981B34F4DCEB51313876E3F481A?method=download&amp;shareKey=bed7ee555658949beaae23dfe6e34b33" target="_blank" rel="external">check_es_head_grunt.sh</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/12/04/ElasticSearch集群-基础/">http://www.yfshare.vip/2017/12/04/ElasticSearch集群-基础/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[timelion请求语法]]></title>
      <url>http://www.yfshare.vip/2017/12/04/timelion%E8%AF%B7%E6%B1%82%E8%AF%AD%E6%B3%95/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>ES2.0 开始提供了一个崭新的 pipeline aggregation 特性，但是 Kibana 似乎并没有立刻跟进这方面的意思，相反，Elastic 公司推出了另一个实验室产品：Timelion。<br><a id="more"></a><br>timelion 的用法在官博里已经有介绍。尤其是最近两篇如何用 timelion 实现异常告警的文章，更是从 ES 的 pipeline aggregation 细节和场景一路讲到 timelion 具体操作，我这里几乎没有再重新讲一遍 timelion 操作入门的必要了。不过，官方却一直没有列出来 timelion 支持的请求语法的文档，而是在页面上通过点击图标的方式下拉帮助。  </p>
<h5 id="可视化效果类"><a href="#可视化效果类" class="headerlink" title="可视化效果类"></a>可视化效果类</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">.bars(<span class="variable">$width</span>): 用柱状图展示数组</div><div class="line">.lines(<span class="variable">$width</span>, <span class="variable">$fill</span>, <span class="variable">$show</span>, <span class="variable">$steps</span>): 用折线图展示数组</div><div class="line">.points(): 用散点图展示数组</div><div class="line">.color(<span class="string">"#c6c6c6"</span>): 改变颜色</div><div class="line">.hide(): 隐藏该数组</div><div class="line">.label(<span class="string">"change from %s"</span>): 标签</div><div class="line">.legend(<span class="variable">$position</span>, <span class="variable">$column</span>): 图例位置</div><div class="line">.yaxis(<span class="variable">$yaxis_number</span>, <span class="variable">$min</span>, <span class="variable">$max</span>, <span class="variable">$position</span>): 设置 Y 轴属性，.yaxis(2) 表示第二根 Y 轴</div></pre></td></tr></table></figure>
<h5 id="数据运算类"><a href="#数据运算类" class="headerlink" title="数据运算类"></a>数据运算类</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">.abs(): 对整个数组元素求绝对值</div><div class="line">.precision(<span class="variable">$number</span>): 浮点数精度</div><div class="line">.testcast(<span class="variable">$count</span>, <span class="variable">$alpha</span>, <span class="variable">$beta</span>, <span class="variable">$gamma</span>): holt-winters 预测</div><div class="line">.cusum(<span class="variable">$base</span>): 数组元素之和，再加上 <span class="variable">$base</span></div><div class="line">.derivative(): 对数组求导数</div><div class="line">.divide(<span class="variable">$divisor</span>): 数组元素除法</div><div class="line">.multiply(<span class="variable">$multiplier</span>): 数组元素乘法</div><div class="line">.subtract(<span class="variable">$term</span>): 数组元素减法</div><div class="line">.sum(<span class="variable">$term</span>): 数组元素加法</div><div class="line">.add(): 同 .sum()</div><div class="line">.plus(): 同 .sum()</div><div class="line">.first(): 返回第一个元素</div><div class="line">.movingaverage(<span class="variable">$window</span>): 用指定的窗口大小计算移动平均值</div><div class="line">.mvavg(): .movingaverage() 的简写</div><div class="line">.movingstd(<span class="variable">$window</span>): 用指定的窗口大小计算移动标准差</div><div class="line">.mvstd(): .movingstd() 的简写</div></pre></td></tr></table></figure>
<h5 id="数据源设定类"><a href="#数据源设定类" class="headerlink" title="数据源设定类"></a>数据源设定类</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">.elasticsearch(): 从 ES 读取数据</div><div class="line">.es(q=<span class="string">"querystring"</span>, metric=<span class="string">"cardinality:uid"</span>, index=<span class="string">"logstash-*"</span>, offset=<span class="string">"-1d"</span>): .elasticsearch() 的简写</div><div class="line">.graphite(metric=<span class="string">"path.to.*.data"</span>, offset=<span class="string">"-1d"</span>): 从 graphite 读取数据</div><div class="line">.quandl(): 从 quandl.com 读取 quandl 码</div><div class="line">.worldbank_indicators(): 从 worldbank.org 读取国家数据</div><div class="line">.wbi(): .worldbank_indicators() 的简写</div><div class="line">.worldbank(): 从 worldbank.org 读取数据</div><div class="line">.wb(): .worldbanck() 的简写</div></pre></td></tr></table></figure>
<p>参考：<a href="https://elasticsearch.cn/article/24" target="_blank" rel="external">https://elasticsearch.cn/article/24</a><br>更多参考：<a href="https://elasticsearch.cn/article/" target="_blank" rel="external">https://elasticsearch.cn/article/</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/12/04/timelion请求语法/">http://www.yfshare.vip/2017/12/04/timelion请求语法/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Logstash监控]]></title>
      <url>http://www.yfshare.vip/2017/12/04/Logstash%E7%9B%91%E6%8E%A7/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p> Logstash监控指标<br> <a id="more"></a><br>环境：Logstash 5.6.1  </p>
<h4 id="通过jvm监控"><a href="#通过jvm监控" class="headerlink" title="通过jvm监控"></a>通过jvm监控</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">[root@ELK-test ~]<span class="comment"># curl -s localhost:9600/_node/stats/jvm?pretty=true</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"host"</span> : <span class="string">"ELK-test"</span>,</div><div class="line">  <span class="string">"version"</span> : <span class="string">"5.6.1"</span>,</div><div class="line">  <span class="string">"http_address"</span> : <span class="string">"127.0.0.1:9600"</span>,</div><div class="line">  <span class="string">"id"</span> : <span class="string">"6eaac40c-2e2a-4e04-8fce-10e938c9dc0d"</span>,</div><div class="line">  <span class="string">"name"</span> : <span class="string">"ELK-test"</span>,</div><div class="line">  <span class="string">"jvm"</span> : &#123;</div><div class="line">    <span class="string">"threads"</span> : &#123;</div><div class="line">      <span class="string">"count"</span> : 67,</div><div class="line">      <span class="string">"peak_count"</span> : 68</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"mem"</span> : &#123;</div><div class="line">      <span class="string">"heap_used_percent"</span> : 17,</div><div class="line">      <span class="string">"heap_committed_in_bytes"</span> : 340779008,</div><div class="line">      <span class="string">"heap_max_in_bytes"</span> : 1056309248,</div><div class="line">      <span class="string">"heap_used_in_bytes"</span> : 181136632,</div><div class="line">      <span class="string">"non_heap_used_in_bytes"</span> : 112857424,</div><div class="line">      <span class="string">"non_heap_committed_in_bytes"</span> : 120733696,</div><div class="line">      <span class="string">"pools"</span> : &#123;</div><div class="line">        <span class="string">"survivor"</span> : &#123;</div><div class="line">          <span class="string">"peak_used_in_bytes"</span> : 17432576,</div><div class="line">          <span class="string">"used_in_bytes"</span> : 5437952,</div><div class="line">          <span class="string">"peak_max_in_bytes"</span> : 17432576,</div><div class="line">          <span class="string">"max_in_bytes"</span> : 17432576,</div><div class="line">          <span class="string">"committed_in_bytes"</span> : 17432576</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"old"</span> : &#123;</div><div class="line">          <span class="string">"peak_used_in_bytes"</span> : 130825496,</div><div class="line">          <span class="string">"used_in_bytes"</span> : 130825496,</div><div class="line">          <span class="string">"peak_max_in_bytes"</span> : 899284992,</div><div class="line">          <span class="string">"max_in_bytes"</span> : 899284992,</div><div class="line">          <span class="string">"committed_in_bytes"</span> : 183754752</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"young"</span> : &#123;</div><div class="line">          <span class="string">"peak_used_in_bytes"</span> : 139591680,</div><div class="line">          <span class="string">"used_in_bytes"</span> : 44873184,</div><div class="line">          <span class="string">"peak_max_in_bytes"</span> : 139591680,</div><div class="line">          <span class="string">"max_in_bytes"</span> : 139591680,</div><div class="line">          <span class="string">"committed_in_bytes"</span> : 139591680</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"gc"</span> : &#123;</div><div class="line">      <span class="string">"collectors"</span> : &#123;</div><div class="line">        <span class="string">"old"</span> : &#123;</div><div class="line">          <span class="string">"collection_time_in_millis"</span> : 375,</div><div class="line">          <span class="string">"collection_count"</span> : 5</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"young"</span> : &#123;</div><div class="line">          <span class="string">"collection_time_in_millis"</span> : 44399,</div><div class="line">          <span class="string">"collection_count"</span> : 3181</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"uptime_in_millis"</span> : 186066906</div><div class="line">  &#125;</div><div class="line">&#125;[root@ELK-test ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h4 id="通过process监控"><a href="#通过process监控" class="headerlink" title="通过process监控"></a>通过process监控</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">[root@ELK-test ~]<span class="comment"># curl -s localhost:9600/_node/stats/process?pretty=true</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"host"</span> : <span class="string">"ELK-test"</span>,</div><div class="line">  <span class="string">"version"</span> : <span class="string">"5.6.1"</span>,</div><div class="line">  <span class="string">"http_address"</span> : <span class="string">"127.0.0.1:9600"</span>,</div><div class="line">  <span class="string">"id"</span> : <span class="string">"6eaac40c-2e2a-4e04-8fce-10e938c9dc0d"</span>,</div><div class="line">  <span class="string">"name"</span> : <span class="string">"ELK-test"</span>,</div><div class="line">  <span class="string">"process"</span> : &#123;</div><div class="line">    <span class="string">"open_file_descriptors"</span> : 202,</div><div class="line">    <span class="string">"peak_open_file_descriptors"</span> : 202,</div><div class="line">    <span class="string">"max_file_descriptors"</span> : 4096,</div><div class="line">    <span class="string">"mem"</span> : &#123;</div><div class="line">      <span class="string">"total_virtual_in_bytes"</span> : 3939852288</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"cpu"</span> : &#123;</div><div class="line">      <span class="string">"total_in_millis"</span> : 3338270,</div><div class="line">      <span class="string">"percent"</span> : 0,</div><div class="line">      <span class="string">"load_average"</span> : &#123;</div><div class="line">        <span class="string">"1m"</span> : 0.54,</div><div class="line">        <span class="string">"5m"</span> : 0.32,</div><div class="line">        <span class="string">"15m"</span> : 0.31</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;[root@ELK-test ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h4 id="通过pipeline监控"><a href="#通过pipeline监控" class="headerlink" title="通过pipeline监控"></a>通过pipeline监控</h4><p>这里可以看到每个插件的日志处理情况（数量，耗时等），如果使用了grok插件，还显示正则匹配失败的数量、每个字段匹配的正则表达式个数等很有用的排障和性能调优信息<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div></pre></td><td class="code"><pre><div class="line">[root@ELK-test ~]<span class="comment"># curl -s localhost:9600/_node/stats/pipeline?pretty=true</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"host"</span> : <span class="string">"ELK-test"</span>,</div><div class="line">  <span class="string">"version"</span> : <span class="string">"5.6.1"</span>,</div><div class="line">  <span class="string">"http_address"</span> : <span class="string">"127.0.0.1:9600"</span>,</div><div class="line">  <span class="string">"id"</span> : <span class="string">"6eaac40c-2e2a-4e04-8fce-10e938c9dc0d"</span>,</div><div class="line">  <span class="string">"name"</span> : <span class="string">"ELK-test"</span>,</div><div class="line">  <span class="string">"pipeline"</span> : &#123;</div><div class="line">    <span class="string">"events"</span> : &#123;</div><div class="line">      <span class="string">"duration_in_millis"</span> : 3671575,</div><div class="line">      <span class="string">"in"</span> : 1621595,</div><div class="line">      <span class="string">"out"</span> : 1621595,</div><div class="line">      <span class="string">"filtered"</span> : 1621595,</div><div class="line">      <span class="string">"queue_push_duration_in_millis"</span> : 295900</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"plugins"</span> : &#123;</div><div class="line">      <span class="string">"inputs"</span> : [ &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-2"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"out"</span> : 1621595,</div><div class="line">          <span class="string">"queue_push_duration_in_millis"</span> : 295900</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"current_connections"</span> : 1,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"beats"</span>,</div><div class="line">        <span class="string">"peak_connections"</span> : 1</div><div class="line">      &#125; ],</div><div class="line">      <span class="string">"filters"</span> : [ ],</div><div class="line">      <span class="string">"outputs"</span> : [ &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-16"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 307125,</div><div class="line">          <span class="string">"in"</span> : 411982,</div><div class="line">          <span class="string">"out"</span> : 411982</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-37"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 0,</div><div class="line">          <span class="string">"in"</span> : 0,</div><div class="line">          <span class="string">"out"</span> : 0</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-28"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 71536,</div><div class="line">          <span class="string">"in"</span> : 11323,</div><div class="line">          <span class="string">"out"</span> : 11323</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-30"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 8323,</div><div class="line">          <span class="string">"in"</span> : 1200,</div><div class="line">          <span class="string">"out"</span> : 1200</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-33"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 0,</div><div class="line">          <span class="string">"in"</span> : 0,</div><div class="line">          <span class="string">"out"</span> : 0</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-40"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 3373,</div><div class="line">          <span class="string">"in"</span> : 154,</div><div class="line">          <span class="string">"out"</span> : 154</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-17"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 24148,</div><div class="line">          <span class="string">"in"</span> : 3444,</div><div class="line">          <span class="string">"out"</span> : 3444</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-31"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 0,</div><div class="line">          <span class="string">"in"</span> : 0,</div><div class="line">          <span class="string">"out"</span> : 0</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-3"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 12911,</div><div class="line">          <span class="string">"in"</span> : 1007,</div><div class="line">          <span class="string">"out"</span> : 1007</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-32"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 3564,</div><div class="line">          <span class="string">"in"</span> : 285,</div><div class="line">          <span class="string">"out"</span> : 285</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-25"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 717356,</div><div class="line">          <span class="string">"in"</span> : 407063,</div><div class="line">          <span class="string">"out"</span> : 407063</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-23"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 29538,</div><div class="line">          <span class="string">"in"</span> : 2054,</div><div class="line">          <span class="string">"out"</span> : 2054</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-11"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 0,</div><div class="line">          <span class="string">"in"</span> : 0,</div><div class="line">          <span class="string">"out"</span> : 0</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-12"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 1805,</div><div class="line">          <span class="string">"in"</span> : 104,</div><div class="line">          <span class="string">"out"</span> : 104</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-10"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 4454,</div><div class="line">          <span class="string">"in"</span> : 838,</div><div class="line">          <span class="string">"out"</span> : 838</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-13"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 0,</div><div class="line">          <span class="string">"in"</span> : 0,</div><div class="line">          <span class="string">"out"</span> : 0</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-20"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 35142,</div><div class="line">          <span class="string">"in"</span> : 4872,</div><div class="line">          <span class="string">"out"</span> : 4872</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-22"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 1334,</div><div class="line">          <span class="string">"in"</span> : 107,</div><div class="line">          <span class="string">"out"</span> : 107</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-21"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 0,</div><div class="line">          <span class="string">"in"</span> : 0,</div><div class="line">          <span class="string">"out"</span> : 0</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-29"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 4538,</div><div class="line">          <span class="string">"in"</span> : 429,</div><div class="line">          <span class="string">"out"</span> : 429</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-24"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 73579,</div><div class="line">          <span class="string">"in"</span> : 10990,</div><div class="line">          <span class="string">"out"</span> : 10990</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-39"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 0,</div><div class="line">          <span class="string">"in"</span> : 0,</div><div class="line">          <span class="string">"out"</span> : 0</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-15"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 34938,</div><div class="line">          <span class="string">"in"</span> : 3095,</div><div class="line">          <span class="string">"out"</span> : 3095</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-9"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 0,</div><div class="line">          <span class="string">"in"</span> : 0,</div><div class="line">          <span class="string">"out"</span> : 0</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-26"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 793240,</div><div class="line">          <span class="string">"in"</span> : 424502,</div><div class="line">          <span class="string">"out"</span> : 424502</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-18"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 32408,</div><div class="line">          <span class="string">"in"</span> : 5051,</div><div class="line">          <span class="string">"out"</span> : 5051</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-36"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 6709,</div><div class="line">          <span class="string">"in"</span> : 2142,</div><div class="line">          <span class="string">"out"</span> : 2142</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-7"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 27306,</div><div class="line">          <span class="string">"in"</span> : 1791,</div><div class="line">          <span class="string">"out"</span> : 1791</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-35"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 2960,</div><div class="line">          <span class="string">"in"</span> : 24,</div><div class="line">          <span class="string">"out"</span> : 24</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-5"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 867,</div><div class="line">          <span class="string">"in"</span> : 1,</div><div class="line">          <span class="string">"out"</span> : 1</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-4"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 19048,</div><div class="line">          <span class="string">"in"</span> : 3088,</div><div class="line">          <span class="string">"out"</span> : 3088</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-8"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 340928,</div><div class="line">          <span class="string">"in"</span> : 306042,</div><div class="line">          <span class="string">"out"</span> : 306042</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-19"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 26274,</div><div class="line">          <span class="string">"in"</span> : 3311,</div><div class="line">          <span class="string">"out"</span> : 3311</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-27"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 512,</div><div class="line">          <span class="string">"in"</span> : 3,</div><div class="line">          <span class="string">"out"</span> : 3</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-14"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 1477,</div><div class="line">          <span class="string">"in"</span> : 329,</div><div class="line">          <span class="string">"out"</span> : 329</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-38"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 6962,</div><div class="line">          <span class="string">"in"</span> : 3773,</div><div class="line">          <span class="string">"out"</span> : 3773</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-6"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 2092,</div><div class="line">          <span class="string">"in"</span> : 989,</div><div class="line">          <span class="string">"out"</span> : 989</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-34"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 8653,</div><div class="line">          <span class="string">"in"</span> : 1152,</div><div class="line">          <span class="string">"out"</span> : 1152</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125; ]</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"reloads"</span> : &#123;</div><div class="line">      <span class="string">"last_error"</span> : null,</div><div class="line">      <span class="string">"successes"</span> : 0,</div><div class="line">      <span class="string">"last_success_timestamp"</span> : null,</div><div class="line">      <span class="string">"last_failure_timestamp"</span> : null,</div><div class="line">      <span class="string">"failures"</span> : 0</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"queue"</span> : &#123;</div><div class="line">      <span class="string">"type"</span> : <span class="string">"memory"</span></div><div class="line">    &#125;,</div><div class="line">    <span class="string">"id"</span> : <span class="string">"main"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">[root@ELK-test ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/12/04/Logstash监控/">http://www.yfshare.vip/2017/12/04/Logstash监控/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Grok正则语法]]></title>
      <url>http://www.yfshare.vip/2017/11/22/Grok%E6%AD%A3%E5%88%99%E8%AF%AD%E6%B3%95/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>官方提供的grok表达式：<a href="https://github.com/logstash-plugins/logstash-patterns-core/tree/master/patterns" target="_blank" rel="external">https://github.com/logstash-plugins/logstash-patterns-core/tree/master/patterns</a><br>grok在线调试：<a href="https://grokdebug.herokuapp.com/" target="_blank" rel="external">https://grokdebug.herokuapp.com/</a><br><a id="more"></a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div></pre></td><td class="code"><pre><div class="line">USERNAME [a-zA-Z0-9._-]+</div><div class="line">USER %&#123;USERNAME&#125;</div><div class="line">EMAILLOCALPART [a-zA-Z][a-zA-Z0-9_.+-=:]+</div><div class="line">EMAILADDRESS %&#123;EMAILLOCALPART&#125;@%&#123;HOSTNAME&#125;</div><div class="line">INT (?:[+-]?(?:[0-9]+))</div><div class="line">BASE10NUM (?&lt;![0-9.+-])(?&gt;[+-]?(?:(?:[0-9]+(?:\.[0-9]+)?)|(?:\.[0-9]+)))</div><div class="line">NUMBER (?:%&#123;BASE10NUM&#125;)</div><div class="line">BASE16NUM (?&lt;![0-9A-Fa<span class="_">-f</span>])(?:[+-]?(?:0x)?(?:[0-9A-Fa<span class="_">-f</span>]+))</div><div class="line">BASE16FLOAT \b(?&lt;![0-9A-Fa-f.])(?:[+-]?(?:0x)?(?:(?:[0-9A-Fa<span class="_">-f</span>]+(?:\.[0-9A-Fa<span class="_">-f</span>]*)?)|(?:\.[0-9A-Fa<span class="_">-f</span>]+)))\b</div><div class="line"></div><div class="line">POSINT \b(?:[1-9][0-9]*)\b</div><div class="line">NONNEGINT \b(?:[0-9]+)\b</div><div class="line">WORD \b\w+\b</div><div class="line">NOTSPACE \S+</div><div class="line">SPACE \s*</div><div class="line">DATA .*?</div><div class="line">GREEDYDATA .*</div><div class="line">QUOTEDSTRING (?&gt;(?&lt;!\\)(?&gt;<span class="string">"(?&gt;\\.|[^\\"</span>]+)+<span class="string">"|"</span><span class="string">"|(?&gt;'(?&gt;\\.|[^\\']+)+')|''|(?&gt;`(?&gt;\\.|[^\\`]+)+`)|``))</span></div><div class="line">UUID [A-Fa-f0-9]&#123;8&#125;-(?:[A-Fa-f0-9]&#123;4&#125;-)&#123;3&#125;[A-Fa-f0-9]&#123;12&#125;</div><div class="line"># URN, allowing use of RFC 2141 section 2.3 reserved characters</div><div class="line">URN urn:[0-9A-Za-z][0-9A-Za-z-]&#123;0,31&#125;:(?:%[0-9a-fA-F]&#123;2&#125;|[0-9A-Za-z()+,.:=@;<span class="variable">$_</span>!*'/?#-])+</div><div class="line"></div><div class="line"># Networking</div><div class="line">MAC (?:%&#123;CISCOMAC&#125;|%&#123;WINDOWSMAC&#125;|%&#123;COMMONMAC&#125;)</div><div class="line">CISCOMAC (?:(?:[A-Fa-f0-9]&#123;4&#125;\.)&#123;2&#125;[A-Fa-f0-9]&#123;4&#125;)</div><div class="line">WINDOWSMAC (?:(?:[A-Fa-f0-9]&#123;2&#125;-)&#123;5&#125;[A-Fa-f0-9]&#123;2&#125;)</div><div class="line">COMMONMAC (?:(?:[A-Fa-f0-9]&#123;2&#125;:)&#123;5&#125;[A-Fa-f0-9]&#123;2&#125;)</div><div class="line">IPV6 ((([0-9A-Fa-f]&#123;1,4&#125;:)&#123;7&#125;([0-9A-Fa-f]&#123;1,4&#125;|:))|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;6&#125;(:[0-9A-Fa-f]&#123;1,4&#125;|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d))&#123;3&#125;)|:))|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;5&#125;(((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;1,2&#125;)|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d))&#123;3&#125;)|:))|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;4&#125;(((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;1,3&#125;)|((:[0-9A-Fa-f]&#123;1,4&#125;)?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d))&#123;3&#125;))|:))|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;3&#125;(((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;1,4&#125;)|((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;0,2&#125;:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d))&#123;3&#125;))|:))|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;2&#125;(((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;1,5&#125;)|((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;0,3&#125;:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d))&#123;3&#125;))|:))|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;1&#125;(((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;1,6&#125;)|((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;0,4&#125;:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d))&#123;3&#125;))|:))|(:(((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;1,7&#125;)|((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;0,5&#125;:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d))&#123;3&#125;))|:)))(%.+)?</div><div class="line">IPV4 (?&lt;![0-9])(?:(?:[0-1]?[0-9]&#123;1,2&#125;|2[0-4][0-9]|25[0-5])[.](?:[0-1]?[0-9]&#123;1,2&#125;|2[0-4][0-9]|25[0-5])[.](?:[0-1]?[0-9]&#123;1,2&#125;|2[0-4][0-9]|25[0-5])[.](?:[0-1]?[0-9]&#123;1,2&#125;|2[0-4][0-9]|25[0-5]))(?![0-9])</div><div class="line">IP (?:%&#123;IPV6&#125;|%&#123;IPV4&#125;)</div><div class="line">HOSTNAME \b(?:[0-9A-Za-z][0-9A-Za-z-]&#123;0,62&#125;)(?:\.(?:[0-9A-Za-z][0-9A-Za-z-]&#123;0,62&#125;))*(\.?|\b)</div><div class="line">IPORHOST (?:%&#123;IP&#125;|%&#123;HOSTNAME&#125;)</div><div class="line">HOSTPORT %&#123;IPORHOST&#125;:%&#123;POSINT&#125;</div><div class="line"></div><div class="line"># paths</div><div class="line">PATH (?:%&#123;UNIXPATH&#125;|%&#123;WINPATH&#125;)</div><div class="line">UNIXPATH (/([\w_%!<span class="variable">$@</span>:.,+~-]+|\\.)*)+</div><div class="line">TTY (?:/dev/(pts|tty([pq])?)(\w+)?/?(?:[0-9]+))</div><div class="line">WINPATH (?&gt;[A-Za-z]+:|\\)(?:\\[^\\?*]*)+</div><div class="line">URIPROTO [A-Za-z]+(\+[A-Za-z+]+)?</div><div class="line">URIHOST %&#123;IPORHOST&#125;(?::%&#123;POSINT:port&#125;)?</div><div class="line"># uripath comes loosely from RFC1738, but mostly from what Firefox</div><div class="line"># doesn't turn into %XX</div><div class="line">URIPATH (?:/[A-Za-z0-9$.+!*'()&#123;&#125;,~:;=@#%&amp;_\-]*)+</div><div class="line">#URIPARAM \?(?:[A-Za-z0-9]+(?:=(?:[^&amp;]*))?(?:&amp;(?:[A-Za-z0-9]+(?:=(?:[^&amp;]*))?)?)*)?</div><div class="line">URIPARAM \?[A-Za-z0-9$.+!*'|()&#123;&#125;,~@#%&amp;/=:;_?\-\[\]&lt;&gt;]*</div><div class="line">URIPATHPARAM %&#123;URIPATH&#125;(?:%&#123;URIPARAM&#125;)?</div><div class="line">URI %&#123;URIPROTO&#125;://(?:%&#123;USER&#125;(?::[^@]*)?@)?(?:%&#123;URIHOST&#125;)?(?:%&#123;URIPATHPARAM&#125;)?</div><div class="line"></div><div class="line"># Months: January, Feb, 3, 03, 12, December</div><div class="line">MONTH \b(?:[Jj]an(?:uary|uar)?|[Ff]eb(?:ruary|ruar)?|[Mm](?:a|ä)?r(?:ch|z)?|[Aa]pr(?:il)?|[Mm]a(?:y|i)?|[Jj]un(?:e|i)?|[Jj]ul(?:y)?|[Aa]ug(?:ust)?|[Ss]ep(?:tember)?|[Oo](?:c|k)?t(?:ober)?|[Nn]ov(?:ember)?|[Dd]e(?:c|z)(?:ember)?)\b</div><div class="line">MONTHNUM (?:0?[1-9]|1[0-2])</div><div class="line">MONTHNUM2 (?:0[1-9]|1[0-2])</div><div class="line">MONTHDAY (?:(?:0[1-9])|(?:[12][0-9])|(?:3[01])|[1-9])</div><div class="line"></div><div class="line"># Days: Monday, Tue, Thu, etc...</div><div class="line">DAY (?:Mon(?:day)?|Tue(?:sday)?|Wed(?:nesday)?|Thu(?:rsday)?|Fri(?:day)?|Sat(?:urday)?|Sun(?:day)?)</div><div class="line"></div><div class="line"># Years?</div><div class="line">YEAR (?&gt;\d\d)&#123;1,2&#125;</div><div class="line">HOUR (?:2[0123]|[01]?[0-9])</div><div class="line">MINUTE (?:[0-5][0-9])</div><div class="line"># '60' is a leap second in most time standards and thus is valid.</div><div class="line">SECOND (?:(?:[0-5]?[0-9]|60)(?:[:.,][0-9]+)?)</div><div class="line">TIME (?!&lt;[0-9])%&#123;HOUR&#125;:%&#123;MINUTE&#125;(?::%&#123;SECOND&#125;)(?![0-9])</div><div class="line"># datestamp is YYYY/MM/DD-HH:MM:SS.UUUU (or something like it)</div><div class="line">DATE_US %&#123;MONTHNUM&#125;[/-]%&#123;MONTHDAY&#125;[/-]%&#123;YEAR&#125;</div><div class="line">DATE_EU %&#123;MONTHDAY&#125;[./-]%&#123;MONTHNUM&#125;[./-]%&#123;YEAR&#125;</div><div class="line">ISO8601_TIMEZONE (?:Z|[+-]%&#123;HOUR&#125;(?::?%&#123;MINUTE&#125;))</div><div class="line">ISO8601_SECOND (?:%&#123;SECOND&#125;|60)</div><div class="line">TIMESTAMP_ISO8601 %&#123;YEAR&#125;-%&#123;MONTHNUM&#125;-%&#123;MONTHDAY&#125;[T ]%&#123;HOUR&#125;:?%&#123;MINUTE&#125;(?::?%&#123;SECOND&#125;)?%&#123;ISO8601_TIMEZONE&#125;?</div><div class="line">DATE %&#123;DATE_US&#125;|%&#123;DATE_EU&#125;</div><div class="line">DATESTAMP %&#123;DATE&#125;[- ]%&#123;TIME&#125;</div><div class="line">TZ (?:[APMCE][SD]T|UTC)</div><div class="line">DATESTAMP_RFC822 %&#123;DAY&#125; %&#123;MONTH&#125; %&#123;MONTHDAY&#125; %&#123;YEAR&#125; %&#123;TIME&#125; %&#123;TZ&#125;</div><div class="line">DATESTAMP_RFC2822 %&#123;DAY&#125;, %&#123;MONTHDAY&#125; %&#123;MONTH&#125; %&#123;YEAR&#125; %&#123;TIME&#125; %&#123;ISO8601_TIMEZONE&#125;</div><div class="line">DATESTAMP_OTHER %&#123;DAY&#125; %&#123;MONTH&#125; %&#123;MONTHDAY&#125; %&#123;TIME&#125; %&#123;TZ&#125; %&#123;YEAR&#125;</div><div class="line">DATESTAMP_EVENTLOG %&#123;YEAR&#125;%&#123;MONTHNUM2&#125;%&#123;MONTHDAY&#125;%&#123;HOUR&#125;%&#123;MINUTE&#125;%&#123;SECOND&#125;</div><div class="line"></div><div class="line"># Syslog Dates: Month Day HH:MM:SS</div><div class="line">SYSLOGTIMESTAMP %&#123;MONTH&#125; +%&#123;MONTHDAY&#125; %&#123;TIME&#125;</div><div class="line">PROG [\x21-\x5a\x5c\x5e-\x7e]+</div><div class="line">SYSLOGPROG %&#123;PROG:program&#125;(?:\[%&#123;POSINT:pid&#125;\])?</div><div class="line">SYSLOGHOST %&#123;IPORHOST&#125;</div><div class="line">SYSLOGFACILITY &lt;%&#123;NONNEGINT:facility&#125;.%&#123;NONNEGINT:priority&#125;&gt;</div><div class="line">HTTPDATE %&#123;MONTHDAY&#125;/%&#123;MONTH&#125;/%&#123;YEAR&#125;:%&#123;TIME&#125; %&#123;INT&#125;</div><div class="line"></div><div class="line"># Shortcuts</div><div class="line">QS %&#123;QUOTEDSTRING&#125;</div><div class="line"></div><div class="line"># Log formats</div><div class="line">SYSLOGBASE %&#123;SYSLOGTIMESTAMP:timestamp&#125; (?:%&#123;SYSLOGFACILITY&#125; )?%&#123;SYSLOGHOST:logsource&#125; %&#123;SYSLOGPROG&#125;:</div><div class="line"></div><div class="line"># Log Levels</div><div class="line">LOGLEVEL ([Aa]lert|ALERT|[Tt]race|TRACE|[Dd]ebug|DEBUG|[Nn]otice|NOTICE|[Ii]nfo|INFO|[Ww]arn?(?:ing)?|WARN?(?:ING)?|[Ee]rr?(?:or)?|ERR?(?:OR)?|[Cc]rit?(?:ical)?|CRIT?(?:ICAL)?|[Ff]atal|FATAL|[Ss]evere|SEVERE|EMERG(?:ENCY)?|[Ee]merg(?:ency)?)</div></pre></td></tr></table></figure></p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/11/22/Grok正则语法/">http://www.yfshare.vip/2017/11/22/Grok正则语法/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Logstash配置语法]]></title>
      <url>http://www.yfshare.vip/2017/11/22/Logstash%E9%85%8D%E7%BD%AE%E8%AF%AD%E6%B3%95/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>Logstash 社区通常习惯用 shipper，broker 和 indexer 来描述数据流中不同进程各自的角色<br><a id="more"></a><br>Logstash设计了自己的DSL。包含有  </p>
<ul>
<li>区域</li>
<li>注释</li>
<li>数据类型(布尔值，字符串，数值，数组，哈希)</li>
<li>条件判断</li>
<li>字段引用等<br><img src="http://note.youdao.com/yws/api/personal/file/5ABEC6BA6184467BA639CD46B67E6AD1?method=download&amp;shareKey=6411709c4a0ddd05944af76c3744134d" alt="Lostash角色">  </li>
</ul>
<h4 id="区段-section"><a href="#区段-section" class="headerlink" title="区段(section)"></a>区段(section)</h4><p>Logstash用<code>{}</code>来定义区域。区域内可以包括插件区域定义，可以在一个区域内定义多个插件。插件区域内则可以定义键值对设置。示例如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">input &#123;</div><div class="line">    stdin &#123;&#125;</div><div class="line">    syslog &#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h4><p>Logstash 支持少量的数据值类型：</p>
<ul>
<li>bool<br><code>debug =&gt; true</code></li>
<li>string<br><code>host =&gt; &quot;hostname&quot;</code></li>
<li>number<br><code>port =&gt; 514</code></li>
<li>array<br><code>match =&gt; [&quot;datetime&quot;, &quot;UNIX&quot;, &quot;ISO8601&quot;]</code></li>
<li>hash  <figure class="highlight coq"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">options =&gt; &#123;</div><div class="line">    key1 =&gt; <span class="string">"value1"</span>,</div><div class="line">    key2 =&gt; <span class="string">"value2"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>注：如果你用的版本低于 1.2.0，哈希的语法跟数组是一样的，如： <code>match =&gt; [ &quot;field1&quot;, &quot;pattern1&quot;, &quot;field2&quot;, &quot;pattern2&quot; ]</code>  </p>
<h4 id="字段引用-field-reference"><a href="#字段引用-field-reference" class="headerlink" title="字段引用(field reference)"></a>字段引用(field reference)</h4><p>字段是Logstash::Event对象的属性。之前提过事件就像一个哈希一样，所以可以想象字段就像一个键值对。<br>如果在Logstash配置中使用字段的值，只需要把字段的名字写在中括号 [] 里就行了，这就叫字段引用。<br>对于嵌套字段(也就是多维哈希表，或者叫哈希的哈希)，每层的字段名都写在 [] 里。如，可以从 geoip 里这样获取 longitude 值<br><code>[geoip][location][0]</code><br>注：logstash 的数组也支持倒序下标，即<code>[geoip][location][-1]</code>可以获取数组最后一个元素的值。<br>Logstash 还支持变量内插，在字符串里使用字段引用的方法是：<br><code>&quot;the longitude is %{[geoip][location][0]}&quot;</code>  </p>
<h4 id="条件判断-condition"><a href="#条件判断-condition" class="headerlink" title="条件判断(condition)"></a>条件判断(condition)</h4><p>Logstash从 1.3.0 版开始支持条件判断和表达式。<br>表达式支持下面这些操作符：  </p>
<ul>
<li><code>==</code>(等于), <code>!=</code>(不等于), <code>&lt;</code>(小于), <code>&gt;</code>(大于), <code>&lt;=</code>(小于等于), <code>&gt;=</code>(大于等于)  </li>
<li><code>=~</code>(匹配正则), <code>!~</code>（不匹配正则）  </li>
<li><code>in</code>(包含), <code>not in</code>(不包含)  </li>
<li><code>and</code>(与), <code>or</code>(或), <code>nand</code>(非与), <code>xor</code>(非或)  </li>
<li><code>()</code>(复合表达式), <code>!()</code>(对复合表达式结果取反)<br>通常来说，你都会在表达式里用到字段引用。为了尽量展示全面各种表达式，下面虚拟一个示例：  <figure class="highlight markdown"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">if "_grokparsefailure" not in [tags] &#123;</div><div class="line">&#125; else if [<span class="string">status</span>] !~ /^2\d\d/ or ( [<span class="string">url</span>] == "/noc.gif" nand [<span class="string">geoip</span>][<span class="symbol">city</span>] != "beijing" ) &#123;</div><div class="line">&#125; else &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="命令行参数"><a href="#命令行参数" class="headerlink" title="命令行参数"></a>命令行参数</h4><p>Logstash 提供了一个 shell 脚本叫 logstash 方便快速运行。它支持以下参数：  </p>
<ul>
<li><p><code>-e</code><br>意即执行。我们在 “Hello World” 的时候已经用过这个参数了。事实上你可以不写任何具体配置，直接运行 <code>bin/logstash -e &#39;&#39;</code> 达到相同效果。这个参数的默认值是下面这样：  </p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class">input </span>&#123;</div><div class="line">    <span class="class">stdin </span>&#123; &#125;</div><div class="line">&#125;</div><div class="line"><span class="class">output </span>&#123;</div><div class="line">    <span class="class">stdout </span>&#123; &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p><code>--config</code> 或 <code>-f</code><br>意即文件。真实运用中，我们会写很长的配置，甚至可能超过 shell 所能支持的 1024 个字符长度。所以我们必把配置固化到文件里，然后通过 <code>bin/logstash -f agent.conf</code> 这样的形式来运行。<br>此外，logstash 还提供一个方便我们规划和书写配置的小功能。你可以直接用 <code>bin/logstash -f /etc/logstash.d/</code> 来运行。logstash 会自动读取 <code>/etc/logstash.d/</code> 目录下所有<code>*.conf</code>的文本文件，然后在自己内存里拼接成一个完整的大配置文件，再去执行。<br>#注意：logstash 列出目录下所有文件时，是字母排序的。而 logstash 配置段的 <code>filter</code> 和 <code>output</code> 都是顺序执行，所以顺序非常重要。采用多文件管理的用户，推荐采用数字编号方式命名配置文件，同时在配置中，严谨采用 if 判断限定不同日志的动作。</p>
</li>
<li><code>--configtest</code> 或 <code>-t</code><br>意即测试。用来测试 Logstash 读取到的配置文件语法是否能正常解析。Logstash 配置语法是用 <code>grammar.treetop</code> 定义的。尤其是使用了上一条提到的读取目录方式的读者，尤其要提前测试。  </li>
<li><code>--log</code> 或 <code>-l</code><br>意即日志。Logstash 默认输出日志到标准错误。生产环境下你可以通过<code>bin/logstash -l logs/logstash.log</code>命令来统一存储日志。  </li>
<li><code>--pipeline-workers</code> 或 <code>-w</code><br>运行 filter 和 output 的 pipeline 线程数量。默认是 CPU 核数。  </li>
<li><code>--pipeline-batch-size</code> 或 <code>-b</code><br>每个 Logstash pipeline 线程，在执行具体的 filter 和 output 函数之前，最多能累积的日志条数。默认是 125 条。越大性能越好，同样也会消耗越多的 JVM 内存。  <ul>
<li><code>--pipeline-batch-delay</code> 或 <code>-u</code><br>每个 Logstash pipeline 线程，在打包批量日志的时候，最多等待几毫秒。默认是 5 ms。  </li>
</ul>
</li>
<li><code>--pluginpath</code> 或 <code>-P</code><br>可以写自己的插件，然后用<code>bin/logstash --pluginpath /path/to/own/plugins</code>加载它们。  </li>
<li><code>--verbose</code><br>输出一定的调试日志。  </li>
<li><code>--debug</code><br>输出更多的调试日志。  </li>
</ul>
<h4 id="设置文件"><a href="#设置文件" class="headerlink" title="设置文件"></a>设置文件</h4><p>从 Logstash 5.0 开始，新增了<code>$LS_HOME/config/logstash.yml</code> 文件，可以将所有的命令行参数都通过 <code>YAML</code> 文件方式设置。同时为了反映命令行配置参数的层级关系，参数也都改成用.而不是-了。<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">pipeline:</span></div><div class="line"><span class="symbol">    workers:</span> <span class="number">24</span></div><div class="line"><span class="symbol">    batch:</span></div><div class="line"><span class="symbol">        size:</span> <span class="number">125</span></div><div class="line"><span class="symbol">        delay:</span> <span class="number">5</span></div></pre></td></tr></table></figure></p>
<p>参考文档：<a href="http://kibana.logstash.es/content/logstash/get-start/full-config.html" target="_blank" rel="external">http://kibana.logstash.es/content/logstash/get-start/full-config.html</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/11/22/Logstash配置语法/">http://www.yfshare.vip/2017/11/22/Logstash配置语法/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[ELK安装(基础)]]></title>
      <url>http://www.yfshare.vip/2017/11/22/ELK%E5%AE%89%E8%A3%85-%E5%9F%BA%E7%A1%80/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>ELK是三个开源软件的缩写，分别表示：Elasticsearch , Logstash, Kibana , 它们都是开源软件<br><a id="more"></a></p>
<ol>
<li>Elasticsearch是一个高度可扩展的开源全文搜索和分析引擎，特点：分布式、零配置、自动发现、索引自动分片、索引副本机制、restful风格接口、多数据源、自动搜索负载等。</li>
<li>Logstash 是一个完全开源的工具，对日志收集、分析、并存储。</li>
<li>Kibana 是一个数据可视化平台，可以通过将数据转化为酷炫而强大的图像而实现与数据的交互，为Logstash和elasticsearch提供WEB界面。<br>将三者的收集加工，存储分析和可视转化整合在一起就形成了 ELK<br>目前这三个软件最新版为logstash-5.1.1、elasticsearch-5.1.1、kibana-5.1.1 （文章很早前写的）</li>
</ol>
<p>ELK官网：<a href="https://www.elastic.co/" target="_blank" rel="external">https://www.elastic.co/</a><br>ELK下载：<a href="https://www.elastic.co/downloads" target="_blank" rel="external">https://www.elastic.co/downloads</a><br>ELK官方文档：<a href="https://www.elastic.co/guide/index.html" target="_blank" rel="external">https://www.elastic.co/guide/index.html</a><br>ELK中文指南：<a href="http://kibana.logstash.es/content/logstash/" target="_blank" rel="external">http://kibana.logstash.es/content/logstash/</a><br>　　　　　　　<a href="https://endymecy.gitbooks.io/elasticsearch-guide-chinese/content/getting-started/README.html" target="_blank" rel="external">https://endymecy.gitbooks.io/elasticsearch-guide-chinese/content/getting-started/README.html</a><br>　　　　　　　<a href="http://udn.yyuap.com/doc/logstash-best-practice-cn/index.html" target="_blank" rel="external">http://udn.yyuap.com/doc/logstash-best-practice-cn/index.html</a>  </p>
<p>环境：Centos 6.6<br>　　　ElasticSearch 5.1.1<br>　　　Logstash 5.1.1<br>　　　Kibana 5.1.1  </p>
<p>要求：JDK 1.8+，最好是1.8.0_73  </p>
<p>安装elasticsearch参考文档：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/install-elasticsearch.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/reference/5.1/install-elasticsearch.html</a><br>安装kibana参考文档：<a href="https://www.elastic.co/guide/en/kibana/5.1/install.html" target="_blank" rel="external">https://www.elastic.co/guide/en/kibana/5.1/install.html</a><br>安装logstash参考文档：<a href="https://www.elastic.co/guide/en/logstash/5.1/installing-logstash.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/5.1/installing-logstash.html</a><br>简单测试参考：<a href="https://www.elastic.co/guide/en/logstash/5.1/first-event.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/5.1/first-event.html</a>  </p>
<h3 id="环境部署"><a href="#环境部署" class="headerlink" title="环境部署"></a>环境部署</h3><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@ELK ~]<span class="comment"># wget http://download.oracle.com/otn/java/jdk/8u73-b02/jdk-8u73-linux-x64.tar.gz?AuthParam=1481271284_8426bd60d7c0a8e617ffa072288f5b3d</span></div><div class="line">[root@ELK ~]<span class="comment"># wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.1.1.rpm</span></div><div class="line">[root@ELK ~]<span class="comment"># wget https://artifacts.elastic.co/downloads/kibana/kibana-5.1.1-x86_64.rpm</span></div><div class="line">[root@ELK ~]<span class="comment"># wget https://artifacts.elastic.co/downloads/logstash/logstash-5.1.1.rpm</span></div><div class="line"></div><div class="line">[root@ELK ~]<span class="comment"># java -version</span></div><div class="line"><span class="keyword">java </span>version <span class="string">"1.8.0_73"</span></div><div class="line"><span class="keyword">Java(TM) </span>SE Runtime Environment (<span class="keyword">build </span><span class="number">1</span>.<span class="number">8</span>.<span class="number">0</span>_73-<span class="keyword">b02)</span></div><div class="line"><span class="keyword">Java </span>HotSpot(TM) <span class="number">64</span>-<span class="keyword">Bit </span>Server VM (<span class="keyword">build </span><span class="number">25</span>.<span class="number">73</span>-<span class="keyword">b02, </span>mixed mode)</div><div class="line">[root@ELK ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#安装elasticsearch</span></div><div class="line">[root@ELK ~]<span class="comment"># yum -y install elasticsearch-5.1.1.rpm</span></div><div class="line">[root@ELK ~]<span class="comment"># mkdir -p /var/log/elasticsearch</span></div><div class="line">[root@ELK ~]<span class="comment"># grep -v '^$' /etc/elasticsearch/elasticsearch.yml | grep -v ^#</span></div><div class="line">path.data: /etc/elasticsearch/data  <span class="comment">#数据文件存放路径</span></div><div class="line">path.logs: /var/<span class="built_in">log</span>/elasticsearch   <span class="comment">#日志文件存放路径</span></div><div class="line"><span class="comment">#注：Elasticsearch本身是不允许外界访问的，所以只能把network.host设置为127.0.0.1或0.0.0.0，而它默认也是这个值，如果设为其他的值，日志里面会报错，Elasticsearch起不来</span></div><div class="line">[root@ELK ~]<span class="comment">#</span></div><div class="line">[root@ELK ~]<span class="comment"># mkdir -p /etc/elasticsearch/data/</span></div><div class="line">[root@ELK ~]<span class="comment"># chmod 775 /etc/elasticsearch/data/</span></div><div class="line">[root@ELK ~]<span class="comment"># chgrp elasticsearch /etc/elasticsearch/data/ -R</span></div><div class="line">[root@ELK ~]<span class="comment"># chkconfig --add elasticsearch</span></div><div class="line">[root@ELK ~]<span class="comment"># chkconfig elasticsearch on</span></div><div class="line">[root@ELK ~]<span class="comment"># /etc/init.d/elasticsearch start</span></div><div class="line"></div><div class="line"><span class="comment">#在Centos7中用systemctl start elasticsearch时，报" elasticsearch[10925]: which: no java in (/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin)"，需要在" /etc/sysconfig/elasticsearch "配置文件中指定“JAVA_HOME”路径</span></div><div class="line"></div><div class="line">[root@ELK ~]<span class="comment"># ps -ef | grep elasticsearch | grep -v grep</span></div><div class="line">498        3508      1 75 19:20 ?        00:00:10 /usr/<span class="built_in">local</span>/jdk1.8.0_73/bin/java -Xms2g -Xmx2g -XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFraction=75 -XX:+UseCMSInitiatingOccupancyOnly -XX:+DisableExplicitGC -XX:+AlwaysPreTouch -server -Xss1m -Djava.awt.headless=<span class="literal">true</span> -Dfile.encoding=UTF-8 -Djna.nosys=<span class="literal">true</span> -Djdk.io.permissionsUseCanonicalPath=<span class="literal">true</span> -Dio.netty.noUnsafe=<span class="literal">true</span> -Dio.netty.noKeySetOptimization=<span class="literal">true</span> -D<span class="built_in">log</span>4j.shutdownHookEnabled=<span class="literal">false</span> -D<span class="built_in">log</span>4j2.disable.jmx=<span class="literal">true</span> -D<span class="built_in">log</span>4j.skipJansi=<span class="literal">true</span> -XX:+HeapDumpOnOutOfMemoryError -Des.path.home=/usr/share/elasticsearch -cp /usr/share/elasticsearch/lib/elasticsearch-5.1.1.jar:/usr/share/elasticsearch/lib/* org.elasticsearch.bootstrap.Elasticsearch -p /var/run/elasticsearch/elasticsearch.pid <span class="_">-d</span> -Edefault.path.logs=/var/<span class="built_in">log</span>/elasticsearch -Edefault.path.data=/var/lib/elasticsearch -Edefault.path.conf=/etc/elasticsearch</div><div class="line">[root@ELK ~]<span class="comment">#</span></div><div class="line"><span class="comment">#通过日志观察，elasticsearch监听了9200(http port)和9300俩端口</span></div><div class="line">[root@ELK ~]<span class="comment"># ss -tunlp | grep 9200</span></div><div class="line">tcp    LISTEN     0      128     ::ffff:127.0.0.1:9200                 :::*      users:((<span class="string">"java"</span>,3508,108))</div><div class="line">tcp    LISTEN     0      128                  ::1:9200                 :::*      users:((<span class="string">"java"</span>,3508,109))</div><div class="line">[root@ELK ~]<span class="comment"># ss -tunlp | grep 9300</span></div><div class="line">tcp    LISTEN     0      128     ::ffff:127.0.0.1:9300                 :::*      users:((<span class="string">"java"</span>,3508,101))</div><div class="line">tcp    LISTEN     0      128                  ::1:9300                 :::*      users:((<span class="string">"java"</span>,3508,99))</div><div class="line">[root@ELK ~]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@ELK ~]<span class="comment"># curl 'http://localhost:9200'   #显示这个就表示启动成功了</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"name"</span> : <span class="string">"mlayMmR"</span>,</div><div class="line">  <span class="string">"cluster_name"</span> : <span class="string">"elasticsearch"</span>,</div><div class="line">  <span class="string">"cluster_uuid"</span> : <span class="string">"QIe1zquiRS24X-NsfmwTNA"</span>,</div><div class="line">  <span class="string">"version"</span> : &#123;</div><div class="line">    <span class="string">"number"</span> : <span class="string">"5.6.1"</span>,</div><div class="line">    <span class="string">"build_hash"</span> : <span class="string">"667b497"</span>,</div><div class="line">    <span class="string">"build_date"</span> : <span class="string">"2017-09-14T19:22:05.189Z"</span>,</div><div class="line">    <span class="string">"build_snapshot"</span> : <span class="literal">false</span>,</div><div class="line">    <span class="string">"lucene_version"</span> : <span class="string">"6.6.1"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"tagline"</span> : <span class="string">"You Know, for Search"</span></div><div class="line">&#125;</div><div class="line">[root@ELK ~]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@ELK ~]<span class="comment"># curl localhost:9200/_cat/health?v   #集群健康检查</span></div><div class="line">epoch      timestamp cluster       status node.total node.data shards pri relo init unassign pending_tasks max_task_wait_time active_shards_percent</div><div class="line">1481282834 19:27:14  elasticsearch yellow          1         1      1   1    0    0        1             0                  -                 50.0%</div><div class="line">[root@ELK ~]<span class="comment"># curl localhost:9200/_cat/nodes?v    #获取集群中节点列表</span></div><div class="line">ip        heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name</div><div class="line">127.0.0.1            3          96   9    0.06    0.20     0.19 mdi       *      9AsElX3</div><div class="line">[root@ELK ~]<span class="comment">#</span></div><div class="line">[root@ELK ~]<span class="comment"># curl localhost:9200/_cat/allocation?v</span></div><div class="line">shards disk.indices disk.used disk.avail disk.total disk.percent host      ip        node</div><div class="line">     1        3.1kb     4.7gb     44.3gb       49gb            9 127.0.0.1 127.0.0.1 9AsElX3</div><div class="line">     1                                                                               UNASSIGNED</div><div class="line">[root@ELK ~]<span class="comment">#</span></div><div class="line">[root@ELK ~]<span class="comment"># curl 'localhost:9200/_cat/indices?v'     #获取ElasticSearch索引</span></div><div class="line">health status index                       uuid                   pri rep docs.count docs.deleted store.size pri.store.size</div><div class="line">yellow open   logstash-message-2016.12.23 6apP2ZYOQnyewF9E7zNIsQ   5   1       1999            0      1.1mb          1.1mb</div><div class="line">yellow open   logstash-message-2016.12.27 5cisTsn1RKS3oUcAcTERbw   5   1       1195            0    924.6kb        924.6kb</div><div class="line">yellow open   .kibana                     z4SDEnWrRnePE3tcz_woLA   1   1          2            0      9.6kb          9.6kb</div><div class="line">[root@ELK ~]<span class="comment">#</span></div><div class="line"><span class="comment">#yellow黄色意味着某些复制没有（或者还未）被分配。因为现在是单节点所以不能被复制，当另一节点加入集群后会复制，则会变成绿色</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#安装kibana</span></div><div class="line">[root@ELK ~]<span class="comment"># yum -y install kibana-5.1.1-x86_64.rpm</span></div><div class="line">[root@ELK ~]<span class="comment"># grep -v '^$' /etc/kibana/kibana.yml | grep -v '^#'</span></div><div class="line">server.host: <span class="string">"192.168.31.100"</span></div><div class="line">elasticsearch.url: <span class="string">"http://localhost:9200"</span></div><div class="line">[root@ELK ~]<span class="comment">#</span></div><div class="line">[root@ELK ~]<span class="comment"># chkconfig --add kibana</span></div><div class="line">[root@ELK ~]<span class="comment"># chkconfig kibana on</span></div><div class="line">[root@ELK ~]<span class="comment"># /etc/init.d/kibana start</span></div><div class="line">kibana started</div><div class="line">[root@ELK ~]<span class="comment"># ps -ef | grep kibana | grep -v grep</span></div><div class="line">kibana     3613      1 37 19:38 pts/0    00:00:16 /usr/share/kibana/bin/../node/bin/node --no-warnings /usr/share/kibana/bin/../src/cli -c /etc/kibana/kibana.yml</div><div class="line">[root@ELK ~]<span class="comment"># ss -tunlp | grep 5601</span></div><div class="line">tcp    LISTEN     0      128       192.168.31.100:5601                  *:*      users:((<span class="string">"node"</span>,3613,11))</div><div class="line">[root@ELK ~]<span class="comment">#</span></div><div class="line"><span class="comment">#kibana日志文件位置</span></div><div class="line">[root@ELK ~]<span class="comment"># ls /var/log/kibana/</span></div><div class="line">kibana.stderr  kibana.stdout</div><div class="line">[root@ELK ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#安装logstash</span></div><div class="line"><span class="comment">#需要对Java做软链接，链接到/usr/bin/java，否则安装logstash-5.1.1.rpm时报错</span></div><div class="line">[root@ELK ~]<span class="comment"># ln -s /usr/local/jdk1.8.0_73/bin/java /usr/bin/</span></div><div class="line">[root@ELK ~]<span class="comment"># whereis java</span></div><div class="line">java: /usr/bin/java</div><div class="line">[root@ELK ~]<span class="comment">#</span></div><div class="line">[root@ELK ~]<span class="comment"># yum -y install logstash-5.1.1.rpm</span></div><div class="line">[root@ELK ~]<span class="comment"># ls /usr/share/logstash/bin/</span></div><div class="line">cpdump  logstash  logstash.bat  logstash.lib.sh  logstash-plugin  logstash-plugin.bat  setup.bat  system-install</div><div class="line">[root@ELK ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h3 id="logstash调试"><a href="#logstash调试" class="headerlink" title="logstash调试"></a>logstash调试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#简单测试1</span></div><div class="line">[root@ELK ~]<span class="comment"># /usr/share/logstash/bin/logstash --path.settings /etc/logstash -e 'input &#123; stdin &#123; &#125; &#125; output &#123; stdout &#123;&#125; &#125;'</span></div><div class="line">Sending Logstash<span class="string">'s logs to /var/log/logstash which is now configured via log4j2.properties</span></div><div class="line">The stdin plugin is now waiting for input:</div><div class="line">hello world</div><div class="line">2016-12-12T09:36:50.758Z 0.0.0.0 hello world</div><div class="line">...</div><div class="line">注：要加--path.settings /etc/logstash指定配置文件目录，否则报错</div><div class="line">#再启一个窗口可以看到logstash进程，不能关掉上面测试命令，screen(crtl+D)后台运行</div><div class="line">[root@ELK ~]# ps -ef | grep logstash</div><div class="line">root       1934   1153 14 17:33 pts/0    00:03:35 /usr/local/jdk1.8.0_73/bin/java -XX:+UseParNewGC -XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFraction=75 -XX:+UseCMSInitiatingOccupancyOnly -XX:+DisableExplicitGC -Djava.awt.headless=true -Dfile.encoding=UTF-8 -XX:+HeapDumpOnOutOfMemoryError -Xmx1g -Xms256m -Xss2048k -Djffi.boot.library.path=/usr/share/logstash/vendor/jruby/lib/jni -Xbootclasspath/a:/usr/share/logstash/vendor/jruby/lib/jruby.jar -classpath : -Djruby.home=/usr/share/logstash/vendor/jruby -Djruby.lib=/usr/share/logstash/vendor/jruby/lib -Djruby.script=jruby -Djruby.shell=/bin/sh org.jruby.Main --1.9 /usr/share/logstash/lib/bootstrap/environment.rb logstash/runner.rb --path.settings /etc/logstash -e input &#123; stdin &#123; &#125; &#125; output &#123; stdout &#123;&#125; &#125;</div><div class="line">root       2012   1982  0 17:57 pts/2    00:00:00 grep logstash</div><div class="line">[root@ELK ~]#</div><div class="line">#Logstash日志文件位置</div><div class="line">[root@ELK ~]# tail -f /var/log/logstash/logstash-plain.log</div><div class="line">[2016-12-12T17:34:11,669][INFO ][logstash.agent           ] No config files found in path &#123;:path=&gt;"/etc/logstash/conf.d/*"&#125;</div><div class="line">[2016-12-12T17:34:12,498][INFO ][logstash.pipeline        ] Starting pipeline &#123;"id"=&gt;"main", "pipeline.workers"=&gt;1, "pipeline.batch.size"=&gt;125, "pipeline.batch.delay"=&gt;5, "pipeline.max_inflight"=&gt;125&#125;</div><div class="line">[2016-12-12T17:34:12,517][INFO ][logstash.pipeline        ] Pipeline main started</div><div class="line">[2016-12-12T17:34:13,000][INFO ][logstash.agent           ] Successfully started Logstash API endpoint &#123;:port=&gt;9600&#125;</div><div class="line">···</div></pre></td></tr></table></figure>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#简单测试2</span></div><div class="line">[root@<span class="type">ELK</span> ~]<span class="comment"># cat /etc/logstash/conf.d/test.conf </span></div><div class="line">input &#123;</div><div class="line">	<span class="literal">stdin</span> &#123;&#125;</div><div class="line">&#125;</div><div class="line">output &#123;</div><div class="line">	<span class="literal">stdout</span> &#123;</div><div class="line">		codec =&gt; rubydebug&#123;&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">[root@<span class="type">ELK</span> ~]<span class="comment">#</span></div><div class="line">[root@<span class="type">ELK</span> ~]<span class="comment"># /usr/share/logstash/bin/logstash --path.settings /etc/logstash -f /etc/logstash/conf.d/test.conf</span></div><div class="line"><span class="type">Sending</span> <span class="type">Logstash</span>'s logs to /<span class="keyword">var</span>/log/logstash which <span class="keyword">is</span> now configured via log4j2.properties</div><div class="line"><span class="type">The</span> <span class="literal">stdin</span> plugin <span class="keyword">is</span> now waiting <span class="keyword">for</span> input:</div><div class="line"></div><div class="line">&#123;</div><div class="line">    <span class="string">"@timestamp"</span> =&gt; <span class="number">2016</span>-<span class="number">12</span>-<span class="number">13</span>T09:<span class="number">24</span>:<span class="number">18</span>.<span class="number">123</span>Z,</div><div class="line">      <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,</div><div class="line">          <span class="string">"host"</span> =&gt; <span class="string">"0.0.0.0"</span>,</div><div class="line">       <span class="string">"message"</span> =&gt; <span class="string">""</span>,</div><div class="line">          <span class="string">"tags"</span> =&gt; []</div><div class="line">&#125;</div><div class="line">hello world</div><div class="line">&#123;</div><div class="line">    <span class="string">"@timestamp"</span> =&gt; <span class="number">2016</span>-<span class="number">12</span>-<span class="number">13</span>T09:<span class="number">24</span>:<span class="number">26</span>.<span class="number">328</span>Z,</div><div class="line">      <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,</div><div class="line">          <span class="string">"host"</span> =&gt; <span class="string">"0.0.0.0"</span>,</div><div class="line">       <span class="string">"message"</span> =&gt; <span class="string">"hello world"</span>,</div><div class="line">          <span class="string">"tags"</span> =&gt; []</div><div class="line">&#125;</div><div class="line"><span class="comment">#host 标记事件发生在哪里。</span></div><div class="line"><span class="comment">#type 标记事件的唯一类型。</span></div><div class="line"><span class="comment">#tags 标记事件的某方面属性。这是一个数组，一个事件可以有多个标签。</span></div><div class="line"><span class="comment">#注：每个 logstash 过滤插件，都会有四个方法叫 add_tag, remove_tag, add_field 和 remove_field。它们在插件过滤匹配成功时生效</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#后台运行Logstash</span></div><div class="line">1. nohup /usr/share/logstash/bin/logstash --path.settings /etc/logstash <span class="_">-f</span> /etc/logstash/conf.d/test.conf &amp;</div><div class="line">2. screen -S logstash_start</div><div class="line">screen会新开一个会话</div><div class="line">输入/usr/share/logstash/bin/logstash --path.settings /etc/logstash <span class="_">-f</span> /etc/logstash/conf.d/test.conf，按ctrl+A+D</div><div class="line">[root@ELK ~]<span class="comment"># ps -ef | grep logstash | grep -v grep</span></div><div class="line">root      11458      1  0 17:34 ?        00:00:00 SCREEN -S logstash_start</div><div class="line">root      11505  11459 55 17:35 pts/2    00:00:54 /usr/<span class="built_in">local</span>/jdk1.8.0_73/bin/java -XX:+UseParNewGC -XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFraction=75 -XX:+UseCMSInitiatingOccupancyOnly -XX:+DisableExplicitGC -Djava.awt.headless=<span class="literal">true</span> -Dfile.encoding=UTF-8 -XX:+HeapDumpOnOutOfMemoryError -Xmx1g -Xms256m -Xss2048k -Djffi.boot.library.path=/usr/share/logstash/vendor/jruby/lib/jni -Xbootclasspath/a:/usr/share/logstash/vendor/jruby/lib/jruby.jar -classpath : -Djruby.home=/usr/share/logstash/vendor/jruby -Djruby.lib=/usr/share/logstash/vendor/jruby/lib -Djruby.script=jruby -Djruby.shell=/bin/sh org.jruby.Main --1.9 /usr/share/logstash/lib/bootstrap/environment.rb logstash/runner.rb --path.settings /etc/logstash <span class="_">-f</span> /etc/logstash/conf.d/test.conf</div><div class="line">logstash  11554      1 79 17:36 ?        00:00:22 /usr/bin/java -XX:+UseParNewGC -XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFraction=75 -XX:+UseCMSInitiatingOccupancyOnly -XX:+DisableExplicitGC -Djava.awt.headless=<span class="literal">true</span> -Dfile.encoding=UTF-8 -XX:+HeapDumpOnOutOfMemoryError -Xmx1g -Xms256m -Xss2048k -Djffi.boot.library.path=/usr/share/logstash/vendor/jruby/lib/jni -Xbootclasspath/a:/usr/share/logstash/vendor/jruby/lib/jruby.jar -classpath : -Djruby.home=/usr/share/logstash/vendor/jruby -Djruby.lib=/usr/share/logstash/vendor/jruby/lib -Djruby.script=jruby -Djruby.shell=/bin/sh org.jruby.Main --1.9 /usr/share/logstash/lib/bootstrap/environment.rb logstash/runner.rb --path.settings /etc/logstash</div><div class="line">[root@ELK ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">logstash-output-stdout插件，最主要的用途是调试。在其不太有效时，加上命令行参数 -vv 运行，查看更多详细的调试信息</div></pre></td></tr></table></figure>
<h3 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q &amp; A"></a>Q &amp; A</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#如果启动多个logstash需要手动指定 --path.data /data/ELK_data/logstash/data_1.21_program 才行，否则报错.</span></div><div class="line"></div><div class="line">报错信息：Logstash could not be started because there is already another instance using the configured data directory.  If you wish to run multiple instances, you must change the <span class="string">"path.data"</span> setting.</div><div class="line"></div><div class="line">[root@ELK ~]<span class="comment"># /usr/share/logstash/bin/logstash --path.settings /etc/logstash/ -f /etc/logstash/conf.d/logstash_192.168.1.21.conf --path.data /data/ELK_data/logstash/data_1.21_program</span></div><div class="line">Sending Logstash<span class="string">'s logs to /data/ELK_data/logstash/logs which is now configured via log4j2.properties</span></div></pre></td></tr></table></figure>
<p>访问<a href="http://ip:5601打开kibana首页" target="_blank" rel="external">http://ip:5601打开kibana首页</a><br><img src="http://note.youdao.com/yws/api/personal/file/12B3FD77299D42BAB4FA2226F3C5EDF2?method=download&amp;shareKey=c514141f708fb56c52d0b33d4a40cf8d" alt="image">  </p>
<p>logstash流程图：<br><img src="http://note.youdao.com/yws/api/personal/file/C09204B066524EA4BC2893B6224E02A6?method=download&amp;shareKey=fe98a78bb4797c7d75f6e8d8350e7c4e" alt="image">  </p>
<p>===============================<br>Question1：如果日志里面报内核问题，可以忽略，我现在用的是Centos 6.6，内核是2.6，所以会报错..<br>参考：<a href="https://discuss.elastic.co/t/elasticsearch-warn-unable-to-install-syscall-filter/42819/1" target="_blank" rel="external">https://discuss.elastic.co/t/elasticsearch-warn-unable-to-install-syscall-filter/42819/1</a><br><img src="http://note.youdao.com/yws/api/personal/file/F11F2EFCDC334D0AA76BBE60643FD2EF?method=download&amp;shareKey=4b5f95081f8a0e4024ade293e181707d" alt="image">  </p>
<p>Question2：<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">需要对Java做软链接，链接到<span class="meta-keyword">/usr/</span>bin/java，否则安装logstash<span class="number">-5.1</span><span class="number">.1</span>.rpm时报错</div><div class="line"><span class="meta">#报错信息如下：↓↓↓↓↓↓↓↓↓</span></div><div class="line">Running Transaction</div><div class="line">  Installing : <span class="number">1</span>:logstash<span class="number">-5.1</span><span class="number">.1</span><span class="number">-1.</span>noarch                                                                                          <span class="number">1</span>/<span class="number">1</span> </div><div class="line">Using provided startup.options file: <span class="meta-keyword">/etc/</span>logstash/startup.options</div><div class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/logstash/</span>vendor<span class="meta-keyword">/jruby/</span>bin/jruby: line <span class="number">388</span>: <span class="meta-keyword">/usr/</span>bin/java: No such file or directory</div><div class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/logstash/</span>vendor<span class="meta-keyword">/jruby/</span>bin/jruby: line <span class="number">388</span>: exec: <span class="meta-keyword">/usr/</span>bin/java: cannot execute: No such file or directory</div><div class="line">Unable to install system startup script for Logstash.</div><div class="line">  Verifying  : <span class="number">1</span>:logstash<span class="number">-5.1</span><span class="number">.1</span><span class="number">-1.</span>noarch                                                                                          <span class="number">1</span>/<span class="number">1</span> </div><div class="line"><span class="symbol"></span></div><div class="line">Installed:</div><div class="line">  logstash.noarch <span class="number">1</span>:<span class="number">5.1</span><span class="number">.1</span><span class="number">-1</span>                                                                                                    </div><div class="line"></div><div class="line">Complete!</div><div class="line">[root@ELK ~]<span class="meta">#</span></div><div class="line"><span class="meta">#↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></div><div class="line">卸载重新安装logstash<span class="number">-5.1</span><span class="number">.1</span>.rpm即可</div><div class="line">[root@ELK ~]<span class="meta"># ln -s /usr/local/jdk1.8.0_73/bin/java /usr/bin/</span></div><div class="line">[root@ELK ~]<span class="meta"># whereis java</span></div><div class="line"><span class="symbol">java:</span> <span class="meta-keyword">/usr/</span>bin/java</div><div class="line">[root@ELK ~]<span class="meta">#</span></div></pre></td></tr></table></figure></p>
<p>Question3：简单测试时需要指定配置文件路径，yum否则报错<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root<span class="meta">@ELK</span> ~]# /usr/share/logstash/bin/logstash -e <span class="string">'input &#123; stdin &#123; &#125; &#125; output &#123; stdout &#123;&#125; &#125;'</span></div><div class="line">WARNING: Could not find logstash.yml which <span class="keyword">is</span> typically located <span class="keyword">in</span> $LS_HOME/config or /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults</div><div class="line">Could not find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using <span class="keyword">default</span> config which logs to console</div><div class="line">The stdin plugin <span class="keyword">is</span> now waiting <span class="keyword">for</span> input:</div><div class="line"><span class="number">17</span>:<span class="number">06</span>:<span class="number">57.595</span> [[main]-pipeline-manager] INFO  logstash.pipeline - Starting pipeline &#123;<span class="string">"id"</span>=&gt;<span class="string">"main"</span>, <span class="string">"pipeline.workers"</span>=&gt;<span class="number">1</span>, <span class="string">"pipeline.batch.size"</span>=&gt;<span class="number">125</span>, <span class="string">"pipeline.batch.delay"</span>=&gt;<span class="number">5</span>, <span class="string">"pipeline.max_inflight"</span>=&gt;<span class="number">125</span>&#125;</div><div class="line"><span class="number">17</span>:<span class="number">06</span>:<span class="number">57.607</span> [[main]-pipeline-manager] INFO  logstash.pipeline - Pipeline main started</div><div class="line"><span class="number">17</span>:<span class="number">06</span>:<span class="number">57.738</span> [Api Webserver] INFO  logstash.agent - Successfully started Logstash API endpoint &#123;:port=&gt;<span class="number">9600</span>&#125;</div><div class="line">hello world</div><div class="line"><span class="number">2016</span><span class="number">-12</span><span class="number">-12</span>T09:<span class="number">10</span>:<span class="number">08.651</span>Z <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> hello world</div><div class="line"><span class="number">17</span>:<span class="number">10</span>:<span class="number">14.145</span> [LogStash::Runner] WARN  logstash.agent - stopping pipeline &#123;:id=&gt;<span class="string">"main"</span>&#125;</div><div class="line">[root<span class="meta">@ELK</span> ~]#</div><div class="line">注：要加--path.settings /etc/logstash指定配置文件目录，否则报错↑↑↑</div><div class="line">正确方法：</div><div class="line">[root<span class="meta">@ELK</span> ~]# /usr/share/logstash/bin/logstash --path.settings /etc/logstash -e <span class="string">'input &#123; stdin &#123; &#125; &#125; output &#123; stdout &#123;&#125; &#125;'</span></div></pre></td></tr></table></figure></p>
<p>Question4：访问Kibana时返回502，如下图：<br>解决办法是：检查下当前电脑是否有打开翻墙软件或IE代理<br><img src="http://note.youdao.com/yws/api/personal/file/A89D2F7B081341BC98AF4D563A8071EE?method=download&amp;shareKey=9d88dec8bbae431f93f6609a4527fa43" alt="Kibana_502">  </p>
<p>附件：<br><a href="http://note.youdao.com/yws/api/personal/file/361B0F5AD67B4909A88EBA48DA8752E1?method=download&amp;shareKey=a693da8e5d71c8ee627cf20bef32b233" target="_blank" rel="external">logstash-5.1.1.rpm</a><br><a href="http://note.youdao.com/yws/api/personal/file/61BD9F64C30A40ED954AE45758804059?method=download&amp;shareKey=381ac62877d82b385f600470a6b81cc2" target="_blank" rel="external">kibana-5.1.1-x86_64.rpm</a><br><a href="http://note.youdao.com/yws/api/personal/file/35D87D7FF5394DDC8EDC3CEB84AC9295?method=download&amp;shareKey=73b2b4d7d169653b407798ceb90e837" target="_blank" rel="external">elasticsearch-5.1.1.rpm</a><br><a href="http://note.youdao.com/share/?id=79ab2b5e16b3d5b484023689fb07918e&amp;type=note#/" target="_blank" rel="external">jdk-8u73-linux-x64.gz</a></p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/11/22/ELK安装-基础/">http://www.yfshare.vip/2017/11/22/ELK安装-基础/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Logstash插件]]></title>
      <url>http://www.yfshare.vip/2017/11/18/Logstash%E6%8F%92%E4%BB%B6/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>Logstash插件主要分为（常用插件）：input、filter、output、Codec等<br><a id="more"></a><br>Logstash input plugins：<a href="https://www.elastic.co/guide/en/logstash/5.1/input-plugins.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/5.1/input-plugins.html</a><br>Logstash filter plugins：<a href="https://www.elastic.co/guide/en/logstash/5.1/filter-plugins.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/5.1/filter-plugins.html</a><br>Logstash output plugins：<a href="https://www.elastic.co/guide/en/logstash/5.1/output-plugins.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/5.1/output-plugins.html</a><br>Logstash Codec plugins：<a href="https://www.elastic.co/guide/en/logstash/5.1/codec-plugins.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/5.1/codec-plugins.html</a>  </p>
<p>环境：Centos 6.6<br>　　　ElasticSearch 5.1.1<br>　　　Logstash 5.1.1<br>　　　Kibana 5.1.1  </p>
<h4 id="Logstash的codec用法之Logstash展示Nginx日志"><a href="#Logstash的codec用法之Logstash展示Nginx日志" class="headerlink" title="Logstash的codec用法之Logstash展示Nginx日志"></a>Logstash的codec用法之Logstash展示Nginx日志</h4><p>参考：<a href="https://www.elastic.co/guide/en/logstash/5.1/codec-plugins.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/5.1/codec-plugins.html</a><br><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">#文件必须以.<span class="keyword">conf</span>结尾，因为Logstash默认扫描*.<span class="keyword">conf</span>文件</div><div class="line">[root@ELK ~]# <span class="keyword">cat</span> /etc/logstash/              #在用grok时可以直接调用<span class="keyword">conf</span>.<span class="keyword">d</span>/nginx.<span class="keyword">conf</span> </div><div class="line"><span class="keyword">input</span> &#123;</div><div class="line">	<span class="keyword">file</span> &#123;</div><div class="line">		path =&gt; [<span class="string">"/var/log/nginx/access.log"</span>]</div><div class="line">		<span class="keyword">type</span> =&gt; <span class="string">"nginx"</span></div><div class="line">		start_position =&gt; <span class="string">"beginning"</span>  #这里参数可以写beginning和end</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">output &#123;</div><div class="line">	stdout &#123;</div><div class="line">		codec =&gt; rubydebug&#123;&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">[root@ELK ~]#</div><div class="line">[root@ELK ~]# /usr/share/logstash/bin/logstash --path.settings /etc/logstash/ -f /etc/logstash/<span class="keyword">conf</span>.<span class="keyword">d</span>/nginx.<span class="keyword">conf</span> </div><div class="line">Sending Logstash's logs to /<span class="keyword">var</span>/<span class="keyword">log</span>/logstash <span class="keyword">which</span> is now configured via log4j2.properties</div><div class="line">&#123;</div><div class="line">          <span class="string">"path"</span> =&gt; <span class="string">"/var/log/nginx/access.log"</span>,</div><div class="line">    <span class="string">"@timestamp"</span> =&gt; 2016-12-14T03:39:56.805Z,</div><div class="line">      <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,</div><div class="line">          <span class="string">"host"</span> =&gt; <span class="string">"0.0.0.0"</span>,</div><div class="line">       <span class="string">"message"</span> =&gt; <span class="string">"192.168.31.100 - - [13/Dec/2016:18:22:21 +0800] \"</span>GET / HTTP/1.1\<span class="string">" 200 612 \"</span>-\<span class="string">" \"</span>curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.15.3 zlib/1.2.3 libidn/1.18 libssh2/1.4.2\<span class="string">" \"</span>-\<span class="string">""</span>,</div><div class="line">          <span class="string">"type"</span> =&gt; <span class="string">"nginx"</span>,</div><div class="line">          <span class="string">"tags"</span> =&gt; []</div><div class="line">&#125;</div><div class="line">....</div><div class="line">#当再次请求Nginx时（即Nginx access.<span class="keyword">log</span>日志再次输出时），会打印到屏幕</div></pre></td></tr></table></figure></p>
<p>注，beginning和end区别：<br><code>beginning是文件从头开始读取</code>，<code>end是读取最新内容</code>。第一次读取后会生成缓存文件 (隐藏文件)记录读取的进度，如：<code>.sincedb_d883144359d3b4f516b37dba51fab2a2(隐藏文件)</code>。rpm安装的在<code>/var/lib/logstash/plugins/inputs/file</code>这个目录下，具体位置需要搜索。  </p>
<h4 id="Logstash的codec插件之multiline用法"><a href="#Logstash的codec插件之multiline用法" class="headerlink" title="Logstash的codec插件之multiline用法"></a>Logstash的codec插件之multiline用法</h4><p>参考：<a href="https://www.elastic.co/guide/en/logstash/5.1/plugins-codecs-multiline.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/5.1/plugins-codecs-multiline.html</a><br><a href="https://kibana.logstash.es/content/logstash/plugins/codec/multiline.html" target="_blank" rel="external">https://kibana.logstash.es/content/logstash/plugins/codec/multiline.html</a>  </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">[root@ELK ~]<span class="comment"># cat /etc/logstash/conf.d/multiline.conf </span></div><div class="line">input &#123;</div><div class="line">	stdin &#123;</div><div class="line">		codec =&gt; multiline &#123;</div><div class="line">			pattern =&gt; <span class="string">"^\["</span></div><div class="line">			negate =&gt; <span class="keyword">true</span></div><div class="line">			what =&gt; <span class="string">"previous"</span></div><div class="line">			&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">output &#123;</div><div class="line">	stdout &#123;</div><div class="line">		codec =&gt; rubydebug&#123;&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">[root@ELK ~]<span class="comment">#</span></div><div class="line"><span class="comment">#测试配置文件语法</span></div><div class="line">[root@ELK ~]<span class="comment"># /usr/share/logstash/bin/logstash --path.settings /etc/logstash/ -f /etc/logstash/conf.d/multiline.conf -t</span></div><div class="line">Sending Logstash<span class="string">'s logs to /var/log/logstash which is now configured via log4j2.properties</span></div><div class="line">Configuration OK</div><div class="line">[root@ELK ~]#</div><div class="line">[root@ELK ~]# /usr/share/logstash/bin/logstash --path.settings /etc/logstash/ -f /etc/logstash/conf.d/multiline.conf</div><div class="line">Sending Logstash's logs to /<span class="keyword">var</span>/log/logstash which is now configured via log4j2.properties</div><div class="line">The stdin plugin is now waiting <span class="keyword">for</span> input:</div><div class="line">[hello world]</div><div class="line">[Windows of the world]</div><div class="line">&#123;</div><div class="line">    <span class="string">"@timestamp"</span> =&gt; <span class="number">2016</span><span class="number">-12</span><span class="number">-14</span>T07:<span class="number">53</span>:<span class="number">20.808</span>Z,</div><div class="line">      <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,</div><div class="line">          <span class="string">"host"</span> =&gt; <span class="string">"0.0.0.0"</span>,</div><div class="line">       <span class="string">"message"</span> =&gt; <span class="string">"[hello world]"</span>,</div><div class="line">          <span class="string">"tags"</span> =&gt; []</div><div class="line">&#125;</div><div class="line">Good mornning</div><div class="line">[</div><div class="line">&#123;</div><div class="line">    <span class="string">"@timestamp"</span> =&gt; <span class="number">2016</span><span class="number">-12</span><span class="number">-14</span>T07:<span class="number">54</span>:<span class="number">00.060</span>Z,</div><div class="line">      <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,</div><div class="line">          <span class="string">"host"</span> =&gt; <span class="string">"0.0.0.0"</span>,</div><div class="line">       <span class="string">"message"</span> =&gt; <span class="string">"[Windows of the world]\nGood mornning"</span>,</div><div class="line">          <span class="string">"tags"</span> =&gt; [</div><div class="line">        [<span class="number">0</span>] <span class="string">"multiline"</span></div><div class="line">    ]</div><div class="line">&#125;</div><div class="line"><span class="comment">#multiline插件是以“[”做标记，如果出现“[”，则把两个“[”之间的内容在message输出，“[”是结尾符</span></div></pre></td></tr></table></figure>
<h4 id="Logstash的filter插件之grok用法"><a href="#Logstash的filter插件之grok用法" class="headerlink" title="Logstash的filter插件之grok用法"></a>Logstash的filter插件之grok用法</h4><p>参考：<a href="https://www.elastic.co/guide/en/logstash/5.1/plugins-filters-grok.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/5.1/plugins-filters-grok.html</a><br><a href="http://kibana.logstash.es/content/logstash/plugins/filter/grok.html" target="_blank" rel="external">http://kibana.logstash.es/content/logstash/plugins/filter/grok.html</a>  </p>
<p>主要是做正则匹配，拆分<br>下面两个地址需要拨VPN才能访问：<br>官方提供的grok表达式：<a href="https://github.com/logstash-plugins/logstash-patterns-core/tree/master/patterns" target="_blank" rel="external">https://github.com/logstash-plugins/logstash-patterns-core/tree/master/patterns</a><br>grok在线调试：<a href="https://grokdebug.herokuapp.com/" target="_blank" rel="external">https://grokdebug.herokuapp.com/</a><br>grok正则表达式：<a href="https://github.com/logstash-plugins/logstash-patterns-core/blob/master/patterns/grok-patterns" target="_blank" rel="external">https://github.com/logstash-plugins/logstash-patterns-core/blob/master/patterns/grok-patterns</a><br>在用grok时可以直接调用，也可以自己写，如：<br><img src="http://note.youdao.com/yws/api/personal/file/9E3F41215A5B44F98B4DE31A1D194559?method=download&amp;shareKey=694a15483adc321844d8f3ac40ff77b7" alt="image">  </p>
<p>grok里正则在这里<a href="https://grokdebug.herokuapp.com/" target="_blank" rel="external">调试</a><br><img src="http://note.youdao.com/yws/api/personal/file/CBEC3EEBC35B457CBC28DFE516A32D28?method=download&amp;shareKey=fe1269199d3998d52b92fdb53814dc6f" alt="image">  </p>
<p>#日志内容本身都是一个类似于key-value 的格式，但是格式具体的样式却是多种多样的。logstash提供filters/kv插件，帮助处理不同样式的key-value日志，变成实际的LogStash::Event数据。  </p>
<p>#kv没用会，下面是摘抄的示例<br><a href="https://kibana.logstash.es/content/logstash/plugins/filter/kv.html" target="_blank" rel="external">https://kibana.logstash.es/content/logstash/plugins/filter/kv.html</a><br><a href="https://www.elastic.co/guide/en/logstash/current/plugins-filters-kv.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/current/plugins-filters-kv.html</a><br><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line">#解析<span class="keyword">test</span>.<span class="keyword">log</span>文件内容</div><div class="line">[root@ELK ~]# <span class="keyword">cat</span> /root/<span class="keyword">test</span>.<span class="keyword">log</span> </div><div class="line">192.168.31.105 - - [14/<span class="keyword">Dec</span>/2016:15:17:56 +0800] <span class="string">"GET / HTTP/1.1"</span> 304 0 <span class="string">"-"</span> <span class="string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/47.0.2526.106 Safari/537.36"</span> <span class="string">"-"</span></div><div class="line">[root@ELK ~]#</div><div class="line">[root@ELK ~]# <span class="keyword">cat</span> /etc/logstash/<span class="keyword">conf</span>.<span class="keyword">d</span>/samp.<span class="keyword">conf</span> </div><div class="line"><span class="keyword">input</span> &#123;</div><div class="line">	<span class="keyword">file</span> &#123;</div><div class="line">		path =&gt; <span class="string">"/root/test.log"</span></div><div class="line">		start_position =&gt; <span class="string">"beginning"</span></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">filter &#123;</div><div class="line">	grok &#123;</div><div class="line">		match =&gt; [<span class="string">"message"</span>,<span class="string">"%&#123;IPV4:remote_addr&#125; \- %&#123;USERNAME:remote_user&#125; \[%&#123;DATA:time_local&#125;\] (?&lt;http_request&gt;\"</span>[A-Za-z][A-Za-z]+\s*\/\s*[A-Za-z][A-Za-z]+\/[0-9][0-9]*\.[0-9][0-9]*\<span class="string">") (?&lt;status&gt;[0-9][0-9]*) (?&lt;body_bytes_sent&gt;[0-9][0-9]*) (?&lt;http_referer&gt;\"</span>[\s\S]*?\<span class="string">") (?&lt;http_user_agent&gt;\"</span>[\s\S]*?\<span class="string">") (?&lt;http_x_forwarded_for&gt;\"</span>[\s\S]*?\<span class="string">")"</span>]</div><div class="line">	&#125;</div><div class="line">    kv &#123;</div><div class="line">        source =&gt; <span class="string">"http_user_agent"</span></div><div class="line">        field_split =&gt; <span class="string">";"</span></div><div class="line">        value_split =&gt; <span class="string">"="</span></div><div class="line">        remove_field =&gt; [ <span class="string">"\\"</span>"]</div><div class="line">        &#125;</div><div class="line">	urldecode &#123;</div><div class="line">		all_fields =&gt; true</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">#这里的kv插件好像没有效果额..，kv适合有规律的拆分</div><div class="line">output &#123;</div><div class="line">	stdout &#123;</div><div class="line">		codec =&gt; rubydebug</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">[root@ELK ~]#</div><div class="line">[root@ELK ~]# /usr/share/logstash/bin/logstash --path.settings /etc/logstash/ -f /etc/logstash/<span class="keyword">conf</span>.<span class="keyword">d</span>/samp.<span class="keyword">conf</span> -t</div><div class="line">Sending Logstash's logs to /<span class="keyword">var</span>/<span class="keyword">log</span>/logstash <span class="keyword">which</span> is now configured via log4j2.properties</div><div class="line">Configuration OK</div><div class="line">[root@ELK ~]# /usr/share/logstash/bin/logstash --path.settings /etc/logstash/ -f /etc/logstash/<span class="keyword">conf</span>.<span class="keyword">d</span>/samp.<span class="keyword">conf</span></div><div class="line">Sending Logstash's logs to /<span class="keyword">var</span>/<span class="keyword">log</span>/logstash <span class="keyword">which</span> is now configured via log4j2.properties</div><div class="line">&#123;</div><div class="line">             <span class="string">"remote_addr"</span> =&gt; <span class="string">"192.168.31.105"</span>,</div><div class="line">         <span class="string">"body_bytes_sent"</span> =&gt; <span class="string">"0"</span>,</div><div class="line">              <span class="string">"time_local"</span> =&gt; <span class="string">"14/Dec/2016:15:17:56 +0800"</span>,</div><div class="line">                 <span class="string">"message"</span> =&gt; <span class="string">"192.168.31.105 - - [14/Dec/2016:15:17:56 +0800] \"</span>GET / HTTP/1.1\<span class="string">" 304 0 \"</span>-\<span class="string">" \"</span>Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/47.0.2526.106 Safari/537.36\<span class="string">" \"</span>-\<span class="string">""</span>,</div><div class="line">                    <span class="string">"tags"</span> =&gt; [],</div><div class="line">         <span class="string">"http_user_agent"</span> =&gt; <span class="string">"\"</span>Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/47.0.2526.106 Safari/537.36\<span class="string">""</span>,</div><div class="line">             <span class="string">"remote_user"</span> =&gt; <span class="string">"-"</span>,</div><div class="line">                    <span class="string">"path"</span> =&gt; <span class="string">"/root/test.log"</span>,</div><div class="line">              <span class="string">"@timestamp"</span> =&gt; 2016-12-14T16:05:20.443Z,</div><div class="line">            <span class="string">"http_referer"</span> =&gt; <span class="string">"\"</span>-\<span class="string">""</span>,</div><div class="line">                <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,</div><div class="line">                    <span class="string">"host"</span> =&gt; <span class="string">"0.0.0.0"</span>,</div><div class="line">    <span class="string">"http_x_forwarded_for"</span> =&gt; <span class="string">"\"</span>-\<span class="string">""</span>,</div><div class="line">            <span class="string">"http_request"</span> =&gt; <span class="string">"\"</span>GET / HTTP/1.1\<span class="string">""</span>,</div><div class="line">                  <span class="string">"status"</span> =&gt; <span class="string">"304"</span></div><div class="line">&#125;</div><div class="line">...</div><div class="line">[root@ELK ~]#</div><div class="line">#Logstash日志输出</div><div class="line">[root@ELK ~]# tail -f /<span class="keyword">var</span>/<span class="keyword">log</span>/logstash/logstash-plain.<span class="keyword">log</span> </div><div class="line">[2016-12-15T00:02:28,195][INFO ][logstash.runner          ] Using config.test_and_exit mode. Config Validation Result: OK. Exiting Logstash</div><div class="line">[2016-12-15T00:05:21,397][INFO ][logstash.pipeline        ] Starting pipeline &#123;<span class="string">"id"</span>=&gt;<span class="string">"main"</span>, <span class="string">"pipeline.workers"</span>=&gt;1, <span class="string">"pipeline.batch.size"</span>=&gt;125, <span class="string">"pipeline.batch.delay"</span>=&gt;5, <span class="string">"pipeline.max_inflight"</span>=&gt;125&#125;</div><div class="line">[2016-12-15T00:05:21,477][INFO ][logstash.pipeline        ] Pipeline main started</div><div class="line">[2016-12-15T00:05:22,156][INFO ][logstash.agent           ] Successfully started Logstash API endpoint &#123;:port=&gt;9600&#125;</div><div class="line">...</div><div class="line">[root@ELK ~]#</div></pre></td></tr></table></figure></p>
<p>示例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">filter &#123;</div><div class="line">    ruby &#123;</div><div class="line">        init =&gt; <span class="string">"@kname = ['method','uri','verb']"</span></div><div class="line">        code =&gt; <span class="string">"</span></div><div class="line">            new_event = LogStash::Event.new(Hash[@kname.zip(event.get('request').split('|'))])</div><div class="line">            new_event.remove('@timestamp')</div><div class="line">            event.append(new_event)</div><div class="line">        "</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> [uri] &#123;</div><div class="line">        ruby &#123;</div><div class="line">            init =&gt; <span class="string">"@kname = ['url_path','url_args']"</span></div><div class="line">            code =&gt; <span class="string">"</span></div><div class="line">                new_event = LogStash::Event.new(Hash[@kname.zip(event.get('uri').split('?'))])</div><div class="line">                new_event.remove('@timestamp')</div><div class="line">                event.append(new_event)</div><div class="line">            "</div><div class="line">        &#125;</div><div class="line">        kv &#123;</div><div class="line">            prefix =&gt; <span class="string">"url_"</span></div><div class="line">            <span class="built_in">source</span> =&gt; <span class="string">"url_args"</span></div><div class="line">            field_split =&gt; <span class="string">"&amp;"</span></div><div class="line">            remove_field =&gt; [ <span class="string">"url_args"</span>, <span class="string">"uri"</span>, <span class="string">"request"</span> ]</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#解释</span></div><div class="line">Nginx 访问日志中的 <span class="variable">$request</span>，通过这段配置，可以详细切分成 method, url_path, verb, url_a, url_b ...</div><div class="line"></div><div class="line">进一步的，如果 url_args 中有过多字段，可能导致 Elasticsearch 集群因为频繁 update mapping 或者消耗太多内存在 cluster state 上而宕机。所以，更优的选择，是只保留明确有用的 url_args 内容，其他部分舍去</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">kv &#123;</div><div class="line">    prefix =&gt; <span class="string">"url_"</span></div><div class="line">    <span class="built_in">source</span> =&gt; <span class="string">"url_args"</span></div><div class="line">    field_split =&gt; <span class="string">"&amp;"</span></div><div class="line">    include_keys =&gt; [ <span class="string">"uid"</span>, <span class="string">"cip"</span> ]</div><div class="line">    remove_field =&gt; [ <span class="string">"url_args"</span>, <span class="string">"uri"</span>, <span class="string">"request"</span> ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#grok分析/var/log/secure日志</span></div><div class="line">input &#123;</div><div class="line">   file &#123;</div><div class="line">	path =&gt; [<span class="string">"/var/log/secure"</span>]</div><div class="line">	start_position =&gt; <span class="string">"end"</span></div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">filter &#123;</div><div class="line">		grok &#123;</div><div class="line">   			match =&gt; [<span class="string">"message"</span>,<span class="string">".* sshd\[\d+\]: (?&lt;status&gt;\S+) .* (?&lt;ClientIP&gt;(?:\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;)?) .*"</span>]</div><div class="line">		&#125;</div><div class="line">&#125;</div><div class="line">output &#123;</div><div class="line">    stdout &#123;</div><div class="line">		codec =&gt; rubydebug&#123;&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Logstash的filter插件之json用法"><a href="#Logstash的filter插件之json用法" class="headerlink" title="Logstash的filter插件之json用法"></a>Logstash的filter插件之json用法</h4><p>参考：<a href="https://www.elastic.co/guide/en/logstash/5.1/plugins-filters-json.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/5.1/plugins-filters-json.html</a><br><a href="https://kibana.logstash.es/content/logstash/plugins/filter/json.html" target="_blank" rel="external">https://kibana.logstash.es/content/logstash/plugins/filter/json.html</a><br><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line">#修改Nginx日志格式</div><div class="line">[root@ELK ~]# head -32 /etc/nginx/nginx.<span class="keyword">conf</span> | tail -15</div><div class="line">#    log_format  main  '<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] <span class="string">"$request"</span> '</div><div class="line">#                      '<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> <span class="string">"$http_referer"</span> '</div><div class="line">#                      '<span class="string">"$http_user_agent"</span> <span class="string">"$http_x_forwarded_for"</span>';</div><div class="line"></div><div class="line">    log_format json '&#123;<span class="string">"clinet"</span>:<span class="string">"$remote_addr"</span>,'</div><div class="line">		'<span class="string">"@timestamp"</span>:<span class="string">"$time_iso8601"</span>,'</div><div class="line">		'<span class="string">"@version"</span>:<span class="string">"1"</span>,'</div><div class="line">		'<span class="string">"host"</span>:<span class="string">"$server_addr"</span>,'</div><div class="line">		'<span class="string">"size"</span>:<span class="variable">$body_bytes_sent</span>,'</div><div class="line">		'<span class="string">"responsetime"</span>:<span class="variable">$request_time</span>,'</div><div class="line">		'<span class="string">"domain"</span>:<span class="string">"$host"</span>,'</div><div class="line">		'<span class="string">"status"</span>:<span class="string">"$status"</span>,'</div><div class="line">		'<span class="string">"ua"</span>:<span class="string">"$http_user_agent"</span>&#125;';</div><div class="line"></div><div class="line">    access_log  /<span class="keyword">var</span>/<span class="keyword">log</span>/nginx/access.<span class="keyword">log</span>  json;</div><div class="line">[root@ELK ~]#</div><div class="line">[root@ELK ~]# <span class="keyword">cat</span> /etc/logstash/<span class="keyword">conf</span>.<span class="keyword">d</span>/json.<span class="keyword">conf</span> </div><div class="line"><span class="keyword">input</span> &#123;</div><div class="line">	<span class="keyword">file</span> &#123;</div><div class="line">		path =&gt; [<span class="string">"/var/log/nginx/access.log"</span>]</div><div class="line">		<span class="keyword">type</span> =&gt; <span class="string">"Nginx"</span></div><div class="line">		start_position =&gt; <span class="string">"end"</span></div><div class="line">		codec =&gt; json</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">output &#123;</div><div class="line">	stdout &#123;</div><div class="line">		codec =&gt; rubydebug&#123;&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">[root@ELK ~]#</div><div class="line">[root@ELK ~]# /usr/share/logstash/bin/logstash --path.settings /etc/logstash/ -f /etc/logstash/<span class="keyword">conf</span>.<span class="keyword">d</span>/json.<span class="keyword">conf</span> -t</div><div class="line">Sending Logstash's logs to /<span class="keyword">var</span>/<span class="keyword">log</span>/logstash <span class="keyword">which</span> is now configured via log4j2.properties</div><div class="line">Configuration OK</div><div class="line">[root@ELK ~]#</div><div class="line">[root@ELK ~]# /usr/share/logstash/bin/logstash --path.settings /etc/logstash/ -f /etc/logstash/<span class="keyword">conf</span>.<span class="keyword">d</span>/json.<span class="keyword">conf</span></div><div class="line">Sending Logstash's logs to /<span class="keyword">var</span>/<span class="keyword">log</span>/logstash <span class="keyword">which</span> is now configured via log4j2.properties</div><div class="line">&#123;</div><div class="line">            <span class="string">"path"</span> =&gt; <span class="string">"/var/log/nginx/access.log"</span>,</div><div class="line">      <span class="string">"@timestamp"</span> =&gt; 2016-12-15T07:33:00.000Z,</div><div class="line">            <span class="string">"size"</span> =&gt; 0,</div><div class="line">          <span class="string">"domain"</span> =&gt; <span class="string">"192.168.31.100"</span>,</div><div class="line">        <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,</div><div class="line">            <span class="string">"host"</span> =&gt; <span class="string">"192.168.31.100"</span>,</div><div class="line">    <span class="string">"responsetime"</span> =&gt; 0.0,</div><div class="line">              <span class="string">"ua"</span> =&gt; <span class="string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/47.0.2526.106 Safari/537.36"</span>,</div><div class="line">            <span class="string">"type"</span> =&gt; <span class="string">"Nginx"</span>,</div><div class="line">          <span class="string">"clinet"</span> =&gt; <span class="string">"192.168.31.105"</span>,</div><div class="line">          <span class="string">"status"</span> =&gt; <span class="string">"304"</span>,</div><div class="line">            <span class="string">"tags"</span> =&gt; []</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Logstash的filter插件之geoip用法"><a href="#Logstash的filter插件之geoip用法" class="headerlink" title="Logstash的filter插件之geoip用法"></a>Logstash的filter插件之geoip用法</h4><p>参考：<a href="https://www.elastic.co/guide/en/logstash/5.1/plugins-filters-geoip.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/5.1/plugins-filters-geoip.html</a><br><a href="https://kibana.logstash.es/content/logstash/plugins/filter/geoip.html" target="_blank" rel="external">https://kibana.logstash.es/content/logstash/plugins/filter/geoip.html</a><br>GeoIP 是最常见的免费IP地址归类查询库<br><figure class="highlight puppet"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># logstash v5.6.4</span></div><div class="line"><span class="comment"># logstash 配置文件</span></div><div class="line"><span class="comment"># cat logstash_10.20.conf</span></div><div class="line"><span class="keyword">input</span> &#123;</div><div class="line">   file &#123;</div><div class="line">	<span class="attr">path</span> =&gt; [<span class="string">"/root/test.log"</span>]</div><div class="line">	<span class="attr">start_position</span> =&gt; <span class="string">"end"</span></div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">filter</span> &#123;</div><div class="line">	grok &#123;</div><div class="line">   		<span class="attr">match</span> =&gt; [<span class="string">"message"</span>,<span class="string">"%&#123;IPV4:remote_addr&#125; [\-] %&#123;USERNAME:remote_user&#125; \[%&#123;DATA:time_local&#125;\] \"(?&lt;request&gt;[^\"]*)\" (?&lt;status&gt;\d+) (?&lt;body_bytes_sent&gt;\d+) \"(?&lt;http_referer&gt;[^\"]*)\" \"(?&lt;http_user_agent&gt;[^\"]*)\" \"%&#123;IPV4:http_x_forwarded_for&#125;"</span>]	&#125;</div><div class="line">	<span class="keyword">geoip</span> &#123;</div><div class="line">		<span class="attr">source</span> =&gt; <span class="string">"http_x_forwarded_for"</span></div><div class="line">		<span class="attr">fields</span> =&gt; [<span class="string">"ip"</span>,<span class="string">"city_name"</span>,<span class="string">"country_name"</span>,<span class="string">"location"</span>,<span class="string">"latitude"</span>,<span class="string">"longitude"</span>,<span class="string">"timezone"</span>,<span class="string">"region_name"</span>]</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">output</span> &#123;</div><div class="line">	stdout &#123;</div><div class="line">		<span class="attr">codec</span> =&gt; rubydebug&#123;&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#nginx 日志</span></div><div class="line">100.116.46.20 - - [15/Nov/2017:11:59:34 +0800] <span class="string">"GET /static/js/util/plugins/cordova-plugin-geolocation/www/geolocation.js HTTP/1.0"</span> 200 8629 <span class="string">"https://qian.julend.com/static/pageHtml/loan.html?s_qian=iOS"</span> <span class="string">"Mozilla/5.0 (iPhone; CPU iPhone OS 10_3_3 like Mac OS X) AppleWebKit/603.3.8 (KHTML, like Gecko) Mobile/14G60 GrowingIO/0.9.47-20170111143620 (4303466304)"</span> <span class="string">"27.8.223.7"</span></div><div class="line"></div><div class="line"><span class="comment">#nginx grok匹配</span></div><div class="line">%&#123;IPV4:remote_addr&#125; [\-] %&#123;USERNAME:remote_user&#125; \[%&#123;DATA:time_local&#125;\] \<span class="string">"(?&lt;request&gt;[^\"]*)\" (?&lt;status&gt;\d+) (?&lt;body_bytes_sent&gt;\d+) \"(?&lt;http_referer&gt;[^\"]*)\" \"(?&lt;http_user_agent&gt;[^\"]*)\" \"%&#123;IPV4:http_x_forwarded_for&#125;</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># /usr/share/logstash/bin/logstash --path.settings /etc/logstash/ -f /etc/logstash/conf.d/logstash_10.20.conf --path.data /data/elk_data/logstash/</span></div><div class="line">dataSending Logstash<span class="string">'s logs to /data/elk_data/logstash/logs which is now configured via log4j2.properties</span></div><div class="line">&#123;</div><div class="line">             "remote_addr" =&gt; "100.116.46.20",</div><div class="line">                 "request" =&gt; "GET /static/js/util/plugins/cordova-plugin-geolocation/www/geolocation.js HTTP/1.0",</div><div class="line">                   "geoip" =&gt; &#123;</div><div class="line">           "city_name" =&gt; "Chongqing",</div><div class="line">            "timezone" =&gt; "Asia/Shanghai",</div><div class="line">                  "ip" =&gt; "27.8.223.7",</div><div class="line">            "latitude" =&gt; 29.5628,</div><div class="line">        "country_name" =&gt; "China",</div><div class="line">         "region_name" =&gt; "Chongqing",</div><div class="line">            "location" =&gt; &#123;</div><div class="line">            "lon" =&gt; 106.5528,</div><div class="line">            "lat" =&gt; 29.5628</div><div class="line">        &#125;,</div><div class="line">           "longitude" =&gt; 106.5528</div><div class="line">    &#125;,</div><div class="line">         "body_bytes_sent" =&gt; "8629",</div><div class="line">              "time_local" =&gt; "15/Nov/2017:11:59:34 +0800",</div><div class="line">                 "message" =&gt; "100.116.46.20 - - [15/Nov/2017:11:59:34 +0800] \"GET /static/js/util/plugins/cordova-plugin-geolocation/www/geolocation.js HTTP/1.0\" 200 8629 \"https://qian.julend.com/static/pageHtml/loan.html?s_qian=iOS\" \"Mozilla/5.0 (iPhone; CPU iPhone OS 10_3_3 like Mac OS X) AppleWebKit/603.3.8 (KHTML, like Gecko) Mobile/14G60 GrowingIO/0.9.47-20170111143620 (4303466304)\" \"27.8.223.7\"",</div><div class="line">         "http_user_agent" =&gt; "Mozilla/5.0 (iPhone; CPU iPhone OS 10_3_3 like Mac OS X) AppleWebKit/603.3.8 (KHTML, like Gecko) Mobile/14G60 GrowingIO/0.9.47-20170111143620(4303466304)", </div><div class="line">             "remote_user" =&gt; "-",</div><div class="line">                    "path" =&gt; "/root/test.log",</div><div class="line">              "@timestamp" =&gt; 2017-11-15T06:16:03.829Z,</div><div class="line">            "http_referer" =&gt; "https://qian.julend.com/static/pageHtml/loan.html?s_qian=iOS",</div><div class="line">                "@version" =&gt; "1",</div><div class="line">                    "host" =&gt; "elk-cluster3",</div><div class="line">    "http_x_forwarded_for" =&gt; "27.8.223.7",</div><div class="line">                  "status" =&gt; "200"</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 去掉geoip后，nginx日志拆分</span></div><div class="line">&#123;</div><div class="line">             <span class="string">"remote_addr"</span> =&gt; <span class="string">"100.116.46.20"</span>,</div><div class="line">                 <span class="string">"request"</span> =&gt; <span class="string">"GET /static/js/util/plugins/cordova-plugin-geolocation/www/geolocation.js HTTP/1.0"</span>,</div><div class="line">         <span class="string">"body_bytes_sent"</span> =&gt; <span class="string">"8629"</span>,</div><div class="line">              <span class="string">"time_local"</span> =&gt; <span class="string">"15/Nov/2017:10:59:34 +0800"</span>,</div><div class="line">                 <span class="string">"message"</span> =&gt; <span class="string">"100.116.46.20 - - [15/Nov/2017:10:59:34 +0800] \"GET /static/js/util/plugins/cordova-plugin-geolocation/www/geolocation.js HTTP/1.0\" 200 8629 \"https://qian.julend.com/static/pageHtml/loan.html?s_qian=iOS\" \"Mozilla/5.0 (iPhone; CPU iPhone OS 10_3_3 like Mac OS X) AppleWebKit/603.3.8 (KHTML, like Gecko) Mobile/14G60 GrowingIO/0.9.47-20170111143620 (4303466304)\" \"27.8.223.7\""</span>,</div><div class="line">         <span class="string">"http_user_agent"</span> =&gt; <span class="string">"Mozilla/5.0 (iPhone; CPU iPhone OS 10_3_3 like Mac OS X) AppleWebKit/603.3.8 (KHTML, like Gecko) Mobile/14G60 GrowingIO/0.9.47-20170111143620 (4303466304)"</span>,</div><div class="line">             <span class="string">"remote_user"</span> =&gt; <span class="string">"-"</span>,</div><div class="line">                    <span class="string">"path"</span> =&gt; <span class="string">"/root/test.log"</span>,</div><div class="line">              <span class="string">"@timestamp"</span> =&gt; 2017-11-15T06:01:24.940Z,</div><div class="line">            <span class="string">"http_referer"</span> =&gt; <span class="string">"https://qian.julend.com/static/pageHtml/loan.html?s_qian=iOS"</span>,</div><div class="line">                <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,</div><div class="line">                    <span class="string">"host"</span> =&gt; <span class="string">"elk-cluster3"</span>,</div><div class="line">    <span class="string">"http_x_forwarded_for"</span> =&gt; <span class="string">"27.8.223.7"</span>,</div><div class="line">                  <span class="string">"status"</span> =&gt; <span class="string">"200"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Logstash的filter插件之date时间处理"><a href="#Logstash的filter插件之date时间处理" class="headerlink" title="Logstash的filter插件之date时间处理"></a>Logstash的filter插件之date时间处理</h4><p>参考：<a href="https://www.elastic.co/guide/en/logstash/5.6/plugins-filters-date.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/5.6/plugins-filters-date.html</a><br><a href="https://kibana.logstash.es/content/logstash/plugins/filter/date.html" target="_blank" rel="external">https://kibana.logstash.es/content/logstash/plugins/filter/date.html</a><br>filters/date 插件可以用来转换你的日志记录中的时间字符串，变成 LogStash::Timestamp 对象，然后转存到 @timestamp 字段里<br><code>注意：因为在稍后的 outputs/elasticsearch 中常用的 %{+YYYY.MM.dd} 这种写法必须读取 @timestamp 数据，所以一定不要直接删掉这个字段保留自己的字段，而是应该用 filters/date 转换后删除自己的字段！</code>  </p>
<p><code>建议打开 Nginx 的 access_log 配置项的 buffer 参数，对极限响应性能有极大提升！</code></p>
<p>filters/date 插件支持五种时间格式  </p>
<ul>
<li>ISO8601<br>类似 “2011-04-19T03:44:01.103Z” 这样的格式。具体Z后面可以有 “08:00”也可以没有，”.103”这个也可以没有。常用场景里来说，Nginx 的 log_format 配置里就可以使用 $time_iso8601 变量来记录请求时间成这种格式。  </li>
<li>UNIX<br>UNIX 时间戳格式，记录的是从 1970 年起始至今的总秒数。Squid 的默认日志格式中就使用了这种格式。  </li>
<li>UNIX_MS<br>这个时间戳则是从 1970 年起始至今的总毫秒数。据我所知，JavaScript 里经常使用这个时间格式。  </li>
<li>TAI64N<br>TAI64N 格式比较少见，是这个样子的：@4000000052f88ea32489532c。我目前只知道常见应用中， qmail 会用这个格式。  </li>
<li>Joda-Time 库<br>Logstash 内部使用了 Java 的 Joda 时间库来作时间处理。所以我们可以使用 Joda 库所支持的时间格式来作具体定义。Joda 时间格式定义见下表：</li>
</ul>
<p>时间格式：  </p>
<table>
<thead>
<tr>
<th>Symbol</th>
<th>Meaning</th>
<th>Presentation</th>
<th>Examples</th>
</tr>
</thead>
<tbody>
<tr>
<td>G</td>
<td>era</td>
<td>text</td>
<td>AD</td>
</tr>
<tr>
<td>C</td>
<td>century of era (&gt;=0)</td>
<td>number</td>
<td>20</td>
</tr>
<tr>
<td>Y</td>
<td>year of era (&gt;=0)</td>
<td>year</td>
<td>1996</td>
</tr>
<tr>
<td>x</td>
<td>weekyear</td>
<td>year</td>
<td>1996</td>
</tr>
<tr>
<td>w</td>
<td>week of weekyear</td>
<td>number</td>
<td>27</td>
</tr>
<tr>
<td>e</td>
<td>day of week</td>
<td>number</td>
<td>2</td>
</tr>
<tr>
<td>E</td>
<td>day of week</td>
<td>text</td>
<td>Tuesday; Tue</td>
</tr>
<tr>
<td>y</td>
<td>year</td>
<td>year</td>
<td>1996</td>
</tr>
<tr>
<td>D</td>
<td>day of year</td>
<td>number</td>
<td>189</td>
</tr>
<tr>
<td>M</td>
<td>month of year</td>
<td>month</td>
<td>July; Jul; 07</td>
</tr>
<tr>
<td>d</td>
<td>day of month</td>
<td>number</td>
<td>10</td>
</tr>
<tr>
<td>a</td>
<td>halfday of day</td>
<td>text</td>
<td>PM</td>
</tr>
<tr>
<td>K</td>
<td>hour of halfday (0~11)</td>
<td>number</td>
<td>0</td>
</tr>
<tr>
<td>h</td>
<td>clockhour of halfday (1~12)</td>
<td>number</td>
<td>12</td>
</tr>
<tr>
<td>H</td>
<td>hour of day (0~23)</td>
<td>number</td>
<td>0</td>
</tr>
<tr>
<td>k</td>
<td>clockhour of day (1~24)</td>
<td>number</td>
<td>24</td>
</tr>
<tr>
<td>m</td>
<td>minute of hour</td>
<td>number</td>
<td>30</td>
</tr>
<tr>
<td>s</td>
<td>second of minute</td>
<td>number</td>
<td>55</td>
</tr>
<tr>
<td>S</td>
<td>fraction of second</td>
<td>number</td>
<td>978</td>
</tr>
<tr>
<td>z</td>
<td>time zone</td>
<td>text</td>
<td>Pacific Standard Time; PST</td>
</tr>
<tr>
<td>Z</td>
<td>time zone offset/id</td>
<td>zone</td>
<td>-0800; -08:00; America/Los_Angeles</td>
</tr>
<tr>
<td>‘</td>
<td>escape for text</td>
<td>delimiter</td>
<td></td>
</tr>
<tr>
<td>‘’</td>
<td>single quote</td>
<td>literal</td>
<td>‘</td>
</tr>
</tbody>
</table>
<p><a href="http://joda-time.sourceforge.net/apidocs/org/joda/time/format/DateTimeFormat.html" target="_blank" rel="external">http://joda-time.sourceforge.net/apidocs/org/joda/time/format/DateTimeFormat.html</a>  </p>
<p>Joda 时间格式的配置：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">filter &#123;</div><div class="line">    grok &#123;</div><div class="line">        match =&gt; [<span class="string">"message"</span>, <span class="string">"%&#123;HTTPDATE:logdate&#125;"</span>]</div><div class="line">    &#125;</div><div class="line">    date &#123;</div><div class="line">        match =&gt; [<span class="string">"logdate"</span>, <span class="string">"dd/MMM/yyyy:HH:mm:ss Z"</span>]</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>注意：时区偏移量只需要用一个字母 <code>Z</code> 即可  </p>
<h4 id="Logstash的filter插件之secure日志切割"><a href="#Logstash的filter插件之secure日志切割" class="headerlink" title="Logstash的filter插件之secure日志切割"></a>Logstash的filter插件之secure日志切割</h4><p>参考：<a href="https://www.elastic.co/guide/en/logstash/5.6/plugins-filters-mutate.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/5.6/plugins-filters-mutate.html</a><br>这个需要配合filebeat操作<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># grep -iv '#' /etc/filebeat/filebeat.yml |grep -iv '^$'</span></div><div class="line">filebeat.prospectors:</div><div class="line">- input_type: <span class="built_in">log</span></div><div class="line">  paths:</div><div class="line">    - /var/<span class="built_in">log</span>/secure</div><div class="line">  document_type: secure_2.250</div><div class="line">  exclude_lines: [<span class="string">"system"</span>]      <span class="comment">#过滤不含system日志</span></div><div class="line">  include_lines: [<span class="string">"Accepted"</span>]    <span class="comment">#过滤含Accepted的日志</span></div><div class="line">output.logstash:</div><div class="line">  hosts: [<span class="string">"192.168.1.41:5044"</span>]</div><div class="line"><span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#logstash配置文件</span></div><div class="line"><span class="comment"># cat logstash_test.conf</span></div><div class="line">input &#123;</div><div class="line">	beats &#123;</div><div class="line">		port =&gt; 5045</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">filter &#123;</div><div class="line">	<span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">'secure_2.250'</span>&#123;</div><div class="line">		grok &#123;</div><div class="line">   			match =&gt; [<span class="string">"message"</span>,<span class="string">".* sshd\[\d+\]: (?&lt;status&gt;\S+) .* (?&lt;ClientIP&gt;(?:\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;)?) .*"</span>]        <span class="comment">#正则过滤secure日志，且赋值到message字段</span></div><div class="line">		&#125;</div><div class="line"> 		mutate&#123;</div><div class="line">     			split =&gt; [<span class="string">"message"</span>,<span class="string">" "</span>]     <span class="comment">#把message字段以空格拆分，message字段的值来自grok</span></div><div class="line">	        	add_field =&gt;   &#123;</div><div class="line">        	    		<span class="string">"username"</span> =&gt; <span class="string">"%&#123;[message][8]&#125;"</span>         <span class="comment">#数组是以0开始的，第9个字段在数组里角标为8</span></div><div class="line">	            		<span class="string">"loginip"</span> =&gt; <span class="string">"%&#123;[message][10]&#125;"</span></div><div class="line">        	    		<span class="string">"login_result"</span> =&gt; <span class="string">"%&#123;[message][5]&#125;"</span></div><div class="line">        		&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">output &#123;</div><div class="line">	stdout &#123;</div><div class="line">		codec =&gt; rubydebug&#123;&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#输出结果</span></div><div class="line">&#123;</div><div class="line">          <span class="string">"offset"</span> =&gt; 136859,</div><div class="line">      <span class="string">"input_type"</span> =&gt; <span class="string">"log"</span>,</div><div class="line">          <span class="string">"source"</span> =&gt; <span class="string">"/var/log/secure"</span>,</div><div class="line">    <span class="string">"login_result"</span> =&gt; <span class="string">"Accepted"</span>,</div><div class="line">         <span class="string">"message"</span> =&gt; [</div><div class="line">        [ 0] <span class="string">"Nov"</span>,</div><div class="line">        [ 1] <span class="string">"16"</span>,</div><div class="line">        [ 2] <span class="string">"14:38:14"</span>,</div><div class="line">        [ 3] <span class="string">"localhost"</span>,</div><div class="line">        [ 4] <span class="string">"sshd[9305]:"</span>,</div><div class="line">        [ 5] <span class="string">"Accepted"</span>,</div><div class="line">        [ 6] <span class="string">"publickey"</span>,</div><div class="line">        [ 7] <span class="string">"for"</span>,</div><div class="line">        [ 8] <span class="string">"yfshare"</span>,</div><div class="line">        [ 9] <span class="string">"from"</span>,</div><div class="line">        [10] <span class="string">"192.168.1.123"</span>,</div><div class="line">        [11] <span class="string">"port"</span>,</div><div class="line">        [12] <span class="string">"2269"</span>,</div><div class="line">        [13] <span class="string">"ssh2:"</span>,</div><div class="line">        [14] <span class="string">"RSA"</span>,</div><div class="line">        [15] <span class="string">"51:37:66:2f:2b:c0:74:d1:0b:15:f8:9c:7f:84:64:0a"</span></div><div class="line">    ],</div><div class="line">            <span class="string">"type"</span> =&gt; <span class="string">"secure_2.250"</span>,</div><div class="line">        <span class="string">"ClientIP"</span> =&gt; <span class="string">"192.168.1.123"</span>,</div><div class="line">            <span class="string">"tags"</span> =&gt; [</div><div class="line">        [0] <span class="string">"beats_input_codec_plain_applied"</span></div><div class="line">    ],</div><div class="line">      <span class="string">"@timestamp"</span> =&gt; 2017-11-16T06:38:19.012Z,</div><div class="line">         <span class="string">"loginip"</span> =&gt; <span class="string">"192.168.1.123"</span>,</div><div class="line">        <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,</div><div class="line">            <span class="string">"beat"</span> =&gt; &#123;</div><div class="line">            <span class="string">"name"</span> =&gt; <span class="string">"localhost"</span>,</div><div class="line">        <span class="string">"hostname"</span> =&gt; <span class="string">"localhost"</span>,</div><div class="line">         <span class="string">"version"</span> =&gt; <span class="string">"5.6.4"</span></div><div class="line">    &#125;,</div><div class="line">            <span class="string">"host"</span> =&gt; <span class="string">"localhost"</span>,</div><div class="line">          <span class="string">"status"</span> =&gt; <span class="string">"Accepted"</span>,</div><div class="line">        <span class="string">"username"</span> =&gt; <span class="string">"yfshare"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在Kibana上的Visualize上选择Data Table。<br><img src="https://note.youdao.com/yws/api/personal/file/D6AC34D06690457AB5DBA55FC9A7768E?method=download&amp;shareKey=90c8da2df75c8d76924f8127a5e586a4" alt="Kianan_Visualize_dataTable"><br>如果报上面的错误<code>no cached mapping for this field. refresh field list from the management &gt; index patterns pageTransform</code><br>原因是我们自己新增字段后，Kibana上index是之前加上的，新增字段不存在会报错，刷新下index即可<br>解决方案是：<code>management &gt; index patterns</code>，刷新对应的index即可<br><img src="https://note.youdao.com/yws/api/personal/file/52309F704287411BA92143E8BEE341D0?method=download&amp;shareKey=55aa29e1eb3960f040f21e887c82c4fb" alt="Kianan_Visualize_dataTable">  </p>
<h4 id="Logstash的output插件之发生email"><a href="#Logstash的output插件之发生email" class="headerlink" title="Logstash的output插件之发生email"></a>Logstash的output插件之发生email</h4><p>参考：<a href="https://www.elastic.co/guide/en/logstash/5.1/plugins-outputs-email.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/5.1/plugins-outputs-email.html</a><br><a href="https://kibana.logstash.es/content/logstash/plugins/output/email.html" target="_blank" rel="external">https://kibana.logstash.es/content/logstash/plugins/output/email.html</a><br>outputs/email 插件支持 SMTP 协议和 sendmail 两种方式，通过 <code>via</code> 参数设置。SMTP 方式有较多的 options 参数可配置。sendmail 只能利用本机上的 sendmail 服务来完成  </p>
<p>126 邮箱发送到 qq 邮箱示例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">output &#123;</div><div class="line">    email &#123;</div><div class="line">        port           =&gt;    <span class="string">"25"</span></div><div class="line">        address        =&gt;    <span class="string">"smtp.126.com"</span></div><div class="line">        username       =&gt;    <span class="string">"test@126.com"</span></div><div class="line">        password       =&gt;    <span class="string">""</span></div><div class="line">        authentication =&gt;    <span class="string">"plain"</span></div><div class="line">        use_tls        =&gt;    <span class="literal">true</span></div><div class="line">        from           =&gt;    <span class="string">"test@126.com"</span></div><div class="line">        subject        =&gt;    <span class="string">"Warning: %&#123;title&#125;"</span></div><div class="line">        to             =&gt;    <span class="string">"test@qq.com"</span></div><div class="line">        via            =&gt;    <span class="string">"smtp"</span></div><div class="line">        body           =&gt;    <span class="string">"%&#123;message&#125;"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Logstash的output插件之发生HDFS"><a href="#Logstash的output插件之发生HDFS" class="headerlink" title="Logstash的output插件之发生HDFS"></a>Logstash的output插件之发生HDFS</h4><p>参考：<a href="https://www.elastic.co/guide/en/logstash/5.6/plugins-outputs-webhdfs.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/5.6/plugins-outputs-webhdfs.html</a><br><a href="https://kibana.logstash.es/content/logstash/plugins/output/hdfs.html" target="_blank" rel="external">https://kibana.logstash.es/content/logstash/plugins/output/hdfs.html</a><br>该插件最初来源于社区，目前已被官方收录，Logstash 5.6支持，使用的是Hadoop的 WebHDFS 接口，其本质是发送 POST 数据<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">input &#123;</div><div class="line">  ...</div><div class="line">&#125;</div><div class="line">filter &#123;</div><div class="line">  ...</div><div class="line">&#125;</div><div class="line">output &#123;</div><div class="line">  webhdfs &#123;</div><div class="line">    host =&gt; <span class="string">"127.0.0.1"</span>                 <span class="comment"># (required)</span></div><div class="line">    port =&gt; 50070                       <span class="comment"># (optional, default: 50070)</span></div><div class="line">    path =&gt; <span class="string">"/user/logstash/dt=%&#123;+YYYY-MM-dd&#125;/logstash-%&#123;+HH&#125;.log"</span>  <span class="comment"># (required)</span></div><div class="line">    user =&gt; <span class="string">"hue"</span>                       <span class="comment"># (required)</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>更多插件请见：<a href="https://kibana.logstash.es/content/logstash/plugins/filter/" target="_blank" rel="external">https://kibana.logstash.es/content/logstash/plugins/filter/</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/11/18/Logstash插件/">http://www.yfshare.vip/2017/11/18/Logstash插件/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Elasticsearch监控相关]]></title>
      <url>http://www.yfshare.vip/2017/11/14/Elasticsearch%E7%9B%91%E6%8E%A7%E7%9B%B8%E5%85%B3/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>Elasticsearch相关监控接口<br><a id="more"></a></p>
<h4 id="监控相关接口"><a href="#监控相关接口" class="headerlink" title="监控相关接口"></a>监控相关接口</h4><h5 id="集群健康状态"><a href="#集群健康状态" class="headerlink" title="集群健康状态"></a>集群健康状态</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">[root@ELK-test ~]<span class="comment"># curl -XGET -u elastic:password http://localhost:9200/_cluster/health?pretty</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"cluster_name"</span> : <span class="string">"Julend_ES-cluster"</span>,</div><div class="line">  <span class="string">"status"</span> : <span class="string">"green"</span>,</div><div class="line">  <span class="string">"timed_out"</span> : <span class="literal">false</span>,</div><div class="line">  <span class="string">"number_of_nodes"</span> : 3,</div><div class="line">  <span class="string">"number_of_data_nodes"</span> : 3,</div><div class="line">  <span class="string">"active_primary_shards"</span> : 5929,</div><div class="line">  <span class="string">"active_shards"</span> : 11859,</div><div class="line">  <span class="string">"relocating_shards"</span> : 0,</div><div class="line">  <span class="string">"initializing_shards"</span> : 0,</div><div class="line">  <span class="string">"unassigned_shards"</span> : 0,</div><div class="line">  <span class="string">"delayed_unassigned_shards"</span> : 0,</div><div class="line">  <span class="string">"number_of_pending_tasks"</span> : 0,</div><div class="line">  <span class="string">"number_of_in_flight_fetch"</span> : 0,</div><div class="line">  <span class="string">"task_max_waiting_in_queue_millis"</span> : 0,</div><div class="line">  <span class="string">"active_shards_percent_as_number"</span> : 100.0</div><div class="line">&#125;</div><div class="line">[root@ELK-test ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>status状态信息：  </p>
<ul>
<li>green（绿灯）：所有分片正常运行，集群非常健康</li>
<li>yellow（黄灯）：所有主分片正常运行，但副本分片有缺失。这种情况指Elasticsearch当前是正常运行的，但有一定风险</li>
<li>red（红灯）：有主分片缺失。这部分数据完全不可用。而Elasticsearch在写入端是简单的取余算法，轮到这个分片上的数据也会持续写入报错</li>
</ul>
<p>其他数据：  </p>
<ul>
<li><code>number_of_nodes</code>: 集群内的总节点数</li>
<li><code>number_of_data_nodes</code>: 集群内的总数据节点数</li>
<li><code>active_primary_shards</code>：集群内所有索引的主分片总数</li>
<li><code>active_shards</code>: 集群内所有索引的分片总数</li>
<li><code>relocating_shards</code>：正在迁移的分片数</li>
<li><code>Initializing_shards</code>：正在初始化的分片数</li>
<li><code>unassigned_shards</code>：未分配到具体节点上的分片数</li>
<li><code>delayed_unassigned_shards</code>：延时待分配到具体节点上的分片数</li>
</ul>
<p>level请求参数<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -XGET -u elastic:admin@julend  http://localhost:9200/_cluster/health?level=indices</div></pre></td></tr></table></figure></p>
<h5 id="节点状态"><a href="#节点状态" class="headerlink" title="节点状态"></a>节点状态</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XGET -u elastic:password http://localhost:9200/_nodes/stats?pretty=true</span></div><div class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</div><div class="line">                                 Dload  Upload   Total   Spent    Left  Speed</div><div class="line">100 42846  100 42846    0     0   5123      0  0:00:08  0:00:08 --:--:-- 12874</div><div class="line">&#123;</div><div class="line">  <span class="string">"_nodes"</span> : &#123;</div><div class="line">    <span class="string">"total"</span> : 3,</div><div class="line">    <span class="string">"successful"</span> : 3,</div><div class="line">    <span class="string">"failed"</span> : 0</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"cluster_name"</span> : <span class="string">"Julend_ES-cluster"</span>,</div><div class="line">  <span class="string">"nodes"</span> : &#123;</div><div class="line">    <span class="string">"mXtk8dQeQh-amui-d5pVoA"</span> : &#123;</div><div class="line">      <span class="string">"timestamp"</span> : 1509868787579,</div><div class="line">      <span class="string">"name"</span> : <span class="string">"Julend_es1"</span>,</div><div class="line">      <span class="string">"transport_address"</span> : <span class="string">"192.168.1.41:9300"</span>,</div><div class="line">      <span class="string">"host"</span> : <span class="string">"192.168.1.41"</span>,</div><div class="line">      <span class="string">"ip"</span> : <span class="string">"192.168.1.41:9300"</span>,</div><div class="line">      <span class="string">"roles"</span> : [</div><div class="line">        <span class="string">"master"</span>,</div><div class="line">        <span class="string">"data"</span>,</div><div class="line">        <span class="string">"ingest"</span></div><div class="line">      ],</div><div class="line">...</div></pre></td></tr></table></figure>
<h5 id="索引信息"><a href="#索引信息" class="headerlink" title="索引信息"></a>索引信息</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XGET -u elastic:password http://localhost:9200/_nodes/stats?pretty=true</span></div><div class="line">...</div><div class="line">        <span class="string">"store"</span> : &#123;</div><div class="line">          <span class="string">"size_in_bytes"</span> : 38046324034,</div><div class="line">          <span class="string">"throttle_time_in_millis"</span> : 0</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"indexing"</span> : &#123;</div><div class="line">          <span class="string">"index_total"</span> : 21895145,</div><div class="line">          <span class="string">"index_time_in_millis"</span> : 4513185,</div><div class="line">          <span class="string">"index_current"</span> : 0,</div><div class="line">          <span class="string">"index_failed"</span> : 0,</div><div class="line">          <span class="string">"delete_total"</span> : 0,</div><div class="line">          <span class="string">"delete_time_in_millis"</span> : 0,</div><div class="line">          <span class="string">"delete_current"</span> : 0,</div><div class="line">          <span class="string">"noop_update_total"</span> : 0,</div><div class="line">          <span class="string">"is_throttled"</span> : <span class="literal">false</span>,</div><div class="line">          <span class="string">"throttle_time_in_millis"</span> : 0</div><div class="line">        &#125;,</div><div class="line">...</div></pre></td></tr></table></figure>
<ul>
<li><code>docs.count</code> 是节点上存储的数据条目总数</li>
<li><code>store.size_in_bytes</code> 是节点上存储的数据占用磁盘实际大小</li>
<li><code>store.throttle_time_in_millis</code> 则是Elasticsearch进程在做segment merge时出现磁盘限速的时长。如果在Elasticsearch日志中经常看到限速声明，则这个值也会偏大</li>
<li><code>indexing.index_total</code> 是一个递增的累计数，表示节点完成的数据写入总次数</li>
<li><code>indexing.delete_total</code> 记录删除的数据条数</li>
<li><code>indexing.is_throttled</code> 为Elasticsearch 2.0新增计数，因为从此Elasticsearch开始自动管理throttle</li>
</ul>
<h5 id="读取性能"><a href="#读取性能" class="headerlink" title="读取性能"></a>读取性能</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XGET -u elastic:password http://localhost:9200/_nodes/stats?pretty=true</span></div><div class="line">...</div><div class="line">        <span class="string">"get"</span> : &#123;</div><div class="line">          <span class="string">"total"</span> : 167,</div><div class="line">          <span class="string">"time_in_millis"</span> : 18,</div><div class="line">          <span class="string">"exists_total"</span> : 167,</div><div class="line">          <span class="string">"exists_time_in_millis"</span> : 18,</div><div class="line">          <span class="string">"missing_total"</span> : 0,</div><div class="line">          <span class="string">"missing_time_in_millis"</span> : 0,</div><div class="line">          <span class="string">"current"</span> : 0</div><div class="line">        &#125;,</div><div class="line">...</div></pre></td></tr></table></figure>
<ul>
<li><code>get</code> 显示的是直接使用<code>_id</code>读取数据的状态</li>
</ul>
<h5 id="搜索性能"><a href="#搜索性能" class="headerlink" title="搜索性能"></a>搜索性能</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XGET -u elastic:password http://localhost:9200/_nodes/stats?pretty=true</span></div><div class="line">...</div><div class="line">        <span class="string">"search"</span> : &#123;</div><div class="line">          <span class="string">"open_contexts"</span> : 0,</div><div class="line">          <span class="string">"query_total"</span> : 10560,</div><div class="line">          <span class="string">"query_time_in_millis"</span> : 12189,</div><div class="line">          <span class="string">"query_current"</span> : 0,</div><div class="line">          <span class="string">"fetch_total"</span> : 7078,</div><div class="line">          <span class="string">"fetch_time_in_millis"</span> : 3383,</div><div class="line">          <span class="string">"fetch_current"</span> : 0,</div><div class="line">          <span class="string">"scroll_total"</span> : 1150,</div><div class="line">          <span class="string">"scroll_time_in_millis"</span> : 6697,</div><div class="line">          <span class="string">"scroll_current"</span> : 0,</div><div class="line">          <span class="string">"suggest_total"</span> : 0,</div><div class="line">          <span class="string">"suggest_time_in_millis"</span> : 0,</div><div class="line">          <span class="string">"suggest_current"</span> : 0</div><div class="line">        &#125;,</div><div class="line">...</div></pre></td></tr></table></figure>
<ul>
<li><code>search.open_contexts</code> 表示当前正在进行的搜索</li>
<li><code>search.query_total</code> 表示节点启动以来完成的搜索数</li>
<li><code>search.query_time_in_millis</code> 表示完成上次搜索花费的时间总和。search.query_time_in_millis除以 search.query_total 越大，说明性能越差，可以通过Elasticsearch 的slowlog获取具体的搜索语句，做出针对性的优化</li>
<li><code>search.fetch_total</code> 等指标含义类似。因为Elasticsearch的搜索默认是<code>query-then-fetch</code>式的，所以fetch一般小而快。如果计算search.fetch_time_in_millis &gt; search.query_time_in_millis，说明有人采用了较大的size参数做分页查询，通过showlog抓到具体的语句，相机优化成 scan式搜索</li>
</ul>
<h5 id="段合并性能"><a href="#段合并性能" class="headerlink" title="段合并性能"></a>段合并性能</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XGET -u elastic:password http://localhost:9200/_nodes/stats?pretty=true</span></div><div class="line">...</div><div class="line">        <span class="string">"merges"</span> : &#123;</div><div class="line">          <span class="string">"current"</span> : 0,</div><div class="line">          <span class="string">"current_docs"</span> : 0,</div><div class="line">          <span class="string">"current_size_in_bytes"</span> : 0,</div><div class="line">          <span class="string">"total"</span> : 15675,</div><div class="line">          <span class="string">"total_time_in_millis"</span> : 8422758,38 16295         </div><div class="line">          <span class="string">"total_docs"</span> : 142493991,</div><div class="line">          <span class="string">"total_size_in_bytes"</span> : 75031786583,</div><div class="line">          <span class="string">"total_stopped_time_in_millis"</span> : 0,</div><div class="line">          <span class="string">"total_throttled_time_in_millis"</span> : 222454,</div><div class="line">          <span class="string">"total_auto_throttle_in_bytes"</span> : 839578885310</div><div class="line">          &#125;,</div><div class="line">...</div></pre></td></tr></table></figure>
<ul>
<li><code>merges</code> 数据分为两部分，current开头的是当前正在发生的段合并行为统计；total开头的历史统计总数。作为ELK，以数据写入压力为主，merges相关数据会比较突出</li>
</ul>
<h5 id="过滤器缓存"><a href="#过滤器缓存" class="headerlink" title="过滤器缓存"></a>过滤器缓存</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XGET -u elastic:password http://localhost:9200/_nodes/stats?pretty=true</span></div><div class="line">...</div><div class="line"><span class="string">"filter_cache"</span>: &#123;</div><div class="line">    <span class="string">"memory_size_in_bytes"</span>: 48,</div><div class="line">    <span class="string">"evictions"</span>: 0</div><div class="line">&#125;,</div><div class="line">...</div></pre></td></tr></table></figure>
<ul>
<li><code>filter_cache.memory_size_in_bytes</code> 表示过滤器缓存使用的内存</li>
<li><code>filter_cache.evictions</code> 表示因内存满被回收的缓存大小，如果这个数比较大，说明过滤器缓存大小不足，或者过滤器本身不太适合缓存<br><em>注：过滤器缓存是建立在 megment 基础上，在当天新日志搜索中，存在大量或多或少的 segment。一个5G的segment和一个2M的segment，发生一次<code>filter_cache.evictions</code> 对搜索性能影响区别是巨大的。但节点状态中本身这个计数并不能反应这点区别。所以尽量减少这个数值，如果搜索本身感觉不慢，这几个值也无所谓</em>  </li>
</ul>
<h5 id="id缓存"><a href="#id缓存" class="headerlink" title="id缓存"></a>id缓存</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XGET -u elastic:password http://localhost:9200/_nodes/stats?pretty=true</span></div><div class="line">...</div><div class="line"><span class="string">"id_cache"</span>: &#123;</div><div class="line">    <span class="string">"memory_size_in_bytes"</span>: 0</div><div class="line">&#125;,</div><div class="line">...</div></pre></td></tr></table></figure>
<ul>
<li><code>id_cache</code> 是 <code>parent/child mappings</code> 使用的内存。不过在ELK中，一般不会用到这个性能，所以此处数据一般为0  </li>
</ul>
<h5 id="fielddata"><a href="#fielddata" class="headerlink" title="fielddata"></a>fielddata</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XGET -u elastic:password http://localhost:9200/_nodes/stats?pretty=true</span></div><div class="line">...</div><div class="line">        <span class="string">"fielddata"</span> : &#123;</div><div class="line">          <span class="string">"memory_size_in_bytes"</span> : 32480,</div><div class="line">          <span class="string">"evictions"</span> : 0</div><div class="line">        &#125;,</div><div class="line">...</div></pre></td></tr></table></figure>
<p>此处显示fielddata使用的内存大小。fielddata用来做聚合、排序等工作。  </p>
<h5 id="segments"><a href="#segments" class="headerlink" title="segments"></a>segments</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XGET -u elastic:password http://localhost:9200/_nodes/stats?pretty=true</span></div><div class="line">...</div><div class="line">        <span class="string">"segments"</span> : &#123;</div><div class="line">          <span class="string">"count"</span> : 18741,</div><div class="line">          <span class="string">"memory_in_bytes"</span> : 193556533,</div><div class="line">          <span class="string">"terms_memory_in_bytes"</span> : 152266264,</div><div class="line">          <span class="string">"stored_fields_memory_in_bytes"</span> : 17067832,</div><div class="line">          <span class="string">"term_vectors_memory_in_bytes"</span> : 0,</div><div class="line">          <span class="string">"norms_memory_in_bytes"</span> : 13141184,</div><div class="line">          <span class="string">"points_memory_in_bytes"</span> : 2426489,</div><div class="line">          <span class="string">"doc_values_memory_in_bytes"</span> : 8654764,</div><div class="line">          <span class="string">"index_writer_memory_in_bytes"</span> : 0,</div><div class="line">          <span class="string">"version_map_memory_in_bytes"</span> : 0,</div><div class="line">          <span class="string">"fixed_bit_set_memory_in_bytes"</span> : 1552,</div><div class="line">          <span class="string">"max_unsafe_auto_id_timestamp"</span> : 1509866960317,</div><div class="line">          <span class="string">"file_sizes"</span> : &#123; &#125;</div><div class="line">        &#125;,</div><div class="line">...</div></pre></td></tr></table></figure>
<ul>
<li><code>segments.count</code> 表示节点上所有索引的segment 数目总和。一般来说，一个索引通常会有50-150个 segment ，再多就对性能有较大影响了（可能merge 速度跟不上新segment 出现的速度）。  </li>
<li><code>segments.memory_in_bytes</code>  表示segment本身底层数据结构所使用的内存大小。像索引的倒排表，词典，bloom Filter（Elasticsearch 1.4以后默认关闭）等，所以过多的segment会导致这个数值迅速变大。  </li>
</ul>
<h4 id="任务管理"><a href="#任务管理" class="headerlink" title="任务管理"></a>任务管理</h4><h5 id="等待执行的任务列表"><a href="#等待执行的任务列表" class="headerlink" title="等待执行的任务列表"></a>等待执行的任务列表</h5><p>master只有集群状态的数据维护，一般来说，这个任务列表都是空的<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XGET -u elastic:password http://localhost:9200/_cluster/pending_tasks?pretty</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"tasks"</span> : [ ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果遇到集群有异常，比如频繁更新索引，数据恢复，分片分配或者初始化的时候反复出错，就会看到一些任务了。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#集群故障了，出现了很多任务</span></div><div class="line"><span class="comment"># curl -XGET -u elastic:password http://localhost:9200/_cluster/pending_tasks?pretty</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"tasks"</span> : [</div><div class="line">    &#123;</div><div class="line">      <span class="string">"insert_order"</span> : 1959,</div><div class="line">      <span class="string">"priority"</span> : <span class="string">"URGENT"</span>,</div><div class="line">      <span class="string">"source"</span> : <span class="string">"shard-started shard id [[192.168.1.24-thirdparty_errorlog-2017.11.02][2]], allocation id [rUOqVHjmTZiqL</span></div><div class="line">COvSaYDnA], primary term [0], message [after existing recovery]",      <span class="string">"executing"</span> : <span class="literal">true</span>,</div><div class="line">      <span class="string">"time_in_queue_millis"</span> : 833,</div><div class="line">      <span class="string">"time_in_queue"</span> : <span class="string">"833ms"</span></div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="string">"insert_order"</span> : 1960,</div><div class="line">      <span class="string">"priority"</span> : <span class="string">"URGENT"</span>,</div><div class="line">      <span class="string">"source"</span> : <span class="string">"shard-started shard id [[192.168.1.21-thirdparty_log-2017.11.02][4]], allocation id [kmyECWLXRSKM4YDlsX</span></div><div class="line">mRcA], primary term [0], message [after existing recovery]",      <span class="string">"executing"</span> : <span class="literal">false</span>,</div><div class="line">      <span class="string">"time_in_queue_millis"</span> : 809,</div><div class="line">      <span class="string">"time_in_queue"</span> : <span class="string">"809ms"</span></div><div class="line">    &#125;,</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>集群存储长期数据导致索引映射数据确实大到了master节点内存不足以快速处理的地步。<br>根据实际情况，可以选择：  </p>
<ul>
<li>索引特别多：给master加内存</li>
<li>索引字段太多：改用nested object 方式节省字段数量</li>
<li>索引多到内存不够了：把一部分数据拆出来到另一个集群</li>
</ul>
<h5 id="新版任务管理"><a href="#新版任务管理" class="headerlink" title="新版任务管理"></a>新版任务管理</h5><p>新版任务并没有独立的接口，发起的具体某次search、snapshot、reindex等操作，自动就成了一个任务。而任务的列表可以通过<code>/_tasks</code>或者<code>/_cat/tasks</code>接口来获取。和其他操作一样，手动操作用cat，写程序时用JSON接口。  </p>
<p>取消某个任务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XGET -u elastic:admin@julend http://localhost:9200/_cat/tasks?v #获取当前任务</span></div><div class="line">action                         task_id                       parent_task_id                <span class="built_in">type</span> start_time    timest</div><div class="line">amp  running_time ip           nodeindices:monitor/stats          Go1e5drSSum7gbrKpIef8g:175591 -                             transport 1509884620079 20:23:</div><div class="line">40  487ms        192.168.1.43 Julend_es3indices:monitor/stats[n]       VQf-ph7NRTeiEVHqAT4pRw:140954 Go1e5drSSum7gbrKpIef8g:175591 netty     1509884619871 20:23:</div><div class="line">39  410.2ms      192.168.1.42 Julend_es2cluster:monitor/tasks/lists    mXtk8dQeQh-amui<span class="_">-d</span>5pVoA:145705 -                             transport 1509884621290 20:23:</div><div class="line">41  17.3ms       192.168.1.41 Julend_es1cluster:monitor/tasks/lists[n] VQf-ph7NRTeiEVHqAT4pRw:140959 mXtk8dQeQh-amui<span class="_">-d</span>5pVoA:145705 netty     1509884620249 20:23:</div><div class="line">40  32ms         192.168.1.42 Julend_es2cluster:monitor/tasks/lists[n] Go1e5drSSum7gbrKpIef8g:175595 mXtk8dQeQh-amui<span class="_">-d</span>5pVoA:145705 netty     1509884620544 20:23:</div><div class="line">40  21.4ms       192.168.1.43 Julend_es3cluster:monitor/tasks/lists[n] mXtk8dQeQh-amui<span class="_">-d</span>5pVoA:145706 mXtk8dQeQh-amui<span class="_">-d</span>5pVoA:145705 direct    1509884621306 20:23:</div><div class="line">41  1.3ms        192.168.1.41 Julend_es1</div><div class="line"></div><div class="line"><span class="comment"># curl -XPOST 'http://localhost:9200/_tasks/task_id:175591/_cancel'</span></div></pre></td></tr></table></figure></p>
<p>而 search任务和 reindex任务不同。Elasticsearch从5.1.1版本开始支持取消还在运行的search任务，但这个行为并不能立即生效。<br>默认情况下，对search tasks的管理粒度是以segment为单位的。即，这个搜索会在执行完当前segment后才停止。历史索引已经经过 forcemerge接口优化，一个分片里面只有一个segment，那么这个cancel可以认为是无效的。<br>对于这种情况，Elasticsearch提供了另一个更细粒度但是也更消耗资源的方法。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPOST 'http://localhost:9200/_cluster/settings' -d '&#123;</span></div><div class="line">    <span class="string">"persistent"</span>: &#123;</div><div class="line">        <span class="string">"search.low_level_cancellation"</span>: <span class="literal">true</span></div><div class="line">    &#125;</div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure></p>
<p>这时，所有的搜索任务，都会定期检查自己是否被取消了。也这可能导致比较慢的搜索，执行时间更加漫长。  </p>
<h5 id="cat接口命令行使用"><a href="#cat接口命令行使用" class="headerlink" title="cat接口命令行使用"></a>cat接口命令行使用</h5><p>用户日常运维，可以读取各种监控数据  </p>
<ul>
<li><code>/_cat/nodes</code></li>
<li><code>/_cat/shards</code></li>
<li><code>/_cat/shards/{index}</code></li>
<li><code>/_cat/aliases</code></li>
<li><code>/_cat/aliases/{alias}</code></li>
<li><code>/_cat/tasks</code></li>
<li><code>/_cat/master</code></li>
<li><code>/_cat/plugins</code></li>
<li><code>/_cat/fielddata</code></li>
<li><code>/_cat/fielddata/{fields}</code></li>
<li><code>/_cat/pending_tasks</code></li>
<li><code>/_cat/count</code></li>
<li><code>/_cat/count/{index}</code></li>
<li><code>/_cat/snapshots/{repository}</code></li>
<li><code>/_cat/recovery</code></li>
<li><code>/_cat/recovery/{index}</code></li>
<li><code>/_cat/segments</code></li>
<li><code>/_cat/segments/{index}</code></li>
<li><code>/_cat/thread_pool</code></li>
<li><code>/_cat/thread_pool/{thread_pools}/_cat/nodeattrs</code></li>
<li><code>/_cat/allocation</code></li>
<li><code>/_cat/repositories</code></li>
<li><code>/_cat/health</code></li>
<li><code>/_cat/indices</code></li>
<li><code>/_cat/indices/{index}</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XGET -u elastic:password http://localhost:9200/_cat/nodes?help</span></div><div class="line">id           | id,nodeId      | unique node id           </div><div class="line">pid          | p              | process id               </div><div class="line">ip           | i              | ip address               </div><div class="line">port         | po             | bound transport port     </div><div class="line">http_address | http           | bound http address       </div><div class="line">version      | v              | es version</div><div class="line">...</div></pre></td></tr></table></figure>
<h5 id="bigdesk"><a href="#bigdesk" class="headerlink" title="bigdesk"></a>bigdesk</h5><p>地址：<a href="https://github.com/hlstudio/bigdesk" target="_blank" rel="external">https://github.com/hlstudio/bigdesk</a><br>bigdesk是一款针对Elasticsearch 性能的开源实时监控方案。  </p>
<h5 id="zabbix-trapper"><a href="#zabbix-trapper" class="headerlink" title="zabbix trapper"></a>zabbix trapper</h5><p>地址：<a href="https://github.com/Wprosdocimo/Elasticsearch-zabbix" target="_blank" rel="external">https://github.com/Wprosdocimo/Elasticsearch-zabbix</a><br><a href="https://github.com/untergeek/zabbix-grab-bag/blob/master/Elasticsearch/es_stats_zabbix.README.md" target="_blank" rel="external">https://github.com/untergeek/zabbix-grab-bag/blob/master/Elasticsearch/es_stats_zabbix.README.md</a>  </p>
<h4 id="Percolator接口"><a href="#Percolator接口" class="headerlink" title="Percolator接口"></a>Percolator接口</h4><p>ELK stack告警方式：  </p>
<ol>
<li>对于匹配报警，采用Elasticsearch的 Percolator接口做响应告警。  </li>
<li>对于时序统计，采用定时任务方式，发送Elasticsearch aggs请求，分析响应体报警。</li>
</ol>
<p>在Elasticsearch 5.0后，对Percolator 功能大幅改造，而现在作为一种 mapping类型，在创建索引时需要预先定义。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPUT http://localhost:9200/syslog -d '&#123;</span></div><div class="line">    <span class="string">"mappings"</span>: &#123;</div><div class="line">        <span class="string">"syslog"</span>: &#123;</div><div class="line">            <span class="string">"properties"</span>: &#123;</div><div class="line">                <span class="string">"message"</span>: &#123;</div><div class="line">                    <span class="string">"type"</span>: <span class="string">"text"</span></div><div class="line">                &#125;,</div><div class="line">                <span class="string">"severity"</span>: &#123;</div><div class="line">                    <span class="string">"type"</span>: <span class="string">"long"</span></div><div class="line">                &#125;,</div><div class="line">                <span class="string">"program"</span>: &#123;</div><div class="line">                    <span class="string">"type"</span>: <span class="string">"keyword"</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"queries"</span>: &#123;</div><div class="line">            <span class="string">"properties"</span>: &#123;</div><div class="line">                <span class="string">"query"</span>: &#123;</div><div class="line">                    <span class="string">"type"</span>: <span class="string">"percolator"</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">    &#125;</div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure></p>
<p>然后往 <code>syslog/queries</code> 里注册两条 percolator 请求规则：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPUT http://localhost:9200/syslog/queries/memory -d '&#123;</span></div><div class="line">    <span class="string">"query"</span>: &#123;</div><div class="line">        <span class="string">"query_string"</span>: &#123;</div><div class="line">            <span class="string">"default_field"</span>: <span class="string">"message"</span>,</div><div class="line">            <span class="string">"default_operator"</span>: <span class="string">"OR"</span>,</div><div class="line">            <span class="string">"query"</span>: <span class="string">"mem DMA segfault page allocation AND severity: &gt;2 AND program:kernel"</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPUT http://localhost:9200/syslog/queries/disk -d '&#123;</span></div><div class="line">    <span class="string">"query"</span>: &#123;</div><div class="line">        <span class="string">"query_string"</span>: &#123;</div><div class="line">            <span class="string">"default_field"</span>: <span class="string">"message"</span>,</div><div class="line">            <span class="string">"default_operator"</span>: <span class="string">"OR"</span>,</div><div class="line">            <span class="string">"query"</span>: <span class="string">"scsi sata hdd sda AND severity:&gt;2 AND program:kernal"</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure>
<p>然后，将标准的数据写入请求改成通过搜索接口进行：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPOST http://localhost:9200/syslog/_search -d '&#123;</span></div><div class="line">    <span class="string">"query"</span>: &#123;</div><div class="line">        <span class="string">"percolate"</span>: &#123;</div><div class="line">            <span class="string">"field"</span>: <span class="string">"query"</span>,</div><div class="line">            <span class="string">"document_type"</span>: <span class="string">"syslog"</span>,</div><div class="line">            <span class="string">"document"</span>: &#123;</div><div class="line">                <span class="string">"program"</span>: <span class="string">"kernel"</span>,</div><div class="line">                <span class="string">"severity"</span>: 3,</div><div class="line">                <span class="string">"message"</span>: <span class="string">"swapper/0: page allocation failure: order:4, mode:0x4020"</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure></p>
<p>得到的结果如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    ...</div><div class="line">    <span class="string">"hits"</span>: [</div><div class="line">        &#123;</div><div class="line">            <span class="string">"_index"</span>: <span class="string">"syslog"</span>,</div><div class="line">            <span class="string">"_type"</span>: <span class="string">"queries"</span>,</div><div class="line">            <span class="string">"_id"</span>: <span class="string">"memory"</span>,</div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line">    ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这条syslog 日志匹配上了memory内存异常。下面就可以发送给报警系统了。<br>如果syslog 索引中已经有数据了，也可以重新 Percolator 查询。比如：有一条之前已经写入到 <a href="http://localhost:9200/syslog/cisco/1234567" target="_blank" rel="external">http://localhost:9200/syslog/cisco/1234567</a> 的数据，如果把这条数据在过一次 Percolate：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPOST http://localhost:9200/syslog/_search -d '&#123;</span></div><div class="line">    <span class="string">"query"</span>: &#123;</div><div class="line">        <span class="string">"percolate"</span>: &#123;</div><div class="line">            <span class="string">"field"</span>: <span class="string">"query"</span>,</div><div class="line">            <span class="string">"document_type"</span>: <span class="string">"syslog"</span>,</div><div class="line">            <span class="string">"index"</span>: <span class="string">"syslog"</span>,</div><div class="line">            <span class="string">"type"</span>: <span class="string">"cisco"</span>,</div><div class="line">            <span class="string">"id"</span>: <span class="string">"1234567"</span>,</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure></p>
<p>更复杂的 query DSL 做 Percolator 请求示例，参考：<a href="https://www.elastic.co/blog/using-percolator-geo-tagging" target="_blank" rel="external">https://www.elastic.co/blog/using-percolator-geo-tagging</a>  </p>
<h4 id="报警机制"><a href="#报警机制" class="headerlink" title="报警机制"></a>报警机制</h4><h5 id="Watcher报警"><a href="#Watcher报警" class="headerlink" title="Watcher报警"></a>Watcher报警</h5><p>现在已经集成到X-PACK，安装X-PACK即可<br>参考：<a href="https://www.elastic.co/cn/products/x-pack/alerting" target="_blank" rel="external">https://www.elastic.co/cn/products/x-pack/alerting</a>  </p>
<h5 id="ElastAlert"><a href="#ElastAlert" class="headerlink" title="ElastAlert"></a>ElastAlert</h5><p>与 Watcher 属于同类型产品。<br>参考：<a href="http://elastalert.readthedocs.io/en/latest/" target="_blank" rel="external">http://elastalert.readthedocs.io/en/latest/</a>  </p>
<h5 id="Etsy的-Kale-异常检测"><a href="#Etsy的-Kale-异常检测" class="headerlink" title="Etsy的 Kale 异常检测"></a>Etsy的 Kale 异常检测</h5><p>Kale 系统是一个监控分析系统，分为：skyline 和 oculus。<br>参考：<a href="https://codeascraft.com/2013/06/11/introducing-kale/" target="_blank" rel="external">https://codeascraft.com/2013/06/11/introducing-kale/</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/11/14/Elasticsearch监控相关/">http://www.yfshare.vip/2017/11/14/Elasticsearch监控相关/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[部署FileBeat+logstash+elasticsearch集群+kibana]]></title>
      <url>http://www.yfshare.vip/2017/11/04/%E9%83%A8%E7%BD%B2FileBeat-logstash-elasticsearch%E9%9B%86%E7%BE%A4-kibana/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>ELK由Elasticsearch、Logstash和Kibana三部分组件组成，这里新增了一个FileBeat，它是一个轻量级的日志收集处理工具(Agent)，Filebeat占用资源少，适合于在各个服务器上搜集日志后传输给Logstash，官方也推荐此工具<br><a id="more"></a><br>Filebeat隶属于Beats。目前Beats包含四种工具：  </p>
<ol>
<li>Packetbeat（搜集网络流量数据）  </li>
<li>Topbeat（搜集系统、进程和文件系统级别的 CPU 和内存使用情况等数据）</li>
<li>Filebeat（搜集文件数据）</li>
<li>Winlogbeat（搜集 Windows 事件日志数据）</li>
</ol>
<p>官方文档<br>Filebeat：<br><a href="https://www.elastic.co/cn/products/beats/filebeat" target="_blank" rel="external">https://www.elastic.co/cn/products/beats/filebeat</a><br><a href="https://www.elastic.co/guide/en/beats/filebeat/5.6/index.html" target="_blank" rel="external">https://www.elastic.co/guide/en/beats/filebeat/5.6/index.html</a>  </p>
<p>Logstash：<br><a href="https://www.elastic.co/cn/products/logstash" target="_blank" rel="external">https://www.elastic.co/cn/products/logstash</a><br><a href="https://www.elastic.co/guide/en/logstash/5.6/index.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/5.6/index.html</a></p>
<p>Elasticsearch：<br><a href="https://www.elastic.co/cn/products/elasticsearch" target="_blank" rel="external">https://www.elastic.co/cn/products/elasticsearch</a><br><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/index.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/reference/5.6/index.html</a>  </p>
<p>elasticsearch中文社区：<br><a href="https://elasticsearch.cn/" target="_blank" rel="external">https://elasticsearch.cn/</a> </p>
<p>官方ELK架构图：<br><img src="http://note.youdao.com/yws/api/personal/file/DCE29CF684C34FC3BA73809D566B0150?method=download&amp;shareKey=798f64543357202a0efb9a95d35c4e5b" alt="filebeat">  </p>
<p>本次环境的拓扑图：<br><img src="http://note.youdao.com/yws/api/personal/file/4772759A56704D82A3D1C6056C76613F?method=download&amp;shareKey=3c9825a509086b1a28b8ffd34aa9c6b0" alt="ELK_拓扑图">  </p>
<p>环境：<br>　　　Centos 7.3<br>　　　Filebeat 5.6.1<br>　　　Logstash 5.6.1<br>　　　Kibana 5.6.1  </p>
<p>软件下载：<br><a href="http://note.youdao.com/yws/api/personal/file/09E0C74E473348FA8DCBDB96F3AEE13D?method=download&amp;shareKey=9d9dc334d3d6c72613c00359372887a9" target="_blank" rel="external">filebeat-5.6.1-x86_64.rpm</a><br><a href="http://note.youdao.com/yws/api/personal/file/85468EC34C484B3F8D2B0AF3B7386841?method=download&amp;shareKey=e00a03bcfbc3d4b63c419ab1139a8765" target="_blank" rel="external">kibana-5.6.1-x86_64.rpm</a><br><a href="http://note.youdao.com/yws/api/personal/file/3D218AEF94474D4A9BC755B4AAADFE0B?method=download&amp;shareKey=3f79c453a9993cd899f38420983db94e" target="_blank" rel="external">logstash-5.6.1.rpm</a><br><a href="http://note.youdao.com/yws/api/personal/file/430B5F758002423A92C9023EF656C1E5?method=download&amp;shareKey=7507f90e005394aff511356bd60fc28e" target="_blank" rel="external">elasticsearch-5.6.1.rpm</a>  </p>
<h3 id="环境部署"><a href="#环境部署" class="headerlink" title="环境部署"></a>环境部署</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#环境部署（安装）</span></div><div class="line"><span class="comment">#每台机器上都需要安装JDK</span></div><div class="line">[root@DevEVN-21 ~]<span class="comment"># curl -L -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-5.6.1-x86_64.rpm</span></div><div class="line">[root@DevEVN-21 ~]<span class="comment"># rpm -ivh filebeat-5.6.1-x86_64.rpm</span></div><div class="line">[root@DevEVN-21 ~]<span class="comment"># rpm -qa | grep -i filebeat</span></div><div class="line">filebeat-5.6.1-1.x86_64</div><div class="line">[root@DevEVN-21 ~]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@ELK-test software]<span class="comment"># wget https://artifacts.elastic.co/downloads/logstash/logstash-5.6.1.rpm</span></div><div class="line">[root@ELK-test software]<span class="comment"># wget http://download.oracle.com/otn-pub/java/jdk/8u144-b01/090f390dda5b47b9b721c7dfaa008135/jdk-8u144-linux-x64.tar.gz?AuthParam=1505893074_6e8dfac4ee1e712087b65acabe8b2506 -O jdk-8u144-linux-x64.tar.gz</span></div><div class="line">[root@ELK-test software]<span class="comment"># tar -zxf jdk-8u144-linux-x64.tar.gz  -C /usr/local/</span></div><div class="line">[root@ELK-test ~]<span class="comment">#</span></div><div class="line">[root@ELK-test ~]<span class="comment"># cat /etc/profile.d/java.sh</span></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="built_in">export</span> JAVA_HOME=<span class="string">'/usr/local/jdk1.8.0_144'</span></div><div class="line"><span class="built_in">export</span> PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span></div><div class="line">[root@ELK-test ~]<span class="comment"># source /etc/profile.d/java.sh</span></div><div class="line">[root@ELK-test ~]<span class="comment"># java -version</span></div><div class="line">java version <span class="string">"1.8.0_144"</span></div><div class="line">Java(TM) SE Runtime Environment (build 1.8.0_144-b01)</div><div class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.144-b01, mixed mode)</div><div class="line">[root@ELK-test ~]<span class="comment">#</span></div><div class="line">[root@ELK-test software]<span class="comment"># rpm -ivh logstash-5.6.1.rpm</span></div><div class="line">[root@ELK-test software]<span class="comment"># rpm -qa | grep logstash</span></div><div class="line">logstash-5.6.1-1.noarch</div><div class="line">[root@ELK-test software]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@ELK-test software]<span class="comment"># wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.6.1.rpm</span></div><div class="line">[root@ELK-test software]<span class="comment"># yum install elasticsearch-5.6.1.rpm</span></div><div class="line">[root@ELK-test software]<span class="comment"># rpm -qa | grep elasticsearch</span></div><div class="line">elasticsearch-5.6.1-1.noarch</div><div class="line">[root@ELK-test software]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@ELK-test software]<span class="comment"># wget https://artifacts.elastic.co/downloads/kibana/kibana-5.6.1-x86_64.rpm</span></div><div class="line">[root@ELK-test software]<span class="comment"># rpm -ivh kibana-5.6.1-x86_64.rpm</span></div><div class="line">[root@ELK-test software]<span class="comment"># rpm -qa | grep kibana</span></div><div class="line">kibana-5.6.1-1.x86_64</div><div class="line">[root@ELK-test software]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@ELK-test ~]<span class="comment"># ll /data/ELK_data/*</span></div><div class="line">/data/ELK_data/elasticsearch:</div><div class="line">total 8</div><div class="line">drwxr-xr-x. 3 elasticsearch elasticsearch 4096 Sep 22 17:25 data</div><div class="line">drwxr-xr-x. 2 elasticsearch elasticsearch 4096 Oct 19 19:54 logs</div><div class="line"></div><div class="line">/data/ELK_data/kibana:</div><div class="line">total 8</div><div class="line">drwxr-xr-x. 2 kibana kibana 4096 Sep 22 16:50 data</div><div class="line">drwxr-xr-x. 2 kibana kibana 4096 Sep 22 16:50 logs</div><div class="line"></div><div class="line">/data/ELK_data/logstash:</div><div class="line">total 8</div><div class="line">drwxr-xr-x. 4 logstash logstash 4096 Oct 19 19:51 data_192.168.1.21</div><div class="line">drwxr-xr-x. 2 logstash logstash 4096 Oct 19 17:41 logs</div><div class="line">[root@ELK-test ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><h4 id="配置-filebeart"><a href="#配置-filebeart" class="headerlink" title="配置 filebeart"></a>配置 filebeart</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#配置filebeart</span></div><div class="line">[root@DevEVN-21 ~]<span class="comment"># grep -iv '#' /etc/filebeat/filebeat.yml | grep -iv '^$'</span></div><div class="line">filebeat.prospectors:</div><div class="line">- input_type: <span class="built_in">log</span>  <span class="comment">#指定文件的输入类型log(默认)或者stdin</span></div><div class="line">  paths:   <span class="comment">#指定要监控的日志，目前按照Go语言的glob函数处理，没有对配置目录做递归处理，如果指定的文件为/var/log/*.log的话，会读取该目录下所有以log结尾的文件，但是这样不好，在logstash上不好处理，会写到一个文件内，kibana显示会很乱，建议分开写</span></div><div class="line">    - /data/soros/logs/soros-account-service-error.log      <span class="comment">#指定filebeat读取的文件（绝对路径）</span></div><div class="line">  document_type: 192.168.1.21-account_errorlog   <span class="comment">#设定Elasticsearch输出时的document的type字段，也可以用来给日志进行分类</span></div><div class="line"></div><div class="line">- input_type: <span class="built_in">log</span></div><div class="line">  paths:</div><div class="line">    - /data/soros/logs/soros-account-service.log</div><div class="line">  document_type: 192.168.1.21-account_log</div><div class="line"></div><div class="line">output.logstash:</div><div class="line">  hosts: [<span class="string">"192.168.1.41:5044"</span>]     <span class="comment">#指定logstash服务器地址及端口，可以指定多个logstash</span></div><div class="line">[root@DevEVN-21 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>参考：<a href="http://blog.csdn.net/xiongzhichao/article/details/51783704" target="_blank" rel="external">Filebeat的高级配置</a><br><a href="http://www.cnblogs.com/zlslch/p/6622079.html" target="_blank" rel="external">filebeat.yml配置详解</a><br><a href="https://www.ibm.com/developerworks/cn/opensource/os-cn-elk-filebeat/index.html" target="_blank" rel="external">ELK+Filebeat 集中式日志解决方案详解</a>  </p>
<h4 id="配置-logstash"><a href="#配置-logstash" class="headerlink" title="配置 logstash"></a>配置 logstash</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">[root@ELK-test ~]<span class="comment"># grep -iv '#' /etc/logstash/logstash.yml | grep -iv '^$'</span></div><div class="line">path.data: /data/ELK_data/logstash/data</div><div class="line">path.config: /etc/logstash/conf.d</div><div class="line">http.host: <span class="string">"0.0.0.0"</span></div><div class="line">path.logs: /data/ELK_data/logstash/logs</div><div class="line">[root@ELK-test ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#配置logstash</span></div><div class="line">[root@ELK-test ~]<span class="comment"># grep -iv '#' /etc/logstash/conf.d/logstash_192.168.1.21.conf | grep -iv '^$'</span></div><div class="line"><span class="comment">#指定logstash监听filebeat的端口</span></div><div class="line">input &#123;</div><div class="line">  beats &#123;</div><div class="line">    port =&gt; 5044</div><div class="line">    codec =&gt; multiline &#123;</div><div class="line">         pattern =&gt; <span class="string">"^%&#123;YEAR&#125;[/-]%&#123;MONTHNUM&#125;[/-]%&#123;MONTHDAY&#125;[/_]%&#123;TIME&#125; "</span></div><div class="line">         negate =&gt; <span class="literal">true</span></div><div class="line">         what =&gt; previous</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">#pattern：多行日志开始的那一行匹配的</span></div><div class="line"><span class="comment">#pattern negate：是否需要对pattern条件转置使用，不翻转设为true，反转设置为false</span></div><div class="line"><span class="comment">#match：匹配pattern后，与前面(后面)的内容合并为一条日志</span></div><div class="line"><span class="comment">#max_lines：合并的最多行数(包含匹配pattern的那一行)，到了timeout之后，即使没有匹配一个新的pattern（发生一个新的事件），也把已经匹配的日志事件发送出去</span></div><div class="line"></div><div class="line"><span class="comment">#output测试输出到控制台</span></div><div class="line">output &#123;</div><div class="line"><span class="comment">#program logs</span></div><div class="line">    <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">'192.168.1.21-account_errorlog'</span>&#123;        <span class="comment">#'192.168.1.21-account_errorlog'为filebeat配置中由document_type定义的</span></div><div class="line">        elasticsearch &#123;          <span class="comment">#输出到elasticsearch中</span></div><div class="line">                hosts =&gt; [<span class="string">"192.168.1.41:9200"</span>,<span class="string">"192.168.1.42:9200"</span>,<span class="string">"192.168.1.43:9200"</span>]       <span class="comment">#指定elasticsearch主机</span></div><div class="line">		index =&gt; <span class="string">"%&#123;type&#125;-%&#123;+YYYY.MM.dd&#125;"</span></div><div class="line">		document_type =&gt; <span class="string">"log"</span>       <span class="comment">#设定Elasticsearch输出时的document的type字段，也可以用来给日志进行分类</span></div><div class="line">		template_overwrite =&gt; <span class="literal">true</span>       <span class="comment">#如果设置为true，模板名字一样的时候，新的模板会覆盖旧的模板</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">'192.168.1.21-account_log'</span>&#123;</div><div class="line">        elasticsearch &#123;</div><div class="line">                hosts =&gt; [<span class="string">"192.168.1.41:9200"</span>,<span class="string">"192.168.1.42:9200"</span>,<span class="string">"192.168.1.43:9200"</span>]</div><div class="line">		index =&gt; <span class="string">"%&#123;type&#125;-%&#123;+YYYY.MM.dd&#125;"</span></div><div class="line">		document_type =&gt; <span class="string">"log"</span></div><div class="line">		template_overwrite =&gt; <span class="literal">true</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">[root@ELK-test ~]<span class="comment">#</span></div><div class="line"></div><div class="line">其他机器的logstash配置同上</div></pre></td></tr></table></figure>
<p>参考：<a href="http://blog.csdn.net/shudaqi2010/article/details/53941389" target="_blank" rel="external">Elasticsearch之<em>default</em>—— 为索引添加默认映射</a><br><a href="http://blog.chinaunix.net/uid-532511-id-4845841.html" target="_blank" rel="external">logstash 多行数据合并 &amp; 日志时间字段解析</a>  </p>
<h4 id="配置-elasticsearch集群"><a href="#配置-elasticsearch集群" class="headerlink" title="配置 elasticsearch集群"></a>配置 elasticsearch集群</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Julend_es1 节点</span></div><div class="line">[root@ELK-test ~]<span class="comment"># grep -iv '#' /etc/elasticsearch/elasticsearch.yml | grep -iv '^$'</span></div><div class="line">cluster.name: <span class="string">"Julend_ES-cluster"</span></div><div class="line">node.name: Julend_es1</div><div class="line">node.data: <span class="literal">true</span></div><div class="line">http.enabled: <span class="literal">true</span></div><div class="line">path.data: /data/ELK_data/elasticsearch/data</div><div class="line">path.logs: /data/ELK_data/elasticsearch/logs</div><div class="line">network.host: 0.0.0.0</div><div class="line">http.port: 9200</div><div class="line">http.cors.enabled: <span class="literal">true</span></div><div class="line">http.cors.allow-origin: <span class="string">"*"</span></div><div class="line">discovery.zen.ping.unicast.hosts: [<span class="string">"192.168.1.41"</span>, <span class="string">"192.168.1.42"</span>, <span class="string">"192.168.1.43"</span>]</div><div class="line">discovery.zen.minimum_master_nodes: 3</div><div class="line">gateway.recover_after_nodes: 2</div><div class="line">[root@ELK-test ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Julend_es2 节点</span></div><div class="line">[root@ELK-test2 ~]<span class="comment"># grep -iv '#' /etc/elasticsearch/elasticsearch.yml | grep -iv '^$'</span></div><div class="line">cluster.name: <span class="string">"Julend_ES-cluster"</span></div><div class="line">node.name: Julend_es2</div><div class="line">node.data: <span class="literal">true</span></div><div class="line">http.enabled: <span class="literal">true</span></div><div class="line">path.data: /data/ELK_data/elasticsearch/data</div><div class="line">path.logs: /data/ELK_data/elasticsearch/logs</div><div class="line">network.host: 0.0.0.0</div><div class="line">http.port: 9200</div><div class="line">http.cors.enabled: <span class="literal">true</span></div><div class="line">http.cors.allow-origin: <span class="string">"*"</span></div><div class="line">discovery.zen.ping.unicast.hosts: [<span class="string">"192.168.1.41"</span>, <span class="string">"192.168.1.42"</span>, <span class="string">"193.168.1.43"</span>]</div><div class="line">discovery.zen.minimum_master_nodes: 3</div><div class="line">gateway.recover_after_nodes: 2</div><div class="line">[root@ELK-test2 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Julend_es3 节点</span></div><div class="line">[root@ELK-test3 ~]<span class="comment"># grep -iv '#' /etc/elasticsearch/elasticsearch.yml | grep -iv '^$'</span></div><div class="line">cluster.name: <span class="string">"Julend_ES-cluster"</span></div><div class="line">node.name: Julend_es3</div><div class="line">node.data: <span class="literal">true</span></div><div class="line">http.enabled: <span class="literal">true</span></div><div class="line">path.data: /data/ELK_data/elasticsearch/data</div><div class="line">path.logs: /data/ELK_data/elasticsearch/logs</div><div class="line">network.host: 0.0.0.0</div><div class="line">http.port: 9200</div><div class="line">http.cors.enabled: <span class="literal">true</span></div><div class="line">http.cors.allow-origin: <span class="string">"*"</span></div><div class="line">discovery.zen.ping.unicast.hosts: [<span class="string">"192.168.1.41"</span>, <span class="string">"192.168.1.42"</span>,<span class="string">"192.168.1.43"</span>]</div><div class="line">discovery.zen.minimum_master_nodes: 3</div><div class="line">gateway.recover_after_nodes: 2</div><div class="line">[root@ELK-test3 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>参考：<a href="http://blog.csdn.net/shudaqi2010/article/details/53941389" target="_blank" rel="external">http://blog.csdn.net/shudaqi2010/article/details/53941389</a><br><a href="http://blog.chinaunix.net/uid-532511-id-4854331.html" target="_blank" rel="external">http://blog.chinaunix.net/uid-532511-id-4854331.html</a><br><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/index.html" target="_blank" rel="external">https://www.elastic.co/guide/cn/elasticsearch/guide/current/index.html</a>  </p>
<h4 id="配置-Kibana"><a href="#配置-Kibana" class="headerlink" title="配置 Kibana"></a>配置 Kibana</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#kibana只是一个WEB GUI展示工具，数据均存储在elasticsearch中，故登陆任何一台kibana看到的数据都一样</span></div><div class="line"><span class="comment">#kibana1配置：</span></div><div class="line">[root@ELK-test ~]<span class="comment"># grep -iv '#' /etc/kibana/kibana.yml | grep -iv '^$'</span></div><div class="line">server.port: 5601</div><div class="line">server.host: <span class="string">"192.168.1.41"</span></div><div class="line">server.name: <span class="string">"Julend_Kibana"</span></div><div class="line">elasticsearch.url: <span class="string">"http://192.168.1.42:9200"</span></div><div class="line">[root@ELK-test ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#kibana2配置：</span></div><div class="line">[root@ELK-test2 ~]<span class="comment"># grep -iv '#' /etc/kibana/kibana.yml | grep -iv '^$'</span></div><div class="line">server.port: 5601</div><div class="line">server.host: <span class="string">"192.168.1.42"</span></div><div class="line">elasticsearch.url: <span class="string">"http://192.168.1.42:9200"</span></div><div class="line">[root@ELK-test2 ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#kibana3配置：</span></div><div class="line">[root@ELK-test3 ~]<span class="comment"># grep -iv '#' /etc/kibana/kibana.yml | grep -iv '^$'</span></div><div class="line">server.port: 5601</div><div class="line">server.host: <span class="string">"192.168.1.43"</span></div><div class="line">elasticsearch.url: <span class="string">"http://192.168.1.43:9200"</span></div><div class="line">[root@ELK-test3 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>参考：<a href="http://blog.csdn.net/ming_311/article/details/50619859" target="_blank" rel="external">Kibana基本使用</a><br><a href="https://segmentfault.com/a/1190000002972420" target="_blank" rel="external">ELK：kibana使用的lucene查询语法</a><br><a href="http://www.ttlsa.com/elk/elk-kibana-query-and-filter/" target="_blank" rel="external">ELK kibana查询与过滤</a><br><a href="http://blog.csdn.net/caisini_vc/article/details/53377756" target="_blank" rel="external">Lucene查询语法详解（Lucene query syntax）- 用于Kibana搜索语句</a>  </p>
<h4 id="配置nginx"><a href="#配置nginx" class="headerlink" title="配置nginx"></a>配置nginx</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#nginx配置</span></div><div class="line">[root@nginx ~]<span class="comment"># cat /etc/nginx/conf.d/192.168.1.41-43.conf </span></div><div class="line">server &#123;</div><div class="line">	listen       443;</div><div class="line">	server_name  domain_name;</div><div class="line">	ssl on;</div><div class="line">	include conf.d/ssl_conf;</div><div class="line"></div><div class="line">	access_log  /var/<span class="built_in">log</span>/kibana/access.log main;</div><div class="line">	error_log /var/<span class="built_in">log</span>/kibana/error.log;</div><div class="line"></div><div class="line">	location / &#123;</div><div class="line">	auth_basic <span class="string">"Restricted"</span>;</div><div class="line">	auth_basic_user_file /etc/nginx/conf.d/.site_kibana_pass;</div><div class="line">	proxy_pass http://testelk;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">server &#123;</div><div class="line">	listen 80;</div><div class="line">	server_name domain_name;</div><div class="line">	rewrite ^/(.*)$ https://domain_name permanent;</div><div class="line">&#125;</div><div class="line"></div><div class="line">upstream domain_name &#123;</div><div class="line">	ip_hash;</div><div class="line">	server 192.168.1.41:5601 max_fails=4 fail_timeout=20s weight=4;</div><div class="line">	server 192.168.1.42:5601 max_fails=4 fail_timeout=20s weight=4;</div><div class="line">	server 192.168.1.43:5601 max_fails=4 fail_timeout=20s weight=4;</div><div class="line">&#125;</div><div class="line">[root@nginx ~]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@nginx ~]<span class="comment"># nginx -t</span></div><div class="line">[root@nginx ~]<span class="comment"># nginx -s reload</span></div></pre></td></tr></table></figure>
<h4 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@DevEVN-21 ~]<span class="comment"># systemctl enable filebeat</span></div><div class="line">[root@DevEVN-21 ~]<span class="comment"># systemctl start filebeat</span></div><div class="line"></div><div class="line">[root@ELK-test ~]<span class="comment"># /usr/share/logstash/bin/logstash --path.settings /etc/logstash/ -f /etc/logstash/conf.d/logstash_192.168.1.21.conf --path.data /data/ELK_data/logstash/data_192.168.1.21</span></div><div class="line">Sending Logstash<span class="string">'s logs to /data/ELK_data/logstash/logs which is now configured via log4j2.properties</span></div><div class="line">...</div><div class="line">[root@ELK-test ~]#</div><div class="line"></div><div class="line">#启动三台elasticsearch</div><div class="line">[root@ELK-test ~]# systemctl enable elasticsearch</div><div class="line">[root@ELK-test ~]# systemctl start elasticsearch</div><div class="line"></div><div class="line">[root@ELK-test ~]# systemctl enable kibana</div><div class="line">[root@ELK-test ~]# systemctl start kibana</div></pre></td></tr></table></figure>
<h5 id="logstash-服务启动日志"><a href="#logstash-服务启动日志" class="headerlink" title="logstash 服务启动日志"></a>logstash 服务启动日志</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># tail -f /data/ELK_data/logstash/logs/logstash-plain.log </span></div><div class="line">[2017-10-19T16:35:07,048][INFO ][logstash.outputs.elasticsearch] Running health check to see <span class="keyword">if</span> an Elasticsearch connection is working &#123;:healthcheck_url=&gt;http://localhost:9</div><div class="line">200/, :path=&gt;<span class="string">"/"</span>&#125;[2017-10-19T16:35:07,146][WARN ][logstash.outputs.elasticsearch] Restored connection to ES instance &#123;:url=&gt;<span class="string">"http://localhost:9200/"</span>&#125;</div><div class="line">[2017-10-19T16:35:07,148][INFO ][logstash.outputs.elasticsearch] Using mapping template from &#123;:path=&gt;nil&#125;</div><div class="line">[2017-10-19T16:35:07,188][INFO ][logstash.outputs.elasticsearch] Attempting to install template &#123;:manage_template=&gt;&#123;<span class="string">"template"</span>=&gt;<span class="string">"logstash-*"</span>, <span class="string">"version"</span>=&gt;50001, <span class="string">"settings"</span>=&gt;</div><div class="line">&#123;<span class="string">"index.refresh_interval"</span>=&gt;<span class="string">"5s"</span>&#125;, <span class="string">"mappings"</span>=&gt;&#123;<span class="string">"_default_"</span>=&gt;&#123;<span class="string">"_all"</span>=&gt;&#123;<span class="string">"enabled"</span>=&gt;<span class="literal">true</span>, <span class="string">"norms"</span>=&gt;<span class="literal">false</span>&#125;, <span class="string">"dynamic_templates"</span>=&gt;[&#123;<span class="string">"message_field"</span>=&gt;&#123;<span class="string">"path_match"</span>=&gt;<span class="string">"message"</span>, <span class="string">"match_mapping_type"</span>=&gt;<span class="string">"string"</span>, <span class="string">"mapping"</span>=&gt;&#123;<span class="string">"type"</span>=&gt;<span class="string">"text"</span>, <span class="string">"norms"</span>=&gt;<span class="literal">false</span>&#125;&#125;&#125;, &#123;<span class="string">"string_fields"</span>=&gt;&#123;<span class="string">"match"</span>=&gt;<span class="string">"*"</span>, <span class="string">"match_mapping_type"</span>=&gt;<span class="string">"string"</span>, <span class="string">"mapping"</span>=&gt;&#123;<span class="string">"type"</span>=&gt;<span class="string">"text"</span>, <span class="string">"norms"</span>=&gt;<span class="literal">false</span>, <span class="string">"fields"</span>=&gt;&#123;<span class="string">"keyword"</span>=&gt;&#123;<span class="string">"type"</span>=&gt;<span class="string">"keyword"</span>, <span class="string">"ignore_above"</span>=&gt;256&#125;&#125;&#125;&#125;&#125;], <span class="string">"properties"</span>=&gt;&#123;<span class="string">"@timestamp"</span>=&gt;&#123;<span class="string">"type"</span>=&gt;<span class="string">"date"</span>, <span class="string">"include_in_all"</span>=&gt;<span class="literal">false</span>&#125;, <span class="string">"@version"</span>=&gt;&#123;<span class="string">"type"</span>=&gt;<span class="string">"keyword"</span>, <span class="string">"include_in_all"</span>=&gt;<span class="literal">false</span>&#125;, <span class="string">"geoip"</span>=&gt;&#123;<span class="string">"dynamic"</span>=&gt;<span class="literal">true</span>, <span class="string">"properties"</span>=&gt;&#123;<span class="string">"ip"</span>=&gt;&#123;<span class="string">"type"</span>=&gt;<span class="string">"ip"</span>&#125;, <span class="string">"location"</span>=&gt;&#123;<span class="string">"type"</span>=&gt;<span class="string">"geo_point"</span>&#125;, <span class="string">"latitude"</span>=&gt;&#123;<span class="string">"type"</span>=&gt;<span class="string">"half_float"</span>&#125;, <span class="string">"longitude"</span>=&gt;&#123;<span class="string">"type"</span>=&gt;<span class="string">"half_float"</span>&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;[2017-10-19T16:35:07,194][INFO ][logstash.outputs.elasticsearch] New Elasticsearch output &#123;:class=&gt;<span class="string">"LogStash::Outputs::ElasticSearch"</span>, :hosts=&gt;[<span class="string">"//localhost:9200"</span>]&#125;</div><div class="line">[2017-10-19T16:35:07,197][INFO ][logstash.pipeline        ] Starting pipeline &#123;<span class="string">"id"</span>=&gt;<span class="string">"main"</span>, <span class="string">"pipeline.workers"</span>=&gt;2, <span class="string">"pipeline.batch.size"</span>=&gt;125, <span class="string">"pipeline.batch.delay"</span>=&gt;5, <span class="string">"</span></div><div class="line">pipeline.max_inflight"=&gt;250&#125;[2017-10-19T16:35:07,582][INFO ][logstash.inputs.beats    ] Beats inputs: Starting input listener &#123;:address=&gt;<span class="string">"0.0.0.0:5044"</span>&#125;</div><div class="line">[2017-10-19T16:35:07,615][INFO ][logstash.pipeline        ] Pipeline main started</div><div class="line">[2017-10-19T16:35:07,623][INFO ][org.logstash.beats.Server] Starting server on port: 5044</div><div class="line">[2017-10-19T16:35:07,702][INFO ][logstash.agent           ] Successfully started Logstash API endpoint &#123;:port=&gt;9600&#125;</div></pre></td></tr></table></figure>
<h5 id="filebeat-服务启动日志"><a href="#filebeat-服务启动日志" class="headerlink" title="filebeat 服务启动日志"></a>filebeat 服务启动日志</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">[root@DevEVN-21 ~]<span class="comment"># tail -f /var/log/filebeat/filebeat</span></div><div class="line">2017-10-19T15:29:38+08:00 INFO Prospector with previous states loaded: 1</div><div class="line">2017-10-19T15:29:38+08:00 INFO Starting prospector of <span class="built_in">type</span>: <span class="built_in">log</span>; id: 14402121705362619298 </div><div class="line">2017-10-19T15:29:38+08:00 INFO Prospector with previous states loaded: 4</div><div class="line">2017-10-19T15:29:38+08:00 INFO Starting prospector of <span class="built_in">type</span>: <span class="built_in">log</span>; id: 3085250400820318742 </div><div class="line">2017-10-19T15:29:38+08:00 INFO Prospector with previous states loaded: 10</div><div class="line">2017-10-19T15:29:38+08:00 INFO Starting prospector of <span class="built_in">type</span>: <span class="built_in">log</span>; id: 9380947956116938860 </div><div class="line">2017-10-19T15:29:38+08:00 INFO Prospector with previous states loaded: 6</div><div class="line">2017-10-19T15:29:38+08:00 INFO Starting prospector of <span class="built_in">type</span>: <span class="built_in">log</span>; id: 8452203097583608250 </div><div class="line">2017-10-19T15:29:38+08:00 INFO Loading and starting Prospectors completed. Enabled prospectors: 41</div><div class="line">2017-10-19T15:29:48+08:00 INFO Harvester started <span class="keyword">for</span> file: /data/soros/logs/soros-batch.log</div><div class="line">2017-10-19T15:29:48+08:00 INFO Harvester started <span class="keyword">for</span> file: /data/soros/logs/soros-marketing-service-error.log</div><div class="line">2017-10-19T15:29:48+08:00 INFO Harvester started <span class="keyword">for</span> file: /data/soros/logs/soros-marketing-service.log</div><div class="line">2017-10-19T15:29:48+08:00 INFO Harvester started <span class="keyword">for</span> file: /data/soros/logs/soros-order-service.log</div><div class="line">2017-10-19T15:29:58+08:00 INFO Harvester started <span class="keyword">for</span> file: /data/soros/logs/soros-pay-service.log</div><div class="line">2017-10-19T15:29:58+08:00 INFO Harvester started <span class="keyword">for</span> file: /data/soros/logs/soros-risk-service.log</div><div class="line">2017-10-19T15:30:08+08:00 INFO Non-zero metrics <span class="keyword">in</span> the last 30s: filebeat.harvester.open_files=8 filebeat.harvester.running=8 filebeat.harvester.started=8 libbeat.logstash.</div><div class="line">call_count.PublishEvents=6 libbeat.logstash.publish.read_bytes=108 libbeat.logstash.publish.write_bytes=125904 libbeat.logstash.published_and_acked_events=4469 libbeat.publisher.published_events=4469 publish.events=4535 registrar.states.current=58 registrar.states.update=4535 registrar.writes=6</div><div class="line">2017-10-19T15:30:38+08:00 INFO Non-zero metrics <span class="keyword">in</span> the last 30s: filebeat.harvester.open_files=12 filebeat.harvester.running=12 filebeat.harvester.started=12 libbeat.logsta</div><div class="line">sh.call_count.PublishEvents=7 libbeat.logstash.publish.read_bytes=54 libbeat.logstash.publish.write_bytes=127592 libbeat.logstash.published_and_acked_events=4581 libbeat.publisher.published_events=4581 publish.events=4593 registrar.states.update=4593 registrar.writes=7</div><div class="line">...</div><div class="line">[root@DevEVN-21 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h5 id="elasticsearch-服务启动日志"><a href="#elasticsearch-服务启动日志" class="headerlink" title="elasticsearch 服务启动日志"></a>elasticsearch 服务启动日志</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line">[root@ELK-test logs]<span class="comment"># tail -f  Julend_ES-cluster.log</span></div><div class="line">[2017-10-19T17:45:58,104][INFO ][o.e.n.Node               ] [Julend_es1] initializing ...</div><div class="line">[2017-10-19T17:45:58,180][INFO ][o.e.e.NodeEnvironment    ] [Julend_es1] using [1] data paths, mounts [[/data (/dev/sdb1)]], net usable_space [270.3gb], net total_space [29</div><div class="line">5.1gb], spins? [possibly], types [ext4][2017-10-19T17:45:58,180][INFO ][o.e.e.NodeEnvironment    ] [Julend_es1] heap size [1.9gb], compressed ordinary object pointers [<span class="literal">true</span>]</div><div class="line">[2017-10-19T17:45:58,857][INFO ][o.e.n.Node               ] [Julend_es1] node name [Julend_es1], node ID [mXtk8dQeQh-amui<span class="_">-d</span>5pVoA]</div><div class="line">[2017-10-19T17:45:58,857][INFO ][o.e.n.Node               ] [Julend_es1] version[5.6.1], pid[8287], build[667b497/2017-09-14T19:22:05.189Z], OS[Linux/3.10.0-514.el7.x86_64/</div><div class="line">amd64], JVM[Oracle Corporation/Java HotSpot(TM) 64-Bit Server VM/1.8.0_144/25.144-b01][2017-10-19T17:45:58,857][INFO ][o.e.n.Node               ] [Julend_es1] JVM arguments [-Xms2g, -Xmx2g, -XX:+UseConcMarkSweepGC, -XX:CMSInitiatingOccupancyFraction=75, -XX:</div><div class="line">+UseCMSInitiatingOccupancyOnly, -XX:+AlwaysPreTouch, -Xss1m, -Djava.awt.headless=<span class="literal">true</span>, -Dfile.encoding=UTF-8, -Djna.nosys=<span class="literal">true</span>, -Djdk.io.permissionsUseCanonicalPath=<span class="literal">true</span>, -Dio.netty.noUnsafe=<span class="literal">true</span>, -Dio.netty.noKeySetOptimization=<span class="literal">true</span>, -Dio.netty.recycler.maxCapacityPerThread=0, -D<span class="built_in">log</span>4j.shutdownHookEnabled=<span class="literal">false</span>, -D<span class="built_in">log</span>4j2.disable.jmx=<span class="literal">true</span>, -D<span class="built_in">log</span>4j.skipJansi=<span class="literal">true</span>, -XX:+HeapDumpOnOutOfMemoryError, -Des.path.home=/usr/share/elasticsearch][2017-10-19T17:45:59,707][INFO ][o.e.p.PluginsService     ] [Julend_es1] loaded module [aggs-matrix-stats]</div><div class="line">[2017-10-19T17:45:59,707][INFO ][o.e.p.PluginsService     ] [Julend_es1] loaded module [ingest-common]</div><div class="line">[2017-10-19T17:45:59,707][INFO ][o.e.p.PluginsService     ] [Julend_es1] loaded module [lang-expression]</div><div class="line">[2017-10-19T17:45:59,707][INFO ][o.e.p.PluginsService     ] [Julend_es1] loaded module [lang-groovy]</div><div class="line">[2017-10-19T17:45:59,707][INFO ][o.e.p.PluginsService     ] [Julend_es1] loaded module [lang-mustache]</div><div class="line">[2017-10-19T17:45:59,707][INFO ][o.e.p.PluginsService     ] [Julend_es1] loaded module [lang-painless]</div><div class="line">[2017-10-19T17:45:59,707][INFO ][o.e.p.PluginsService     ] [Julend_es1] loaded module [parent-join]</div><div class="line">[2017-10-19T17:45:59,707][INFO ][o.e.p.PluginsService     ] [Julend_es1] loaded module [percolator]</div><div class="line">[2017-10-19T17:45:59,707][INFO ][o.e.p.PluginsService     ] [Julend_es1] loaded module [reindex]</div><div class="line">[2017-10-19T17:45:59,708][INFO ][o.e.p.PluginsService     ] [Julend_es1] loaded module [transport-netty3]</div><div class="line">[2017-10-19T17:45:59,708][INFO ][o.e.p.PluginsService     ] [Julend_es1] loaded module [transport-netty4]</div><div class="line">[2017-10-19T17:45:59,708][INFO ][o.e.p.PluginsService     ] [Julend_es1] no plugins loaded</div><div class="line">[2017-10-19T17:46:01,565][INFO ][o.e.d.DiscoveryModule    ] [Julend_es1] using discovery <span class="built_in">type</span> [zen]</div><div class="line">[2017-10-19T17:46:02,716][INFO ][o.e.n.Node               ] [Julend_es1] initialized</div><div class="line">[2017-10-19T17:46:02,716][INFO ][o.e.n.Node               ] [Julend_es1] starting ...</div><div class="line">[2017-10-19T17:46:02,854][INFO ][o.e.t.TransportService   ] [Julend_es1] publish_address &#123;192.168.1.41:9300&#125;, bound_addresses &#123;[::]:9300&#125;</div><div class="line">[2017-10-19T17:46:02,863][INFO ][o.e.b.BootstrapChecks    ] [Julend_es1] bound or publishing to a non-loopback or non-link-local address, enforcing bootstrap checks</div><div class="line">[2017-10-19T17:46:05,946][WARN ][o.e.d.z.ZenDiscovery     ] [Julend_es1] failed to connect to master [&#123;Julend_es3&#125;&#123;Go1e5drSSum7gbrKpIef8g&#125;&#123;KF8fUy32Q-WhSJDBCrdVrQ&#125;&#123;192.168.1</div><div class="line">.43&#125;&#123;192.168.1.43:9300&#125;], retrying...org.elasticsearch.transport.ConnectTransportException: [Julend_es3][192.168.1.43:9300] connect_timeout[30s]</div><div class="line">	at org.elasticsearch.transport.netty4.Netty4Transport.connectToChannels(Netty4Transport.java:361) ~[?:?]</div><div class="line">	at org.elasticsearch.transport.TcpTransport.openConnection(TcpTransport.java:561) ~[elasticsearch-5.6.1.jar:5.6.1]</div><div class="line">	at org.elasticsearch.transport.TcpTransport.connectToNode(TcpTransport.java:464) ~[elasticsearch-5.6.1.jar:5.6.1]</div><div class="line">	at org.elasticsearch.transport.TransportService.connectToNode(TransportService.java:332) ~[elasticsearch-5.6.1.jar:5.6.1]</div><div class="line">	at org.elasticsearch.transport.TransportService.connectToNode(TransportService.java:319) ~[elasticsearch-5.6.1.jar:5.6.1]</div><div class="line">	at org.elasticsearch.discovery.zen.ZenDiscovery.joinElectedMaster(ZenDiscovery.java:458) [elasticsearch-5.6.1.jar:5.6.1]</div><div class="line">	at org.elasticsearch.discovery.zen.ZenDiscovery.innerJoinCluster(ZenDiscovery.java:410) [elasticsearch-5.6.1.jar:5.6.1]</div><div class="line">	at org.elasticsearch.discovery.zen.ZenDiscovery.access<span class="variable">$4100</span>(ZenDiscovery.java:82) [elasticsearch-5.6.1.jar:5.6.1]</div><div class="line">	at org.elasticsearch.discovery.zen.ZenDiscovery<span class="variable">$JoinThreadControl</span><span class="variable">$1</span>.run(ZenDiscovery.java:1188) [elasticsearch-5.6.1.jar:5.6.1]</div><div class="line">	at org.elasticsearch.common.util.concurrent.ThreadContext<span class="variable">$ContextPreservingRunnable</span>.run(ThreadContext.java:569) [elasticsearch-5.6.1.jar:5.6.1]</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_144]</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor<span class="variable">$Worker</span>.run(ThreadPoolExecutor.java:624) [?:1.8.0_144]</div><div class="line">	at java.lang.Thread.run(Thread.java:748) [?:1.8.0_144]</div><div class="line">Caused by: io.netty.channel.AbstractChannel<span class="variable">$AnnotatedConnectException</span>: Connection refused: 192.168.1.43/192.168.1.43:9300</div><div class="line">	at sun.nio.ch.SocketChannelImpl.checkConnect(Native Method) ~[?:?]</div><div class="line">	at sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:717) ~[?:?]</div><div class="line">	at io.netty.channel.socket.nio.NioSocketChannel.doFinishConnect(NioSocketChannel.java:352) ~[?:?]</div><div class="line">	at io.netty.channel.nio.AbstractNioChannel<span class="variable">$AbstractNioUnsafe</span>.finishConnect(AbstractNioChannel.java:340) ~[?:?]</div><div class="line">	at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:632) ~[?:?]</div><div class="line">	at io.netty.channel.nio.NioEventLoop.processSelectedKeysPlain(NioEventLoop.java:544) ~[?:?]</div><div class="line">	at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:498) ~[?:?]</div><div class="line">	at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:458) ~[?:?]</div><div class="line">	at io.netty.util.concurrent.SingleThreadEventExecutor<span class="variable">$5</span>.run(SingleThreadEventExecutor.java:858) ~[?:?]</div><div class="line">	... 1 more</div><div class="line">Caused by: java.net.ConnectException: Connection refused</div><div class="line">	at sun.nio.ch.SocketChannelImpl.checkConnect(Native Method) ~[?:?]</div><div class="line">	at sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:717) ~[?:?]</div><div class="line">	at io.netty.channel.socket.nio.NioSocketChannel.doFinishConnect(NioSocketChannel.java:352) ~[?:?]</div><div class="line">	at io.netty.channel.nio.AbstractNioChannel<span class="variable">$AbstractNioUnsafe</span>.finishConnect(AbstractNioChannel.java:340) ~[?:?]</div><div class="line">	at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:632) ~[?:?]</div><div class="line">	at io.netty.channel.nio.NioEventLoop.processSelectedKeysPlain(NioEventLoop.java:544) ~[?:?]</div><div class="line">	at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:498) ~[?:?]</div><div class="line">	at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:458) ~[?:?]</div><div class="line">	at io.netty.util.concurrent.SingleThreadEventExecutor<span class="variable">$5</span>.run(SingleThreadEventExecutor.java:858) ~[?:?]</div><div class="line">	... 1 more</div><div class="line">[2017-10-19T17:46:08,968][WARN ][o.e.d.z.ZenDiscovery     ] [Julend_es1] not enough master nodes discovered during pinging (found [[Candidate&#123;node=&#123;Julend_es2&#125;&#123;VQf-ph7NRTei</div><div class="line">EVHqAT4pRw&#125;&#123;v2HyA4hTT0miTzlFmi1vZg&#125;&#123;192.168.1.42&#125;&#123;192.168.1.42:9300&#125;, clusterStateVersion=-1&#125;, Candidate&#123;node=&#123;Julend_es1&#125;&#123;mXtk8dQeQh-amui<span class="_">-d</span>5pVoA&#125;&#123;1f1jfhuQQCyor5YXnm8oAg&#125;&#123;192.168.1.41&#125;&#123;192.168.1.41:9300&#125;, clusterStateVersion=-1&#125;]], but needed [3]), pinging again[2017-10-19T17:46:11,971][WARN ][o.e.d.z.ZenDiscovery     ] [Julend_es1] not enough master nodes discovered during pinging (found [[Candidate&#123;node=&#123;Julend_es2&#125;&#123;VQf-ph7NRTei</div><div class="line">EVHqAT4pRw&#125;&#123;v2HyA4hTT0miTzlFmi1vZg&#125;&#123;192.168.1.42&#125;&#123;192.168.1.42:9300&#125;, clusterStateVersion=-1&#125;, Candidate&#123;node=&#123;Julend_es1&#125;&#123;mXtk8dQeQh-amui<span class="_">-d</span>5pVoA&#125;&#123;1f1jfhuQQCyor5YXnm8oAg&#125;&#123;192.168.1.41&#125;&#123;192.168.1.41:9300&#125;, clusterStateVersion=-1&#125;]], but needed [3]), pinging again[2017-10-19T17:46:15,025][INFO ][o.e.c.s.ClusterService   ] [Julend_es1] detected_master &#123;Julend_es3&#125;&#123;Go1e5drSSum7gbrKpIef8g&#125;&#123;60Fb2YJZQ0Ct2uL7PcsuRQ&#125;&#123;192.168.1.43&#125;&#123;192.168.</div><div class="line">1.43:9300&#125;, added &#123;&#123;Julend_es2&#125;&#123;VQf-ph7NRTeiEVHqAT4pRw&#125;&#123;v2HyA4hTT0miTzlFmi1vZg&#125;&#123;192.168.1.42&#125;&#123;192.168.1.42:9300&#125;,&#123;Julend_es3&#125;&#123;Go1e5drSSum7gbrKpIef8g&#125;&#123;60Fb2YJZQ0Ct2uL7PcsuRQ&#125;&#123;192.168.1.43&#125;&#123;192.168.1.43:9300&#125;,&#125;, reason: zen-disco-receive(from master [master &#123;Julend_es3&#125;&#123;Go1e5drSSum7gbrKpIef8g&#125;&#123;60Fb2YJZQ0Ct2uL7PcsuRQ&#125;&#123;192.168.1.43&#125;&#123;192.168.1.43:9300&#125; committed version [1]])[2017-10-19T17:46:15,056][INFO ][o.e.h.n.Netty4HttpServerTransport] [Julend_es1] publish_address &#123;192.168.1.41:9200&#125;, bound_addresses &#123;[::]:9200&#125;</div><div class="line">[2017-10-19T17:46:15,056][INFO ][o.e.n.Node               ] [Julend_es1] started</div><div class="line">...</div><div class="line">[root@ELK-test logs]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h4 id="查看-elasticsearch-集群状态"><a href="#查看-elasticsearch-集群状态" class="headerlink" title="查看 elasticsearch 集群状态"></a>查看 elasticsearch 集群状态</h4><h5 id="获取集群中节点列表"><a href="#获取集群中节点列表" class="headerlink" title="获取集群中节点列表"></a>获取集群中节点列表</h5><p><code>curl &#39;localhost:9200/_cat/nodes?v&#39;</code><br><img src="http://note.youdao.com/yws/api/personal/file/329B6F6EA752494CB4C4D6031C77B479?method=download&amp;shareKey=a3fee6f200f0e9d1d5f6382d823d4748" alt="获取集群中节点列表">  </p>
<h5 id="集群健康检查"><a href="#集群健康检查" class="headerlink" title="集群健康检查"></a>集群健康检查</h5><p><code>curl &#39;localhost:9200/_cat/health?v&#39;</code><br><img src="http://note.youdao.com/yws/api/personal/file/61C65EEE2B034AD09FC4AF4CF3DC3C12?method=download&amp;shareKey=b3bb5668a73fdb35647afed00419fd10" alt="集群健康检查">  </p>
<h5 id="获取ElasticSearch索引"><a href="#获取ElasticSearch索引" class="headerlink" title="获取ElasticSearch索引"></a>获取ElasticSearch索引</h5><p><code>curl &#39;localhost:9200/_cat/indices?v&#39;</code><br><img src="http://note.youdao.com/yws/api/personal/file/E862D2654364496E8474E7F44E5F09A4?method=download&amp;shareKey=6b9d3f0297cc80f23b43479a6c8a9841" alt="获取ElasticSearch索引"> </p>
<h5 id="本机节点查询"><a href="#本机节点查询" class="headerlink" title="本机节点查询"></a>本机节点查询</h5><p><code>curl -XGET &#39;localhost:9200/_nodes/_local?pretty&#39;</code><br><img src="http://note.youdao.com/yws/api/personal/file/7986E5063E69469C9C77699A37CE0244?method=download&amp;shareKey=ed6aa6f801cc993ccfd70b443772637a" alt="本机节点查询1">  </p>
<p><code>curl -XGET &#39;localhost:9200/_nodes/_local/network?pretty&#39;</code><br><img src="http://note.youdao.com/yws/api/personal/file/0E9EBB54EC8D43B7A4014DA31E70ADDE?method=download&amp;shareKey=4c3db04e15fe968eb9e9cb288a4a0069" alt="本机节点查询2">  </p>
<h5 id="节点状态"><a href="#节点状态" class="headerlink" title="节点状态"></a>节点状态</h5><p><code>curl -XGET &#39;http://localhost:9200/_nodes/stats?pretty&#39;</code><br><img src="http://note.youdao.com/yws/api/personal/file/99AAAE558FE74153914FA78F844400F9?method=download&amp;shareKey=7b22a74b7e6c7226be128574a3af75a9" alt="节点状态1">  </p>
<p><code>curl -XGET &#39;http://localhost:9200/_nodes/stats/os,process?pretty&#39;</code><br><img src="http://note.youdao.com/yws/api/personal/file/C9B6B407B93E4214B63331975EB47EF6?method=download&amp;shareKey=298f0b1e82cc9785fb9e321199bf6909" alt="节点状态2">  </p>
<p><code>curl -XGET &#39;http://localhost:9200/_nodes?pretty&#39;</code><br><img src="http://note.youdao.com/yws/api/personal/file/BB22940B585B4F90BFB2F8349A39B9FA?method=download&amp;shareKey=76c793558852d58d72fca64d37eec706" alt="节点状态3">  </p>
<p><code>curl -XGET &#39;http://localhost:9200/_nodes/process?pretty&#39;</code><br><img src="http://note.youdao.com/yws/api/personal/file/C29147AE73D345D8B50926CB00B4AF29?method=download&amp;shareKey=d32513c28c63fa9658abde8da2bde251" alt="节点状态4">  </p>
<p><code>curl -XGET &#39;http://localhost:9200/_nodes/os?pretty&#39;</code><br><img src="http://note.youdao.com/yws/api/personal/file/C7B4C4CFCCBB41C4AF799CAFE771E370?method=download&amp;shareKey=8aceb129875e52c7a00cc1b2457dabf7" alt="节点状态5">  </p>
<p><code>curl -XGET &#39;http://localhost:9200/_nodes/settings?pretty&#39;</code><br><img src="http://note.youdao.com/yws/api/personal/file/397DF0BEC4D94209B69D023C581406CA?method=download&amp;shareKey=5b2675affc9e3956f9a45fae3b45de59" alt="节点状态6">  </p>
<h5 id="获取集群健康状况"><a href="#获取集群健康状况" class="headerlink" title="获取集群健康状况"></a>获取集群健康状况</h5><p><code>curl -XGET &#39;http://localhost:9200/_cluster/health?pretty=true&#39;</code><br><img src="http://note.youdao.com/yws/api/personal/file/45011E4E313142FAB9881CB9A5C6EF25?method=download&amp;shareKey=a37a6a50b678ebc5263086dd4c695d79" alt="获取集群健康状况">  </p>
<h5 id="集群状态"><a href="#集群状态" class="headerlink" title="集群状态"></a>集群状态</h5><p><code>curl -XGET &#39;http://localhost:9200/_cluster/state?pretty&#39;</code><br><img src="http://note.youdao.com/yws/api/personal/file/002F39A9F6CC407A87CE90BEB23C2039?method=download&amp;shareKey=f406f9dad95986261270cd10be864e58" alt="集群状态1">  </p>
<p><code>curl -XGET &#39;http://localhost:9200/_cluster/stats?human&amp;pretty&#39;</code><br><img src="http://note.youdao.com/yws/api/personal/file/63BC83C64A7242F88E43DA5BAA384F58?method=download&amp;shareKey=617d72ec5682fe56ad7d59b591abc205" alt="集群状态2">  </p>
<p>详细参考：<a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/cluster-nodes-stats.html" target="_blank" rel="external">http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/cluster-nodes-stats.html</a><br><a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/cluster-nodes-info.html" target="_blank" rel="external">http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/cluster-nodes-info.html</a>  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@ELK-test ~]<span class="comment"># ls /data/ELK_data/elasticsearch/logs/</span></div><div class="line">Julend_ES-cluster-2017-10-17.log  Julend_ES-cluster_deprecation.log             Julend_ES-cluster_index_search_slowlog.log</div><div class="line">Julend_ES-cluster-2017-10-18.log  Julend_ES-cluster_index_indexing_slowlog.log  Julend_ES-cluster.log</div><div class="line">[root@ELK-test ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>elasticsearch-head安装略  </p>
<p>第三个elasticsearch节点（之前有两个）加入到elasticsearch集群后，前两个elasticsearch节点会自动迁移同步数据到第三个节点<br>elasticsearch集群开始同步<br><img src="http://note.youdao.com/yws/api/personal/file/09534A80B39F4F178B3187517DAFA898?method=download&amp;shareKey=ce322eed4929d14ee88d4c92b950b364" alt="elasticsearch_cluster_status">  </p>
<p>elasticsearch集群同步完成后，各个elasticsearch节点几乎均匀分布，允许宕机一个节点<br><img src="http://note.youdao.com/yws/api/personal/file/B40C211E50634D648CF82E54B2FCD109?method=download&amp;shareKey=00425374d1c0425cbc224b1524ea90bf" alt="elasticsearch_cluster_status">  </p>
<h5 id="kibana-状态"><a href="#kibana-状态" class="headerlink" title="kibana 状态"></a>kibana 状态</h5><p><img src="http://note.youdao.com/yws/api/personal/file/26933567953E40EE8F284794F1CB78FC?method=download&amp;shareKey=56d001acd84646148ad4c51112103c24" alt="kibana">  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/644A2A5A28A24FE1B20C5ABFD27A9CDD?method=download&amp;shareKey=3251ff9b6046a236ff91f6e157e9ad41" alt="nginx+kibana">  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/11/04/部署FileBeat-logstash-elasticsearch集群-kibana/">http://www.yfshare.vip/2017/11/04/部署FileBeat-logstash-elasticsearch集群-kibana/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Elasticsearch原理]]></title>
      <url>http://www.yfshare.vip/2017/11/02/Elasticsearch%E5%8E%9F%E7%90%86/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>Elasticsearch原理<br><a id="more"></a></p>
<h3 id="动态更新的Lucene索引"><a href="#动态更新的Lucene索引" class="headerlink" title="动态更新的Lucene索引"></a>动态更新的Lucene索引</h3><p>Lucene处理方法，新收到的数据写到新文件里<br>Lucene把每次生成的倒排索引，叫做一个段（segment）。使用一个commit文件记录索引内所有的段，生产的segment的数据来源则是放在内存的buffer  </p>
<ol>
<li>当前索引有3个segment可用</li>
<li>新接收的数据进入内存buffer</li>
<li>内存buffer刷到磁盘，生成一个新的segment，commit文件同步更新<br><img src="http://note.youdao.com/yws/api/personal/file/E0FB3DE0ED34483699E2FD08AF8B07AA?method=download&amp;shareKey=4e8edcbd0741fefc8a26222648236865" alt="动态更新的Lucene索引">  </li>
</ol>
<h3 id="利用磁盘缓存实现的准实时检索"><a href="#利用磁盘缓存实现的准实时检索" class="headerlink" title="利用磁盘缓存实现的准实时检索"></a>利用磁盘缓存实现的准实时检索</h3><p>相对来说，磁盘处理速度很慢，因此在上述第三步中还存在一个中间状态  </p>
<ol>
<li>内存buffer生成一个新的segment，刷新到文件系统缓存中，Lucene即可检索这个新的segment</li>
<li>文件系统缓存真正同步到磁盘，commit文件更新<br>这一步刷新到文件系统缓存的步骤，在Elasticsearch中默认是1秒间隔，对于大部分应用来说，几乎是实时可搜索了。Elasticsearch也提供了单独的<code>/_refresh</code>接口，用户如果不满意，可以主动调整<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#加大refresh_interval参数</span></div><div class="line"><span class="comment"># curl -XPOST http://localhost:9200/192.168.1.24-weixin_log-2017.10.28/_settings -d '</span></div><div class="line">&#123; <span class="string">"refresh_interval"</span>: <span class="string">"10s"</span> &#125;</div><div class="line"><span class="string">'</span></div></pre></td></tr></table></figure>
</li>
</ol>
<p>如果导入的是历史数据，可以关闭<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPOST http://localhost:9200/192.168.1.24-weixin_log-2017.10.28 -d '</span></div><div class="line">&#123;</div><div class="line">    <span class="string">"settings"</span>: &#123;</div><div class="line">        <span class="string">"refresh_interval"</span>: <span class="string">"-1"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="string">'</span></div></pre></td></tr></table></figure></p>
<p>在导入完成后，修改回原来的值或者手动调用一次<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPOST http://localhost:9200/192.168.1.24-weixin_log-2017.10.27/_refresh?pretty=true</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"_shards"</span> : &#123;</div><div class="line">    <span class="string">"total"</span> : 10,</div><div class="line">    <span class="string">"successful"</span> : 10,</div><div class="line">    <span class="string">"failed"</span> : 0</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/FD45A9D1BDDF4D92BFFBA09E04872591?method=download&amp;shareKey=735c6c6ebf035d8836ec5d827aa7e7fc" alt="利用磁盘缓存实现的准实时检索">  </p>
<h3 id="translog-提供的磁盘同步控制"><a href="#translog-提供的磁盘同步控制" class="headerlink" title="translog 提供的磁盘同步控制"></a>translog 提供的磁盘同步控制</h3><p>Elasticsearch在把数据写入到内存buffer时，还记录了一个translog的日志，来保证期间发生主机错误、硬件故障等异常情况时数据不会丢失<br>如果在这期间发生异常，Elasticsearch会从 commit 位置开始恢复整个translog文件中的记录<br><img src="http://note.youdao.com/yws/api/personal/file/6F91BABFB8B44FA2878D7FC4DF36EA8C?method=download&amp;shareKey=b5b3bb7b92596d736f0e8eb4b0b99079" alt="translog提供的磁盘同步控制"><br>等到真正把segment刷到磁盘，且commit 文件进行更新的时候，translog文件才清空，这一步叫flush。Elasticsearch也提供了<code>/_flush</code>接口<br>Elasticsearch默认设置为每30分钟主动执行一次flush，或者当translog文件大于512M时，两者分别可以通过<code>index.translog.flush_threshold_period</code>和<code>index.translog.flush_threshold_size</code>参数控制，Elasticsearch还可以通过<code>index.translog.flush_threshold_ops</code>参数设置每收到多少条数据后flush一次  </p>
<p>默认情况下，Elasticsearch每5秒，或每次请求操作结束前，会强制刷新 translog日志到磁盘。为了保证不丢数据 ，每次index、bulk、delete、update完成时，一定会触发新translog到磁盘，才给请求返回200 OK。这个改变提供数据安全性的同时降低了一点性能<br>可以在index template里设置如下参数来控制<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"index.translog.durability"</span>: <span class="string">"async"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="segment-merge的影响"><a href="#segment-merge的影响" class="headerlink" title="segment merge的影响"></a>segment merge的影响</h3><p>从前面看Lucene会写很多“新文件”，但这样会给服务器带来很大的负荷，每个文件都需要文件句柄，内存，CPU等各种资源，磁盘inode也有限<br>Elasticsearch通过segment merge操作将很多零散的segment做数据归并。这个过程有独立的线程来操作，并不影响新的segment的产生<br>当归并完成后，较大的segment刷到磁盘，commit文件做出相应变更，删除前面小的segment<br><img src="http://note.youdao.com/yws/api/personal/file/288CB47874D84FE5B4924D1DF06CA3A0?method=download&amp;shareKey=5cef29dfcfb7b1ed2d76c44fbe5da40d" alt="segment merge">  </p>
<p>并归线程配置<br>segment归并过程中，需要读取segment，归并计算，再写新的segment，最后还要保存到磁盘。此过程非常消耗磁盘I/O和CPU的任务。所以，Elasticsearch提供了对归并线程的限速机制，要确保这个任务不会影响到其他的任务<br>归并线程的限速配置<code>indices.store.throttle.max_bytes_per_sec</code>在Elasticsearch 5.0默认是10240MB，使用了Lucene CMS（ConcurrentMergeScheduler）的auto throttle机制，正常情况下不需要手动配置。配置参数如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPUT http://localhost:9200/_cluster/settings -d '</span></div><div class="line">&#123;</div><div class="line">        <span class="string">"persistent"</span>: &#123;</div><div class="line">            <span class="string">"indices.store.throttle.max_bytes_per_sec"</span>: <span class="string">"100mb"</span></div><div class="line">        &#125;</div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure></p>
<p>归并线程数目，Elasticsearch也通过计算公式控制：Math.min(3,Runtime.getRuntime().availableProcessors()/2)。即服务器CPU核数的一半大于3时，启用3个归并线程，否则启动跟CPU核数的一半相等的线程数。如果确定磁盘I/O不够，可以降低<code>index.merge.schedule.max_thread_count</code>配置修改  </p>
<p>归并策略主要有以下几条：  </p>
<ul>
<li><code>index.merge.policy.floor_segment</code> 默认2MB，小于这个值得segment优先被归并</li>
<li><code>index.merge.policy.max_merge_at_once</code> 默认一次归并10个segment</li>
<li><code>index.merge.policy.max_merge_at_once_explicit</code> 默认forcemerge时一次最多归并30个segment</li>
<li><code>index.merge.policy.max_merged_segment</code> 默认是5G，大于这个值得segment，不用参与归并，optimize除外</li>
</ul>
<p>forcemerge接口<br>segment最大为5G，也会存在很多的segment，但因归并任务太消耗资源，所以一般不选择加大<code>index.merge.policy.max_merged_segment</code>配置，而在较低负荷时间段，通过forcemerge接口，强行归并segment<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPOST http://localhost:9200/192.168.1.24-weixin_log-2017.10.28/_forcemerge?max_num_segments=1</span></div><div class="line">&#123;<span class="string">"_shards"</span>:&#123;<span class="string">"total"</span>:10,<span class="string">"successful"</span>:10,<span class="string">"failed"</span>:0&#125;&#125;</div></pre></td></tr></table></figure></p>
<p>forcemerge线程消耗服务器资源比普通的归并线程还大，所以不要在写入数据的热索引执行这个操作，一般索引都是按天分割的  </p>
<h3 id="routing-和-replica的读写过程"><a href="#routing-和-replica的读写过程" class="headerlink" title="routing 和 replica的读写过程"></a>routing 和 replica的读写过程</h3><p>在Elasticsearch分布层面上，当一个Elasticsearch节点收到一条数据的请求时，通过以下方式来确认数据应该存储到哪个分片的  </p>
<ol>
<li>路由计算<br>Elasticsearch没有额外的依赖，对任意一条数据计算其对应分片的方式如下  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">shard = <span class="built_in">hash</span>(routing) % number_of_primary_shards</div></pre></td></tr></table></figure>
</li>
</ol>
<p>每个数据都有一个routing参数，默认情况下，使用其<code>_id</code>值。将其<code>_id</code>值哈希计算后，对索引的主分片数取余，就是数据实际应该存储到的分片ID。<br>由于取余这种计算方式，完全依赖分母，所以不能修改索引的主分片数。一旦主分片数不一样，所有数据的存储位置计算结果都会改变，索引数据将完全不可读。  </p>
<p>副本一致性<br>数据副本是分布式系统的一个标配。数据流程如下：<br><img src="http://note.youdao.com/yws/api/personal/file/BA7FE1FF0D25420BB14CA1D7EEC67193?method=download&amp;shareKey=ac023a5a0bed3c9485219979e64ef9e3" alt="数据写入流程">  </p>
<ol>
<li>客户端请求发送给node1节点，图中node1为master节点</li>
<li>node1用数据的<code>id_</code>取余计算得到应该将数据存储到share0上，通过cluster state信息发现share0的主分片已经分配到node3上，node1将请求数据给node3  </li>
<li>node3完成请求数据的索引过程，存入主分片0，然后并行转发数据给分配由shard0的副本分片的node1和node2。当收到任一节点汇报副本分片数据写入成功，node3即返回给初始的接收节点node1，宣布数据写入成功。node1返回成功响应给客户端<br>下面几个参数可以控制这个过程：  </li>
</ol>
<ul>
<li><code>wait_for_active_shards</code>: 两个副本只要有一个成功，就返回给客户端，默认值计算如下<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">int((primary + number_of_replicas)/2 ) +1</div></pre></td></tr></table></figure>
</li>
</ul>
<p>该参数通过<code>index.write.wait_for_active_shards</code>在索引级别设置，也可以根据需要单个写入请求上作为参数使用，设置成为1仅写完主分片就返回；设置为all，表示等所有副本分片都写入完成才返回，还可以设置为介于1和<code>number_of_replicas +1</code>之间的值  </p>
<ul>
<li><code>timeout</code>: 如果集群出现异常，有些分片不可用，Elasticsearch会等待1分钟确认分片是否正常，可以用<code>?timeout=30s</code>参数来缩短这个等待的时间<br>副本配置和分片配置不一样，可以随时调整。有些较大的索引，甚至可以在做<code>optimize</code>前，先把副本全部取消，等<code>optimize</code>完成后，在重新开启副本，节约单个segment的重复归并消耗  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPUT http://localhost:9200/192.168.1.24-weixin_log-2017.10.28/_settings -d '</span></div><div class="line">&#123;</div><div class="line">    <span class="string">"index"</span>: &#123; <span class="string">"number_of_replicas"</span>: 0 &#125;</div><div class="line">&#125;</div><div class="line"><span class="string">'</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="shard-的-allocate-控制"><a href="#shard-的-allocate-控制" class="headerlink" title="shard 的 allocate 控制"></a>shard 的 allocate 控制</h3><p>Elasticsearch由以下策略来决定某个shard分配在哪个节点，是由Elasticsearch自行决定的  </p>
<ul>
<li>新索引的生成</li>
<li>索引的删除</li>
<li>新增副本分片</li>
<li>节点增减引发的数据平衡</li>
</ul>
<p>Elasticsearch控制这部分逻辑的参数如下：  </p>
<ul>
<li><code>cluster.routing.allocation.enable</code> 参数用来控制允许分配哪种分片。默认是all。可选项包含<code>primaries</code> 和<code>new_primaries</code>。<code>none</code>则彻底拒绝分片</li>
<li><code>cluster.routing.allocation.allow_rebalance</code> 参数用来控制什么时候允许数据平衡。默认是<code>indices_all_active</code>，即要求所有分片都正常启用以后，才可以进行数据平衡操作，否则在集群重启阶段，会浪费很多流量</li>
<li><code>cluster.routing.allocation.cluster_concurrent_rebalance</code> 参数用来控制集群内同时运行的数据均衡任务个数。默认是2个，如果有节点增减，且集群负载压力不高的情况下，可以适当加大</li>
<li><code>cluster.routing.allocation.node_initial_primaries_recoveries</code> 参数用来控制节点重启时，允许同时恢复几个主分片。默认是4个，如果节点是多磁盘，且I/O压力不大，可以适当增加</li>
<li><code>cluster.routing.allocation.node_concurrent_recoveries</code> 参数用来控制节点除了主分片重启恢复以外其他情况下，允许同时运行的数据恢复任务。默认是2个。所以，节点重启时，可以看到主分片通过本地恢复迅速完成，副分片通过网络复制的恢复却很慢，并发线程本身也减少了一半。在Elasticsearch 1.6后，冷索引的副本分片也可以本地恢复，可以适当加大</li>
<li><code>indices.recovery.concurrent_streams</code> 参数用来控制节点从网络复制恢复副本分片时的数据流个数。默认是3个，可以配合上一条配置一起加大  </li>
<li><code>indices.recovery.max_bytes_per_sec</code> 参数用来控制节点恢复时的速率。默认是 40MB</li>
</ul>
<p>运维人员较常见的策略有2种：  </p>
<ul>
<li><p>磁盘限额，为了保护节点数据安全。Elasticsearch会定时（<code>cluster.info.update.interval</code>默认为30秒）检查一下各节点的数据目录磁盘使用情况。在达到<code>cluster.routing.allocation.disk.watermark.low</code>（默认85%）的时候，新索引分片就不会再分配到这个节点上了。在达到<code>cluster.routing.allocation.disk.watermark.high</code>（默认90%）的时候就会触发该节点现存分片的数据平衡，把数据挪到其他节点上去。这两个值可以写成百分比或者具体字节数。可以适当修改参数配置：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPUT http://localhost:9200/_cluster/settings -d '&#123;</span></div><div class="line"><span class="string">"transient"</span>: &#123;</div><div class="line">    <span class="string">"cluster.routing.allocation.disk.watermark.low"</span>: <span class="string">"85%"</span>,</div><div class="line">    <span class="string">"cluster.routing.allocation.disk.watermark.high"</span>: <span class="string">"10gb"</span>,</div><div class="line">    <span class="string">"cluster.info.update.interval"</span>: <span class="string">"1m"</span></div><div class="line">&#125;</div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure>
</li>
<li><p>热索引分片不均。默认情况下，Elasticsearch集群的数据均衡策略是以各节点的分片总数（<code>indices_all_active</code>）作为基准的。可以提高均衡搜索压力。一般压力集群中在新索引的数据写入方面，正常运行时，没有问题的。但当集群扩容时，新加入集群的节点，分片总数远低于其他节点，如果有新的索引创建，Elasticsearch的默认策略会导致新索引的所有主分片几乎全部分配到这个新节点上。整个集群的写入压力全部在这个节点上，可以会导致这个节点出现异常，集群出现异常。<br>在ELK环境中，需要预先计算好索引的分片数，配置好单节点的分片限额。比如：一个5节点的集群，索引主分片10个，副本1个，则平均下来每个节点应该有4个分片，则应配置为：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPUT http://localhost:9200/192.168.1.24-weixin_log-2017.10.28/_settings -d '&#123;</span></div><div class="line">    <span class="string">"index"</span>: &#123; <span class="string">"routing.allocation.total_shards_per_node"</span>: <span class="string">"5"</span> &#125;</div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>这里配置的是5而不是4，需要预防有机器故障，分片发生迁移失败的情况  </p>
<p>Elasticsearch中有一系列参数互相影响，最终联合决定分片分配：  </p>
<ul>
<li><code>cluster.routing.allocation.balance.shard</code> 节点上分配分片的权重，默认值为 0.45。 数值越大越倾向于在节点层面均衡分片  </li>
<li><code>cluster.routing.allocation.balance.index</code> 每个索引往单个节点上分配分片的权重，默认值为0.55。 数值越大越倾向于在索引层面均衡分片</li>
<li><code>cluster.routing.allocation.balance.threshold</code> 大于阈值则触发均衡操作。默认值为1。 Elasticsearch计算方法是：<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(indexBalance (node.numShards(index) - avgShardsPerNode(index)) + shardBalance (node.numShards() - avgShardsPerNode)) &lt;=&gt; weightthreshold</div></pre></td></tr></table></figure>
</li>
</ul>
<p>所以，也可以采取加大<code>cluster.routing.allocation.balance.index</code>的措施，甚至设置<code>cluster.routing.allocation.balance.shard</code> 为0来尽量采用索引内的节点均衡  </p>
<h3 id="reroute-接口"><a href="#reroute-接口" class="headerlink" title="reroute 接口"></a>reroute 接口</h3><p>上述都是从策略层面控制分片的选择，在必要的时候可以通过Elasticsearch的<code>reroute</code>接口，手动完成对分片的分配选择的控制<br>reroute接口支持三种指令：<code>allocate</code>、<code>move</code>、<code>cancel</code>，常用的是<code>allocate</code>和<code>move</code>  </p>
<ul>
<li><code>allocate</code>指令：因为负载过高等原因，有时候个别分片长期处于<code>UNASSIGNED</code>状态，可以手动分配分片到指定节点上。默认情况下只允许手动分配副本分片，所以如果是主分片故障，需要单独加一个<code>allow_primary</code>选项  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPOST http://localhost:9200/_cluster/reroute -d '&#123;</span></div><div class="line"><span class="string">"commands"</span>: [&#123;</div><div class="line">    <span class="string">"allocate"</span>: &#123;</div><div class="line">        <span class="string">"index"</span>: <span class="string">"192.168.1.24-weixin_log-2017.10.28"</span>, <span class="string">"shard"</span>: 61, <span class="string">"node"</span>: <span class="string">"192.168.1.42"</span>, <span class="string">"allow_primary"</span>: <span class="literal">true</span></div><div class="line">    &#125;</div><div class="line">    &#125;]</div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>注：如果是历史数据的话，需要提前确认哪个节点上保留有这个分片的实际目录，且目录大小最大。然后手动分片到这个节点上，以此减少数据丢失。  </p>
<ul>
<li><code>move</code>指令： 因负载过高，磁盘利用率过高，服务器下线，更换磁盘等原因，可能会需要从节点上移走部分分片<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPOST http://localhost:9200/_cluster/reroute -d '&#123;</span></div><div class="line"><span class="string">"command"</span>: [&#123;</div><div class="line">    <span class="string">"move"</span>: &#123;</div><div class="line">        <span class="string">"index"</span>: <span class="string">"192.168.1.24-weixin_log-2017.10.28"</span>, <span class="string">"shard"</span>: 0, <span class="string">"from_node"</span>: <span class="string">"192.168.1.43"</span>, <span class="string">"to_node"</span>: <span class="string">"192.168.1.42"</span></div><div class="line">    &#125;</div><div class="line">    &#125;]</div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>如果自己手动reroute失败，Elasticsearch返回的响应中会带上失败的原因。从Elasticsearch 5.0开始，新增了一个<code>allocation explain</code>接口，用来解释指定分片的具体失败原因<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XGET 'http://localhost:9200/_cluster/allocation/explain' -d '&#123;</span></div><div class="line"><span class="string">"index"</span>: <span class="string">"192.168.1.24-weixin_log-2017.10.28"</span>,</div><div class="line"><span class="string">"shard"</span>: 0,</div><div class="line"><span class="string">"primary"</span>: <span class="literal">false</span></div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure></p>
<p>得到的响应如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"shard"</span>: &#123;</div><div class="line">        <span class="string">"index"</span>: <span class="string">"192.168.1.24-weixin_log-2017.10.28"</span>,</div><div class="line">        <span class="string">"index_uuid"</span>: <span class="string">"KnW0-zELRs6PK8410r38ZA"</span>,</div><div class="line">        <span class="string">"id"</span>: 0,</div><div class="line">        <span class="string">"primary"</span>: <span class="literal">false</span></div><div class="line">    &#125;,</div><div class="line">    <span class="string">"assigned"</span>: <span class="literal">false</span>,</div><div class="line">    <span class="string">"shard_state_fetch_pending"</span>: <span class="literal">false</span>,</div><div class="line">    <span class="string">"unassigned_info"</span>: &#123;</div><div class="line">        <span class="string">"reason"</span>: <span class="string">"INDEX_CREATED"</span>,</div><div class="line">        <span class="string">"at"</span>: <span class="string">"2017-10-28T20:04:23.620Z"</span></div><div class="line">    &#125;,</div><div class="line">    <span class="string">"allocation_delay_ms"</span>: 0,</div><div class="line">    <span class="string">"remaining_delay_ms"</span>: 0,</div><div class="line">    <span class="string">"nodes"</span>: &#123;</div><div class="line">        <span class="string">"V-Spi0AyRZ6ZvKbaI3691w"</span>: &#123;</div><div class="line">            <span class="string">"node_name"</span>: <span class="string">"H5dfFeA"</span>,</div><div class="line">            <span class="string">"node_attributes"</span>: &#123;</div><div class="line">                <span class="string">"bar"</span>: <span class="string">"baz"</span></div><div class="line">            &#125;,</div><div class="line">            <span class="string">"store"</span>: &#123;</div><div class="line">                <span class="string">"shard_copy"</span>: <span class="string">"NONE"</span></div><div class="line">            &#125;,</div><div class="line">            <span class="string">"final_decision"</span>: <span class="string">"NO"</span>,</div><div class="line">            <span class="string">"final_explanation"</span>: <span class="string">"the shard cannot be assigned because one or more allocation decider returns a 'NO' decision"</span>,</div><div class="line">            <span class="string">"weight"</span>: 0.06666675,</div><div class="line">            <span class="string">"decisions"</span>: [&#123;</div><div class="line">                <span class="string">"decider"</span>: <span class="string">"filter"</span>,</div><div class="line">                <span class="string">"decision"</span>: <span class="string">"NO"</span>,</div><div class="line">                <span class="string">"explanation"</span>: <span class="string">"node does not match index include filters [foo:\"bar\"]"</span></div><div class="line">                &#125;]</div><div class="line">            &#125;,</div><div class="line">            <span class="string">"Qc6VL8c5RWaw1qXZ0Rg57g"</span>: &#123;</div><div class="line">                ...</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>这是一段很长的JSON字符，会把集群里所有节点都列上来，挨个解释为什么不能分配到这个节点上  </p>
<h3 id="节点下线（迁移）"><a href="#节点下线（迁移）" class="headerlink" title="节点下线（迁移）"></a>节点下线（迁移）</h3><p>集群中个别节点出现故障预警，也是在Elasticsearch运维工作中常见的情况。如果已经稳定运行了一段时间的集群，每个节点上都保存有数量不少的分片，这时通过 reroute接口手动转移就太麻烦了，可以采取另一种方式：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPUT http://localhost:9200/_cluster/settings -d '&#123;</span></div><div class="line"><span class="string">"transient"</span>: &#123;</div><div class="line">    <span class="string">"cluster.routing.allocation.exclude._ip"</span>: <span class="string">"192.168.1.43"</span></div><div class="line">&#125;</div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure></p>
<p>Elasticsearch就会把这个IP节点上的所有分片，都自动转移到其他的节点上。等转移完成后，这个节点就可以毫无影响的下线了<br>和<code>_ip</code>类似的参数还有<code>_host</code>，<code>_name</code>等。这类参数不仅仅是cluster级别，也可以是index级别  </p>
<h3 id="冷热数据的读写分离"><a href="#冷热数据的读写分离" class="headerlink" title="冷热数据的读写分离"></a>冷热数据的读写分离</h3><p>实施步骤如下：  </p>
<ol>
<li>N台机器做热数据的存储，上面只放当天的数据。这N台数据节点上面的elasticsearch.yml中配置<code>node.tag: host</code></li>
<li>之前的数据放在另外的M台机器上，这M台机器冷数据节点中配置<code>node.tag: stale</code></li>
<li><p>模版中控制对新建索引添加<code>hot</code>标签：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"order"</span>: 0,</div><div class="line">    <span class="string">"template"</span>: <span class="string">"*"</span>,</div><div class="line">    <span class="string">"settings"</span>: &#123;</div><div class="line">        <span class="string">"index.routing.allocation.require.tag"</span>: <span class="string">"hot"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>每天计划任务更新索引的配置，将<code>tag</code>更变为<code>stale</code>，索引会自动迁移到M台冷数据节点  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPUT http://localhost:9200/indexname/_settings -d '</span></div><div class="line">&#123;</div><div class="line">    <span class="string">"index"</span>: &#123;</div><div class="line">        <span class="string">"routing"</span>: &#123;</div><div class="line">            <span class="string">"allocation"</span>: &#123;</div><div class="line">                <span class="string">"require"</span>: &#123;</div><div class="line">                    <span class="string">"tag"</span>: <span class="string">"stale"</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure>
</li>
</ol>
<p>这样，写操作就在N台热数据节点上，大范围的独操作集中在M台冷数据节点上，避免了堵塞影响<br>参考： <a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/shard-allocation-filtering.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/reference/master/shard-allocation-filtering.html</a>  </p>
<h3 id="Elasticsearch自动发现的配置"><a href="#Elasticsearch自动发现的配置" class="headerlink" title="Elasticsearch自动发现的配置"></a>Elasticsearch自动发现的配置</h3><p>Elasticsearch是P2P类型（gossip协议）的分布式系统，除了集群状态管理以外，其他所有的请求都可以发送到集群内任意一台节点上，这个节点可以自己找到需求转发给哪些节点，并且直接跟这个节点通讯。<br>在Elasticsearch 5.0以后自动发现方式为单播（unicast）方式，原来的组播（multicast）被彻底删除。<br>单播方式的配置里，提供几台节点的地址里（和可选端口），Elasticsearch将其视作 <code>gossip router</code>角色，借以完成集群的发现。由于这只是Elasticsearch内很小的一个功能，所以，<code>gossip router</code>角色并不需要单独配置，每个Elasticsearch节点都可以担任。所以采用单播方式的集群，各个节点都配置相同的几个节点列表作为<code>router</code>即可。<br>此外，考虑到节点有时候因为高负载，慢GC等原因，可能会有偶尔没有及时相应的<code>ping</code>包，一般建议稍微加大<code>Fault Detection</code>的超时时间。同样基于安全考虑做的变更，还有监听的主机名，现在默认只监听本地lo网卡上的信号。所以正式环境上需要修改配置为监听具体的网卡：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">network.host: <span class="string">"192.168.1.41"</span></div><div class="line">discovery.zen.minimum_master_nodes:3</div><div class="line">discovery.zen.ping.timeout: 100s</div><div class="line">discovery.zen.fd.ping_timeout: 100s</div><div class="line">discovery.zen.ping.multicast.enabled: <span class="literal">false</span></div><div class="line">discovery.zen.ping.unicase.hosts: [<span class="string">"192.168.1.41"</span>,<span class="string">"192.168.1.42"</span>,<span class="string">"192.168.1.43"</span>]</div></pre></td></tr></table></figure></p>
<p>上面的<code>fd</code>是<code>fault detection</code>的缩写  </p>
<ul>
<li><code>discovery.zen.ping.timeout</code> 参数仅在加入或者选举master主节点的时候才起作用</li>
<li><code>discovery.zen.fd.ping_timeout</code> 参数在稳定运行的集群中，master检测所有节点，以及节点检测master是否正常时，长期有用</li>
</ul>
<p>既然是长期使用，自然还有运行间隔和重试配置，可以根据实际情况调整：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">discovery.zen.fd.ping_intervel: 10s</div><div class="line">discovery.zen.fd.ping_retries: 10</div></pre></td></tr></table></figure></p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/11/02/Elasticsearch原理/">http://www.yfshare.vip/2017/11/02/Elasticsearch原理/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Kibana5使用指南]]></title>
      <url>http://www.yfshare.vip/2017/10/30/Kibana5%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>ELK由Elasticsearch、Logstash和Kibana三部分组件组成，这里新增了一个FileBeat，它是一个轻量级的日志收集处理工具(Agent)，Filebeat占用资源少，适合于在各个服务器上搜集日志后传输给Logstash，官方也推荐此工具<br><a id="more"></a><br>Filebeat隶属于Beats。目前Beats包含四种工具：  </p>
<ol>
<li>Packetbeat（搜集网络流量数据）  </li>
<li>Topbeat（搜集系统、进程和文件系统级别的 CPU 和内存使用情况等数据）</li>
<li>Filebeat（搜集文件数据）</li>
<li>Winlogbeat（搜集 Windows 事件日志数据）<h3 id="测试环境ELK架构讲解"><a href="#测试环境ELK架构讲解" class="headerlink" title="测试环境ELK架构讲解"></a>测试环境ELK架构讲解</h3>官方ELK架构图：<br><img src="http://note.youdao.com/yws/api/personal/file/DCE29CF684C34FC3BA73809D566B0150?method=download&amp;shareKey=798f64543357202a0efb9a95d35c4e5b" alt="filebeat">  </li>
</ol>
<p>目前测试环境的拓扑图：<br><img src="http://note.youdao.com/yws/api/personal/file/4772759A56704D82A3D1C6056C76613F?method=download&amp;shareKey=3c9825a509086b1a28b8ffd34aa9c6b0" alt="ELK_拓扑图">  </p>
<h3 id="Elasticsearch基本原理"><a href="#Elasticsearch基本原理" class="headerlink" title="Elasticsearch基本原理"></a>Elasticsearch基本原理</h3><p><img src="http://note.youdao.com/yws/api/personal/file/FD45A9D1BDDF4D92BFFBA09E04872591?method=download&amp;shareKey=735c6c6ebf035d8836ec5d827aa7e7fc" alt="利用磁盘缓存实现的准实时检索"><br><img src="http://note.youdao.com/yws/api/personal/file/6F91BABFB8B44FA2878D7FC4DF36EA8C?method=download&amp;shareKey=b5b3bb7b92596d736f0e8eb4b0b99079" alt="translog提供的磁盘同步控制"><br><img src="http://note.youdao.com/yws/api/personal/file/288CB47874D84FE5B4924D1DF06CA3A0?method=download&amp;shareKey=5cef29dfcfb7b1ed2d76c44fbe5da40d" alt="segment merge">  </p>
<p>官方文档<br>Filebeat：<br><a href="https://www.elastic.co/cn/products/beats/filebeat" target="_blank" rel="external">https://www.elastic.co/cn/products/beats/filebeat</a><br><a href="https://www.elastic.co/guide/en/beats/filebeat/5.6/index.html" target="_blank" rel="external">https://www.elastic.co/guide/en/beats/filebeat/5.6/index.html</a>  </p>
<p>Logstash：<br><a href="https://www.elastic.co/cn/products/logstash" target="_blank" rel="external">https://www.elastic.co/cn/products/logstash</a><br><a href="https://www.elastic.co/guide/en/logstash/5.6/index.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/5.6/index.html</a>  </p>
<p>Elasticsearch：<br><a href="https://www.elastic.co/cn/products/elasticsearch" target="_blank" rel="external">https://www.elastic.co/cn/products/elasticsearch</a><br><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/index.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/reference/5.6/index.html</a>  </p>
<p>elasticsearch中文社区：<br><a href="https://elasticsearch.cn/" target="_blank" rel="external">https://elasticsearch.cn/</a>  </p>
<h3 id="Kibana使用指南"><a href="#Kibana使用指南" class="headerlink" title="Kibana使用指南"></a>Kibana使用指南</h3><p>Kibana有另一个名字 elasticsearch dashboard，设计参考了 Splunk<br>Kibana主要功能 Discover，Visualize，Dashboard，Timelion，DevTools，Management  </p>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/query-dsl-query-string-query.html#query-string-syntax" target="_blank" rel="external">lucene query syntax</a><br><img src="http://note.youdao.com/yws/api/personal/file/45BD110CD9B24ECAACC51EE54637EAB8?method=download&amp;shareKey=dd229f6cfe56bfd10396117cb4790a65" alt="kibana">  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/58CBFFB81D4941178EDE60CB254E0512?method=download&amp;shareKey=7eec44cd864fb579a5b12694c77bc52c" alt="kibana">  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/8732A5AA79B64E1F9B1A63D85CD8F330?method=download&amp;shareKey=f7d887ce2e084814367c8555c656b3c1" alt="Kibana">  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/B80830DE946244E5A0105A62FBA738D9?method=download&amp;shareKey=7b9b3a854c883ca4bc17f286c5c6c743" alt="kibana">  </p>
<h3 id="Elasticsearch查询语法"><a href="#Elasticsearch查询语法" class="headerlink" title="Elasticsearch查询语法"></a>Elasticsearch查询语法</h3><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/common-options.html#date-math" target="_blank" rel="external">Elasticsearch Query DSL查询语法</a><br><img src="http://note.youdao.com/yws/api/personal/file/3E744DB1A632475EA8D5460F76BDD6BC?method=download&amp;shareKey=8ef13860f3e3f2eb1c901e2b017dc74e" alt="kibana">  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/25D871BBDF604A1189E18F6D922C4014?method=download&amp;shareKey=7f4fcf3f5e29920e64099a8deb137757" alt="Elasticsearch Query DSL"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"query"</span>: &#123;</div><div class="line">    <span class="string">"term"</span>: &#123;</div><div class="line">      <span class="string">"_id"</span>: <span class="string">"AV9orWWLv96dGKcHDVyi"</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/DA5A626EFFE3454F922FAD2B4F0C45BF?method=download&amp;shareKey=48ce91f24595076b45122e9dea483db9" alt="kibana_search">  </p>
<p>querystring 语法<br>上例中<code>?q=</code>后面的就是querystring语法，会在kibana中经常使用  </p>
<ul>
<li><code>全文检索</code>：直接写搜索的单词。如：<code>?q=aaaa</code></li>
<li><code>单字段的全文检索</code>：在搜索单词之前加上字段名和冒号。如：<code>?q=user:jack</code></li>
<li><code>单字段的精确检索</code>：在搜索单词前加上双引号。如：<code>?q=user:&quot;jack&quot;</code></li>
<li><code>多个检索条件的组合</code>：可以使用<code>NOT</code>、<code>AND</code>、<code>OR</code>来组合检索，必须是大写的。如：<code>?q=user:(&quot;jack&quot; OR &quot;bob&quot;) AND NOT mesg:aaaa</code></li>
<li><code>字段是否存在</code>：<code>_exists_:user</code>表示要求user字段存在，<code>_missing_:user</code>表示user字段不存在。如：<code>?q=_exists_:beat.name</code></li>
<li><code>通配符</code>：用<code>?</code>表示单字母，<code>*</code>表示任意个字母。如：<code>?q=DevE?N</code>，<code>?q=DevE?N*</code></li>
<li><code>正则</code>：比通配符更复杂一点点。如：<code>?q=/dub{2}o/</code><br>注：Elasticsearch正则性能不好，尽量不要使用太复杂或不使用。参考<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/query-dsl-regexp-query.html#regexp-synntax" target="_blank" rel="external">Elasticsearch正则表达式语法</a>  </li>
<li><code>近似搜索</code>：用<code>~</code>表示搜索单词可能有一字母写的不对。如：<code>?q=dubao~</code></li>
<li><code>范围搜索</code>：对数值和时间。如：<code>?q=@timestamp:&gt;150928968615</code>，<code>?q=@timestamp:[&quot;now-1m&quot; TO &quot;now&quot;]</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -XGET http://localhost:9200/192.168.1.21-account_errorlog-2017.10.29/_search?pretty=<span class="literal">true</span>?q=<span class="string">'com.alibaba.dubbo.monitor.MonitorService'</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -XGET http://localhost:9200/192.168.1.21-account_errorlog-2017.10.29/_search?pretty=<span class="literal">true</span>?q=beat.hostname=<span class="string">'DevEVN-21'</span></div></pre></td></tr></table></figure>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/query-dsl-queries.html" target="_blank" rel="external">Elasticsearch其他查询语法</a><br><a href="http://www.yfshare.vip/2017/10/30/Elasticsearch%E6%9F%A5%E8%AF%A2%E8%AF%AD%E6%B3%95/#全文搜索">Elasticsearch全文搜索</a>  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/F9660B5ED9F2481B85888ACCF2FC11B4?method=download&amp;shareKey=328b06bb6a52b854733eb636b0938a73" alt="Kibana">  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/E39A9C72B26B4883BFE71058C40D3EF4?method=download&amp;shareKey=aaf776329e429927fe221afb5b37ecd4" alt="Kibana">  </p>
<h3 id="日志分析"><a href="#日志分析" class="headerlink" title="日志分析"></a>日志分析</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#nginx日志格式</span></div><div class="line">    log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></div><div class="line">                      <span class="string">'$status $body_bytes_sent "$http_referer" '</span></div><div class="line">                      <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</div><div class="line"></div><div class="line"><span class="comment">#nginx access日志</span></div><div class="line">192.168.1.153 - - [18/Oct/2017:21:48:00 +0800] <span class="string">"GET /ErrorPages/404.html HTTP/1.0"</span> 404 571 <span class="string">"https://devqian.julend.com/static/pageHtml/bindCardCallback.html?view=zhimaCredit&amp;params=XHk1tuyGnXS1wGSpis2PiC9UKCizLIiGIm0eJ%2Fz1lXc8JdGVXxB2Ftg9hFKZjFfwh3w%2FM6UIEpxQ11TTqXf31xNx9N%2FzGMc00rpvf6YpKEJPQFFCL4X9eLQdLJl5KaaGiK8AdNZS38dJDKEzFJP0o1523nCOhjJEtgS0394oLIB2siIqYF7RTVgBaU1xE72m3vmZcvqvgVZUH8ozt8tftXh4Wq5paf647mA%2FZZJOaXabeFEwuwa7dhtVXTT8CBdnOOiDC5WmwBCC%2FnIqKmfTI1gmFvQUobDA9RY4UcMdMY9RixLkhSdQ8k5LtpD2NVuJDLEscZAdfROhyYeEnZ7Ptg%3D%3D&amp;sign=ABeWMdLqNeFUhDYKUJsJfzLolxA%2Fo64Wl8mmgX36yqM5VWHMvB7VcpZJ3AA7WsH%2BTFe6EARuABMe2HupY6DbzuITufa9aPZX9BHbN6dLPMre0n8aHZnr59h%2FC6Us%2FAW11tu2n6l%2F1dSyCo951diQ55en%2BO%2FffRJ1ldFUwzhzNCQ%3D"</span> <span class="string">"Mozilla/5.0 (Linux; Android 7.1.1; OPPO R11t Build/NMF26X; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/55.0.2883.91 Mobile Safari/537.36"</span> <span class="string">"121.238.20.93"</span></div><div class="line"></div><div class="line"><span class="comment">#logstash grok分析nginx日志格式</span></div><div class="line">grok &#123;</div><div class="line">   match =&gt; [<span class="string">"message"</span>,<span class="string">"%&#123;IPV4:remote_addr&#125; [\-] %&#123;USERNAME:remote_user&#125; \[%&#123;DATA:time_local&#125;\] \"(?&lt;request&gt;[^\"]*)\" (?&lt;status&gt;\d+) (?&lt;body_bytes_sent&gt;\d+) \"(?&lt;http_referer&gt;[^\"]*)\" \"(?&lt;http_user_agent&gt;[^\"]*)\" \"%&#123;IPV4:http_x_forwarded_for&#125;"</span>]</div><div class="line">&#125;</div><div class="line"></div><div class="line">[root@ELK ~]<span class="comment"># /usr/share/logstash/bin/logstash --path.settings /etc/logstash/ -f /etc/logstash/conf.d/geoip.conf</span></div><div class="line">Sending Logstash<span class="string">'s logs to /var/log/logstash which is now configured via log4j2.properties</span></div><div class="line">&#123;</div><div class="line">           "geoip" =&gt; &#123;&#125;,</div><div class="line">              "ua" =&gt; "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/47.0.2526.106 Safari/537.36",</div><div class="line">            "type" =&gt; "Nginx",</div><div class="line">          "clinet" =&gt; "192.168.31.105",</div><div class="line">            "tags" =&gt; [</div><div class="line">        [0] "_geoip_lookup_failure"</div><div class="line">    ],</div><div class="line">            "path" =&gt; "/var/log/nginx/access.log",</div><div class="line">      "@timestamp" =&gt; 2016-12-15T08:13:19.000Z,</div><div class="line">            "size" =&gt; 0,</div><div class="line">          "domain" =&gt; "192.168.31.100",</div><div class="line">        "@version" =&gt; "1",</div><div class="line">            "host" =&gt; "192.168.31.100",</div><div class="line">    "responsetime" =&gt; 0.0,</div><div class="line">          "status" =&gt; "304"</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">2017-10-24_15:42:00.408 [DubboMonitorSendTimer-thread-3] ERROR [com.alibaba.dubbo.common.logger.slf4j.Slf4jLogger]  [DUBBO] Unexpected error occur at send statistic, cause:</div><div class="line"> Failed to invoke the method collect <span class="keyword">in</span> the service com.alibaba.dubbo.monitor.MonitorService. No provider available <span class="keyword">for</span> the service com.alibaba.dubbo.monitor.MonitorService from registry 192.168.1.21:2181 on the consumer 192.168.1.21 using the dubbo version 2.5.3. Please check <span class="keyword">if</span> the providers have been started and registered., dubbo version: 2.5.3, current host: 192.168.1.21com.alibaba.dubbo.rpc.RpcException: Failed to invoke the method collect <span class="keyword">in</span> the service com.alibaba.dubbo.monitor.MonitorService. No provider available <span class="keyword">for</span> the service com.a</div><div class="line">libaba.dubbo.monitor.MonitorService from registry 192.168.1.21:2181 on the consumer 192.168.1.21 using the dubbo version 2.5.3. Please check <span class="keyword">if</span> the providers have been started and registered.	at com.alibaba.dubbo.rpc.cluster.support.AbstractClusterInvoker.checkInvokers(AbstractClusterInvoker.java:246) ~[dubbo-2.5.3.jar:2.5.3]</div><div class="line">	at com.alibaba.dubbo.rpc.cluster.support.FailoverClusterInvoker.doInvoke(FailoverClusterInvoker.java:55) ~[dubbo-2.5.3.jar:2.5.3]</div><div class="line">	at com.alibaba.dubbo.rpc.cluster.support.AbstractClusterInvoker.invoke(AbstractClusterInvoker.java:227) ~[dubbo-2.5.3.jar:2.5.3]</div><div class="line">	at com.alibaba.dubbo.rpc.cluster.support.wrapper.MockClusterInvoker.invoke(MockClusterInvoker.java:72) ~[dubbo-2.5.3.jar:2.5.3]</div><div class="line">	at com.alibaba.dubbo.rpc.proxy.InvokerInvocationHandler.invoke(InvokerInvocationHandler.java:52) ~[dubbo-2.5.3.jar:2.5.3]</div><div class="line">	at com.alibaba.dubbo.common.bytecode.proxy8.collect(proxy8.java) ~[na:2.5.3]</div><div class="line">	at com.alibaba.dubbo.monitor.dubbo.DubboMonitor.send(DubboMonitor.java:113) ~[dubbo-2.5.3.jar:2.5.3]</div><div class="line">	at com.alibaba.dubbo.monitor.dubbo.DubboMonitor<span class="variable">$1</span>.run(DubboMonitor.java:70) ~[dubbo-2.5.3.jar:2.5.3]</div><div class="line">	at java.util.concurrent.Executors<span class="variable">$RunnableAdapter</span>.call(Executors.java:471) [na:1.7.0_80]</div><div class="line">	at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:304) [na:1.7.0_80]</div><div class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor<span class="variable">$ScheduledFutureTask</span>.access<span class="variable">$301</span>(ScheduledThreadPoolExecutor.java:178) [na:1.7.0_80]</div><div class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor<span class="variable">$ScheduledFutureTask</span>.run(ScheduledThreadPoolExecutor.java:293) [na:1.7.0_80]</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) [na:1.7.0_80]</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor<span class="variable">$Worker</span>.run(ThreadPoolExecutor.java:615) [na:1.7.0_80]</div><div class="line">	at java.lang.Thread.run(Thread.java:745) [na:1.7.0_80]</div><div class="line">2017-10-24_15:43:00.413 [DubboMonitorSendTimer-thread-3] INFO  [com.alibaba.dubbo.common.logger.slf4j.Slf4jLogger]  [DUBBO] Send statistics to monitor zookeeper://192.168.1</div><div class="line">.21:2181/com.alibaba.dubbo.monitor.MonitorService?dubbo=2.5.3&amp;interface=com.alibaba.dubbo.monitor.MonitorService&amp;pid=11958&amp;timestamp=1508762187622, dubbo version: 2.5.3, current host: 192.168.1.21</div></pre></td></tr></table></figure>
<ul>
<li><p>multiline</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">input &#123;</div><div class="line">  beats &#123;</div><div class="line">    port =&gt; 5044</div><div class="line">    codec =&gt; multiline &#123;</div><div class="line">         pattern =&gt; <span class="string">"^%&#123;YEAR&#125;[/-]%&#123;MONTHNUM&#125;[/-]%&#123;MONTHDAY&#125;[/_]%&#123;TIME&#125; "</span></div><div class="line">         negate =&gt; <span class="literal">true</span></div><div class="line">         what =&gt; previous</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>Log4J<br>需要配置 Java 应用的 <code>Log4J</code> 设置，启动一个内置的 <code>SocketAppender</code>。修改应用的 log4j.xml 配置文件，添加如下配置段  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;appender name=<span class="string">"LOGSTASH"</span> class=<span class="string">"org.apache.log4j.net.SocketAppender"</span>&gt;</div><div class="line">    &lt;param name=<span class="string">"RemoteHost"</span> value=<span class="string">"logstash_hostname"</span> /&gt;</div><div class="line">    &lt;param name=<span class="string">"ReconnectionDelay"</span> value=<span class="string">"60000"</span> /&gt;</div><div class="line">    &lt;param name=<span class="string">"LocationInfo"</span> value=<span class="string">"true"</span> /&gt;</div><div class="line">    &lt;param name=<span class="string">"Threshold"</span> value=<span class="string">"DEBUG"</span> /&gt;</div><div class="line">&lt;/appender&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>然后把这个新定义的 appender 对象加入到 root logger 里，可以跟其他已有 logger 共存<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;root&gt;</div><div class="line">    &lt;level value=<span class="string">"INFO"</span>/&gt;</div><div class="line">    &lt;appender-ref ref=<span class="string">"OTHERPLACE"</span>/&gt;</div><div class="line">    &lt;appender-ref ref=<span class="string">"LOGSTASH"</span>/&gt;</div><div class="line">&lt;/root&gt;</div></pre></td></tr></table></figure></p>
<p>log4j.properties 配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">log</span>4j.rootLogger=DEBUG, logstash</div><div class="line"></div><div class="line"><span class="comment">###SocketAppender###</span></div><div class="line"><span class="built_in">log</span>4j.appender.logstash=org.apache.log4j.net.SocketAppender</div><div class="line"><span class="built_in">log</span>4j.appender.logstash.Port=4560</div><div class="line"><span class="built_in">log</span>4j.appender.logstash.RemoteHost=logstash_hostname</div><div class="line"><span class="built_in">log</span>4j.appender.logstash.ReconnectionDelay=60000</div><div class="line"><span class="built_in">log</span>4j.appender.logstash.LocationInfo=<span class="literal">true</span></div></pre></td></tr></table></figure></p>
<p>Log4J 会持续尝试连接你配置的 <code>logstash_hostname</code> 这个地址，建立连接后，即开始发送日志数据  </p>
<p>Logstash，Java 应用端的配置完成以后，开始设置 Logstash 的接收端，配置如下所示，其中 4560 端口是 Log4J SocketAppender 的默认对端端口<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">input &#123;</div><div class="line">  <span class="built_in">log</span>4j &#123;</div><div class="line">    <span class="built_in">type</span> =&gt; <span class="string">"log4j-json"</span></div><div class="line">    port =&gt; 4560</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>JSON Event layout<br>如果无法采用 socketappender ，必须使用文件方式的，其实 Log4J 有一个 layout 特性，用来控制日志输出的格式。和 Nginx 日志自己拼接 JSON 输出类似，也可以通过 layout 功能，记录成 JSON 格式。</li>
</ul>
<p>参考：<a href="https://github.com/logstash/log4j-jsonevent-layout" target="_blank" rel="external">https://github.com/logstash/log4j-jsonevent-layout</a>  </p>
<p>logstash官方提供的扩展包，可以通过mvnrepository.com搜索下载<br><a href="http://central.maven.org/maven2/net/logstash/log4j/jsonevent-layout/1.7/jsonevent-layout-1.7.jar" target="_blank" rel="external">http://central.maven.org/maven2/net/logstash/log4j/jsonevent-layout/1.7/jsonevent-layout-1.7.jar</a>  </p>
<p>或者直接编辑自己项目的pom.xml添加依赖<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;net.logstash.log4j&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;jsonevent-layout&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;1.7&lt;/version&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure></p>
<p>然后修改项目的log4j.properties文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">log</span>4j.rootCategory=WARN,RollingLog</div><div class="line"><span class="built_in">log</span>4j.appender.RollingLog=org.apache.log4j.DailyRollingFileAppender</div><div class="line"><span class="built_in">log</span>4j.appender.RollingLog.Threshold=TRACE</div><div class="line"><span class="built_in">log</span>4j.appender.RollingLog.File=api.log</div><div class="line"><span class="built_in">log</span>4j.appender.RollingLog.DatePattern=.yyyy-MM-dd</div><div class="line"><span class="built_in">log</span>4j.appender.RollingLog.layout=net.logstash.log4j.JSONEventLayoutV1</div></pre></td></tr></table></figure></p>
<p>如果是log4j.xml文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;appender name=<span class="string">"Console"</span> class=<span class="string">"org.apace.log4j.ConsoleAppender"</span>&gt;</div><div class="line">    &lt;param name=<span class="string">"Threshould"</span> value=<span class="string">"TRACE"</span> /&gt;</div><div class="line">    &lt;layout class=<span class="string">"net.logstash.log4j.JSONEventLayoutV1"</span> /&gt;</div><div class="line">&lt;/appender&gt;</div></pre></td></tr></table></figure></p>
<p>生成的文件就是Logstash标准的JSON格式，logstash使用下面配置读取<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">input &#123;</div><div class="line">    file &#123;</div><div class="line">            codec =&gt; json</div><div class="line">            path =&gt; [<span class="string">"/path/to/log4j.log"</span>]</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>生成的Logstash事件如下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"mdc"</span>: &#123;&#125;,</div><div class="line">    <span class="string">"line_number"</span>: <span class="string">"29"</span>,</div><div class="line">    <span class="string">"class"</span>:<span class="string">"org.eclipse,jetty.examples.logging.EchoFormServlet"</span>,</div><div class="line">    <span class="string">"@version"</span>:1,</div><div class="line">    <span class="string">"source_host"</span>:<span class="string">"jvstratusmbp.local"</span>,</div><div class="line">    <span class="string">"thread_name"</span>:<span class="string">"qtp513694835-14"</span>,</div><div class="line">    <span class="string">"message"</span>:<span class="string">"Got request from 0:0:0:0:0:0:0:1%0 using Mozilla\/5.0 (Macintosh;Inter Mac OS X 10_9_1) AppleWebit\/537.36 (KHTML, like Gecko) Chrome \/32.0.1700.77 Safari\/537.36"</span>,</div><div class="line">    <span class="string">"@timestamp"</span>:<span class="string">"2014-01-27T19:52:35.738z"</span>,</div><div class="line">    <span class="string">"level"</span>:<span class="string">"INFO"</span>,</div><div class="line">    <span class="string">"file"</span>:<span class="string">"EchoFormServlet.java"</span>,</div><div class="line">    <span class="string">"method"</span>:<span class="string">"doPost"</span>,</div><div class="line">    <span class="string">"logger_name"</span>:<span class="string">"org.eclipse.jetty.example.logging.EchoFormServlet"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果使用的不是Log4J而是logback项目来记录JAVA日志，Logstash官方也有类似的扩展包，修改pom.xml<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;net.logstash.logback&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;logstash-logback-encoder&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;4.4&lt;/version&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure></p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/10/30/Kibana5使用指南/">http://www.yfshare.vip/2017/10/30/Kibana5使用指南/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Elasticsearch查询语法]]></title>
      <url>http://www.yfshare.vip/2017/10/30/Elasticsearch%E6%9F%A5%E8%AF%A2%E8%AF%AD%E6%B3%95/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>Elasticsearch在很多情况下被当作一个文本型的NOSQL数据库，也有增删查改操作<br><a id="more"></a></p>
<h4 id="数据写入"><a href="#数据写入" class="headerlink" title="数据写入"></a>数据写入</h4><p>Elasticsearch的一大特点是，全是<code>RESTful</code>接口处理JSON请求<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPOST http://localhost:9200/logstash-2017.10.29/testlog -d '&#123;</span></div><div class="line">    <span class="string">"date"</span>: <span class="string">"1509271325780"</span></div><div class="line">    <span class="string">"user"</span>: <span class="string">"jack"</span></div><div class="line">    <span class="string">"mesg"</span>: <span class="string">"first message into Elasticsearch"</span></div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure></p>
<h4 id="数据获取"><a href="#数据获取" class="headerlink" title="数据获取"></a>数据获取</h4><p>在数据写入时，会返回该数据的<code>_id</code>，这是后续用来获取数据的关键：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XGET http://localhost:9200/logstash-2017.10.29/testlog/AV9nlDQhv96dGKcHC2zo</span></div><div class="line">&#123;<span class="string">"_index"</span>: <span class="string">"logstash-2017.10.29"</span>,<span class="string">"_type"</span>: <span class="string">"testlog"</span>, <span class="string">"_id"</span>: <span class="string">"AV9nlDQhv96dGKcHC2zo"</span>, <span class="string">"_version"</span>: 1, <span class="string">"found"</span>: <span class="literal">true</span>, <span class="string">"_source"</span>: &#123;</div><div class="line">    <span class="string">"date"</span>: <span class="string">"1509271325780"</span>,</div><div class="line">    <span class="string">"user"</span>: <span class="string">"jack"</span>,</div><div class="line">    <span class="string">"mesg"</span>: <span class="string">"first message into Elasticsearch"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>也可以使用下面语法来获取源数据部分<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -XGET http://localhost:9200/logstash-2017.10.29/testlog/AV9nlDQhv96dGKcHC2zo/_source</div></pre></td></tr></table></figure></p>
<p>或者使用下面语法来指明获取字段<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -XGET http://localhost:9200/logstash-2017.10.29/testlog/AV9nlDQhv96dGKcHC2zo?fields=user,mesg</div></pre></td></tr></table></figure></p>
<h4 id="数据删除"><a href="#数据删除" class="headerlink" title="数据删除"></a>数据删除</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#删除单条数据</span></div><div class="line"><span class="comment"># curl -XDELETE http://localhost:9200/logstash-2017.10.29/testlog/AV9nlDQhv96dGKcHC2zo</span></div><div class="line"></div><div class="line"><span class="comment">#删除整个type或者整个索引</span></div><div class="line"><span class="comment"># curl -XGET http://localhost:9200/logstash-2017.10.2*</span></div></pre></td></tr></table></figure>
<h4 id="数据更新"><a href="#数据更新" class="headerlink" title="数据更新"></a>数据更新</h4><p>分为两种情况：  </p>
<ol>
<li>全量提交</li>
<li>指明<code>_id</code>再发送一次写入请求<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#全部提交</span></div><div class="line"><span class="comment"># curl -XPOST http://localhost:9200/logstash-2017.10.29/testlog/AV9nlDQhv96dGKcHC2zo -d '&#123;</span></div><div class="line">    <span class="string">"date"</span>: <span class="string">"1509271325780"</span>,</div><div class="line">    <span class="string">"user"</span>: <span class="string">"jack"</span>,</div><div class="line">    <span class="string">"mesg"</span>: <span class="string">"first message into Elasticsearch but version 2"</span></div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#局部提交</span></div><div class="line"><span class="comment"># curl -XPOST http://localhost:9200/logstash-2017.10.29/testlog/AV9nlDQhv96dGKcHC2zo -d '&#123;</span></div><div class="line">    <span class="string">"doc"</span>: &#123;</div><div class="line">        <span class="string">"user"</span>: <span class="string">"jack wang"</span></div><div class="line">    &#125;</div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure>
<p>或者<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPOST http://localhost:9200/logstash-2017.10.29/testlog/AV9nlDQhv96dGKcHC2zo/_update -d '&#123;</span></div><div class="line">    <span class="string">"scripts"</span>: <span class="string">"ctx._source.user = \"someone\""</span></div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure></p>
<h4 id="全文搜索"><a href="#全文搜索" class="headerlink" title="全文搜索"></a>全文搜索</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XGET http://localhost:9200/logstash-2017.10.29/testlog/_search?pretty=true?q='first'</span></div><div class="line"></div><div class="line"><span class="comment"># curl -XGET http://localhost:9200/logstash-2017.10.29/testlog/_search?pretty=true?q=user:"jack"</span></div></pre></td></tr></table></figure>
<h5 id="querystring-语法"><a href="#querystring-语法" class="headerlink" title="querystring 语法"></a>querystring 语法</h5><p>上例中<code>?q=</code>后面的就是querystring语法，会在kibana中经常使用  </p>
<ul>
<li><code>全文检索</code>：直接写搜索的单词。如：<code>?q=aaaa</code></li>
<li><code>单字段的全文检索</code>：在搜索单词之前加上字段名和冒号。如：<code>?q=user:jack</code></li>
<li><code>单字段的精确检索</code>：在搜索单词前加上双引号。如：<code>?q=user:&quot;jack&quot;</code></li>
<li><code>多个检索条件的组合</code>：可以使用<code>NOT</code>、<code>AND</code>、<code>OR</code>来组合检索，必须是大写的。如：<code>?q=user:(&quot;jack&quot; OR &quot;bob&quot;) AND NOT mesg:aaaa</code></li>
<li><code>字段是否存在</code>：<code>_exists_:user</code>表示要求user字段存在，<code>_missing_:user</code>表示user字段不存在。如：<code>?q=_exists_:beat.name</code></li>
<li><code>通配符</code>：用<code>?</code>表示单字母，<code>*</code>表示任意个字母。如：<code>?q=DevE?N</code>，<code>?q=DevE?N*</code></li>
<li><code>正则</code>：比通配符更复杂一点点。如：<code>?q=/dub{2}o/</code><br>注：Elasticsearch正则性能不好，尽量不要使用太复杂或不使用。参考<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/query-dsl-regexp-query.html#regexp-synntax" target="_blank" rel="external">Elasticsearch正则表达式语法</a>  </li>
<li><code>近似搜索</code>：用<code>~</code>表示搜索单词可能有一字母写的不对。如：<code>?q=dubao~</code></li>
<li><code>范围搜索</code>：对数值和时间。如：<code>?q=@timestamp:&gt;150928968615</code>，<code>?q=@timestamp:[&quot;now-1m&quot; TO &quot;now&quot;]</code></li>
</ul>
<h5 id="DSL语法"><a href="#DSL语法" class="headerlink" title="DSL语法"></a>DSL语法</h5><p>Elasticsearch也支持其他查询语法，具体见：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/query-dsl-queries.html" target="_blank" rel="external">Elasticsearch其他查询语法</a>  </p>
<ul>
<li><code>term query</code><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XGET http://localhost:9200/_search -d '</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"query"</span>: &#123;</div><div class="line">    <span class="string">"term"</span>: &#123;</div><div class="line">      <span class="string">"_id"</span>: <span class="string">"AV9orWWLv96dGKcHDVyi"</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="聚合请求"><a href="#聚合请求" class="headerlink" title="聚合请求"></a>聚合请求</h5><p>在检索范围确定后，Elasticsearch还执行对结果集做聚合查询，返回更直接的聚合统计结果。<br><code>aggression</code>分为<code>bucket</code>和<code>metric</code>，分别用作词元划分和数值计算。而bucket aggression还支持在自身结果集的基础上叠加新的aggression。<br>实现一个时序的百分比统计<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPOST 'http://localhost:9200/logstash-2017.10.29/_search?size=0&amp;pretty' -d '&#123;</span></div><div class="line"><span class="string">"aggs"</span>: &#123;</div><div class="line">    <span class="string">"percentile_over_time"</span>: &#123;</div><div class="line">        <span class="string">"date_histogram"</span>: &#123;</div><div class="line">            <span class="string">"field"</span>: <span class="string">"@timestamp"</span>,</div><div class="line">            <span class="string">"interval"</span>: <span class="string">"1m"</span></div><div class="line">        &#125;,</div><div class="line">        <span class="string">"aggs"</span>: &#123;</div><div class="line">            <span class="string">"percentile_one_time"</span>: &#123;</div><div class="line">                <span class="string">"percentiles"</span>: &#123;</div><div class="line">                    <span class="string">"field"</span>: <span class="string">"requesttime"</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure></p>
<h5 id="pipeline聚合"><a href="#pipeline聚合" class="headerlink" title="pipeline聚合"></a>pipeline聚合</h5><p>Elasticsearch 2.x 新增pipeline aggression类型，再已有aggression返回的数组数据之后，再对这组数值做一次运算。在Kibana 5.0的timelion中有用到<br>常见的pipeline聚合场景，就是对时序数据求移动平均值<br>示例：<br>对响应时间设置如下：周期为7，移动窗口为30，alpa、beta、gamma参数均为0.5，holt-winters季节性预测2个未来值<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"aggs"</span>: &#123;</div><div class="line">        <span class="string">"my_date_histo"</span>: &#123;</div><div class="line">            <span class="string">"date_histogram"</span>: &#123;</div><div class="line">                <span class="string">"field"</span>: <span class="string">"@timestamp"</span>,</div><div class="line">                <span class="string">"interval"</span>: <span class="string">"1h"</span></div><div class="line">            &#125;,</div><div class="line">            <span class="string">"aggs"</span>: &#123;</div><div class="line">                <span class="string">"avgtime"</span>: &#123;</div><div class="line">                    <span class="string">"avg"</span>: &#123; <span class="string">"field"</span>: <span class="string">"requesttime"</span> &#125;</div><div class="line">                &#125;,</div><div class="line">                <span class="string">"the_movavg"</span>: &#123;</div><div class="line">                    <span class="string">"moving_avg"</span>: &#123;</div><div class="line">                        <span class="string">"buckets_path"</span>: <span class="string">"avgtime"</span>,</div><div class="line">                        <span class="string">"window"</span>: 30,</div><div class="line">                        <span class="string">"model"</span>: <span class="string">"holt_winters"</span>,</div><div class="line">                        <span class="string">"predict"</span>: 2,</div><div class="line">                        <span class="string">"settings"</span>: &#123;</div><div class="line">                            <span class="string">"type"</span>: <span class="string">"mult"</span>,</div><div class="line">                            <span class="string">"alpha"</span>: 0.5,</div><div class="line">                            <span class="string">"beat"</span>: 0.5,</div><div class="line">                            <span class="string">"gamma"</span>: 0.5,</div><div class="line">                            <span class="string">"period"</span>: 7,</div><div class="line">                            <span class="string">"pad"</span>: <span class="literal">true</span></div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="buckets-path语法"><a href="#buckets-path语法" class="headerlink" title="buckets_path语法"></a>buckets_path语法</h5><p>aggression是有堆叠层级关系的，所以pipeline aggression在引用 metric aggression时会涉及到层级的问题。在上例中，the_movavg和avgtime是同一级，所以buckets_path直接就写avgtime即可。但如果把the_movavg上提一层，跟my_date_histo同级<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">"buckets_path"</span>: <span class="string">"my_date_histo &gt; avgtime"</span></div></pre></td></tr></table></figure></p>
<p>如果用的是返回的数值有多个值的聚合，比如<code>?percentiles</code>或者<code>?extended_stats</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">"buckets_path"</span>: <span class="string">"percentile_over_time &gt; percentile_one_time.95"</span></div></pre></td></tr></table></figure></p>
<p>目前Elasticsearch支持的聚合请求列表，参考：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/search-aggregations.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/reference/5.6/search-aggregations.html</a><br>参考阅读：Holt Winters预测算法，见：<a href="https://en.wikipedia.org/wiki/Holt-Winters" target="_blank" rel="external">https://en.wikipedia.org/wiki/Holt-Winters</a>  </p>
<h5 id="搜索请求参数"><a href="#搜索请求参数" class="headerlink" title="搜索请求参数"></a>搜索请求参数</h5><p>搜索请求参数如下：  </p>
<ul>
<li><code>from</code>: 从索引的第几条数据开始返回，默认是0  </li>
<li><code>size</code>: 返回多少条数据，默认是10<br><em>Elasticsearch集群实际是需要给 coordinate node 返回 shards number x (from + size)条数据，然后在单机上进行排序，最后给客户端返回大小为 size的数据。所以请慎用 from和size参数</em><br><em>此外，Elasticsearch 2.x 还增加了一个索引级别的动态控制配置项：index.max_result_window，默认为10000，即from + size大于10000，Elasticsearch会直接拒绝这次请求不进行具体搜索，以保护节点</em><br><em>Elasticsearch 2.x 还优化了，当设置 “size”:0 时，自动改变 search_type为 count。跳过过程的 fetch 阶段</em>  </li>
<li><code>timeout</code>：coordinate node 等待超时时间。当达到阀值后，coordinate node 会直接把当前收到的数据返回个客户端，不再等待 data node后续的返回结果了。<br>注：这个参数只是为了配合客户端程序，并不能取消data node上搜索任务还在运行和占用资源  </li>
<li><code>terminate_after</code>：各data node上，扫描单个分片时找到多少记录后，就认为足够了。这个参数可以切实保护 data node 上搜索任务不会长期运行和占用资源。也就是意味着搜索范围没有覆盖全部索引，是一个抽样数据。准确率不好判断。  </li>
<li><code>request_cache</code>：各data node上，在分片级别对请求的响应（仅限于hits.total数值、 aggression 和 suggestion的结果集）做的缓存。注意，这个缓存的键值要求很严格，请求的JSON必须一字不易，缓存才能命中<br>另外，request_cache 参数不能写在请求的JSON里，只能以URL参数的形式存在，示例如下：  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPOST http://localhost:9200/_search?request_cache=true -d '</span></div><div class="line">&#123;</div><div class="line">    <span class="string">"size"</span>: 0,</div><div class="line">    <span class="string">"timeout"</span>: <span class="string">"120s"</span>,</div><div class="line">    <span class="string">"terminate_after"</span>: 1000000,</div><div class="line">    <span class="string">"query"</span>: &#123; <span class="string">"match_all"</span>: &#123;&#125; &#125;,</div><div class="line">    <span class="string">"aggs"</span>: &#123;<span class="string">"terms"</span>: &#123; <span class="string">"terms"</span> : &#123; <span class="string">"field"</span> : <span class="string">"keyname"</span> &#125; &#125; &#125;</div><div class="line">&#125;</div><div class="line"><span class="string">'</span></div></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/10/30/Elasticsearch查询语法/">http://www.yfshare.vip/2017/10/30/Elasticsearch查询语法/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Python 读取Mysql生成EXCEL（XLSX）]]></title>
      <url>http://www.yfshare.vip/2017/10/16/Python-%E8%AF%BB%E5%8F%96Mysql%E7%94%9F%E6%88%90EXCEL%EF%BC%88XLSX%EF%BC%89/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>以前做报表从Mysql数据里面提取数据很简单，几条简单的SHELL脚本就可以实现该功能，因为是自己使用，所以对于格式无所谓，以前使用的都是<code>.csv</code>格式，因为其是以<code>逗号</code>区分的，方便脚本处理。这次不一样了，虽然这次接到需求也是从Mysql中导出数据，但是！！导出文件的格式必须是<code>.XLSX</code>这是微软EXCEL软件自有的格式，包含特殊的文件头，所以之前的方法失效了，失效了… 折腾了好久，也请教了别人，终于，终于解决了这个需求。<br><a id="more"></a><br>环境：<br>　　　Centos 7.2.1511<br>　　　Python 2.7.5 -&gt; 3.5</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># python -V</span></div><div class="line">Python 2.7.5</div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#安装easy_install命令</span></div><div class="line">[root@localhost ~]<span class="comment"># wget https://bootstrap.pypa.io/ez_setup.py -O - | python</span></div><div class="line"></div><div class="line"><span class="comment">#安装pip命令(python包管理软件)</span></div><div class="line">[root@localhost ~]<span class="comment"># wget https://pypi.python.org/packages/11/b6/abcb525026a4be042b486df43905d6893fb04f05aac21c32c638e939e447/pip-9.0.1.tar.gz#md5=35f01da33009719497f01a4ba69d63c9</span></div><div class="line">[root@localhost ~]<span class="comment"># tar -zxf pip-9.0.1.tar.gz </span></div><div class="line">[root@localhost ~]<span class="comment"># cd pip-9.0.1</span></div><div class="line">[root@localhost pip-9.0.1]<span class="comment"># python setup.py install</span></div><div class="line"></div><div class="line"><span class="comment">#安装python module</span></div><div class="line">[root@localhost ~]<span class="comment"># python select3.py </span></div><div class="line">Traceback (most recent call last):</div><div class="line">  File <span class="string">"select3.py"</span>, line 3, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    from sqlalchemy import create_engine</div><div class="line">ImportError: No module named sqlalchemy</div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#安装sqlalchemy模块</span></div><div class="line">[root@localhost ~]<span class="comment"># pip install sqlalchemy</span></div><div class="line">Collecting pymysql</div><div class="line">  Downloading PyMySQL-0.7.11-py2.py3-none-any.whl (78kB)</div><div class="line">    100% |████████████████████████████████| 81kB 48kB/s </div><div class="line">Installing collected packages: pymysql</div><div class="line">Successfully installed pymysql-0.7.11</div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#重复执行python select3.py 安装缺失的模块</span></div><div class="line">[root@localhost ~]<span class="comment"># pip install pymysql</span></div><div class="line">[root@localhost ~]<span class="comment"># pip install pandas</span></div><div class="line"></div><div class="line"><span class="comment"># Python 2.7不支持中文，报错如下，需要升级到 Python ，测试 Python 3.5.4 支持</span></div><div class="line">[root@localhost ~]<span class="comment"># python select3.py </span></div><div class="line">Traceback (most recent call last):</div><div class="line">  File <span class="string">"select3.py"</span>, line 10, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    sql.encode(<span class="string">'gb18030'</span>)</div><div class="line">UnicodeDecodeError: <span class="string">'ascii'</span> codec can<span class="string">'t decode byte 0xe6 in position 20: ordinal not in range(128)</span></div><div class="line">[root@localhost ~]#</div></pre></td></tr></table></figure>
<p>升级 Python 2.7.5 至 Python 3.5<br><strong>不要动系统自带的Python，否则系统的某些功能都无法正常使用</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># wget https://www.python.org/ftp/python/3.5.4/Python-3.5.4.tgz</span></div><div class="line">[root@localhost ~]<span class="comment"># yum install openssl-devel -y</span></div><div class="line">[root@localhost ~]<span class="comment"># tar -zxf Python-3.5.4.tgz</span></div><div class="line">[root@localhost ~]<span class="comment"># mkdir -p /usr/local/Python-3.5.4</span></div><div class="line">[root@localhost ~]<span class="comment"># cd Python-3.5.4</span></div><div class="line">[root@localhost Python-3.5.4]<span class="comment"># ./configure --prefix=/usr/local/Python-3.5.4/</span></div><div class="line">[root@localhost Python-3.5.4]<span class="comment"># make &amp;&amp; make install</span></div><div class="line">[root@localhost ~]<span class="comment"># /usr/local/Python-3.5.4/bin/python3.5 -V</span></div><div class="line">Python 3.5.4</div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment"># 现在系统同时存在两个版本的 Python，因此脚本需要的模块需要重新安装，因为Python 3.5.2之后自带 pip3 和 setuptools，因此需要使用 pip3 安装所需要的模块</span></div><div class="line">[root@localhost ~]<span class="comment"># /usr/local/Python-3.5.4/bin/python3.5 select3.py </span></div><div class="line">Traceback (most recent call last):</div><div class="line">  File <span class="string">"select3.py"</span>, line 3, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    from sqlalchemy import create_engine</div><div class="line">ImportError: No module named <span class="string">'sqlalchemy'</span></div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#安装所需要的 Python 模块</span></div><div class="line">[root@localhost ~]<span class="comment"># /usr/local/Python-3.5.4/bin/pip3.5 install sqlalchemy</span></div><div class="line">[root@localhost ~]<span class="comment"># /usr/local/Python-3.5.4/bin/pip3.5 install pymysql</span></div><div class="line">[root@localhost ~]<span class="comment"># /usr/local/Python-3.5.4/bin/pip3.5 install pandas     #这个很慢</span></div><div class="line">[root@localhost ~]<span class="comment"># /usr/local/Python-3.5.4/bin/pip3.5 install openpyxl</span></div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment"># cat /etc/profile.d/Python.sh </span></div><div class="line"><span class="meta">#!/bin/sh</span></div><div class="line">Python3_5_home=<span class="string">'/usr/local/Python-3.5.4'</span></div><div class="line"><span class="built_in">export</span> PATH=<span class="variable">$&#123;Python3_5_home&#125;</span>/bin:<span class="variable">$PATH</span></div><div class="line">[root@localhost ~]<span class="comment"># source /etc/profile.d/Python.sh</span></div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment"># /usr/local/Python-3.5.4/bin/python3.5 select3.py</span></div><div class="line">[root@localhost ~]<span class="comment"># ll | grep output.xlsx </span></div><div class="line">-rw-r--r--   1 root root      4854 Oct 15 06:37 output.xlsx</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/7B8F09CFC0CF45BCAD07916AA8A1CAFB?method=download&amp;shareKey=974173e2da4dc8ec9df2e29c1973427e" alt="Py_mysql_to_excel">  </p>
<p>如果报这个错，好像是 <code>查询SQL</code> 时超时了，在同级目录下会生成 <code>__pycache__</code>文件夹，脚本换个目录（不要在含有<code>__pycache__</code>这个目录的目录中执行 py脚本），然后删掉其父目录，再执行 py 脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">Traceback (most recent call last):</div><div class="line">  File <span class="string">"/usr/local/Python-3.5.4/lib/python3.5/site-packages/pandas/compat/__init__.py"</span>, line 47, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    import __builtin__ as builtins</div><div class="line">ImportError: No module named <span class="string">'__builtin__'</span></div><div class="line"></div><div class="line">During handling of the above exception, another exception occurred:</div><div class="line"></div><div class="line">Traceback (most recent call last):</div><div class="line">  File <span class="string">"select.py </span></div><div class="line"></div><div class="line">", line 4, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    import pymysql</div><div class="line">  File <span class="string">"/usr/local/Python-3.5.4/lib/python3.5/site-packages/pymysql/__init__.py"</span>, line 92, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    from . import connections as _orig_conn</div><div class="line">  File <span class="string">"/usr/local/Python-3.5.4/lib/python3.5/site-packages/pymysql/connections.py </span></div><div class="line"></div><div class="line">", line 13, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    import socket</div><div class="line">  File <span class="string">"/usr/local/Python-3.5.4/lib/python3.5/socket.py </span></div><div class="line"></div><div class="line">", line 52, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    import os, sys, io, selectors</div><div class="line">  File <span class="string">"/usr/local/Python-3.5.4/lib/python3.5/selectors.py </span></div><div class="line"></div><div class="line">", line 11, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    import select</div><div class="line">  File <span class="string">"/data/soros/job/report/jinrongban_data_back/test/select.py </span></div><div class="line"></div><div class="line">", line 5, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    import pandas as pd</div><div class="line">  File <span class="string">"/usr/local/Python-3.5.4/lib/python3.5/site-packages/pandas/__init__.py"</span>, line 23, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    from pandas.compat.numpy import *</div><div class="line">  File <span class="string">"/usr/local/Python-3.5.4/lib/python3.5/site-packages/pandas/compat/__init__.py"</span>, line 60, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    import http.client as httplib</div><div class="line">  File <span class="string">"/usr/local/Python-3.5.4/lib/python3.5/http/client.py </span></div><div class="line"></div><div class="line">", line 739, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    class HTTPConnection:</div><div class="line">  File <span class="string">"/usr/local/Python-3.5.4/lib/python3.5/http/client.py </span></div><div class="line"></div><div class="line">", line 749, <span class="keyword">in</span> HTTPConnection</div><div class="line">    def __init__(self, host, port=None, timeout=socket._GLOBAL_DEFAULT_TIMEOUT,</div><div class="line">AttributeError: module <span class="string">'socket'</span> has no attribute <span class="string">'_GLOBAL_DEFAULT_TIMEOUT'</span></div></pre></td></tr></table></figure></p>
<p>Python脚本：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># cat select3.py</span></div><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment">#-*- coding: utf8 -*-</span></div><div class="line">from sqlalchemy import create_engine</div><div class="line">import pymysql</div><div class="line">import pandas as pd</div><div class="line">from pandas import DataFrame,Series</div><div class="line"></div><div class="line">engine=create_engine(<span class="string">'mysql+pymysql://username:password@192.168.1.1/database_name?charset=gbk,pool_timeout=3000'</span>)</div><div class="line">sql=<span class="string">"select count(*) as '总数' from database.table1;"</span></div><div class="line">sql.encode(<span class="string">'gb18030'</span>)</div><div class="line">df=pd.read_sql(sql,engine)</div><div class="line">writer = pd.ExcelWriter(<span class="string">'/root/output.xlsx'</span>)</div><div class="line">df.to_excel(writer,<span class="string">'Sheet1'</span>,index=False)</div><div class="line">writer.save()</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>附件：<br><a href="http://note.youdao.com/yws/api/personal/file/E1F6B7761791434088E5695A6FD9F129?method=download&amp;shareKey=91d60ea9e7ec086373e91948ff2c6038" target="_blank" rel="external">Python-3.5.4.tar.gz</a><br><a href="http://note.youdao.com/yws/api/personal/file/B4252F91B6C44921BDFB59666FBB099F?method=download&amp;shareKey=3217d852ff44cf5c33a44c442eacf32c" target="_blank" rel="external">select3.py</a><br><a href="http://note.youdao.com/yws/api/personal/file/A971448108714F66B09900242EAD747D?method=download&amp;shareKey=5a644f1f069d121d8b1f356013aeb84e" target="_blank" rel="external">numpy-1.13.3-cp35-cp35m-manylinux1_x86_64.whl</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/10/16/Python-读取Mysql生成EXCEL（XLSX）/">http://www.yfshare.vip/2017/10/16/Python-读取Mysql生成EXCEL（XLSX）/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Zabbix监控redis]]></title>
      <url>http://www.yfshare.vip/2017/09/10/Zabbix%E7%9B%91%E6%8E%A7redis/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>Zabbix监控Redis<br><a id="more"></a><br>环境：<br>　　　Centos 7.3<br>　　　Zabbix version : 3.0.2<br>　　　Redis version : 3.2.5  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#监控脚本</span></div><div class="line">[root@localhost ~]<span class="comment"># cd /etc/zabbix/scripts/</span></div><div class="line">[root@localhost scripts]<span class="comment"># ls</span></div><div class="line">check_redis.sh</div><div class="line">[root@localhost scripts]<span class="comment"># cat check_redis.sh </span></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">PORT=<span class="string">'6379'</span></div><div class="line">STATUS_redis=`/bin/redis-cli -h <span class="string">'192.168.1.1'</span> -p <span class="variable">$PORT</span> <span class="_">-a</span> redis_password ping`</div><div class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$STATUS_redis</span>"</span> == <span class="string">'PONG'</span> ];<span class="keyword">then</span></div><div class="line">	<span class="built_in">echo</span> <span class="string">'1'</span></div><div class="line"><span class="keyword">else</span></div><div class="line">	<span class="built_in">echo</span> <span class="string">'0'</span></div><div class="line"><span class="keyword">fi</span></div><div class="line">[root@localhost scripts]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#zabbix agent</span></div><div class="line">[root@localhost ~]<span class="comment"># cd /etc/zabbix/zabbix_agentd.d/</span></div><div class="line">[root@localhost zabbix_agentd.d]<span class="comment"># cat userparameter_redis.conf </span></div><div class="line">UserParameter=redis_status[*],/bin/redis-cli -h <span class="string">'192.168.1.1'</span> -p <span class="variable">$1</span> <span class="_">-a</span> redis_password info | grep -w <span class="variable">$2</span> | awk -F<span class="string">':'</span> <span class="string">'&#123;print $NF&#125;'</span></div><div class="line">UserParameter=redis_ping,sh /etc/zabbix/scripts/check_redis.sh</div><div class="line">[root@localhost zabbix_agentd.d]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment"># systemctl restart zabbix-agent</span></div><div class="line">[root@localhost ~]<span class="comment"># zabbix_get -s localhost -k redis_ping</span></div><div class="line">1</div><div class="line">[root@localhost ~]<span class="comment"># zabbix_get -s localhost -k redis_status[6379,used_memory]</span></div><div class="line">1210708664</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>把修改后的模版链接到主机上<br><img src="http://note.youdao.com/yws/api/personal/file/CC389D2BC7B64E31AC375564D51DFFDD?method=download&amp;shareKey=f62b62d5785e6b5d59091beb1a84e087" alt="Zabbix Monitor Redis"><br><img src="http://note.youdao.com/yws/api/personal/file/4B422DF4096E4BB29C95C36C94BB17A2?method=download&amp;shareKey=ed5f2e64d8d7999e4daf559e6c48c10f" alt="Zabbix Monitor Redis"><br><img src="http://note.youdao.com/yws/api/personal/file/70AC5B37AF304881A771259522ACF1AE?method=download&amp;shareKey=24338b2339b17eddff0fa60d721d07f9" alt="Zabbix Monitor Redis"><br><img src="http://note.youdao.com/yws/api/personal/file/F043F5ABCE964C9A88B7DC1D4BE4E600?method=download&amp;shareKey=78a2dd918ea6d15bbbfc7a003fd8fc1c" alt="Zabbix Monitor Redis"><br><img src="http://note.youdao.com/yws/api/personal/file/965860E7F3C343109324312F17CF0C42?method=download&amp;shareKey=58fe3b21783cc6c81cdeccbff4ffe9c8" alt="Zabbix Monitor Redis"><br><img src="http://note.youdao.com/yws/api/personal/file/6D2C578CB4C1406AB0C7201AAAF18CE8?method=download&amp;shareKey=ce1f49d596164110225afdf819ae1ca3" alt="Zabbix Monitor Redis"><br><img src="http://note.youdao.com/yws/api/personal/file/A210C26E59984F99936F36C525E225A3?method=download&amp;shareKey=a87e00f9930183e621c0300a0745a9ef" alt="Zabbix Monitor Redis">  </p>
<p>参考：<a href="http://blog.hackroad.com/operations-engineer/linux_server/11019.html" target="_blank" rel="external">http://blog.hackroad.com/operations-engineer/linux_server/11019.html</a><br><a href="http://www.cnblogs.com/gnuhpc/p/4609592.html" target="_blank" rel="external">http://www.cnblogs.com/gnuhpc/p/4609592.html</a>  </p>
<p>附件：<br><a href="http://note.youdao.com/yws/api/personal/file/E9122E61EE1E48E78C30C36C458A83FC?method=download&amp;shareKey=09aa40c7a459918803a8f76566c9865c" target="_blank" rel="external">Zabbix监控redis模版6379</a><br>注：这个redis监控脚本需要根据实际情况修改  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/09/10/Zabbix监控redis/">http://www.yfshare.vip/2017/09/10/Zabbix监控redis/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Zookeeper运维经验分享[转]]]></title>
      <url>http://www.yfshare.vip/2017/09/04/Zookeeper%E8%BF%90%E7%BB%B4%E7%BB%8F%E9%AA%8C%E5%88%86%E4%BA%AB-%E8%BD%AC/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>　　Zookeeper是一个分布式协调框架，有不错的性能，也经过许多公司的验证，所以在很多场景都有使用。大家一般用Zookeeper来实现服务发现(类似DNS)，配置管理，分布式锁，leader选举等。在这些场景中，Zookeeper成为了一个被依赖的核心组件，Zookeeper的稳定性是需要特别关注的<br><a id="more"></a><br>　　去哪儿网也在很多场景依赖Zookeeper，所以我们也一直在摸索怎么更好的运维稳定的Zookeeper集群。在过去的几年我们也踩过一些坑，也因为Zookeeper导致了故障。现在将我们运维Zookeeper集群的一些经验分享，也欢迎大家提供更好的建议<br>　　那么在打算运维一套Zookeeper集群之前，我们先了解一些Zookeeper的基本原理<br>　　集群里分三种角色: Leader,Follower和Observer。Leader和Follower参与投票，Observer只会『听』投票的结果，不参与投票  </p>
<p>　　投票集群里的节点数要求是奇数  </p>
<ol>
<li>一个集群容忍挂掉的节点数的等式为 <code>N=2F +1</code>，N为投票集群节点数，F为能同时容忍失败节点数。比如一个三节点集群，可以挂掉一个节点，5节点集群可以挂掉两个…  </li>
<li>一个写操作需要半数以上的节点ack，所以集群节点数越多，整个集群可以抗挂点的节点数越多(越可靠)，但是吞吐量越差  </li>
</ol>
<p>　　Zookeeper里所有节点以及节点的数据都会放在内存里，形成一棵树的数据结构。并且定时的dump snapshot到磁盘<br>　　Zookeeper的Client与Zookeeper之间维持的是长连接，并且保持心跳，Client会与Zookeeper之间协商出一个Session超时时间出来(其实就是Zookeeper Server里配置了最小值，最大值，如果client的值在这两个值之间则采用client的，小于最小值就是最小值，大于最大值就用最大值)，如果在Session超时时间内没有收到心跳，则该Session过期<br>　　Client可以watch Zookeeper那个树形数据结构里的某个节点或数据，当有变化的时候会得到通知  </p>
<p>有了这些了解后，那么我们心里其实有底了  </p>
<h2 id="最小生产集群"><a href="#最小生产集群" class="headerlink" title="最小生产集群"></a>最小生产集群</h2><p>　　要确保Zookeeper能够稳定运行，那么就需要确保投票能够正常进行，最好不要挂一个节点整个就不work了，所以我们一般要求最少5个节点部署。</p>
<h2 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h2><p>　　除了节点外，我们还要看不能一台物理机器，一个机柜或一个交换机挂掉然后影响了整个集群，所以节点的网络结构也要考虑。这个可能就比很多应用服务器的要求更加严格。</p>
<h2 id="分Group，保护核心Group"><a href="#分Group，保护核心Group" class="headerlink" title="分Group，保护核心Group"></a>分Group，保护核心Group</h2><p>　　要确保Zookeeper整个集群可靠运行，就是要确保投票集群可靠。那在我们这里，将一个Zookeeper集群划分为多个小的Group，我们称Leader+Follower为核心Group，核心Group我们一般是不向外提供服务的，然后我们会根据不同的业务再加一些Observer，比如一个Zookeeper集群为服务发现，消息，定时任务三个不同的组件提供服务，那么我们为建立三个Observer Group，分别给这三个组件使用，而Client只会连接分配给它的Observer Group，不去连接核心Group。这样核心Group就不会给Client提供长连接服务，也不负责长连接的心跳，这大大的减轻了核心Group的压力，因为在实际环境中，一个Zookeeper集群要为上万台机器提供服务，维持长连接和心跳还是要消耗一定的资源的。因为Observer是不参与投票的所以加Observer并不会降低整体的吞吐量，而且Observer挂掉不会影响整个集群的健康  </p>
<p>但是这里要注意的是，分Observer Group只能解决部分问题，因为毕竟所有的写入还是要交给核心Group来处理的，所以对于写入量特别大的应用来说，还是需要进行集群上的隔离，比如Storm和Kafka就对Zookeeper压力比较大，你就不能将其与服务发现的集群放在一起  </p>
<h2 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h2><p>因为Zookeeper将所有数据都放在内存里，所以对JVM以及机器的内存也要预先计划，如果出现Swap那将严重的影响Zookeeper集群的性能，所以我一般不怎么推荐将Zookeeper用作通用的配置管理服务。因为一般配置数据还是挺大的，这些全部放在内存里不太可控。</p>
<h2 id="日志清理"><a href="#日志清理" class="headerlink" title="日志清理"></a>日志清理</h2><p>因为Zookeeper要频繁的写txlog(Zookeeper写的一种顺序日志)以及定期dump内存snapshot到磁盘，这样磁盘占用就越来越大，所以Zookeeper提供了清理这些文件的机制，但是这种机制并不太合理，它只能设置间隔多久清理，而不能设置具体的时间段。那么就有可能碰到高峰期间清理，所以建议将其关闭:<code>autopurge.purgeInterval=0</code>。然后使用crontab等机制，在业务低谷的时候清理。</p>
<h2 id="日志，jvm配置"><a href="#日志，jvm配置" class="headerlink" title="日志，jvm配置"></a>日志，jvm配置</h2><p>从官网直接下载的包如果直接启动运行是很糟糕的，这个包默认的配置日志是不会轮转的，而且是直接输出到终端。我们最开始并不了解这点，然后运行一段时间后发现生成一个庞大的zookeeper.out的日志文件。除此之外，这个默认配置还没有设置任何jvm相关的参数(所以堆大小是个默认值)，这也是不可取的。那么有的同学说那我去修改Zookeeper的启动脚本吧。最好不要这样做，Zookeeper会加载conf文件夹下一个名为<code>zookeeper-env.sh</code>的脚本，所以你可以将一些定制化的配置写在这里，而不是直接去修改Zookeeper自带的脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">　　<span class="comment">#!/usr/bin/env bash</span></div><div class="line">　　JAVA_HOME= <span class="comment">#java home</span></div><div class="line">　　ZOO_LOG_DIR= <span class="comment">#日志文件放置的路径</span></div><div class="line">　　ZOO_LOG4J_PROP=<span class="string">"INFO,ROLLINGFILE"</span> <span class="comment">#设置日志轮转</span></div><div class="line">　　JVMFLAGS=<span class="string">"jvm的一些设置，比如堆大小，开gc log等"</span></div></pre></td></tr></table></figure></p>
<h2 id="地址"><a href="#地址" class="headerlink" title="地址"></a>地址</h2><p>在实际环境中，我们可能因为各种原因比如机器过保，硬件故障等需要迁移Zookeeper集群，所以Zookeeper的地址是一个很头痛的事情。这个地址有两方面，第一个是提供给Client的地址，建议这个地址通过配置的方式下发，不要让使用方直接使用，这一点我们前期做的不好。另外一个是集群配置里，集群之间需要通讯，也需要地址。我们的处理方式是设置hosts:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">192.168.1.20 zk1</div><div class="line">192.168.1.21 zk2</div><div class="line">192.168.1.22 zk3</div></pre></td></tr></table></figure></p>
<p>在配置里:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">server.1=zk1:2081:3801</div><div class="line">server.2=zk2:2801:3801</div><div class="line">server.3=zk3:2801:3801</div></pre></td></tr></table></figure></p>
<p>这样在需要迁移的时候，我们停老的节点，起新的节点只需要修改hosts映射就可以了。比如现在server.3需要迁移，那我们在hosts里将zk3映射到新的ip地址。但是对于java有一个问题是，java默认会永久缓存DNS cache，即使你将zk3映射到别的ip，如果并不重启server.1, server.2，它是不会解析到新的ip的，这个需要修改<code>$JAVA_HOME/jre/lib/security/java.security</code>文件里的<code>networkaddress.cache.ttl=60</code>，将其修改为一个比较小的数。<br>　　对于这个迁移的问题，我们还遇到一个比较尴尬的情况，在最后的坑里会有提及  </p>
<h2 id="日志位置"><a href="#日志位置" class="headerlink" title="日志位置"></a>日志位置</h2><p>Zookeeper主要产生三种IO:txlog(每个写操作，包括新Session都会记录一条log)，Snapshot以及运行的应用日志。一般建议将这三个IO分散到三个不同的盘上。不过我们倒是一直没有这么实验过，我们的Zookeeper也是运行在虚拟机(一般认为虚拟机IO较差)上  </p>
<h2 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h2><p>我们对Zookeeper做了这样一些监控:  </p>
<ol>
<li>是否可写。 就是一个定时任务定时的去创建节点，删节点等操作。这里要注意的是Zookeeper是一个集群，我们监控的时候我还是希望对单个节点做监控，所以这些操作的时候不要连接整个集群，而是直接去连接单个节点</li>
<li>监控watcher数和连接数，特别是这两个数据有较大波动的时候，可以发现使用方是否有误用的情况</li>
<li>网络流量以及client ip，这个会记录到监控系统里，这样很快能发现『害群之马』</li>
</ol>
<h2 id="一些使用建议"><a href="#一些使用建议" class="headerlink" title="一些使用建议"></a>一些使用建议</h2><ol>
<li>不要强依赖Zookeeper，也就是Zookeeper出现问题业务已然可以正常运行。Zookeeper是一个分布式的协调框架，主要做的事情就是分布式环境的一致性。这是一个非常苛刻的事情，所以它的稳定性受很多方面的影响。比如我们常常使用Zookeeper做服务发现，那么服务发现其实是不需要严格的一致性的，我们可以缓存server list，当Zookeeper出现问题的时候已然可以正常工作，在这方面etcd要做的更好一些，Zookeeper如果出现分区，少数派是不能提供任何服务的，读都不可以，而etcd的少数派仍然可以提供读服务，这在服务发现的时候还是不错的</li>
<li>不要将很多东西塞到Zookeeper里，这个上面已经提到过</li>
<li>不要使用Zookeeper做细粒度锁，比如很多业务在订单这个粒度上使用Zookeeper做分布式锁，这会频繁的和Zookeeper交互，对Zookeeper压力较大，而且一旦出现问题影响面广。但是可以使用粗粒度的锁(其实leader选举也是一种锁)</li>
<li>不建议做通用配置的第二个理由是，通用配置要提供给特别多特别多系统使用，而且一些公共配置甚至所有系统都会使用，一旦这样的配置发生变更，Zookeeper会广播给所有的watcher，然后所有Client都来拉取，瞬间造成非常大的网络流量，引起所谓的『惊群』。而自己实现通用配置系统的时候，一般会对这种配置采取排队或分批通知的方式</li>
</ol>
<h2 id="一些坑"><a href="#一些坑" class="headerlink" title="一些坑"></a>一些坑</h2><ol>
<li><p>zookeeper client 3.4.5 ping时间间隔算法有问题，在遇到网络抖动等原因导致一次ping失败后会断开连接。3.4.6解决了这个问题 Bug1751</p>
</li>
<li><p>zookeeper client如果因为网络抖动断开了连接，如果后来又重连上了，zookeeper client会自动的将之前订阅的watcher等又全部订阅一遍，而Zookeeper默认对单个数据包的大小有个1M的限制，这往往就会超限，最后导致一直不断地的重试。这个问题在较新的版本得到了修复。Bug706</p>
</li>
<li><p>抛出<code>UnresolvedAddressException</code>异常导致Zookeeper选举线程退出，整个集群无法再选举，处于崩溃的边缘。这个问题是，某次OPS迁移机器，将老的机器回收了，所以老的机器的IP和机器名不复存在，最后抛出UnresolvedAddressException这个异常，而Zookeeper的选举线程(<code>QuorumCnxManager类里的Listener</code>)只捕获了IOException，导致该线程退出，该线程一旦退出只要现在的leader出现问题，需要重新选举，则不会选出新的leader来，整个集群就会崩溃。Bug2319(PS，这个bug是我report的)</p>
</li>
</ol>
<p>参考：<a href="http://www.cnblogs.com/seaspring/p/6099750.html" target="_blank" rel="external">http://www.cnblogs.com/seaspring/p/6099750.html</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/09/04/Zookeeper运维经验分享-转/">http://www.yfshare.vip/2017/09/04/Zookeeper运维经验分享-转/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Zabbix监控磁盘IO]]></title>
      <url>http://www.yfshare.vip/2017/08/28/Zabbix%E7%9B%91%E6%8E%A7%E7%A3%81%E7%9B%98IO/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>IOSTAT获取磁盘性能参数后，通过Zabbix Agent传值给Zabbix Server即可<br><a id="more"></a></p>
<h1 id="IOSTAT"><a href="#IOSTAT" class="headerlink" title="IOSTAT"></a>IOSTAT</h1><p>单独执行iostat，显示的结果为从系统开机到当前执行时刻的统计信息。以上输出中，除最上面指示系统版本、主机名和日期的一行外，另有两部分：  </p>
<ul>
<li>avg-cpu: 总体cpu使用情况统计信息，对于多核cpu，这里为所有cpu的平均值;  </li>
<li>Device: 各磁盘设备的IO统计信息.  </li>
</ul>
<p>环境：<br>　　　Centos 7.3<br>　　　Zabbix 3.0<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># iostat </span></div><div class="line">Linux 3.10.0-123.9.3.el7.x86_64 (uulend-Sstones-250) 	08/27/2017 	_x86_64_	(4 CPU)</div><div class="line"></div><div class="line">avg-cpu:  %user   %nice %system %iowait  %steal   %idle</div><div class="line">           7.05    0.00    1.52    8.46    0.00   82.96</div><div class="line"></div><div class="line">Device:            tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtn</div><div class="line">vda               8.53        23.92       101.76  190838701  811715460</div><div class="line">vdb            1508.27      8334.43       896.07 66480462117 7147631044</div><div class="line">dm-0             11.32       135.41       181.72 1080084008 1449488199</div><div class="line">dm-1              0.02         0.07         0.08     563269     645028</div><div class="line">dm-2              0.04         0.35         0.45    2825226    3588173</div><div class="line">vdc               0.86        58.49        65.16  466571469  519767308</div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># iostat -dxkt</span></div><div class="line">Linux 3.10.0-123.9.3.el7.x86_64 (uulend-Sstones-250) 	08/27/2017 	_x86_64_	(4 CPU)</div><div class="line"></div><div class="line">08/27/2017 08:02:50 PM</div><div class="line">Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util</div><div class="line">vda               0.02     3.27    2.05    6.48    23.93   101.79    29.48     0.02    2.91    3.63    2.69   0.80   0.68</div><div class="line">vdb               0.10   105.55 1436.35   72.02  8334.63   896.07    12.24     0.29    0.19    0.15    1.12   0.21  31.72</div><div class="line">dm-0              0.00     0.00    3.36    7.96   135.39   181.69    56.02     0.04    3.28    2.77    3.49   0.62   0.70</div><div class="line">dm-1              0.00     0.00    0.00    0.01     0.07     0.08    18.98     0.00    4.70    2.55    5.31   3.70   0.01</div><div class="line">dm-2              0.00     0.00    0.02    0.02     0.35     0.45    38.14     0.00    3.58    1.41    6.00   2.56   0.01</div><div class="line">vdc               0.00     0.19    0.60    0.25    58.61    65.29   288.35     0.05   59.65    2.49  195.64   2.03   0.17</div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<ul>
<li>rrqm/s: 每秒对该设备的读请求被合并次数，文件系统会对读取同块(block)的请求进行合并</li>
<li>wrqm/s: 每秒对该设备的写请求被合并次数</li>
<li>r/s: 每秒完成的读次数</li>
<li>w/s: 每秒完成的写次数</li>
<li>rkB/s: 每秒读数据量(kB为单位)</li>
<li>wkB/s: 每秒写数据量(kB为单位)</li>
<li>avgrq-sz:平均每次IO操作的数据量(扇区数为单位)</li>
<li>avgqu-sz: 平均等待处理的IO请求队列长度</li>
<li>await: 平均每次IO请求等待时间(包括等待时间和处理时间，毫秒为单位)</li>
<li>svctm: 平均每次IO请求的处理时间(毫秒为单位)</li>
<li>%util: 采用周期内用于IO操作的时间比率，即IO队列非空的时间比率</li>
</ul>
<h1 id="Zabbix监控"><a href="#Zabbix监控" class="headerlink" title="Zabbix监控"></a>Zabbix监控</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#扫描磁盘</span></div><div class="line">[root@localhost ~]<span class="comment"># cd /etc/zabbix/scripts/</span></div><div class="line">[root@localhost scripts]<span class="comment"># cat disk_scan.sh </span></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">diskarray=(`cat /proc/diskstats |grep -E <span class="string">"\bvd[abcdefg]\b|\bvd[abcdefg]\b"</span>|grep -i <span class="string">"\b<span class="variable">$1</span>\b"</span>|awk <span class="string">'&#123;print $3&#125;'</span>|sort|uniq   </div><div class="line">2&gt;/dev/null`)length=<span class="variable">$&#123;#diskarray[@]&#125;</span></div><div class="line"><span class="built_in">printf</span> <span class="string">"&#123;\n"</span></div><div class="line"><span class="built_in">printf</span>  <span class="string">'\t'</span><span class="string">"\"data\":["</span></div><div class="line"><span class="keyword">for</span> ((i=0;i&lt;<span class="variable">$length</span>;i++))</div><div class="line"><span class="keyword">do</span></div><div class="line">         <span class="built_in">printf</span> <span class="string">'\n\t\t&#123;'</span></div><div class="line">         <span class="built_in">printf</span> <span class="string">"\"&#123;#DISKNAME&#125;\":\"<span class="variable">$&#123;diskarray[$i]&#125;</span>\"&#125;"</span></div><div class="line">         <span class="keyword">if</span> [ <span class="variable">$i</span> <span class="_">-lt</span> $[<span class="variable">$length</span>-1] ];<span class="keyword">then</span></div><div class="line">                 <span class="built_in">printf</span> <span class="string">','</span></div><div class="line">         <span class="keyword">fi</span></div><div class="line"><span class="keyword">done</span></div><div class="line"><span class="built_in">printf</span>  <span class="string">"\n\t]\n"</span></div><div class="line"><span class="built_in">printf</span> <span class="string">"&#125;\n"</span></div><div class="line">[root@localhost scripts]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#执行结果</span></div><div class="line">[root@localhost scripts]<span class="comment"># sh disk_scan.sh </span></div><div class="line">&#123;</div><div class="line">	<span class="string">"data"</span>:[</div><div class="line">		&#123;<span class="string">"&#123;#DISKNAME&#125;"</span>:<span class="string">"vda"</span>&#125;,</div><div class="line">		&#123;<span class="string">"&#123;#DISKNAME&#125;"</span>:<span class="string">"vdb"</span>&#125;,</div><div class="line">		&#123;<span class="string">"&#123;#DISKNAME&#125;"</span>:<span class="string">"vdc"</span>&#125;</div><div class="line">	]</div><div class="line">&#125;</div><div class="line">[root@localhost scripts]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#获取磁盘性能参数</span></div><div class="line">[root@localhost scripts]<span class="comment"># cat disk_status.sh </span></div><div class="line"><span class="comment">#/bin/sh</span></div><div class="line">device=<span class="variable">$1</span></div><div class="line">item=<span class="variable">$2</span></div><div class="line"><span class="keyword">case</span> <span class="variable">$item</span> <span class="keyword">in</span></div><div class="line">          rps)</div><div class="line">            iostat -dxkt |grep <span class="string">"\b<span class="variable">$device</span>\b"</span>|tail -1|awk <span class="string">'&#123;print $4&#125;'</span></div><div class="line">            ;;</div><div class="line">          wps)</div><div class="line">            iostat -dxkt |grep <span class="string">"\b<span class="variable">$device</span>\b"</span> |tail -1|awk <span class="string">'&#123;print $5&#125;'</span></div><div class="line">            ;;</div><div class="line">         util)</div><div class="line">            iostat -dxkt |grep <span class="string">"\b<span class="variable">$device</span>\b"</span> |tail -1|awk <span class="string">'&#123;print $NF&#125;'</span></div><div class="line">	    ;;</div><div class="line">         idle)</div><div class="line">            iostat -x | grep -iA1 <span class="string">"\b<span class="variable">$device</span>\b"</span> | tail -1 | awk <span class="string">'&#123;print $NF&#125;'</span></div><div class="line">	    ;;</div><div class="line">         iowait)</div><div class="line">	   iostat -x | grep -iA1 <span class="string">"\b<span class="variable">$device</span>\b"</span> | tail -1 | awk <span class="string">'&#123;print $(NF-2)&#125;'</span></div><div class="line">	   ;;</div><div class="line"><span class="keyword">esac</span></div><div class="line">[root@localhost scripts]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#执行结果</span></div><div class="line">[root@Localhost scripts]<span class="comment"># sh disk_status.sh vda idle</span></div><div class="line">31.72</div><div class="line">[root@Localhost scripts]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#配置Zabbix Agent</span></div><div class="line">[root@localhost ~]<span class="comment"># cd /etc/zabbix/zabbix_agentd.d/</span></div><div class="line">[root@localhost zabbix_agentd.d]<span class="comment"># cat userparameter_io.conf </span></div><div class="line">UserParameter=disk.scandisk[*],sh /etc/zabbix/scripts/disk_scan.sh <span class="variable">$1</span>     <span class="comment">#扫描磁盘</span></div><div class="line">UserParameter=disk.status[*],sh /etc/zabbix/scripts/disk_status.sh <span class="variable">$1</span> <span class="variable">$2</span></div><div class="line">[root@localhost zabbix_agentd.d]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment"># systemctl restart zabbix-agent</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#测试zabbix是否可以成功获取</span></div><div class="line">[root@localhost ~]<span class="comment"># zabbix_get -s localhost -k disk.scandisk </span></div><div class="line">&#123;</div><div class="line">	<span class="string">"data"</span>:[</div><div class="line">		&#123;<span class="string">"&#123;#DISKNAME&#125;"</span>:<span class="string">"vda"</span>&#125;,</div><div class="line">		&#123;<span class="string">"&#123;#DISKNAME&#125;"</span>:<span class="string">"vdb"</span>&#125;,</div><div class="line">		&#123;<span class="string">"&#123;#DISKNAME&#125;"</span>:<span class="string">"vdc"</span>&#125;</div><div class="line">	]</div><div class="line">&#125;</div><div class="line">[root@localhost ~]<span class="comment"># zabbix_get -s localhost -k disk.status[vdb,util]</span></div><div class="line">31.72</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h1 id="配置Zabbix-Monitor"><a href="#配置Zabbix-Monitor" class="headerlink" title="配置Zabbix Monitor"></a>配置Zabbix Monitor</h1><p><img src="http://note.youdao.com/yws/api/personal/file/302C8142A5E84F86A3CA4F2D9FE31FE3?method=download&amp;shareKey=a34e00f62d858c86e8e4cf27883183e0" alt="Zabbix_Monitor_IO"><br><img src="http://note.youdao.com/yws/api/personal/file/298BDD98D0C0492FBD8EA5F1282BCE06?method=download&amp;shareKey=62816d1fc6134ce646a1857d45eeccdc" alt="Zabbix_Monitor_IO"><br><img src="http://note.youdao.com/yws/api/personal/file/91F87F396B214134B726998F9DBDE87B?method=download&amp;shareKey=7daab8e18b9f4273ae6f1d1d7ba0aa31" alt="Zabbix_Monitor_IO"><br><img src="http://note.youdao.com/yws/api/personal/file/2AA561496DC94AC4A4EBF1B6686461E4?method=download&amp;shareKey=5e3ce4c0db0c7de96b9f6153cc3ac5ad" alt="Zabbix_Monitor_IO"><br><img src="http://note.youdao.com/yws/api/personal/file/5358F7E7605D4383A16DD2B1BC6F1D8F?method=download&amp;shareKey=dbdec5d3eee57a154f3aea78b9c98367" alt="Zabbix_Monitor_IO"><br><img src="http://note.youdao.com/yws/api/personal/file/0AE9A738B7004E5FBB81E2AF0B188EBC?method=download&amp;shareKey=cb829ffe4bfa9684c9749348a9dab05b" alt="Zabbix_Monitor_IO"><br><img src="http://note.youdao.com/yws/api/personal/file/2EFF3C30EAFB4711B0B38C0DC35DCE18?method=download&amp;shareKey=d4b74e913ed6aa7fb05792a31311c902" alt="Zabbix_Monitor_IO"><br><img src="http://note.youdao.com/yws/api/personal/file/A46A860CF9AB416CA31C51BBF3F467FE?method=download&amp;shareKey=81342d2dd0bf6aeab5e27ea956875c5d" alt="Zabbix_Monitor_IO"><br><img src="http://note.youdao.com/yws/api/personal/file/D275B83007C144E894341D7B84ADAAEA?method=download&amp;shareKey=77ebaa7110ee6fd36f1c706ebf3ecd68" alt="Zabbix_Monitor_IO"><br><img src="http://note.youdao.com/yws/api/personal/file/744E961FB3514A8F8C0400D122E88ACF?method=download&amp;shareKey=8f2c503341250d441cd819f14a812dcb" alt="Zabbix_Monitor_IO">  </p>
<p>附件：<br><a href="http://note.youdao.com/yws/api/personal/file/2652B89E0A614EC399A82437EA15228A?method=download&amp;shareKey=00a49f1f8fdc741f6ac8c0d970433235" target="_blank" rel="external">disk_scan.sh</a><br><a href="http://note.youdao.com/yws/api/personal/file/AEEFCB1FDF944D5B94ABEC19EE71EBBD?method=download&amp;shareKey=7d7afb028b4d7d8cd11891620c7cfbfd" target="_blank" rel="external">disk_status.sh</a><br><a href="http://note.youdao.com/yws/api/personal/file/5C67C7D476E14C12AA9778324C991364?method=download&amp;shareKey=c79d92d47d9953d3b5e4412a46ae611e" target="_blank" rel="external">userparameter_io.conf</a><br><a href="http://note.youdao.com/yws/api/personal/file/10B04508EE354B878454B52734B960DD?method=download&amp;shareKey=1d25232e6221be964f40d2c7103ed566" target="_blank" rel="external">Template IO status.xml</a>  </p>
<p>关于Zabbix其他监控指标，请参考：<a href="http://yfshare.blog.51cto.com/8611708/d-5" target="_blank" rel="external">http://yfshare.blog.51cto.com/8611708/d-5</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/08/28/Zabbix监控磁盘IO/">http://www.yfshare.vip/2017/08/28/Zabbix监控磁盘IO/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Win2008 r2 远程桌面服务授权管理器激活方法]]></title>
      <url>http://www.yfshare.vip/2017/08/24/Win2008-r2-%E8%BF%9C%E7%A8%8B%E6%A1%8C%E9%9D%A2%E6%9C%8D%E5%8A%A1%E6%8E%88%E6%9D%83%E7%AE%A1%E7%90%86%E5%99%A8%E6%BF%80%E6%B4%BB%E6%96%B9%E6%B3%95/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>Windows 2008在不安装远程桌面服务授权管理器下的情况，系统允许有120天的宽限期，在120天后，又不想购买授权的话，就需要按以下的步骤“折腾”一下<br><a id="more"></a></p>
<ol>
<li>在添加角色和功能向导里，先安装<code>远程桌面会话主机</code>，<code>远程桌面授权</code>，<code>远程协助</code>，<code>远程桌面授权工具</code>，<code>远程桌面许可诊断程序</code></li>
<li>首先进入”开始菜单–&gt;管理工具–&gt;远程桌面服务–&gt;远程桌面授权管理器”，开始激活。</li>
<li>如果是域控环境，需要把RD授权服务器和RD授权功能都加入到域，否则会显示感叹号。右键<code>RD-LIC授权服务器</code>–&gt;配置–&gt;加入到组，即可。参考：<a href="http://blog.csdn.net/liangdapo/article/details/49127859" target="_blank" rel="external">http://blog.csdn.net/liangdapo/article/details/49127859</a></li>
<li>在列表里选择已安装的授权服务器，此为的激活状态为“没有激活”，右击鼠标，选择“激活服务器”。</li>
<li>在弹出的对话框里点“下一步”，连接方法选择“Web 浏览器，点击“下一步”。</li>
<li>记住这个页面提供的产品ID（如：88888-888-8888888-88888），按照上面的提示，用浏览器打开“ <a href="https://activate.microsoft.com" target="_blank" rel="external">https://activate.microsoft.com</a> ”，这个页面是英文界面的，在左边的菜单中选择”Chinese(Simplified)”(简体中文)项，再点”GO”图标，切换为中文界面。</li>
<li>确保已选中”启用许可证服务器”，再单击“下一步”按钮。</li>
<li>填上上面记下来的产品ID，再填入自己的其他基本资料（输入必填项即可），然后再选”下一步”继续。</li>
<li>在这个页面显示了刚才输入的信息，点击“下一步”继续。</li>
<li>这个页面会显示：”已成功处理您的许可证服务器激活请求……。许可证服务器ID为：……“，需要把这个分为七段的35位数抄下来，里面包含有数字和大写的英文字母；下方会问你”是否希望立即在具有此产品ID的许可证服务器上安装客户端访问许可证？”，当然应该选择“是”。</li>
<li>在这个界面的”授权信息“中有个选择”许可证程序“的地方，天火选择的是“企业协议”，博主推荐选这个，然后点”下一步“继续。</li>
<li>这个页面需要选择”产品类型“，天火选择的是”Windows Server 2008 R2 RDS 每设备CAL或Windows Server 2008 TS 每设备CAL“，俺也推荐选这个，“数量”根据需要随便输，比如：50，在“协议号码”处需要输入已授权的协议号码，这个是关键，否则激活无法通过，天火在这里给大家提供四个：4954438、5256992、6565792、6879321，点“下一步”。</li>
<li>又是让你确认信息的页面，直接点“下一步”。</li>
<li>这里就是大家期待已久的页面了：已成功处理您的客户端访问许可证请求…….，需要记住中间新产生的七段35位数，这个就是“许可证密钥包ID”。点“结束”按钮，然后就可以关闭这个窗口了。</li>
<li>回到服务器激活向导中来，将前面产生的第一个七段35位数（许可证服务器ID）输入到输入框中（支持复制／粘贴），点“下一步”。</li>
<li>现在完成了授权向导，还需要”立即安装许可证”，在这个界面，默认是选中“立即启动许可证安装向导”的，点”下一步”继续。</li>
<li>确认一下连接方法使用的是“Web 浏览器”，然后继续点“下一步”。</li>
<li>在这个界面输入第二个七段35位数（许可证密钥包ID，也支持复制／粘贴），点“下一步”。</li>
<li>点击“完成”，恭喜你，完成激活和许可证的安装了！</li>
</ol>
<p>适用windows server 2012 r2  </p>
<p>参考：<a href="http://blog.sina.com.cn/s/blog_4152a9f501017asy.html" target="_blank" rel="external">http://blog.sina.com.cn/s/blog_4152a9f501017asy.html</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/08/24/Win2008-r2-远程桌面服务授权管理器激活方法/">http://www.yfshare.vip/2017/08/24/Win2008-r2-远程桌面服务授权管理器激活方法/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[程序启动报Illegal key size错误]]></title>
      <url>http://www.yfshare.vip/2017/08/22/%E7%A8%8B%E5%BA%8F%E5%90%AF%E5%8A%A8%E6%8A%A5Illegal-key-size%E9%94%99%E8%AF%AF/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>因业务需要，对生产应用系统进行扩容后，当启动应用(tomcat)时，其日志(catalina.out)却输出 <code>java.security.InvalidKeyException: Illegal key size</code> 这样的错误<br>开发在自测和测试在测试环境上测试时都没有遇到这个问题，而在生产上却出现了这个错误，不过生产上的这个服务器是刚部署的<br>后来就是各种查资料，原因是<code>JDK不兼容</code>，不过奇怪的是都是同样的JDK版本，刚部署的服务器却又问题，也可能是后来替换了得吧  </p>
<p>处理办法: 在官方网站下载JCE无限制权限策略文件<br>JDK7的下载地址: <a href="http://www.oracle.com/technetwork/java/javase/downloads/jce-7-download-432124.html" target="_blank" rel="external">http://www.oracle.com/technetwork/java/javase/downloads/jce-7-download-432124.html</a><br>JDK8的下载地址: <a href="http://www.oracle.com/technetwork/java/javase/downloads/jce8-download-2133166.html" target="_blank" rel="external">http://www.oracle.com/technetwork/java/javase/downloads/jce8-download-2133166.html</a><br>如果安装了JRE，将两个jar文件放到%JRE_HOME%\lib\security目录下覆盖原来的文件<br>如果安装了JDK，还要将两个jar文件也放到%JDK_HOME%\jre\lib\security目录下覆盖原来文件  </p>
<p>替换JDK<code>local_policy.jar</code>和<code>US_export_policy.jar</code>两个文件，然后重启应用即可<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># ls /usr/local/jdk/jre/lib/security/ -lrtc</span></div><div class="line">total 144</div><div class="line">-rw-r--r-- 1   10  143     0 Aug 16 22:13 trusted.libraries</div><div class="line">-rw-r--r-- 1   10  143    98 Aug 16 22:13 javaws.policy</div><div class="line">-rw-r--r-- 1   10  143  2593 Aug 16 22:13 java.policy</div><div class="line">-rw-r--r-- 1   10  143   158 Aug 16 22:13 javafx.policy</div><div class="line">-rw-r--r-- 1   10  143  4054 Aug 16 22:13 blacklist</div><div class="line">-rw-r--r-- 1   10  143 18033 Aug 16 22:13 java.security</div><div class="line">-rw-r--r-- 1   10  143 98626 Aug 16 22:13 cacerts</div><div class="line">-rw-r--r-- 1 root root  2500 Aug 17 20:54 local_policy.jar   <span class="comment">#替换这文件</span></div><div class="line">-rw-r--r-- 1 root root  2487 Aug 17 20:54 US_export_policy.jar      <span class="comment">#替换这文件</span></div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>附件：<br><a href="http://note.youdao.com/yws/api/personal/file/86096F1D533C49E983860AB8531476E0?method=download&amp;shareKey=6c993d393fc466c6f03539f61ed3d009" target="_blank" rel="external">local_policy.jar</a><br><a href="http://note.youdao.com/yws/api/personal/file/FB0E6938DEE64BA18508AAF920FD5D02?method=download&amp;shareKey=a0dd06db1ed70a2870e5ef6b847428b1" target="_blank" rel="external">US_export_policy.jar</a>  </p>
<p>参考：<a href="http://www.cnblogs.com/gdayq/p/5919252.html" target="_blank" rel="external">http://www.cnblogs.com/gdayq/p/5919252.html</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/08/22/程序启动报Illegal-key-size错误/">http://www.yfshare.vip/2017/08/22/程序启动报Illegal-key-size错误/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[部署PinPoint分布式调用链系统监控]]></title>
      <url>http://www.yfshare.vip/2017/08/14/%E9%83%A8%E7%BD%B2PinPoint%E5%88%86%E5%B8%83%E5%BC%8F%E8%B0%83%E7%94%A8%E9%93%BE%E7%B3%BB%E7%BB%9F%E7%9B%91%E6%8E%A7/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>pinpoint是开源在github上的一款APM监控工具，JAVA语言开发用于大规模分布式系统监控，对性能的影响最小(只增加约3％资源利用率，吃内存)，安装agent是无侵入式的，只需要在被测试的Tomcat中加上配置下，打下探针就可以监控整套程序了<br><a id="more"></a></p>
<table>
<thead>
<tr>
<th>IP</th>
<th>OS</th>
<th>安装项</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>172.16.10.170</td>
<td>Centos 7.3</td>
<td>pinpoint</td>
<td>pinpoint的web展示端，逻辑控制机，以及Hbase存储</td>
</tr>
<tr>
<td>172.16.10.170</td>
<td>Centos 7.3</td>
<td>pinpoint-agent</td>
<td>主要用来采集数据，发送给pinpoint处理</td>
</tr>
</tbody>
</table>
<p>官网流程图：<br><img src="http://note.youdao.com/yws/api/personal/file/AF274A18DF6A48E48F3733426578F268?method=download&amp;shareKey=74c9e88948e27c53f62235a2ec00a592" alt="PinPoint">  </p>
<p>环境：<br>　　　Centos 7.3<br>　　　pinpoint 1.6.2<br>　　　hbase 1.2.5  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@localhost software]<span class="comment"># tar -zxf ../apache-tomcat-7.0.79.tar.gz -C /data/pinpoint/</span></div><div class="line">[root@localhost software]<span class="comment"># cd /data/pinpoint/</span></div><div class="line">[root@localhost pinpoint]<span class="comment"># mv apache-tomcat-7.0.79/ pinpoint-collector</span></div><div class="line">[root@localhost pinpoint]<span class="comment"># cp -a pinpoint-collector/ pinpoint-web</span></div><div class="line">[root@localhost software]<span class="comment"># tar -zxf hbase-1.2.5-bin.tar.gz -C /data/pinpoint/</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#配置环境变量</span></div><div class="line">[root@localhost ~]<span class="comment"># cat /etc/profile.d/java.sh </span></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">JAVA_HOME=/usr/<span class="built_in">local</span>/jdk1.7</div><div class="line">HBASE_HOME=<span class="string">'/data/pinpoint/hbase-1.2.5'</span></div><div class="line">PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$HBASE_HOME</span>/bin:<span class="variable">$PATH</span></div><div class="line"><span class="built_in">export</span> PATH</div><div class="line">[root@localhost ~]<span class="comment"># source /etc/profile.d/java.sh</span></div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment"># cd $HBASE_HOME/conf</span></div><div class="line">[root@localhost conf]<span class="comment"># grep -i 'export JAVA_HOME' hbase-env.sh</span></div><div class="line"><span class="comment">#手动指定正确的java环境变量值</span></div><div class="line"><span class="built_in">export</span> JAVA_HOME=/usr/<span class="built_in">local</span>/jdk1.7</div><div class="line">[root@localhost conf]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">[root@localhost pinpoint]<span class="comment"># unzip /opt/tools/software/pinpoint-collector-1.6.1.war -d pinpoint-collector/webapps/ROOT/</span></div><div class="line">[root@localhost pinpoint]<span class="comment"># unzip /opt/tools/software/pinpoint-web-1.6.1.war -d pinpoint-web/webapps/ROOT/</span></div><div class="line">[root@localhost pinpoint]<span class="comment"># </span></div><div class="line"></div><div class="line"><span class="comment">#安装数据采集Agent</span></div><div class="line">[root@localhost pinpoint]<span class="comment"># mkdir pinpoint-agent</span></div><div class="line">[root@localhost pinpoint]<span class="comment"># tar -zxf /opt/tools/software/pinpoint-agent-1.6.1.tar.gz -C ./pinpoint-agent/</span></div><div class="line">[root@localhost ~]<span class="comment"># grep -i 'PINPOINT_AGENT' /etc/profile.d/java.sh </span></div><div class="line">PINPOINT_AGENT=<span class="string">'/data/pinpoint/pinpoint-agent'</span></div><div class="line">PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$HBASE_HOME</span>/bin:<span class="variable">$PINPOINT_AGENT</span>:<span class="variable">$PATH</span></div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line">[root@localhost ~]<span class="comment"># cd $PINPOINT_AGENT</span></div><div class="line">[root@localhost pinpoint-agent]<span class="comment"># grep -i '^profiler.collector.ip' pinpoint.config </span></div><div class="line">profiler.collector.ip=172.16.10.170</div><div class="line">[root@localhost pinpoint-agent]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#start.sh里面写绝对路径，不要使用变量</span></div><div class="line"><span class="comment"># $&#123;AGENT_ID&#125;:必须要唯一，推荐使用应用名称+本机ip，如：172.16.1.170.risk</span></div><div class="line"><span class="comment"># $&#123;APPLICATION_NAME&#125;:应用名称，如：soros-service-risk</span></div><div class="line"></div><div class="line"><span class="comment">#dubbo pinpoint配置</span></div><div class="line">[root@localhost project]<span class="comment"># grep -i 'POINPOINT' soros-service-risk/bin/start.sh </span></div><div class="line">POINPOINT=<span class="string">"-javaagent:/data/pinpoint/pinpoint-agent/pinpoint-bootstrap-1.6.1.jar -Dpinpoint.agentId=172.16.1.170.risk -Dpinpoint.applicationName=soros-service-risk"</span></div><div class="line">nohup java <span class="variable">$JAVA_OPTS</span> <span class="variable">$JAVA_MEM_OPTS</span> <span class="variable">$JAVA_DEBUG_OPTS</span> <span class="variable">$JAVA_JMX_OPTS</span> <span class="variable">$POINPOINT</span> -classpath <span class="variable">$CONF_DIR</span>:<span class="variable">$LIB_JARS</span> com.alibaba.dubbo.container.Main &gt; <span class="variable">$STDOUT_FILE</span> 2&gt;&amp;1 &amp;</div><div class="line">[root@localhost project]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#tomcat pinpoint配置</span></div><div class="line">[jusys@localhost bin]$ <span class="built_in">pwd</span></div><div class="line">/data/soft/julend/tomcat1/bin</div><div class="line">[jusys@localhost bin]$ grep -iA2 <span class="string">"Xms1g"</span> catalina.sh </div><div class="line">JAVA_OPTS=<span class="string">'-server -Xms1g -Xmx2g -XX:+UseConcMarkSweepGC -XX:+CMSIncrementalMode -XX:NewSize=512m -XX:MaxPermSize=256m -Dorg.apache.catalina.startup.EXIT_ON_INIT_FAILURE=tr</span></div><div class="line">ue'</div><div class="line">CATALINA_OPTS=<span class="string">"-javaagent:/usr/local/pinpoint-agent/pinpoint-bootstrap-1.6.1-RC2.jar -Dpinpoint.agentId=10.10.2.101.webserver -Dpinpoint.applicationName=soros-webserver"</span></div><div class="line">[jusys@localhost bin]$</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">[root@localhost pinpoint]<span class="comment"># cd hbase-1.2.5/conf/</span></div><div class="line">[root@localhost conf]<span class="comment"># grep -iv ^$ hbase-site.xml | grep -iv '*'</span></div><div class="line"><span class="comment">#在hbase-site.xml下面加如下配置</span></div><div class="line">&lt;configuration&gt;</div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;hbase.zookeeper.property.clientPort&lt;/name&gt;</div><div class="line">    &lt;value&gt;2181&lt;/value&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;hbase.zookeeper.property.dataDir&lt;/name&gt;</div><div class="line">    &lt;value&gt;/data/pinpoint/data/hbase-<span class="variable">$&#123;user.name&#125;</span>/zookeeper&lt;/value&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;hbase.rootdir&lt;/name&gt;</div><div class="line">    &lt;value&gt;/data/pinpoint/data/hbase-<span class="variable">$&#123;user.name&#125;</span>/hbase&lt;/value&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;hbase.tmp.dir&lt;/name&gt;</div><div class="line">    &lt;value&gt;/data/pinpoint/data/hbase-<span class="variable">$&#123;user.name&#125;</span>&lt;/value&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;hbase.local.dir&lt;/name&gt;</div><div class="line">    &lt;value&gt;/data/pinpoint/data/hbase-<span class="variable">$&#123;user.name&#125;</span>/<span class="built_in">local</span>/&lt;/value&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">&lt;/configuration&gt;</div><div class="line">[root@localhost conf]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#修改Hbase PID文件位置</span></div><div class="line">[root@localhost conf]<span class="comment"># grep -iB1 'HBASE_PID_DIR' hbase-env.sh </span></div><div class="line"><span class="comment"># The directory where pid files are stored. /tmp by default.</span></div><div class="line"><span class="built_in">export</span> HBASE_PID_DIR=/data/pinpoint/data</div><div class="line">[root@localhost conf]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#必须要用普通用户启动，hbase用普通用户导入初始化数据</span></div><div class="line"><span class="comment">#hbase/pinpoint-collector/pinpoint-web需要部署到同一台服务器上</span></div><div class="line">[root@localhost pinpoint]<span class="comment"># chown jusys:jusys hbase-1.2.5/ pinpoint-agent/ pinpoint-collector/ pinpoint-web/ -R</span></div><div class="line"></div><div class="line">[jusys@localhost pinpoint]$ sh hbase-1.2.5/bin/start-hbase.sh</div><div class="line">[jusys@localhost ~]$ <span class="built_in">cd</span> /data/pinpoint/hbase-1.2.5/bin/</div><div class="line"><span class="comment">#初始化数据表</span></div><div class="line">[jusys@localhost bin]$ hbase shell &lt; /opt/tools/software/hbase-create.hbase    <span class="comment">#hbase用普通用户导入初始化数据</span></div><div class="line">2017-08-14 14:52:47,175 WARN  [main] util.NativeCodeLoader: Unable to load native-hadoop library <span class="keyword">for</span> your platform... using <span class="built_in">builtin</span>-java classes <span class="built_in">where</span> applicable</div><div class="line">HBase Shell; enter <span class="string">'help&lt;RETURN&gt;'</span> <span class="keyword">for</span> list of supported commands.</div><div class="line">Type <span class="string">"exit&lt;RETURN&gt;"</span> to leave the HBase Shell</div><div class="line">Version 1.2.5, rd7b05f79dee10e0ada614765bb354b93d615a157, Wed Mar  1 00:34:48 CST 2017</div><div class="line">create <span class="string">'AgentInfo'</span>, &#123; NAME =&gt; <span class="string">'Info'</span>, TTL =&gt; 31536000, DATA_BLOCK_ENCODING =&gt; <span class="string">'PREFIX'</span> &#125;</div><div class="line">0 row(s) <span class="keyword">in</span> 1.4230 seconds</div><div class="line">Hbase::Table - AgentInfo</div><div class="line">...</div><div class="line">list</div><div class="line">TABLE                                                                                                                                                            </div><div class="line">AgentEvent</div><div class="line">AgentInfo</div><div class="line">AgentLifeCycle</div><div class="line">AgentStat</div><div class="line">AgentStatV2</div><div class="line">ApiMetaData</div><div class="line">ApplicationIndex</div><div class="line">ApplicationMapStatisticsCallee_Ver2</div><div class="line">ApplicationMapStatisticsCaller_Ver2</div><div class="line">ApplicationMapStatisticsSelf_Ver2</div><div class="line">ApplicationTraceIndex</div><div class="line">HostApplicationMap_Ver2</div><div class="line">SqlMetaData_Ver2</div><div class="line">StringMetaData</div><div class="line">TraceV2</div><div class="line">Traces</div><div class="line">16 row(s) <span class="keyword">in</span> 0.0190 seconds</div><div class="line">[<span class="string">"AgentEvent"</span>, <span class="string">"AgentInfo"</span>, <span class="string">"AgentLifeCycle"</span>, <span class="string">"AgentStat"</span>, <span class="string">"AgentStatV2"</span>, <span class="string">"ApiMetaData"</span>, <span class="string">"ApplicationIndex"</span>, <span class="string">"ApplicationMapStatisticsCallee_Ver2"</span>, <span class="string">"ApplicationMapStatistic</span></div><div class="line">sCaller_Ver2", <span class="string">"ApplicationMapStatisticsSelf_Ver2"</span>, <span class="string">"ApplicationTraceIndex"</span>, <span class="string">"HostApplicationMap_Ver2"</span>, <span class="string">"SqlMetaData_Ver2"</span>, <span class="string">"StringMetaData"</span>, <span class="string">"TraceV2"</span>, <span class="string">"Traces"</span>]</div><div class="line"><span class="built_in">exit</span></div><div class="line">[jusys@localhost pinpoint]$ sh pinpoint-collector/bin/startup.sh</div><div class="line">[jusys@localhost pinpoint]$ sh pinpoint-web/bin/startup.sh</div></pre></td></tr></table></figure>
<p>如果pinpoint-agent日志输出这个，只能重新部署了，hbase初始化数据，启动pinpoint-collector和pinpoint-web<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">2017-08-14 16:57:07 [INFO ](.p.r.c.DefaultPinpointClientHandler) DefaultPinpointClientHandler@18f5940a initReconnect() completed.</div><div class="line">2017-08-14 16:57:07 [INFO ](.p.r.c.DefaultPinpointClientHandler) DefaultPinpointClientHandler@18f5940a channelClosed() started.</div><div class="line">2017-08-14 16:57:07 [INFO ](.p.r.c.DefaultPinpointClientHandler) DefaultPinpointClientHandler@18f5940a exceptionCaught() occurred. state:BEING_CONNECT, caused:Connection re</div><div class="line">fused: /172.16.10.172:9994.2017-08-14 16:57:07 [INFO ](.n.p.r.c.PinpointClientHandlerState) DefaultPinpointClientHandler@18f5940a stateTo() completed. Socket state change success(updateWanted:CONNECT</div><div class="line">_FAILED ,before:BEING_CONNECT ,current:CONNECT_FAILED).2017-08-14 16:57:07 [INFO ](c.n.p.r.c.PinpointClientHandshaker ) PinpointClientHandshaker@15bf565b handshakeAbort() started.</div><div class="line">2017-08-14 16:57:07 [INFO ](c.n.p.r.c.PinpointClientHandshaker ) PinpointClientHandshaker@15bf565b unexpected state</div></pre></td></tr></table></figure></p>
<p>如果出现这个，可能是PinPoint安装包(.war)损坏，去git上重新下载安装即可<br><img src="http://note.youdao.com/yws/api/personal/file/EFE68F542ED542C3B54051D97B9139E0?method=download&amp;shareKey=4a0c981625879ca16fee30fd3e833a83" alt="PinPoint_set"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#这个报错可以忽略，暂不影响pinpoint使用</span></div><div class="line">java.lang.NullPointerException: calleeApplicationName must not be null</div><div class="line">	at com.navercorp.pinpoint.collector.dao.hbase.HbaseMapStatisticsCallerDao.update(HbaseMapStatisticsCallerDao.java:88)</div><div class="line">	at com.navercorp.pinpoint.collector.handler.StatisticsHandler.updateCaller(StatisticsHandler.java:59)</div><div class="line">	at com.navercorp.pinpoint.collector.handler.SpanHandler.insertSpanEventStat(SpanHandler.java:183)</div><div class="line">	at com.navercorp.pinpoint.collector.handler.SpanHandler.handleSimple(SpanHandler.java:90)</div><div class="line">	at com.navercorp.pinpoint.collector.receiver.AbstractDispatchHandler.dispatchSendMessage(AbstractDispatchHandler.java:56)</div><div class="line">	at com.navercorp.pinpoint.collector.receiver.DispatchHandlerWrapper.dispatchSendMessage(DispatchHandlerWrapper.java:49)</div><div class="line">	at com.navercorp.pinpoint.collector.receiver.udp.BaseUDPHandlerFactory<span class="variable">$DispatchPacket</span>.receive(BaseUDPHandlerFactory.java:122)</div><div class="line">	at com.navercorp.pinpoint.collector.receiver.udp.BaseUDPHandlerFactory<span class="variable">$DispatchPacket</span>.receive(BaseUDPHandlerFactory.java:101)</div><div class="line">	at com.navercorp.pinpoint.collector.receiver.udp.PooledPacketWrap.run(PooledPacketWrap.java:51)</div><div class="line">	at com.navercorp.pinpoint.collector.receiver.udp.UDPReceiver<span class="variable">$1</span>.run(UDPReceiver.java:186)</div><div class="line">	at com.navercorp.pinpoint.collector.monitor.MonitoredExecutorService<span class="variable">$InstrumentedRunnable</span>.run(MonitoredExecutorService.java:208)</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor<span class="variable">$Worker</span>.run(ThreadPoolExecutor.java:615)</div><div class="line">	at java.lang.Thread.run(Thread.java:745)</div></pre></td></tr></table></figure></p>
<p>Pinpoint安装成功<br><img src="http://note.youdao.com/yws/api/personal/file/02ED5B1568434A60BB850D93DB9DF561?method=download&amp;shareKey=8324115468e0836b35127c28c5584235" alt="PinPoint_set">  </p>
<p>从别的网站荡的图<br><img src="http://note.youdao.com/yws/api/personal/file/D865D91DEED54A6E996C3CC819923BDC?method=download&amp;shareKey=29141f3ab2fc94dcf7087ed1160b40a8" alt="PinPoint"><br><img src="http://note.youdao.com/yws/api/personal/file/36533B686C434E82A039BE1297F8BF97?method=download&amp;shareKey=5c8b75f5e9f1563b08b339ebd2c7a428" alt="PinPoint"><br><img src="http://note.youdao.com/yws/api/personal/file/6C2B145F62FC499E995C3B28B8F1CEED?method=download&amp;shareKey=0ce848c63ea3bf2a63f5bd208ba71382" alt="PinPoint">  </p>
<p>参考：<a href="http://www.cnblogs.com/yyhh/p/6106472.html#yy0201" target="_blank" rel="external">http://www.cnblogs.com/yyhh/p/6106472.html#yy0201</a>  </p>
<p>附件：<br><a href="http://www.oracle.com/technetwork/java/javase/downloads/jdk7-downloads-1880260.html" target="_blank" rel="external">java7官方下载</a><br><a href="https://github.com/naver/pinpoint/releases/tag/1.6.2" target="_blank" rel="external">PinPoint Git下载</a><br><a href="http://note.youdao.com/yws/api/personal/file/CB316538423E4CDC9C3D41B7EDC5BCB5?method=download&amp;shareKey=f9f1e61b112bd26abafd90e3e57c9a82" target="_blank" rel="external">hbase-1.2.5-bin.tar.gz下载</a><br><a href="http://note.youdao.com/yws/api/personal/file/F2EEA733CE464B5898B3571CE1F4BB49?method=download&amp;shareKey=f412193774511a8762f73cf6792b5f0e" target="_blank" rel="external">分布式调用链监控系统.zip</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/08/14/部署PinPoint分布式调用链系统监控/">http://www.yfshare.vip/2017/08/14/部署PinPoint分布式调用链系统监控/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[tomcat启动时SessionIdGeneratorBase.createSecureRandom耗时问题]]></title>
      <url>http://www.yfshare.vip/2017/08/11/tomcat%E5%90%AF%E5%8A%A8%E6%97%B6SessionIdGeneratorBase-createSecureRandom%E8%80%97%E6%97%B6%E9%97%AE%E9%A2%98/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>通常情况，tomcat启动只需要几秒，最近发现发现tomcat启动非常慢，要花近10分钟，而且是发生在生产环境上，这是坚决不允许的，因此亟需解决这个问题<br>目前环境是tomcat7启动非常慢，且日志无任何报错<br><a id="more"></a><br>环境：<br>　　　Centos 7.3<br>　　　java version 1.7.0_80<br>　　　tomcat version 7.0.70  </p>
<p>在tomcat的<code>catalina.out</code>日志中仅输出如下信息<br>搜索<code>catalina.out</code>日志中<code>Context: initialization completed in</code>关键字段<br><img src="http://note.youdao.com/yws/api/personal/file/07293469E0244BAEA83D0C3811B3B3F8?method=download&amp;shareKey=3a5d2f016b44bc9f7fc08fcd4598d518" alt="start_tomcatlog">  </p>
<h1 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h1><p>Tomcat 7/8都使用<code>bash org.apache.catalina.util.SessionIdGeneratorBase.createSecureRandom</code>类产生安全随机类<code>SecureRandom</code>的实例作为会话ID，花了近7分钟<br>SHA1PRNG算法是基于SHA-1算法实现且保密性较强的伪随机数生成器<br>在SHA1PRNG中，有一个种子产生器，它根据配置执行各种操作  </p>
<ol>
<li>如果<code>Java.security.egd</code>属性或<code>securerandom.source</code>属性指定的是<code>file:/dev/random</code>或<code>file:/dev/urandom</code>，那么JVM 会使用本地种子产生器<code>NativeSeedGenerator</code>，它会调用<code>super()</code>方法，即调用<code>SeedGenerator.URLSeedGenerator(/dev/random)</code>方法进行初始化</li>
<li>如果<code>java.security.egd</code>属性或<code>securerandom.source</code>属性指定的是其它已存在的URL，那么会调用<code>SeedGenerator.URLSeedGenerator(url)</code>方法进行初始化，这就是为什么我们设置值为<code>file:///dev/urandom</code>或者值为<code>file:/./dev/random</code>都会起作用的原因  </li>
</ol>
<p>在这个请问下，产生器会评估熵池(entropy pool)中的噪声数量。随机数是从熵池中进行创建的。当读操作时，<code>/dev/random</code>设备会只返回熵池中噪声的随机字节。<code>/dev/random</code>非 常适合那些需要非常高质量随机性的场景，比如一次性的支付或生成密钥的场景<br>当熵池为空时，来自<code>/dev/random</code>的读操作将被阻塞，直到熵池收集到足够的环境噪声数据。这么做的目的是成为一个密码安全的伪随机数发生器，熵池要有尽可能大的输出。对于生成高质量的加密密钥或者是需要长期保护的场景，一定要这么做  </p>
<p>环境噪声：随机数产生器会手机来自设备驱动器和其它源的环境噪声数据，并放入熵池中。产生器会评估熵池中的噪声数据的数量。当熵池为空时，这个噪声数据的收集是比较花时间的。这就意味着，Tomcat在生产环境中使用熵池时，会被阻塞较长的时间  </p>
<h1 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h1><p>有两种解决办法  </p>
<ol>
<li>在Tomcat环境中解决。可以通过配置JRE使用非阻塞的Entropy Source，在catalina.sh中加入这么一行：<code>-Djava.security.egd=file:/dev/./urandom</code>即可加入后再启动Tomcat，整个启动耗时下降到Server startup in 2912 ms （未测试）  </li>
<li>在JVM环境中解决。在<code>$JAVA_HOME/jre/lib/security/java.security</code>文件中搜索关键字<code>securerandom.source</code>并修改其值 （测试通过）  </li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">securerandom.source=file:/dev/urandom</div></pre></td></tr></table></figure>
<p>改成<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">securerandom.source=file:/dev/./urandom</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># cd $JAVA_HOME/jre/lib/security</span></div><div class="line">[root@localhost security]<span class="comment"># ll java.security</span></div><div class="line">-rw-r--r-- 1 10 143 18035 Aug 10 14:55 java.security</div><div class="line">[root@localhost security]<span class="comment"># </span></div><div class="line">[root@localhost security]<span class="comment"># sed -i '/^securerandom.source/s#file:/dev/urandom#file:/dev/./urandom#g' java.security</span></div></pre></td></tr></table></figure>
<p>然后重启tomcat即可解决，如下图<br><img src="http://note.youdao.com/yws/api/personal/file/C646F73C34114E7483F54CAFF442560F?method=download&amp;shareKey=aec0e5da87f42fe51fd8ccf5312f0e20" alt="start_tomcatlog">  </p>
<p>参考：<a href="http://www.cnblogs.com/lavezhang/p/5522112.html" target="_blank" rel="external">http://www.cnblogs.com/lavezhang/p/5522112.html</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/08/11/tomcat启动时SessionIdGeneratorBase-createSecureRandom耗时问题/">http://www.yfshare.vip/2017/08/11/tomcat启动时SessionIdGeneratorBase-createSecureRandom耗时问题/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Deploy Windows 10 with the Microsoft Deployment Toolkit (Windows 10)]]></title>
      <url>http://www.yfshare.vip/2017/08/01/Deploy-Windows-10-with-the-Microsoft-Deployment-Toolkit-Windows-10/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>Microsoft Deployment Toolkit (MDT) 提供了自动化桌面和服务器部署的统一的工具、流程和指南集合。除了减少部署时间和标准化桌面和服务器映像，MDT 还提供了更高的安全性和持续的配置管理<br>Windows ADK（Windows 评估和部署工具包） 它具有自定义大规模部署的 Windows 映像以及测试系统、添加的组件和在该系统上运行的应用程序的质量和性能所需的工具<br>WDS是windows 部署服务<br><a id="more"></a><br>环境：<br>　　　windows server 2016<br>　　　AD DC 2016<br>　　　DHCP<br>　　　DNS<br>　　　windows10 v1607  </p>
<p>工具：<br>　　　win10_v1607 for Windows ADK<br>　　　MicrosoftDeploymentToolkit_x64  </p>
<p><a href="https://developer.microsoft.com/zh-cn/windows/hardware/windows-assessment-deployment-kit" target="_blank" rel="external">官方ADK 获取地址</a><br><a href="https://technet.microsoft.com/zh-CN/windows/dn475741" target="_blank" rel="external">官方Microsoft Deployment Toolkit获取地址</a>  </p>
<p><a href="http://download.microsoft.com/download/9/A/E/9AE69DD5-BA93-44E0-864E-180F5E700AB4/adk/adksetup.exe" target="_blank" rel="external">适用于 Windows 10 版本 1607 的 Windows ADK 官方下载地址</a><br><a href="http://note.youdao.com/yws/api/personal/file/0392306BF2AB4AE399FDE15CC92CB4DF?method=download&amp;shareKey=3de5091df7000b558544a55ef3f56881" target="_blank" rel="external">win10_v1607 for windows adk本地下载</a><br><a href="https://www.microsoft.com/en-us/download/details.aspx?id=54259" target="_blank" rel="external">Microsoft Deployment Toolkit (8443)官方下载地址</a><br><a href="http://note.youdao.com/noteshare?id=3b7ce3ec8d2bf427405347720f87407f&amp;sub=8BF1453CEE854660B934FC9F84A5CC30" target="_blank" rel="external">win10_v1607 for mdt_8443本地下载</a><br>注： 8443适用于  </p>
<ul>
<li>Windows 10 1607 版（包括企业版 LTSB 和教育版）和 Windows Server 2016 的部署和升级</li>
<li>适用于 Windows 10 1607 版的 Windows ADK</li>
<li>支持与配置管理器 1606 版集成  </li>
</ul>
<p><a href="http://note.youdao.com/yws/api/personal/file/D33B3C93D002425A95ACDA27200934BE?method=download&amp;shareKey=b93d9d4d1bc7f8435d41b1d7f986d610" target="_blank" rel="external">KMSpico_setup_win10_2016激活工具</a>  </p>
<h1 id="环境部署"><a href="#环境部署" class="headerlink" title="环境部署"></a>环境部署</h1><h2 id="Install-Windows-ADK-and-MDT"><a href="#Install-Windows-ADK-and-MDT" class="headerlink" title="Install Windows ADK and MDT"></a>Install Windows ADK and MDT</h2><p><img src="http://note.youdao.com/yws/api/personal/file/C93C041556534B8FBCD4AF3DC38A3794?method=download&amp;shareKey=3153c328b199a98f06dae974a1d11eb7" alt="ADK setup"><br><img src="http://note.youdao.com/yws/api/personal/file/25D7D417EF944FF2889BCF4B0DCF7EDC?method=download&amp;shareKey=07d32f595930e9ed96f709498eaaefd1" alt="ADK setup"><br><img src="http://note.youdao.com/yws/api/personal/file/578B4C756BFD401C8A13118D75210638?method=download&amp;shareKey=36d9c27d090821b65a2d08dfa3678f2d" alt="MDT setup">  </p>
<h2 id="Install-AD-DS-DHCP-and-DNS"><a href="#Install-AD-DS-DHCP-and-DNS" class="headerlink" title="Install AD DS, DHCP and DNS"></a>Install AD DS, DHCP and DNS</h2><p>此套系统只能在域环境下进行<br>DNS用于域名解析，在推送策略时用的是域名<br>客户机在使用PXE agent时，从DHCP获取地址<br>理论和Linux PXE类似<br><img src="http://note.youdao.com/yws/api/personal/file/379DFDCD396C4ACDADEC3725526C2A7E?method=download&amp;shareKey=331277cd0140574faf9d590904049970" alt="ADDS setup">  </p>
<h1 id="配置MDT"><a href="#配置MDT" class="headerlink" title="配置MDT"></a>配置MDT</h1><h2 id="Create-MDT"><a href="#Create-MDT" class="headerlink" title="Create MDT"></a>Create MDT</h2><p>右键点击Deployment Share，选择New Deployment Share<br><img src="http://note.youdao.com/yws/api/personal/file/D365FA7AE54B46EB9803CB45C43BF62C?method=download&amp;shareKey=6f7485575bcab07864264eb286045b49" alt="MDT Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/6EFAC21FAABF41BEBF456F793977A6FB?method=download&amp;shareKey=a4c35168c78d67f08f6bbf771f6bd7c5" alt="MDT Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/C0F75DE0B39247D5B94632BA2E5D6182?method=download&amp;shareKey=76fe07008fe6f61305fb7337101863a4" alt="MDT Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/8EF9AD90AE2E4E33B9C131EA50ACD877?method=download&amp;shareKey=595237ed5a95e916e8724accd6d93a40" alt="MDT Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/C8A4D1AB220245CC9F6905432C82CA00?method=download&amp;shareKey=12b2573418d690e7d1861900dcd176f0" alt="MDT Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/A3A14244320643ACBC8C181072CC6978?method=download&amp;shareKey=2ce4d0b5885bd499475c498f17a2c4e7" alt="MDT Configuration">  </p>
<h2 id="Import-Operating-System"><a href="#Import-Operating-System" class="headerlink" title="Import Operating System"></a>Import Operating System</h2><p>右键点击Operating System，选择New Folder，用于区分多个系统，便于管理<br><img src="http://note.youdao.com/yws/api/personal/file/056AFA32A9F44959807E5712928CAF7F?method=download&amp;shareKey=a292d1e18da3eef5c0f13c0765df9a85" alt="MDT Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/E1935BB691BA4DDF8EB3E97571A6621D?method=download&amp;shareKey=5d8862605d8ac3b83f4ee246e49caa1a" alt="MDT Configuration">  </p>
<h2 id="Import-Images"><a href="#Import-Images" class="headerlink" title="Import Images"></a>Import Images</h2><p>挂载win10 v1607镜像<br><img src="http://note.youdao.com/yws/api/personal/file/6C9BD41BEBB440F88BBE7B567E16C6F6?method=download&amp;shareKey=3089b101036ad2bbd8050c5e0dead8e6" alt="MDT Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/093CB71BEBA246E8BDC583732166B6D6?method=download&amp;shareKey=4600da80ae6270c5df731f4ddac2304f" alt="MDT Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/2F3167AB0991485F9D1967B35D1D5097?method=download&amp;shareKey=850c3cfd9ab238042bdacca5d603821d" alt="MDT Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/4F61CC22F38148DEAEDF1F5A313CA124?method=download&amp;shareKey=a8fda87218a0774c66d7c7416ea10482" alt="MDT Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/9A949A93CF34435CA3EE21DA97775176?method=download&amp;shareKey=e7512d6c33e2af36438c42f0df979a34" alt="MDT Configuration"><br>导入Opearting System成功  </p>
<h2 id="Import-Application"><a href="#Import-Application" class="headerlink" title="Import Application"></a>Import Application</h2><p>设置推送软件（也可以等系统部署成功后，通过域的组策略推送软件或捕获样本机器分发，前提是被部署的客户端全部加入域），推送的软件需要特别定制<br>需要被推送的软件支持静默安装，如果不支持则需要重新定制该软件让其支持静默安装<br><a href="http://blog.csdn.net/pkbaolong/article/details/51360319" target="_blank" rel="external">Windows软件静默安装包制作方法，比较复杂，仅供参考</a>  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/9ADF999FBAC04620843EA21258DB3C20?method=download&amp;shareKey=47776a8d9a87848fe32aa9519cfc5239" alt="MDT Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/586D564D680A4C4F90086550A84A9623?method=download&amp;shareKey=af4c1a77238a93ebec0a137f16bfe5f9" alt="MDT Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/64738571D3BC48BDAE1E92365CA313B2?method=download&amp;shareKey=1688af9f49c512a1187d2dfdd34421fc" alt="MDT Configuration">  </p>
<p>挂载office2013镜像<br><img src="http://note.youdao.com/yws/api/personal/file/1E8A4B715E99430D80AF3457731F0314?method=download&amp;shareKey=70c97405e79193334c33f5d2390628ef" alt="MDT Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/3B9C980980B64298B8EC2838A1033834?method=download&amp;shareKey=c964231b7ffcebd821baed2ce7c90e0b" alt="MDT Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/86C2E50DCC164B38B49557247FBD7686?method=download&amp;shareKey=55a82934454dec21f4eefdef651617ee" alt="MDT Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/BD014DD6EB914938BBBC83055ED14BCC?method=download&amp;shareKey=565650482520ddbf8cb6ad54c1c59fcd" alt="MDT Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/EA273DF2F63D4256AEAF04D69C9C148F?method=download&amp;shareKey=2e362acb24c57a6d09a298922a25b401" alt="MDT Configuration">  </p>
<p>Application office2013导入成功<br><img src="http://note.youdao.com/yws/api/personal/file/FF1DB1C9BFB04551A120CCB7A199F3FD?method=download&amp;shareKey=db71c503d6c35876d66552957e7f4175" alt="MDT Configuration">  </p>
<p>使用MDT+WDS推送软件时，必须要软件支持静默安装，否则和手动安装软件没什么区别咯<br>静默安装 office2013<br>参考：<a href="https://technet.microsoft.com/zh-cn/library/cc179195.aspx" target="_blank" rel="external">https://technet.microsoft.com/zh-cn/library/cc179195.aspx</a><br>修改office2013的配置文件(office2013\proplusr.ww\config.xml)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;!--&lt;Display Level=<span class="string">"full"</span> CompletionNotice=<span class="string">"yes"</span> SuppressModal=<span class="string">"no"</span> AcceptEula=<span class="string">"no"</span> /&gt; --&gt;</div></pre></td></tr></table></figure></p>
<p>改成<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;Display Level=<span class="string">"basic"</span> CompletionNotice=<span class="string">"no"</span> SuppressModal=<span class="string">"no"</span> AcceptEula=<span class="string">"no"</span> /&gt;</div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/6E7C60D2FF7D4100A64B80AF28B9DD2A?method=download&amp;shareKey=9ef783e16cd9002a8a746aa4824cc199" alt="MDT Configuration"><br>参数具体属性请见<a href="https://technet.microsoft.com/zh-cn/library/cc179195.aspx" target="_blank" rel="external">官网</a><br><a href="http://note.youdao.com/yws/api/personal/file/19555AFA5E444D35A484AE35754BB827?method=download&amp;shareKey=426397b67a688a3efae4b4081f462c89" target="_blank" rel="external">config.xml配置文件</a>  </p>
<h2 id="Import-Driver"><a href="#Import-Driver" class="headerlink" title="Import Driver"></a>Import Driver</h2><p>先手动安装一台样板机用驱动精灵等软件把驱动打上，然后剥离驱动文件导入到MDT即可<br>剥离驱动需要使用到工具，我这里使用的是驱动精灵的驱动备份功能，因为现在的驱动文件均加壳了不能直接使用，而MDT只能识别驱动的原生文件，后缀为.inf文件  </p>
<p>右键Out-of-Box Drivers，选择New Folder<br><img src="http://note.youdao.com/yws/api/personal/file/2CADD7633461490BA5858CEED24D5FBB?method=download&amp;shareKey=ab87ac55b652da8dd383264def24717c" alt="MDT Configuration">  </p>
<p>剥离后的驱动程序文件<br><img src="http://note.youdao.com/yws/api/personal/file/A1439D7305944F7AAC2418E04F134C88?method=download&amp;shareKey=f3cf8027b4ce1877e3930ae1e19278b2" alt="MDT Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/7BF0674330FD44659A6FA0FEE828E0FE?method=download&amp;shareKey=71e1c750f23befa35c24285fdbd6a655" alt="MDT Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/D6F7087DA6B04BA7899728E7496CB2E3?method=download&amp;shareKey=f4fd1db7a9f063f79782d9b6cbb9359f" alt="MDT Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/349787175663483298320721C853B9F2?method=download&amp;shareKey=0e69df731e239c5259c598a90f46c9d6" alt="MDT Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/D735C9F54F8E4DCEA2028A06CCE6D310?method=download&amp;shareKey=0b30d6f7b21c471e08a96c6ee97712e5" alt="MDT Configuration"><br>驱动导入成功  </p>
<h2 id="Create-Task-Sequences"><a href="#Create-Task-Sequences" class="headerlink" title="Create Task Sequences"></a>Create Task Sequences</h2><p>右键Task Sequences，选择New Folder<br><img src="http://note.youdao.com/yws/api/personal/file/6AFFF5EC13B445CE94798ACE00812F4A?method=download&amp;shareKey=6e8a9727d5d720c29f7c5f2096584ab6" alt="MDT Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/3B02A195F2034A79A15845DD3F914BDA?method=download&amp;shareKey=20788691f22cc9588dde04c73eb72f74" alt="MDT Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/9C6CEF820FBA434893DA014C9D5493A3?method=download&amp;shareKey=5090d86c3ec26f843b05b53a545640ce" alt="MDT Configuration">  </p>
<p>新建Task Sequences前需要导入Operating Systems<br><img src="http://note.youdao.com/yws/api/personal/file/462BAA15BD20450BA472AB2144A4644F?method=download&amp;shareKey=d341a3f27ffa9f3bc6288b070be78c7c" alt="MDT Configuration">  </p>
<p>如果想使用MDT批量安装Client后自动激活，就需要在这里添加批量激活Key(OVL序列号)，这个需要购买<br><img src="http://note.youdao.com/yws/api/personal/file/D8B64A50592742918DD0BF9D34C19DAE?method=download&amp;shareKey=7c270d8e05c7290134980992853dfc07" alt="MDT Configuration">  </p>
<p>自定义Client安装完成后IE浏览器的首页地址等信息<br><img src="http://note.youdao.com/yws/api/personal/file/142A50B4CCE0406D9F731AB28814FAB9?method=download&amp;shareKey=a5d5129d3554c79645efa3aebd30dc94" alt="MDT Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/F96DE59E63BC4ED6B48C7DD8F922C58A?method=download&amp;shareKey=157ebc55040558a1c2476f332f551131" alt="MDT Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/9D4A994A7E2F429FB0FEE51459DE5CC8?method=download&amp;shareKey=10a29c55f410f12912abb0c1a0731409" alt="MDT Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/BB58B8E8AD834768A1C1C343BE350DDC?method=download&amp;shareKey=65f737fe02ff39bc30ec23e6f3f61793" alt="MDT Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/31DCD4EA895B41E18554FEB6B29523FA?method=download&amp;shareKey=cd94c1ad7d9f146567b148960e86209a" alt="MDT Configuration"><br>Task Sequences创建成功  </p>
<p>自定义Task Sequences属性<br>Task Sequences —win10_v1607 —Task Sequence  </p>
<p>自定义磁盘分区，Variable定义的变量后续在系统分区时有用到，默认为OSDisk<br><img src="http://note.youdao.com/yws/api/personal/file/C176FC7286D944B8BA695CA59F4996DB?method=download&amp;shareKey=53fa912b127fb0d961d1710b5a4ef8da" alt="MDT Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/3FB8C8A8ECD742EB8E22702EF7532C22?method=download&amp;shareKey=cc44feb807b1de93d1ff1fcb519bf9bf" alt="MDT Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/DD5FD75916C54DF4A7184E8689A7CE67?method=download&amp;shareKey=743f9ad8f5bf1e3164d117ff85fdf51b" alt="MDT Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/EE29DC3A444F48488288BCF51B0AB7C8?method=download&amp;shareKey=94190a37ab58e3cdf29dc93d1840ab8b" alt="MDT Configuration">  </p>
<p>Install — ‘Install Operating System’ —‘Select the location where you want to apply this Operating System’，在这里默认是选择的’Logical Drive Letter stored in avariable’会调用前面定义的变量OSDisk(默认值)<br><img src="http://note.youdao.com/yws/api/personal/file/2634B42822E7488BA210CC7EB9D2F602?method=download&amp;shareKey=373237c473adcb039d995470c2e812c1" alt="MDT Configuration">  </p>
<p>如果在实际安装过程中报无法找到磁盘驱动器，如下图所示<br><img src="http://note.youdao.com/yws/api/personal/file/2F085A84B5754BF18E0D68EE635B806E?method=download&amp;shareKey=48227a43c5d6add3b288a835e9107aa1" alt="MDT Configuration"><br>解决方案是修改上图的默认值为’Specific disk partition’，强制指定磁盘和分区，默认值为Disk0和partition1，意思为第一块磁盘的第一个分区即可，如下图所示<br><img src="http://note.youdao.com/yws/api/personal/file/5FFE3CC242484EFB8D10FC7251BD925C?method=download&amp;shareKey=ead49297e83996fd2ab408bde5d3c275" alt="MDT Configuration">  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/F7AF21E9217F4FDEAD1FF80A6B327E8C?method=download&amp;shareKey=894c43873a13576a43f0991eee498d3d" alt="MDT Configuration">  </p>
<p>‘Select the location where you want to apply this Operating System’有四个选项值，分别如下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Next available formatted partition</div><div class="line">Specific disk partition</div><div class="line">Logical Drive Letter stored <span class="keyword">in</span> a variable</div><div class="line">Specific Logical driver Letter</div></pre></td></tr></table></figure></p>
<h2 id="Set-MDT-attribute"><a href="#Set-MDT-attribute" class="headerlink" title="Set MDT attribute"></a>Set MDT attribute</h2><p>配置MDT属性参数<br>MDT基本配置配置完成后，需要把DeploymentShare目录共享出来且给Everyone只读权限，需要让PXEClient读取配置<br><img src="http://note.youdao.com/yws/api/personal/file/62D970E9BEA941858434686DB3906948?method=download&amp;shareKey=5eb6d7ace093d7bccfeb79b9d1101169" alt="MDT Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/75C2C97A65F242E5B3CB4B9E90A888E3?method=download&amp;shareKey=8d610a352b2fc83032bb9fd99584d52b" alt="MDT Configuration">  </p>
<p>如果在安装过程中报如下错误，就需要检查PXEClient是否能连接到DNS服务器，如上图所示<br>也有可能是因为MDT的BUG引起的,参考：<a href="http://bbs.51cto.com/thread-957212-1.html" target="_blank" rel="external">http://bbs.51cto.com/thread-957212-1.html</a><br><img src="http://note.youdao.com/yws/api/personal/file/CE44A9742B754411B5C0EB8E7837C1B8?method=download&amp;shareKey=2e99c913920ca45cf656537c9c20875f" alt="MDT Configuration">  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/3F0F5998B59A440EAAE05F82831D82FB?method=download&amp;shareKey=0e2cb377a84179b777f7ee19eade717d" alt="MDT Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/08FB25F25E4849C8A465C45431DBA43E?method=download&amp;shareKey=91e11d61d36faddd7effefe023625d11" alt="MDT Configuration">  </p>
<p>Rules<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">[Settings]</div><div class="line">Priority=Default</div><div class="line">Properties=MyCustomProperty</div><div class="line"></div><div class="line">[Default]</div><div class="line">OSInstall=YES         <span class="comment">#是否允许部署操作系统到目标计算机</span></div><div class="line">SkipAdminPassword=YES    <span class="comment">#是否跳过设置本地管理员密码</span></div><div class="line">SkipApplications=NO     <span class="comment">#是否跳过应用程序安装向导页</span></div><div class="line">SkipAppsOnUpgrade=YES</div><div class="line">SkipBDDWelcome=YES     <span class="comment">#是否跳过欢迎界面</span></div><div class="line">SkipBitLocker=YES      <span class="comment">#是否跳过Bitlocker设置</span></div><div class="line">SkipCapture=YES        <span class="comment">#是否跳过镜像捕捉，win10_v1607镜像捕获失败，暂未找到原因</span></div><div class="line">SkipComputerName=YES    <span class="comment">#是否跳过设置计算机名</span></div><div class="line">SkipComputerBackup=YES</div><div class="line">SkipDeploymentType=YES    <span class="comment">#是否跳过选择部署类型</span></div><div class="line">DeploymentType=NEWCOMPUTER</div><div class="line">SkipDomainMembership=YES</div><div class="line">;JoinDomain=yfshare.vip    <span class="comment">#是否跳过加入域或工作组，逗号为注释(捕获镜像时需要注释掉)</span></div><div class="line">;DomainAdmin=Administrator</div><div class="line">;DomainAdminDomain=yfshare.vip</div><div class="line">;DomainAdminPassword=Julend123</div><div class="line">SkipFinalSummary=YES</div><div class="line">SkipLocaleSelection=YES    <span class="comment">#是否跳过设置本地地区</span></div><div class="line">KeyboardLocale=en-US       <span class="comment">#指定键盘语言、输入法</span></div><div class="line">UserLocale=en-US</div><div class="line">UILanguage=en-US</div><div class="line">SkipPackageDisplay=YES</div><div class="line">SkipProductKey=YES        <span class="comment">#是否跳过序列号输入</span></div><div class="line">SkipSummary=YES           <span class="comment">#是否跳过摘要界面</span></div><div class="line">SkipTaskSequence=YES</div><div class="line">TaskSequenceID=001</div><div class="line">SkipTimeZone=YES          <span class="comment">#是否跳过设置时区</span></div><div class="line">TimeZoneName=Central Standard Time</div><div class="line">SkipUserData=Yes</div><div class="line">DeployRoot=\\MDT.yfshare.vip\DeploymentShare        <span class="comment">#指定文件共享目录，win7在Share后面要加$，win10不用</span></div><div class="line">FinishAction=REBOOT       <span class="comment">#指定目标计算机部署完成后的动作(关机、注销、重启)</span></div><div class="line">;OverrideProductKey=XXXX-XXXX-XXXX-XXXX  <span class="comment">#如果需要分发序列号可在此添加，批量部署需要使用win7 OVL序列号</span></div><div class="line">;ProductKey=XXXX-XXXX-XXXX-XXXX</div></pre></td></tr></table></figure></p>
<p>bootstrap.ini配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[Settings]</div><div class="line">Priority=Default</div><div class="line"></div><div class="line">[Default]</div><div class="line">DeployRoot=\\MDT.yfshare.vip\DeploymentShare</div><div class="line">UserID=administrator      <span class="comment">#刚启动安装时需要进行验证，只有验证通过了才能部署系统和调用上面的代码</span></div><div class="line">UserID=administrator</div><div class="line">UserDomain=yfshare.vip</div><div class="line">UserPassword=Julend123</div><div class="line">SkipBDDWelcome=YES</div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/DB219DC12B0247AEAAF8DDBE590F510D?method=download&amp;shareKey=0bf5164775b0b012efe2bfac497e9fce" alt="MDT Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/B6BAE4F835B7481C94C882FD60B841B6?method=download&amp;shareKey=3d3646e8dc093ea9bdf438383359978e" alt="MDT Configuration"><br>MDT配置完成  </p>
<h2 id="Generate-wim-file"><a href="#Generate-wim-file" class="headerlink" title="Generate wim file"></a>Generate wim file</h2><p>下来来生成WDS服务所需要的wim、xml、iso文件<br>选择MDT Deployment Share，右键选择Update Deployment Share，重新生成.wim、.iso、.xml的文件<br><img src="http://note.youdao.com/yws/api/personal/file/E543887224C64356A9FC4AB369B168AB?method=download&amp;shareKey=92cb0ade020049e6d1fbc4d186feaf6d" alt="MDT Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/8AECC8BF83AE4B79A91323663D4A53DE?method=download&amp;shareKey=d8f9dd766c44ca878779407e2d3c01de" alt="MDT Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/30BB5CF354A340B1B8E3E2C5D2DD7C86?method=download&amp;shareKey=25153317aba49a60b36f3cfb379a1304" alt="MDT Configuration">  </p>
<h1 id="部署WDS服务"><a href="#部署WDS服务" class="headerlink" title="部署WDS服务"></a>部署WDS服务</h1><h2 id="Install-WDS"><a href="#Install-WDS" class="headerlink" title="Install WDS"></a>Install WDS</h2><p>WDS服务提供文件服务，把生成的wim文件推送给Client<br><img src="http://note.youdao.com/yws/api/personal/file/FA55419DE8624F008DB1B7D6580040A9?method=download&amp;shareKey=8f414c1929966e12ee9a34e8c1d5dc11" alt="WDS Configuration">  </p>
<h2 id="Configuration-WDS"><a href="#Configuration-WDS" class="headerlink" title="Configuration WDS"></a>Configuration WDS</h2><p><img src="http://note.youdao.com/yws/api/personal/file/6FE7D6823D804513A21A88C273C4B2AB?method=download&amp;shareKey=e4fa56d90d5e23596939b63dcdd917a7" alt="WDS Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/9EA38307160542B5BEF5BB6569F607F5?method=download&amp;shareKey=88f1ccd939b5720e77e765e88abeaa5f" alt="WDS Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/AC344F6C88944B66AF58C1FD0B3FE542?method=download&amp;shareKey=6ba6442ea2a2cf08c9fde1f3cdc2cf55" alt="WDS Configuration">  </p>
<p>此环境需要DHCP与WDS服务在同一台机器上<br><img src="http://note.youdao.com/yws/api/personal/file/34AF32C8A14348DE940D35C3497A72A1?method=download&amp;shareKey=6214edfb6a0e798f315d2be2cab6191a" alt="WDS Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/2F00DFEF87614856B4CBB84A106BB8F5?method=download&amp;shareKey=1b9054e1293e292ed7846ede570af727" alt="WDS Configuration">  </p>
<h2 id="Import-wim-Image"><a href="#Import-wim-Image" class="headerlink" title="Import wim Image"></a>Import wim Image</h2><p>现在导入由MDT生成的wim系统镜像文件<br><img src="http://note.youdao.com/yws/api/personal/file/805F1901B5884ECBA5A92D36BB3CD1D8?method=download&amp;shareKey=8d55ce1af6c8be239dfb3a172220d570" alt="WDS Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/0AE5AAC8871E4E8A8CFE65BCC9B3A999?method=download&amp;shareKey=0d740674c6f1075ed8647737120b6199" alt="WDS Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/F617D333BD2D4D5CB4231A578E96C93C?method=download&amp;shareKey=7be33457ae4737ecc090c353a398b93d" alt="WDS Configuration"><br><img src="http://note.youdao.com/yws/api/personal/file/63C30F5AD90B4367A71589A8852A86D0?method=download&amp;shareKey=e400a88ea4a2b59a0502e3233413906c" alt="WDS Configuration"><br>导入wim镜像成功  </p>
<h1 id="Install-Operating-System"><a href="#Install-Operating-System" class="headerlink" title="Install Operating System"></a>Install Operating System</h1><h2 id="Start-Installation"><a href="#Start-Installation" class="headerlink" title="Start Installation"></a>Start Installation</h2><p>按F12启用WDS+MDT服务安装系统<br><img src="http://note.youdao.com/yws/api/personal/file/388D3EBC709E4E7F945B8BD88B0ED0C5?method=download&amp;shareKey=f13ca059acf1d8820d190b2215a9d717" alt="Install Operating System"><br><img src="http://note.youdao.com/yws/api/personal/file/DC11FEE019BA402CB319AADBA7C61DAA?method=download&amp;shareKey=c5d5a18a2b0086aea244f670b8ae7935" alt="Install Operating System">  </p>
<h2 id="Install-Software"><a href="#Install-Software" class="headerlink" title="Install Software"></a>Install Software</h2><p>选择安装Office2013，在MDT的Application中配置<br>这一步无法跳过，必须手动选中安装，如在Rules中设置’SkipApplications=YES’跳过此步，系统安装完成后将不会安装此推送软件<br><img src="http://note.youdao.com/yws/api/personal/file/A42B6FB54DD64264B9E44C7163721634?method=download&amp;shareKey=eb4c504768a5f369ec94215af97d6f5f" alt="Install Operating System">  </p>
<h2 id="Format-the-disk"><a href="#Format-the-disk" class="headerlink" title="Format the disk"></a>Format the disk</h2><p>格式化磁盘，调用’Task Sequence’中’Format and Partition Disk’任务<br><img src="http://note.youdao.com/yws/api/personal/file/5D9D61E4107D45A2BFCBAF6BB100FEA3?method=download&amp;shareKey=dd82e8f6c8022fba1bf3b5c17fb5ae03" alt="Install Operating System">  </p>
<h2 id="Installing-operating-system"><a href="#Installing-operating-system" class="headerlink" title="Installing operating system"></a>Installing operating system</h2><p><img src="http://note.youdao.com/yws/api/personal/file/56DB9D6386B74CECA2E834F172DA600E?method=download&amp;shareKey=a2d6f98370cb09a2ffd2f5a39c92382f" alt="Install Operating System">  </p>
<p>系统安装完成后开始自动安装推送的Office2013，期间会重启<br><img src="http://note.youdao.com/yws/api/personal/file/936A369046374625BD7AE54A25656AF5?method=download&amp;shareKey=879c4186cd9c492e3b826aa9d10bce92" alt="Install Operating System">  </p>
<p>系统安装完成，同时Office2013也安装完成<br><img src="http://note.youdao.com/yws/api/personal/file/E606B8745C17488FA8EB7524D42E014C?method=download&amp;shareKey=44096641591e72bcc0de4b4deff61aeb" alt="Install Operating System">  </p>
<p>这样安装完成后，除非使用了OVL批量安装的密钥，否则不能成功激活系统，在安装过程中会调用Sysprep初始化系统<br><img src="http://note.youdao.com/yws/api/personal/file/16373EF6199942AE877F7CF70F0484C0?method=download&amp;shareKey=680ca47d6852c2d2ebdcbaf3f4ff7ac0" alt="Install Operating System"><br>MDT+WDS系统安装完成  </p>
<h1 id="实体机安装"><a href="#实体机安装" class="headerlink" title="实体机安装"></a>实体机安装</h1><p>以下是在应用到实体机时拍的照片<br>使用PXE Agent引导<br><img src="http://note.youdao.com/yws/api/personal/file/67BD192B95B2448EA2655418F1C8BD91?method=download&amp;shareKey=0cb290173efceeb0d59f81aa26bc4018" alt="Install Operating System"><br><img src="http://note.youdao.com/yws/api/personal/file/169938D8DDFB4B6C962DE897D1B55F89?method=download&amp;shareKey=85a5a273ef0a7de5980c44a8c0667c3b" alt="Install Operating System"><br><img src="http://note.youdao.com/yws/api/personal/file/2C3F57677C5449DB85416045E37598EA?method=download&amp;shareKey=ceb0b7242a97c702b040426bd6ddda1b" alt="Install Operating System"><br><img src="http://note.youdao.com/yws/api/personal/file/123EE233F772434794D1B614BC4B5E52?method=download&amp;shareKey=9e20f29e404949b5e626af989738204b" alt="Install Operating System">  </p>
<p>安装网卡驱动<br><img src="http://note.youdao.com/yws/api/personal/file/20D60D445B8C4760BE2A3A623C0F2F49?method=download&amp;shareKey=d8f683b1519e404fd6507c1152e34350" alt="Install Operating System"><br><img src="http://note.youdao.com/yws/api/personal/file/04AE3D47564745769DB543B9E31E4E69?method=download&amp;shareKey=8b6e9cfe032205bfbf8ec2eca48a16f0" alt="Install Operating System"><br><img src="http://note.youdao.com/yws/api/personal/file/E2E7A7AFB60843A6B66FD9005051EDBA?method=download&amp;shareKey=4cb259251efb4f2ca7bce14bdbb03666" alt="Install Operating System"><br><img src="http://note.youdao.com/yws/api/personal/file/BF5633F2CD6B482F8CE35626B6C0912D?method=download&amp;shareKey=ea8a843a0c16ca8004c20f116bfa3336" alt="Install Operating System"><br>系统、Office2013、驱动程序安装完成  </p>
<p>注：用实体机测试Capture Image不成功，执行Lite Touch.vbs脚本后，被镜像的机器重启后正常进入系统，但是在MDT服务器上无任何反应  </p>
<p>附件：<br><a href="http://pan.baidu.com/s/1nvG82wT" target="_blank" rel="external">工具合集，内含部署工具软件，VM，密码：3kfk</a>  </p>
<p>参考文档：<br><a href="https://docs.microsoft.com/en-us/windows/deployment/deploy-windows-mdt/deploy-windows-10-with-the-microsoft-deployment-toolkit" target="_blank" rel="external">https://docs.microsoft.com/en-us/windows/deployment/deploy-windows-mdt/deploy-windows-10-with-the-microsoft-deployment-toolkit</a><br><a href="https://social.technet.microsoft.com/Forums/zh-CN/6ff7914b-3bb2-41b2-a715-e0e11a8aee56/mdt-2012-failure-5456-unable-to-determine-destination-disk?forum=mdt" target="_blank" rel="external">https://social.technet.microsoft.com/Forums/zh-CN/6ff7914b-3bb2-41b2-a715-e0e11a8aee56/mdt-2012-failure-5456-unable-to-determine-destination-disk?forum=mdt</a><br><a href="https://technet.microsoft.com/en-us/library/dn744270(v=ws.11).aspx" target="_blank" rel="external">https://technet.microsoft.com/en-us/library/dn744270(v=ws.11).aspx</a><br><a href="https://docs.microsoft.com/en-us/windows/deployment/deploy-windows-mdt/deploy-a-windows-10-image-using-mdt" target="_blank" rel="external">https://docs.microsoft.com/en-us/windows/deployment/deploy-windows-mdt/deploy-a-windows-10-image-using-mdt</a><br><a href="https://www.petri.com/deploy-windows-10-using-mdt-wds-part-1-create-mdt-deployment-share" target="_blank" rel="external">https://www.petri.com/deploy-windows-10-using-mdt-wds-part-1-create-mdt-deployment-share</a><br><a href="https://www.youtube.com/watch?v=N02hpaRgMYQ" target="_blank" rel="external">https://www.youtube.com/watch?v=N02hpaRgMYQ</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/08/01/Deploy-Windows-10-with-the-Microsoft-Deployment-Toolkit-Windows-10/">http://www.yfshare.vip/2017/08/01/Deploy-Windows-10-with-the-Microsoft-Deployment-Toolkit-Windows-10/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[怎么在Linux划分大磁盘分区]]></title>
      <url>http://www.yfshare.vip/2017/07/15/%E6%80%8E%E4%B9%88%E5%9C%A8Linux%E5%88%92%E5%88%86%E5%A4%A7%E7%A3%81%E7%9B%98%E5%88%86%E5%8C%BA/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>前几天收到需求，在阿里云上购买5台服务器，配置为32G,8核,3T<br>问题主要是卡在这里，阿里云的公共镜像里 Centos 7.3 默认为 EXT4 文件系统，和官方的不同，官网默认文件系统为 XFS 。而 EXT4 文件系统默认最大只支持最大分区为2TB，这里有3TB，如果用 EXT4 文件系统，就表示剩余的1TB空间会被浪费…  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@bigdata1 ~]<span class="comment"># fdisk -l /dev/vdb </span></div><div class="line"></div><div class="line">Disk /dev/vdb: 3298.5 GB, 3298534883328 bytes, 6442450944 sectors</div><div class="line">Units = sectors of 1 * 512 = 512 bytes</div><div class="line">Sector size (logical/physical): 512 bytes / 512 bytes</div><div class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</div><div class="line"></div><div class="line">[root@bigdata1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>这时默认的fdisk分区工具将无法使用了，因为它不能满足我们的需求，这里就需要用到 parted 分区工具了<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#分区命令</span></div><div class="line">parted /dev/vdb</div><div class="line">mklabel</div><div class="line">gpt</div><div class="line">mkpart</div><div class="line"></div><div class="line">xfs</div><div class="line">0G</div><div class="line">3299GB</div><div class="line">p</div><div class="line">quit</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line">[root@bigdata1 ~]<span class="comment"># parted /dev/vdb </span></div><div class="line">GNU Parted 3.1</div><div class="line">Using /dev/vdb</div><div class="line">Welcome to GNU Parted! Type <span class="string">'help'</span> to view a list of commands.</div><div class="line">(parted) p                                                                </div><div class="line">Error: /dev/vdb: unrecognised disk label</div><div class="line">Model: Virtio Block Device (virtblk)                                      </div><div class="line">Disk /dev/vdb: 3299GB</div><div class="line">Sector size (logical/physical): 512B/512B</div><div class="line">Partition Table: unknown</div><div class="line">Disk Flags: </div><div class="line">(parted) <span class="built_in">help</span>                                                             </div><div class="line">  align-check TYPE N                        check partition N <span class="keyword">for</span> TYPE(min|opt) alignment</div><div class="line">  <span class="built_in">help</span> [COMMAND]                           <span class="built_in">print</span> general <span class="built_in">help</span>, or <span class="built_in">help</span> on COMMAND</div><div class="line">  mklabel,mktable LABEL-TYPE               create a new disklabel (partition table)</div><div class="line">  mkpart PART-TYPE [FS-TYPE] START END     make a partition</div><div class="line">  name NUMBER NAME                         name partition NUMBER as NAME</div><div class="line">  <span class="built_in">print</span> [devices|free|list,all|NUMBER]     display the partition table, available devices, free space, all found</div><div class="line">        partitions, or a particular partition</div><div class="line">  quit                                     <span class="built_in">exit</span> program</div><div class="line">  rescue START END                         rescue a lost partition near START and END</div><div class="line">  rm NUMBER                                delete partition NUMBER</div><div class="line">  select DEVICE                            choose the device to edit</div><div class="line">  disk_set FLAG STATE                      change the FLAG on selected device</div><div class="line">  disk_toggle [FLAG]                       toggle the state of FLAG on selected device</div><div class="line">  <span class="built_in">set</span> NUMBER FLAG STATE                    change the FLAG on partition NUMBER</div><div class="line">  toggle [NUMBER [FLAG]]                   toggle the state of FLAG on partition NUMBER</div><div class="line">  unit UNIT                                <span class="built_in">set</span> the default unit to UNIT</div><div class="line">  version                                  display the version number and copyright information of GNU Parted</div><div class="line">(parted) mklabel                                                          </div><div class="line">New disk label <span class="built_in">type</span>? gpt                                                  </div><div class="line">(parted) p                                                                </div><div class="line">Model: Virtio Block Device (virtblk)</div><div class="line">Disk /dev/vdb: 3299GB</div><div class="line">Sector size (logical/physical): 512B/512B</div><div class="line">Partition Table: gpt</div><div class="line">Disk Flags: </div><div class="line"></div><div class="line">Number  Start  End  Size  File system  Name  Flags</div><div class="line"></div><div class="line">(parted) mkpart                                                           </div><div class="line">Partition name?  []? ?                                                    </div><div class="line">File system <span class="built_in">type</span>?  [ext2]? xfs</div><div class="line">Start? 0G                                                                 </div><div class="line">End? 3299GB                                                               </div><div class="line">(parted) p                                                                </div><div class="line">Model: Virtio Block Device (virtblk)</div><div class="line">Disk /dev/vdb: 3299GB</div><div class="line">Sector size (logical/physical): 512B/512B</div><div class="line">Partition Table: gpt</div><div class="line">Disk Flags: </div><div class="line"></div><div class="line">Number  Start   End     Size    File system  Name  Flags</div><div class="line"> 1      1049kB  3299GB  3299GB               ?</div><div class="line"></div><div class="line">(parted) quit                                                             </div><div class="line">Information: You may need to update /etc/fstab.</div><div class="line"></div><div class="line">[root@bigdata1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>然后格式化为 xfs 文件系统后挂载<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">[root@bigdata1 ~]<span class="comment"># mkfs.xfs /dev/vdb1 </span></div><div class="line">meta-data=/dev/vdb1              isize=512    agcount=4, agsize=201326464 blks</div><div class="line">         =                       sectsz=512   attr=2, projid32bit=1</div><div class="line">         =                       crc=1        finobt=0, sparse=0</div><div class="line">data     =                       bsize=4096   blocks=805305856, imaxpct=5</div><div class="line">         =                       sunit=0      swidth=0 blks</div><div class="line">naming   =version 2              bsize=4096   ascii-ci=0 ftype=1</div><div class="line"><span class="built_in">log</span>      =internal <span class="built_in">log</span>           bsize=4096   blocks=393215, version=2</div><div class="line">         =                       sectsz=512   sunit=0 blks, lazy-count=1</div><div class="line">realtime =none                   extsz=4096   blocks=0, rtextents=0</div><div class="line">[root@bigdata1 ~]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@bigdata1 ~]<span class="comment"># blkid /dev/vdb1</span></div><div class="line">/dev/vdb1: UUID=<span class="string">"32687403-bcc8-425f-8544-ddf710186d53"</span> TYPE=<span class="string">"xfs"</span> PARTLABEL=<span class="string">"?"</span> PARTUUID=<span class="string">"580a257e-18e2-4d57-99cf-b5be5b6</span></div><div class="line">9557a" [root@bigdata1 ~]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@bigdata1 ~]<span class="comment"># mkdir /data</span></div><div class="line">[root@bigdata1 ~]<span class="comment"># tail -1 /etc/fstab </span></div><div class="line">UUID=<span class="string">"32687403-bcc8-425f-8544-ddf710186d53"</span>	/data		xfs	defaults	0 0</div><div class="line">[root@bigdata1 ~]<span class="comment"># mount -a</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">[root@bigdata1 ~]<span class="comment"># fdisk -l /dev/vdb</span></div><div class="line">WARNING: fdisk GPT support is currently new, and therefore <span class="keyword">in</span> an experimental phase. Use at your own discretion.</div><div class="line"></div><div class="line">Disk /dev/vdb: 3298.5 GB, 3298534883328 bytes, 6442450944 sectors</div><div class="line">Units = sectors of 1 * 512 = 512 bytes</div><div class="line">Sector size (logical/physical): 512 bytes / 512 bytes</div><div class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</div><div class="line">Disk label <span class="built_in">type</span>: gpt</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#         Start          End    Size  Type            Name</span></div><div class="line"> 1         2048   6442448895      3T  Microsoft basic ?</div><div class="line">[root@bigdata1 ~]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@bigdata1 ~]<span class="comment"># df -T /dev/vdb1 </span></div><div class="line">Filesystem     Type  1K-blocks  Used  Available Use% Mounted on</div><div class="line">/dev/vdb1      xfs  3219650564 32944 3219617620   1% /data</div><div class="line">[root@bigdata1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>这时我们就可以在 Centos 7.3(默认为ext4)上使用大磁盘了(超过2TB)  </p>
<p>参考：<a href="https://help.aliyun.com/document_detail/34377.html" target="_blank" rel="external">https://help.aliyun.com/document_detail/34377.html</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/07/15/怎么在Linux划分大磁盘分区/">http://www.yfshare.vip/2017/07/15/怎么在Linux划分大磁盘分区/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[部署wordpress]]></title>
      <url>http://www.yfshare.vip/2017/06/25/%E9%83%A8%E7%BD%B2wordpress/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>WordPress是一种使用PHP语言开发的博客平台，用户可以在支持PHP和MySQL数据库的服务器上架设属于自己的网站。也可以把 WordPress当作一个内容管理系统（CMS）来使用. WordPress是一款个人博客系统，并逐步演化成一款内容管理系统软件<br><a id="more"></a><br>官网：<a href="https://wordpress.org/" target="_blank" rel="external">https://wordpress.org/</a><br>官方文档：<a href="https://codex.wordpress.org/Main_Page" target="_blank" rel="external">https://codex.wordpress.org/Main_Page</a><br>wordpress最新版下载(目前最新版是4.8)：<a href="https://wordpress.org/latest.tar.gz" target="_blank" rel="external">https://wordpress.org/latest.tar.gz</a><br>wordpress安装要求：<a href="https://wordpress.org/about/requirements/" target="_blank" rel="external">https://wordpress.org/about/requirements/</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#wordpress 4.8系统安装要求</span></div><div class="line">php version &gt;= 7</div><div class="line">mysql version &gt;=5.6 or MariaDB version &gt;= 10.0</div><div class="line">https support</div></pre></td></tr></table></figure></p>
<p>官方安装文档：<a href="https://codex.wordpress.org/Installing_WordPress#Famous_5-Minute_Install" target="_blank" rel="external">https://codex.wordpress.org/Installing_WordPress#Famous_5-Minute_Install</a>  </p>
<h2 id="安装LNMP环境"><a href="#安装LNMP环境" class="headerlink" title="安装LNMP环境"></a>安装LNMP环境</h2><p>环境：<br>　　　Centos 7.3<br>　　　wordpress version 4.8<br>　　　mysql version 5.6.36<br>　　　php version 7.1.5<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># yum -y install mysql-community-server mysql-community-client</span></div><div class="line">[root@localhost ~]<span class="comment"># systemctl start mysql</span></div><div class="line">[root@localhost ~]<span class="comment"># systemctl list-unit-files | grep -i mysql</span></div><div class="line">mysql.service                               enabled </div><div class="line">mysqld.service                              enabled </div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#更新yum源</span></div><div class="line">[root@localhost ~]<span class="comment"># rpm -Uvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm</span></div><div class="line">[root@localhost ~]<span class="comment"># rpm -Uvh https://mirror.webtatic.com/yum/el7/webtatic-release.rpm</span></div><div class="line"><span class="comment">#安装php71</span></div><div class="line">[root@localhost ~]<span class="comment"># yum install php71w-fpm php71w-devel php71w-gd php71w-imap php71w-mysql php71w-odbc</span></div><div class="line"><span class="comment">#安装nginx1.12.0-1.w7</span></div><div class="line">[root@localhost ~]<span class="comment"># yum install nginx1w</span></div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment"># systemctl start php-fpm</span></div><div class="line">[root@localhost ~]<span class="comment"># systemctl enable php-fpm</span></div><div class="line">[root@localhost ~]<span class="comment"># systemctl start nginx</span></div><div class="line">[root@localhost ~]<span class="comment"># systemctl enable nginx</span></div></pre></td></tr></table></figure></p>
<h2 id="安装wordpress"><a href="#安装wordpress" class="headerlink" title="安装wordpress"></a>安装wordpress</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#官方只提供最新版下载，本文附件会提供wordpress-4.8下载</span></div><div class="line">[root@localhost ~]<span class="comment"># wget https://wordpress.org/latest.tar.gz -O wordpress-4.8.tar.gz</span></div><div class="line">[root@localhost ~]<span class="comment"># tar -zxf wordpress-4.8.tar.gz -C /usr/local/</span></div></pre></td></tr></table></figure>
<p>配置nginx<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># cd /etc/nginx/conf.d/</span></div><div class="line">[root@localhost conf.d]<span class="comment"># cat wordpress.conf </span></div><div class="line">server &#123;</div><div class="line">        listen       80;</div><div class="line">        server_name  192.168.1.199;</div><div class="line">	    root  /usr/<span class="built_in">local</span>;</div><div class="line"></div><div class="line">        location /wordpress &#123;</div><div class="line">		index index.php;</div><div class="line">        access_log  /var/<span class="built_in">log</span>/nginx/host_wordpress.access.log  main;</div><div class="line">		try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.php?<span class="variable">$args</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">	    location /info &#123;</div><div class="line">	    	index index.php;</div><div class="line">	    	try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.php?<span class="variable">$args</span>;</div><div class="line">	    &#125;</div><div class="line"></div><div class="line">        error_page  404              /404.html;</div><div class="line">        error_page   500 502 503 504  /50x.html;</div><div class="line"></div><div class="line">	    location ~ ^(.+.php)(.*)$ &#123;</div><div class="line">                fastcgi_split_path_info ^(.+.php)(.*)$;</div><div class="line">                include fastcgi.conf;</div><div class="line">                fastcgi_pass  127.0.0.1:9000;</div><div class="line">                fastcgi_index index.php;</div><div class="line">                fastcgi_param  PATH_INFO          <span class="variable">$fastcgi_path_info</span>;</div><div class="line">	    &#125;</div><div class="line">&#125;</div><div class="line">[root@localhost conf.d]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@localhost conf.d]<span class="comment"># nginx -t</span></div><div class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</div><div class="line">nginx: configuration file /etc/nginx/nginx.conf <span class="built_in">test</span> is successful</div><div class="line">[root@localhost conf.d]<span class="comment"># systemctl reload nginx</span></div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment"># curl -I http://192.168.1.199/info</span></div><div class="line">[root@localhost ~]<span class="comment"># curl -I http://192.168.1.199/wordpress</span></div></pre></td></tr></table></figure></p>
<p>访问<a href="http://ip/info" target="_blank" rel="external">http://ip/info</a><br><img src="http://note.youdao.com/yws/api/personal/file/E7B92FD10C5A49A39FC9A4A8D462A8AE?method=download&amp;shareKey=42942e0a0e65757aa79d3c3b7d15cf7e" alt="php_info">  </p>
<p>访问<a href="http://ip/wordpress" target="_blank" rel="external">http://ip/wordpress</a><br><img src="http://note.youdao.com/yws/api/personal/file/9B00896C67B548A581D17F957C0C57BF?method=download&amp;shareKey=207e4808d4a05758f9735defc1e5e8d2" alt="wordpress_setup"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#创建mysql库wordpress</span></div><div class="line">mysql&gt; create database wordpress DEFAULT CHARACTER SET utf8;</div><div class="line">mysql&gt; create user wordpress_user identified by <span class="string">'wordpress_pass'</span>;</div><div class="line">mysql&gt; grant all privileges on wordpress.* TO <span class="string">'wordpress_user'</span>;</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># cd /usr/local/wordpress</span></div><div class="line">[root@localhost wordpress]<span class="comment"># cp wp-config-sample.php wp-config.php</span></div></pre></td></tr></table></figure>
<p>如果打开时报这个错误，是因为没有正确在 wp-config.php 配置mysql数据库连接信息<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Error establishing a database connection</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@localhost wordpress]<span class="comment"># grep -i '^define' wp-config.php | grep -i 'db'</span></div><div class="line">define(<span class="string">'DB_NAME'</span>, <span class="string">'wordpress'</span>);</div><div class="line">define(<span class="string">'DB_USER'</span>, <span class="string">'wordpress_user'</span>);</div><div class="line">define(<span class="string">'DB_PASSWORD'</span>, <span class="string">'wordpress_pass'</span>);</div><div class="line">define(<span class="string">'DB_HOST'</span>, <span class="string">'192.168.1.199'</span>);</div><div class="line">define(<span class="string">'DB_CHARSET'</span>, <span class="string">'utf8'</span>);</div><div class="line">define(<span class="string">'DB_COLLATE'</span>, <span class="string">''</span>);</div><div class="line">[root@localhost wordpress]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p><img src="http://note.youdao.com/yws/api/personal/file/DAED3746D98F40F58B263B5CD03A3D1B?method=download&amp;shareKey=79e096e183c5ecd255ebe4bcbfccfe8a" alt="wordpress_setup"><br><img src="http://note.youdao.com/yws/api/personal/file/AA1A6476AB314A8AA692FDD8393F4727?method=download&amp;shareKey=2fb2dc9a5c38f1253b8a984832079e8f" alt="wordpress_setup"><br><img src="http://note.youdao.com/yws/api/personal/file/0FDD8E0F04A54865B7EC69388D480F32?method=download&amp;shareKey=a0d006cd9026dfe508fdcc41e316d68e" alt="wordpress_setup"><br><img src="http://note.youdao.com/yws/api/personal/file/E7F1ECC0F00F46368F930FF903B3C288?method=download&amp;shareKey=8fb3db6d436e4ad9dd767dc712048a63" alt="wordpress_setup"><br><img src="http://note.youdao.com/yws/api/personal/file/94A079CC6FEC457FBC26D4B283D460AB?method=download&amp;shareKey=68531e8abc3169d32bbc44a395d5681f" alt="wordpress_setup"><br><img src="http://note.youdao.com/yws/api/personal/file/61B09A80BA024991A7B69C9F26DD5806?method=download&amp;shareKey=657dc0db9545feb26d9090b0a9eb5865" alt="wordpress_setup">  </p>
<p>Wordpress安装成功  </p>
<p>附件：<br><a href="http://note.youdao.com/yws/api/personal/file/EA86652A437B401E89779A59BDB9C277?method=download&amp;shareKey=b37e6799aeaaaa2335bfa0db132320cf" target="_blank" rel="external">wordpress-4.8.tar.gz</a><br><a href="http://note.youdao.com/yws/api/personal/file/48771A01FF8541C0B580B5CC944FF2E7?method=download&amp;shareKey=57c1dcff158b802afd0a65d51d83eb94" target="_blank" rel="external">mysql57-community-release-el7-11.noarch.rpm</a><br>此mysql yum源安装后，修改mysql-community.repo即可</p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/06/25/部署wordpress/">http://www.yfshare.vip/2017/06/25/部署wordpress/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[部署atlassian-confluence 6.1.2]]></title>
      <url>http://www.yfshare.vip/2017/06/25/%E9%83%A8%E7%BD%B2atlassian-confluence-6-1-2/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>AtlassianConfluence（简称Confluence）是一个专业的wiki程序。它是一个知识管理的工具，通过它可以实现团队成员之间的协作和知识共享。Confluence不是一个开源软件，非商业用途可以免费使用<br>Confluence使用简单，但它强大的编辑和站点管理特征能够帮助团队成员之间共享信息，文档协作，集体讨论。 目前，Confluence被用于广泛地用于项目团队，开发团队，市场销售团队<br><a id="more"></a></p>
<p>首页：<a href="https://www.atlassian.com/" target="_blank" rel="external">https://www.atlassian.com/</a><br>　　　<a href="https://www.atlassian.com/software/confluence" target="_blank" rel="external">https://www.atlassian.com/software/confluence</a>  </p>
<p>atlassian-confluence各版本下载地址(截至到目前最新版是6.2.2)：<a href="https://www.atlassian.com/software/confluence/download-archives" target="_blank" rel="external">https://www.atlassian.com/software/confluence/download-archives</a>  </p>
<p>6.1.2系统配置要求官方文档：<br><a href="https://confluence.atlassian.com/conf61/system-requirements-877188692.html" target="_blank" rel="external">https://confluence.atlassian.com/conf61/system-requirements-877188692.html</a><br><a href="https://confluence.atlassian.com/conf61/supported-platforms-877188781.html" target="_blank" rel="external">https://confluence.atlassian.com/conf61/supported-platforms-877188781.html</a>  </p>
<p>confluence 6.1.2官方帮助文档：<a href="https://confluence.atlassian.com/conf61/getting-help-and-support-877188789.html" target="_blank" rel="external">https://confluence.atlassian.com/conf61/getting-help-and-support-877188789.html</a>  </p>
<p>附件：<br>下载atlassian-confluence-6.1.2-x64.bin<br><a href="https://downloads.atlassian.com/software/confluence/downloads/atlassian-confluence-6.1.2-x64.bin" target="_blank" rel="external">confluence-6.1.2 for linux官网下载</a><br><a href="http://pan.baidu.com/s/1i4Tp37Z" target="_blank" rel="external">confluence-6.1.2 for linux百度网盘下载，密码：izdr</a><br><a href="http://pan.baidu.com/s/1jHS4VPW" target="_blank" rel="external">jdk-8u20百度网盘下载，密码：9p4g</a>  </p>
<h2 id="安装前准备"><a href="#安装前准备" class="headerlink" title="安装前准备"></a>安装前准备</h2><p>环境：<br>　　　Centos 6.6<br>　　　Mysql version 5.6.36<br>　　　JIRA 7.2.2<br>　　　atlassian-confluence 6.1.2  </p>
<p>服务器内存建议大于3G<br>说明，目前已经成功安装JIRA<br>安装confluence 6.1.2所需要的系统配置：<a href="https://confluence.atlassian.com/conf61/supported-platforms-877188781.html" target="_blank" rel="external">https://confluence.atlassian.com/conf61/supported-platforms-877188781.html</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#安装confluence对环境的要求</span></div><div class="line">Mysql = 5.6(但不要用5.6.16之前的版本)</div><div class="line">JDK = 1.8</div><div class="line">    ≠ Java 1.8.0_25 and 1.8.0_31 and Java 1.8.0_45</div><div class="line">Tomcat = 8.0.x</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#官方关于JAVA环境的说明</span></div><div class="line"><span class="comment">#这里安装的atlassian-confluence-6.1.2-x64.bin文件，不需要手动安装JRE环境</span></div><div class="line">Java</div><div class="line">The Java Runtime Environment (JRE) is packed up and ready to go when you install Confluence using the Windows or Linux installer. You don<span class="string">'t need to install Java yourself. </span></div><div class="line">If you choose to install Confluence from an archive file, you'll need a supported JRE or JDK, and your JAVA_HOME variable <span class="built_in">set</span> correctly. See Installing Java <span class="keyword">for</span> Confluence <span class="keyword">for</span> more information.</div></pre></td></tr></table></figure>
<p>Confluence安装前准备，如果是生产使用需要用到外部的数据库，这里我们选择安装Mysql  </p>
<p>注：如果当前系统有安装JIRA，则Mysql安装相关配置可省略<br>Mysql 5.6 Yum源(rpm)：<a href="http://note.youdao.com/yws/api/personal/file/9F81786CBC5748E69B2F34FC7BE160D6?method=download&amp;shareKey=aca90d80731cf2a892d421787e401289" target="_blank" rel="external">点击下载</a><br>Confluence 6.1.2关于Mysql的配置参考：<a href="https://confluence.atlassian.com/conf61/database-setup-for-mysql-877188444.html" target="_blank" rel="external">https://confluence.atlassian.com/conf61/database-setup-for-mysql-877188444.html</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># yum -y install http://dev.mysql.com/get/mysql-community-release-el6-5.noarch.rpm</span></div><div class="line">[root@localhost ~]<span class="comment"># yum -y install mysql-community-server.x86_64 mysql-community-devel.x86_64 mysql-community-client.x86_64</span></div><div class="line">[root@localhost ~]<span class="comment"># /etc/init.d/mysqld start</span></div><div class="line">[root@localhost ~]<span class="comment"># /usr/bin/mysqladmin -u root password '123456'</span></div><div class="line">[root@localhost ~]<span class="comment"># chkconfig mysqld on</span></div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment"># grep -iA6 confluence /etc/my.cnf </span></div><div class="line">[mysqld]</div><div class="line">...</div><div class="line"><span class="comment">#confluence configure</span></div><div class="line">character-set-server=utf8</div><div class="line">collation-server=utf8_bin</div><div class="line">default-storage-engine=INNODB</div><div class="line">max_allowed_packet=256M</div><div class="line">innodb_log_file_size=2GB</div><div class="line">transaction-isolation=READ-COMMITTED</div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line">[root@localhost ~]<span class="comment"># /etc/init.d/mysqld restart</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Mysql初始化</span></div><div class="line">[root@localhost ~]<span class="comment"># mysql -uroot -p123456</span></div><div class="line">mysql&gt; CREATE DATABASE confluence CHARACTER SET utf8 COLLATE utf8_bin;</div><div class="line">mysql&gt; GRANT ALL PRIVILEGES ON confluence.* TO <span class="string">'confluenceuser'</span>@<span class="string">'localhost'</span> IDENTIFIED BY <span class="string">'confluencepass'</span>;</div><div class="line">mysql&gt; GRANT ALL PRIVILEGES ON confluence.* TO <span class="string">'confluenceuser'</span>@<span class="string">'192.168.1.%'</span> IDENTIFIED BY <span class="string">'confluencepass'</span>;</div><div class="line">mysql&gt; FLUSH PRIVILEGES;</div><div class="line">mysql&gt; \q</div><div class="line">Bye</div><div class="line">[root@localhost ~]<span class="comment"># mysql -V</span></div><div class="line">mysql  Ver 14.14 Distrib 5.6.36, <span class="keyword">for</span> Linux (x86_64) using  EditLine wrapper</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h2 id="安装并破解atlassian-confluence-6-1-2"><a href="#安装并破解atlassian-confluence-6-1-2" class="headerlink" title="安装并破解atlassian-confluence 6.1.2"></a>安装并破解atlassian-confluence 6.1.2</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#atlassian-confluence 没有加到chkconfig里，不能开机启动</span></div><div class="line">[root@localhost ~]<span class="comment"># chmod +x atlassian-confluence-6.1.2-x64.bin</span></div><div class="line">[root@localhost ~]<span class="comment"># ./atlassian-confluence-6.1.2-x64.bin </span></div><div class="line">Unpacking JRE ...</div><div class="line">Starting Installer ...</div><div class="line"></div><div class="line">This will install Confluence 6.1.2 on your computer.</div><div class="line">OK [o, Enter], Cancel [c]</div><div class="line">o</div><div class="line">Choose the appropriate installation or upgrade option.</div><div class="line">Please choose one of the following:</div><div class="line">Express Install (uses default settings) [1], </div><div class="line">Custom Install (recommended <span class="keyword">for</span> advanced users) [2, Enter], </div><div class="line">Upgrade an existing Confluence installation [3]</div><div class="line">1</div><div class="line">See <span class="built_in">where</span> Confluence will be installed and the settings that will be used.</div><div class="line">Installation Directory: /opt/atlassian/confluence </div><div class="line">Home Directory: /var/atlassian/application-data/confluence </div><div class="line">HTTP Port: 8090 </div><div class="line">RMI Port: 8000 </div><div class="line">Install as service: Yes </div><div class="line">Install [i, Enter], Exit [e]</div><div class="line">i</div><div class="line"></div><div class="line">Extracting files ...</div><div class="line"></div><div class="line">Please <span class="built_in">wait</span> a few moments <span class="keyword">while</span> we configure Confluence.</div><div class="line">Installation of Confluence 6.1.2 is complete</div><div class="line">Start Confluence now?</div><div class="line">Yes [y, Enter], No [n]</div><div class="line">y</div><div class="line"></div><div class="line">Please <span class="built_in">wait</span> a few moments <span class="keyword">while</span> Confluence starts up.</div><div class="line">Launching Confluence ...</div><div class="line">Installation of Confluence 6.1.2 is complete</div><div class="line">Your installation of Confluence 6.1.2 is now ready and can be accessed via</div><div class="line">your browser.</div><div class="line">Confluence 6.1.2 can be accessed at http://localhost:8090</div><div class="line">Finishing installation ...</div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line">[root@localhost ~]<span class="comment"># netstat -tunlp | grep 8090</span></div><div class="line">tcp        0      0 :::8090                     :::*                        LISTEN      14529/java          </div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#破解atlassian-confluence 6.1.2</span></div><div class="line"><span class="comment">#替换 atlassian-extras-decoder-v2-3.2.jar 和 atlassian-universal-plugin-manager-plugin-2.22.1.jar 这两个文件</span></div><div class="line">[root@localhost ~]<span class="comment"># /etc/init.d/confluence stop</span></div><div class="line">[root@localhost ~]<span class="comment"># cd /opt/atlassian/confluence/confluence/WEB-INF/lib</span></div><div class="line"><span class="comment">#备份，仅限个人使用勿用于商业</span></div><div class="line">[root@localhost lib]<span class="comment"># cp atlassian-extras-decoder-v2-3.2.jar ~</span></div><div class="line"></div><div class="line"><span class="comment">#上传破解文件</span></div><div class="line">[root@localhost lib]<span class="comment"># ll atlassian-extras-decoder-v2-3.2.jar</span></div><div class="line">-rw-r--r-- 1 confluence confluence 8321 Jun 24 17:59 atlassian-extras-decoder-v2-3.2.jar</div><div class="line">[root@localhost lib]<span class="comment"># </span></div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment"># cd /opt/atlassian/confluence/confluence/WEB-INF/atlassian-bundled-plugins</span></div><div class="line"><span class="comment">#备份，仅限个人使用勿用于商业</span></div><div class="line">[root@localhost atlassian-bundled-plugins]<span class="comment"># cp atlassian-universal-plugin-manager-plugin-2.22.1.jar ~</span></div><div class="line"></div><div class="line"><span class="comment">#上传破解文件</span></div><div class="line">[root@localhost atlassian-bundled-plugins]<span class="comment"># ll atlassian-universal-plugin-manager-plugin-2.22.1.jar</span></div><div class="line">-rw-r--r-- 1 confluence confluence 8054971 Jun 24 17:59 atlassian-universal-plugin-manager-plugin-2.22.1.jar</div><div class="line">[root@localhost atlassian-bundled-plugins]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment"># chown confluence:confluence /opt/atlassian/confluence/ -R</span></div><div class="line">[root@localhost ~]<span class="comment"># chown confluence:confluence /var/atlassian/application-data/confluence/ -R</span></div><div class="line">[root@localhost ~]<span class="comment"># /etc/init.d/confluence start</span></div></pre></td></tr></table></figure>
<p>如果在打开Confluence向导配置页面出现下面错误，可以通过重启Confluence和Mysql解决<br><img src="http://note.youdao.com/yws/api/personal/file/24FD420254F74B25ADF50B1FB5AB133B?method=download&amp;shareKey=8ce860b8f5b432a376faf0286e9093f3" alt="confluence_setup_error">  </p>
<p>访问<a href="http://ip:8090打开Confluence配置页面向导" target="_blank" rel="external">http://ip:8090打开Confluence配置页面向导</a><br><img src="http://note.youdao.com/yws/api/personal/file/5010DB050FDD46F59E134A754DA66C49?method=download&amp;shareKey=923249f8ed3d81325a26d7c8889e2f83" alt="confluence_install"><br><img src="http://note.youdao.com/yws/api/personal/file/18D9A75EAAC84BA6B179AE3ABC144292?method=download&amp;shareKey=5feacdc57b178708ab4785be254015c0" alt="confluence_install"><br><img src="http://note.youdao.com/yws/api/personal/file/C88C03CF5236404EBF3F6C7DE656D951?method=download&amp;shareKey=064c408e1c75e4929a71f4ab456e5cb1" alt="confluence_install">  </p>
<p>如果没有Key的话，就需要我们去官网申请一个测试Key<br>申请一个测试key需要<a href="https://id.atlassian.com/login?application=mac&amp;continue=https://my.atlassian.com" target="_blank" rel="external">登录Atlassian</a>，如果没有Atlassian，则需要<a href="https://id.atlassian.com/signup?application=mac&amp;tenant=&amp;continue=" target="_blank" rel="external">注册Atlassian</a>帐号了。<em>这里可能翻墙，因为需要加载google验证码…</em>  </p>
<p>如果已有Atlassian帐号则跳过下一步<br><img src="http://note.youdao.com/yws/api/personal/file/BEDE645C4D3F4E2292A7EB285CEDE5DB?method=download&amp;shareKey=251da9366a1e1522e01ea296e865136c" alt="SignUP_Atlassian"><br><img src="http://note.youdao.com/yws/api/personal/file/92ED4D7B125B4B85B9D21E91104C0DFE?method=download&amp;shareKey=b45bfd72456ceffcf09da05cd30bd450" alt="confluence_install"><br><img src="http://note.youdao.com/yws/api/personal/file/826333DD3B314B1EBFA2A121E51456D3?method=download&amp;shareKey=5fd3eefb377a6b21f6a9a4e94c2b479d" alt="confluence_install"><br><img src="http://note.youdao.com/yws/api/personal/file/E875F7B88580423D84A389B955C261E5?method=download&amp;shareKey=2e9a3aa73314e56b0d141de841439cc4" alt="confluence_install"><br>然后会生成一个测试key，然后填入上图的key选项框内(一般情况下系统会自动填入)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#试用key，有效期30天，官网可以随时申请</span></div><div class="line">BHBF-LIX9-DF7P-E62M</div><div class="line">AAABJg0ODAoPeNptkF9LwzAUxd/zKQK+6ENGW/tvhYCu7bDSdsNO8cGXGG410GZbkg737U1XxSk+B</div><div class="line">C6555z7u/eiYQbfDxJ7PnaCxA0TN8ZptsGe40YoA82V2BmxlTTdyrYbQHLAlw2oA6irlwTnB9YNb</div><div class="line">BSgVMGpyJgBOtqJExLPR9waZ4wbcQBq1ADTR2OYMqBoyzoNyIYbK8krJjoaX8dB4IeOf7Pfz/i2R</div><div class="line">z9DzgJKwUFq2Bx3ULMeaLqqqvwhLW5L1E2tJ1B69HjIxkoDkln4/GMn1PGMMRoZV+qNSaGnGXWDp</div><div class="line">gWLjC7uFktSFs9zki2jNclDr0JNXlP7SDmfu2EURugLxcrLIvvVOZHWQ/8KatU+agtEifut/x9lP</div><div class="line">Sj+zjT8PeMnH9GHljAsAhQBR2B3nIotW7W/fZPdH5cO1UwcQQIUP5BxRFyS/6+Efljom+Ai9Cgm9</div><div class="line">a8=X02eq</div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/CC9CB8F6E7394147BCD2650D1DC4E2E3?method=download&amp;shareKey=2898709ce9794d413dd94e1abf54df77" alt="confluence_install">  </p>
<p>如果出现下面的错误，是因为我们没有安装Mysql的驱动程序<br>关于<a href="https://confluence.atlassian.com/conf61/database-jdbc-drivers-877188428.html" target="_blank" rel="external">Mysql数据库驱动问题解决办法</a><br><img src="http://note.youdao.com/yws/api/personal/file/F46C2CF899714286BBA65BE51BBC2ADB?method=download&amp;shareKey=4dd33733d56de4588c8a7eea0a876c3a" alt="confluence_install"><br>解决办法：在Confluence的安装目录 /opt/atlassian/confluence/confluence/WEB-INF/lib/ 上传Mysql的驱动程序，并重启Confluence服务<br>Mysql驱动程序：<a href="http://note.youdao.com/yws/api/personal/file/96A36E6E887E48A4BF17B26D93404EDC?method=download&amp;shareKey=aef29732ea1e0defc22dd157ef1aca26" target="_blank" rel="external">点击下载</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># cd /opt/atlassian/confluence/confluence/WEB-INF/lib/</span></div><div class="line">[root@localhost lib]<span class="comment"># ll mysql-connector-java-5.1.39-bin.jar </span></div><div class="line">-rw-r--r-- 1 confluence confluence 989497 Jun 24 18:37 mysql-connector-java-5.1.39-bin.jar</div><div class="line">[root@localhost lib]<span class="comment"># /etc/init.d/confluence restart</span></div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/EFF3DFF59D6B46C98EDCE9B6F54D509B?method=download&amp;shareKey=169878c51a7ac0b47e2345048ab025aa" alt="confluence_install"><br><img src="http://note.youdao.com/yws/api/personal/file/29007C22DB284513AEA14ADE85F53F32?method=download&amp;shareKey=86fe76e0d36119217bf6d0d15ac79da9" alt="confluence_install"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#要配置Mysql的授权登录信息</span></div><div class="line">Driver Class Name：com.mysql.jdbc.Driver</div><div class="line">Database URL：jdbc:mysql://192.168.1.119/confluence?sessionVariables=storage_engine%3DInnoDB</div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/197029A0B2A346049AC3C25AA6E7FF5F?method=download&amp;shareKey=b407d62ccd0e8db75ca7a5cab905583d" alt="confluence_install">  </p>
<p>如果出现下面的错误，就比较悲剧了，需要我们重新来过<br><img src="http://note.youdao.com/yws/api/personal/file/21B7637E8230483A820EA3C81661C7DA?method=download&amp;shareKey=800bb4fbdc255771ae1474d6395750b4" alt="confluence_install"><br>解决办法：需要删除confluence家目录的相关配置文件和缓存文件<br>参考：<a href="https://confluence.atlassian.com/confkb/confluence-installation-fails-with-set-up-step-error-java-sql-sqlsyntaxerrorexception-user-lacks-privilege-or-object-not-found-bandana-390497283.html" target="_blank" rel="external">https://confluence.atlassian.com/confkb/confluence-installation-fails-with-set-up-step-error-java-sql-sqlsyntaxerrorexception-user-lacks-privilege-or-object-not-found-bandana-390497283.html</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># cd /var/atlassian/application-data/confluence</span></div><div class="line">[root@localhost confluence]<span class="comment"># rm -rf bundled-plugins/ plugins-cache/ plugins-osgi-cache/ plugins-temp/ database confluence.cfg.xml   #database可能没有，我这里就没有这个</span></div><div class="line">[root@localhost ~]<span class="comment"># /etc/init.d/confluence restart</span></div><div class="line">[root@localhost ~]<span class="comment"># chown confluence:confluence /opt/atlassian/ -R</span></div><div class="line">[root@localhost ~]<span class="comment"># chown confluence:confluence /var/atlassian/ -R</span></div></pre></td></tr></table></figure></p>
<p>重新来过的步骤略，直到下面这一步<br><img src="http://note.youdao.com/yws/api/personal/file/6E48754B104F47E9B6A26294525F1F8A?method=download&amp;shareKey=85cd30e5a10b336f5fc44bc92dfdfbe6" alt="confluence_install">  </p>
<p>点下一步前需要确认JIRA已经启动成功了<br><img src="http://note.youdao.com/yws/api/personal/file/CE4C8B38E4124148AFB74BC269214EB7?method=download&amp;shareKey=9429730240206336286d574b0e08361d" alt="confluence_install"><br><img src="http://note.youdao.com/yws/api/personal/file/7A35B50E505E4AEFB279673FF87B6E66?method=download&amp;shareKey=cc016f54b7645a1f3f425c2f089606fb" alt="confluence_install"><br><img src="http://note.youdao.com/yws/api/personal/file/99E16A726765471BB398E77282AA21CA?method=download&amp;shareKey=bfa286b85821606e1f883d71ca4e905a" alt="confluence_install"><br>安装 atlassian-confluence 6.1.2 成功  </p>
<p>配置 atlassian-confluence 6.1.2<br><img src="http://note.youdao.com/yws/api/personal/file/178719E6241940888BD1A8CE9D738705?method=download&amp;shareKey=ff704a3505262944e34bd3c3a71558db" alt="confluence_setup"><br><img src="http://note.youdao.com/yws/api/personal/file/3CA3D13901BF4BDA9042B212A6F721BD?method=download&amp;shareKey=b0408b3ce4903d2dbe07c5d91a1bbdde" alt="confluence_setup"><br><img src="http://note.youdao.com/yws/api/personal/file/761984549515471C96C3C229419B1C88?method=download&amp;shareKey=d66e7b684dba58a22452abea00c6a8f2" alt="confluence_setup"><br><img src="http://note.youdao.com/yws/api/personal/file/35157265F193450C976C4B499581E07B?method=download&amp;shareKey=27739711e361294143120d15a3872aaa" alt="confluence_setup">  </p>
<p>设置– 一般管理– 授权码细节<br><img src="http://note.youdao.com/yws/api/personal/file/BC4C48F113384AFE8C1425C61B93BD15?method=download&amp;shareKey=11e47d1f4fd91f44ffabccecbaf1e5a1" alt="confluence_setup"><br>破解成功  </p>
<h2 id="汉化atlassian-confluence-6-1-2"><a href="#汉化atlassian-confluence-6-1-2" class="headerlink" title="汉化atlassian-confluence 6.1.2"></a>汉化atlassian-confluence 6.1.2</h2><p>atlassian-confluence 6.1.2 应该是自动识别语言了，我没有做汉化操作，默认就是中文了<br>如果没有汉化的，下面是 atlassian-confluence 6.1.2 的语言包<br><a href="http://note.youdao.com/yws/api/personal/file/42A4E88F9BCD43C89057CA48AF690E62?method=download&amp;shareKey=ef26537fa975a98d1c852007deca1d6e" target="_blank" rel="external">Confluence-6.1.0-language-pack-zh_CN.jar</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#把confluence的中文语言包上传到 /opt/atlassian/confluence/confluence/WEB-INF/lib/ 这个目录然，然后重启confluence即可</span></div><div class="line">[root@localhost ~]<span class="comment"># cd /opt/atlassian/confluence/confluence/WEB-INF/lib/</span></div><div class="line">[root@localhost lib]<span class="comment"># ll Confluence-6.1.0-language-pack-zh_CN.jar </span></div><div class="line">-rw-r--r-- 1 confluence confluence 269133 Jun 24 18:47 Confluence-6.1.0-language-pack-zh_CN.jar </div><div class="line">[root@localhost lib]<span class="comment"># /etc/init.d/confluence restart</span></div></pre></td></tr></table></figure></p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/06/25/部署atlassian-confluence-6-1-2/">http://www.yfshare.vip/2017/06/25/部署atlassian-confluence-6-1-2/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Dubbo理论]]></title>
      <url>http://www.yfshare.vip/2017/06/21/Dubbo%E7%90%86%E8%AE%BA/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>DUBBO是Alibaba开源的分布式服务框架，致力于提供高性能和透明化的RPC远程服务调用方案，使用这种方式可以使各个层之间解耦合(或者最大限度地松耦合)。从服务模型的角度，Dubbo采用的是一种非常简单的模型，分为<strong>提供方提供服务</strong>和<strong>消费方消费服务</strong>，基于这一点可以抽象出<strong>服务提供方</strong>(Provider)和<strong>服务消费方</strong>(Consumer)两个角色<br><a id="more"></a><br>官网：<a href="http://dubbo.io/" target="_blank" rel="external">http://dubbo.io/</a><br>用户手册：<a href="http://dubbo.io/User+Guide-zh.htm" target="_blank" rel="external">http://dubbo.io/User+Guide-zh.htm</a><br>管理指南：<a href="http://dubbo.io/Administrator+Guide-zh.htm" target="_blank" rel="external">http://dubbo.io/Administrator+Guide-zh.htm</a><br>FAQ：<a href="http://dubbo.io/FAQ-zh.htm" target="_blank" rel="external">http://dubbo.io/FAQ-zh.htm</a>  </p>
<p>Dubbo总体架构图<br><img src="http://note.youdao.com/yws/api/personal/file/E36A4921C3074B4D8E75C4AF51C250B7?method=download&amp;shareKey=86c67efbb244731c612a3b9c5c8a6b95" alt="dubbo-architecture"><br>Dubbo框架设计一共划分了10个层，而最上面的 Service 层是留给实际想要使用Dubbo开发分布式服务的开发者实现业务逻辑的接口层<br>图中左边淡蓝背景的为服务消费方使用的接口，右边淡绿色背景的为服务提供方使用的接口， 位于中轴线上的为双方都用到的接口<br>结合Dubbo官方文档，整理了一下框架分层架构，各个层次的设计要点如下：  </p>
<ol>
<li>服务接口层（Service）：该层是与实际业务逻辑相关的，根据服务提供方和服务消费方的业务设计对应的接口和实现  </li>
<li>配置层（Config）：对外配置接口，以 ServiceConfig 和 ReferenceConfig 为中心，可以直接 new 配置类，也可以通过 spring 解析配置生成配置类  </li>
<li>服务代理层（Proxy）：服务接口透明代理，生成服务的客户端 Stub 和服务器端 Skeleton ，以 ServiceProxy 为中心，扩展接口为 ProxyFactory  </li>
<li>服务注册层（Registry）：封装服务地址的注册与发现，以服务URL为中心，扩展接口为 RegistryFactory 、 Registry 和 RegistryService 。可能没有服务注册中心，此时服务提供方直接暴露服务  </li>
<li>集群层（Cluster）：封装多个提供者的路由及负载均衡，并桥接注册中心，以 Invoker 为中心，扩展接口为 Cluster 、 Directory 、 Router 和 LoadBalance 。将多个服务提供方组合为一个服务提供方，实现对服务消费方来透明，只需要与一个服务提供方进行交互  </li>
<li>监控层（Monitor）：RPC调用次数和调用时间监控，以 Statistics 为中心，扩展接口为 MonitorFactory 、 Monitor 和 MonitorService  </li>
<li>远程调用层（Protocol）：封将 RPC 调用，以 Invocation 和 Result 为中心，扩展接口为 Protocol 、 Invoker 和 Exporter 。 Protocol 是服务域，它是 Invoker 暴露和引用的主功能入口，它负责 Invoker 的生命周期管理。Invoker 是实体域，它是 Dubbo 的核心模型，其它模型都向它靠扰，或转换成它，它代表一个可执行体，可向它发起 invoke 调用，它有可能是一个本地的实现，也可能是一个远程的实现，也可能一个集群实现  </li>
<li>信息交换层（Exchange）：封装请求响应模式，同步转异步，以 Request 和 Response 为中心，扩展接口为 Exchanger、ExchangeChannel、ExchangeClient 和 ExchangeServer  </li>
<li>网络传输层（Transport）：抽象 mina 和 netty 为统一接口，以 Message 为中心，扩展接口为 Channel、Transporter、Client、Server 和 Codec  </li>
<li>数据序列化层（Serialize）：可复用的一些工具，扩展接口为 Serialization、 ObjectInput、ObjectOutput 和 ThreadPool  </li>
</ol>
<p>从上图可以看出，Dubbo对于服务提供方和服务消费方，从框架的10层中分别提供了各自需要关心和扩展的接口，构建整个服务生态系统（服务提供方和服务消费方本身就是一个以服务为中心的）  </p>
<p>上述各层之间关系的描述：  </p>
<ul>
<li>在RPC中，Protocol是核心层，也就是只要有Protocol + Invoker + Exporter就可以完成非透明的RPC调用，然后在Invoker的主过程上Filter拦截点  </li>
<li>图中的Consumer和Provider是抽象概念，只是想让看图者更直观的了解哪些类分属于客户端与服务器端，不用Client和Server的原因是Dubbo在很多场景下都使用Provider、Consumer、Registry、Monitor划分逻辑拓普节点，保持统一概念  </li>
<li>而Cluster是外围概念，所以Cluster的目的是将多个Invoker伪装成一个Invoker，这样其它人只要关注Protocol层Invoker即可，加上Cluster或者去掉Cluster对其它层都不会造成影响，因为只有一个提供者时，是不需要Cluster的  </li>
<li>Proxy层封装了所有接口的透明化代理，而在其它层都以Invoker为中心，只有到了暴露给用户使用时，才用Proxy将Invoker转成接口，或将接口实现转成Invoker，也就是去掉Proxy层RPC是可以Run的，只是不那么透明，不那么看起来像调本地服务一样调远程服务  </li>
<li>而Remoting实现是Dubbo协议的实现，如果你选择RMI协议，整个Remoting都不会用上，Remoting内部再划为Transport传输层和Exchange信息交换层，Transport层只负责单向消息传输，是对Mina、Netty、Grizzly的抽象，它也可以扩展UDP传输，而Exchange层是在传输层之上封装了Request-Response语义  </li>
<li>Registry和Monitor实际上不算一层，而是一个独立的节点，只是为了全局概览，用层的方式画在一起  </li>
</ul>
<p>从上面的架构图中，了解到，Dubbo作为一个分布式服务框架，主要具有如下几个核心的要点：  </p>
<p><strong>服务定义</strong><br>服务是围绕服务提供方和服务消费方的，服务提供方实现服务，而服务消费方调用服务  </p>
<p><strong>服务注册</strong><br>　　对于服务提供方，它需要发布服务，而且由于应用系统的复杂性，服务的数量、类型也不断膨胀；对于服务消费方，它最关心如何获取到它所需要的服务，而面对复杂的应用系统，需要管理大量的服务调用。而且，对于服务提供方和服务消费方来说，他们还有可能兼具这两种角色，即既需要提供服务，有需要消费服务<br>　　通过将服务统一管理起来，可以有效地优化内部应用对服务发布/使用的流程和管理。服务注册中心可以通过特定协议来完成服务对外的统一。Dubbo提供的注册中心有如下几种类型可供选择：<br>　　- Multicast注册中心<br>　　- Zookeeper注册中心<br>　　- Redis注册中心<br>　　- Simple注册中心</p>
<p><strong>服务监控</strong><br>无论是服务提供方，还是服务消费方，他们都需要对服务调用的实际状态进行有效的监控，从而改进服务质量<br><strong>远程通信与信息交换</strong><br>远程通信需要指定通信双方所约定的协议，在保证通信双方理解协议语义的基础上，还要保证高效、稳定的消息传输。Dubbo继承了当前主流的网络通信框架，主要包括如下几个：  </p>
<ul>
<li>Mina</li>
<li>Netty</li>
<li>Grizzly</li>
</ul>
<p><strong>服务调用</strong><br>下面从Dubbo官网直接拿来，看一下基于RPC层，服务提供方和服务消费方之间的调用关系<br><img src="http://note.youdao.com/yws/api/personal/file/69A00BB8DFC24AADA522F55D021731A8?method=download&amp;shareKey=e06835a8b18ec947a5f8d36cfeefe4b2" alt="dubbo-architecture"><br>上图中，蓝色的表示与业务有交互，绿色的表示只对Dubbo内部交互。上述图所描述的调用流程如下:  </p>
<ol>
<li>服务提供方发布服务到服务注册中心</li>
<li>服务消费方从服务注册中心订阅服务</li>
<li>服务消费方调用已经注册的可用服务</li>
</ol>
<p>将上面抽象的调用流程图展开，详细如图所示:<br><img src="http://note.youdao.com/yws/api/personal/file/18212A8091A64C37AA396CD2F9ACBFCC?method=download&amp;shareKey=944c755e915ecc452b83b4036cc98f61" alt="dubbo-extension">  </p>
<p><strong>注册/注销服务</strong><br>服务的注册与注销，是对服务提供方角色而言，那么注册服务与注销服务的时序图<br><img src="http://note.youdao.com/yws/api/personal/file/9C8006F023DF44DE9A49DADB602C3FFE?method=download&amp;shareKey=a3c67535a718d9aed979fe4b8564a01c" alt="dubbo-export">  </p>
<p><strong>服务订阅/取消</strong><br>为了满足应用系统的需求，服务消费方的可能需要从服务注册中心订阅指定的有服务提供方发布的服务，在得到通知可以使用服务时，就可以直接调用服务。反过来，如果不需要某一个服务了，可以取消该服务<br><img src="http://note.youdao.com/yws/api/personal/file/6524730E5DBB4D18B824F7A138C49D04?method=download&amp;shareKey=ae6c3e294fcb134f1925091850fc6a06" alt="dubbo-refer">  </p>
<p><strong>协议支持</strong><br>Dubbo支持多种协议  </p>
<ul>
<li>Dubbo协议</li>
<li>Hessian协议</li>
<li>HTTP协议</li>
<li>RMI协议</li>
<li>WebService协议</li>
<li>Thrift协议</li>
<li>Memcached协议</li>
<li>Redis协议</li>
</ul>
<p>在通信过程中，不同的服务等级一般对应着不同的服务质量，那么选择合适的协议便是一件非常重要的事情。你可以根据你应用的创建来选择。例如，使用RMI协议，一般会受到防火墙的限制，所以对于外部与内部进行通信的场景，就不要使用RMI协议，而是基于HTTP协议或者Hessian协议  </p>
<p>参考补充<br>Dubbo以包结构来组织各个模块，各个模块及其关系<br><img src="http://note.youdao.com/yws/api/personal/file/37F8F524EFCB447F8167EE17385E4B28?method=download&amp;shareKey=65136f130a053ce9b5aed041071488ac" alt="dubbo-modules">  </p>
<p>可以通过Dubbo的代码（使用Maven管理）组织，与上面的模块进行比较。简单说明各个包的情况  </p>
<ul>
<li>dubbo-common 公共逻辑模块，包括Util类和通用模型  </li>
<li>dubbo-remoting 远程通讯模块，相当于Dubbo协议的实现，如果RPC用RMI协议则不需要使用此包  </li>
<li>dubbo-rpc 远程调用模块，抽象各种协议，以及动态代理，只包含一对一的调用，不关心集群的管理  </li>
<li>dubbo-cluster 集群模块，将多个服务提供方伪装为一个提供方，包括：负载均衡、容错、路由等，集群的地址列表可以是静态配置的，也可以是由注册中心下发  </li>
<li>dubbo-registry 注册中心模块，基于注册中心下发地址的集群方式，以及对各种注册中心的抽象  </li>
<li>dubbo-monitor 监控模块，统计服务调用次数，调用时间的，调用链跟踪的服务  </li>
<li>dubbo-config 配置模块，是Dubbo对外的API，用户通过Config使用Dubbo，隐藏Dubbo所有细节  </li>
<li>dubbo-container 容器模块，是一个Standalone的容器，以简单的Main加载Spring启动，因为服务通常不需要Tomcat/JBoss等Web容器的特性，没必要用Web容器去加载服务  </li>
</ul>
<p>原文：<a href="http://shiyanjun.cn/archives/325.html" target="_blank" rel="external">http://shiyanjun.cn/archives/325.html</a><br>参考链接：<br><a href="https://github.com/alibaba/dubbo" target="_blank" rel="external">https://github.com/alibaba/dubbo</a><br><a href="http://alibaba.github.io/dubbo-doc-static/Home-zh.htm" target="_blank" rel="external">http://alibaba.github.io/dubbo-doc-static/Home-zh.htm</a><br><a href="http://alibaba.github.io/dubbo-doc-static/User+Guide-zh.htm" target="_blank" rel="external">http://alibaba.github.io/dubbo-doc-static/User+Guide-zh.htm</a><br><a href="http://alibaba.github.io/dubbo-doc-static/Developer+Guide-zh.htm" target="_blank" rel="external">http://alibaba.github.io/dubbo-doc-static/Developer+Guide-zh.htm</a><br><a href="http://alibaba.github.io/dubbo-doc-static/Administrator+Guide-zh.htm" target="_blank" rel="external">http://alibaba.github.io/dubbo-doc-static/Administrator+Guide-zh.htm</a><br><a href="http://alibaba.github.io/dubbo-doc-static/FAQ-zh.htm" target="_blank" rel="external">http://alibaba.github.io/dubbo-doc-static/FAQ-zh.htm</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/06/21/Dubbo理论/">http://www.yfshare.vip/2017/06/21/Dubbo理论/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Ant]]></title>
      <url>http://www.yfshare.vip/2017/06/19/Ant/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>Ant是一个Apache基金会下的跨平台的构件工具，可以实现自动构建和部署，大多数用于JAVA环境中的软件开发<br><a id="more"></a></p>
<h2 id="Ant"><a href="#Ant" class="headerlink" title="Ant"></a>Ant</h2><p>官网：<a href="http://ant.apache.org/" target="_blank" rel="external">http://ant.apache.org/</a><br>官方文档：<a href="http://ant.apache.org/manual/index.html" target="_blank" rel="external">http://ant.apache.org/manual/index.html</a><br>下载：<a href="http://ant.apache.org/bindownload.cgi" target="_blank" rel="external">http://ant.apache.org/bindownload.cgi</a><br><a href="http://mirror.bit.edu.cn/apache//ant/binaries/apache-ant-1.9.9-bin.zip" target="_blank" rel="external">apache-ant-1.9.9-bin.zip官方下载</a><br><a href="http://note.youdao.com/yws/api/personal/file/DA790D1F015A4B3EA72C8478B5045781?method=download&amp;shareKey=736463d1e22df8aec9cebf13f9bb2694" target="_blank" rel="external">apache-ant-1.9.9-bin.zip本地下载</a>  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/A10BDE3E38FF477ABDD560B5DAEB4CBE?method=download&amp;shareKey=407a4732d49b42ddec1a7ff1290060dd" alt="ANT流程"><br>jar包这个部分步骤是为下面编译增量包做准备的，因为增量包导出的增量文件，它依赖于整个项目的其他代码，如果没有这些代码的支持是编译不通过。然而又不能直接通过diff得到增量的class，所以只能导出增量文件后，通过引用全部工程的代码的class再进行编译即可  </p>
<p>环境：<br>　　　centos 7.2<br>　　　jdk version 1.7.0_79<br>　　　ant version 1.9.9  </p>
<p>如果报这个错，说明是服务器上目前的JDK版本不正确<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@localhost <span class="built_in">local</span>]<span class="comment"># ant --version</span></div><div class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java.lang.UnsupportedClassVersionError: org/apache/tools/ant/launch/Launcher : Unsupported maj</div><div class="line">or.minor version 52.0	at java.lang.ClassLoader.defineClass1(Native Method)</div><div class="line">	at java.lang.ClassLoader.defineClass(ClassLoader.java:800)</div><div class="line">	at java.security.SecureClassLoader.defineClass(SecureClassLoader.java:142)</div><div class="line">	at java.net.URLClassLoader.defineClass(URLClassLoader.java:449)</div></pre></td></tr></table></figure></p>
<p>官方说明<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">The Apache Ant team currently maintains two lines of development. The 1.9.x releases require Java5 at runtime and 1.10.x requires Java8 at runtime. Both lines are based off of Ant 1.9.7 and the 1.9.x releases are mostly bug fix releases <span class="keyword">while</span> additional new features are developed <span class="keyword">for</span> 1.10.x. We recommend using 1.10.x unless you are required to use versions of Java prior to Java8 during the build process.</div><div class="line"></div><div class="line">Currently, Apache Ant 1.9.9 and 1.10.1 are the best available versions, see the release notes.</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># unzip apache-ant-1.9.9-bin.zip -d /usr/local/</span></div><div class="line">[root@localhost ~]<span class="comment"># tail -2 /etc/profile</span></div><div class="line"><span class="built_in">export</span> ANT_HOME=<span class="string">"/usr/local/apache-ant-1.9.9"</span></div><div class="line"><span class="built_in">export</span> PATH=<span class="string">"<span class="variable">$JAVA_HOME</span>"</span>/bin:<span class="string">"<span class="variable">$ANT_HOME</span>"</span>/bin:<span class="variable">$PATH</span></div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line">[root@localhost ~]<span class="comment"># echo $ANT_HOME</span></div><div class="line">/usr/<span class="built_in">local</span>/apache-ant-1.9.9</div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line">[root@localhost ~]<span class="comment"># java -version</span></div><div class="line">java version <span class="string">"1.7.0_79"</span></div><div class="line">Java(TM) SE Runtime Environment (build 1.7.0_79-b15)</div><div class="line">Java HotSpot(TM) 64-Bit Server VM (build 24.79-b02, mixed mode)</div><div class="line">[root@localhost ~]<span class="comment"># </span></div><div class="line">[root@localhost ~]<span class="comment"># ant -version</span></div><div class="line">Apache Ant(TM) version 1.9.9 compiled on February 2 2017</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>因为这里没有build.xml，所以会报错<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># ant</span></div><div class="line">Buildfile: build.xml does not exist!</div><div class="line">Build failed</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#手动建一个build.xml文件</span></div><div class="line">[root@localhost ~]<span class="comment"># cat build.xml </span></div><div class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"GBK"</span>?&gt;</div><div class="line">&lt;project name=<span class="string">"测试脚本"</span> default=<span class="string">"copyfile"</span> basedir=<span class="string">"."</span> &gt;</div><div class="line">   &lt;target name=<span class="string">"copyfile"</span>&gt;</div><div class="line">      &lt;copy file=<span class="string">"/root/a.txt"</span> todir=<span class="string">"/tmp/"</span> overwrite=<span class="string">"true"</span> /&gt;</div><div class="line">   &lt;/target&gt;</div><div class="line">&lt;/project&gt;</div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#新建一个文件a.txt</span></div><div class="line">[root@localhost ~]<span class="comment"># ll /root/a.txt </span></div><div class="line">-rw-r--r-- 1 root root 21 Jun 19 05:43 /root/a.txt</div><div class="line">[root@localhost ~]<span class="comment"># cat /root/a.txt </span></div><div class="line">My filename is a.txt</div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#执行ant命令</span></div><div class="line">[root@localhost ~]<span class="comment"># ant</span></div><div class="line">Buildfile: /root/build.xml</div><div class="line"></div><div class="line">copyfile:</div><div class="line">     [copy] Copying 1 file to /tmp</div><div class="line"></div><div class="line">BUILD SUCCESSFUL</div><div class="line">Total time: 0 seconds</div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment"># ll /tmp/a.txt </span></div><div class="line">-rw-r--r-- 1 root root 21 Jun 19 05:43 /tmp/a.txt</div><div class="line">[root@localhost ~]<span class="comment"># cat /tmp/a.txt </span></div><div class="line">My filename is a.txt</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h2 id="ANT-Jenkins"><a href="#ANT-Jenkins" class="headerlink" title="ANT+Jenkins  "></a>ANT+Jenkins  </h2><p><img src="http://note.youdao.com/yws/api/personal/file/F2188B73B3AE49838B79E028C8B8F354?method=download&amp;shareKey=3e32cc84bd10237806d7c24099982a89" alt="ant_jenkins_plugin"><br>“Jenkis”— “系统管理”— “Global Tool Configuration”— “Ant”<br><img src="http://note.youdao.com/yws/api/personal/file/8463702CB4F94DE7BEC4C8906486C5F6?method=download&amp;shareKey=8558c7945765f5ddc31c26851ba49d9c" alt="ant_jenkins"><br><img src="http://note.youdao.com/yws/api/personal/file/74E049FDBFF2449CA3426D5F5EC3A0AE?method=download&amp;shareKey=15eb5a00e926b6500123453ed21b3cdf" alt="ant_jenkins"><br><img src="http://note.youdao.com/yws/api/personal/file/63B20CC903C94C6D8DB4700DAAD8732E?method=download&amp;shareKey=462817eadb9468fb14c4775288eab66d" alt="ant_jenkins"><br><img src="http://note.youdao.com/yws/api/personal/file/7BAB9B7AECB44E939DC727F417119555?method=download&amp;shareKey=87b2463a704a2f7a8a97dbd5d39c5874" alt="ant_jenkins">  </p>
<p>这里没有ANT项目就不跑Jenkins了哈  </p>
<p>关于ant的一些用法，参考：<a href="http://www.blogjava.net/amigoxie/archive/2007/11/09/159413.html" target="_blank" rel="external">http://www.blogjava.net/amigoxie/archive/2007/11/09/159413.html</a><br>关于ANT打包的可以参考：<a href="http://www.cnblogs.com/hoojo/p/ant_increment_svn_diff_diffSummarize.html" target="_blank" rel="external">http://www.cnblogs.com/hoojo/p/ant_increment_svn_diff_diffSummarize.html</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/06/19/Ant/">http://www.yfshare.vip/2017/06/19/Ant/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Play Framework]]></title>
      <url>http://www.yfshare.vip/2017/06/19/Play-Framework/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>Play是一个full-stack（全栈的）Java Web应用框架，包括一个简单的无状态MVC模型，具有Hibernate的对象持续，一个基于Groovy的模板引擎，以及建立一个现代Web应用所需的所有东西<br><a id="more"></a></p>
<h2 id="Play-Framework"><a href="#Play-Framework" class="headerlink" title="Play Framework"></a>Play Framework</h2><p>官网：<a href="https://playframework.com/" target="_blank" rel="external">https://playframework.com/</a><br>官网下载页：<a href="https://playframework.com/download" target="_blank" rel="external">https://playframework.com/download</a>  </p>
<p><a href="https://downloads.typesafe.com/play/2.2.6/play-2.2.6.zip" target="_blank" rel="external">官方play-2.2.6.zip下载</a><br><a href="http://note.youdao.com/yws/api/personal/file/0C87E9E4557E46B9895CAF2424BDC154?method=download&amp;shareKey=a6cd1bf9a59a9765a20266de98d9cb29" target="_blank" rel="external">本地play-2.2.6.zip下载</a>  </p>
<p>环境：<br>　　　centos 7.2<br>　　　jdk version 1.7.0_79<br>　　　play version 2.2.6<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># unzip play-2.2.6.zip -d /usr/local/</span></div><div class="line">[root@localhost ~]<span class="comment"># tail -2 /etc/profile</span></div><div class="line"><span class="built_in">export</span> PLAY_HOME=<span class="string">"/usr/local/play-2.2.6"</span></div><div class="line"><span class="built_in">export</span> PATH=<span class="string">"<span class="variable">$PLAY_HOME</span>"</span>:<span class="variable">$PATH</span></div><div class="line">[root@localhost ~]<span class="comment"># echo $PLAY_HOME</span></div><div class="line">/usr/<span class="built_in">local</span>/play-2.2.6</div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#play安装完成</span></div><div class="line">[root@localhost ~]<span class="comment"># play -version</span></div><div class="line">Getting com.typesafe.play console_2.10 2.2.6 ...</div><div class="line">:: retrieving :: org.scala-sbt<span class="comment">#boot-app</span></div><div class="line">	confs: [default]</div><div class="line">	6 artifacts copied, 0 already retrieved (2012kB/72ms)</div><div class="line">Getting Scala 2.10.3 (<span class="keyword">for</span> console)...</div><div class="line">:: retrieving :: org.scala-sbt<span class="comment">#boot-scala</span></div><div class="line">	confs: [default]</div><div class="line">	5 artifacts copied, 0 already retrieved (24447kB/302ms)</div><div class="line">       _</div><div class="line"> _ __ | | __ _ _  _</div><div class="line">| <span class="string">'_ \| |/ _'</span> | || |</div><div class="line">|  __/|_|\____|\__ /</div><div class="line">|_|            |__/</div><div class="line"></div><div class="line">play 2.2.6 built with Scala 2.10.3 (running Java 1.7.0_79), http://www.playframework.com</div><div class="line"></div><div class="line">This is not a play application!</div><div class="line"></div><div class="line">Use `play new` to create a new Play application <span class="keyword">in</span> the current directory,</div><div class="line">or go to an existing application and launch the development console using `play`.</div><div class="line"></div><div class="line">You can also browse the complete documentation at http://www.playframework.com.</div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>创建一个简单的play测试项目<br>play支持<a href="http://www.scala-lang.org/" target="_blank" rel="external">Scala</a>和JAVA，两者均为一种语言<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line">[root@localhost play]<span class="comment"># play new test</span></div><div class="line">       _</div><div class="line"> _ __ | | __ _ _  _</div><div class="line">| <span class="string">'_ \| |/ _'</span> | || |</div><div class="line">|  __/|_|\____|\__ /</div><div class="line">|_|            |__/</div><div class="line"></div><div class="line">play 2.2.6 built with Scala 2.10.3 (running Java 1.7.0_79), http://www.playframework.com</div><div class="line"></div><div class="line">The new application will be created <span class="keyword">in</span> /opt/play/<span class="built_in">test</span></div><div class="line"></div><div class="line">What is the application name? [<span class="built_in">test</span>]</div><div class="line">&gt; Play Jack Wang</div><div class="line">Error: Application name may only contain letters, digits, <span class="string">'_'</span> and <span class="string">'-'</span>, and it must start with a letter.</div><div class="line"></div><div class="line">What is the application name? [<span class="built_in">test</span>]</div><div class="line">&gt; PlayJackWang</div><div class="line"></div><div class="line">Which template <span class="keyword">do</span> you want to use <span class="keyword">for</span> this new application? </div><div class="line"></div><div class="line">  1             - Create a simple Scala application</div><div class="line">  2             - Create a simple Java application</div><div class="line"></div><div class="line">&gt; 1</div><div class="line">OK, application PlayJackWang is created.</div><div class="line"></div><div class="line">Have fun!</div><div class="line"></div><div class="line">[root@localhost play]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@localhost play]<span class="comment"># pwd</span></div><div class="line">/opt/play</div><div class="line">[root@localhost play]<span class="comment"># ll</span></div><div class="line">total 0</div><div class="line">drwxr-xr-x 7 root root 111 Nov 14  2014 <span class="built_in">test</span></div><div class="line">[root@localhost play]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@localhost play]<span class="comment"># tree test/</span></div><div class="line"><span class="built_in">test</span>/</div><div class="line">├── app</div><div class="line">│   ├── controllers</div><div class="line">│   │   └── Application.scala</div><div class="line">│   └── views</div><div class="line">│       ├── index.scala.html</div><div class="line">│       └── main.scala.html</div><div class="line">├── build.sbt</div><div class="line">├── conf</div><div class="line">│   ├── application.conf</div><div class="line">│   └── routes</div><div class="line">├── project</div><div class="line">│   ├── build.properties</div><div class="line">│   └── plugins.sbt</div><div class="line">├── public</div><div class="line">│   ├── images</div><div class="line">│   │   └── favicon.png</div><div class="line">│   ├── javascripts</div><div class="line">│   │   └── jquery-1.9.0.min.js</div><div class="line">│   └── stylesheets</div><div class="line">│       └── main.css</div><div class="line">├── README</div><div class="line">└── <span class="built_in">test</span></div><div class="line">    ├── ApplicationSpec.scala</div><div class="line">    └── IntegrationSpec.scala</div><div class="line"></div><div class="line">10 directories, 14 files</div><div class="line">[root@localhost play]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#然后进入项目所在的目录，使用play run test运行项目</span></div><div class="line">[root@localhost ~]<span class="comment"># cd /opt/play/test/</span></div><div class="line">[root@localhost <span class="built_in">test</span>]<span class="comment"># play run test</span></div><div class="line">Getting org.scala-sbt sbt 0.13.0 ...</div><div class="line">:: retrieving :: org.scala-sbt<span class="comment">#boot-app</span></div><div class="line">	confs: [default]</div><div class="line">	43 artifacts copied, 0 already retrieved (12440kB/128ms)</div><div class="line">[info] Loading project definition from /opt/play/<span class="built_in">test</span>/project</div><div class="line">[info] Set current project to PlayJackWang (<span class="keyword">in</span> build file:/opt/play/<span class="built_in">test</span>/)</div><div class="line">[info] Updating &#123;file:/opt/play/<span class="built_in">test</span>/&#125;test...</div><div class="line">[info] Resolving org.fusesource.jansi<span class="comment">#jansi;1.4 ...</span></div><div class="line">[info] Done updating.</div><div class="line"></div><div class="line">--- (Running the application from SBT, auto-reloading is enabled) ---</div><div class="line"></div><div class="line">[info] play - Listening <span class="keyword">for</span> HTTP on /0:0:0:0:0:0:0:0:9000</div><div class="line"></div><div class="line">(Server started, use Ctrl+D to stop and go back to the console...)</div><div class="line"></div><div class="line">[info] Compiling 5 Scala sources and 1 Java <span class="built_in">source</span> to /opt/play/<span class="built_in">test</span>/target/scala-2.10/classes...</div><div class="line">[info] <span class="string">'compiler-interface'</span> not yet compiled <span class="keyword">for</span> Scala 2.10.3. Compiling...</div><div class="line">[info]   Compilation completed <span class="keyword">in</span> 32.219 s</div><div class="line">[info] play - Application started (Dev)</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># netstat -tunlp | grep 9000</span></div><div class="line">tcp6       0      0 :::9000                 :::*                    LISTEN      1833/java     </div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p><img src="http://note.youdao.com/yws/api/personal/file/B99409B6881747B48705FF1F2D7E877F?method=download&amp;shareKey=0c0856c0fb4939d67c83abe34da011cf" alt="Play_test_page">  </p>
<h2 id="play-jenkins"><a href="#play-jenkins" class="headerlink" title="play+jenkins"></a>play+jenkins</h2><p>Jenkins默认是没有安装play插件的<br><img src="http://note.youdao.com/yws/api/personal/file/FC96C4BC7EF84286A8CC6A1ED3E43BF6?method=download&amp;shareKey=225526bbb9392075748faf612136b920" alt="play_jenkis_plugin">  </p>
<p>“Jenkis”— “系统管理”— “Global Tool Configuration”— “Play”<br><img src="http://note.youdao.com/yws/api/personal/file/D9A306755F8142568B3F32AC8627A363?method=download&amp;shareKey=f420f0459148f03b1bb4d435e6ff36ac" alt="play_jenkis"><br><img src="http://note.youdao.com/yws/api/personal/file/1FEA0ACC282D43E3ACDBA5361D038594?method=download&amp;shareKey=b7f31e23edba5f68ee95f9f374fedca2" alt="play_jenkis"><br><img src="http://note.youdao.com/yws/api/personal/file/7D00987222714E4085837027140E4ECE?method=download&amp;shareKey=5c5c475e2ae5367060a754d1d93a9405" alt="play_jenkis"><br><img src="http://note.youdao.com/yws/api/personal/file/1E77FC528CB447ABBBB14C8FC1E3CCD1?method=download&amp;shareKey=13a71ac5df7a37dcb6f9aede296ccd1f" alt="play_jenkis">  </p>
<p>我没有play项目跑不了Jenkins，这里就不做了哈  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/06/19/Play-Framework/">http://www.yfshare.vip/2017/06/19/Play-Framework/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Java构建工具：Ant vs Maven vs Gradle]]></title>
      <url>http://www.yfshare.vip/2017/06/19/Java%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7%EF%BC%9AAnt-vs-Maven-vs-Gradle/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>最开始时，只有Make一种构建工具，其后来发展为GNU Make。但因需求的发展，码农世界JVM生态圈主要分为三大构建工具：Apache Ant+Ivy，Maven，Gradel<br><a id="more"></a></p>
<h2 id="Ant-with-Ivy"><a href="#Ant-with-Ivy" class="headerlink" title="Ant with Ivy"></a>Ant with Ivy</h2><p>Ant是第一个“现代”构建工具，在很多方面它有些像Make。2000年发布，在很短时间内成为Java项目上最流行的构建工具。它的学习曲线很缓，因此不需要什么特殊的准备就能上手。它基于过程式编程的idea。在最初的版本之后，逐渐具备了支持插件的功能<br>　　主要的不足是用XML作为脚本编写格式XML，本质上是层次化的，并不能很好地贴合Ant过程化编程的初衷。Ant的另外一个问题是，除非是很小的项目，否则它的XML文件很快就大得无法管理。<br>后来，随着通过网络进行依赖管理成为必备功能，Ant采用了Apache Ivy<br>　　Ant的主要优点在于对构建过程的控制上  </p>
<h2 id="Maven"><a href="#Maven" class="headerlink" title="Maven"></a>Maven</h2><p>Maven发布于2004年。目的是解决码农使用Ant所带来的一些问题.<br>　　Maven仍旧使用XML作为编写构建配置的文件格式，但文件结构却有巨大的变化. 　　Ant需要码农将执行task所需的全部命令都一一列出，然而Maven依靠约定(convention)并提供现成的可调用的目标(goal). 不仅如此，Maven具备从网络上自动下载依赖的能力（Ant后来通过Ivy也具备了这个功能），这一点革命性地改变了我们开发软件的方式<br>　　但是，Maven也有它的问题，依赖管理不能很好地处理相同库文件不同版本之间的冲突（Ivy在这方面更好一些）。XML作为配置文件的格式有严格的结构层次和标准，定制化目标（goal）很困难。因为Maven主要聚焦于依赖管理，实际上用Maven很难写出复杂、定制化的构建脚本，甚至不如Ant<br>　　用XML写的配置文件会变得越来越大，越来越笨重。在大型项目中，它经常什么“特别的”事还没干就有几百行代码<br>　　Maven的主要优点是生命周期。只要项目基于一定之规，它的整个生命周期都能够轻松搞定，代价是牺牲了灵活性<br>　　在对DSL（Domain Specific Languages)的热情持续高涨之时，通常的想法是设计一套能够解决特定领域问题的语言。在构建这方面，DSL的一个成功案例就是Gradle  </p>
<h2 id="Gradle"><a href="#Gradle" class="headerlink" title="Gradle"></a>Gradle</h2><p>　　Gradle结合了前两者的优点，在此基础之上做了很多改进。它具有Ant的强大和灵活，又有Maven的生命周期管理且易于使用。最终结果就是一个工具在2012年华丽诞生并且很快地获得了广泛关注。例如，Google采用Gradle作为Android OS的默认构建工具<br>　　Gradle不用XML，它使用基于Groovy的专门的DSL，从而使Gradle构建脚本变得比用Ant和Maven写的要简洁清晰。Gradle样板文件的代码很少，这是因为它的DSL被设计用于解决特定的问题：贯穿软件的生命周期，从编译，到静态检查，到测试，直到打包和部署<br>　　它使用Apache Ivy来处理Jar包的依赖，Gradle的成就可以概括为：约定好，灵活性也高  </p>
<h2 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h2><p>代码库 <a href="https://github.com/vfarcic/JavaBuildTools" target="_blank" rel="external">https://github.com/vfarcic/JavaBuildTools</a> 包含有 Java 代码（两个简单的类和测试代码）， checkstyle 配置文件和 Ant，Ivy，Maven 以及 Gradle 的配置文件<br><a href="http://note.youdao.com/yws/api/personal/file/7738723D6C024979A285E214D81DE264?method=download&amp;shareKey=433ebf4cff1d0256fd18e8e5b5e27af0" target="_blank" rel="external">JavaBuildTools本地下载</a>  </p>
<ul>
<li><p>Any+Ivy<br>Ivy的依赖需要在ivy.xml中指定。我们的例子很简单，只需要依赖JUnit和Hamcrest  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#ivy.xml</span></div><div class="line">&lt;ivy-module version=<span class="string">"2.0"</span>&gt;  </div><div class="line">    &lt;info organisation=<span class="string">"org.apache"</span> module=<span class="string">"java-build-tools"</span>/&gt;  </div><div class="line">    &lt;dependencies&gt;  </div><div class="line">        &lt;dependency org=<span class="string">"junit"</span> name=<span class="string">"junit"</span> rev=<span class="string">"4.11"</span>/&gt;  </div><div class="line">        &lt;dependency org=<span class="string">"org.hamcrest"</span> name=<span class="string">"hamcrest-all"</span> rev=<span class="string">"1.3"</span>/&gt;  </div><div class="line">    &lt;/dependencies&gt;  </div><div class="line">&lt;/ivy-module&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>ANT  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#build.xml</span></div><div class="line">&lt;project xmlns:ivy=<span class="string">"antlib:org.apache.ivy.ant"</span> name=<span class="string">"java-build-tools"</span> default=<span class="string">"jar"</span>&gt;  </div><div class="line">   </div><div class="line">    &lt;property name=<span class="string">"src.dir"</span> value=<span class="string">"src"</span>/&gt;  </div><div class="line">    &lt;property name=<span class="string">"build.dir"</span> value=<span class="string">"build"</span>/&gt;  </div><div class="line">    &lt;property name=<span class="string">"classes.dir"</span> value=<span class="string">"<span class="variable">$&#123;build.dir&#125;</span>/classes"</span>/&gt;  </div><div class="line">    &lt;property name=<span class="string">"jar.dir"</span> value=<span class="string">"<span class="variable">$&#123;build.dir&#125;</span>/jar"</span>/&gt;  </div><div class="line">    &lt;property name=<span class="string">"lib.dir"</span> value=<span class="string">"lib"</span> /&gt;  </div><div class="line">    &lt;path id=<span class="string">"lib.path.id"</span>&gt;  </div><div class="line">        &lt;fileset dir=<span class="string">"<span class="variable">$&#123;lib.dir&#125;</span>"</span> /&gt;  </div><div class="line">    &lt;/path&gt;  </div><div class="line">   </div><div class="line">    &lt;target name=<span class="string">"resolve"</span>&gt;  </div><div class="line">        &lt;ivy:retrieve /&gt;  </div><div class="line">    &lt;/target&gt;  </div><div class="line">   </div><div class="line">    &lt;target name=<span class="string">"clean"</span>&gt;  </div><div class="line">        &lt;delete dir=<span class="string">"<span class="variable">$&#123;build.dir&#125;</span>"</span>/&gt;  </div><div class="line">    &lt;/target&gt;  </div><div class="line">   </div><div class="line">    &lt;target name=<span class="string">"compile"</span> depends=<span class="string">"resolve"</span>&gt;  </div><div class="line">        &lt;mkdir dir=<span class="string">"<span class="variable">$&#123;classes.dir&#125;</span>"</span>/&gt;  </div><div class="line">        &lt;javac srcdir=<span class="string">"<span class="variable">$&#123;src.dir&#125;</span>"</span> destdir=<span class="string">"<span class="variable">$&#123;classes.dir&#125;</span>"</span> classpathref=<span class="string">"lib.path.id"</span>/&gt;  </div><div class="line">    &lt;/target&gt;  </div><div class="line">   </div><div class="line">    &lt;target name=<span class="string">"jar"</span> depends=<span class="string">"compile"</span>&gt;  </div><div class="line">        &lt;mkdir dir=<span class="string">"<span class="variable">$&#123;jar.dir&#125;</span>"</span>/&gt;  </div><div class="line">        &lt;jar destfile=<span class="string">"<span class="variable">$&#123;jar.dir&#125;</span>/<span class="variable">$&#123;ant.project.name&#125;</span>.jar"</span> basedir=<span class="string">"<span class="variable">$&#123;classes.dir&#125;</span>"</span>/&gt;  </div><div class="line">    &lt;/target&gt;  </div><div class="line">   </div><div class="line">&lt;/project&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>设置了几个属性，然后是一个接一个的task。我们用Ivy来处理依赖，清理，编译和打包，这是几乎所有的Java项目都会进行的task，配置有很多<br>运行Ant task来生成Jar文件，执行下面的命令<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ant jar</div></pre></td></tr></table></figure></p>
<ul>
<li>Maven<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#pom.xml</span></div><div class="line">&lt;project xmlns=<span class="string">"http://maven.apache.org/POM/4.0.0"</span>  </div><div class="line">         xmlns:xsi=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span>  </div><div class="line">         xsi:schemaLocation=<span class="string">"http://maven.apache.org/POM/4.0.0  </span></div><div class="line">   </div><div class="line">http://maven.apache.org/maven-v4_0_0.xsd"&gt;  </div><div class="line">   </div><div class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;  </div><div class="line">    &lt;groupId&gt;com.technologyconversations&lt;/groupId&gt;  </div><div class="line">    &lt;artifactId&gt;java-build-tools&lt;/artifactId&gt;  </div><div class="line">    &lt;packaging&gt;jar&lt;/packaging&gt;  </div><div class="line">    &lt;version&gt;1.0&lt;/version&gt;  </div><div class="line">   </div><div class="line">    &lt;dependencies&gt;  </div><div class="line">        &lt;dependency&gt;  </div><div class="line">            &lt;groupId&gt;junit&lt;/groupId&gt;  </div><div class="line">            &lt;artifactId&gt;junit&lt;/artifactId&gt;  </div><div class="line">            &lt;version&gt;4.11&lt;/version&gt;  </div><div class="line">        &lt;/dependency&gt;  </div><div class="line">        &lt;dependency&gt;  </div><div class="line">            &lt;groupId&gt;org.hamcrest&lt;/groupId&gt;  </div><div class="line">            &lt;artifactId&gt;hamcrest-all&lt;/artifactId&gt;  </div><div class="line">            &lt;version&gt;1.3&lt;/version&gt;  </div><div class="line">        &lt;/dependency&gt;  </div><div class="line">    &lt;/dependencies&gt;  </div><div class="line">   </div><div class="line">    &lt;build&gt;  </div><div class="line">        &lt;plugins&gt;  </div><div class="line">            &lt;plugin&gt;  </div><div class="line">                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;  </div><div class="line">                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;  </div><div class="line">                &lt;version&gt;2.3.2&lt;/version&gt;  </div><div class="line">            &lt;/plugin&gt;  </div><div class="line">        &lt;/plugins&gt;  </div><div class="line">    &lt;/build&gt;  </div><div class="line">   </div><div class="line">&lt;/project&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>通过执行下面的命令来运行Maven goal生成Jar文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mvn package</div></pre></td></tr></table></figure></p>
<p>主要的区别在于Maven不需要指定执行的操作，当没有创建task，而是设置了一些参数（有哪些依赖，用哪些插件…)， Maven推行使用约定并提供了开箱即用的goals。Ant和Maven的XML文件都会随时间而变大，为了说明这一点，我们加入CheckStyle，FindBugs和PMD插件来进行静态检查，三者是Java项目中使用很普遍的的工具。我们希望将所有静态检查的执行以及单元测试一起作为一个单独的targetVerify。当然我们还应该指定自定义的checkstyle配置文件的路径并且确保错误时能够提示。更新后的Maven代码如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#pom.xml</span></div><div class="line">&lt;plugin&gt;  </div><div class="line">    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;  </div><div class="line">    &lt;artifactId&gt;maven-checkstyle-plugin&lt;/artifactId&gt;  </div><div class="line">    &lt;version&gt;2.12.1&lt;/version&gt;  </div><div class="line">    &lt;executions&gt;  </div><div class="line">        &lt;execution&gt;  </div><div class="line">            &lt;configuration&gt;  </div><div class="line">                &lt;configLocation&gt;config/checkstyle/checkstyle.xml&lt;/configLocation&gt;  </div><div class="line">                &lt;consoleOutput&gt;<span class="literal">true</span>&lt;/consoleOutput&gt;  </div><div class="line">                &lt;failsOnError&gt;<span class="literal">true</span>&lt;/failsOnError&gt;  </div><div class="line">            &lt;/configuration&gt;  </div><div class="line">            &lt;goals&gt;  </div><div class="line">                &lt;goal&gt;check&lt;/goal&gt;  </div><div class="line">            &lt;/goals&gt;  </div><div class="line">        &lt;/execution&gt;  </div><div class="line">    &lt;/executions&gt;  </div><div class="line">&lt;/plugin&gt;  </div><div class="line">&lt;plugin&gt;  </div><div class="line">    &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;  </div><div class="line">    &lt;artifactId&gt;findbugs-maven-plugin&lt;/artifactId&gt;  </div><div class="line">    &lt;version&gt;2.5.4&lt;/version&gt;  </div><div class="line">    &lt;executions&gt;  </div><div class="line">        &lt;execution&gt;  </div><div class="line">            &lt;goals&gt;  </div><div class="line">                &lt;goal&gt;check&lt;/goal&gt;  </div><div class="line">            &lt;/goals&gt;  </div><div class="line">        &lt;/execution&gt;  </div><div class="line">    &lt;/executions&gt;  </div><div class="line">&lt;/plugin&gt;  </div><div class="line">&lt;plugin&gt;  </div><div class="line">    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;  </div><div class="line">    &lt;artifactId&gt;maven-pmd-plugin&lt;/artifactId&gt;  </div><div class="line">    &lt;version&gt;3.1&lt;/version&gt;  </div><div class="line">    &lt;executions&gt;  </div><div class="line">        &lt;execution&gt;  </div><div class="line">            &lt;goals&gt;  </div><div class="line">                &lt;goal&gt;check&lt;/goal&gt;  </div><div class="line">            &lt;/goals&gt;  </div><div class="line">        &lt;/execution&gt;  </div><div class="line">    &lt;/executions&gt;  </div><div class="line">&lt;/plugin&gt;</div></pre></td></tr></table></figure></p>
<p>通过执行下面的命令来运行Maven goal，包括单元测试，静态检查，如CheckStyle，FindBugs和PMD<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mvn verify</div></pre></td></tr></table></figure></p>
<p>需要写很多XML来进行基本的常用的任务。在实际项目中有更多的依赖和task，Maven的pom.xml很容易就有成百上千行的配置  </p>
<ul>
<li>Gradle<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#build.gradle</span></div><div class="line">apply plugin: <span class="string">'java'</span>  </div><div class="line">apply plugin: <span class="string">'checkstyle'</span>  </div><div class="line">apply plugin: <span class="string">'findbugs'</span>  </div><div class="line">apply plugin: <span class="string">'pmd'</span>  </div><div class="line">   </div><div class="line">version = <span class="string">'1.0'</span>  </div><div class="line">   </div><div class="line">repositories &#123;  </div><div class="line">    mavenCentral()  </div><div class="line">&#125;  </div><div class="line">   </div><div class="line">dependencies &#123;  </div><div class="line">    <span class="built_in">test</span>Compile group: <span class="string">'junit'</span>, name: <span class="string">'junit'</span>, version: <span class="string">'4.11'</span>  </div><div class="line">    <span class="built_in">test</span>Compile group: <span class="string">'org.hamcrest'</span>, name: <span class="string">'hamcrest-all'</span>, version: <span class="string">'1.3'</span>  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>Gradle不仅代码少了很多，对于熟悉的人来说，比Maven要更容易理解，而且它还包括很多Maven代码没有覆盖的有用的task。请执行下面的命令来得到Gradle在当前配置下能够支持的task列表<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gradle tasks --all</div></pre></td></tr></table></figure></p>
<p>清晰性，复杂度和学习曲线<br>对于初学者，Ant是最清晰的。只要读懂XML配置文件你就能够理解它干了些什么，但是，Ant文件很容易变复杂。Maven和Gradle，尤其是Gradle，有很多开箱即用的插件。例如，下面这行代码可能会令那些对Gradle一知半解的人有些困惑，不知道通过这句话就能够使用哪些task<br>build.gradle<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">apply plugin: <span class="string">'java'</span></div></pre></td></tr></table></figure></p>
<p>简单的这一行增加了20多个可用的任务<br>Ant的可读性和Maven的简单性，在我看来，是伪命题，只适用于Gradle学习曲线的初级阶段。一旦用上了Gradle的DSL，就会发现语法比Ant和Maven更加短小精悍、易于理解。不仅如此，只有Gradle既提供了约定也提供了自定义命令。如果说Maven可以通过Ant task来扩展，这似乎有些滑稽可笑，而且低效，Groovy写的Gradle将其提升了一个层次  </p>
<p>原文：<a href="https://technologyconversations.com/2014/06/18/build-tools/" target="_blank" rel="external">https://technologyconversations.com/2014/06/18/build-tools/</a><br><a href="http://blog.csdn.net/bailyzheng/article/details/48395949" target="_blank" rel="external">http://blog.csdn.net/bailyzheng/article/details/48395949</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/06/19/Java构建工具：Ant-vs-Maven-vs-Gradle/">http://www.yfshare.vip/2017/06/19/Java构建工具：Ant-vs-Maven-vs-Gradle/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[CCKiller：Linux轻量级CC攻击防御工具，秒级检查、自动拉黑和释放[转]]]></title>
      <url>http://www.yfshare.vip/2017/06/03/CCKiller%EF%BC%9ALinux%E8%BD%BB%E9%87%8F%E7%BA%A7CC%E6%94%BB%E5%87%BB%E9%98%B2%E5%BE%A1%E5%B7%A5%E5%85%B7%EF%BC%8C%E7%A7%92%E7%BA%A7%E6%A3%80%E6%9F%A5%E3%80%81%E8%87%AA%E5%8A%A8%E6%8B%89%E9%BB%91%E5%92%8C%E9%87%8A%E6%94%BE-%E8%BD%AC/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>DDoS攻击指的是分布式拒绝服务。而CC攻击只是DDoS攻击的一种，本文所阐述的CC攻击，指的是单个IP达到我们设定好的阈值并发请求，而非海量IP的低并发攻击！对于个人低配服务器，除了使用CDN来防护，至少我是没有想到如何抵挡海量IP攻击的！因为每个IP都模拟正常的用户浏览器请求，并不会触发防御阈值，同时来1000个，甚至上万个，个人低配服务器的带宽在第一时间就会被占满，就无法继续提供服务了<br><a id="more"></a><br>当然，用脚本也是无法防御DDoS大流量攻击的，因为所有机房的防御带宽是有限的，当攻击的流量超过了机房的防御带宽，要么机房把你的服务器IP拉黑洞，要么就一起死。因此，如果你的服务器正遭受大流量攻击，比如几十G上百G，一般机房或CDN节点都是扛不住的，脚本也无能为力了，赶紧换高防服务器吧！  </p>
<h2 id="功能介绍"><a href="#功能介绍" class="headerlink" title="功能介绍"></a>功能介绍</h2><p>CCKiller定位：CCKiller是用于个人低配服务器的轻量级CC攻击防御，可以抵挡单个IP产生的高并发攻击。<br>目前设计的功能特性如下：  </p>
<ol>
<li>秒级检查<br>很多人写的防御脚本都是使用了Linux系统的计划任务crontab来定时检查的。而crontab的最细颗粒是1分钟，也就是说脚本最快也只能1分钟检查一次。对于一些强迫症来说就会很不爽。<br>所以，我还是按照以前分享的思路，利用while循环实现秒级检查，实现更细的颗粒。当然，CCKiller更是被我写成了系统服务，更加灵活稳定。  </li>
<li>拉黑时长<br>CCKiller可以设置拉黑时长，默认为10分钟。当发现有恶意请求时，会自动拉黑目标IP，并在拉黑时长结束后自动释放，这个功能算是对我之前写的脚本的一个大的改进。  </li>
<li>并发阈值<br>CCKiller 可以设定单个IP的最高请求数，如果某个IP同时请求数超过了设定的阈值，就会被暂时拉黑一段时间。    </li>
<li>邮件发送<br>这个功能没啥好说的，意义并不大。而且发送成功率和服务器的环境也有很大关系。  </li>
<li>并发显示<br>安装后，直接运行cckiller会列出当前系统的请求排行，可以清晰的看到当前请求IP和并发数。使用-s参数还可以继续定制需求，比如 cckiller -s 10 就能显示当前并发数排行前10名的IP。  </li>
<li>手动拉黑<br>支持手动拉黑，执行后会立即检查，将并发请求超过n的IP拉黑一段时间，比如 cckiller -k 100 就会将目前超过100个请求的IP拉黑一段时间，如果没有则不会执行任何拉黑操作  </li>
</ol>
<h2 id="工具安装"><a href="#工具安装" class="headerlink" title="工具安装"></a>工具安装</h2><ol>
<li><p>在线安装<br>由于可能经常会更新一些功能，或修复一些BUG，所以仅提供在线安装，以保证脚本是最新的  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wget -O install.sh --no-check-certificate https://zhangge.net/wp-content/uploads/files/cckiller/install.sh?ver=1.0.7 &amp;&amp; chmod +x install.sh &amp;&amp; bash install.sh -i</div></pre></td></tr></table></figure>
</li>
<li><p>工具配置<br>因为每个服务器的情况可能不一样，所以有一个自定义配置的过程<br>执行上述安装命令后，将会进入自选配置部分<br><img src="https://res.zgboke.com/wp-content/uploads/2015/09/CCkiller1.png" alt="CCKiller Configuration"><br>提示否使用脚本默认配置，如果选择是（y），那么显示默认配置，并询问是否继续<br><img src="https://res.zgboke.com/wp-content/uploads/2015/09/CCkiller2.png" alt="CCKiller Configuration">  </p>
</li>
</ol>
<p>默认配置如下:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">The Time interval : 20 s       <span class="comment">#每20s检查一次系统请求情况</span></div><div class="line">The Forbidden Time: 600 s  <span class="comment">#拉黑时长设为10分钟</span></div><div class="line">Adminstrator Email: root@localhost   <span class="comment">#邮件对象设置为root@localhost（即关闭邮件发送）</span></div><div class="line">Connections Allow: 100      <span class="comment">#单个IP并发限制为100</span></div></pre></td></tr></table></figure></p>
<p>如果不符合你的需求，你可以使用 ctrl + c 组合键终止脚本，或者先继续安装，因为工具设计了配置修改的功能，所以无需着急。<br>如果不使用默认配置（n），则会要你输入参数来自定义配置<br><img src="https://res.zgboke.com/wp-content/uploads/2015/09/CCkiller3.png?w=480" alt="CCKiller Configuration"><br>如图，我将参数依次定义为每10秒进行检查，拉黑时长为300秒，发件人设置为博客邮箱，并发限制设置为60，回车后会弹出一个提示，让你检查，如果没问题你直接回车就会安装并启动<br><img src="https://res.zgboke.com/wp-content/uploads/2015/09/CCkiller4.png?w=480" alt="CCKiller Configuration">  </p>
<ol>
<li><p>服务控制<br>安装后，会将cckiller注册成系统服务，这时你就可以使用service来控制cckiller了。使用标准的service定义，支持 start | stop | restart | status 四个参数。所以，你可以使用service cckiller stop来停止cckiller，也可以使用service cckiller status来查看状态。  </p>
</li>
<li><p>集成命令<br>成功安装后，系统还会多出一个cckiller的命令，这个命令现有功能如下：<br>cckiller -h可以调出帮助信息：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">CCkiller version 1.0.0 Author: Jager &lt;ge@zhangge.net&gt;</div><div class="line">Copyright ©2015 zhangge.net. All rights reserved. </div><div class="line">Usage: cckiller [OPTIONS] [N]</div><div class="line">N : number of tcp/udp   connections (default 100)</div><div class="line">OPTIONS:</div><div class="line">-h | --help: Show       this <span class="built_in">help</span> screen</div><div class="line">-k | --kill: Block the offending ip making more than N connections</div><div class="line"><span class="_">-s</span> | --show: Show The TOP <span class="string">"N"</span> Connections of System Current</div></pre></td></tr></table></figure>
</li>
</ol>
<p>-k 是拉黑功能，需要在后面带上你想拉黑的并发数，比如 cckiller -k 100 就会拉黑当前请求数大于100的IP一段时间（和拉黑时长一致）<br>-s 是显示并发排名，也需要在后面带上数字，比如 cckiller -s 10 就能显示当前并发数排行前10名的IP。  </p>
<ol>
<li>文件结构<br>如上图所示，脚本安装目录为/usr/local/cckiller，其结构如下  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">cckiller/</div><div class="line">├── cckiller       <span class="comment">#主程序</span></div><div class="line">├── <span class="built_in">log</span>/           <span class="comment">#日志目录（ver 1.0.1新增特性）</span></div><div class="line">├── ck.conf        <span class="comment">#配置文件</span></div><div class="line">├── ignore.ip.list <span class="comment">#白名单</span></div><div class="line">└── install.sh     <span class="comment">#安装和卸载脚本</span></div><div class="line"> </div><div class="line">0 directories, 5 files</div></pre></td></tr></table></figure>
</li>
</ol>
<p>如果你熟悉vim的话，只要编辑ck.conf就可以定义工具参数<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">##### Paths of the script and other files</span></div><div class="line">PROGDIR=<span class="string">"/usr/local/cckiller"</span></div><div class="line">PROG=<span class="string">"/usr/local/cckiller/cckiller"</span></div><div class="line">LOGDIR=<span class="string">"/usr/local/cckiller/log"</span></div><div class="line">IGNORE_IP_LIST=<span class="string">"/usr/local/cckiller/ignore.ip.list"</span></div><div class="line">IPT=<span class="string">"/sbin/iptables"</span></div><div class="line">DKName=CCkiller</div><div class="line">DKVer=1.0.5</div><div class="line"><span class="comment">##### SLEEP_TIME设定检查频率，单位为秒</span></div><div class="line">SLEEP_TIME=10</div><div class="line"><span class="comment">##### NO_OF_CONNECTIONS设定并发限制</span></div><div class="line">NO_OF_CONNECTIONS=60</div><div class="line"><span class="comment">##### EMAIL_TO设定邮件的发送对象</span></div><div class="line">EMAIL_TO=<span class="string">"ge@zhangge.net"</span></div><div class="line"><span class="comment">##### BAN_PERIOD设定拉黑时长，单位为秒</span></div><div class="line">BAN_PERIOD=300</div><div class="line"><span class="comment">##### 设置忽略端口，比如 21,2121,8000 (默认不忽略)</span></div><div class="line">IGNORE_PORT=</div><div class="line"> </div><div class="line"><span class="comment">##### 定义日志级别 INFO,DEBUG,WARNING,OFF (默认 INFO)</span></div><div class="line">LOG_LEVEL=INFO</div></pre></td></tr></table></figure></p>
<p>如果不熟悉也没关系。你还可以执行 ./install.sh -c 进行工具初始化，重新设定所有参数，过程和首次安装时一致  </p>
<ol>
<li><p>白名单<br>工具安装时会默认将系统所有IP都加入白名单，避免自己把自己给拉黑的尴尬。如果你还有其他要加白的IP，可以将IP加入到cckiller安装目录下的ignore.ip.list文件中，每行一个。<br>Ps：目前白名单还不支持IP段，敬请期待后续更新。  </p>
</li>
<li><p>卸载工具<br>有心的朋友可能注意到了install.sh是可以带参数的。写代码的时候已经设计了几个常用的安装卸载功能，具体如下  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#直接执行./install.sh 将会显示如下帮助信息</span></div><div class="line"><span class="comment">###################################################################</span></div><div class="line"><span class="comment">#  CCkiller version 1.0.5 Author: Jager &lt;ge@zhangge.net&gt;          #</span></div><div class="line"><span class="comment">#  For more information please visit http://zhangge.net/5066.html #</span></div><div class="line"><span class="comment">#-----------------------------------------------------------------#</span></div><div class="line"><span class="comment">#  Copyright @2015 zhangge.net. All rights reserved.              #</span></div><div class="line"><span class="comment">###################################################################</span></div><div class="line"> </div><div class="line">Usage: configure.sh [OPTIONS]</div><div class="line"> </div><div class="line">OPTIONS:</div><div class="line">-h | --help : Show <span class="built_in">help</span> of CCkiller</div><div class="line">-u | --update : update Check <span class="keyword">for</span> CCkiller [not available now]</div><div class="line">-c | --config : Edit The configure of CCkiller again</div><div class="line">-i | --install : install CCkiller version 1.0.0 to This System</div><div class="line">-U | --uninstall : Uninstall cckiller from This System</div></pre></td></tr></table></figure>
</li>
</ol>
<p>其中<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">-u 参数用来升级工具，不过目前由于没时间还没写，所以不可用(Ver 1.0.2已支持在线更新)</div><div class="line">-i  参数用来安装工具，如果已安装则会提示并终止</div><div class="line">-c 参数用来配置工具，方便安装后随时修改工具配置</div><div class="line">-U 参数用来卸载工具，注意是大写哦！</div></pre></td></tr></table></figure></p>
<p>可以使用 ./install.sh -U  如图卸载CCKiller<br><img src="https://res.zgboke.com/wp-content/uploads/2015/09/CCkiller6.png?w=480" alt="CCKiller Configuration">  </p>
<h2 id="攻防测试"><a href="#攻防测试" class="headerlink" title="攻防测试"></a>攻防测试</h2><p>成功安装并启用CCKiller之后，我们可以使用压力测试工具来测试拉黑和释放效果，比如webbench 或 ab等。<br>假如CCKiller设定的并发限制为100，检查间隔为10s，使用webbench如下测试：<br>webbench -c 101 -t 60 <a href="http://www.yourwebsite.com/" target="_blank" rel="external">http://www.yourwebsite.com/</a><br>启动测试后，你可以立即去服务器上查看防火墙：<br>iptables -nvL<br>多刷几下，就可以看到webbench所在服务器IP已经在DROP规则中了。<br>确定已被拉黑之后，你等个10分钟再来看防火墙，可以发现webbench所在服务器IP已经消失了，成功释放！<br>Ps：如果邮件发送功能无误，那么应该也收到了工具发来的告警邮件<br><img src="https://res.zgboke.com/wp-content/uploads/2015/09/cckiller5.png?w=480" alt="CCKiller Configuration">  </p>
<h2 id="更多说明"><a href="#更多说明" class="headerlink" title="更多说明"></a>更多说明</h2><ol>
<li>配置并发限制<br>CCKiller配置最大连接数限制时，建议根据单个网页产生的并发数来判断  </li>
</ol>
<ul>
<li>情况A： 你网站做了动静分离，那么静态的请求就到另一个域名了（假设静态资源托管在另一台服务器或是CDN），单个IP请求一个页面可能就只会产生若干并发（假设5个），我们假设某个用户很猛，他喜欢快速拖拽打开你网站的多个网页，比如同时打开10个，那么正常用户的正常最大并发你也可以基本确定了吧？即并发限制：10x5=50。如果有人同时刷新你几十个页面，要说没恶意你也不相信吧？</li>
<li>情况B： 如果没有做动静分离，那么一个页面产生的并发可能就比较多了，每个css、js、图片都会产生一次请求。所以，在这种情况下就需要稍微计算一下你网站单个页面产生的并发请求，比如一个单页面会产生30个请求，那么你也需要考虑用户可能会连续拖拽多个页面的情况，假设我允许用户可以同时刷新10页面，那么并发限制就可以设置为300了，依此类推。<br>容错：从A和B来看，CCKiller其实是有一个盲点的，那就是如果用户IP是某个公司的统一出口，也就是代理上网IP，那么工具就容易误杀无辜了。所以，除了A和B，你还得考虑你网站的受众人群类型。比如，我就一个个人博客，同一时刻被一个公司的多名同时多窗口拖拽访问，这种情况也不多吧？如果可能存在这种受众人群，那么这个并发限制可以设置大一些，避免错杀无辜。当然，拉黑也就10分钟而已，也不至于“一失足成千古恨”。。。<br>当然，不管哪种情况，并发限制都可以比预估设置高那么一些，这个自行斟酌吧！</li>
</ul>
<ol>
<li>不足与完善<br>CCKiller是我最近利用闲暇时间，匆忙之作，难免会有各种问题。也没时间进行测试和完善。不过目前还是有数位站长在使用，暂未反馈异常。当然， 我分享的是在线安装方式，也是为后续的更新提供方便。不过对比我以前写的防御脚本，CCKiller算是有了长足的进步了，很简单的安装，更强大的功能！  </li>
</ol>
<p>附件下载：<a href="http://note.youdao.com/yws/api/personal/file/1BE15B8113864F7284CA87B8EF3880EC?method=download&amp;shareKey=e54bb3abdeac400d66ddbad0eeee88b4" target="_blank" rel="external">CCkiller V1.0.7</a>  </p>
<p>本文非原创，原文请戳：<a href="https://zhangge.net/5066.html" target="_blank" rel="external">https://zhangge.net/5066.html</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/06/03/CCKiller：Linux轻量级CC攻击防御工具，秒级检查、自动拉黑和释放-转/">http://www.yfshare.vip/2017/06/03/CCKiller：Linux轻量级CC攻击防御工具，秒级检查、自动拉黑和释放-转/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[部署Apache+Subversion版本控制系统]]></title>
      <url>http://www.yfshare.vip/2017/05/30/%E9%83%A8%E7%BD%B2Apache-Subversion%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6%E7%B3%BB%E7%BB%9F/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>SVN是Subversion的简称，是一个开放源代码的版本控制系统，采用C/S模式。SVN有2中数据存储模式， 一是Berkeley DB 数据库中存放数据；二是使用普通文件，采用自定义的格式来储存，称为 FSFS<br>两种存储格式各有优缺点，如果需要使用FSFS，在创建版本库的时候加参数“--fs-type fsfs”即可。即：“svnadmin create --fs-type fsfs /data/svn/project”<br><a id="more"></a></p>
<table>
<thead>
<tr>
<th>特性</th>
<th>Berkeley DB</th>
<th>FSFS</th>
</tr>
</thead>
<tbody>
<tr>
<td>对操作中断的敏感</td>
<td>很敏感；系统崩溃或者权限问题会导致数据库“塞住”，需要定期进行恢复</td>
<td>不敏感</td>
</tr>
<tr>
<td>可只读加载</td>
<td>不能</td>
<td>可以</td>
</tr>
<tr>
<td>存储平台无关</td>
<td>不能</td>
<td>可以</td>
</tr>
<tr>
<td>可从网络文件系统访问</td>
<td>不能</td>
<td>可以</td>
</tr>
<tr>
<td>版本库大小</td>
<td>稍大</td>
<td>稍小</td>
</tr>
<tr>
<td>扩展性：修订版本树数量</td>
<td>无限制</td>
<td>某些本地文件系统在处理单一目录包含上千个条目时会出现问题。</td>
</tr>
<tr>
<td>扩展性：文件较多的目录</td>
<td>较慢</td>
<td>较慢</td>
</tr>
<tr>
<td>检出最新代码的速度</td>
<td>较快</td>
<td>可以</td>
</tr>
<tr>
<td>大量提交的速度</td>
<td>较慢，但时间被分配在整个提交操作中</td>
<td>较快，但最后较长的延时可能会导致客户端操作超时</td>
</tr>
<tr>
<td>组访问权处理</td>
<td>对于用户的 umask 设置十分敏感，最好只由一个用户访问</td>
<td>对 umask 设置不敏感</td>
</tr>
<tr>
<td>功能成熟时间</td>
<td>2001 年</td>
<td>2004 年</td>
</tr>
</tbody>
</table>
<h2 id="安装SVN"><a href="#安装SVN" class="headerlink" title="安装SVN"></a>安装SVN</h2><p>环境：<br>　　　Centos 7.2<br>　　　Subversion 1.7.14<br>　　　Apache 2.4.6  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># yum -y install svn</span></div><div class="line">[root@localhost ~]<span class="comment"># svnserve --version </span></div><div class="line">svnserve, version 1.7.14 (r1542130)</div><div class="line">···</div><div class="line">[root@localhost ~]<span class="comment"># mkdir -p /data/svn</span></div><div class="line">[root@localhost ~]<span class="comment"># svnadmin create /data/svn/project</span></div><div class="line">[root@localhost ~]<span class="comment"># ll /data/svn/project/</span></div><div class="line">total 16</div><div class="line">drwxr-xr-x 2 root root   51 May 31 00:17 conf      <span class="comment">#conf 目录下存放了版本库的配置文件，包括用户访问控制和权限控制等内容</span></div><div class="line">drwxr-sr-x 6 root root 4096 May 31 00:17 db        <span class="comment">#db 目录下存放着 Subversion 所要管理的所有受版本控制的数据</span></div><div class="line">-r--r--r-- 1 root root    2 May 31 00:17 format    <span class="comment">#format 文件记录了版本库的布局版本号</span></div><div class="line">drwxr-xr-x 2 root root 4096 May 31 00:17 hooks     <span class="comment">#hooks 目录存放着钩子脚本及其模版(一种版本库事件触发程序)</span></div><div class="line">drwxr-xr-x 2 root root   39 May 31 00:17 locks     <span class="comment">#locks 目录存放着 Subversion 版本库锁定数据</span></div><div class="line">-rw-r--r-- 1 root root  229 May 31 00:17 README.txt</div><div class="line">[root@localhost ~]<span class="comment"># cd /data/svn/project/conf/</span></div><div class="line">[root@localhost conf]<span class="comment"># grep -v ^# passwd | grep -v ^$</span></div><div class="line">[users]</div><div class="line">jack = jackpass</div><div class="line">bob = bobpass</div><div class="line">[root@localhost conf]<span class="comment"># grep -v ^# authz | grep -v ^$</span></div><div class="line">[aliases]</div><div class="line">[groups]</div><div class="line">admin = jack</div><div class="line">[/]</div><div class="line">@admin = rw</div><div class="line">[/svn_test]</div><div class="line">bob = r</div><div class="line">[root@localhost conf]<span class="comment"># grep -v ^# svnserve.conf | grep -v ^$</span></div><div class="line">[general]</div><div class="line">anon-access = none</div><div class="line">auth-access = write</div><div class="line">password-db = passwd</div><div class="line">authz-db = authz</div><div class="line">[sasl]</div><div class="line">[root@localhost conf]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#导入项目</span></div><div class="line">[root@localhost ~]<span class="comment"># svn import /tmp/svncode/ file:///data/svn/project/ --message "init"</span></div><div class="line">···</div><div class="line">Adding         /tmp/svncode/svn_test/<span class="built_in">test</span>9.txt</div><div class="line">Adding         /tmp/svncode/svn_test/<span class="built_in">test</span>1.txt</div><div class="line">Adding         /tmp/svncode/svn_test/<span class="built_in">test</span>10.txt</div><div class="line"></div><div class="line">Committed revision 1.</div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#查看项目是否导入成功</span></div><div class="line">[root@localhost ~]<span class="comment"># svn list --verbose file:///data/svn/project/</span></div><div class="line">      1 root                  May 31 00:25 ./</div><div class="line">      1 root                  May 31 00:25 svn_test/</div><div class="line">      1 root                  May 31 00:25 svn_uu/</div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#查看最新修订版本的信息</span></div><div class="line">[root@localhost ~]<span class="comment"># svnlook info /data/svn/project/</span></div><div class="line">root</div><div class="line">2017-05-31 00:25:41 +0800 (Wed, 31 May 2017)</div><div class="line">4</div><div class="line">init</div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#显示版本库的具体树形结构，“--show-ids”指定显示每一个显示元素的修改版本 ID</span></div><div class="line">[root@localhost ~]<span class="comment"># svnlook tree /data/svn/project/ --show-ids</span></div><div class="line">/ &lt;0.0.r1/4948&gt;</div><div class="line"> svn_test/ &lt;n-1.0.r1/2515&gt;</div><div class="line">  <span class="built_in">test</span>2.txt &lt;o-1.0.r1/697&gt;</div><div class="line">  <span class="built_in">test</span>3.txt &lt;r-1.0.r1/873&gt;</div><div class="line">  <span class="built_in">test</span>4.txt &lt;t-1.0.r1/1049&gt;</div><div class="line">  <span class="built_in">test</span>5.txt &lt;v-1.0.r1/1226&gt;</div><div class="line">  <span class="built_in">test</span>6.txt &lt;x-1.0.r1/1403&gt;</div><div class="line">  <span class="built_in">test</span>7.txt &lt;z-1.0.r1/1580&gt;</div><div class="line">  <span class="built_in">test</span>8.txt &lt;11-1.0.r1/1758&gt;</div><div class="line">  <span class="built_in">test</span>9.txt &lt;13-1.0.r1/1937&gt;</div><div class="line">  <span class="built_in">test</span>1.txt &lt;15-1.0.r1/340&gt;</div><div class="line">  <span class="built_in">test</span>10.txt &lt;17-1.0.r1/518&gt;</div><div class="line"> svn_uu/ &lt;0-1.0.r1/4740&gt;</div><div class="line">  uu8.txt &lt;j-1.0.r1/4016&gt;</div><div class="line">  uu9.txt &lt;l-1.0.r1/4189&gt;</div><div class="line">  uu1.txt &lt;2-1.0.r1/2638&gt;</div><div class="line">  uu10.txt &lt;5-1.0.r1/2809&gt;</div><div class="line">  uu2.txt &lt;7-1.0.r1/2982&gt;</div><div class="line">  uu3.txt &lt;9-1.0.r1/3154&gt;</div><div class="line">  uu4.txt &lt;b-1.0.r1/3326&gt;</div><div class="line">  uu5.txt &lt;d-1.0.r1/3498&gt;</div><div class="line">  uu6.txt &lt;f-1.0.r1/3670&gt;</div><div class="line">  uu7.txt &lt;h-1.0.r1/3843&gt;</div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#启动svn</span></div><div class="line">[root@localhost ~]<span class="comment"># svnserve -d -r /data/svn/project/</span></div><div class="line">[root@localhost ~]<span class="comment"># netstat -tunlp | grep 3690</span></div><div class="line">tcp        0      0 0.0.0.0:3690            0.0.0.0:*               LISTEN      2054/svnserve       </div><div class="line">[root@localhost ~]<span class="comment"># ps -ef | grep svn</span></div><div class="line">root       2078      1  0 00:34 ?        00:00:00 svnserve <span class="_">-d</span> -r /data/svn/project/</div><div class="line">root       2094   1126  0 00:37 pts/0    00:00:00 grep --color=auto svn</div><div class="line">[root@localhost ~]<span class="comment"># tail -1 /etc/rc.local </span></div><div class="line">svnserve <span class="_">-d</span> -r /data/svn/project/</div><div class="line">[root@localhost ~]<span class="comment"># systemctl enable svnserve</span></div></pre></td></tr></table></figure>
<p><img src="http://note.youdao.com/yws/api/personal/file/89409706F81647A290F91354249174AC?method=download&amp;shareKey=3b306443717b5fd01c8f1da22e8d6af5" alt="svn_Verification"><br><img src="http://note.youdao.com/yws/api/personal/file/338B32D5033648068533FA9F11EFBBF4?method=download&amp;shareKey=033155feaedb437e1ab33e0de4645b09" alt="svn_Verification"><br>SVN安装成功  </p>
<h2 id="安装Apache"><a href="#安装Apache" class="headerlink" title="安装Apache"></a>安装Apache</h2><p>通过 Http 协议可更方便的访问 Subversion 版本库，只需要打开浏览器，输入 URL 即可轻松的浏览整个版本库<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># yum -y install httpd mod_dav_svn</span></div><div class="line">[root@localhost ~]<span class="comment"># httpd -version</span></div><div class="line">Server version: Apache/2.4.6 (CentOS)</div><div class="line">Server built:   Apr 12 2017 21:03:28</div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line">[root@localhost ~]<span class="comment"># chown apache:apache /data/svn/project/ -R</span></div><div class="line">[root@localhost ~]<span class="comment"># cd /data/svn/project/</span></div><div class="line">[root@localhost project]<span class="comment"># htpasswd -cm htpassword jack</span></div><div class="line">New password: </div><div class="line">Re-type new password: </div><div class="line">Adding password <span class="keyword">for</span> user jack</div><div class="line">[root@localhost project]<span class="comment"># cat htpassword </span></div><div class="line">jack:<span class="variable">$apr1</span><span class="variable">$wqsFKPQo</span><span class="variable">$XwD1nh1Y7OPX</span>.62dQIMt..</div><div class="line">[root@localhost project]<span class="comment">#</span></div><div class="line">[root@localhost project]<span class="comment"># chmod 644 htpassword</span></div></pre></td></tr></table></figure></p>
<h2 id="Apache与Subversion结合"><a href="#Apache与Subversion结合" class="headerlink" title="Apache与Subversion结合"></a>Apache与Subversion结合</h2><p>由于 Subversion 需要版本化的控制，因此标准的 Http 协议不能满足需求。要让 Apache 与 Subversion 协同工作，需要使用 WebDAV（Web 分布式创作和版本控制）。WebDAV 是 HTTP 1.1 的扩展，关于 WebDAV 的规范和工作原理，参考：<a href="http://www.ietf.org/rfc/rfc2518.txt" target="_blank" rel="external">http://www.ietf.org/rfc/rfc2518.txt</a><br>为了使 Subversion 与 dav 模块通信，需要安装 mod_dav_svn 插件。默认情况下没有安装，至少我这里是这样的<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># cd /etc/httpd/modules/</span></div><div class="line">[root@localhost modules]<span class="comment"># ll | grep -i mod_dav_svn.so</span></div><div class="line">-rwxr-xr-x 1 root root 181336 Nov 21  2015 mod_dav_svn.so</div><div class="line">[root@localhost modules]<span class="comment"># ll | grep -i mod_dav.so</span></div><div class="line">-rwxr-xr-x 1 root root 102400 Apr 13 05:04 mod_dav.so</div><div class="line">[root@localhost modules]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment"># cd /etc/httpd/</span></div><div class="line">[root@localhost httpd]<span class="comment"># tail -1 conf/httpd.conf </span></div><div class="line">IncludeOptional conf.d/*.conf</div><div class="line">[root@localhost httpd]<span class="comment">#</span></div><div class="line">[root@localhost httpd]<span class="comment"># cat conf.d/subversion.conf </span></div><div class="line"><span class="comment">#使用mod_authz_svn进行目录访问控制</span></div><div class="line">LoadModule dav_svn_module     modules/mod_dav_svn.so  </div><div class="line">LoadModule authz_svn_module   modules/mod_authz_svn.so  </div><div class="line">&lt;Location /svn&gt;  </div><div class="line">    DAV svn</div><div class="line">    SVNPath <span class="string">"/data/svn/project/"</span></div><div class="line">    AuthType Basic</div><div class="line">    AuthName <span class="string">"svn repos"</span></div><div class="line">    AuthUserFile <span class="string">"/data/svn/project/htpassword"</span>         <span class="comment">#前面用htpasswd生成的认证文件</span></div><div class="line">    AuthzSVNAccessFile <span class="string">"/data/svn/project/conf/authz"</span>   <span class="comment">#SVN的 authz 的策略文件</span></div><div class="line">    Satisfy Any    <span class="comment">#用户验证机制，值为all|any。用于一个目录同时被这两个规则作用，All要同时满足两个条件，Any只要满足一个即可</span></div><div class="line">    Require valid-user  </div><div class="line">&lt;/Location&gt;</div><div class="line">[root@localhost httpd]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment"># systemctl start httpd</span></div><div class="line">[root@localhost ~]<span class="comment"># systemctl enable httpd</span></div></pre></td></tr></table></figure></p>
<p>初始版本库<br><img src="http://note.youdao.com/yws/api/personal/file/C0BD1F9006CC454393CF7903F9926513?method=download&amp;shareKey=f98af9c334e20895e824ada31a229f8a" alt="Apache+subversion"><br>这样做的好处是，用户访问管理员给的URL时，首先需要通过Apache的登录验证，再验证SVN的 authz ，两者都满足时，才能正常访问，且用户无法点上面的两个冒号切到上级目录(这时会切到初始版本库)，如下图<br><img src="http://note.youdao.com/yws/api/personal/file/2A63A05A9B25417CBAFE367776149434?method=download&amp;shareKey=875898daa6381f0bda59d2e0a9b5bc0e" alt="Apache+subversion"><br>如果用户满足了Apache的登录验证，但不满足SVN的验证，则会出现下图所示的情况<br><img src="http://note.youdao.com/yws/api/personal/file/05738EAFB7E74A749D1A571B618D118E?method=download&amp;shareKey=7a2c55cce635dffb0bd8ac0c93dce879" alt="Apache+subversion">  </p>
<p>如果启动报下面这个错误，是因为没有安装mod_dav_svn，而在apache和subversion通讯需要加载“mod_dav_svn.so”和“mod_authz_svn.so”模块<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">May 31 01:42:22 localhost httpd[11633]: Unknown DAV provider: svn</div></pre></td></tr></table></figure></p>
<p>如果通过浏览器访问，出现下面信息，说明我们部署是没有问题的，只是访问URL搞错了<br>在subversion.conf中如果配置“<location svn="">”，则浏览器访问时的URL为：<a href="http://ip/svn" target="_blank" rel="external">http://ip/svn</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">( success ( 2 2 ( ) ( edit-pipeline svndiff1 absent-entries commit-revprops depth <span class="built_in">log</span>-revprops atomic-revprops partial-replay ) ) )</div></pre></td></tr></table></figure></location></p>
<p>关于其他配置可以参考：<a href="https://www.ibm.com/developerworks/cn/java/j-lo-apache-subversion/" target="_blank" rel="external">https://www.ibm.com/developerworks/cn/java/j-lo-apache-subversion/</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/05/30/部署Apache-Subversion版本控制系统/">http://www.yfshare.vip/2017/05/30/部署Apache-Subversion版本控制系统/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Hexo maupassant主题添加disqus评论系统]]></title>
      <url>http://www.yfshare.vip/2017/05/21/Hexo-maupassant%E4%B8%BB%E9%A2%98%E6%B7%BB%E5%8A%A0disqus%E8%AF%84%E8%AE%BA%E7%B3%BB%E7%BB%9F/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>需求：给博客添加评论系统<br>之前博客用的是多说评论系统，但是最近收到多说官方消息说将在2017年6月1日关闭多说评论系统，消息来源：<a href="http://dev.duoshuo.com/threads/58d1169ae293b89a20c57241" target="_blank" rel="external">http://dev.duoshuo.com/threads/58d1169ae293b89a20c57241</a> 。但是博客又不能没有评论系统，所以呢，所以呢就是更换评论系统咯<br><a id="more"></a><br><img src="http://note.youdao.com/yws/api/personal/file/3A52CC3A48384DA5AD3B5F47F895CC74?method=download&amp;shareKey=0a9e3d2f5589d24c85b0caf103918e05" alt="多说评论系统关闭公告"><br><img src="http://note.youdao.com/yws/api/personal/file/47D6CA8467374D12BFF55EDE87EE0DB4?method=download&amp;shareKey=e525c6a55b2d70de348771e38fbf7f6f" alt="多说评论系统关闭公告">  </p>
<p>有网友建议多说把代码开源或者出售，以后可能还能用哦，关于<a href="http://www.yfshare.vip/2017/02/14/Hexo-maupassant主题添加多说评论系统/">Hexo-maupassant主题添加多说评论系统</a>在这里  </p>
<p>效果图：<br><img src="http://note.youdao.com/yws/api/personal/file/E1C7457599194CB6821E80F0C94F9C83?method=download&amp;shareKey=5adabaadfcc0caffeca8feedc7ee8fb3" alt="Disqus评论系统">  </p>
<p>首先，我们需要在<a href="https://disqus.com/" target="_blank" rel="external">disqus官网</a>注册一个帐号：<a href="https://disqus.com/profile/signup/" target="_blank" rel="external">注册跳转点这里</a>，如果有disqus帐号，<a href="https://disqus.com/profile/login/" target="_blank" rel="external">登录跳转点这里</a>  </p>
<p><a href="https://disqus.com/admin/create/" target="_blank" rel="external">创建站点</a><br>路径为：Qisqus – settings – Add Disqus to your site<br><img src="http://note.youdao.com/yws/api/personal/file/3C7B727A7F044CDAAAEEBF71F7C5BD55?method=download&amp;shareKey=a81f853f49144e8b7f616178fbf24bd1" alt="disqus_set"><br><img src="http://note.youdao.com/yws/api/personal/file/73D3129E829D4ED5A82D9F0B3F5AFC50?method=download&amp;shareKey=2c45935589cfbad7c82bd066dda4b387" alt="disqus_set">  </p>
<p>提交后，然后找到本地Hexo的maupassant主题目录(themes\maupassant)，这里就说它了<br>在maupassant主题目录(themes\maupassant)下有个_config.yml文件，在disqus项填上刚在disqus系统上注册的short_name即可<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#这里的disqus_shortname就是在disqus创建站点时的Website Name</span></div><div class="line">$ grep -i <span class="string">'^disqus'</span> themes/maupassant/_config.yml</div><div class="line">disqus: yfshare <span class="comment">## Your disqus_shortname, e.g. username</span></div><div class="line">$</div></pre></td></tr></table></figure></p>
<p>配置好后，重新提交到Github即可  </p>
<p>注：Disqus是国外的网站，要拨VPN才能流畅的访问，我在我自己的博客添加了Disqus评论系统后，拨了VPN可以正常显示，但断开VPN好像就不能显示了，纠结~。。可见文章底部  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/05/21/Hexo-maupassant主题添加disqus评论系统/">http://www.yfshare.vip/2017/05/21/Hexo-maupassant主题添加disqus评论系统/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[JDBC执行Mysql存储过程报权限错误]]></title>
      <url>http://www.yfshare.vip/2017/05/17/JDBC%E6%89%A7%E8%A1%8CMysql%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E6%8A%A5%E6%9D%83%E9%99%90%E9%94%99%E8%AF%AF/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>今天开发向我反馈说Mysql账户不能调用存储过程，说没有权限，沟通后说是用tomcat配置JDBC连接的Mysql数据库的<br><a id="more"></a><br>报错信息如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java.sql.SQLException: User does not have access to metadata required to determine stored procedure parameter types. If rights can not be granted, configure connection with <span class="string">"noAccessToProcedureBodies=true"</span> to have driver generate parameters that represent INOUT strings irregardless of actual parameter types</div></pre></td></tr></table></figure></p>
<p>经过查阅资料得知，JDBC在调用存储过程时不光用户要有execute的权限，还需要对mysql.proc具有访问权限。否则它无法访问metadata<br>有两种解决办法：  </p>
<ul>
<li>给数据库连接设置一个noAccessToProcedureBodies属性，属性值为true  </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jdbc:mysql://ipaddress:3306/<span class="built_in">test</span>?noAccessToProcedureBodies=<span class="literal">true</span></div></pre></td></tr></table></figure>
<p>网上说设置noAccessToProcedureBodies=true会带来一些影响(未经考证):  </p>
<ol>
<li>调用存储过程时，将没有类型检查，设为字符串类型，并且所有的参数设为int类型，但是在调用registerOutParameter时，不抛出异常  </li>
<li>存储过程的查询结果无法使用getXXX(String parameterName)的形式获取，只能通过getXXX(int parameterIndex)的方式获取  </li>
</ol>
<ul>
<li>给数据库用户赋权，赋执行mysql.proc表的select权限  </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GRANT SELECT ON mysql.proc TO <span class="string">'user'</span>@<span class="string">'localhost'</span>;</div></pre></td></tr></table></figure>
<p>参考：<br><a href="http://stackoverflow.com/questions/986628/mysql-java-cant-execute-stored-procedure" target="_blank" rel="external">http://stackoverflow.com/questions/986628/mysql-java-cant-execute-stored-procedure</a><br><a href="http://space.itpub.net/18945822/viewspace-683363" target="_blank" rel="external">http://space.itpub.net/18945822/viewspace-683363</a><br><a href="http://cau99.blog.51cto.com/1855224/348792" target="_blank" rel="external">http://cau99.blog.51cto.com/1855224/348792</a><br><a href="http://www.cnblogs.com/AloneSword/p/3591702.html" target="_blank" rel="external">http://www.cnblogs.com/AloneSword/p/3591702.html</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/05/17/JDBC执行Mysql存储过程报权限错误/">http://www.yfshare.vip/2017/05/17/JDBC执行Mysql存储过程报权限错误/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[KVM网络模式详解]]></title>
      <url>http://www.yfshare.vip/2017/05/14/KVM%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%BC%8F%E8%AF%A6%E8%A7%A3/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>KVM 客户机网络连接分为三种模式：host-only、NAT、Bridge<br><a id="more"></a>  </p>
<ul>
<li>host-only：看网上说也叫隔离模式，个人理解就类似于Vmware的仅主机模式，意思就是将所有的虚拟机组成一个局域网，不能和外界通信，不能访问Internet，其他主机也不能访问虚拟主机，安全性高。</li>
<li>NAT方式： 用户网络（User Networking）：让虚拟机访问主机、互联网或本地网络上的资源的简单方法，但是不能从网络或其他的客户机访问客户机，性能上也需要大的调整。</li>
<li>Bridge方式：虚拟网桥（Virtual Bridge）：这网络模式下客户机与宿主机处于同一网络环境，类似于一台真实的宿主机，直接访问网络资源，设置好后客户机与互联网，客户机与主机之间的通信都很容易。</li>
</ul>
<p>host-only<br>仅(虚拟)主机模式比较简单，拓扑图如下<br><img src="http://note.youdao.com/yws/api/personal/file/B315F0517F214AB38C08CA511269ECF5?method=download&amp;shareKey=5030a88551480e95137fef3895355a63" alt="host_only">  </p>
<p>桥接网络<br>Bridge方式，即客户机通过网桥连接到宿主机网络环境中，可以使客户机成为网络中具有独立IP的主机<br>注：客户机，即用KVM安装在linux宿主机中的虚拟机<br>桥接网络，也叫物理设备共享，被用作把一个物理设备复制到一台虚拟机<br><img src="http://note.youdao.com/yws/api/personal/file/98989AB92F8041D88C02ABC8A70434F2?method=download&amp;shareKey=130bdf969e2631fe19cbd16bc5936ff2" alt="Bridge"><br>网桥的基本原理就是创建一个桥接接口，并把物理主机的eth0绑定到网桥上，客户机的网络模式需要配置为桥接模式  </p>
<p>NAT网络<br>NAT方式是kvm安装后的默认方式。支持主机与虚拟机的互访，同时也支持虚拟机访问互联网，但不支持外界访问虚拟机<br>virbr0是由宿主机KVM相关模块安装的一个虚拟网络接口（TAP设备），也是一个switch和bridge，负责把内容分发到各虚拟机<br><img src="http://note.youdao.com/yws/api/personal/file/119EF0ED28464FD288E8FB5DF2B3244C?method=download&amp;shareKey=ebbd237b51390893e2bc5200e3765811" alt="NAT"><br><img src="http://note.youdao.com/yws/api/personal/file/163C1296BBC545088C2F6B5A787AD199?method=download&amp;shareKey=a36657a903506b6e3a854228fa00d701" alt="NAT"><br>virbr0是一个桥接器，给虚拟机群虚拟了一个局域网，这个局域网的网络号默认为 192.168.122.0<br>virbr0是kvm虚拟机NAT网络模式的重要角色，相当于Wmware中NAT网络模式中的虚拟NAT服务器<br>同时kvm 安装时默认 NAT 网络模式，他会修改宿主机的 iptables 规则，来实现 NAT网络模式的功能  </p>
<p>参考：<a href="http://blog.csdn.net/cooling88/article/details/52203998" target="_blank" rel="external">http://blog.csdn.net/cooling88/article/details/52203998</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/05/14/KVM网络模式详解/">http://www.yfshare.vip/2017/05/14/KVM网络模式详解/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[部署KVM虚拟机之命令行操作]]></title>
      <url>http://www.yfshare.vip/2017/05/14/%E9%83%A8%E7%BD%B2KVM%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B9%8B%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%93%8D%E4%BD%9C/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>随记，这样操作键盘会错位，不晓得为啥会这样，但不影响使用<br>建议使用配置文件来安装KVM虚拟机，就不会出现这个问题了，参考：<a href="http://www.yfshare.vip/2017/05/14/部署KVM虚拟机/">http://www.yfshare.vip/2017/05/14/部署KVM虚拟机/</a><br><a id="more"></a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#本地iso源安装KVM虚拟机</span></div><div class="line">[root@localhost ~]<span class="comment"># virt-install --name=Kvm_centos6.6 \</span></div><div class="line">--ram 512 \</div><div class="line">--vcpus=1 \</div><div class="line">--disk path=/kvm_data/centos6.6/centos.img,size=30 \</div><div class="line">--accelerate \</div><div class="line">--cdrom=/iso/CentOS-6.6-x86_64-bin-DVD1.iso \</div><div class="line">--graphics vnc,password=123456,port=5920 \</div><div class="line">--network bridge=br0 \</div><div class="line">--force --autostart</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>注：如果使用本地源(iso)，加参数–cdrom=；如果使用网络源，加参数–location ‘<a href="http://mirrors.aliyun.com/centos/6/os/x86_64/" target="_blank" rel="external">http://mirrors.aliyun.com/centos/6/os/x86_64/</a>‘  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#使用网络源安装KVM虚拟机</span></div><div class="line">[root@localhost ~]<span class="comment"># virt-install \</span></div><div class="line">--name Kvm_centos6.6 \</div><div class="line">--ram 512 \</div><div class="line">--disk path=/kvm_data/centos6.6/centos.img,size=30 \</div><div class="line">--vcpus 1 \</div><div class="line">--os-type linux \</div><div class="line">--os-variant rhel6 \</div><div class="line">--network bridge=br0 \</div><div class="line">--graphics none \</div><div class="line">--console pty,target_type=serial \</div><div class="line">--location <span class="string">'http://mirrors.aliyun.com/centos/6/os/x86_64/'</span> \</div><div class="line">--extra-args <span class="string">'console=ttyS0,115200n8 serial'</span></div></pre></td></tr></table></figure>
<p>说明：<br>–name  指定虚拟机的名字<br>–ram 指定内存分配多少<br>–vcpus 指定分配cpu几个<br>–os-type 指定系统类型为linux<br>–os-variant 指定系统版本<br>–network  指定网络类型<br>–graphics 指定安装通过哪种类型，可以是vnc，也可以没有图形，在这里我们没有使用图形直接使用文本方式<br>–console 指定控制台类型<br>–disk path 指定虚拟磁盘放到哪里，size=30 指定磁盘大小为30G,这样磁盘文件格式为raw，raw格式不能做快照，后面有说明，需要转换为qcow2格式，如果要使用qcow2格式的虚拟磁盘，需要事先创建qcow2格式的虚拟磁盘。 参考  <a href="http://www.361way.com/kvm-qcow2-preallocation-metadata/3354.html" target="_blank" rel="external">http://www.361way.com/kvm-qcow2-preallocation-metadata/3354.html</a><br>–extra-args 设定内核参数<br>–location 指定网络安装介质地址(http/nfs)<br>–cdrom 指定本地安装介质(iso)  </p>
<p>注：这样操作，好像键盘会错位，不晓得为啥，可以凑合着用<br>如果宿主机(linux有图形化界面的话，可以用Virtual Machine Manager也一样)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># qemu-img info /kvm_data/centos6.6/centos.img</span></div><div class="line">image: /kvm_data/centos6.6/centos.img</div><div class="line">file format: raw</div><div class="line">virtual size: 30G (32212254720 bytes)</div><div class="line">disk size: 1.9G</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>使用virt-install 工具安装虚拟机后，会在/etc/libvirt/qemu/目录下生成Kvm_centos6.6.xml文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># virsh list --all</span></div><div class="line"> Id    Name                           State</div><div class="line">----------------------------------------------------</div><div class="line"> 7     Kvm_centos6.6                  running</div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#开机自动启动虚拟机</span></div><div class="line">[root@localhost ~]<span class="comment"># virsh autostart Kvm_centos6.6</span></div><div class="line">Domain Kvm_centos6.6 marked as autostarted</div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># ll  /var/lib/libvirt/qemu</span></div><div class="line">total 12</div><div class="line">drwxr-xr-x 2 root root 4096 May 12 11:23 dump</div><div class="line">srwxr-xr-x 1 qemu qemu    0 May 12 13:51 Kvm_centos6.6.monitor   </div><div class="line">drwxr-xr-x 2 qemu qemu 4096 May 12 11:23 save</div><div class="line">drwxr-xr-x 2 qemu qemu 4096 May 12 11:23 snapshot</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># top -d 1 | grep kvm</span></div><div class="line">  2552 qemu      20   0  855m 241m 5804 S 15.9 24.6  18:24.97 qemu-kvm</div><div class="line">  2552 qemu      20   0  855m 241m 5804 R 15.9 24.6  18:25.13 qemu-kvm</div><div class="line">  2552 qemu      20   0  855m 241m 5804 R 12.9 24.6  18:25.26 qemu-kvm</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>修改KVM虚拟机磁盘格式：<br>参考：<a href="https://www.ibm.com/developerworks/cn/linux/1409_qiaoly_qemuimgages/" target="_blank" rel="external">https://www.ibm.com/developerworks/cn/linux/1409_qiaoly_qemuimgages/</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#kvm默认是raw磁盘格式，这里可在安装时指定为qcow2磁盘格式</span></div><div class="line">qemu-img create <span class="_">-f</span> qcow2 -o preallocation=metadata  /data/daixuan2.img 10G</div><div class="line">[root@localhost ~]<span class="comment"># virt-install \</span></div><div class="line">--name centos \</div><div class="line">--ram 512 \</div><div class="line">--disk path=/data/centos.img,format=qcow2,size=10,bus=virtio \</div><div class="line">--vcpus 1 \</div><div class="line">--os-type linux \</div><div class="line">--os-variant rhel6 \</div><div class="line">--network bridge=br1 \</div><div class="line">--graphics none \</div><div class="line">--console pty,target_type=serial \</div><div class="line">--location <span class="string">'http://mirrors.163.com/centos/6.7/os/x86_64/'</span> \</div><div class="line">--extra-args <span class="string">'console=ttyS0,115200n8 serial'</span></div></pre></td></tr></table></figure></p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/05/14/部署KVM虚拟机之命令行操作/">http://www.yfshare.vip/2017/05/14/部署KVM虚拟机之命令行操作/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[部署KVM虚拟机]]></title>
      <url>http://www.yfshare.vip/2017/05/14/%E9%83%A8%E7%BD%B2KVM%E8%99%9A%E6%8B%9F%E6%9C%BA/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>KVM是指基于Linux内核的虚拟机(Kernel-base Virtual Machine)，在KVM模型中，每一个虚拟机都是一个由Linux调度程序管理的标准进程，你可以在用户空间启动客户机操作系统，一个普通的Linux进程有两种运行模式：内核和用户，KVM增加了第三种模式：客户模式（有自己的内核和用户模式）<br><a id="more"></a><br>KVM虚拟机的管理工具<br>准确的来说，KVM仅仅是Linux内核的一个模块，管理和创建完整的KVM虚拟机，需要更多的辅助工具<br>QEMU-KVM：在Linux系统中，首先我们可以用modprobe命令加载KVM模块，如果用RPM安装KVM软件包，系统会在启动时自动加载模块，QEMU是一个强大的虚拟软件，它可以虚拟不同的构架<br>Virt-manager：尽管QEMU-KVM工具可以创建和管理KVM虚拟机，RedHat为KVM开发了更多的辅助工具，比如 libvirt libguestfs等，原因是QEMU工具效率不高，不易于使用  </p>
<h2 id="安装前准备"><a href="#安装前准备" class="headerlink" title="安装前准备"></a>安装前准备</h2><p>首先需要CPU支持虚拟化功能(VT-X/AMD-V)并开启，如果机器支持虚拟化需要在BIOS开启。如有有，把Virtualization Technology这个功能打开即可  </p>
<p>环境：<br>　　　Centos 6.6 </p>
<p>清除iptables规则和Selinux<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># /etc/init.d/iptables status</span></div><div class="line">iptables: Firewall is not running.</div><div class="line">[root@localhost ~]<span class="comment"># getenforce </span></div><div class="line">Disabled</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>检查你的系统是否支持虚拟化。如果有输出内容，则支持，其中intel cpu支持会有vmx，amd cpu支持会有svm<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># grep -Ei 'vmx|svm' /proc/cpuinfo</span></div><div class="line">flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov </div><div class="line">pat pse36 clflush dts mmx fxsr sse sse2 ss syscall nx pdpe1gb rdtscp lm constant_tsc up arch_perfmon pebs bts xtopology tsc_reliable nonstop_tsc aperfmperf unfair_spinlock pni pclmulqdq vmx ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm ida arat epb xsaveopt pln pts dts tpr_shadow vnmi ept vpid fsgsbase bmi1 avx2 smep bmi2 invpcid</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>注：我这里使用的是Vmware Workstation，如果本身机器支持并开启了，但这里还是查不到。需要检查vmware虚拟机是否开启了虚拟化功能<br><img src="http://note.youdao.com/yws/api/personal/file/BEF83767E54A448BBE2610A0E3F93991?method=download&amp;shareKey=2c8a6f4a180cac114cd2af911f72d518" alt="vmware_vmset">  </p>
<h2 id="安装KVM虚拟机"><a href="#安装KVM虚拟机" class="headerlink" title="安装KVM虚拟机"></a>安装KVM虚拟机</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># yum -y install kvm python-virtinst libvirt libvirt-client bridge-utils virt-manager qemu-kvm qemu-kvm-tools virt-viewer virt-v2v avahi dmidecode tunctl</span></div></pre></td></tr></table></figure>
<p>说明：<br>kvm：软件包中含有KVM内核模块，它在默认linux内核中提供kvm管理程序<br>libvirts：安装虚拟机管理工具，使用virsh等命令来管理和控制虚拟机<br>bridge-utils：设置网络网卡桥接<br>virt-*：创建、克隆虚拟机命令，以及图形化管理工具virt-manager<br>qemu-img：安装qemu组件，使用qemu命令来创建磁盘等  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># /etc/init.d/libvirtd restart</span></div><div class="line">[root@localhost ~]<span class="comment"># /etc/init.d/messagebus restart</span></div><div class="line">[root@localhost ~]<span class="comment"># /etc/init.d/avahi-daemon restart</span></div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment"># chkconfig libvirtd on</span></div><div class="line">[root@localhost ~]<span class="comment"># chkconfig messagebus on</span></div><div class="line">[root@localhost ~]<span class="comment"># chkconfig avahi-daemon on</span></div></pre></td></tr></table></figure>
<p>检查KVM模块是否加载：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#如果没有加载KVM模块，执行下modprobe kvm-intel试试，如果还不行，就重启下</span></div><div class="line">[root@localhost ~]<span class="comment"># lsmod |grep kvm</span></div><div class="line">kvm_intel              55496  0 </div><div class="line">kvm                   337772  1 kvm_intel</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># virsh list --all</span></div><div class="line"> Id    Name                           State</div><div class="line">----------------------------------------------------</div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment"># virt-install --version</span></div><div class="line">0.600.0</div><div class="line">[root@localhost ~]<span class="comment"># virsh --version</span></div><div class="line">0.10.2</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>KVM网络配置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># cd /etc/sysconfig/network-scripts/</span></div><div class="line">[root@localhost network-scripts]<span class="comment"># cp ifcfg-eth0 ifcfg-br0</span></div><div class="line">[root@localhost network-scripts]<span class="comment"># cat ifcfg-br0 </span></div><div class="line">DEVICE=br0</div><div class="line">TYPE=Bridge</div><div class="line">ONBOOT=yes</div><div class="line">NM_CONTROLLED=yes</div><div class="line">BOOTPROTO=static</div><div class="line">IPADDR=192.168.1.160</div><div class="line">NETMASK=255.255.255.0</div><div class="line">GATEWAY=192.168.1.1</div><div class="line">DNS1=114.114.114.114</div><div class="line">[root@localhost network-scripts]<span class="comment"># </span></div><div class="line">[root@localhost network-scripts]<span class="comment"># cat ifcfg-eth0 </span></div><div class="line">DEVICE=eth0</div><div class="line">HWADDR=00:0C:29:BA:C8:85</div><div class="line">TYPE=Ethernet</div><div class="line">UUID=9f21503e-9a56-4f7c-97dc-4516fb960816</div><div class="line">ONBOOT=yes</div><div class="line">NM_CONTROLLED=no</div><div class="line">BOOTPROTO=none</div><div class="line">BRIDGE=br0</div><div class="line">[root@localhost network-scripts]<span class="comment"># /etc/init.d/network restart</span></div></pre></td></tr></table></figure></p>
<p>查看网络接口列表<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># brctl show</span></div><div class="line">bridge name	bridge id		STP enabled	interfaces</div><div class="line">br0		8000.000c29bac885	no		eth0</div><div class="line">virbr0		8000.52540045e79f	yes		virbr0-nic</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># ip a</span></div><div class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN </div><div class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</div><div class="line">    inet 127.0.0.1/8 scope host lo</div><div class="line">    inet6 ::1/128 scope host </div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP ql</div><div class="line">en 1000    link/ether 00:0c:29:ba:c8:85 brd ff:ff:ff:ff:ff:ff</div><div class="line">    inet6 fe80::20c:29ff:feba:c885/64 scope link </div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line">3: virbr0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOW</div><div class="line">N     link/ether 52:54:00:45:e7:9f brd ff:ff:ff:ff:ff:ff</div><div class="line">    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0</div><div class="line">4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN qlen 500</div><div class="line">    link/ether 52:54:00:45:e7:9f brd ff:ff:ff:ff:ff:ff</div><div class="line">6: br0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN </div><div class="line">    link/ether 00:0c:29:ba:c8:85 brd ff:ff:ff:ff:ff:ff</div><div class="line">    inet 192.168.1.160/24 brd 192.168.5.255 scope global br0</div><div class="line">    inet6 fe80::20c:29ff:feba:c885/64 scope link </div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># mkdir -p /kvm_data/&#123;iso,system&#125;</span></div><div class="line">[root@localhost ~]<span class="comment"># ls /kvm_data/iso/      #安装镜像放这里</span></div><div class="line">CentOS-6.6-x86_64-bin-DVD1.iso</div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#制作虚拟机镜像</span></div><div class="line">[root@localhost ~]<span class="comment"># mkdir -p /kvm_data/system/centos6_1</span></div><div class="line">[root@localhost ~]<span class="comment"># cd /kvm_data/system/centos6_1/</span></div><div class="line">[root@localhost centos6_1]<span class="comment"># qemu-img create -f qcow2 centos6_1.qcow2 30G</span></div><div class="line">Formatting <span class="string">'centos6_1.qcow2'</span>, fmt=qcow2 size=32212254720 encryption=off cluster_size=65536 </div><div class="line">[root@localhost centos6_1]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#模版demo_template.xml</span></div><div class="line">[root@localhost ~]<span class="comment"># cat /kvm_data/demo_template.xml </span></div><div class="line">&lt;domain <span class="built_in">type</span>=<span class="string">'kvm'</span>&gt;</div><div class="line">    &lt;name&gt;centos6&lt;/name&gt; //虚拟机名称</div><div class="line">    &lt;uuid&gt;77a83ddb-5ac8-43c3-be22<span class="_">-f</span>8e7156d5784&lt;/uuid&gt;</div><div class="line">    &lt;memory&gt;524288&lt;/memory&gt; //最大内存，单位kb</div><div class="line">    &lt;currentMemory&gt;524288&lt;/currentMemory&gt; //可用内存，单位kb</div><div class="line">    &lt;vcpu&gt;1&lt;/vcpu&gt; //虚拟cpu个数</div><div class="line">    &lt;os&gt;</div><div class="line">      &lt;<span class="built_in">type</span> arch=<span class="string">'x86_64'</span> machine=<span class="string">'pc'</span>&gt;hvm&lt;/<span class="built_in">type</span>&gt;</div><div class="line">      &lt;boot dev=<span class="string">'hd'</span>/&gt; //从硬盘启动</div><div class="line">   &lt;/os&gt;</div><div class="line">   &lt;features&gt;</div><div class="line">     &lt;acpi/&gt;</div><div class="line">     &lt;apic/&gt;</div><div class="line">     &lt;pae/&gt;</div><div class="line">   &lt;/features&gt;</div><div class="line">   &lt;clock offset=<span class="string">'localtime'</span>/&gt;</div><div class="line">   &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;</div><div class="line">   &lt;on_reboot&gt;restart&lt;/on_reboot&gt;</div><div class="line">   &lt;on_crash&gt;destroy&lt;/on_crash&gt;</div><div class="line">   &lt;devices&gt;</div><div class="line">     &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;</div><div class="line">     &lt;disk <span class="built_in">type</span>=<span class="string">'file'</span> device=<span class="string">'disk'</span>&gt;</div><div class="line">      &lt;driver name=<span class="string">'qemu'</span> <span class="built_in">type</span>=<span class="string">'qcow2'</span>/&gt;</div><div class="line">       &lt;<span class="built_in">source</span> file=<span class="string">'/kvm_data/system/centos6_1/centos6_1.qcow2'</span>/&gt; //目的镜像路径</div><div class="line">       &lt;target dev=<span class="string">'hda'</span> bus=<span class="string">'ide'</span>/&gt;</div><div class="line">     &lt;/disk&gt;</div><div class="line">     &lt;disk <span class="built_in">type</span>=<span class="string">'file'</span> device=<span class="string">'cdrom'</span>&gt;</div><div class="line">       &lt;<span class="built_in">source</span> file=<span class="string">'/kvm_data/iso/CentOS-6.6-x86_64-bin-DVD1.iso'</span>/&gt; //光盘镜像路径</div><div class="line">       &lt;target dev=<span class="string">'hdb'</span> bus=<span class="string">'ide'</span>/&gt;</div><div class="line">     &lt;/disk&gt;</div><div class="line">    &lt;interface <span class="built_in">type</span>=<span class="string">'bridge'</span>&gt; //虚拟机网络连接方式</div><div class="line">      &lt;<span class="built_in">source</span> bridge=<span class="string">'br0'</span>/&gt; //当前主机网桥的名称</div><div class="line">      &lt;mac address=<span class="string">"00:16:00:1e:5a:0d"</span>/&gt; //为虚拟机分配mac地址，务必唯一，否则dhcp获得同样ip,引起冲突</div><div class="line">    &lt;/interface&gt;</div><div class="line">    &lt;input <span class="built_in">type</span>=<span class="string">'mouse'</span> bus=<span class="string">'ps2'</span>/&gt;</div><div class="line">     &lt;graphics <span class="built_in">type</span>=<span class="string">'vnc'</span> port=<span class="string">'-1'</span> autoport=<span class="string">'yes'</span> listen = <span class="string">'0.0.0.0'</span> keymap=<span class="string">'en-us'</span>/&gt;//vnc方式登录，端口号自动分配，自动</div><div class="line">加1，可以通过virsh vncdisplay来查询   &lt;/devices&gt;</div><div class="line"> &lt;/domain&gt;</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#复制模版demo_template.xml</span></div><div class="line">[root@localhost centos6_1]<span class="comment"># cp /kvm_data/demo_template.xml ./centos6_1.xml</span></div><div class="line">[root@localhost centos6_1]<span class="comment"># ls</span></div><div class="line">centos6_1.qcow2  centos6_1.xml</div><div class="line">[root@localhost centos6_1]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#定义虚拟机，define告诉libvirt,要被libvirt管理</span></div><div class="line">[root@localhost centos6_1]<span class="comment"># virsh define centos6_1.xml</span></div><div class="line">Domain centos6 defined <span class="keyword">from</span> centos6_1.xml</div><div class="line"></div><div class="line">[root@localhost centos6_1]<span class="comment"># virsh list --all</span></div><div class="line"> Id    Name                           State</div><div class="line">----------------------------------------------------</div><div class="line"> -     centos6                        shut <span class="literal">off</span></div><div class="line"></div><div class="line">[root@localhost centos6_1]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#启动虚拟机</span></div><div class="line">[root@localhost centos6_1]<span class="comment"># virsh start centos6</span></div><div class="line">Domain centos6 started</div><div class="line"></div><div class="line"><span class="comment">#查看虚拟机vnc端口</span></div><div class="line">[root@localhost centos6_1]<span class="comment"># virsh vncdisplay centos6</span></div><div class="line">:<span class="number">0</span></div><div class="line"></div><div class="line">[root@localhost centos6_1]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#安装vncviewer和xhost用于图形化安装Linux系统</span></div><div class="line">[root@localhost ~]<span class="comment"># yum -y install tigervnc xhost</span></div><div class="line">[root@localhost ~]<span class="comment"># export DISPLAY=192.168.1.105:0.0</span></div><div class="line"></div><div class="line"><span class="comment">#需要打开Xmanager - Passive</span></div><div class="line">[root@localhost ~]<span class="comment"># xhost +</span></div><div class="line">[root@localhost ~]<span class="comment"># vncviewer 192.168.1.160:0</span></div></pre></td></tr></table></figure>
<p>接下来开始安装系统(略)<br><img src="http://note.youdao.com/yws/api/personal/file/B297E3ECB88A413F8CEFF46392895404?method=download&amp;shareKey=0fcc26483272ea3eeb58c624ce2db1d4" alt="kvm_install"><br><img src="http://note.youdao.com/yws/api/personal/file/0DE1C86363BA41408A4944B7DC08219F?method=download&amp;shareKey=2d2447e0174953874a5005182b9781c5" alt="kvm_install"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#kvm虚拟机安装成功</span></div><div class="line">[root@localhost ~]<span class="comment"># virsh list --all</span></div><div class="line"> Id    Name                           State</div><div class="line">----------------------------------------------------</div><div class="line"> 2     centos6                        running</div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment"># virsh autostart centos6    #设定kvm虚拟机开机自启</span></div><div class="line">Domain centos6 marked as autostarted</div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment"># qemu-img info /kvm_data/system/centos6_1/centos6_1.qcow2 </span></div><div class="line">image: /kvm_data/system/centos6_1/centos6_1.qcow2</div><div class="line">file format: qcow2</div><div class="line">virtual size: 30G (32212254720 bytes)</div><div class="line">disk size: 2.1G</div><div class="line">cluster_size: 65536</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># ll /var/lib/libvirt/qemu</span></div><div class="line">total 12</div><div class="line">srwxr-xr-x 1 qemu qemu    0 May 14 11:41 centos6.monitor      <span class="comment">#这里的文件，是libvirtd在重启后，虚拟机也随着自动重启</span></div><div class="line">drwxr-xr-x 2 root root 4096 May 14 11:05 dump</div><div class="line">drwxr-xr-x 2 qemu qemu 4096 May 14 11:05 save</div><div class="line">drwxr-xr-x 2 qemu qemu 4096 May 14 11:05 snapshot</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#动态查询kvm资源占用情况，每一台VM，对应一个qemu-kvm进程</span></div><div class="line">[root@localhost ~]<span class="comment"># top -d 1 | grep kvm</span></div><div class="line">  2601 qemu      20   0  796m 530m 3928 S  1.0 28.5   5:27.72 qemu-kvm                                                   </div><div class="line">  2601 qemu      20   0  796m 530m 3928 S  1.0 28.5   5:27.73 qemu-kvm                                                   </div><div class="line">  2601 qemu      20   0  796m 530m 3928 S  1.0 28.5   5:27.74 qemu-kvm                                                   </div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h2 id="部署多台KVM虚拟机"><a href="#部署多台KVM虚拟机" class="headerlink" title="部署多台KVM虚拟机"></a>部署多台KVM虚拟机</h2><ol>
<li>使用qemu-img创建虚拟机镜像  </li>
<li>拷贝demo_template.xml模版配置文件并修改里的参数，如：UUID/MASK地址/镜像存储位置/ISO镜像目录等</li>
<li>virsh define vm_name和virsh start vm_name即可</li>
</ol>
<h2 id="常见问题解决办法"><a href="#常见问题解决办法" class="headerlink" title="常见问题解决办法"></a>常见问题解决办法</h2><p>如果报这个错，把NetworkManager服务关掉就OK了，因为和桥接有冲突<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Bringing up interface br0:  Error: Connection activation failed: Failed to determine connection<span class="string">'s virtual interface name</span></div></pre></td></tr></table></figure></p>
<p>如果出现下面的错误，需要安装一个avahi软件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ERROR    Failed to connect socket to <span class="string">'/var/run/libvirt/libvirt-sock'</span>: No such file or directory</div></pre></td></tr></table></figure></p>
<p>解决办法：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># yum -y install avahi</span></div><div class="line">[root@localhost ~]<span class="comment"># /etc/init.d/messagebus restart</span></div><div class="line">[root@localhost ~]<span class="comment"># /etc/init.d/avahi-daemon restart</span></div><div class="line">[root@localhost ~]<span class="comment"># /etc/init.d/libvirtd restart</span></div></pre></td></tr></table></figure></p>
<p>如果报这个错，表示disk path选项中的size指定的值大于当前实际磁盘空间<br><figure class="highlight smali"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">WARNING  The filesystem will<span class="built_in"> not </span>have enough free space to fully allocate the<span class="built_in"> sparse </span>file when the guest is running. 6144</div><div class="line">0 M requested &gt; 42184 M available</div></pre></td></tr></table></figure></p>
<p>如果报这个错，是因为存在相同名字的虚拟机，即使删掉虚拟机的配置文件也会报这个错<br>kvm和xen不同，xen的半虚拟化要想重装，只要把创建好的虚拟机配置文件删掉就可以了，kvm如果想要重装相同名字的虚拟机，只需要在虚拟机停止的状态下执行如下命令<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ERROR    Guest name <span class="string">'Kvm_centos6.6'</span> is already <span class="keyword">in</span> use.</div></pre></td></tr></table></figure></p>
<p>解决办法：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># virsh destroy Kvm_centos6.6</span></div><div class="line">Domain Kvm_centos6.6 destroyed</div><div class="line">[root@localhost ~]<span class="comment"># virsh undefine Kvm_centos6.6</span></div><div class="line">Domain Kvm_centos6.6 has been undefined</div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>如果出现下面的错误，<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kvm cpu0 disabled perfctr wrmsr 0xc1 data 0xabcd</div></pre></td></tr></table></figure></p>
<h2 id="KVM常用命令"><a href="#KVM常用命令" class="headerlink" title="KVM常用命令"></a>KVM常用命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#virsh -c qemu:///system list  </span></div><div class="line"><span class="comment">#virsh list  </span></div><div class="line"><span class="comment">#virsh list --all //查看所有状态的虚拟机</span></div><div class="line"><span class="comment">#virsh shutdown myWin7 //关闭myWin7虚拟机</span></div><div class="line"><span class="comment">#virsh destroy myWin7 //删除myWin7虚拟机</span></div><div class="line"><span class="comment">#virsh start node4 //开机虚拟机</span></div><div class="line"><span class="comment">#virsh define /etc/libvirt/qemu/node5.xml #根据主机配置文档添加虚拟机</span></div><div class="line"><span class="comment">#virsh dumpxml node4 &gt; /etc/libvirt/qemu/node6.xml //将node4虚机的配置文件保存至node6.xml</span></div><div class="line"><span class="comment">#virsh edit node6 //修改node6的配置文件</span></div><div class="line"><span class="comment">#virsh suspend vm_name   //暂停虚拟机</span></div><div class="line"><span class="comment">#virsh resume vm_name    //恢复虚拟机</span></div><div class="line"> Kvm配置文件路径 ：</div><div class="line">/etc/libvirtd/qemu/***.xml 可以通过vim对配置文件进行管理，编辑后需要<span class="comment">#service libvirtd restart(不会对现有VM有影响)</span></div></pre></td></tr></table></figure>
<h2 id="其他问题"><a href="#其他问题" class="headerlink" title="其他问题"></a>其他问题</h2><ol>
<li>图形化配置：从菜单中启动，或者运行virt-manager进入图形管理界面，比较简单，不过img的位置需要注意一下，kvm安装后会有一个默认位置，不注意的话容易占满空间。或者直接硬盘分区时单独给/var分一个区  </li>
<li>虚拟机重新配置：<br>虚拟机的配置文件保存在/etc/libvirt/qemu目录下，扩展名是xml。修改相应的文件即可重新配置虚拟机  </li>
<li><p>虚拟机备份及恢复：<br>备份：拷贝/etc/libvirt/qemu目录下的xml配置文件，以及xml中设置的img文件<br>恢复：进入virsh，执行define 目录下的xml文件路径  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># virsh</span></div><div class="line">virsh <span class="comment"># define /etc/libvirt/qemu/winxp.xml</span></div></pre></td></tr></table></figure>
</li>
<li><p>开机自动启动虚拟机：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@vfeelit qemu]<span class="comment"># virsh autostart Winxp</span></div></pre></td></tr></table></figure>
</li>
<li><p>克隆KVM虚拟机：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@vfeelit ~]<span class="comment"># virt-clone -o Winxp -n winxpclong -f /var/lib/libvirt/images/winxpclong.img</span></div></pre></td></tr></table></figure>
</li>
</ol>
<p>(-o 原始客体的名称，-n新客户端的名称，-f作为新客户端磁盘映像的新文件)  </p>
<ol>
<li>虚拟机意外关机报下述错误：  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@vfeelit qemu]<span class="comment"># virsh start winxp</span></div><div class="line">错误：开始域 winxp 失败</div><div class="line">错误：Unable to <span class="built_in">read</span> from monitor: Connection reset by peer</div></pre></td></tr></table></figure>
</li>
</ol>
<p>解决方法：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">virsh managedsave-remove winxp</div></pre></td></tr></table></figure></p>
<p>Virsh语法参考  </p>
<table>
<thead>
<tr>
<th>命令</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>Autostart</td>
<td>自动开始一个域</td>
</tr>
<tr>
<td>Create</td>
<td>从一个XML文件创建一个域</td>
</tr>
<tr>
<td>Define</td>
<td>从一个XML文件定义(但不开始)一个域</td>
</tr>
<tr>
<td>edit</td>
<td>编辑某个域的 XML 配置</td>
</tr>
<tr>
<td>shutdown</td>
<td>关闭一个域</td>
</tr>
<tr>
<td>start</td>
<td>开始一个(以前定义的)非活跃的域</td>
</tr>
<tr>
<td>reboot</td>
<td>重新启动一个域</td>
</tr>
<tr>
<td>suspend</td>
<td>挂起一个域</td>
</tr>
<tr>
<td>resume</td>
<td>重新恢复一个域</td>
</tr>
<tr>
<td>vncdisplay</td>
<td>vnc 显示</td>
</tr>
</tbody>
</table>
<p>使用save来备份当前虚拟机的状态<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># virsh save --bypass-cache centos6 /var/lib/libvirt/images/test_centos6 --running</span></div><div class="line"></div><div class="line">Domain centos6 saved to /var/lib/libvirt/images/test_centos6</div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment"># virsh list</span></div><div class="line"> Id    Name                           State</div><div class="line">----------------------------------------------------</div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>这个命令将Kvm_centos6.6的当前状态保存到/var/lib/libvirt/images/文件中。–running参数表示下次restore回来的时候能够自动启动RedHat，这个命令会导致RedHat被关闭<br>现在还原：必须先关闭虚拟机<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># virsh restore /var/lib/libvirt/images/test_centos6 --bypass-cache --running (还原时不要指定虚拟机名称)</span></div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment"># virsh list --all</span></div><div class="line"> Id    Name                           State</div><div class="line">----------------------------------------------------</div><div class="line"> 6     centos6                  running</div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>附件：<br><a href="http://note.youdao.com/yws/api/personal/file/34E833FCF9284B4F9086BE10693978E8?method=download&amp;shareKey=8848490fd7479386d223a89d31cffe44" target="_blank" rel="external">demo_template.xml</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/05/14/部署KVM虚拟机/">http://www.yfshare.vip/2017/05/14/部署KVM虚拟机/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[部署JIRA 7.2.2 for Linux]]></title>
      <url>http://www.yfshare.vip/2017/05/09/%E9%83%A8%E7%BD%B2JIRA-7-2-2-for-Linux/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>jira是Atlassian公司出品的项目与事务跟踪工具，被广泛应用于缺陷跟踪（bug管理）、客户服务、需求收集、流程审批、任务跟踪、项目跟踪和敏捷管理等工作领域<br><a id="more"></a><br>首页：<a href="https://www.atlassian.com/" target="_blank" rel="external">https://www.atlassian.com/</a><br>　　　<a href="https://www.atlassian.com/software/jira/core" target="_blank" rel="external">https://www.atlassian.com/software/jira/core</a>  </p>
<p>JIRA Core各个版本下载地址(目前最新版是7.3.6)：<a href="https://www.atlassian.com/software/jira/core/update" target="_blank" rel="external">https://www.atlassian.com/software/jira/core/update</a><br>JIRA7.2 for Linux官方安装手册：<a href="https://confluence.atlassian.com/adminjiraserver072/installing-jira-applications-on-linux-828787555.html" target="_blank" rel="external">https://confluence.atlassian.com/adminjiraserver072/installing-jira-applications-on-linux-828787555.html</a>  </p>
<h2 id="安装前准备"><a href="#安装前准备" class="headerlink" title="安装前准备  "></a>安装前准备  </h2><p>环境：<br>　　　Centos 6.8<br>　　　JIRA Core server 7.2.2<br>　　　Mysql 5.6.36  </p>
<p>服务器内存建议大于3G<br>安装JIRA7.2所需要的系统配置：<a href="https://confluence.atlassian.com/adminjiraserver072/supported-platforms-828787550.html" target="_blank" rel="external">https://confluence.atlassian.com/adminjiraserver072/supported-platforms-828787550.html</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#安装JIRA对环境的要求</span></div><div class="line">Mysql = 5.5，5.6</div><div class="line">JDK = 1.8</div><div class="line">    ≠ Java 1.8.0_25 and 1.8.0_31 and Java 1.8.0_45</div><div class="line">Tomcat = 8.0.33  <span class="comment">#不支持单个tomcat部署多个Atlassian应用</span></div></pre></td></tr></table></figure></p>
<p>JIRA需要依赖JAVA环境，因此我们需要安装jdk，且需要jdk 1.8以上<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># java -version</span></div><div class="line">java version <span class="string">"1.8.0_20"</span></div><div class="line">Java(TM) SE Runtime Environment (build 1.8.0_20-b26)</div><div class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.20-b23, mixed mode)</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>除此之外，JIRA需要使用外部数据库，JIRA支持PostgreSQL, Oracle, MySQL, SQL Server，这里我们选择Mysql<br>JIRA关于Mysql的配置说明：<a href="https://confluence.atlassian.com/adminjiraserver072/connecting-jira-applications-to-mysql-828787562.html" target="_blank" rel="external">https://confluence.atlassian.com/adminjiraserver072/connecting-jira-applications-to-mysql-828787562.html</a>  </p>
<p>Mysql 5.6 Yum源(rpm)：<a href="http://note.youdao.com/yws/api/personal/file/9F81786CBC5748E69B2F34FC7BE160D6?method=download&amp;shareKey=aca90d80731cf2a892d421787e401289" target="_blank" rel="external">点击下载</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#安装并配置Mysql数据库</span></div><div class="line">[root@localhost ~]<span class="comment"># yum -y install http://dev.mysql.com/get/mysql-community-release-el6-5.noarch.rpm</span></div><div class="line">[root@localhost ~]<span class="comment"># yum -y install mysql-community-server.x86_64 mysql-community-devel.x86_64 mysql-community-client.x86_64</span></div><div class="line">[root@localhost ~]<span class="comment"># /etc/init.d/mysqld start</span></div><div class="line">[root@localhost ~]<span class="comment"># /usr/bin/mysqladmin -u root password '123456'</span></div><div class="line">[root@localhost ~]<span class="comment"># chkconfig mysqld on</span></div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment"># grep -iA6 confluence /etc/my.cnf </span></div><div class="line">[mysqld]</div><div class="line">...</div><div class="line"><span class="comment">#confluence configure</span></div><div class="line">character-set-server=utf8</div><div class="line">collation-server=utf8_bin</div><div class="line">default-storage-engine=INNODB</div><div class="line">max_allowed_packet=256M</div><div class="line">innodb_log_file_size=2GB</div><div class="line">transaction-isolation=READ-COMMITTED</div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line">[root@localhost ~]<span class="comment"># /etc/init.d/mysqld restart</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># mysql -uroot -p123456</span></div><div class="line">mysql&gt; CREATE DATABASE jiradb CHARACTER SET utf8 COLLATE utf8_bin;</div><div class="line">mysql&gt; GRANT SELECT,INSERT,UPDATE,DELETE,CREATE,DROP,ALTER,INDEX on jiradb.* TO <span class="string">'jir</span></div><div class="line">a'@<span class="string">'localhost'</span> IDENTIFIED BY <span class="string">'jirapass'</span>;</div><div class="line">mysql&gt; GRANT SELECT,INSERT,UPDATE,DELETE,CREATE,DROP,ALTER,INDEX on jiradb.* TO <span class="string">'jir</span></div><div class="line">a'@<span class="string">'192.168.31.117'</span> IDENTIFIED BY <span class="string">'jirapass'</span>;</div><div class="line">mysql&gt; FLUSH PRIVILEGES;</div><div class="line"></div><div class="line">mysql&gt; SHOW GRANTS FOR <span class="string">'jira'</span>@<span class="string">'localhost'</span>;</div><div class="line">+-------------------------------------------------------------------------------------------------------------+</div><div class="line">| Grants <span class="keyword">for</span> jira@localhost                                                                                   |</div><div class="line">+-------------------------------------------------------------------------------------------------------------+</div><div class="line">| GRANT USAGE ON *.* TO <span class="string">'jira'</span>@<span class="string">'localhost'</span> IDENTIFIED BY PASSWORD <span class="string">'*F6300EC05CFE78CF8A64ADD7EB065178DEC0B866'</span> |</div><div class="line">| GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, INDEX, ALTER ON `jiradb`.* TO <span class="string">'jira'</span>@<span class="string">'localhost'</span>        |</div><div class="line">+-------------------------------------------------------------------------------------------------------------+</div><div class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; SHOW GRANTS FOR <span class="string">'jira'</span>@<span class="string">'192.168.31.117'</span>;</div><div class="line">+------------------------------------------------------------------------------------------------------------------+</div><div class="line">| Grants <span class="keyword">for</span> jira@192.168.31.117                                                                                   |</div><div class="line">+------------------------------------------------------------------------------------------------------------------+</div><div class="line">| GRANT USAGE ON *.* TO <span class="string">'jira'</span>@<span class="string">'192.168.31.117'</span> IDENTIFIED BY PASSWORD <span class="string">'*F6300EC05CFE78CF8A64ADD7EB065178DEC0B866'</span> |</div><div class="line">| GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, INDEX, ALTER ON `jiradb`.* TO <span class="string">'jira'</span>@<span class="string">'192.168.31.117'</span>        |</div><div class="line">+------------------------------------------------------------------------------------------------------------------+</div><div class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; \q</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h2 id="安装JIRA-7-2-2"><a href="#安装JIRA-7-2-2" class="headerlink" title="安装JIRA 7.2.2  "></a>安装JIRA 7.2.2  </h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># chmod u+x atlassian-jira-software-7.2.2-x64.bin </span></div><div class="line">[root@localhost ~]<span class="comment"># ./atlassian-jira-software-7.2.2-x64.bin </span></div><div class="line">Unpacking JRE ...</div><div class="line">Starting Installer ...</div><div class="line">May 09, 2017 10:52:01 AM java.util.prefs.FileSystemPreferences<span class="variable">$1</span> run</div><div class="line">INFO: Created user preferences directory.</div><div class="line"></div><div class="line">This will install JIRA Software 7.2.2 on your computer.</div><div class="line">OK [o, Enter], Cancel [c]</div><div class="line">o</div><div class="line">Choose the appropriate installation or upgrade option.</div><div class="line">Please choose one of the following:</div><div class="line">Express Install (use default settings) [1], Custom Install (recommended <span class="keyword">for</span> advanced users) [2, Enter], Upgrade an existi</div><div class="line">ng JIRA installation [3]1</div><div class="line">Details on <span class="built_in">where</span> JIRA Software will be installed and the settings that will be used.</div><div class="line">c</div><div class="line">HTTP Port: 8080 </div><div class="line">RMI Port: 8005 </div><div class="line">Install as service: Yes </div><div class="line">Install [i, Enter], Exit [e]</div><div class="line">i</div><div class="line"></div><div class="line">Extracting files ...</div><div class="line"></div><div class="line">Please <span class="built_in">wait</span> a few moments <span class="keyword">while</span> JIRA Software starts up.</div><div class="line">Launching JIRA Software ...</div><div class="line">Installation of JIRA Software 7.2.2 is complete</div><div class="line">Your installation of JIRA Software 7.2.2 is now ready and can be accessed</div><div class="line">via your browser.</div><div class="line">JIRA Software 7.2.2 can be accessed at http://localhost:8080</div><div class="line">Finishing installation ...</div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line">[root@localhost ~]<span class="comment"># netstat -tunlp | grep 8080</span></div><div class="line">tcp        0      0 :::8080                     :::*                        LISTEN      50711/java          </div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#JIRA的安装目录和家目录</span></div><div class="line">Installation Directory: /opt/atlassian/jira </div><div class="line">Home Directory: /var/atlassian/application-data/jira </div><div class="line"><span class="comment">#如果需要修改端口之类的，需要修改/opt/atlassian/jira/conf/server.xml这个配置文件</span></div><div class="line"><span class="comment">#数据库的配置文件是/var/atlassian/application-data/jira/dbconfig.xml</span></div></pre></td></tr></table></figure>
<h2 id="破解JIRA-7-2-2"><a href="#破解JIRA-7-2-2" class="headerlink" title="破解JIRA 7.2.2  "></a>破解JIRA 7.2.2  </h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># /etc/init.d/jira stop</span></div><div class="line"><span class="comment">#进入JIRA安装目录，上传破解文件</span></div><div class="line"><span class="comment">#atlassian-extras-3.1.2.jar替换原来的atlassian-extras-3.1.2.jar，用于破解JIRA系统</span></div><div class="line"><span class="comment">#mysql-connector-java-5.1.39-bin.jar是MYSQL的驱动程序包</span></div><div class="line">[root@localhost ~]<span class="comment"># cd /opt/atlassian/jira/atlassian-jira/WEB-INF/lib</span></div><div class="line">[root@localhost lib]<span class="comment"># cp ~/atlassian-extras-3.1.2.jar .</span></div><div class="line">[root@localhost lib]<span class="comment"># cp ~/mysql-connector-java-5.1.39-bin.jar .</span></div><div class="line">[root@localhost ~]<span class="comment"># /etc/init.d/jira start</span></div></pre></td></tr></table></figure>
<p>访问<a href="http://ip:8080" target="_blank" rel="external">http://ip:8080</a> 打开JIRA配置向导页面<br><img src="http://note.youdao.com/yws/api/personal/file/0FCA2310301348438C781C2736633C46?method=download&amp;shareKey=e93942bd82fdda8a2f476717b9fa0fb5" alt="JIRA_install"><br><img src="http://note.youdao.com/yws/api/personal/file/775AA99451A34E86856C1B328572D3C1?method=download&amp;shareKey=e71bd93e4f86fdcfb1e0e50f27ab63f2" alt="JIRA_install"><br><img src="http://note.youdao.com/yws/api/personal/file/D669B7F2B7724AE986A47572B3F447FE?method=download&amp;shareKey=21be15edc6e433f17acfe6e74c5f73bf" alt="JIRA_install"><br><img src="http://note.youdao.com/yws/api/personal/file/82E548B0DC16475BA1BD8D401BB6C075?method=download&amp;shareKey=0cc74d94fd01159fab83640fe7ec9a0e" alt="JIRA_install"><br><img src="http://note.youdao.com/yws/api/personal/file/95356B5BEDB14AE1B8C96DEDA1115AA8?method=download&amp;shareKey=0185b25a933f73142485ef8a3961089f" alt="JIRA_install"><br><img src="http://note.youdao.com/yws/api/personal/file/4A636F46CEAF4082A348456858398F00?method=download&amp;shareKey=57528639d9b0c11854a750915bd0723f" alt="JIRA_install"><br><img src="http://note.youdao.com/yws/api/personal/file/E8328EFF81A547D89745C63E5772D89E?method=download&amp;shareKey=c4748c746a378a4444ee15c9b0317ccf" alt="JIRA_install"><br><img src="http://note.youdao.com/yws/api/personal/file/C64BD097863945FA84476196CA9EE587?method=download&amp;shareKey=60dbdfa889efcab79f8bb7f3697c62e6" alt="JIRA_install"><br><img src="http://note.youdao.com/yws/api/personal/file/0CD6CB2373AD4E74A3B65E4FEEEB4897?method=download&amp;shareKey=3d7764eba4667435a43713ab7c877533" alt="JIRA_install"><br><img src="http://note.youdao.com/yws/api/personal/file/EE09B197C91E401FB3E831278A810833?method=download&amp;shareKey=0bb5acd4584f8d1a90fcc00e757855b4" alt="JIRA_install"><br>JIRA 7.22安装完成  </p>
<p>配置JIRA 7.2.2<br>创建第一个项目<br><img src="http://note.youdao.com/yws/api/personal/file/06347A33D066476293A2BA62930E0BB9?method=download&amp;shareKey=a7a6a93787b3b2d742e3a6ba35c141c6" alt="JIRA_setup"><br><img src="http://note.youdao.com/yws/api/personal/file/810E923C514746F788E07E617172C516?method=download&amp;shareKey=e59c333222233084d36101d9207ae5d8" alt="JIRA_setup"><br><img src="http://note.youdao.com/yws/api/personal/file/FC3E1ABE7EE0412EA3A90F62714A8020?method=download&amp;shareKey=3b0f375c1c93f231105c56d0ae703d4d" alt="JIRA_setup"><br><img src="http://note.youdao.com/yws/api/personal/file/FA5ECD94F4AB41A4BF2B44B64225656A?method=download&amp;shareKey=15876094d96b112355c6a2c185d70d9a" alt="JIRA_setup"><br><img src="http://note.youdao.com/yws/api/personal/file/1F7D5CB6968B4970B7B8F47C5C8C6579?method=download&amp;shareKey=8091c1be7ef18286bc35276bdcd1a1a7" alt="JIRA_setup">  </p>
<p>从这里看，我们之前的破解是成功的，这个JIRA我们可以使用到2033年，现在是2017年哦~<br>如果没有破解的话，默认是30天使用期限，就是在安装时在官网申请的Licence<br><img src="http://note.youdao.com/yws/api/personal/file/FD82EE49300045D19AF2FCF230BDC4A3?method=download&amp;shareKey=a16d371985fbcb4cdc2f7b60cf057e14" alt="JIRA_setup">  </p>
<h2 id="汉化JIRA-7-2-2"><a href="#汉化JIRA-7-2-2" class="headerlink" title="汉化JIRA 7.2.2  "></a>汉化JIRA 7.2.2  </h2><p>官网JIRA中文语言包获取地址：<a href="https://translations.atlassian.com/dashboard/download?lang=zh_CN#/JIRA" target="_blank" rel="external">https://translations.atlassian.com/dashboard/download?lang=zh_CN#/JIRA</a><br>下载JIRA Core-7.2.1-language-pack-zh_CN.jar(中文语言包)<br><a href="https://translations.atlassian.com/download/JIRA+Core/7.2.1/zh_CN/JIRA+Core-7.2.1-language-pack-zh_CN.jar" target="_blank" rel="external">官网下载jira中文语言包</a><br><a href="http://note.youdao.com/yws/api/personal/file/E97D7487FD91475D9C34F83747DDCF03?method=download&amp;shareKey=803eef9a500cf15e04945fcb71d70eab" target="_blank" rel="external">本地下载jira中文语言包</a>  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/773421D0FA6A47EAA41F08218AFD902D?method=download&amp;shareKey=eb27a8ab26c06560a1be7a39832aa456" alt="JIRA_setup"><br><img src="http://note.youdao.com/yws/api/personal/file/A85DFAC834214747A3C8419A9E79149D?method=download&amp;shareKey=d5db63e2fe92a390edeceff10d24903b" alt="JIRA_setup"><br><img src="http://note.youdao.com/yws/api/personal/file/5C3E02F7ED4B4CB38C0429B5DEE4B912?method=download&amp;shareKey=208fd72af81f8a610151d18801f448dc" alt="JIRA_setup">  </p>
<p>Syetem – Edit Settings – Default language<br><img src="http://note.youdao.com/yws/api/personal/file/83CD29E3E3DC4E4C9696C8AED8905B79?method=download&amp;shareKey=d0cb65a2586a9b6b7e20d59a683d2bb7" alt="JIRA_setup"><br><img src="http://note.youdao.com/yws/api/personal/file/B0A9875D10E3438A900FDC92EC59E2A5?method=download&amp;shareKey=8ddb99a4eeb0c240220f5de9c4625c2b" alt="JIRA_setup"><br>汉化完成  </p>
<p>附件：<br>下载atlassian-jira-software-7.2.2-x64.bin<br><a href="https://downloads.atlassian.com/software/jira/downloads/atlassian-jira-core-7.2.2-x64.bin" target="_blank" rel="external">JIRA 7.2.2 for linux x64官网下载</a><br><a href="http://pan.baidu.com/s/1bBQ1pO" target="_blank" rel="external">JIRA 7.2.2 for linux x64百度网盘下载，密码：a27h</a><br><a href="http://pan.baidu.com/s/1jHS4VPW" target="_blank" rel="external">jdk-8u20百度网盘下载，密码：9p4g</a><br><a href="http://note.youdao.com/yws/api/personal/file/3C3313EA38AB468496274194F97C9B22?method=download&amp;shareKey=f572622fcb9af65860227468644aaef7" target="_blank" rel="external">JIRA 7.2破解包下载</a>  </p>
<p><a href="http://pan.baidu.com/s/1pK8ce4F" target="_blank" rel="external">JIRA 7.2.2安装包合集百度网盘下载，密码：h5tp</a>  </p>
<p>参考：<a href="http://www.ilanni.com/?p=12119" target="_blank" rel="external">http://www.ilanni.com/?p=12119</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/05/09/部署JIRA-7-2-2-for-Linux/">http://www.yfshare.vip/2017/05/09/部署JIRA-7-2-2-for-Linux/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[部署Grafana数据展示系统]]></title>
      <url>http://www.yfshare.vip/2017/04/29/%E9%83%A8%E7%BD%B2Grafana%E6%95%B0%E6%8D%AE%E5%B1%95%E7%A4%BA%E7%B3%BB%E7%BB%9F/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>Grafana 是 Graphite 和 InfluxDB 仪表盘和图形编辑器。<br>Grafana 是开源的，功能齐全的度量仪表盘和图形编辑器，支持 Graphite，InfluxDB 和 OpenTSDB。<br>Grafana 主要特性：灵活丰富的图形化选项；可以混合多种风格；支持白天和夜间模式；多个数据源；Graphite 和 InfluxDB 查询编辑器等等。<br><a id="more"></a></p>
<h2 id="认识Grafana"><a href="#认识Grafana" class="headerlink" title="认识Grafana"></a>认识Grafana</h2><p><strong>Graphite 指标编辑器</strong></p>
<ul>
<li>Graphite 指标表达解析器</li>
<li>功能齐全的查询功能</li>
<li>快速添加和编辑函数和参数</li>
<li>模板化查询</li>
<li>See it in action</li>
</ul>
<p><strong>图形化</strong></p>
<ul>
<li>快速渲染，甚至是较大的时间跨度</li>
<li>点击和拖拽缩放</li>
<li>多个 Y 轴 </li>
<li>条形，折线，点 </li>
<li>智能 Y 轴格式化</li>
<li>系列切换和颜色选择 </li>
<li>Legend values 和格式化选项</li>
<li>网格阈值，轴标签</li>
<li>Annotations</li>
</ul>
<p><strong>仪表盘</strong></p>
<ul>
<li>创建，编辑，保存和搜索仪表盘</li>
<li>修改列宽和行高</li>
<li>拖拽面板重新编排</li>
<li>使用 InfluxDB 或者 Elasticsearch 作为仪表盘存储</li>
<li>导入和导出仪表盘（JSON 文件）</li>
<li>从 Graphite 导入仪表盘</li>
<li>模板</li>
<li>Scripted dashboards</li>
<li>Dashboard playlists</li>
<li>时间范围控制</li>
</ul>
<p><strong>InfluxDB</strong></p>
<ul>
<li>使用 InfluxDB 作为指标数据源，注释源和仪表盘存储</li>
<li>查询编辑器</li>
</ul>
<p><strong>OpenTSDB</strong></p>
<ul>
<li>作为指标数据源</li>
<li>查询编辑器</li>
</ul>
<h2 id="部署Grafana数据展示平台-之在线安装"><a href="#部署Grafana数据展示平台-之在线安装" class="headerlink" title="部署Grafana数据展示平台 之在线安装"></a>部署Grafana数据展示平台 之在线安装</h2><p>官网：<a href="http://grafana.org/" target="_blank" rel="external">http://grafana.org/</a><br>环境：<br>　　　Centos 6.6<br>　　　Zabbix Version 3.0.4<br>　　　grafana Version 3.1.1  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[root@Zabbix ~]<span class="comment"># wget https://grafanarel.s3.amazonaws.com/builds/grafana-3.1.1-1470047149.x86_64.rpm</span></div><div class="line">[root@Zabbix ~]<span class="comment"># yum -y install grafana-3.1.1-1470047149.x86_64.rpm</span></div><div class="line">[root@Zabbix ~]<span class="comment"># mkdir -p /var/log/grafana</span></div><div class="line">[root@Zabbix ~]<span class="comment"># cd /usr/share/grafana/conf/</span></div><div class="line">[root@Zabbix conf]<span class="comment"># grep -v '^#' defaults.ini | grep -v ^$</span></div><div class="line">···</div><div class="line">[users]</div><div class="line">allow_sign_up = <span class="literal">false</span>         <span class="comment">#关闭这个在登录界面就没有Sign Up了</span></div><div class="line">allow_org_create = <span class="literal">false</span></div><div class="line">auto_assign_org = <span class="literal">false</span></div><div class="line">auto_assign_org_role = Viewer</div><div class="line">verify_email_enabled = <span class="literal">false</span></div><div class="line">login_hint = email or username</div><div class="line">default_theme = dark</div><div class="line">···</div><div class="line">[root@Zabbix conf]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>安装Grafana插件<br>官方文档：<a href="http://docs.grafana.org/plugins/installation/" target="_blank" rel="external">http://docs.grafana.org/plugins/installation/</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#列出可用的插件</span></div><div class="line">[root@Zabbix ~]<span class="comment"># grafana-cli plugins list-remote</span></div><div class="line">id: abhisant-druid-datasource version: 0.0.2</div><div class="line">id: alexanderzobnin-zabbix-app version: 3.0.0</div><div class="line">id: bosun-app version: 0.0.25</div><div class="line">id: bosun-datasource version: 0.0.5</div><div class="line">id: crate-datasource version: 0.0.1</div><div class="line">id: fastweb-openfalcon-datasource version: 1.0.0</div><div class="line">id: fetzerch-sunandmoon-datasource version: 0.1.1</div><div class="line">id: grafana-clock-panel version: 0.0.8</div><div class="line">id: grafana-example-app version: 1.0.1</div><div class="line">id: grafana-influxdb-08-datasource version: 1.0.2</div><div class="line">id: grafana-kairosdb-datasource version: 1.0.1</div><div class="line">id: grafana-piechart-panel version: 1.1.1</div><div class="line">id: grafana-simple-json-datasource version: 1.1.2</div><div class="line">id: grafana-worldmap-panel version: 0.0.14</div><div class="line">id: kentik-app version: 1.0.4</div><div class="line">id: mtanda-heatmap-epoch-panel version: 0.1.1</div><div class="line">id: mtanda-histogram-panel version: 0.1.5</div><div class="line">id: ns1-app version: 0.0.5</div><div class="line">id: opennms-datasource version: 2.0.1</div><div class="line">id: percona-percona-app version: 1.0.0</div><div class="line">id: praj-ams-datasource version: 1.0.1</div><div class="line">id: raintank-snap-app version: 0.0.3</div><div class="line">id: raintank-worldping-app version: 1.0.10</div><div class="line">id: sileht-gnocchi-datasource version: 1.0.6</div><div class="line">id: sraoss-sunburst-panel version: 1.0</div><div class="line">id: stagemonitor-elasticsearch-app version: 0.26.0</div><div class="line">id: udoprog-heroic-datasource version: 0.1.0</div><div class="line">id: voxter-app version: 0.0.1</div><div class="line">Restart grafana after installing plugins . &lt;service grafana-server restart&gt;</div><div class="line">[root@Zabbix ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p><a href="https://grafana.com/plugins/alexanderzobnin-zabbix-app" target="_blank" rel="external">alexanderzobnin-zabbix-app</a> 插件用于Grafana通过Zabbix API获取数据并展示数据<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@Zabbix ~]<span class="comment"># grafana-cli plugins install alexanderzobnin-zabbix-app</span></div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/F9559698659841E8913649C3444C5701?method=download&amp;shareKey=2c51f44d408b1674bceee85ab5787611" alt="Grafana_install_plugins">  </p>
<p>安装Grafana其他插件<br>常用插件：<a href="https://grafana.com/plugins/grafana-clock-panel" target="_blank" rel="external">grafana-clock-panel</a>、<a href="https://grafana.com/plugins/grafana-simple-json-datasource" target="_blank" rel="external">grafana-simple-json-datasource</a>、<a href="https://grafana.com/plugins/grafana-piechart-panel" target="_blank" rel="external">grafana-piechart-panel</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@Zabbix ~]<span class="comment"># grafana-cli plugins install grafana-clock-panel</span></div><div class="line">[root@Zabbix ~]<span class="comment"># grafana-cli plugins install grafana-simple-json-datasource</span></div><div class="line">[root@Zabbix ~]<span class="comment"># grafana-cli plugins install grafana-piechart-panel</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#这三个可以不安装，这三个插件是用于检测DNS/PING等网络情况的，需要付费</span></div><div class="line">[root@Zabbix ~]<span class="comment"># grafana-cli plugins install raintank-worldping-app</span></div><div class="line">[root@Zabbix ~]<span class="comment"># grafana-cli plugins install fastweb-openfalcon-datasource</span></div><div class="line">[root@Zabbix ~]<span class="comment"># grafana-cli plugins install percona-percona-app</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#列出已安装的插件</span></div><div class="line">[root@Zabbix ~]<span class="comment"># grafana-cli plugins ls</span></div></pre></td></tr></table></figure>
<p><img src="http://note.youdao.com/yws/api/personal/file/9AA193AACC784E9DACA6C47A9162C132?method=download&amp;shareKey=d50c4fe6334663c21675454699cba3d2" alt="Grafana_plugins_list"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@Zabbix ~]<span class="comment"># ll /var/lib/grafana/plugins</span></div><div class="line">total 28</div><div class="line">drwxr-xr-x 7 root root 4096 Aug 30 10:14 alexanderzobnin-zabbix-app</div><div class="line">drwxr-xr-x 6 root root 4096 Aug 30 15:03 fastweb-openfalcon-datasource</div><div class="line">drwxr-xr-x 4 root root 4096 Aug 30 10:15 grafana-clock-panel</div><div class="line">drwxr-xr-x 4 root root 4096 Aug 30 14:40 grafana-piechart-panel</div><div class="line">drwxr-xr-x 5 root root 4096 Aug 30 10:15 grafana-simple-json-datasource</div><div class="line">drwxr-xr-x 4 root root 4096 Aug 30 15:31 percona-percona-app</div><div class="line">drwxr-xr-x 4 root root 4096 Aug 30 10:15 raintank-worldping-app</div><div class="line">[root@Zabbix ~]<span class="comment">#</span></div><div class="line">[root@Zabbix ~]<span class="comment"># /etc/init.d/grafana-server start</span></div><div class="line">Starting Grafana Server: .... OK</div><div class="line">[root@Zabbix ~]<span class="comment"># chkconfig --add grafana-server</span></div><div class="line">[root@Zabbix ~]<span class="comment"># chkconfig grafana-server on</span></div></pre></td></tr></table></figure></p>
<p>访问：<a href="http://ip:3000/" target="_blank" rel="external">http://ip:3000/</a><br><img src="http://note.youdao.com/yws/api/personal/file/C6BD03BA70054CDA86E0F06A22565CF4?method=download&amp;shareKey=4fef0d3fa79d4ddac0ddcec59cf0f324" alt="Grafana_login"><br><img src="http://note.youdao.com/yws/api/personal/file/9917D8C1D4C24100B069C89E388D6D3B?method=download&amp;shareKey=1e7ad5cb9d8a03620beebe317425fe18" alt="Grafana">  </p>
<p>安装zabbix插件<br><img src="http://note.youdao.com/yws/api/personal/file/7A07E86DB96749EFB27ED735384BA754?method=download&amp;shareKey=e81b981df1db0df3b7497548f5e3481e" alt="Grafana"><br><img src="http://note.youdao.com/yws/api/personal/file/C630210B1F1B4BF1AA0695CCBED55FC0?method=download&amp;shareKey=675682543eb92186f4ac9dc9a6f88db0" alt="Grafana"><br><img src="http://note.youdao.com/yws/api/personal/file/FB95B45975024294903C014A0EC7452E?method=download&amp;shareKey=503c506c48df2eba416b79fba9eec87b" alt="Grafana"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Zabbix的API地址为“http://192.168.31.130/zabbix/api_jsonrpc.php”，其中IP的安装zabbix-server的服务器IP</div><div class="line">Zabbix的API账号密码就是Zabbix的Web端登录账号和密码</div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/CAE0140CA04D4DF48FE71CC516745D8D?method=download&amp;shareKey=93d4114c12ef3fadfb95511cc90b3ae5" alt="Grafana_datasource"><br><img src="http://note.youdao.com/yws/api/personal/file/4D17740A04754EFD880EE5538BA68F18?method=download&amp;shareKey=90faa224c21a22ea962bca3ab69c043c" alt="Grafana_datasource"><br><img src="http://note.youdao.com/yws/api/personal/file/85BFEE13D1C9484B813E41FF4F94495F?method=download&amp;shareKey=5ab8cd7a870598acce4cc7ac0f34a619" alt="Grafana_datasource">  </p>
<p>新建一个仪表<br><img src="http://note.youdao.com/yws/api/personal/file/7A029D61C3034907A7A478057BECABB2?method=download&amp;shareKey=c01433e248d55b813bafd9932d7260cc" alt="Grafana_table"><br><img src="http://note.youdao.com/yws/api/personal/file/FD53B024CD7F40E3A3A7F4649FF93FEE?method=download&amp;shareKey=7e69a28a18f3f352ff7bb8254a2396e3" alt="Grafana_table"><br><img src="http://note.youdao.com/yws/api/personal/file/665E5D9A6E514558B862359B3DCF8D5E?method=download&amp;shareKey=1d17b900e195a92fd4d234951348dd85" alt="Grafana_table"><br><img src="http://note.youdao.com/yws/api/personal/file/DB3037B236F94787B9152D109D39205E?method=download&amp;shareKey=066caf56955144b5c2a564993d8ee54f" alt="Grafana_table"><br><img src="http://note.youdao.com/yws/api/personal/file/ACEE15EF2DA34CD0B7116DC90A9B8D73?method=download&amp;shareKey=f52e33fc6dc6721525bf5b9dfc4f4d09" alt="Grafana_table"><br><img src="http://note.youdao.com/yws/api/personal/file/82DC4AAFDF744673895B25C90706BA22?method=download&amp;shareKey=f0f36343e8c3cb04a984a98f96761f2b" alt="Grafana_table"><br>OK，Grafana在线安装完成  </p>
<p>看看效果图<br><img src="http://note.youdao.com/yws/api/personal/file/1D8445F4804C435085DE75FBDE27263E?method=download&amp;shareKey=c4fa2915a6d0c49cd5e0a6209a0fba52" alt="Grafana_view"><br><img src="http://note.youdao.com/yws/api/personal/file/8DF5C52B582F494DA2954B8D8827B204?method=download&amp;shareKey=499d5a9b47ace1047965438e21942a1d" alt="Grafana_view"><br><img src="http://note.youdao.com/yws/api/personal/file/07456EC8BB6545CCAB7D2E1318DFCBED?method=download&amp;shareKey=9ca12dd9c5eabd809762f15706fd4164" alt="Grafana_view"><br><img src="http://note.youdao.com/yws/api/personal/file/52FFAD517EBC494DA0FF0B610DCCE4B9?method=download&amp;shareKey=e483df4b036bda1cd7bab7b85caed089" alt="Grafana_view"><br><img src="http://note.youdao.com/yws/api/personal/file/C0B0D4DDAE2F4300A66D28F737E9001A?method=download&amp;shareKey=ac4613af5fcff7c55615905dca9eb00f" alt="Grafana_view">  </p>
<p>用户管理（使用管理员登录）<br><img src="http://note.youdao.com/yws/api/personal/file/D8F5502ED5EE4BC28D325D53138BEBFD?method=download&amp;shareKey=47cc76449f34b867a36f46ca898518bd" alt="Grafana_user"><br>创建Grafana用户并授权<br><img src="http://note.youdao.com/yws/api/personal/file/A40A324FC3534F5280F3D1CAD703782A?method=download&amp;shareKey=dbee8d7330e6bfbf50ef7faeea881762" alt="Grafana_create_user"><br><img src="http://note.youdao.com/yws/api/personal/file/7D17F2BA1B2347A0870FE23DF7389BB4?method=download&amp;shareKey=c3a99d1cb924d7c0fc91802cae6e6a5b" alt="Grafana_create_user"><br><img src="http://note.youdao.com/yws/api/personal/file/9F5FF958A04040D8A0C66BBCDC52794F?method=download&amp;shareKey=fcaeff76d1d9e5d58a2be6c7e243b7cf" alt="Grafana_create_user"><br><img src="http://note.youdao.com/yws/api/personal/file/BBBE8D23CCE149E9B4A8F39BFEA157A1?method=download&amp;shareKey=a19a190c96a5a86fc670a57ffd7136c2" alt="Grafana_create_user"><br><img src="http://note.youdao.com/yws/api/personal/file/1AA4DE107B614001A5DD67B52C8A1553?method=download&amp;shareKey=845ec93e76260b6153ef0d007ac90361" alt="Grafana_create_user">  </p>
<h2 id="部署Grafana数据展示平台-之离线安装"><a href="#部署Grafana数据展示平台-之离线安装" class="headerlink" title="部署Grafana数据展示平台 之离线安装"></a>部署Grafana数据展示平台 之离线安装</h2><p>官网：<a href="http://grafana.org/" target="_blank" rel="external">http://grafana.org/</a><br>环境：<br>　　　Centos 7.2<br>　　　Grafana Version 4.2.0  </p>
<p>Grafana支持多平台安装，目前已知平台有Linux、Windows、Mac、Docker。Linux支持系统有Ubuntu &amp;Debian、Standalone Linux Binaries、Redhat &amp;Centos等等<br>Grafana下载地址：<a href="https://grafana.com/grafana/download" target="_blank" rel="external">https://grafana.com/grafana/download</a>  </p>
<p><a href="https://s3-us-west-2.amazonaws.com/grafana-releases/release/grafana-4.2.0-1.x86_64.rpm" target="_blank" rel="external">下载Grafana for Centos</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#安装Grafana</span></div><div class="line">[root@localhost ~]<span class="comment"># yum -y install grafana-4.2.0-1.x86_64.rpm</span></div><div class="line">[root@localhost ~]<span class="comment"># cd /usr/share/grafana/conf/</span></div><div class="line">[root@localhost ~]<span class="comment"># grep -v ^# /usr/share/grafana/conf/defaults.ini | grep -v ^$</span></div><div class="line">...</div><div class="line"><span class="comment">#allow_sign_up、allow_org_create、auto_assign_org值为false在登录界面就没有Sign Up了</span></div><div class="line">[users]</div><div class="line">allow_sign_up = <span class="literal">false</span></div><div class="line">allow_org_create = <span class="literal">false</span></div><div class="line">auto_assign_org = <span class="literal">false</span></div><div class="line">auto_assign_org_role = Viewer</div><div class="line">verify_email_enabled = <span class="literal">false</span></div><div class="line">login_hint = email or username</div><div class="line">default_theme = dark</div><div class="line">...</div><div class="line">[root@localhost ~]<span class="comment"># systemctl enable grafana-server</span></div><div class="line">[root@localhost ~]<span class="comment"># service grafana-server start</span></div><div class="line">[root@localhost ~]<span class="comment"># mkdir -p /var/log/grafana</span></div></pre></td></tr></table></figure></p>
<p>访问<a href="http://ip:3000" target="_blank" rel="external">http://ip:3000</a><br><img src="http://note.youdao.com/yws/api/personal/file/283EB01F3A4941E29F8AE30FD43E8775?method=download&amp;shareKey=a5c4750aa0f94fb4ef599640a08155d6" alt="Grafana_login">  </p>
<p>安装Grafana插件<br>grafana插件：<a href="https://grafana.com/plugins" target="_blank" rel="external">https://grafana.com/plugins</a> ，这里可以获取Grafana最新插件  </p>
<p>安装Grafana for Zabbix插件<br><a href="https://grafana.com/plugins/alexanderzobnin-zabbix-app" target="_blank" rel="external">alexanderzobnin-zabbix-app</a> 插件用于Grafana通过Zabbix API获取数据并展示数据<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># unzip alexanderzobnin-grafana-zabbix-v3.3.0-0-geca8096.zip</span></div><div class="line">[root@localhost ~]<span class="comment"># cp -rfp alexanderzobnin-grafana-zabbix-eca8096/ /var/lib/g</span></div><div class="line">rafana/plugins/</div><div class="line">[root@localhost ~]<span class="comment"># service grafana-server restart</span></div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/4FA3930F6A92405EA22D6615C4F27B8C?method=download&amp;shareKey=1f06986616b1ada68340d0504fdd2bd8" alt="Grafana_install_plugin"><br><img src="http://note.youdao.com/yws/api/personal/file/DDFE4FD7CED342AB888E8505A9886929?method=download&amp;shareKey=539ea2e4844cb414ca5a7c0d9e7b5801" alt="Grafana_install_plugin"><br><img src="http://note.youdao.com/yws/api/personal/file/7106F5778C6C4BCEB8EC2691F940C1FC?method=download&amp;shareKey=9dcf899b3fdc6449592318587c0f91a9" alt="Grafana_install_plugin">  </p>
<p>安装Grafana其他插件<br>常用插件：<a href="https://grafana.com/plugins/grafana-clock-panel" target="_blank" rel="external">grafana-clock-panel</a>、<a href="https://grafana.com/plugins/grafana-simple-json-datasource" target="_blank" rel="external">grafana-simple-json-datasource</a>、<a href="https://grafana.com/plugins/grafana-piechart-panel" target="_blank" rel="external">grafana-piechart-panel</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># unzip grafana-clock-panel-c5b3c7f.zip</span></div><div class="line">[root@localhost ~]<span class="comment"># cp -rfp grafana-clock-panel-c5b3c7f /var/lib/grafana/plugins/</span></div><div class="line">[root@localhost ~]<span class="comment"># unzip grafana-piechart-panel-ce2ede8.zip</span></div><div class="line">[root@localhost ~]<span class="comment"># cp grafana-piechart-panel-ce2ede8 /var/lib/grafana/plugins/ -rfp</span></div><div class="line">[root@localhost ~]<span class="comment"># unzip grafana-simple-json-datasource-49eeb6d.zip</span></div><div class="line">[root@localhost ~]<span class="comment"># cp -rfp grafana-simple-json-datasource-49eeb6d /var/lib/grafana/plugins/</span></div><div class="line">[root@localhost ~]<span class="comment"># unzip Vonage-Grafana_Status_panel-1.0.4-0-g8bf28f2.zip</span></div><div class="line">[root@localhost ~]<span class="comment"># cp -rfp Vonage-Grafana_Status_panel-8bf28f2/ /var/lib/grafana/plugins/</span></div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment"># ll /var/lib/grafana/plugins/</span></div><div class="line">total 8</div><div class="line">drwxr-xr-x 6 root root 4096 Feb 10 23:30 alexanderzobnin-grafana-zabbix-eca8096</div><div class="line">drwxr-xr-x 4 root root 4096 Mar 18 07:29 grafana-clock-panel-c5b3c7f</div><div class="line">drwxr-xr-x 4 root root  112 Sep 29  2016 grafana-piechart-panel-ce2ede8</div><div class="line">drwxr-xr-x 5 root root  156 Mar 24 00:54 grafana-simple-json-datasource-49eeb6d</div><div class="line">drwxr-xr-x 4 root root  136 Apr 27 18:02 Vonage-Grafana_Status_panel-8bf28f2</div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line">[root@localhost ~]<span class="comment"># grafana-cli plugins ls </span></div><div class="line">installed plugins:</div><div class="line">vonage-status-panel @ 1.0.4 </div><div class="line">alexanderzobnin-zabbix-app @ 3.3.0 </div><div class="line">grafana-clock-panel @ 0.0.9 </div><div class="line">grafana-piechart-panel @ 1.1.4 </div><div class="line">grafana-simple-json-datasource @ 1.3.1 </div><div class="line"></div><div class="line">Restart grafana after installing plugins . &lt;service grafana-server restart&gt;</div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line"><span class="comment">#安装了新的Grafana插件需要重启Grafana</span></div><div class="line">[root@localhost ~]<span class="comment"># service grafana-server restart</span></div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/C95B8C145A5D426DA83765ABCD32AB69?method=download&amp;shareKey=cc367f5f83d84d60348a4207b4b6409b" alt="Grafana_install_plugin"><br>OK，Grafana离线安装完成  </p>
<p>附件：<br><a href="http://note.youdao.com/yws/api/personal/file/5DBEFC3BD49A4A4389EB254F017BEAE5?method=download&amp;shareKey=6e1a225b682c682666f2b06f5f1053a9" target="_blank" rel="external">grafana_install_packages.zip</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/04/29/部署Grafana数据展示系统/">http://www.yfshare.vip/2017/04/29/部署Grafana数据展示系统/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Zabbix之微信(Wechat)告警]]></title>
      <url>http://www.yfshare.vip/2017/04/13/Zabbix%E4%B9%8B%E5%BE%AE%E4%BF%A1-Wechat-%E5%91%8A%E8%AD%A6/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>Zabbix告警可以通过邮件，微信，电话，短信等方式发送告警消息。电话和短信需要向运营商购买相应的网关，需要付费；邮件和微信是免费的，可以根据业务需要选择相应的告警模式<br><a id="more"></a></p>
<h2 id="部署前准备工作"><a href="#部署前准备工作" class="headerlink" title="部署前准备工作"></a>部署前准备工作</h2><p>先申请一个微信企业号：<a href="https://qy.weixin.qq.com" target="_blank" rel="external">https://qy.weixin.qq.com</a><br>申请通过过<a href="https://qy.weixin.qq.com" target="_blank" rel="external">登录</a>该企业号  </p>
<p>注：每个企业号有发送消息限制<br>据说是有消息数限制的  </p>
<ul>
<li>发消息频率。每企业不可超过200次/分钟；不可超过帐号上限数x30人次/天。例如：企业号的注册号的人数上限为200人，注册号一天可以发送200x30=6000人次/天，注意：1条消息发给100人算作100人次。<br>参考：<a href="http://qydev.weixin.qq.com/qa/index.php?qa=29914&amp;qa_1=企业号发布消息有条数限制吗？&amp;show=29914#q29914" target="_blank" rel="external">企业号发布消息数限制</a>  </li>
</ul>
<p>向微信企业号添加部门<br><img src="http://note.youdao.com/yws/api/personal/file/9A74C3796A06442FAB736F9293BF47C7?method=download&amp;shareKey=a9669fcd95dab5382a282862a282879b" alt="weichat_qiyehao">  </p>
<p>向微信企业号新增成员。添加成员后，会生成一个二维码，需要用户扫描关注该微信企业号<br><img src="http://note.youdao.com/yws/api/personal/file/400EBA197981491D9F820AFB94337A0F?method=download&amp;shareKey=9daf4035ea99807443e593907c2fe811" alt="qiyehao_adduser">  </p>
<p>创建应用（消息型应用），并给部门设置管理员（设置—权限管理–新建管理组）<br><img src="http://note.youdao.com/yws/api/personal/file/EE9D4CBA5E224EF6A2F4D998C923A9F3?method=download&amp;shareKey=8f9be28123bf4786673250d257bcb8cf" alt="create_application"><br><img src="http://note.youdao.com/yws/api/personal/file/7F8798ADB8064107A95F0D6B0129A952?method=download&amp;shareKey=4fbec5cec5dfc6b0194e72f1a2146678" alt="qiyehao_app_set">  </p>
<p>要确认管理员能读取通讯录，可以使用应用发送消息<br>注意：这时需要管理员的CorpID和Secret  </p>
<p>我们要准备这些东西：  </p>
<ul>
<li>一个微信企业号</li>
<li>企业号已经被部门成员关注</li>
<li>企业号里有一个可以发消息的应用</li>
<li>一个授权管理员，可以使用该应用给成员发消息</li>
</ul>
<p>我们要取到这些信息：  </p>
<ul>
<li>成员账号</li>
<li>组织部门ID</li>
<li>应用ID</li>
<li>CropID</li>
<li>Secret</li>
</ul>
<h2 id="配置Zabbix之微信告警"><a href="#配置Zabbix之微信告警" class="headerlink" title="配置Zabbix之微信告警"></a>配置Zabbix之微信告警</h2><p>调用微信接口：<br>调用微信接口需要一个调用接口的凭证：access_token<br>通过 ：CropID 、Secret才能获取到access_token，但是获取到的token有效期为两分钟<br><a href="http://qydev.weixin.qq.com/debug" target="_blank" rel="external">http://qydev.weixin.qq.com/debug</a><br><img src="http://note.youdao.com/yws/api/personal/file/FAA655931F1D439793DD0A0E85AF40F8?method=download&amp;shareKey=b5c3ea2a1d938ae1a014746df9cb2e39" alt="weichat_debug">  </p>
<p>Shell脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">curl <span class="_">-s</span> -G  url       获取 AccessToken</div><div class="line">curl --data  url     传送凭证调用企业号接口</div><div class="line">zabbix会传递三个参数给脚本，<span class="variable">$1</span>是消息接收账号，<span class="variable">$2</span>报警标题，<span class="variable">$3</span>报警内容</div></pre></td></tr></table></figure></p>
<p>把脚本放到zabbix告警脚本目录下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@localhost etc]<span class="comment"># grep -i '^AlertScriptsPath' zabbix_server.conf</span></div><div class="line">AlertScriptsPath=/usr/<span class="built_in">local</span>/zabbix/share/zabbix/alertscripts</div><div class="line">[root@CentOS etc]<span class="comment"># cd /usr/local/zabbix/share/zabbix/alertscripts</span></div><div class="line">[root@CentOS alertscripts]<span class="comment"># chmod 755 weixin.sh</span></div><div class="line">[root@CentOS alertscripts]<span class="comment"># chown zabbix:zabbix weixin.sh</span></div></pre></td></tr></table></figure></p>
<p>登录zabbix webGUI：管理–报警媒介类型–创建媒介类型<br><img src="http://note.youdao.com/yws/api/personal/file/5AE07B5F4F9442348AA652A440188C9B?method=download&amp;shareKey=054ef9e8898a679922aa9cc5ec13e59b" alt="zabbix_weichat_warnning"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;ALERT.SENDTO&#125;</div><div class="line">&#123;ALERT.SUBJECT&#125;</div><div class="line">&#123;ALERT.MESSAGE&#125;</div><div class="line">这三个参数在zabbix3.0上必须加上，否则无法发送消息</div></pre></td></tr></table></figure></p>
<p>管理–用户–admin–报警媒介–添加：<br><img src="http://note.youdao.com/yws/api/personal/file/20D63B48DC094209ADEC22BEAF762802?method=download&amp;shareKey=5f5d1d5888a3fbf7d9700977cb287a03" alt="zabbix_wechat_mess">  </p>
<p>创建Trigger和Action（略），发送选择微信<br><img src="http://note.youdao.com/yws/api/personal/file/C58EE9B446BF42CAA697DDE1217582D9?method=download&amp;shareKey=6c59c733bd45500705f106198a9cf5a1" alt="zabbix_wechat_action">  </p>
<p>当条件满足Zabbix Trigger后会触发Action，然后Action调用微信API发送告警消息：<br><img src="http://note.youdao.com/yws/api/personal/file/AA7934E296D648AABF13FF77AE79855C?method=download&amp;shareKey=82b3fc350484396c84b59117b19304c7" alt="image">  </p>
<p>zabbix Action默认消息模版<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">【告警】 &#123;TRIGGER.NAME&#125;\n</div><div class="line"></div><div class="line">告警主机：&#123;HOST.NAME&#125;\n</div><div class="line">主机IP：  &#123;HOST.IP&#125;\n</div><div class="line">告警时间：&#123;EVENT.DATE&#125;  &#123;EVENT.TIME&#125; \n</div><div class="line">告警等级：&#123;TRIGGER.SEVERITY&#125; \n</div><div class="line">告警信息：&#123;TRIGGER.NAME&#125;\n</div><div class="line">问题详情：&#123;ITEM.NAME&#125;:&#123;ITEM.VALUE&#125;\n</div><div class="line">事件ID：  &#123;EVENT.ID&#125;\n</div><div class="line">触发器URL： &#123;TRIGGER.URL&#125;\n</div><div class="line"></div><div class="line">Item values:\n</div><div class="line"></div><div class="line">1. &#123;ITEM.NAME1&#125; (&#123;HOST.NAME1&#125;:&#123;ITEM.KEY1&#125;): &#123;ITEM.VALUE1&#125;\n</div><div class="line">2. &#123;ITEM.NAME2&#125; (&#123;HOST.NAME2&#125;:&#123;ITEM.KEY2&#125;): &#123;ITEM.VALUE2&#125;\n</div><div class="line">3. &#123;ITEM.NAME3&#125; (&#123;HOST.NAME3&#125;:&#123;ITEM.KEY3&#125;): &#123;ITEM.VALUE3&#125;\n</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#微信脚本：</span></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="comment">###SCRIPT_NAME:weixin.sh###</span></div><div class="line"><span class="comment">###send message from weixin for zabbix monitor###</span></div><div class="line"><span class="comment">###wuhf###</span></div><div class="line"><span class="comment">###V1-2015-08-25###</span></div><div class="line">CropID=<span class="string">'1234567890abcdefghi'</span></div><div class="line">Secret=<span class="string">'12435dfh5ysdqwdMD4MI3ORUVpPnd9Q174mXP7'</span></div><div class="line">GURL=<span class="string">"https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=<span class="variable">$CropID</span>&amp;corpsecret=<span class="variable">$Secret</span>"</span> </div><div class="line">Gtoken=$(/usr/bin/curl <span class="_">-s</span> -G <span class="variable">$GURL</span> | awk -F\<span class="string">" '&#123;print <span class="variable">$4</span>&#125;')</span></div><div class="line">PURL="https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=<span class="variable">$Gtoken</span><span class="string">"</span></div><div class="line">function body() &#123;</div><div class="line">        local int AppID=1                        企业号中的应用id</div><div class="line">        local UserID=<span class="variable">$1</span>                          部门成员id，zabbix中定义的微信接收者</div><div class="line">        local PartyID=3                          部门id，定义了范围，组内成员都可接收到消息</div><div class="line">        local Msg=<span class="variable">$(echo "$@" | cut -d" " -f3-)</span>  过滤出zabbix中传递的第三个参数</div><div class="line">        printf '&#123;\n'</div><div class="line">        printf '\t"touser<span class="string">": "</span><span class="string">'"$User"\"",\n"</span></div><div class="line">        printf '\t<span class="string">"toparty"</span>: <span class="string">"'"</span><span class="variable">$PartyID</span><span class="string">"\""</span>,\n<span class="string">"</span></div><div class="line">        printf '\t"msgtype<span class="string">": "</span>text<span class="string">",\n'</span></div><div class="line">        printf '\t"agentid<span class="string">": "</span><span class="string">'" $AppID "\"",\n"</span></div><div class="line">        printf '\t<span class="string">"text"</span>: &#123;\n<span class="string">'</span></div><div class="line">        printf '\t\t<span class="string">"content"</span>: <span class="string">"'"</span><span class="variable">$Msg</span><span class="string">"\""</span>\n<span class="string">"</span></div><div class="line">        printf '\t&#125;,\n'</div><div class="line">        printf '\t"safe<span class="string">":"</span>0<span class="string">"\n'</span></div><div class="line">        printf '&#125;\n'</div><div class="line">&#125;</div><div class="line">/usr/bin/curl --data-ascii "$(body <span class="variable">$1</span> <span class="variable">$2</span> <span class="variable">$3</span>)<span class="string">" <span class="variable">$PURL</span></span></div></pre></td></tr></table></figure>
<h2 id="部署多人接收微信告警消息"><a href="#部署多人接收微信告警消息" class="headerlink" title="部署多人接收微信告警消息"></a>部署多人接收微信告警消息</h2><p>首先登录微信企业号（<a href="https://qy.weixin.qq.com/）" target="_blank" rel="external">https://qy.weixin.qq.com/）</a><br>向微信企业号接收Zabbix告警消息组添加成员<br><img src="http://note.youdao.com/yws/api/personal/file/17F887DE7C884A01934E332E77220771?method=download&amp;shareKey=bca3e12a44445a18ee224caa0d127eb6" alt="weichat_qiyehao_adduser"><br><img src="http://note.youdao.com/yws/api/personal/file/1A04970180AD4D0F96B5340E974FF810?method=download&amp;shareKey=2c9224ac567e884ca3534ba97b57ea62" alt="weichat_qiyehao_adduser"><br><img src="http://note.youdao.com/yws/api/personal/file/AA8CA35D820A490E9510D4521FE5C8CB?method=download&amp;shareKey=6cfc782f00783c728a3b2ceadf43ad93" alt="weichat_qiyehao_adduser">  </p>
<p>这里在部署时设置好后就不需要在操作了<br><img src="http://note.youdao.com/yws/api/personal/file/2E88038AF4814B7F85AB7B7A5782AC7F?method=download&amp;shareKey=e666f11a513f2926a71b28c555e0fcf6" alt="image">  </p>
<p>登录Zabbix Web Gui<br>管理–用户–admin–报警媒介–微信<br><img src="http://note.youdao.com/yws/api/personal/file/B3039377906B4D5A8DBAC67B379E9A4F?method=download&amp;shareKey=43fd59327f2a5e613bf9cb67443d3c83" alt="zabbix_weichat_mess_adduser">  </p>
<p>测试<br><img src="http://note.youdao.com/yws/api/personal/file/D974AE71BAC64D56A025543156B82354?method=download&amp;shareKey=bcd9d048f215fb8398f2c8eb5d2a638c" alt="test_weichat_mess_success"><br>成功  </p>
<p>附件：<br><a href="http://note.youdao.com/yws/api/personal/file/514487CA90F1482AA53BA3E7B81CF4FF?method=download&amp;shareKey=fda0d641c4d0b542cbbf2e2d300d4d7f" target="_blank" rel="external">weichat.sh</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/04/13/Zabbix之微信-Wechat-告警/">http://www.yfshare.vip/2017/04/13/Zabbix之微信-Wechat-告警/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[部署Oracle-RAC集群]]></title>
      <url>http://www.yfshare.vip/2017/04/12/%E9%83%A8%E7%BD%B2Oracle-RAC%E9%9B%86%E7%BE%A4/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>RAC：real application clusters introduction  </p>
<p>ORACLE RAC原理：<br>在一个应用环境当中，所有的服务器使用和管理同一个数据库，目的是为了分散每一台服务器的工作量，硬件上至少需要两台以上的服务器，而且还需一个共享存储设备。还需要两类软件，一个是集群软件，另外一个就是Oracle数据库中的RAC组件，所有服务器上的OS都应该是同一类OS。<br><a id="more"></a><br>根据负载均衡的配置策略，当一个客户端发送请求到某一台服务的listener后，这台服务器根据负载均衡策略，会把请求发送给本机的RAC组件处理，也可能会发送给另外一台服务器的RAC组件处理，处理完请求后，RAC会通过集群软件来访问我们的共享存储设备。</p>
<p>逻辑结构上，每一个参加集群的节点有一个独立的instance，这些instance访问同一个数据库。节点之间通过集群软件的通讯层（communication layer）来进行通讯。同时为了减少IO的消耗，存在了一个全局缓存服务，因此每一个数据库的instance，都保留了一份相同的数据库cache。</p>
<p>RAC中的特点是：<br>每一个节点的instance都有自己的SGA，background process，redo logs，undo表空间<br>所有节点都共享一份datafiles和controlfiles</p>
<p>Oracle缓存融合技术(Cache fusion):  </p>
<ol>
<li>保证缓存的一致性  </li>
<li>减少共享磁盘IO的消耗</li>
</ol>
<p>缓存融合原理：  </p>
<ol>
<li>其中一个节点会从共享数据库中读取一个block到db cache中</li>
<li>这个节点会在所有的节点进行交叉db block copy</li>
<li>当任何一个节点缓存被修改的时候，就会在节点之间进行缓存修改</li>
<li>为了达到存储的一致最终修改的结果也会写到磁盘上</li>
</ol>
<p>ClusterWare组件：<br>有四种服务  </p>
<ul>
<li>Crsd - 集群资源服务</li>
<li>Cssd - 集群同步服务</li>
<li>Evmd - 事件管理服务</li>
<li>oprocd - 节点检测监控</li>
</ul>
<p>三类Resource  </p>
<ul>
<li>VIP - 虚拟IP地址(Virtual IP)</li>
<li>OCR - Oracle Cluster Registry(集群注册文件),记录每个节点的相关信息</li>
<li>Voting Disk - Establishes quorum (表决磁盘),仲裁机制用于仲裁多个节点向共享节点同时写的行为，这样做是为了避免发生冲突</li>
</ul>
<p>RAC组件：<br>提供过了额外的进程，用来维护数据库  </p>
<ul>
<li>LMS - Gobal Cache Service Process 全局缓存服务进程</li>
<li>LMD - Global Enqueue Service Daemon 全局查询服务守护进程</li>
<li>LMON - Global Enqueue Service Monitor全局查询服务监视进程</li>
<li>LCK0 - Instance Enqueue Process 实例查询进程</li>
</ul>
<h2 id="规划"><a href="#规划" class="headerlink" title="规划"></a>规划</h2><p>拓扑图：<br><img src="http://note.youdao.com/yws/api/personal/file/36F1D89D60D64C6AAD28358C84DCE3BF?method=download&amp;shareKey=87cdeb07ee5b622b6164e2f6d6c746b1" alt="tuopu">  </p>
<p>IP规划</p>
<table>
<thead>
<tr>
<th style="text-align:center">Node</th>
<th style="text-align:center">Public IP(Bond0)</th>
<th style="text-align:center">Heartbeat(eth2)</th>
<th style="text-align:center">Private IP</th>
<th style="text-align:center">System</th>
<th style="text-align:center">hostname</th>
<th style="text-align:center">Memory</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">RAC1</td>
<td style="text-align:center">192.168.100.241/24</td>
<td style="text-align:center">192.168.90.1/24</td>
<td style="text-align:center">eth3：192.168.80.1/24</td>
<td style="text-align:center">Centos 6.4</td>
<td style="text-align:center">rac1.example.com</td>
<td style="text-align:center">3G</td>
</tr>
<tr>
<td style="text-align:center">RAC2</td>
<td style="text-align:center">192.168.100.242/24</td>
<td style="text-align:center">192.168.90.2/24</td>
<td style="text-align:center">eth3：192.168.80.1/24</td>
<td style="text-align:center">Centos 6.4</td>
<td style="text-align:center">rac2.example.com</td>
<td style="text-align:center">3G</td>
</tr>
<tr>
<td style="text-align:center">Storage</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">bond0：192.168.80.3/24</td>
<td style="text-align:center">CentOS 6.4</td>
<td style="text-align:center">iscsi</td>
<td style="text-align:center">512M</td>
</tr>
</tbody>
</table>
<p>Storage磁盘规划</p>
<table>
<thead>
<tr>
<th>存储组件</th>
<th>文件系统</th>
<th>卷大小</th>
<th>ASM卷组名</th>
<th>ASM冗余</th>
<th>ASM磁盘组</th>
</tr>
</thead>
<tbody>
<tr>
<td>OCR/表决磁盘</td>
<td>ASM</td>
<td>2G</td>
<td>+CRS</td>
<td>External</td>
<td>DISK1</td>
</tr>
<tr>
<td>数据库文件</td>
<td>ASM</td>
<td>40G</td>
<td>+RACDB_DATA</td>
<td>External</td>
<td>DISK2</td>
</tr>
<tr>
<td>快速恢复区</td>
<td>ASM</td>
<td>40G</td>
<td>+FRA</td>
<td>External</td>
<td>DISK3</td>
</tr>
</tbody>
</table>
<h2 id="安装前准备"><a href="#安装前准备" class="headerlink" title="安装前准备"></a>安装前准备</h2><p>环境：Centos 6.4<br>　　　Oracle 11.2.0.4  </p>
<p>附件：<br><a href="http://note.youdao.com/yws/api/personal/file/3F26DCE4F66E4A92955421AD81907702?method=download&amp;shareKey=171e55b45eb00b0b4a04c19c94713f9d" target="_blank" rel="external">hosts</a><br><a href="http://note.youdao.com/yws/api/personal/file/EBE77CFA3E284EB6B536742A65ACB240?method=download&amp;shareKey=532b531d1b9e1b365f917c08268b1058" target="_blank" rel="external">cvuqdisk-1.0.9-1.rpm</a><br><a href="http://note.youdao.com/yws/api/personal/file/E8045FCC036D451CACE873C042919AB3?method=download&amp;shareKey=c990c68ec5fe93a69e4cfd97310d9ba9" target="_blank" rel="external">pdksh-5.2.14-1.i386.rpm</a><br><a href="http://note.youdao.com/yws/api/personal/file/918F64A65F6B4723AE40E7415A0D0D97?method=download&amp;shareKey=0671839fd7336ba472007fd158a0b91c" target="_blank" rel="external">plsql+instantclient_11_2安装包</a>  </p>
<p>利用ISCSI搭建后台存储<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@iscsi ~]<span class="comment"># tgt-admin -s|grep -i target</span></div><div class="line">Target 1: iqn.disk1</div><div class="line">Target 2: iqn.disk2</div><div class="line">Target 3: iqn.disk3</div><div class="line">[root@iscsi ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>rac1和rac2挂载后分区<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@rac1 software]<span class="comment"># fdisk -l|grep sd|tail -n 3</span></div><div class="line">Disk /dev/sdb: 2147 MB, 2147483648 bytes</div><div class="line">Disk /dev/sdc: 42.9 GB, 42949672960 bytes</div><div class="line">Disk /dev/sdd: 42.9 GB, 42949672960 bytes</div><div class="line">[root@rac1 software]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@rac1 ~]<span class="comment"># hostname</span></div><div class="line">rac1.example.com</div><div class="line">[root@rac1 ~]<span class="comment">#</span></div><div class="line">[root@rac2 ~]<span class="comment"># hostname</span></div><div class="line">rac2.example.com</div><div class="line">[root@rac2 ~]<span class="comment">#</span></div><div class="line">[root@rac1 ~]<span class="comment"># ping rac2.example.com -c 3</span></div><div class="line">PING rac2 (192.168.100.242) 56(84) bytes of data.</div><div class="line">64 bytes from rac2 (192.168.100.242): icmp_seq=1 ttl=64 time=0.622 ms</div><div class="line">64 bytes from rac2 (192.168.100.242): icmp_seq=2 ttl=64 time=0.369 ms</div></pre></td></tr></table></figure>
<p>在rac1和rac2上需要做地址解析<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">[root@rac1 ~]<span class="comment"># tail -n 19 /etc/hosts</span></div><div class="line"><span class="comment">#Public Network</span></div><div class="line">192.168.100.241	rac1	rac1.example.com</div><div class="line">192.168.100.242 rac2	rac2.example.com</div><div class="line"></div><div class="line"><span class="comment">#Public Virtual IP (VIP) addresses</span></div><div class="line">192.168.100.244	rac1-vip</div><div class="line">192.168.100.245	rac2-vip</div><div class="line"></div><div class="line"><span class="comment">#Single Client Access Name (SCAN)</span></div><div class="line">192.168.100.246	racscan</div><div class="line"></div><div class="line"><span class="comment">#Private Interconnect</span></div><div class="line">192.168.90.1 rac1-priv</div><div class="line">192.168.90.2 rac2-priv</div><div class="line"></div><div class="line"><span class="comment">#Private Storage Network</span></div><div class="line">192.168.80.1 rac1<span class="_">-s</span></div><div class="line">192.168.80.2 rac2<span class="_">-s</span></div><div class="line">192.168.80.3 iscsi</div><div class="line">[root@rac1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>关闭防火墙和Selinux<br>要求：内存至少2G，swap：16GB内存以内内存的1.5或者1倍，16GB内存以上设置16GB<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@rac1 software]<span class="comment"># uname -a</span></div><div class="line">Linux rac1 2.6.32-358.el6.x86_64 <span class="comment">#1 SMP Fri Feb 22 00:31:26 UTC 2013 x86_64 x86_64 x86_64 GNU/Linux</span></div><div class="line">[root@rac1 ~]<span class="comment">#</span></div><div class="line">[root@rac1 ~]<span class="comment"># ntpdate time.windows.com</span></div><div class="line">[root@rac1 ~]<span class="comment"># df -h|grep shm</span></div><div class="line">tmpfs                  10G     0   10G   0% /dev/shm</div><div class="line">[root@rac1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/DD5C35B377C24C52BEA24662EB8338CE?method=download&amp;shareKey=b2cc6c7953190c0f83d0e38c951df89e" alt="image"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@rac1 ~]<span class="comment"># yum -y install binutils* elfutils-libelf* compat-libstdc++* compat-libcap1* gcc gcc-c++ ksh libaio* libgcc* libstdc++* make* sysstat unixODBC* glibc*</span></div><div class="line">[root@rac1 ~]<span class="comment"># rpm -ivh pdksh-5.2.14-1.i386.rpm --nodeps --force</span></div><div class="line">[root@rac1 ~]<span class="comment"># yum -y install xhost</span></div><div class="line">[root@rac1 ~]<span class="comment"># groupadd oinstall</span></div><div class="line">[root@rac1 ~]<span class="comment"># groupadd dba</span></div><div class="line">[root@rac1 ~]<span class="comment"># groupadd oper</span></div><div class="line">[root@rac1 ~]<span class="comment"># groupadd asmadmin</span></div><div class="line">[root@rac1 ~]<span class="comment"># groupadd asmoper</span></div><div class="line">[root@rac1 ~]<span class="comment"># groupadd asmdba</span></div><div class="line">[root@rac1 ~]<span class="comment"># useradd -g oinstall -G asmadmin,asmdba,asmoper,dba grid</span></div><div class="line">[root@rac1 ~]<span class="comment"># useradd -g oinstall -G dba,asmdba,oper oracle</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#资源限制</span></div><div class="line">[root@rac1 ~]<span class="comment"># tail -n 12 /etc/security/limits.conf</span></div><div class="line"><span class="comment">#for oracle</span></div><div class="line">oracle soft nproc 2047</div><div class="line">oracle hard nproc 16384</div><div class="line">oracle soft nofile 1024</div><div class="line">oracle hard nofile 65536</div><div class="line">oracle soft stack 10240</div><div class="line"><span class="comment">#for grid</span></div><div class="line">grid soft nproc 2047</div><div class="line">grid hard nproc 16384</div><div class="line">grid soft nofile 1024</div><div class="line">grid hard nofile 65536</div><div class="line">grid soft stack 10240</div><div class="line">[root@rac1 ~]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@rac1 ~]<span class="comment"># tail -n 2 /etc/pam.d/login</span></div><div class="line"><span class="comment">#oracle</span></div><div class="line">session	  required	pam_limits.so</div><div class="line">[root@rac1 ~]<span class="comment">#</span></div><div class="line">[root@rac1 ~]<span class="comment"># tail -n 12 /etc/sysctl.conf</span></div><div class="line"><span class="comment">#oracle</span></div><div class="line">fs.aio-max-nr = 1048576</div><div class="line">fs.file-max = 6815744</div><div class="line">kernel.shmall = 2097152</div><div class="line">kernel.shmmax = 4294967295</div><div class="line">kernel.shmmni = 4096</div><div class="line">kernel.sem = 250 32000 100 128</div><div class="line">net.ipv4.ip_local_port_range = 9000 65500</div><div class="line">net.core.rmem_default = 262144</div><div class="line">net.core.rmem_max = 4194304</div><div class="line">net.core.wmem_default = 262144</div><div class="line">net.core.wmem_max = 1048576</div><div class="line">[root@rac1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@rac1 ~]<span class="comment"># mkdir -p /u01/app/grid</span></div><div class="line">[root@rac1 ~]<span class="comment"># mkdir -p /u01/app/11.2.0/grid</span></div><div class="line">[root@rac1 ~]<span class="comment"># chown -R grid:oinstall /u01</span></div><div class="line">[root@rac1 ~]<span class="comment"># mkdir -p /u01/app/oracle</span></div><div class="line">[root@rac1 ~]<span class="comment"># chown -R oracle:oinstall /u01/app/oracle</span></div><div class="line">[root@rac1 ~]<span class="comment"># chmod -R 775 /u01</span></div><div class="line">[root@rac1 ~]<span class="comment"># mkdir /oradata</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#设置环境变量</span></div><div class="line">[root@rac1 ~]<span class="comment"># su - oracle</span></div><div class="line">[oracle@rac1 ~]$ tail -n 8 .bash_profile</div><div class="line"><span class="comment">#oracle</span></div><div class="line"><span class="built_in">export</span> ORACLE_BASE=/u01/app/oracle</div><div class="line"><span class="built_in">export</span> ORACLE_SID=racdb1</div><div class="line"><span class="built_in">export</span> ORACLE_HOME=<span class="variable">$ORACLE_BASE</span>/product/11.2.0/db_1</div><div class="line"><span class="built_in">export</span> LD_LIBARY_PATH=<span class="variable">$ORACLE_HOME</span>/lib</div><div class="line"><span class="built_in">export</span> PATH=<span class="variable">$ORACLE_HOME</span>/bin:<span class="variable">$PATH</span></div><div class="line"><span class="built_in">export</span> ORACLE_UNQNAME=racdb</div><div class="line"><span class="built_in">umask</span> 022</div><div class="line">[oracle@rac1 ~]$ <span class="built_in">source</span> .bash_profile</div><div class="line">[oracle@rac1 ~]$ <span class="built_in">echo</span> <span class="variable">$ORACLE_HOME</span></div><div class="line">/u01/app/oracle/product/11.2.0/db_1</div><div class="line">[oracle@rac1 ~]$ <span class="built_in">echo</span> <span class="variable">$ORACLE_BASE</span></div><div class="line">/u01/app/oracle</div><div class="line">[oracle@rac1 ~]$</div><div class="line"></div><div class="line">[grid@rac1 ~]$ tail -n 7 .bash_profile</div><div class="line"><span class="comment">#oracle</span></div><div class="line"><span class="built_in">export</span> ORACLE_BASE=/u01/app/grid</div><div class="line"><span class="built_in">export</span> ORACLE_SID=+ASM1</div><div class="line"><span class="built_in">export</span> ORACLE_HOME=/u01/app/11.2.0/grid</div><div class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=<span class="variable">$ORACLE_HOME</span>/lib</div><div class="line"><span class="built_in">export</span> PATH=<span class="variable">$ORACLE_HOME</span>/bin:<span class="variable">$PATH</span></div><div class="line"><span class="built_in">umask</span> 022</div><div class="line">[grid@rac1 ~]$ <span class="built_in">source</span> .bash_profile</div><div class="line">[gr[grid@rac1 ~]$ <span class="built_in">echo</span> <span class="variable">$ORACLE_BASE</span></div><div class="line">/u01/app/grid</div><div class="line">[grid@rac1 ~]$ <span class="built_in">echo</span> <span class="variable">$ORACLE_HOME</span></div><div class="line">/u01/app/11.2.0/grid</div><div class="line">[grid@rac1 ~]$</div><div class="line"></div><div class="line">[grid@rac2 ~]$ grep SID .bash_profile</div><div class="line"><span class="built_in">export</span> ORACLE_SID=+ASM2</div><div class="line">[grid@rac2 ~]$</div><div class="line"></div><div class="line">[oracle@rac2 ~]$ grep SID .bash_profile</div><div class="line"><span class="built_in">export</span> ORACLE_SID=racdb2</div><div class="line">[oracle@rac2 ~]$</div><div class="line">以上步骤第二个节点也同样操作</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#配置SSH互信</span></div><div class="line">[grid@rac1 sshsetup]$ <span class="built_in">pwd</span></div><div class="line">/software/grid/sshsetup</div><div class="line">[grid@rac1 sshsetup]$ ./sshUserSetup.sh -user grid -hosts rac2.example.com -advanced -exverify -confirm -noPromptPassphrase</div><div class="line">[grid@rac1 sshsetup]$</div></pre></td></tr></table></figure>
<p><img src="http://note.youdao.com/yws/api/personal/file/9118C973FE614DCCBBA3F5BA6AEB41EC?method=download&amp;shareKey=a34b7dbec01e15dcd522013c0045af23" alt="ssh互信"><br><img src="http://note.youdao.com/yws/api/personal/file/6912860CAE2C4AADB5861B26A578A7CA?method=download&amp;shareKey=f7498f91cf7007e3b73de0362548bbdf" alt="ssh互信">  </p>
<p>检查下会不会出现下面的情况。如果出现在测试SSH互信时会包INS-06006的错误<br><img src="http://note.youdao.com/yws/api/personal/file/1FD46DDB71034ACEBB41F2C3B5C16104?method=download&amp;shareKey=71aa8faaca754212dc512af07d428f1f" alt="ssh_date1"><br><img src="http://note.youdao.com/yws/api/personal/file/843B1CBBA6B149D7B10D5DACB4424B11?method=download&amp;shareKey=da67f85fc412182ed0ea0900020cedc4" alt="ssh_date2"><br><img src="http://note.youdao.com/yws/api/personal/file/4315C5D7C6604B67AF2AD4BA8EB8C182?method=download&amp;shareKey=dcdc2804e2d9e67c62675b387b03cf58" alt="image"><br><img src="http://note.youdao.com/yws/api/personal/file/DB73EC487F3B42CDA69B8F5689922938?method=download&amp;shareKey=9edb234b13e3501524f96774150519b1" alt="image">  </p>
<p>安装cvuqdisk，发现共享磁盘(rac1和rac2都安装)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@rac1 ~]<span class="comment"># CVUQDISK_GRP=oinstall &amp;&amp; export CVUQDISK_GRP</span></div><div class="line">[root@rac1 software]<span class="comment"># yum -y install smartmontools</span></div><div class="line">[root@rac1 software]<span class="comment"># yum -y install cvuqdisk-1.0.9-1.rpm</span></div></pre></td></tr></table></figure></p>
<p>使用UDEV绑定ASM<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@rac1 ~]<span class="comment"># echo "options=--whitelisted --replace-whitespace"  &gt;&gt; /etc/scsi_id.config</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#UDEV绑定ASM脚本</span></div><div class="line"><span class="built_in">declare</span> -i num =0</div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> b c d;</div><div class="line"><span class="keyword">do</span></div><div class="line"><span class="built_in">let</span> num=<span class="variable">$num</span>+1</div><div class="line"><span class="built_in">echo</span> <span class="string">"KERNEL==\"sd*\", BUS==\"scsi\", PROGRAM==\"/sbin/scsi_id --whitelisted --replace-whitespace --device=/dev/\$name\", RESULT==\"`/sbin/scsi_id --whitelisted --replace-whitespace --device=/dev/sd<span class="variable">$i</span>`\", NAME=\"asm-disk<span class="variable">$num</span>\", OWNER=\"grid\", GROUP=\"asmadmin\", MODE=\"0660\""</span> &gt;&gt; /etc/udev/rules.d/12-oracle-asmdevices.rules</div><div class="line"><span class="keyword">done</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#使用start_udev命令重新启动udev服务</span></div><div class="line">[root@rac1 ~]<span class="comment"># start_udev</span></div><div class="line">Starting udev:                                             [  OK  ]</div><div class="line">[root@rac1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#12-oracle-asmdevices.rules</span></div><div class="line"><span class="comment">#UDEV策略</span></div><div class="line">KERNEL==<span class="string">"sd*"</span>, BUS==<span class="string">"scsi"</span>, PROGRAM==<span class="string">"/sbin/scsi_id --whitelisted --replace-whitespace --device=/dev/<span class="variable">$name</span>"</span>, RESULT==<span class="string">"1IET_00010001"</span>, NAME=<span class="string">"asm-disk1"</span>, OWNER=<span class="string">"grid"</span>, GROUP=<span class="string">"asmadmin"</span>, MODE=<span class="string">"0660"</span></div><div class="line">KERNEL==<span class="string">"sd*"</span>, BUS==<span class="string">"scsi"</span>, PROGRAM==<span class="string">"/sbin/scsi_id --whitelisted --replace-whitespace --device=/dev/<span class="variable">$name</span>"</span>, RESULT==<span class="string">"1IET_00020002"</span>, NAME=<span class="string">"asm-disk2"</span>, OWNER=<span class="string">"grid"</span>, GROUP=<span class="string">"asmadmin"</span>, MODE=<span class="string">"0660"</span></div><div class="line">KERNEL==<span class="string">"sd*"</span>, BUS==<span class="string">"scsi"</span>, PROGRAM==<span class="string">"/sbin/scsi_id --whitelisted --replace-whitespace --device=/dev/<span class="variable">$name</span>"</span>, RESULT==<span class="string">"1IET_00030003"</span>, NAME=<span class="string">"asm-disk3"</span>, OWNER=<span class="string">"grid"</span>, GROUP=<span class="string">"asmadmin"</span>, MODE=<span class="string">"0660"</span></div></pre></td></tr></table></figure>
<p><img src="http://note.youdao.com/yws/api/personal/file/4968F05A3DAC4C71A8E945E8C3E6DBB3?method=download&amp;shareKey=c8d8aab71065291750db66df1e62939d" alt="image"><br>固化磁盘后Linux就无法读取到/dev/sdb、/dev/sdc、/dev/sdd了，在rac1上固化磁盘后，rac2上也需要执行下上面的脚本，注意匹配PROGRAM的值，需要与节点一的相同<br>注：如果使用UDEV绑定磁盘后所属组不是asmadmin，需要手动改下，否则在创建数据库(dbca)时会报错，如下图：<br><img src="http://note.youdao.com/yws/api/personal/file/FE485775F730495B8D65775CAF10F0A0?method=download&amp;shareKey=a48e258d0439272956fc6a1228eb14df" alt="image"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@rac1 ~]<span class="comment"># chown grid:asmadmin /dev/asm-disk*</span></div><div class="line">[root@rac1 ~]<span class="comment"># echo "chown grid:asmadmin /dev/asm-disk*" &gt;&gt;/etc/rc.local</span></div></pre></td></tr></table></figure></p>
<p>更改后：<br><img src="http://note.youdao.com/yws/api/personal/file/7D70E68FA40A4B8F9337103C37F19FD6?method=download&amp;shareKey=c2cef35b5512fbfd2fb5be4348694769" alt="image">  </p>
<h2 id="安装Grid"><a href="#安装Grid" class="headerlink" title="安装Grid"></a>安装Grid</h2><p>用grid用户登录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[grid@rac1 grid]$ <span class="built_in">export</span> DISPLAY=192.168.100.251:0.0</div><div class="line">[grid@rac1 grid]$ ./runInstaller</div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/FE8E61CC6E3E45F6A26DC92ED45D55D9?method=download&amp;shareKey=102774b58ddc8d9968ed2522a262bdd3" alt="grid_install"><br><img src="http://note.youdao.com/yws/api/personal/file/CFD0CBA42ABD4398AA646F45E51E8F3E?method=download&amp;shareKey=50203b8136874ce61978cf085e26bdc5" alt="grid_install"><br><img src="http://note.youdao.com/yws/api/personal/file/CCC009BB056645339376A817ADBBDE2C?method=download&amp;shareKey=bf0c55f1a04c50bd2ff6a191d0d29083" alt="grid_install"><br><img src="http://note.youdao.com/yws/api/personal/file/2E31CD4F29A349308C5EDE45C297C8F8?method=download&amp;shareKey=4efb135eed5c139437b4212f06e57280" alt="grid_install">  </p>
<p>需要在/etc/hosts里面解析racscan，否则会报：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[INS-40718] Single Client Access Name (SCAN):RACSCAN1 could not be resolved.</div></pre></td></tr></table></figure></p>
<p>但racscan不是真实存在的地址<br><img src="http://note.youdao.com/yws/api/personal/file/FF0748FF48B142AB859C7D9963B1B45B?method=download&amp;shareKey=b45ec81818a4873f70e445528eb77bca" alt="grid_install">  </p>
<p>Test和Setup均能通过<br><img src="http://note.youdao.com/yws/api/personal/file/17D7FE8F5E43433D8A4F8C2E3598D9EA?method=download&amp;shareKey=89108bde8e1ce16654c058b090ec0af5" alt="grid_install">  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[INS-40912] Virtual host name: rac1-vip is assigned to another system on the network.</div></pre></td></tr></table></figure>
<p>参考：<a href="https://community.oracle.com/thread/2594182" target="_blank" rel="external">https://community.oracle.com/thread/2594182</a><br>如果出现上面的报错信息，看下/etc/hosts里面的Virtual IP是否存在，ping一下<br><img src="http://note.youdao.com/yws/api/personal/file/2BDD7464264E45468E94FE7B82FE317C?method=download&amp;shareKey=9f0d48e5dbe439b46ae4e9d5fcdd0e3c" alt="rac_vip">  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/2BF28D6032274BC0935B3751AB90C015?method=download&amp;shareKey=a5ea2082ec4ad6802f2465ffa1e18f31" alt="grid_install"><br><img src="http://note.youdao.com/yws/api/personal/file/D90DA12B5BBD4EE294AE2F545BC73CF5?method=download&amp;shareKey=7b5c6c05a3a4d708b19d6347920a5de7" alt="grid_install"><br><img src="http://note.youdao.com/yws/api/personal/file/7EB263CDE75C4802AA045A3FBF22919A?method=download&amp;shareKey=7f4e16907a66e49ed5ef2a2c0e8760c4" alt="grid_install"><br><img src="http://note.youdao.com/yws/api/personal/file/900E5DE683CA470386D1F63D16A39162?method=download&amp;shareKey=9e185e802aa2c8d2b75b46d99d1ff2d3" alt="grid_install"><br><img src="http://note.youdao.com/yws/api/personal/file/8409B55D39224F64A3B631A9C38B198B?method=download&amp;shareKey=06b72a1b028c64847704e4f5334a5a09" alt="grid_install"><br><img src="http://note.youdao.com/yws/api/personal/file/9891079073064BDAA3E1D6024AAFEB87?method=download&amp;shareKey=2dfe1d8c8cc1e5fc752c489830813baf" alt="grid_install">  </p>
<p>在grid用户的环境变量，$ORACLE_HOME  不能是  $ORACLE_BASE  子目录，否则会报错：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ORACLE 11G RAC [INS-32026] The Software Location specified should not</div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/1FE9A53C986042DEAFE66CD3DD533AB9?method=download&amp;shareKey=ff9b937ad40d6907acf04fd05f8a4806" alt="grid_install"><br><img src="http://note.youdao.com/yws/api/personal/file/DC323BFFE5044728B6025E7309DF4574?method=download&amp;shareKey=f91d6af7a55af38fb301679989c79bc7" alt="grid_install">  </p>
<p>因为这里使用是的udev绑定，这个警告可以忽略<br><img src="http://note.youdao.com/yws/api/personal/file/BC0579F86B5149E693285E4523E403D2?method=download&amp;shareKey=6227b8857a1a02cf34d1dedf3b6bbbb7" alt="grid_install"><br><img src="http://note.youdao.com/yws/api/personal/file/9C7E26FF75BA443A9B82D6EA84DE664D?method=download&amp;shareKey=f022760193ab0d46240a5d51f1ff68ef" alt="grid_install">  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@rac1 ~]<span class="comment"># /u01/app/oraInventory/orainstRoot.sh</span></div><div class="line">Changing permissions of /u01/app/oraInventory.</div><div class="line">Adding <span class="built_in">read</span>,write permissions <span class="keyword">for</span> group.</div><div class="line">Removing <span class="built_in">read</span>,write,execute permissions <span class="keyword">for</span> world.</div><div class="line"></div><div class="line">Changing groupname of /u01/app/oraInventory to oinstall.</div><div class="line">The execution of the script is complete.</div><div class="line">[root@rac1 ~]<span class="comment">#</span></div><div class="line">[root@rac1 ~]<span class="comment"># /u01/app/11.2.0/grid/root.sh</span></div></pre></td></tr></table></figure>
<p>执行上面这个脚本如果报下面的错误<br><img src="http://note.youdao.com/yws/api/personal/file/A8F28B38E831479288A74182A788A7CE?method=download&amp;shareKey=258f1581e7fd15d73a768c0b1c870fbf" alt="grid_root"><br>解决方法：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@rac1 ~]<span class="comment"># yum -y install compat-libcap1*</span></div></pre></td></tr></table></figure></p>
<p>再执行/u01/app/11.2.0/grid/root.sh就没问题了<br>执行过程如下：<br><a href="http://note.youdao.com/yws/api/personal/file/5F86C7E0A3564106AAE09443614C4DB3?method=download&amp;shareKey=cd8ebff8d5e7a14cb9a5f306aced24e1" target="_blank" rel="external">rac1_u01_app_11.2.0_grid_root.sh执行过程</a><br><a href="http://note.youdao.com/yws/api/personal/file/7E8ACFD112234C4EAA6CFE3C598B81F1?method=download&amp;shareKey=b26ccf10fcffe85e535e19acb0045a8b" target="_blank" rel="external">rac1_u01_app_11.2.0_grid_root.sh执行过程</a><br>在rac1和rac2上都执行下↑↑↑(/u01/app/oraInventory/orainstRoot.sh和/u01/app/11.2.0/grid/root.sh)<br>在Install Product过程中如果出现下面的情况：(忽略）<br><img src="http://note.youdao.com/yws/api/personal/file/F91F56DC002140609177534DF6FA056D?method=download&amp;shareKey=1550687b6616e3380e772de03c512112" alt="grid_install">  </p>
<p>如果出现这个错误且能ping通racscan地址(192.168.100.246)，则可忽略<br><img src="http://note.youdao.com/yws/api/personal/file/F31B12CB31274E2CA5C7E869A0748EA9?method=download&amp;shareKey=61375d52ca2da7f0e08dd2c1e82fc6df" alt="grid_install"><br><img src="http://note.youdao.com/yws/api/personal/file/B0B0273158F3455B90DCD83990DD8F70?method=download&amp;shareKey=be794a83daed905874d9c917a85ded8d" alt="ping_racscan"><br><img src="http://note.youdao.com/yws/api/personal/file/6CC8AFF1F00D49A08ADFB36ACF617494?method=download&amp;shareKey=5ff8cb14275aba741f968b0d4f7fedf9" alt="grid_install">  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#检查crs状态</span></div><div class="line">[grid@rac1 grid]$ crsctl check crs</div><div class="line">CRS-4638: Oracle High Availability Services is online</div><div class="line">CRS-4537: Cluster Ready Services is online</div><div class="line">CRS-4529: Cluster Synchronization Services is online</div><div class="line">CRS-4533: Event Manager is online</div><div class="line"></div><div class="line"><span class="comment">#打印节点编号和节点名</span></div><div class="line">[grid@rac1 grid]$ olsnodes -n</div><div class="line">rac1	1</div><div class="line">rac2	2</div><div class="line"></div><div class="line"><span class="comment">#检测ctss状态</span></div><div class="line">[grid@rac1 grid]$ crsctl check ctss</div><div class="line">CRS-4701: The Cluster Time Synchronization Service is <span class="keyword">in</span> Active mode.</div><div class="line">CRS-4702: Offset (<span class="keyword">in</span> msec): 0</div><div class="line"></div><div class="line"><span class="comment">#显示指定数据库当前状态</span></div><div class="line">[grid@rac1 grid]$ srvctl status asm <span class="_">-a</span></div><div class="line">ASM is running on rac2,rac1</div><div class="line">ASM is enabled.</div><div class="line"></div><div class="line"><span class="comment">#显示注册Oracle集群的健康状态</span></div><div class="line">[grid@rac1 grid]$ ocrcheck</div><div class="line">Status of Oracle Cluster Registry is as follows :</div><div class="line">  Version                  :          3</div><div class="line">  Total space (kbytes)     :     262120</div><div class="line">  Used space (kbytes)      :       2592</div><div class="line">  Available space (kbytes) :     259528</div><div class="line">  ID                       : 1975731354</div><div class="line">  Device/File Name         :       +CRS</div><div class="line">                                    Device/File integrity check succeeded</div><div class="line"></div><div class="line">                                    Device/File not configured</div><div class="line"></div><div class="line">                                    Device/File not configured</div><div class="line"></div><div class="line">                                    Device/File not configured</div><div class="line"></div><div class="line">                                    Device/File not configured</div><div class="line"></div><div class="line">  Cluster registry integrity check succeeded</div><div class="line"></div><div class="line">  Logical corruption check bypassed due to non-privileged user</div><div class="line"></div><div class="line"><span class="comment">#查看votedisk磁盘位置</span></div><div class="line">[grid@rac1 grid]$ crsctl query css votedisk</div><div class="line"><span class="comment">##  STATE    File Universal Id                File Name Disk group</span></div><div class="line">--  -----    -----------------                --------- ---------</div><div class="line"> 1. ONLINE   65b9ef5913044fdbbff0d1b75e91172e (/dev/asm-disk1) [CRS]</div><div class="line">Located 1 voting disk(s).</div><div class="line">[grid@rac1 grid]$</div></pre></td></tr></table></figure>
<h2 id="创建ASM磁盘"><a href="#创建ASM磁盘" class="headerlink" title="创建ASM磁盘"></a>创建ASM磁盘</h2><p>grid用户登录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[grid@rac1 ~]$ <span class="built_in">export</span> DISPLAY=192.168.100.251:0.0</div><div class="line">[grid@rac1 ~]$ xhost +</div><div class="line">access control disabled, clients can connect from any host</div><div class="line">[grid@rac1 ~]$ asmca</div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/03C4A43AD7A64661A9D1D6F7EC185DC5?method=download&amp;shareKey=5fc81aaaeffd229cb98d98f55d4d0c4b" alt="ASM_install"><br><img src="http://note.youdao.com/yws/api/personal/file/04B843E1A9F34108BB17BF03C1C20CE8?method=download&amp;shareKey=04a0908d8bad5e7ed95fbba6cb0c0ec6" alt="ASM_install"><br><img src="http://note.youdao.com/yws/api/personal/file/094F58FBCE7C40529956B7953030953E?method=download&amp;shareKey=a08ff5ab2bfb4bb7b763ae9dc3540bd8" alt="ASM_install">  </p>
<h2 id="安装database"><a href="#安装database" class="headerlink" title="安装database"></a>安装database</h2><p>用Oracle用户登录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[oracle@rac1 ~]$ <span class="built_in">export</span> DISPLAY=192.168.100.251:0.0</div><div class="line">[oracle@rac1 ~]$ xhost +</div><div class="line">access control disabled, clients can connect from any host</div><div class="line">[oracle@rac1 ~]$ <span class="built_in">cd</span> /software/database</div><div class="line">[oracle@rac1 database]$ ./runInstaller</div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/8D27737A5648408D8BC6D65160F19FEE?method=download&amp;shareKey=89e2e512ba5492fba02750710a519142" alt="DB_install"><br><img src="http://note.youdao.com/yws/api/personal/file/E30E8704F02049D2899F64B8C813B084?method=download&amp;shareKey=3c94b82c3ac0e3332af201ba61f1db27" alt="DB_install"><br><img src="http://note.youdao.com/yws/api/personal/file/46E5A434B9FA4589A6D9B479FF4427CC?method=download&amp;shareKey=03ef98de2f76489b85cfbd737ed9d027" alt="DB_install">  </p>
<p>做Oracle用户SSH互信(按照之前grid用户一样做互信)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[oracle@rac1 sshsetup]$ ./sshUserSetup.sh -user oracle -hosts rac2.example.com -advanced -exverify -confirm -noPromptPassphrase</div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/7500B4745E454A33B8DE422A69C41EF2?method=download&amp;shareKey=cfd1df564ca56af384f33e8c2fcf4b0b" alt="DB_install"><br><img src="http://note.youdao.com/yws/api/personal/file/4667BFA405C94DC4B16EF5C0D4202277?method=download&amp;shareKey=c2518992dc8fe5fa6f655fae2090a642" alt="DB_install"><br><img src="http://note.youdao.com/yws/api/personal/file/39ECFC3C78DE48A69D133AA5852FE5DD?method=download&amp;shareKey=1d483c70b0afc1c966366af58281d6a3" alt="DB_install"><br><img src="http://note.youdao.com/yws/api/personal/file/A3BDB3519BD54AB69E30B2EB4CE9E0E4?method=download&amp;shareKey=eb593b50dd934d0059b344a95e00ea23" alt="DB_install"><br><img src="http://note.youdao.com/yws/api/personal/file/EC73246D2BA841B78357FF4028B42C55?method=download&amp;shareKey=633bca30d6a07834cbb5c757c9667e64" alt="DB_install"><br><img src="http://note.youdao.com/yws/api/personal/file/79B11710EA3145DF9EFFE4E9B2F63740?method=download&amp;shareKey=1564620f65cb5932e8f3d9527f85bd6f" alt="DB_install"><br><img src="http://note.youdao.com/yws/api/personal/file/83CB5C68B58A40999AF87472C598B7BB?method=download&amp;shareKey=276a1242d68cb6b789211c0c0d2ed032" alt="DB_install">  </p>
<p>节点rac1和节点rac2都执行下面的脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">[root@rac1 ~]<span class="comment"># /u01/app/oracle/product/11.2.0/db_1/root.sh</span></div><div class="line">Performing root user operation <span class="keyword">for</span> Oracle 11g</div><div class="line"></div><div class="line">The following environment variables are <span class="built_in">set</span> as:</div><div class="line">    ORACLE_OWNER= oracle</div><div class="line">    ORACLE_HOME=  /u01/app/oracle/product/11.2.0/db_1</div><div class="line"></div><div class="line">Enter the full pathname of the <span class="built_in">local</span> bin directory: [/usr/<span class="built_in">local</span>/bin]:</div><div class="line">The contents of <span class="string">"dbhome"</span> have not changed. No need to overwrite.</div><div class="line">The contents of <span class="string">"oraenv"</span> have not changed. No need to overwrite.</div><div class="line">The contents of <span class="string">"coraenv"</span> have not changed. No need to overwrite.</div><div class="line"></div><div class="line">Entries will be added to the /etc/oratab file as needed by</div><div class="line">Database Configuration Assistant when a database is created</div><div class="line">Finished running generic part of root script.</div><div class="line">Now product-specific root actions will be performed.</div><div class="line">Finished product-specific root actions.</div><div class="line">[root@rac1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/9329F7C332564B30A997B062FF205885?method=download&amp;shareKey=3a8b9a6fc87a80c2654ed36d4baff48a" alt="DB_install"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">[root@rac1 ~]<span class="comment"># su - grid</span></div><div class="line"></div><div class="line"><span class="comment">#RAC查看集群资源状态</span></div><div class="line">[grid@rac1 ~]$ crs_stat  -t -v</div><div class="line">Name           Type           R/RA   F/FT   Target    State     Host        </div><div class="line">----------------------------------------------------------------------</div><div class="line">ora.CRS.dg     ora....up.type 0/5    0/     ONLINE    ONLINE    rac1        </div><div class="line">ora.FRA.dg     ora....up.type 0/5    0/     ONLINE    ONLINE    rac1        </div><div class="line">ora....ER.lsnr ora....er.type 0/5    0/     ONLINE    ONLINE    rac1        </div><div class="line">ora....N1.lsnr ora....er.type 0/5    0/0    ONLINE    ONLINE    rac1        </div><div class="line">ora....DATA.dg ora....up.type 0/5    0/     ONLINE    ONLINE    rac1        </div><div class="line">ora.asm        ora.asm.type   0/5    0/     ONLINE    ONLINE    rac1        </div><div class="line">ora.cvu        ora.cvu.type   0/5    0/0    ONLINE    ONLINE    rac1        </div><div class="line">ora.gsd        ora.gsd.type   0/5    0/     OFFLINE   OFFLINE              </div><div class="line">ora....network ora....rk.type 0/5    0/     ONLINE    ONLINE    rac1        </div><div class="line">ora.oc4j       ora.oc4j.type  0/1    0/2    ONLINE    ONLINE    rac1        </div><div class="line">ora.ons        ora.ons.type   0/3    0/     ONLINE    ONLINE    rac1        </div><div class="line">ora....SM1.asm application    0/5    0/0    ONLINE    ONLINE    rac1        </div><div class="line">ora....C1.lsnr application    0/5    0/0    ONLINE    ONLINE    rac1        </div><div class="line">ora.rac1.gsd   application    0/5    0/0    OFFLINE   OFFLINE              </div><div class="line">ora.rac1.ons   application    0/3    0/0    ONLINE    ONLINE    rac1        </div><div class="line">ora.rac1.vip   ora....t1.type 0/0    0/0    ONLINE    ONLINE    rac1        </div><div class="line">ora....SM2.asm application    0/5    0/0    ONLINE    ONLINE    rac2        </div><div class="line">ora....C2.lsnr application    0/5    0/0    ONLINE    ONLINE    rac2        </div><div class="line">ora.rac2.gsd   application    0/5    0/0    OFFLINE   OFFLINE              </div><div class="line">ora.rac2.ons   application    0/3    0/0    ONLINE    ONLINE    rac2        </div><div class="line">ora.rac2.vip   ora....t1.type 0/0    0/0    ONLINE    ONLINE    rac2        </div><div class="line">ora.scan1.vip  ora....ip.type 0/0    0/0    ONLINE    ONLINE    rac1        </div><div class="line">[grid@rac1 ~]$</div></pre></td></tr></table></figure></p>
<h2 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h2><p>创建数据库：(用oracle用户登录)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[oracle@rac1 ~]$ <span class="built_in">export</span> DISPLAY=192.168.100.251:0.0</div><div class="line">[oracle@rac1 ~]$ xhost +</div><div class="line">access control disabled, clients can connect from any host</div><div class="line">[oracle@rac1 ~]$ dbca</div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/B5F8C257719340B8A22A7E6364F27547?method=download&amp;shareKey=63d9c209de07599c1bd10b4007343f63" alt="Create_db"><br><img src="http://note.youdao.com/yws/api/personal/file/EC8B5FB7119944DB985A8417C8AC1E59?method=download&amp;shareKey=724f0eec005c3979adb19d91df077d03" alt="Create_db"><br><img src="http://note.youdao.com/yws/api/personal/file/73DF5250A493444FA211D6020C326624?method=download&amp;shareKey=e247fa3a130468dc2ee84ee4f4a8f88a" alt="Create_db"><br><img src="http://note.youdao.com/yws/api/personal/file/B1BE1C1885CB4A16ADC81F38F20E7242?method=download&amp;shareKey=fc6641f76abc9af875caf458bc1e2746" alt="Create_db"><br><img src="http://note.youdao.com/yws/api/personal/file/7D1B74AFAB0D46F497211545D05ECF3C?method=download&amp;shareKey=fc72815a42af6d027683594ab2fbb73f" alt="Create_db"><br><img src="http://note.youdao.com/yws/api/personal/file/D58AEA48BC9E4D97B04148222E495319?method=download&amp;shareKey=2f06e6917fb8ff2074182837d90e68da" alt="Create_db"><br><img src="http://note.youdao.com/yws/api/personal/file/92CBFDB752DD4A689904D208044DFEFA?method=download&amp;shareKey=ebdd2834a2be2f3a7a0b25e4041212a2" alt="Create_db"><br><img src="http://note.youdao.com/yws/api/personal/file/A67BFEEE880C4702BF2651C55D307E4C?method=download&amp;shareKey=10bd73780edc1b9fcbb6ad8a016c0a1e" alt="Create_db"><br><img src="http://note.youdao.com/yws/api/personal/file/9FABA2D3265448A18CD970588B437B16?method=download&amp;shareKey=0c2f98ed195c5d596d4fe52070ce97e5" alt="Create_db">  </p>
<p>如果SGA and PGA内存不够在安装数据库时会出现下面的错误：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ORA-00838: Specified value of MEMORY_TARGET is too small, needs to be at least 1408M</div><div class="line">ORA-01078：failure <span class="keyword">in</span> processing system parameters</div></pre></td></tr></table></figure></p>
<p>参考：<a href="http://yfshare.blog.51cto.com/8611708/1671927" target="_blank" rel="external">http://yfshare.blog.51cto.com/8611708/1671927</a>  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/531024DC7DF24577AB2C6BB0BCD30BAE?method=download&amp;shareKey=3fbdddc7d6413ce9169adfd0228e6b89" alt="Create_db"><br><img src="http://note.youdao.com/yws/api/personal/file/CEC9BC8BB4F04742A29FEF372612688C?method=download&amp;shareKey=e33dbdb30ea172090cb8f9fc6fcd1f8d" alt="Create_db"><br><img src="http://note.youdao.com/yws/api/personal/file/8A035EEF0C50450FBBF7B9B481B88CBC?method=download&amp;shareKey=3c735d9f58384633630df499b1f2843c" alt="Create_db"><br><img src="http://note.youdao.com/yws/api/personal/file/7FD8667B1D0A4F8A87ADE703925F0A25?method=download&amp;shareKey=85ff3fbdf736b2d2626bbc150f4bdb39" alt="Create_db"><br><img src="http://note.youdao.com/yws/api/personal/file/5DB3EE5CC1CB45299BDA03903CBDB517?method=download&amp;shareKey=4e5c5765cd6599136bf009a05ed5c5d7" alt="Create_db"><br><img src="http://note.youdao.com/yws/api/personal/file/985657944EA94DFFA419BFFCD59A48C1?method=download&amp;shareKey=7974beee807487207bc56da4e21ecd1c" alt="Create_db"><br><img src="http://note.youdao.com/yws/api/personal/file/D23B5E2CC2ED41848A392A7161ADA0CD?method=download&amp;shareKey=c46d6a21c0b78c4262095ae90b08464a" alt="Create_db"><br><img src="http://note.youdao.com/yws/api/personal/file/3758624B77A64DCB950BF4A1C1E3D28E?method=download&amp;shareKey=40fcf6de27d69bb64ce4101f7eb8f07d" alt="Create_db">  </p>
<p>如果安装到85%报上面这个错，查看到闪回区没空间了<br><img src="http://note.youdao.com/yws/api/personal/file/449AB7641BCF4D4FBF9E6D67A7D9F380?method=download&amp;shareKey=70a203188b5aa20546e05cca5fb1d348" alt="recovery_file_dest"><br>解决方法：删除多余的归档文件，或设置较大的db_recovery_file_dest_size  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/F0B6421ECD50485CBDB77BA985609B22?method=download&amp;shareKey=a113a3ab29f750841e6e0c4480b7bb2c" alt="Create_db">  </p>
<p>检查集群运行状态<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">srvctl status database <span class="_">-d</span> racdb</div><div class="line">crs_stat -t -v</div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/87EB8740870045F880745C052AADEC76?method=download&amp;shareKey=6217fb496f2a634eccc760a25e42fdd9" alt="srvctl_status"><br><img src="http://note.youdao.com/yws/api/personal/file/805DC37BDB8D4CDC9D5951AF65B7D384?method=download&amp;shareKey=d11a2ec0e6cccacaea3a25d97a54b9f0" alt="crs_stat"><br><img src="http://note.youdao.com/yws/api/personal/file/6147B920E8B24AC5AE2CC3CF28A31008?method=download&amp;shareKey=80671286ac0a8d3d7a742b47cb00e012" alt="crs_stat">  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">[oracle@rac1 ~]$ lsnrctl status</div><div class="line">LSNRCTL <span class="keyword">for</span> Linux: Version 11.2.0.4.0 - Production on 11-JUL-2015 01:07:17</div><div class="line">Copyright (c) 1991, 2013, Oracle.  All rights reserved.</div><div class="line">Connecting to (ADDRESS=(PROTOCOL=tcp)(HOST=)(PORT=1521))</div><div class="line">STATUS of the LISTENER</div><div class="line">------------------------</div><div class="line">Alias                     LISTENER</div><div class="line">Version                   TNSLSNR <span class="keyword">for</span> Linux: Version 11.2.0.4.0 - Production</div><div class="line">Start Date                10-JUL-2015 15:38:11</div><div class="line">Uptime                    0 days 9 hr. 29 min. 6 sec</div><div class="line">Trace Level               off</div><div class="line">Security                  ON: Local OS Authentication</div><div class="line">SNMP                      OFF</div><div class="line">Listener Parameter File   /u01/app/11.2.0/grid/network/admin/listener.ora</div><div class="line">Listener Log File         /u01/app/grid/diag/tnslsnr/rac1/listener/alert/log.xml</div><div class="line">Listening Endpoints Summary...</div><div class="line">  (DESCRIPTION=(ADDRESS=(PROTOCOL=ipc)(KEY=LISTENER)))</div><div class="line">  (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=192.168.100.244)(PORT=1521)))</div><div class="line">  (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=192.168.100.241)(PORT=1521)))</div><div class="line">Services Summary...</div><div class="line">Service <span class="string">"+ASM"</span> has 1 instance(s).</div><div class="line">  Instance <span class="string">"+ASM1"</span>, status READY, has 1 handler(s) <span class="keyword">for</span> this service...</div><div class="line">Service <span class="string">"racdb"</span> has 1 instance(s).</div><div class="line">  Instance <span class="string">"racdb1"</span>, status READY, has 1 handler(s) <span class="keyword">for</span> this service...</div><div class="line">Service <span class="string">"racdbXDB"</span> has 1 instance(s).</div><div class="line">  Instance <span class="string">"racdb1"</span>, status READY, has 1 handler(s) <span class="keyword">for</span> this service...</div><div class="line">The <span class="built_in">command</span> completed successfully</div><div class="line">[oracle@rac1 ~]$</div><div class="line"></div><div class="line">[oracle@rac1 ~]$ sqlplus / as sysdba</div><div class="line">SQL&gt; select status from v<span class="variable">$instance</span>;</div><div class="line"></div><div class="line">STATUS</div><div class="line">------------</div><div class="line">OPEN</div><div class="line"></div><div class="line">SQL&gt;</div></pre></td></tr></table></figure>
<h2 id="配置EM管理器"><a href="#配置EM管理器" class="headerlink" title="配置EM管理器"></a>配置EM管理器</h2><p>如果启动EM web界面管理工具，出现下面的问题，则使用emca -config dbcontrol db重建EM<br><img src="http://note.youdao.com/yws/api/personal/file/8B81A3F8C4F24FB9AE76BF17483C6F24?method=download&amp;shareKey=6b4edfb25a8cb71d7b6288a8f042509a" alt="em_start"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#删除集群EM</span></div><div class="line">[oracle@rac1 ~]$ emca -deconfig dbcontrol db -cluster</div></pre></td></tr></table></figure></p>
<p><a href="http://note.youdao.com/yws/api/personal/file/E97CE99D29F74E0088BE1DD1BB2D2450?method=download&amp;shareKey=41edb04ba2cb25d35c10dbd851abae7e" target="_blank" rel="external">删除集群EM执行过程</a><br><a href="http://note.youdao.com/yws/api/personal/file/BEB6B2ECD5764208B17893513F26C6F4?method=download&amp;shareKey=de30b1edb7fa40d9a8debc87f710c3c9" target="_blank" rel="external">emctl命令</a>  </p>
<p>重建EM<br>用oracle用户登录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[oracle@rac1 ~]$ <span class="built_in">export</span> DISPLAY=192.168.100.251:0.0</div><div class="line">[oracle@rac1 ~]$ xhost +</div><div class="line">access control disabled, clients can connect from any host</div><div class="line">[oracle@rac1 ~]$ dbca</div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/30AFD56186C94798BB9C494321EB5726?method=download&amp;shareKey=57185649b2653571b6315665457cb16d" alt="em_rebuild"><br><img src="http://note.youdao.com/yws/api/personal/file/51E12844D74A4A30BFA5DADD15726A93?method=download&amp;shareKey=175017e912a9c48781c67aa217eff47d" alt="em_rebuild"><br><img src="http://note.youdao.com/yws/api/personal/file/493A3B0E2F8D4E9C961BDCD561D0505D?method=download&amp;shareKey=a1a86d942a22150f0d9c2de0cd638ccb" alt="em_rebuild1"><br><img src="http://note.youdao.com/yws/api/personal/file/0AD996F1EF3B41E9BAE257B8AFC672E2?method=download&amp;shareKey=2b72b9ca1ee1a07a4f9c01f70ba06fc7" alt="em_rebuild1"><br><img src="http://note.youdao.com/yws/api/personal/file/7741542BB1EA4F4FB275E832A9873C38?method=download&amp;shareKey=92ca47c9566794f50e193f25ce76f837" alt="em_rebuild1"><br><img src="http://note.youdao.com/yws/api/personal/file/257D3B750D7C4F5596F1735FA72EC76E?method=download&amp;shareKey=6674f78d0c6326e122c29bd35b41111a" alt="em_rebuild1"><br><img src="http://note.youdao.com/yws/api/personal/file/ED32CFCE3ABE4CDA9EF15CD56D8BB4F0?method=download&amp;shareKey=b657a58df51961db1a7659dacf2bc2a0" alt="em_rebuild1"><br><img src="http://note.youdao.com/yws/api/personal/file/B8EEDAD45D0E46D5805F15D08184C674?method=download&amp;shareKey=017dd6a0aaae1277a86ccc1cfb5ab336" alt="em_rebuild1"><br><img src="http://note.youdao.com/yws/api/personal/file/85797754B44B4C71978F6EE9C8ADFD8F?method=download&amp;shareKey=29ee7750d8e9c3109152c327ae5efcb6" alt="em_rebuild1"><br><img src="http://note.youdao.com/yws/api/personal/file/9D6F942B32264A1C8402C2755AD5E9BB?method=download&amp;shareKey=739fd735cf7d39d55b3914fdd5183234" alt="em_rebuild1"><br>注：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[oracle@rac1 ~]<span class="variable">$emctl</span> status dbconsole</div><div class="line">Environment variable ORACLE_UNQNAME not defined. Please <span class="built_in">set</span> ORACLE_UNQNAME to database unique name.</div><div class="line">[oracle@rac1 ~]$</div></pre></td></tr></table></figure></p>
<p>如果报上面的错误，是oracle用户的ORACLE_UNQNAME环境变量未设置。如果报下面的错误，则是ORACLE_UNQNAME设置不正确<br><img src="http://note.youdao.com/yws/api/personal/file/A410DFF1803F48B0A87A26CAC027CADA?method=download&amp;shareKey=a7658d2940b902f565cda2f6d2421497" alt="ORACLE_UNQNAME_error"><br>正确设置<br><img src="http://note.youdao.com/yws/api/personal/file/9F50F62A73104E2DA0BDB9531EE8DA48?method=download&amp;shareKey=9e765fb734dd34be7488ef2b86c891f5" alt="ORACLE_UNQNAME_true"><br><img src="http://note.youdao.com/yws/api/personal/file/79479FA7AE684FF9845E3780F7592B2D?method=download&amp;shareKey=c1bca3ac67335417a2964b46797597f8" alt="em_status"><br>oracle RAC集群默认是开机自启。根据配置不同，花费的时间不一样  </p>
<h2 id="配置PL-SQL"><a href="#配置PL-SQL" class="headerlink" title="配置PL/SQL"></a>配置PL/SQL</h2><p>使用PL/SQL登录oracle RAC<br>安装plsql+ora10client<br><a href="http://note.youdao.com/yws/api/personal/file/918F64A65F6B4723AE40E7415A0D0D97?method=download&amp;shareKey=0671839fd7336ba472007fd158a0b91c" target="_blank" rel="external">plsql+instantclient_11_2安装包</a><br>C:\Ora10InstantClient\network\admin\tnsnames.ora（在ora10client安装目录下新建network/admin目录，在RAC服务器上把$ORACLE_HOME/network/admin/tnsnames.ora文件放到ora10client安装目录下的admin目录下）<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@rac1 ~]<span class="comment"># grep racscan /etc/hosts</span></div><div class="line">192.168.100.246	racscan</div><div class="line">[root@rac1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>格式为：把HOST = racscan改为HOST = racscan对应的地址<br><figure class="highlight nix"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#监听文件</span></div><div class="line"><span class="attr">RACDB</span> =</div><div class="line">  (<span class="attr">DESCRIPTION</span> =</div><div class="line">    (<span class="attr">ADDRESS</span> = (<span class="attr">PROTOCOL</span> =TCP)(<span class="attr">HOST</span> = <span class="number">192.168</span>.<span class="number">100.246</span>)(<span class="attr">PORT=</span> <span class="number">1521</span>))</div><div class="line">    (<span class="attr">CONNECT_DATA</span> =</div><div class="line">      (<span class="attr">SERVER</span> = DEDICATED)</div><div class="line">      (<span class="attr">SERVICE_NAME</span> = racdb)</div><div class="line">    )</div><div class="line">  )</div></pre></td></tr></table></figure></p>
<p>打开PL/SQL—&gt;Tools—&gt;Preferences—&gt;Connection<br><img src="http://note.youdao.com/yws/api/personal/file/3C5FEB3B813C4EA1A23B8A2E3E184287?method=download&amp;shareKey=c2f4cd579bde7bb8c3b59610d79b7960" alt="plsql_preferences"><br><img src="http://note.youdao.com/yws/api/personal/file/867F08CA18E941CAA87DEFDB628EF9C8?method=download&amp;shareKey=97463fbbab49dd3a6b770c739d4ef260" alt="plsql_login"><br><img src="http://note.youdao.com/yws/api/personal/file/1D8F9F0F64554F5D94881F4491B030AC?method=download&amp;shareKey=7fa82a30a8bcd139dfa6e28467d7e849" alt="plsql_connected">  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/04/12/部署Oracle-RAC集群/">http://www.yfshare.vip/2017/04/12/部署Oracle-RAC集群/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Ansible常用模块]]></title>
      <url>http://www.yfshare.vip/2017/04/05/Ansible%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9D%97/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>模块(也被称为 “task plugins” 或 “library plugins”)，可以在Ansible-playbooks和Ansible命令中运用它们。</p>
<p>官方文档：<br>Ansible所有模块列表：<a href="https://docs.ansible.com/ansible/list_of_all_modules.html" target="_blank" rel="external">https://docs.ansible.com/ansible/list_of_all_modules.html</a><br><a id="more"></a><br>环境：Centos 6.6<br>　　　ansible 2.2.1.0  </p>
<h2 id="Command模块"><a href="#Command模块" class="headerlink" title="Command模块"></a>Command模块</h2><p>Ansible command模块：<a href="https://docs.ansible.com/ansible/list_of_commands_modules.html" target="_blank" rel="external">https://docs.ansible.com/ansible/list_of_commands_modules.html</a><br>在远程主机上执行命令<br>常用选项：<br><strong>creates</strong>：判断，当该文件存在时，则该命令不执行<br><strong>free_form</strong>：需要执行的Linux指令<br><strong>chdir</strong>：在执行命令之前，先切换到该指定的目录<br><strong>removes</strong>：判断，当该文件不存在时，则该选项不执行<br><strong>executable</strong>：切换shell来执行命令，该执行路径必须是一个绝对路径<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#查看test_hosts组主机的主机名</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible -i /etc/ansible/hosts test_hosts -u root -m command -a 'hostname' -k</span></div><div class="line">SSH password: </div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">host1</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div><div class="line"><span class="comment"># -i：specify inventory host path</span></div><div class="line"><span class="comment"># -u：Remote User</span></div><div class="line"><span class="comment"># -m：Module name</span></div><div class="line"><span class="comment"># -a：Module Args</span></div><div class="line"><span class="comment"># -k：ask for privilege escalation password。在Inventory(/etc/ansible/hosts)中配置ansible_ssh_user和ansible_ssh_pass后可实现Ansible免密连接或者使用证书实现免密连接，即不使用-k参数</span></div><div class="line"><span class="comment"># test_hosts：/etc/ansible/hosts指定的主机组</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#creates判断一个文件，当该文件存在时，则不执行后面的命令</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'creates=/tmp/aaa.txt ls /home'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">lost+found</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'creates=/tmp/ansible_test_cpoy.txt ls /home'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">skipped, since /tmp/ansible_test_cpoy.txt exists</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#removes当文件不存在时，不执行后面的命令</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'removes=/tmp/ansible_test_cpoy.txt ls /home'</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS | rc=0 &gt;</span>&gt;</div><div class="line">lost+found</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'removes=/tmp/bbb.txt.txt ls /home'</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS | rc=0 &gt;</span>&gt;</div><div class="line">skipped, since /tmp/bbb.txt.txt does not exist</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#chdir在执行命令前，先切换到指定的目录</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'chdir=/usr/local/games tar -czf game1.tar.gz game1'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'chdir=/usr/local/games ls -l'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">total 20500</div><div class="line">-rw-r--r-- 1 root root 20971520 Feb  6 15:42 game1</div><div class="line">-rw-r--r-- 1 root root    20458 Feb  6 15:43 game1.tar.gz</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h2 id="Shell模块"><a href="#Shell模块" class="headerlink" title="Shell模块"></a>Shell模块</h2><p>Ansible shell模块：<a href="https://docs.ansible.com/ansible/shell_module.html" target="_blank" rel="external">https://docs.ansible.com/ansible/shell_module.html</a><br>Ansible raw：<a href="https://docs.ansible.com/ansible/raw_module.html" target="_blank" rel="external">https://docs.ansible.com/ansible/raw_module.html</a><br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#shell模块可以使用command模块所有选项，但功能比command模块更强大，因为其支持“|”管道符。</span></div><div class="line"><span class="comment">#使用raw模块也可。执行ansible-doc -s raw查看帮助</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m shell -a 'ps -ef | grep crond | grep -v grep'</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS | rc=0 &gt;</span>&gt;</div><div class="line">root       <span class="number">1013</span>      <span class="number">1</span>  <span class="number">0</span> <span class="number">10</span><span class="symbol">:</span><span class="number">36</span> ?        <span class="number">00</span><span class="symbol">:</span><span class="number">00</span><span class="symbol">:</span><span class="number">00</span> crond</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m raw -a 'ps -ef | grep crond | grep -v grep'</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS | rc=0 &gt;</span>&gt;</div><div class="line">root       <span class="number">1013</span>      <span class="number">1</span>  <span class="number">0</span> <span class="number">10</span><span class="symbol">:</span><span class="number">36</span> ?        <span class="number">00</span><span class="symbol">:</span><span class="number">00</span><span class="symbol">:</span><span class="number">00</span> crond</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m shell -a "aaa.sh &gt;&gt; /tmp/output.txt"</span></div></pre></td></tr></table></figure></p>
<h2 id="File模块"><a href="#File模块" class="headerlink" title="File模块"></a>File模块</h2><p>Ansible File模块：<a href="https://docs.ansible.com/ansible/list_of_files_modules.html" target="_blank" rel="external">https://docs.ansible.com/ansible/list_of_files_modules.html</a><br>file - Sets attributes of file：<a href="https://docs.ansible.com/ansible/file_module.html" target="_blank" rel="external">https://docs.ansible.com/ansible/file_module.html</a></p>
<p>常用选项：<br><strong>force</strong>：在两种情况下强制创建软链接。1、源文件不存在但之后会建立的情况；2、目标软件已存在，需要先取消之前的软链接，然后创建新的软链接。选项：yes|no<br><strong>group</strong>：定义文件/目录的属组<br><strong>mode</strong>：定义文件/目录的权限<br><strong>path</strong>：必选项，定义文件/目录的路径<br><strong>recurse</strong>：递归的设置文件的属性，只对目录有效<br><strong>src</strong>：要被链接到的路径，只应用于state=link的情况<br><strong>dest</strong>：被链接到的路径，只应用于state=link的情况<br><strong>state</strong>：  </p>
<ul>
<li>directory：如果目录不存在，创建目录</li>
<li>file：即使文件不存在，也不会被创建</li>
<li>link：创建软链接；hard：创建硬链接</li>
<li>touch：如果文件不存在，则会创建一个新的文件，如果已存在，则更新其最后修改时间</li>
<li>absent：删除目录/文件或者取消链接文件  <figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Ansible创建文件：</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m file -a 'path=/tmp/test.txt state=touch'</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS =&gt;</span> &#123;</div><div class="line">    <span class="string">"changed"</span>: true, </div><div class="line">    <span class="string">"dest"</span>: <span class="string">"/tmp/test.txt"</span>, </div><div class="line">    <span class="string">"gid"</span>: <span class="number">0</span>, </div><div class="line">    <span class="string">"group"</span>: <span class="string">"root"</span>, </div><div class="line">    <span class="string">"mode"</span>: <span class="string">"0644"</span>, </div><div class="line">    <span class="string">"owner"</span>: <span class="string">"root"</span>, </div><div class="line">    <span class="string">"size"</span>: <span class="number">0</span>, </div><div class="line">    <span class="string">"state"</span>: <span class="string">"file"</span>, </div><div class="line">    <span class="string">"uid"</span>: <span class="number">0</span></div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m command -a 'ls -l /tmp/test.txt'</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS | rc=0 &gt;</span>&gt;</div><div class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">0</span> Feb  <span class="number">6</span> <span class="number">10</span><span class="symbol">:</span><span class="number">38</span> /tmp/test.txt</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div><div class="line"><span class="comment">#Ansible删除文件，文件状态改成absent；使用command模块执行rm命令也可</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m file -a 'path=/tmp/test.txt state=absent'</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS =&gt;</span> &#123;</div><div class="line">    <span class="string">"changed"</span>: true, </div><div class="line">    <span class="string">"path"</span>: <span class="string">"/tmp/test.txt"</span>, </div><div class="line">    <span class="string">"state"</span>: <span class="string">"absent"</span></div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Ansible创建目录：</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m file -a 'path=/tmp/test_dir state=directory owner=root group=mail mode=777'</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS =&gt;</span> &#123;</div><div class="line">    <span class="string">"changed"</span>: true, </div><div class="line">    <span class="string">"gid"</span>: <span class="number">12</span>, </div><div class="line">    <span class="string">"group"</span>: <span class="string">"mail"</span>, </div><div class="line">    <span class="string">"mode"</span>: <span class="string">"0777"</span>, </div><div class="line">    <span class="string">"owner"</span>: <span class="string">"root"</span>, </div><div class="line">    <span class="string">"path"</span>: <span class="string">"/tmp/test_dir"</span>, </div><div class="line">    <span class="string">"size"</span>: <span class="number">4096</span>, </div><div class="line">    <span class="string">"state"</span>: <span class="string">"directory"</span>, </div><div class="line">    <span class="string">"uid"</span>: <span class="number">0</span></div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m command -a 'ls -ld /tmp/test_dir'</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS | rc=0 &gt;</span>&gt;</div><div class="line">drwxrwxrwx <span class="number">2</span> root mail <span class="number">4096</span> Feb  <span class="number">6</span> <span class="number">10</span><span class="symbol">:</span><span class="number">47</span> /tmp/test_dir</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h2 id="Copy模块："><a href="#Copy模块：" class="headerlink" title="Copy模块："></a>Copy模块：</h2><p>Ansible copy模块：<a href="https://docs.ansible.com/ansible/copy_module.html" target="_blank" rel="external">https://docs.ansible.com/ansible/copy_module.html</a><br>复制文件到远程主机<br>常用选项<br><strong>backup</strong>：在覆盖之前将源文件备份，备份文件包含时间信息，选项：yes|no<br><strong>content</strong>：用于替代”src”，可以直接设定文件的值<br><strong>directory_node</strong>：递归的设定目录权限，默认为系统默认权限<br><strong>force</strong>：如果目标主机包含该文件，但内容不同，如果设置为yes，则强制覆盖；如果设置为no，则只有当目标主机的目标位置不存在该文件时，才复制。默认为yes<br><strong>others</strong>：所有file模块里的选项都可以在这里使用<br><strong>src</strong>：要复制到远程主机的文件在本地的地址，可以是绝对路径，也可以是相对路径。如果路径是一个目录，它将递归复制。在这种情况下，如果路径使用“/”来结尾，则只复制目录里的内容，如果没有使用“/”来结尾，则包含目录在内的整个内容全部复制，类似于rsync<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m copy -a 'src=/root/test_file.txt dest=/tmp/ansible_test_cpoy.txt owner=root group=mail mode=0600'</span></div><div class="line">192.168.31.110 | SUCCESS =&gt; &#123;</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </div><div class="line">    <span class="string">"checksum"</span>: <span class="string">"e6c4fbd4fe7607f3e6ebf68b2ea4ef694da7b4fe"</span>, </div><div class="line">    <span class="string">"dest"</span>: <span class="string">"/tmp/ansible_test_cpoy.txt"</span>, </div><div class="line">    <span class="string">"gid"</span>: 12, </div><div class="line">    <span class="string">"group"</span>: <span class="string">"mail"</span>, </div><div class="line">    <span class="string">"md5sum"</span>: <span class="string">"2d282102fa671256327d4767ec23bc6b"</span>, </div><div class="line">    <span class="string">"mode"</span>: <span class="string">"0600"</span>, </div><div class="line">    <span class="string">"owner"</span>: <span class="string">"root"</span>, </div><div class="line">    <span class="string">"size"</span>: 21, </div><div class="line">    <span class="string">"src"</span>: <span class="string">"/root/.ansible/tmp/ansible-tmp-1486364820.02-66604881581156/source"</span>, </div><div class="line">    <span class="string">"state"</span>: <span class="string">"file"</span>, </div><div class="line">    <span class="string">"uid"</span>: 0</div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m command -a 'ls -l /tmp/ansible_test_cpoy.txt'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">-rw------- 1 root mail 21 Feb  6 15:07 /tmp/ansible_test_cpoy.txt</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<h2 id="Service模块"><a href="#Service模块" class="headerlink" title="Service模块"></a>Service模块</h2><p>Ansible service模块：<a href="https://docs.ansible.com/ansible/service_module.html" target="_blank" rel="external">https://docs.ansible.com/ansible/service_module.html</a><br>用于管理服务<br>常用选项：<br><strong>arguments</strong>：为命令提供一些附加参数<br><strong>enabled</strong>：是否开机启动，选项 yes|no<br><strong>name</strong>：必选项，服务名称<br><strong>pattern</strong>：定义一个模式，如果通过status指令来查看服务状态时，没有响应，它会通过ps命令在进程中根据该模式进行查找，如果匹配到，则认为该服务依然运行<br><strong>runlevel</strong>：运行级别<br><strong>sleep</strong>：如果执行了restarted，则在stop和start之间等待几秒钟<br><strong>state</strong>：对当前服务执行启动/停止/重启/重新加载等操作(started/stopped/restarted/reloaded)<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m service -a 'name=nginx state=started enabled=yes'</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS =&gt;</span> &#123;</div><div class="line">    <span class="string">"changed"</span>: true, </div><div class="line">    <span class="string">"enabled"</span>: true, </div><div class="line">    <span class="string">"name"</span>: <span class="string">"nginx"</span>, </div><div class="line">    <span class="string">"state"</span>: <span class="string">"started"</span></div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m shell -a 'ps -ef | grep nginx | grep -v grep'</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS | rc=0 &gt;</span>&gt;</div><div class="line">root       <span class="number">2638</span>      <span class="number">1</span>  <span class="number">0</span> <span class="number">17</span><span class="symbol">:</span><span class="number">40</span> ?        <span class="number">00</span><span class="symbol">:</span><span class="number">00</span><span class="symbol">:</span><span class="number">00</span> <span class="symbol">nginx:</span> master process /usr/sbin/nginx -c /etc/nginx/nginx.conf</div><div class="line">nginx      <span class="number">2640</span>   <span class="number">2638</span>  <span class="number">0</span> <span class="number">17</span><span class="symbol">:</span><span class="number">40</span> ?        <span class="number">00</span><span class="symbol">:</span><span class="number">00</span><span class="symbol">:</span><span class="number">00</span> <span class="symbol">nginx:</span> worker process                   </div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m shell -a 'chkconfig --list | egrep -w nginx'</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS | rc=0 &gt;</span>&gt;</div><div class="line">nginx          	<span class="number">0</span><span class="symbol">:off</span>	<span class="number">1</span><span class="symbol">:off</span>	<span class="number">2</span><span class="symbol">:on</span>	<span class="number">3</span><span class="symbol">:on</span>	<span class="number">4</span><span class="symbol">:on</span>	<span class="number">5</span><span class="symbol">:on</span>	<span class="number">6</span><span class="symbol">:off</span></div><div class="line">nginx-debug    	<span class="number">0</span><span class="symbol">:off</span>	<span class="number">1</span><span class="symbol">:off</span>	<span class="number">2</span><span class="symbol">:off</span>	<span class="number">3</span><span class="symbol">:off</span>	<span class="number">4</span><span class="symbol">:off</span>	<span class="number">5</span><span class="symbol">:off</span>	<span class="number">6</span><span class="symbol">:off</span></div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#Ansible会匹配nginx服务，如果存在/usr/sbin/nginx这个进程时，认为其已经启动，则不执行后面的started操作</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m service -a 'name=nginx pattern=/usr/sbin/nginx state=started'</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS =&gt;</span> &#123;</div><div class="line">    <span class="string">"changed"</span>: false, </div><div class="line">    <span class="string">"name"</span>: <span class="string">"nginx"</span>, </div><div class="line">    <span class="string">"state"</span>: <span class="string">"started"</span></div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m service -a 'name=network state=restarted args=eth0'</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS =&gt;</span> &#123;</div><div class="line">    <span class="string">"changed"</span>: true, </div><div class="line">    <span class="string">"name"</span>: <span class="string">"network"</span>, </div><div class="line">    <span class="string">"state"</span>: <span class="string">"started"</span></div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<h2 id="Cron模块"><a href="#Cron模块" class="headerlink" title="Cron模块"></a>Cron模块</h2><p>Ansible cron模块：<a href="https://docs.ansible.com/ansible/cron_module.html" target="_blank" rel="external">https://docs.ansible.com/ansible/cron_module.html</a><br>用于管理计划任务<br>常用参数：<br><strong>backup</strong>：对远程主机上的原计划任务内容修改之前做备份<br><strong>cron_file</strong>：如果指定该选项，则用该文件替换远程主机上cron.d目录下的用户的任务计划<br><strong>day</strong>：日(1-31,*,*/2,…)<br><strong>hour</strong>：小时(0-23,*,*/2,…)<br><strong>minute</strong>:分钟(0-59,*,*/2,…)<br><strong>month</strong>：月(0-12,*,…)<br><strong>weekday</strong>：周(0-7,*,…)<br><strong>job</strong>：要执行的任务，依赖于state=present<br><strong>name</strong>：该任务的描述<br><strong>special_time</strong>：指定什么时候执行，参数：reboot,yearly,annually,monthly,weekly,daily,hourly<br><strong>state</strong>：确认该任务计划是创建还是删除<br><strong>user</strong>：以哪个用户身份执行<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m cron -a 'name="reboot system" minute=0 hour=5 user=root job="/sbin/reboot" state=present'</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS =&gt;</span> &#123;</div><div class="line">    <span class="string">"changed"</span>: true, </div><div class="line">    <span class="string">"envs"</span>: [], </div><div class="line">    <span class="string">"jobs"</span>: [</div><div class="line">        <span class="string">"reboot system"</span></div><div class="line">    ]</div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m shell -a "crontab -l"</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS | rc=0 &gt;</span>&gt;</div><div class="line"><span class="comment">#Ansible: reboot system</span></div><div class="line"><span class="number">0</span> <span class="number">5</span> * * * <span class="regexp">/sbin/reboot</span></div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m cron -a 'name="reboot system" state=absent'</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS =&gt;</span> &#123;</div><div class="line">    <span class="string">"changed"</span>: true, </div><div class="line">    <span class="string">"envs"</span>: [], </div><div class="line">    <span class="string">"jobs"</span>: []</div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#每隔5分钟查看home目录,state=present可省略</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m cron -a 'name="check home directory" minute=*/5 job="ls -lht /home"'</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS =&gt;</span> &#123;</div><div class="line">    <span class="string">"changed"</span>: true, </div><div class="line">    <span class="string">"envs"</span>: [], </div><div class="line">    <span class="string">"jobs"</span>: [</div><div class="line">        <span class="string">"check home directory"</span></div><div class="line">    ]</div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m shell -a "crontab -l"</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS | rc=0 &gt;</span>&gt;</div><div class="line"><span class="comment">#Ansible: check home directory</span></div><div class="line">*<span class="regexp">/5 * * * * ls -lht /home</span></div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m cron -a 'name="echo reboot" special_time=reboot job="echo reboot_successful" state=present'</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS =&gt;</span> &#123;</div><div class="line">    <span class="string">"changed"</span>: true, </div><div class="line">    <span class="string">"envs"</span>: [], </div><div class="line">    <span class="string">"jobs"</span>: [</div><div class="line">        <span class="string">"echo reboot"</span></div><div class="line">    ]</div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m shell -a "crontab -l"</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS | rc=0 &gt;</span>&gt;</div><div class="line"><span class="comment">#Ansible: echo reboot</span></div><div class="line">@reboot echo reboot_successful</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<h2 id="FileSystem"><a href="#FileSystem" class="headerlink" title="FileSystem"></a>FileSystem</h2><p>Ansible FileSystem模块：<a href="https://docs.ansible.com/ansible/filesystem_module.html" target="_blank" rel="external">https://docs.ansible.com/ansible/filesystem_module.html</a><br>块设备上创建文件系统<br>选项：<br><strong>dev</strong>：目标块设备<br><strong>force</strong>：在一个已有文件系统的设备上强制创建<br><strong>fstype</strong>：文件系统的类型<br><strong>opts</strong>：传递给mkfs命令的选项<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Filesystem模块只能对整个块设备操作，不能分区</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m filesystem -a 'dev=/dev/sdb fstype=ext4'</span></div><div class="line">192.168.31.110 | SUCCESS =&gt; &#123;</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">true</span></div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'fdisk -l /dev/sdb'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line"></div><div class="line">Disk /dev/sdb: 107.4 GB, 107374182400 bytes</div><div class="line">255 heads, 63 sectors/track, 13054 cylinders</div><div class="line">Units = cylinders of 16065 * 512 = 8225280 bytes</div><div class="line">Sector size (logical/physical): 512 bytes / 512 bytes</div><div class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</div><div class="line">Disk identifier: 0x00000000</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#如果需要像平时样对块设备进行分区操作，则需要编写脚本让Ansible执行。这里用到了copy和command模块</span></div><div class="line">[root@Ansible ~]<span class="comment"># cat fdisk.sh </span></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="comment">#make partition</span></div><div class="line">fdisk /dev/sdb &lt;&lt;EOF</div><div class="line">n</div><div class="line">p</div><div class="line">1</div><div class="line"></div><div class="line">+10G</div><div class="line">p</div><div class="line">w</div><div class="line">EOF</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m copy -a 'src=/root/fdisk.sh dest=/tmp/'</span></div><div class="line">192.168.31.110 | SUCCESS =&gt; &#123;</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </div><div class="line">    <span class="string">"checksum"</span>: <span class="string">"f265923f0a4578e36c82418df1a068a55867c1b1"</span>, </div><div class="line">    <span class="string">"dest"</span>: <span class="string">"/tmp/fdisk.sh"</span>, </div><div class="line">    <span class="string">"gid"</span>: 0, </div><div class="line">    <span class="string">"group"</span>: <span class="string">"root"</span>, </div><div class="line">    <span class="string">"md5sum"</span>: <span class="string">"87c9e0b074e4828b37d6e334d1cf7ce1"</span>, </div><div class="line">    <span class="string">"mode"</span>: <span class="string">"0644"</span>, </div><div class="line">    <span class="string">"owner"</span>: <span class="string">"root"</span>, </div><div class="line">    <span class="string">"size"</span>: 71, </div><div class="line">    <span class="string">"src"</span>: <span class="string">"/root/.ansible/tmp/ansible-tmp-1486437971.22-237961786906240/source"</span>, </div><div class="line">    <span class="string">"state"</span>: <span class="string">"file"</span>, </div><div class="line">    <span class="string">"uid"</span>: 0</div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m command -a 'sh /tmp/fdisk.sh'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">...</div><div class="line">Disk /dev/sdb: 107.4 GB, 107374182400 bytes</div><div class="line">255 heads, 63 sectors/track, 13054 cylinders</div><div class="line">Units = cylinders of 16065 * 512 = 8225280 bytes</div><div class="line">Sector size (logical/physical): 512 bytes / 512 bytes</div><div class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</div><div class="line">Disk identifier: 0x166637ee</div><div class="line"></div><div class="line">   Device Boot      Start         End      Blocks   Id  System</div><div class="line">/dev/sdb1               1        1306    10490413+  83  Linux</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'mkfs.ext4 /dev/sdb1'</span></div><div class="line"><span class="comment">#格式化分区</span></div></pre></td></tr></table></figure>
<h2 id="Mount模块"><a href="#Mount模块" class="headerlink" title="Mount模块"></a>Mount模块</h2><p>Ansible mount模块：<a href="https://docs.ansible.com/ansible/mount_module.html" target="_blank" rel="external">https://docs.ansible.com/ansible/mount_module.html</a><br><strong>dump</strong>：存储(见fstab文件第5列)。注意，如果设置为null并且状态设置为present，它将停止工作，并且将在后续运行中进行重复条目。对Solaris系统没有影响。<br><strong>fstype</strong>：必选项，文件系统类型，要求状态是present或mounted<br><strong>name</strong>：必选项，挂载点<br><strong>opts</strong>：传递给mount命令的参数<br><strong>src</strong>：必选项，要挂载的设备路径。要求状态是present或mounted<br><strong>state</strong>：必选项。选项为present/absent/mounted/unmounted  </p>
<ul>
<li>present：只处理fstab中的配置</li>
<li>absent：删除挂载点  </li>
<li>mounted：自动创建挂载点并挂载  </li>
<li>unmounted：卸载  <figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#挂载分区</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m mount -a 'name=/mnt src=/dev/sdb1 fstype=ext4 state=mounted opts=rw'</span></div><div class="line"><span class="number">192.168</span><span class="number">.31</span><span class="number">.110</span> | SUCCESS =&gt; &#123;</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </div><div class="line">    <span class="string">"dump"</span>: <span class="string">"0"</span>, </div><div class="line">    <span class="string">"fstab"</span>: <span class="string">"/etc/fstab"</span>, </div><div class="line">    <span class="string">"fstype"</span>: <span class="string">"ext4"</span>, </div><div class="line">    <span class="string">"name"</span>: <span class="string">"/mnt"</span>, </div><div class="line">    <span class="string">"opts"</span>: <span class="string">"rw"</span>, </div><div class="line">    <span class="string">"passno"</span>: <span class="string">"0"</span>, </div><div class="line">    <span class="string">"src"</span>: <span class="string">"/dev/sdb1"</span></div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'df -h /dev/sdb1'</span></div><div class="line"><span class="number">192.168</span><span class="number">.31</span><span class="number">.110</span> | SUCCESS | rc=<span class="number">0</span> &gt;&gt;</div><div class="line">Filesystem      Size  Used Avail Use% Mounted <span class="literal">on</span></div><div class="line">/dev/sdb1       <span class="number">9.8</span>G   <span class="number">23</span>M  <span class="number">9.3</span>G   <span class="number">1</span>% /mnt</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'tail -1 /etc/fstab'</span></div><div class="line"><span class="number">192.168</span><span class="number">.31</span><span class="number">.110</span> | SUCCESS | rc=<span class="number">0</span> &gt;&gt;</div><div class="line">/dev/sdb1 /mnt ext4 rw <span class="number">0</span> <span class="number">0</span></div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#state=mounted，如果挂载点不存在会自动创建</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'dd if=/dev/zero of=/mnt/disk.img bs=1M count=100'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">100+0 records <span class="keyword">in</span></div><div class="line">100+0 records out</div><div class="line">104857600 bytes (105 MB) copied, 0.241784 s, 434 MB/s</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'losetup /dev/loop0 /mnt/disk.img'  #关联设备</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m filesystem -a 'dev=/mnt/disk.img fstype=ext4 opts=-F'  #格式化块设备</span></div><div class="line">192.168.31.110 | SUCCESS =&gt; &#123;</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">true</span></div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m mount -a 'src=/dev/loop0 name=/yfshare fstype=ext4 state=mounted'</span></div><div class="line">192.168.31.110 | SUCCESS =&gt; &#123;</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </div><div class="line">    <span class="string">"dump"</span>: <span class="string">"0"</span>, </div><div class="line">    <span class="string">"fstab"</span>: <span class="string">"/etc/fstab"</span>, </div><div class="line">    <span class="string">"fstype"</span>: <span class="string">"ext4"</span>, </div><div class="line">    <span class="string">"name"</span>: <span class="string">"/yfshare"</span>, </div><div class="line">    <span class="string">"opts"</span>: <span class="string">"defaults"</span>, </div><div class="line">    <span class="string">"passno"</span>: <span class="string">"0"</span>, </div><div class="line">    <span class="string">"src"</span>: <span class="string">"/dev/loop0"</span></div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m shell -a 'df -h | grep -w loop0'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">/dev/loop0             93M  1.6M   87M   2% /yfshare</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m shell -a 'grep -w loop0 /etc/fstab'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">/dev/loop0 /yfshare ext4 defaults 0 0</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m file -a 'path=/yfshare/test.txt state=touch mode=0600'</span></div></pre></td></tr></table></figure>
<h2 id="Yum模块"><a href="#Yum模块" class="headerlink" title="Yum模块"></a>Yum模块</h2><p>Ansible Packaging Modules：<a href="https://docs.ansible.com/ansible/list_of_packaging_modules.html" target="_blank" rel="external">https://docs.ansible.com/ansible/list_of_packaging_modules.html</a><br>Ansible yum模块：<a href="https://docs.ansible.com/ansible/yum_module.html" target="_blank" rel="external">https://docs.ansible.com/ansible/yum_module.html</a><br>使用yum包管理器来管理软件包<br>选项：<br><strong>conf_file</strong>：yum的配置文件<br><strong>disable_gpg_check</strong>：关闭gpg_check<br><strong>disablerepo</strong>：不启用某个源<br><strong>enablerepo</strong>：启用某个源<br><strong>list</strong>：查看yum列表<br><strong>name</strong>：要进行操作的软件包名字，也可以传递一个url或者一个本地的rpm包的路径<br><strong>state</strong>：状态(present/installed/absent/removed/latest)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#卸载nginx软件包</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m yum -a 'name=nginx state=absent'</span></div><div class="line">192.168.31.110 | SUCCESS =&gt; &#123;</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </div><div class="line">    <span class="string">"msg"</span>: <span class="string">""</span>, </div><div class="line">    <span class="string">"rc"</span>: 0, </div><div class="line">    <span class="string">"results"</span>: [</div><div class="line">    <span class="string">"Loaded plugins: fastestmirror\nSetting up Remove Process\nResolving Dependencies\n--&gt; Running transaction check\n---&gt; Package nginx.x86_64 0:1.10.3-1.el6.ngx will be erased\n--&gt; Finished Dependency Resolution\n\nDependencies Resolved\n\n</span></div><div class="line">    ...</div><div class="line">        ]</div><div class="line">&#125;</div><div class="line">[root@Ansible ~]#</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#更新nginx软件包</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m yum -a 'name=nginx update_cache=yes'</span></div><div class="line">192.168.31.110 | SUCCESS =&gt; &#123;</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>, </div><div class="line">    <span class="string">"msg"</span>: <span class="string">""</span>, </div><div class="line">    <span class="string">"rc"</span>: 0, </div><div class="line">    <span class="string">"results"</span>: [</div><div class="line">        <span class="string">"nginx-1.10.3-1.el6.ngx.x86_64 providing nginx is already installed"</span></div><div class="line">    ]</div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h2 id="User模块"><a href="#User模块" class="headerlink" title="User模块"></a>User模块</h2><p>Ansible User模块：<a href="https://docs.ansible.com/ansible/user_module.html" target="_blank" rel="external">https://docs.ansible.com/ansible/user_module.html</a><br>常用参数：<br><strong>home</strong>：指定用户家目录<br><strong>group</strong>：设置用户主组<br><strong>groups</strong>：设置用户的附属组<br><strong>uid</strong>：设置用户的UID<br><strong>password</strong>：设置用户的密码，密码必须为加密后的值<br><strong>name</strong>：创建用户的用户名<br><strong>createhhome</strong>：选项yes|no，值为yes时才创建用户家目录<br><strong>system</strong>：选项yes|no，默认为no，值为yes时创建的用户为系统用户<br><strong>remove</strong>：当state=absent时，remove=yes则表示连同家目录一起删除，等价于userdel -r<br><strong>state</strong>：选项present|absent，创建用户或删除用户<br><strong>shell</strong>：设置用户的shell环境<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#生成用户的密码</span></div><div class="line">[root@Ansible ~]<span class="comment"># echo "123456" | openssl passwd -1 -salt $(&lt; /dev/urandom tr -dc '[:alnum:]' | head -c 32) -stdin</span></div><div class="line"><span class="variable">$1</span><span class="variable">$K28XAyId</span><span class="variable">$YUKHvYzbbO9C8RkzGIzNo1</span></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#group为指定用户的主组</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m user -a 'name=user1 uid=1001 group=yfshare createhome=yes home=/home/user1 password="$1$K28XAyId$YUKHvYzbbO9C8RkzGIzNo1" shell=/bin/bash state=present'</span></div><div class="line">192.168.31.110 | SUCCESS =&gt; &#123;</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </div><div class="line">    <span class="string">"comment"</span>: <span class="string">""</span>, </div><div class="line">    <span class="string">"createhome"</span>: <span class="literal">true</span>, </div><div class="line">    <span class="string">"group"</span>: 1000, </div><div class="line">    <span class="string">"home"</span>: <span class="string">"/home/user1"</span>, </div><div class="line">    <span class="string">"name"</span>: <span class="string">"user1"</span>, </div><div class="line">    <span class="string">"password"</span>: <span class="string">"NOT_LOGGING_PASSWORD"</span>, </div><div class="line">    <span class="string">"shell"</span>: <span class="string">"/bin/bash"</span>, </div><div class="line">    <span class="string">"state"</span>: <span class="string">"present"</span>, </div><div class="line">    <span class="string">"system"</span>: <span class="literal">false</span>, </div><div class="line">    <span class="string">"uid"</span>: 1001</div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'id user1'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">uid=1001(user1) gid=1000(yfshare) groups=1000(yfshare)</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#groups为指定用户的附属组</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m user -a 'name=user2 uid=1002 groups=yfshare createhome=yes home=/home/user2 password="$1$K28XAyId$YUKHvYzbbO9C8RkzGIzNo1" shell=/bin/bash state=present'</span></div><div class="line">192.168.31.110 | SUCCESS =&gt; &#123;</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </div><div class="line">    <span class="string">"comment"</span>: <span class="string">""</span>, </div><div class="line">    <span class="string">"createhome"</span>: <span class="literal">true</span>, </div><div class="line">    <span class="string">"group"</span>: 1002, </div><div class="line">    <span class="string">"groups"</span>: <span class="string">"yfshare"</span>, </div><div class="line">    <span class="string">"home"</span>: <span class="string">"/home/user2"</span>, </div><div class="line">    <span class="string">"name"</span>: <span class="string">"user2"</span>, </div><div class="line">    <span class="string">"password"</span>: <span class="string">"NOT_LOGGING_PASSWORD"</span>, </div><div class="line">    <span class="string">"shell"</span>: <span class="string">"/bin/bash"</span>, </div><div class="line">    <span class="string">"state"</span>: <span class="string">"present"</span>, </div><div class="line">    <span class="string">"system"</span>: <span class="literal">false</span>, </div><div class="line">    <span class="string">"uid"</span>: 1002</div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'id user2'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">uid=1002(user2) gid=1002(user2) groups=1002(user2),1000(yfshare)</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#删除user1用户</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m user -a 'name=user1 remove=yes state=absent'</span></div><div class="line">192.168.31.110 | SUCCESS =&gt; &#123;</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </div><div class="line">    <span class="string">"force"</span>: <span class="literal">false</span>, </div><div class="line">    <span class="string">"name"</span>: <span class="string">"user1"</span>, </div><div class="line">    <span class="string">"remove"</span>: <span class="literal">true</span>, </div><div class="line">    <span class="string">"state"</span>: <span class="string">"absent"</span></div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'id user1'</span></div><div class="line">192.168.31.110 | FAILED | rc=1 &gt;&gt;</div><div class="line">id: user1: No such user</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h2 id="Group模块"><a href="#Group模块" class="headerlink" title="Group模块"></a>Group模块</h2><p>Ansible group模块：<a href="https://docs.ansible.com/ansible/group_module.html" target="_blank" rel="external">https://docs.ansible.com/ansible/group_module.html</a><br>选项：<br><strong>gid</strong>：设置组的GID<br><strong>name</strong>：组名<br><strong>state</strong>：选项为present|absent，创建组或删除组<br><strong>system</strong>：选项为yes|no，值为yes，则创建系统组<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#创建yfshare组</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m group -a 'name=yfshare gid=1000 state=present'</span></div><div class="line">192.168.31.110 | SUCCESS =&gt; &#123;</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </div><div class="line">    <span class="string">"gid"</span>: 1000, </div><div class="line">    <span class="string">"name"</span>: <span class="string">"yfshare"</span>, </div><div class="line">    <span class="string">"state"</span>: <span class="string">"present"</span>, </div><div class="line">    <span class="string">"system"</span>: <span class="literal">false</span></div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'grep yfshare /etc/group'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">yfshare:x:1000:</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#删除yfshare组</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m group -a 'name=yfshare gid=1000 state=absent'</span></div><div class="line">192.168.31.110 | SUCCESS =&gt; &#123;</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </div><div class="line">    <span class="string">"name"</span>: <span class="string">"yfshare"</span>, </div><div class="line">    <span class="string">"state"</span>: <span class="string">"absent"</span></div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'grep yfshare /etc/group'</span></div><div class="line">192.168.31.110 | FAILED | rc=1 &gt;&gt;</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h2 id="Synchronize模块"><a href="#Synchronize模块" class="headerlink" title="Synchronize模块"></a>Synchronize模块</h2><p>Ansible synchronize模块：<a href="https://docs.ansible.com/ansible/synchronize_module.html" target="_blank" rel="external">https://docs.ansible.com/ansible/synchronize_module.html</a><br><strong>archive</strong>：归档，相当于同时开启recursive(递归)、links、perms、times、owner、group、-D选项都为yes ，默认该项为开启<br><strong>checksum</strong>：跳过检测sum值，默认关闭<br><strong>delete</strong>：删除不存在的文件(源主机没有但目标主机中存在的文件)，默认no<br><strong>dest</strong>：从源同步到目的主机的路径，可以为绝对路径或相对路径<br><strong>src</strong>：在源主机上将要同步到目的主机的路径，可为绝对路径或相对路径<br><strong>dest_port</strong>：目标主机上的SSH端口号，在Ansible 2.0之前，ansible_ssh_port变量值优先于此变量<br><strong>existing_only</strong>：在目的主机上不创建新文件<br><strong>links</strong>：将符号链接复制为符号链接<br><strong>copy_links</strong>：复制链接文件，默认为no<br><strong>owner</strong>：保留所有者（仅超级用户）<br><strong>mode</strong>：选项push和pull。push模式，从本机向远程主机传送文件；pull模式从远程主机上取文件<br><strong>recursive</strong>：递归到目录<br><strong>rsync_path</strong>：指定在远程主机上运行rsync命令<br><strong>times</strong>：保留修改时间<br><strong>compress</strong>：在传输过程中是否压缩文件，选项yes|no<br><strong>dirs</strong>：传速目录不进行递归，默认为no，即进行目录递归<br><strong>rsync_opts</strong>：指定rsync参数选项<br><strong>set_remote_user</strong>：主要用于/etc/ansible/hosts中定义或默认使用的用户与rsync使用的用户不同的情况<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="string">"msg"</span>: <span class="string">"Failed to find required executable ssh"</span>  <span class="comment">#出现这个报错，需要安装openssh-clients</span></div><div class="line"><span class="string">"msg"</span>: <span class="string">"Failed to find required executable rsync"</span>  <span class="comment">#出现这个问题，需要安装rsync</span></div><div class="line"></div><div class="line"><span class="comment">#synchronize同步文件</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m synchronize -a 'src=/tmp/helloworld.txt dest=/tmp/'</span></div><div class="line">root@192.168.31.110<span class="string">'s password: </span></div><div class="line">192.168.31.110 | SUCCESS =&gt; &#123;</div><div class="line">    "changed": true, </div><div class="line">    "cmd": "/usr/bin/rsync --delay-updates -F --compress --archive --rsh 'ssh  -S none -o StrictHostKeyChecking=no<span class="string">' --out-format='</span>&lt;&lt;CHANGED&gt;&gt;%i %n%L<span class="string">' \"/tmp/helloworld.txt\" \"root@192.168.31.110:/tmp/\"", </span></div><div class="line">    "msg": "&lt;f+++++++++ helloworld.txt\n", </div><div class="line">    "rc": 0, </div><div class="line">    "stdout_lines": [</div><div class="line">        "&lt;f+++++++++ helloworld.txt"</div><div class="line">    ]</div><div class="line">&#125;</div><div class="line">[root@Ansible ~]# ansible test_hosts -a 'cat /tmp/helloworld.txt<span class="string">'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">hello world</div><div class="line"></div><div class="line">[root@Ansible ~]#</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#synchronize同步目录。如果synchronize同步到目的服务器的目录不存在，则会创建该目录后同步到该目录，rsync_path可以指定rsync的路径(如果是源码安装的)</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m synchronize -a 'src=/tmp/test dest=/tmp/synchronize_test delete=yes mode=push owner=yes rsync_path=/usr/bin/rsync rsync_opts="-avz,--exclude=.git"'</span></div><div class="line">root@192.168.31.110<span class="string">'s password: </span></div><div class="line">192.168.31.110 | SUCCESS =&gt; &#123;</div><div class="line">    "changed": true, </div><div class="line">    "cmd": "/usr/bin/rsync --delay-updates -F --compress --delete-after --archive --rsh 'ssh  -S none -o StrictHostKeyChecking=no<span class="string">' --out-format='</span>&lt;&lt;CHANGED&gt;&gt;%i %n%L<span class="string">' \"/tmp/test\" \"root@192.168.31.110:/tmp/synchronize_test\"", </span></div><div class="line">    "msg": "cd+++++++++ test/\n</div><div class="line">    ···</div><div class="line">        ]</div><div class="line">&#125;</div><div class="line">[root@Ansible ~]#</div><div class="line">[root@Ansible ~]# ansible test_hosts -a 'ls /tmp/synchronize_test<span class="string">'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">test</div><div class="line"></div><div class="line">[root@Ansible ~]#</div></pre></td></tr></table></figure>
<h2 id="get-url模块"><a href="#get-url模块" class="headerlink" title="get_url模块"></a>get_url模块</h2><p>主要用于从http、ftp、https服务器上下载文件（类似于wget）<br>Ansible get_url模块：<a href="https://docs.ansible.com/ansible/get_url_module.html" target="_blank" rel="external">https://docs.ansible.com/ansible/get_url_module.html</a><br>选项：<br><strong>checksum</strong>：文件下载完成后进行校验<br><strong>timeout</strong>：请求超时时间，默认为10s<br><strong>url</strong>：文件下载地址<br><strong>url_username</strong>：用户名，基于HTTP的基本认证<br><strong>url_password</strong>：密码<br><strong>use_proxy</strong>：选项yes|no，默认为yes，即使用代理<br><strong>dest</strong>：下载文件存储的绝对路径<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#下载文件并下载完成后进行sha256sum校验</span></div><div class="line"><span class="comment">#支持加密算法：sha1, sha224, sha384, sha256, sha512, md5</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m get_url -a 'dest=/tmp/ url="http://archive.kernel.org/centos-vault/6.7/isos/x86_64/0_README.txt" checksum="sha256:f98849cdc1b3dee8cf47cfcf2a2fe2fb8e8e69426157a47d20a3005693fd3e1c"'</span></div><div class="line">192.168.31.110 | SUCCESS =&gt; &#123;</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </div><div class="line">    <span class="string">"checksum_dest"</span>: null, </div><div class="line">    <span class="string">"checksum_src"</span>: <span class="string">"a1b756c6a431552e5012a9332c68dc1ef3ec463c"</span>, </div><div class="line">    <span class="string">"dest"</span>: <span class="string">"/tmp/0_README.txt"</span>, </div><div class="line">    <span class="string">"gid"</span>: 0, </div><div class="line">    <span class="string">"group"</span>: <span class="string">"root"</span>, </div><div class="line">    <span class="string">"md5sum"</span>: <span class="string">"99bc97977d71be899bef0c5664fae3fb"</span>, </div><div class="line">    <span class="string">"mode"</span>: <span class="string">"0644"</span>, </div><div class="line">    <span class="string">"msg"</span>: <span class="string">"OK (2210 bytes)"</span>, </div><div class="line">    <span class="string">"owner"</span>: <span class="string">"root"</span>, </div><div class="line">    <span class="string">"size"</span>: 2210, </div><div class="line">    <span class="string">"src"</span>: <span class="string">"/tmp/tmp8GUXc4"</span>, </div><div class="line">    <span class="string">"state"</span>: <span class="string">"file"</span>, </div><div class="line">    <span class="string">"uid"</span>: 0, </div><div class="line">    <span class="string">"url"</span>: <span class="string">"http://archive.kernel.org/centos-vault/6.7/isos/x86_64/0_README.txt"</span></div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'ls /tmp/0_README.txt -l'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">-rw-r--r-- 1 root root 2210 Feb  8 19:33 /tmp/0_README.txt</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<h2 id="unarchive模块"><a href="#unarchive模块" class="headerlink" title="unarchive模块"></a>unarchive模块</h2><p>Ansible unarchive模块：<a href="https://docs.ansible.com/ansible/unarchive_module.html" target="_blank" rel="external">https://docs.ansible.com/ansible/unarchive_module.html</a><br>用于解压文件<br>选项：<br><strong>remote_src</strong>：选项yes|no，默认为no，值为yes表示文件已复制到远程主机，added in Ansible 2.2<br><strong>creates</strong>：如果文件存在，则不执行解压命令<br><strong>dest</strong>：在远程主机上解压的绝对路径<br><strong>group</strong>：设置解压后文件/目录的属组<br><strong>owner</strong>：设置解压后文件/目录的属主<br><strong>list_files</strong>：选项yes|no，默认为no，值为yes，解压后列出压缩包的文件，added in Ansible 2.0<br><strong>mode</strong>：解压后文件的权限<br><strong>src</strong>：值为yes，如果remote_src=no (default)，本地压缩文件复制到目的服务器，绝对路径相对路径均可；如果remote_src=yes，直接在目标服务器上解压文件；如果remote_src=yes和src包含URL，则先下载文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m unarchive -a 'creates=NewSid.zip src=/tmp/NewSid.zip dest=/tmp/ mode=0600 owner=yfshare list_files=yes'</span></div><div class="line">192.168.31.110 | SUCCESS =&gt; &#123;</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </div><div class="line">    <span class="string">"dest"</span>: <span class="string">"/tmp/"</span>, </div><div class="line">    <span class="string">"extract_results"</span>: &#123;</div><div class="line">        <span class="string">"cmd"</span>: [</div><div class="line">            <span class="string">"/usr/bin/unzip"</span>, </div><div class="line">            <span class="string">"-o"</span>, </div><div class="line">            <span class="string">"/root/.ansible/tmp/ansible-tmp-1486610818.84-40104290759151/source"</span>, </div><div class="line">            <span class="string">"-d"</span>, </div><div class="line">            <span class="string">"/tmp/"</span></div><div class="line">        ], </div><div class="line">        <span class="string">"err"</span>: <span class="string">""</span>, </div><div class="line">        <span class="string">"out"</span>: <span class="string">"Archive:  /root/.ansible/tmp/ansible-tmp-1486610818.84-40104290759151/source\n  inflating: /tmp/newsid.exe         \n  inflating: /tmp/Eula.txt           \n"</span>, </div><div class="line">        <span class="string">"rc"</span>: 0</div><div class="line">    &#125;, </div><div class="line">    <span class="string">"files"</span>: [   <span class="comment">#列出解压文件列表</span></div><div class="line">        <span class="string">"newsid.exe"</span>, </div><div class="line">        <span class="string">"Eula.txt"</span></div><div class="line">    ], </div><div class="line">    <span class="string">"gid"</span>: 0, </div><div class="line">    <span class="string">"group"</span>: <span class="string">"root"</span>, </div><div class="line">    <span class="string">"handler"</span>: <span class="string">"ZipArchive"</span>, </div><div class="line">    <span class="string">"mode"</span>: <span class="string">"01777"</span>, </div><div class="line">    <span class="string">"owner"</span>: <span class="string">"root"</span>, </div><div class="line">    <span class="string">"size"</span>: 4096, </div><div class="line">    <span class="string">"src"</span>: <span class="string">"/root/.ansible/tmp/ansible-tmp-1486610818.84-40104290759151/source"</span>, </div><div class="line">    <span class="string">"state"</span>: <span class="string">"directory"</span>, </div><div class="line">    <span class="string">"uid"</span>: 0</div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'ls -l /tmp'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">total 240</div><div class="line">drwx------ 2 root    root   4096 Feb  9 11:28 ansible_zimVwy</div><div class="line">-rw------- 1 yfshare root   7005 Jul 28  2006 Eula.txt</div><div class="line">-rw------- 1 yfshare root 228152 Nov  1  2006 newsid.exe</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<h2 id="Setup模块"><a href="#Setup模块" class="headerlink" title="Setup模块"></a>Setup模块</h2><p>Ansible Setup模块：<a href="https://docs.ansible.com/ansible/setup_module.html" target="_blank" rel="external">https://docs.ansible.com/ansible/setup_module.html</a><br>playbooks自动收集远程主机上可用变量，这些变量用于playbooks<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m setup</span></div><div class="line">192.168.31.110 | SUCCESS =&gt; &#123;</div><div class="line">    <span class="string">"ansible_facts"</span>: &#123;</div><div class="line">        <span class="string">"ansible_all_ipv4_addresses"</span>: [</div><div class="line">            <span class="string">"192.168.31.110"</span></div><div class="line">        ], </div><div class="line">        <span class="string">"ansible_all_ipv6_addresses"</span>: [</div><div class="line">            <span class="string">"fe80::20c:29ff:fe5c:dc6d"</span></div><div class="line">        ], </div><div class="line">        <span class="string">"ansible_architecture"</span>: <span class="string">"x86_64"</span>,</div><div class="line">...</div></pre></td></tr></table></figure></p>
<h2 id="Template模块"><a href="#Template模块" class="headerlink" title="Template模块"></a>Template模块</h2><p>Ansible Template模块：<a href="https://docs.ansible.com/ansible/template_module.html" target="_blank" rel="external">https://docs.ansible.com/ansible/template_module.html</a><br>模版由<a href="http://jinja.pocoo.org/docs" target="_blank" rel="external">jinja2模版语言</a>处理，模版设计文档参考<a href="http://jinja.pocoo.org/docs/templates/" target="_blank" rel="external">这里</a><br>模版中可以使用六个附加变量：  </p>
<ul>
<li>ansible_managed(通过ansible.cfg的defaults部分配置)包含一个字符串，可用户描述模版名称，主机，模版文件修改时间和所有者uid</li>
<li>template_host包含模版机器的节点名称</li>
<li>template_uid所有者的用户ID</li>
<li>template_path模版路径</li>
<li>template_fullpath模版的绝对路径</li>
<li>telmpate_run_date模版显示日期</li>
</ul>
<p>常用选项：<br><strong>backup</strong>：选项yes|no，默认为no，创建一个包含时间戳的备份文件<br><strong>src</strong>：本地文件的路径<br><strong>dest</strong>：远程主机的文件位置<br><strong>force</strong>：选项yes|no，默认为yes，覆盖远程主机上的同名文件，如果为否，只有当远程主机上不存在此文件时，才传输文件<br><strong>owner</strong>：文件/目录的所有者，chown<br><strong>group</strong>：文件/目录的所属组，chown<br><strong>mode</strong>：文件/目录的权限，chmod<br><strong>validate</strong>：在复制之前需要验证命令，要验证的文件的路径通过“%s”传递<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">- template:</div><div class="line">    src: etc/ssh/sshd_config.j2</div><div class="line">    dest: /etc/ssh/sshd_config</div><div class="line">    owner: root</div><div class="line">    group: root</div><div class="line">    mode: <span class="string">'0600'</span></div><div class="line">    validate: /usr/sbin/sshd -t <span class="_">-f</span> %s</div><div class="line">    backup: yes</div></pre></td></tr></table></figure></p>
<h2 id="script模块"><a href="#script模块" class="headerlink" title="script模块"></a>script模块</h2><p>Ansible script模块：<a href="http://docs.ansible.com/ansible/script_module.html" target="_blank" rel="external">http://docs.ansible.com/ansible/script_module.html</a><br>在远程主机上执行脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@Ansible ~]<span class="comment"># chmod +x /tmp/script.sh </span></div><div class="line">[root@Ansible ~]<span class="comment"># cat /tmp/script.sh </span></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="built_in">echo</span> <span class="string">'This is a test script'</span> &gt; /tmp/script.ansible</div><div class="line">useradd Jack_wang</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m script -a '/tmp/script.sh'</span></div><div class="line">Enter passphrase <span class="keyword">for</span> key <span class="string">'/root/.ssh/id_rsa'</span>: </div><div class="line">192.168.31.110 | SUCCESS =&gt; &#123;</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </div><div class="line">    <span class="string">"rc"</span>: 0, </div><div class="line">    <span class="string">"stderr"</span>: <span class="string">"Shared connection to 192.168.31.110 closed.\r\n"</span>, </div><div class="line">    <span class="string">"stdout"</span>: <span class="string">""</span>, </div><div class="line">    <span class="string">"stdout_lines"</span>: []</div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a "id Jack_wang"</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">uid=502(Jack_wang) gid=502(Jack_wang) groups=502(Jack_wang)</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a "cat /tmp/script.ansible"</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">This is a <span class="built_in">test</span> script</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>参考文档：<a href="http://breezey.blog.51cto.com/2400275/1555530/" target="_blank" rel="external">http://breezey.blog.51cto.com/2400275/1555530/</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/04/05/Ansible常用模块/">http://www.yfshare.vip/2017/04/05/Ansible常用模块/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Ansible-Playbooks之安装Zabbix]]></title>
      <url>http://www.yfshare.vip/2017/03/20/Ansible-Playbooks%E4%B9%8B%E5%AE%89%E8%A3%85Zabbix/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>playbooks 是一种简单的配置管理系统与多机器部署系统的基础。与现有的其他系统有不同之处,且非常适合于复杂应用的批量部署<br>Playbooks 的格式是YAML，语法做到最小化  </p>
<p>这里讲述的是使用ansible-playbooks的roles安装Zabbix应用<br><a id="more"></a></p>
<h2 id="Ansible之源码安装Zabbix-sever"><a href="#Ansible之源码安装Zabbix-sever" class="headerlink" title="Ansible之源码安装Zabbix-sever"></a>Ansible之源码安装Zabbix-sever</h2><ul>
<li>Zabbix_Server结构目录</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#结构目录</span></div><div class="line">[root@Ansible ~]<span class="comment"># tree /etc/ansible/</span></div><div class="line">/etc/ansible/</div><div class="line">├── ansible.cfg</div><div class="line">├── hosts</div><div class="line">├── roles</div><div class="line">│   └── source_zabbix_server</div><div class="line">│       ├── files</div><div class="line">│       │   ├── authorization.sql</div><div class="line">│       │   ├── initialize.sql</div><div class="line">│       │   ├── yum.repo</div><div class="line">│       │   └── zabbix-3.2.4.tar.gz</div><div class="line">│       ├── handlers</div><div class="line">│       │   └── main.yml</div><div class="line">│       ├── tasks</div><div class="line">│       │   └── main.yml</div><div class="line">│       ├── templates</div><div class="line">│       │   ├── fastcgi.conf.j2</div><div class="line">│       │   ├── zabbix_agentd.conf</div><div class="line">│       │   ├── zabbix.conf</div><div class="line">│       │   └── zabbix_server.conf</div><div class="line">│       └── vars</div><div class="line">│           └── main.yml</div><div class="line">└── site.yml</div><div class="line"></div><div class="line">7 directories, 14 files</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>环境：<br>　　　ansible 2.2.1.0<br>　　　Centos 6.6<br>　　　zabbix-3.2.4  </p>
<p>参考：<br><a href="http://www.yfshare.vip/2017/03/20/Ansible-Playbooks之安装LNMP/">Ansible-Playbooks之安装LNMP</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#入口文件</span></div><div class="line">[root@Ansible ~]<span class="comment"># cd /etc/ansible/</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat site.yml </span></div><div class="line">- hosts: test_hosts</div><div class="line">  user: root</div><div class="line">  roles:</div><div class="line">    - yum_mysql</div><div class="line">    - yum_php</div><div class="line">    - source_nginx</div><div class="line">    - source_zabbix_server</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#tasks</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat roles/source_zabbix_server/tasks/main.yml</span></div><div class="line">- name: disabled iptables</div><div class="line">  service: name=iptables state=stopped</div><div class="line">- name: Set the selinux value to Permissive</div><div class="line">  shell: setenforce 0</div><div class="line"></div><div class="line">- name: Install libselinux-python package</div><div class="line">  yum: name=libselinux-python state=installed</div><div class="line"></div><div class="line">- name: Check whether yum.repo file exist</div><div class="line">  shell: ls /etc/yum.repos.d/yum.repo</div><div class="line">  register: result</div><div class="line">  ignore_errors: True</div><div class="line">- name: Copy yum.repo file</div><div class="line">  copy: src=<span class="string">"files/yum.repo"</span> dest=<span class="string">"/etc/yum.repos.d/yum.repo"</span> mode=0644 owner=root group=root</div><div class="line">  when: result|failed</div><div class="line">- name: Rebuild the yum cache</div><div class="line">  shell: yum clean all &amp;&amp; yum makecache</div><div class="line">  when: result|failed</div><div class="line"></div><div class="line">- name: Install same devel packages</div><div class="line">  yum: name=<span class="string">"&#123;&#123;item.name&#125;&#125;"</span></div><div class="line">  with_items:</div><div class="line">    - name: <span class="string">"net-snmp"</span></div><div class="line">    - name: <span class="string">"net-snmp-devel"</span></div><div class="line">    - name: <span class="string">"libxml2-devel"</span></div><div class="line">    - name: <span class="string">"libcurl-devel"</span></div><div class="line">    - name: <span class="string">"java-devel"</span></div><div class="line">    - name: <span class="string">"unixODBC"</span></div><div class="line">    - name: <span class="string">"unixODBC-devel"</span></div><div class="line">    - name: <span class="string">"OpenIPMI-devel"</span></div><div class="line">    - name: <span class="string">"curl-devel"</span></div><div class="line">    - name: <span class="string">"libssh2-devel"</span></div><div class="line">    - name: <span class="string">"MySQL-python"</span></div><div class="line"></div><div class="line">- name: Check whether jdk-7u79-linux-x64.tar.gz file exist</div><div class="line">  shell: ls /tmp/jdk-7u79-linux-x64.tar.gz</div><div class="line">  register: result</div><div class="line">  ignore_errors: True</div><div class="line">- name: download jdk-7u79 <span class="built_in">source</span> package</div><div class="line">  get_url: url=<span class="string">"http://note.youdao.com/yws/api/personal/file/B6CC3F0E2AED4E51B16CE7FAF865A81B?method=download&amp;shareKey=8bce5fcc4e54f5295476a3be85eb16d5"</span> dest=<span class="string">"/tmp"</span></div><div class="line">  when: result|failed</div><div class="line"></div><div class="line">- name: Check whether <span class="string">'/usr/local/jdk1.7.0_79'</span> file exist</div><div class="line">  shell: ls /usr/<span class="built_in">local</span>/jdk1.7.0_79</div><div class="line">  register: result</div><div class="line">  ignore_errors: True</div><div class="line">- name: unarchive jdk-7u79 <span class="built_in">source</span> package</div><div class="line">  unarchive: src=<span class="string">"/tmp/jdk-7u79-linux-x64.tar.gz"</span> dest=<span class="string">"/usr/local/"</span> remote_src=yes</div><div class="line">  when: result|failed</div><div class="line">- name: Configure java variable</div><div class="line">  shell: <span class="built_in">echo</span> <span class="string">'export JAVA_HOME=/usr/local/jdk1.7.0_79'</span> &gt;&gt; /etc/profile &amp;&amp; <span class="built_in">echo</span> <span class="string">'export PATH=$&#123;JAVA_HOME&#125;/bin/:$PATH'</span> &gt;&gt; /etc/profile &amp;&amp; <span class="built_in">source</span> /etc/profile</div><div class="line">  when: result|failed</div><div class="line"></div><div class="line">- name: unarchive zabbix-3.2.4 <span class="built_in">source</span> package</div><div class="line">  unarchive: src=<span class="string">"files/zabbix-3.2.4.tar.gz"</span> dest=<span class="string">"/tmp"</span> remote_src=no</div><div class="line">- name: Install zabbix <span class="built_in">source</span> package</div><div class="line">  shell: <span class="built_in">cd</span> /tmp/zabbix-3.2.4 &amp;&amp; ./configure --prefix=&#123;&#123;zabbix_install_path&#125;&#125; --enable-server --enable-agent --with-mysql --with-net-snmp --with-libcurl --with-libxml2  --enable-java &amp;&amp; make &amp;&amp; make install</div><div class="line"></div><div class="line">- name: Check whether zabbix users exist</div><div class="line">  shell: id zabbix</div><div class="line">  register: result</div><div class="line">  ignore_errors: True</div><div class="line">- name: The zabbix user does not exist, so we need to create it.</div><div class="line">  user: name=zabbix createhome=yes home=/home/zabbix shell=/sbin/nologin  state=present</div><div class="line">  when: result|failed</div><div class="line"></div><div class="line">- name: Replace some files</div><div class="line">  lineinfile: dest=<span class="string">"&#123;&#123;item.dest&#125;&#125;"</span> regexp=<span class="string">"&#123;&#123;item.reg&#125;&#125;"</span> line=<span class="string">"&#123;&#123;item.line&#125;&#125;"</span> backrefs=yes</div><div class="line">  with_items:</div><div class="line">    - dest: <span class="string">'/etc/php.ini'</span></div><div class="line">      reg: <span class="string">'^max_execution_time'</span></div><div class="line">      line: <span class="string">'max_execution_time = 300'</span></div><div class="line">    - dest: <span class="string">'/etc/php.ini'</span></div><div class="line">      reg: <span class="string">'^post_max_size'</span></div><div class="line">      line: <span class="string">'post_max_size = 16M'</span></div><div class="line">    - dest: <span class="string">'/etc/php.ini'</span></div><div class="line">      reg: <span class="string">'^max_input_time'</span></div><div class="line">      line: <span class="string">'max_input_time = 300'</span></div><div class="line">    - dest: <span class="string">'/etc/php.ini'</span></div><div class="line">      reg: <span class="string">'^;date.timezone'</span></div><div class="line">      line: <span class="string">'date.timezone = "Asia/Shanghai"'</span></div><div class="line">    - dest: <span class="string">'/etc/php-fpm.conf'</span></div><div class="line">      reg: <span class="string">'^;pid ='</span></div><div class="line">      line: <span class="string">'pid = /var/run/php-fpm/php-fpm.pid'</span></div><div class="line">    - dest: <span class="string">'/etc/php-fpm.d/www.conf'</span></div><div class="line">      reg: <span class="string">'^;pm.min_spare_servers'</span></div><div class="line">      line: <span class="string">'pm.min_spare_servers = 5'</span></div><div class="line">    - dest: <span class="string">'/etc/php-fpm.d/www.conf'</span></div><div class="line">      reg: <span class="string">'^;pm.max_spare_servers'</span></div><div class="line">      line: <span class="string">'pm.max_spare_servers = 35'</span></div><div class="line">    - dest: <span class="string">'/etc/php-fpm.d/www.conf'</span></div><div class="line">      reg: <span class="string">'^;^pm.start_servers'</span></div><div class="line">      line: <span class="string">'pm.start_servers = 5'</span></div><div class="line"></div><div class="line">- name: Copy authorization.sql file</div><div class="line">  template: src=<span class="string">"&#123;&#123;item.name&#125;&#125;"</span> dest=<span class="string">"/tmp/"</span></div><div class="line">  with_items:</div><div class="line">    - name: <span class="string">"files/authorization.sql"</span></div><div class="line">    - name: <span class="string">"files/initialize.sql"</span></div><div class="line"></div><div class="line">- name: Set up mysql database authorization</div><div class="line">  shell: mysql -u&#123;&#123;mysql_user&#125;&#125; -p&#123;&#123;mysql_pass&#125;&#125; -P&#123;&#123;mysql_port&#125;&#125; &lt; <span class="string">"/tmp/authorization.sql"</span></div><div class="line">- name: Authorize Zabbix users</div><div class="line">  shell: mysql -u&#123;&#123;mysql_user&#125;&#125; -p&#123;&#123;mysql_pass&#125;&#125; -P&#123;&#123;mysql_port&#125;&#125; &lt; <span class="string">"/tmp/initialize.sql"</span></div><div class="line">- name: Initialize the zabbix database</div><div class="line">  shell: <span class="built_in">cd</span> /tmp/zabbix-3.2.4 &amp;&amp; mysql -u&#123;&#123;mysql_zbx_user&#125;&#125; -p&#123;&#123;mysql_zbx_pass&#125;&#125; -P&#123;&#123;mysql_port&#125;&#125; &#123;&#123;mysql_zbx_db&#125;&#125; &lt; database/mysql/schema.sql &amp;&amp; mysql -u&#123;&#123;mysql_zbx_user&#125;&#125; -p&#123;&#123;mysql_zbx_pass&#125;&#125; -P&#123;&#123;mysql_port&#125;&#125; &#123;&#123;mysql_zbx_db&#125;&#125; &lt; database/mysql/images.sql &amp;&amp; mysql -u&#123;&#123;mysql_zbx_user&#125;&#125; -p&#123;&#123;mysql_zbx_pass&#125;&#125; -P&#123;&#123;mysql_port&#125;&#125; &#123;&#123;mysql_zbx_db&#125;&#125; &lt; database/mysql/data.sql</div><div class="line"></div><div class="line">- name: Configure zabbix</div><div class="line">  shell: <span class="built_in">cd</span> /tmp/zabbix-3.2.4 &amp;&amp; cp misc/init.d/fedora/core/zabbix_* /etc/init.d/ &amp;&amp; chmod 775 /etc/init.d/zabbix_*</div><div class="line">- name: Copy zabbix configure</div><div class="line">  template: src=<span class="string">"&#123;&#123;item.src&#125;&#125;"</span> dest=<span class="string">"&#123;&#123;item.dest&#125;&#125;"</span></div><div class="line">  with_items:</div><div class="line">    - src: <span class="string">"templates/zabbix_server.conf"</span></div><div class="line">      dest: <span class="string">"&#123;&#123;zabbix_install_path&#125;&#125;/etc/zabbix_server.conf"</span></div><div class="line">    - src: <span class="string">"templates/zabbix_agentd.conf"</span></div><div class="line">      dest: <span class="string">"&#123;&#123;zabbix_install_path&#125;&#125;/etc/zabbix_agentd.conf"</span></div><div class="line"></div><div class="line">- name: Create some directory</div><div class="line">  file: path=<span class="string">"&#123;&#123;item.path&#125;&#125;"</span> state=directory mode=0755</div><div class="line">  with_items:</div><div class="line">    - path: <span class="string">"&#123;&#123;nginx_install_path&#125;&#125;/html/zabbix"</span></div><div class="line">    - path: <span class="string">"&#123;&#123;zabbix_log_path&#125;&#125;"</span></div><div class="line">    - path: <span class="string">"&#123;&#123;nginx_log_path&#125;&#125;/zabbix"</span></div><div class="line"></div><div class="line">- name: Copy zabbix pages</div><div class="line">  shell: cp -rpf /tmp/zabbix-3.2.4/frontends/php/* &#123;&#123;nginx_install_path&#125;&#125;/html/zabbix/ &amp;&amp; chown zabbix:zabbix &#123;&#123;nginx_install_path&#125;&#125;/html/zabbix/</div><div class="line">- name: Modify file permissions</div><div class="line">  file: path=<span class="string">"&#123;&#123;nginx_install_path&#125;&#125;/html/zabbix/conf"</span> state=directory owner=zabbix group=zabbix mode=0777</div><div class="line">- name: Command Links</div><div class="line">  file: src=<span class="string">"&#123;&#123;item.src&#125;&#125;"</span> dest=<span class="string">"&#123;&#123;item.dest&#125;&#125;"</span> state=link remote_src=True</div><div class="line">  with_items:</div><div class="line">    - src: <span class="string">"&#123;&#123;zabbix_install_path&#125;&#125;/sbin/zabbix_server"</span></div><div class="line">      dest: <span class="string">"/usr/local/sbin/zabbix_server"</span></div><div class="line">    - src: <span class="string">"&#123;&#123;zabbix_install_path&#125;&#125;/sbin/zabbix_agentd"</span></div><div class="line">      dest: <span class="string">"/usr/local/sbin/zabbix_agentd"</span></div><div class="line">- name: touch zabbix <span class="built_in">log</span> file</div><div class="line">  file: path=&#123;&#123;item.path&#125;&#125; state=touch owner=zabbix group=zabbix mode=0755</div><div class="line">  with_items:</div><div class="line">    - path: <span class="string">"&#123;&#123;zabbix_log_path&#125;&#125;/zabbix_server.log"</span></div><div class="line">    - path: <span class="string">"&#123;&#123;zabbix_log_path&#125;&#125;/zabbix_agentd.log"</span></div><div class="line"></div><div class="line">- name: Configure nginx <span class="keyword">for</span> Zabbix</div><div class="line">  template: src=<span class="string">"templates/zabbix.conf"</span> dest=<span class="string">"&#123;&#123;nginx_install_path&#125;&#125;/conf/vhosts/zabbix.conf"</span> mode=0644 owner=nginx group=nginx</div><div class="line">- name: Check whether fastcgi.conf file exist</div><div class="line">  shell: ls &#123;&#123;nginx_install_path&#125;&#125;/conf/vhosts/fastcgi.conf</div><div class="line">  register: result</div><div class="line">  ignore_errors: True</div><div class="line">- name: Copy fastcgi.conf file</div><div class="line">  copy: src=<span class="string">"templates/fastcgi.conf.j2"</span> dest=<span class="string">"&#123;&#123;nginx_install_path&#125;&#125;/conf/vhosts/fastcgi.conf"</span> mode=0644 owner=nginx group=nginx mode=0644</div><div class="line">  when: result|failed</div><div class="line">- name: Add zabbix to chkconfig</div><div class="line">  shell: chkconfig --add zabbix_server &amp;&amp; chkconfig --add zabbix_agentd</div><div class="line">  notify: restart zabbix server</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#handlers</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat roles/source_zabbix_server/handlers/main.yml</span></div><div class="line">- name: restart zabbix server</div><div class="line">  service: name=&#123;&#123;item.name&#125;&#125; state=restarted enabled=yes</div><div class="line">  with_items:</div><div class="line">    - name: <span class="string">"zabbix_server"</span></div><div class="line">    - name: <span class="string">"zabbix_agentd"</span></div><div class="line">    - name: <span class="string">"php-fpm"</span></div><div class="line">    - name: <span class="string">"nginx"</span></div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#变量</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat roles/source_zabbix_server/vars/main.yml</span></div><div class="line">mysql_user: root</div><div class="line">mysql_host: 192.168.31.110</div><div class="line">mysql_pass: 123456</div><div class="line">mysql_zbx_db: zabbix</div><div class="line">mysql_zbx_user: zabbix</div><div class="line">mysql_zbx_pass: zabbix</div><div class="line">mysql_zbx_hosts: 192.168.31.%</div><div class="line">mysql_port: 3306</div><div class="line"></div><div class="line">zabbix_install_path: /usr/<span class="built_in">local</span>/zabbix</div><div class="line">zabbix_log_path: /var/<span class="built_in">log</span>/zabbix</div><div class="line">zabbix_server_ip: 192.168.31.110</div><div class="line"></div><div class="line">nginx_install_path: /usr/<span class="built_in">local</span>/nginx-1.11.7</div><div class="line">nginx_log_path: /var/<span class="built_in">log</span>/nginx</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#执行过程</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible-playbook /etc/ansible/site.yml </span></div><div class="line"></div><div class="line">PLAY [test_hosts] **************************************************************</div><div class="line"></div><div class="line">TASK [setup] *******************************************************************</div><div class="line">ok: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : disabled iptables] ********************************</div><div class="line">ok: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Set the selinux value to Permissive] **************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Install libselinux-python package] ****************</div><div class="line">ok: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Check whether yum.repo file exist] ****************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Copy yum.repo file] *******************************</div><div class="line">skipping: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Rebuild the yum cache] ****************************</div><div class="line">skipping: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Install same devel packages] **********************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'net-snmp'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'net-snmp-devel'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'libxml2-devel'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'libcurl-devel'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'java-devel'</span>&#125;)</div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'unixODBC'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'unixODBC-devel'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'OpenIPMI-devel'</span>&#125;)</div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'curl-devel'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'libssh2-devel'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'MySQL-python'</span>&#125;)</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Check whether jdk-7u79-linux-x64.tar.gz file exist] ***</div><div class="line">fatal: [192.168.31.110]: FAILED! =&gt; &#123;<span class="string">"changed"</span>: <span class="literal">true</span>, <span class="string">"cmd"</span>: <span class="string">"ls /tmp/jdk-7u79-linux-x64.tar.gz"</span>, <span class="string">"delta"</span>: <span class="string">"0:00:00.006056"</span>, <span class="string">"end"</span>: <span class="string">"2017-03-21 10:42:08.254025"</span>, <span class="string">"failed"</span>: <span class="literal">true</span>, <span class="string">"rc"</span>: 2, <span class="string">"start"</span>: <span class="string">"2017-03-21 10:42:08.247969"</span>, <span class="string">"stderr"</span>: <span class="string">"ls: cannot access /tmp/jdk-7u79-linux-x64.tar.gz: No such file or directory"</span>, <span class="string">"stdout"</span>: <span class="string">""</span>, <span class="string">"stdout_lines"</span>: [], <span class="string">"warnings"</span>: []&#125;</div><div class="line">...ignoring</div><div class="line"></div><div class="line">TASK [source_zabbix_server : download jdk-7u79 <span class="built_in">source</span> package] *****************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Check whether <span class="string">'/usr/local/jdk1.7.0_79'</span> file exist] </div><div class="line">fatal: [192.168.31.110]: FAILED! =&gt; &#123;<span class="string">"changed"</span>: <span class="literal">true</span>, <span class="string">"cmd"</span>: <span class="string">"ls /usr/local/jdk1.7.0_79"</span>, <span class="string">"delta"</span>: <span class="string">"0:00:00.004081"</span>, <span class="string">"end"</span>: <span class="string">"2017-03-21 10:45:48.414682"</span>, <span class="string">"failed"</span>: <span class="literal">true</span>, <span class="string">"rc"</span>: 2, <span class="string">"start"</span>: <span class="string">"2017-03-21 10:45:48.410601"</span>, <span class="string">"stderr"</span>: <span class="string">"ls: cannot access /usr/local/jdk1.7.0_79: No such file or directory"</span>, <span class="string">"stdout"</span>: <span class="string">""</span>, <span class="string">"stdout_lines"</span>: [], <span class="string">"warnings"</span>: []&#125;</div><div class="line">...ignoring</div><div class="line"></div><div class="line">TASK [source_zabbix_server : unarchive jdk-7u79 <span class="built_in">source</span> package] ****************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Configure java variable] **************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : unarchive zabbix-3.2.4 <span class="built_in">source</span> package] ************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Install zabbix <span class="built_in">source</span> package] ********************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Check whether zabbix users exist] *****************</div><div class="line">fatal: [192.168.31.110]: FAILED! =&gt; &#123;<span class="string">"changed"</span>: <span class="literal">true</span>, <span class="string">"cmd"</span>: <span class="string">"id zabbix"</span>, <span class="string">"delta"</span>: <span class="string">"0:00:00.004139"</span>, <span class="string">"end"</span>: <span class="string">"2017-03-21 10:46:58.885950"</span>, <span class="string">"failed"</span>: <span class="literal">true</span>, <span class="string">"rc"</span>: 1, <span class="string">"start"</span>: <span class="string">"2017-03-21 10:46:58.881811"</span>, <span class="string">"stderr"</span>: <span class="string">"id: zabbix: No such user"</span>, <span class="string">"stdout"</span>: <span class="string">""</span>, <span class="string">"stdout_lines"</span>: [], <span class="string">"warnings"</span>: []&#125;</div><div class="line">...ignoring</div><div class="line"></div><div class="line">TASK [source_zabbix_server : The zabbix user does not exist, so we need to create it.] ***</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Replace some files] *******************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/etc/php.ini'</span>, u<span class="string">'line'</span>: u<span class="string">'max_execution_time = 300'</span>, u<span class="string">'reg'</span>: u<span class="string">'^max_execution_time'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/etc/php.ini'</span>, u<span class="string">'line'</span>: u<span class="string">'post_max_size = 16M'</span>, u<span class="string">'reg'</span>: u<span class="string">'^post_max_size'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/etc/php.ini'</span>, u<span class="string">'line'</span>: u<span class="string">'max_input_time = 300'</span>, u<span class="string">'reg'</span>: u<span class="string">'^max_input_time'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/etc/php.ini'</span>, u<span class="string">'line'</span>: u<span class="string">'date.timezone = "Asia/Shanghai"'</span>, u<span class="string">'reg'</span>: u<span class="string">'^;date.timezone'</span>&#125;)</div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/etc/php-fpm.conf'</span>, u<span class="string">'line'</span>: u<span class="string">'pid = /var/run/php-fpm/php-fpm.pid'</span>, u<span class="string">'reg'</span>: u<span class="string">'^;pid ='</span>&#125;)</div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/etc/php-fpm.d/www.conf'</span>, u<span class="string">'line'</span>: u<span class="string">'pm.min_spare_servers = 5'</span>, u<span class="string">'reg'</span>: u<span class="string">'^;pm.min_spare_servers'</span>&#125;)</div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/etc/php-fpm.d/www.conf'</span>, u<span class="string">'line'</span>: u<span class="string">'pm.max_spare_servers = 35'</span>, u<span class="string">'reg'</span>: u<span class="string">'^;pm.max_spare_servers'</span>&#125;)</div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/etc/php-fpm.d/www.conf'</span>, u<span class="string">'line'</span>: u<span class="string">'pm.start_servers = 5'</span>, u<span class="string">'reg'</span>: u<span class="string">'^;^pm.start_servers'</span>&#125;)</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Copy authorization.sql file] **********************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'files/authorization.sql'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'files/initialize.sql'</span>&#125;)</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Set up mysql database authorization] **************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Authorize Zabbix users] ***************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Initialize the zabbix database] *******************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Configure zabbix] *********************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Copy zabbix configure] ****************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/usr/local/zabbix/etc/zabbix_server.conf'</span>, u<span class="string">'src'</span>: u<span class="string">'templates/zabbix_server.conf'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/usr/local/zabbix/etc/zabbix_agentd.conf'</span>, u<span class="string">'src'</span>: u<span class="string">'templates/zabbix_agentd.conf'</span>&#125;)</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Create some directory] ****************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'path'</span>: u<span class="string">'/usr/local/nginx-1.11.7/html/zabbix'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'path'</span>: u<span class="string">'/var/log/zabbix'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'path'</span>: u<span class="string">'/var/log/nginx/zabbix'</span>&#125;)</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Copy zabbix pages] ********************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Modify file permissions] **************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Command Links] ************************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/usr/local/sbin/zabbix_server'</span>, u<span class="string">'src'</span>: u<span class="string">'/usr/local/zabbix/sbin/zabbix_server'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/usr/local/sbin/zabbix_agentd'</span>, u<span class="string">'src'</span>: u<span class="string">'/usr/local/zabbix/sbin/zabbix_agentd'</span>&#125;)</div><div class="line"></div><div class="line">TASK [source_zabbix_server : touch zabbix <span class="built_in">log</span> file] ****************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'path'</span>: u<span class="string">'/var/log/zabbix/zabbix_server.log'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'path'</span>: u<span class="string">'/var/log/zabbix/zabbix_agentd.log'</span>&#125;)</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Configure nginx <span class="keyword">for</span> Zabbix] ***********************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Check whether fastcgi.conf file exist] ************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Copy fastcgi.conf file] ***************************</div><div class="line">skipping: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Add zabbix to chkconfig] **************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">RUNNING HANDLER [source_zabbix_server : restart zabbix server] *****************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'zabbix_server'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'zabbix_agentd'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'php-fpm'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'nginx'</span>&#125;)</div><div class="line"></div><div class="line">PLAY RECAP *********************************************************************</div><div class="line">192.168.31.110             : ok=31   changed=28   unreachable=0    failed=0   </div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p><img src="http://note.youdao.com/yws/api/personal/file/1B3E3B138F6F4BD2BD3F7EE4A611B33C?method=download&amp;shareKey=15995fa7cd9fd6515aa8b95ea4712f07" alt="image">  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m shell -a 'ps -ef | grep zabbix | grep -v grep'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">zabbix    11586      1  0 18:01 ?        00:00:00 /usr/<span class="built_in">local</span>/sbin/zabbix_server</div><div class="line">zabbix    11593  11586  0 18:01 ?        00:00:00 /usr/<span class="built_in">local</span>/sbin/zabbix_server: configuration syncer [synced configuration <span class="keyword">in</span> 0.006998 sec, idle 60 sec]</div><div class="line">zabbix    11594  11586  0 18:01 ?        00:00:00 /usr/<span class="built_in">local</span>/sbin/zabbix_server: db watchdog [synced alerts config <span class="keyword">in</span> 0.001220 sec, idle 60 sec]</div><div class="line">zabbix    11595  11586  0 18:01 ?        00:00:00 /usr/<span class="built_in">local</span>/sbin/zabbix_server: poller <span class="comment">#1 [got 0 values in 0.000101 sec, idle 5 sec]</span></div><div class="line">···</div></pre></td></tr></table></figure>
<p><img src="http://note.youdao.com/yws/api/personal/file/F586BD68280D4E8281FF40208BB99318?method=download&amp;shareKey=2547559de07cb0792ac84676339ec885" alt="image"><br><img src="http://note.youdao.com/yws/api/personal/file/AAB04280F3D5480098F3560BA6ACCBD6?method=download&amp;shareKey=22bd12e0ba86ebb7b6f545ca6debaea7" alt="image">  </p>
<h2 id="Ansible之源码安装Zabbix-agent"><a href="#Ansible之源码安装Zabbix-agent" class="headerlink" title="Ansible之源码安装Zabbix-agent"></a>Ansible之源码安装Zabbix-agent</h2><ul>
<li>Zabbix_Agent结构目录  </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#结构目录</span></div><div class="line">[root@Ansible ~]<span class="comment"># tree /etc/ansible/</span></div><div class="line">/etc/ansible/</div><div class="line">├── ansible.cfg</div><div class="line">├── hosts</div><div class="line">├── roles</div><div class="line">│   └── source_zabbix_agent</div><div class="line">│       ├── files</div><div class="line">│       │   ├── yum.repo</div><div class="line">│       │   └── zabbix-3.2.4.tar.gz</div><div class="line">│       ├── handlers</div><div class="line">│       │   └── main.yml</div><div class="line">│       ├── tasks</div><div class="line">│       │   └── main.yml</div><div class="line">│       ├── templates</div><div class="line">│       │   └── zabbix_agentd.conf</div><div class="line">│       └── vars</div><div class="line">│           └── main.yml</div><div class="line">└── site.yml</div><div class="line"></div><div class="line">7 directories, 9 files</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>环境：<br>　　　ansible 2.2.1.0<br>　　　Centos 6.6<br>　　　zabbix-3.2.4  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#入口文件</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat site.yml </span></div><div class="line">- hosts: test_hosts2</div><div class="line">  user: root</div><div class="line">  roles:</div><div class="line">    - source_zabbix_agent</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#tasks</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat roles/source_zabbix_agent/tasks/main.yml </span></div><div class="line">- name: Install libselinux-python package</div><div class="line">  yum: name=libselinux-python state=installed</div><div class="line"></div><div class="line">- name: Check whether yum.repo file exist</div><div class="line">  shell: ls /etc/yum.repos.d/yum.repo</div><div class="line">  register: result</div><div class="line">  ignore_errors: True</div><div class="line">- name: Copy yum.repo file</div><div class="line">  copy: src=<span class="string">"files/yum.repo"</span> dest=<span class="string">"/etc/yum.repos.d/yum.repo"</span> mode=0644 owner=root group=root</div><div class="line">  when: result|failed</div><div class="line">- name: Rebuild the yum cache</div><div class="line">  shell: yum clean all &amp;&amp; yum makecache</div><div class="line">  when: result|failed</div><div class="line"></div><div class="line">- name: Install same devel packages</div><div class="line">  yum: name=<span class="string">"&#123;&#123;item.name&#125;&#125;"</span></div><div class="line">  with_items:</div><div class="line">    - name: <span class="string">"net-snmp"</span></div><div class="line">    - name: <span class="string">"net-snmp-devel"</span></div><div class="line">    - name: <span class="string">"libxml2-devel"</span></div><div class="line">    - name: <span class="string">"libcurl-devel"</span></div><div class="line">    - name: <span class="string">"java-devel"</span></div><div class="line">    - name: <span class="string">"unixODBC"</span></div><div class="line">    - name: <span class="string">"unixODBC-devel"</span></div><div class="line">    - name: <span class="string">"OpenIPMI-devel"</span></div><div class="line">    - name: <span class="string">"curl-devel"</span></div><div class="line">    - name: <span class="string">"libssh2-devel"</span></div><div class="line">    - name: <span class="string">"MySQL-python"</span></div><div class="line"></div><div class="line">- name: unarchive zabbix-3.2.4 <span class="built_in">source</span> package</div><div class="line">  unarchive: src=<span class="string">"files/zabbix-3.2.4.tar.gz"</span> dest=<span class="string">"/tmp"</span> remote_src=no</div><div class="line">- name: Install zabbix <span class="built_in">source</span> package</div><div class="line">  shell: <span class="built_in">cd</span> /tmp/zabbix-3.2.4 &amp;&amp; ./configure --prefix=&#123;&#123;zabbix_install_path&#125;&#125; --enable-agent  &amp;&amp; make &amp;&amp; make install</div><div class="line">- name: Configure zabbix</div><div class="line">  copy: src=<span class="string">"/tmp/zabbix-3.2.4/misc/init.d/fedora/core/zabbix_agentd"</span> dest=<span class="string">"/etc/init.d/zabbix_agentd"</span> mode=0755 remote_src=True</div><div class="line"></div><div class="line">- name: Check whether zabbix users exist</div><div class="line">  shell: id zabbix</div><div class="line">  register: result</div><div class="line">  ignore_errors: True</div><div class="line">- name: The zabbix user does not exist, so we need to create it.</div><div class="line">  user: name=zabbix createhome=yes home=/home/zabbix shell=/sbin/nologin  state=present</div><div class="line">  when: result|failed</div><div class="line"></div><div class="line">- name: Configure zabbix agent</div><div class="line">  template: src=<span class="string">"templates/zabbix_agentd.conf"</span> dest=<span class="string">"&#123;&#123;zabbix_install_path&#125;&#125;/etc/zabbix_agentd.conf"</span></div><div class="line"></div><div class="line">- name: Command Links</div><div class="line">  file: src=<span class="string">"&#123;&#123;zabbix_install_path&#125;&#125;/sbin/zabbix_agentd"</span> dest=<span class="string">"/usr/local/sbin/zabbix_agentd"</span> state=link remote_src=True</div><div class="line"></div><div class="line">- name: touch zabbix <span class="built_in">log</span> file</div><div class="line">  file: path=&#123;&#123;item.path&#125;&#125; state=<span class="string">"&#123;&#123;item.state|default("</span>touch<span class="string">")&#125;&#125;"</span> owner=zabbix group=zabbix mode=0755</div><div class="line">  with_items:</div><div class="line">    - path: <span class="string">"&#123;&#123;zabbix_log_path&#125;&#125;"</span></div><div class="line">      state: <span class="string">"directory"</span></div><div class="line">    - path: <span class="string">"&#123;&#123;zabbix_log_path&#125;&#125;/zabbix_agentd.log"</span></div><div class="line">- name: Add zabbix_agent to chkconfig</div><div class="line">  shell: chkconfig --add zabbix_agentd</div><div class="line">  notify: restart zabbix agent</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#handlers</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat roles/source_zabbix_agent/handlers/main.yml </span></div><div class="line">- name: restart zabbix agent</div><div class="line">  service: name=<span class="string">"zabbix_agentd"</span> state=restarted enabled=yes</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#变量</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat roles/source_zabbix_agent/vars/main.yml </span></div><div class="line">zabbix_install_path: /usr/<span class="built_in">local</span>/zabbix</div><div class="line">zabbix_log_path: /var/<span class="built_in">log</span>/zabbix</div><div class="line">zabbix_server_ip: 192.168.31.110</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#执行过程</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible-playbook /etc/ansible/site.yml </span></div><div class="line"></div><div class="line">PLAY [test_hosts2] *************************************************************</div><div class="line"></div><div class="line">TASK [setup] *******************************************************************</div><div class="line">ok: [192.168.31.120]</div><div class="line"></div><div class="line">TASK [source_zabbix_agent : Install libselinux-python package] *****************</div><div class="line">changed: [192.168.31.120]</div><div class="line"></div><div class="line">TASK [source_zabbix_agent : Check whether yum.repo file exist] *****************</div><div class="line">fatal: [192.168.31.120]: FAILED! =&gt; &#123;<span class="string">"changed"</span>: <span class="literal">true</span>, <span class="string">"cmd"</span>: <span class="string">"ls /etc/yum.repos.d/yum.repo"</span>, <span class="string">"delta"</span>: <span class="string">"0:00:00.004811"</span>, <span class="string">"end"</span>: <span class="string">"2017-03-21 18:22:42.833895"</span>, <span class="string">"failed"</span>: <span class="literal">true</span>, <span class="string">"rc"</span>: 2, <span class="string">"start"</span>: <span class="string">"2017-03-21 18:22:42.829084"</span>, <span class="string">"stderr"</span>: <span class="string">"ls: cannot access /etc/yum.repos.d/yum.repo: No such file or directory"</span>, <span class="string">"stdout"</span>: <span class="string">""</span>, <span class="string">"stdout_lines"</span>: [], <span class="string">"warnings"</span>: []&#125;</div><div class="line">...ignoring</div><div class="line"></div><div class="line">TASK [source_zabbix_agent : Copy yum.repo file] ********************************</div><div class="line">changed: [192.168.31.120]</div><div class="line"></div><div class="line">TASK [source_zabbix_agent : Rebuild the yum cache] *****************************</div><div class="line">changed: [192.168.31.120]</div><div class="line"> [WARNING]: Consider using yum module rather than running yum</div><div class="line"></div><div class="line"></div><div class="line">TASK [source_zabbix_agent : Install same devel packages] ***********************</div><div class="line">changed: [192.168.31.120] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'net-snmp'</span>&#125;)</div><div class="line">changed: [192.168.31.120] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'net-snmp-devel'</span>&#125;)</div><div class="line">changed: [192.168.31.120] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'libxml2-devel'</span>&#125;)</div><div class="line">changed: [192.168.31.120] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'libcurl-devel'</span>&#125;)</div><div class="line">changed: [192.168.31.120] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'java-devel'</span>&#125;)</div><div class="line">changed: [192.168.31.120] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'unixODBC'</span>&#125;)</div><div class="line">changed: [192.168.31.120] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'unixODBC-devel'</span>&#125;)</div><div class="line">changed: [192.168.31.120] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'OpenIPMI-devel'</span>&#125;)</div><div class="line">ok: [192.168.31.120] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'curl-devel'</span>&#125;)</div><div class="line">changed: [192.168.31.120] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'libssh2-devel'</span>&#125;)</div><div class="line">changed: [192.168.31.120] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'MySQL-python'</span>&#125;)</div><div class="line"></div><div class="line">TASK [source_zabbix_agent : unarchive zabbix-3.2.4 <span class="built_in">source</span> package] *************</div><div class="line">changed: [192.168.31.120]</div><div class="line"></div><div class="line">TASK [source_zabbix_agent : Install zabbix <span class="built_in">source</span> package] *********************</div><div class="line">changed: [192.168.31.120]</div><div class="line"></div><div class="line">TASK [source_zabbix_agent : Configure zabbix] **********************************</div><div class="line">changed: [192.168.31.120]</div><div class="line"></div><div class="line">TASK [source_zabbix_agent : Check whether zabbix users exist] ******************</div><div class="line">fatal: [192.168.31.120]: FAILED! =&gt; &#123;<span class="string">"changed"</span>: <span class="literal">true</span>, <span class="string">"cmd"</span>: <span class="string">"id zabbix"</span>, <span class="string">"delta"</span>: <span class="string">"0:00:00.005663"</span>, <span class="string">"end"</span>: <span class="string">"2017-03-21 18:35:09.861371"</span>, <span class="string">"failed"</span>: <span class="literal">true</span>, <span class="string">"rc"</span>: 1, <span class="string">"start"</span>: <span class="string">"2017-03-21 18:35:09.855708"</span>, <span class="string">"stderr"</span>: <span class="string">"id: zabbix: No such user"</span>, <span class="string">"stdout"</span>: <span class="string">""</span>, <span class="string">"stdout_lines"</span>: [], <span class="string">"warnings"</span>: []&#125;</div><div class="line">...ignoring</div><div class="line"></div><div class="line">TASK [source_zabbix_agent : The zabbix user does not exist, so we need to create it.] ***</div><div class="line">changed: [192.168.31.120]</div><div class="line"></div><div class="line">TASK [source_zabbix_agent : Configure zabbix agent] ****************************</div><div class="line">changed: [192.168.31.120]</div><div class="line"></div><div class="line">TASK [source_zabbix_agent : Command Links] *************************************</div><div class="line">changed: [192.168.31.120]</div><div class="line"></div><div class="line">TASK [source_zabbix_agent : touch zabbix <span class="built_in">log</span> file] *****************************</div><div class="line">changed: [192.168.31.120] =&gt; (item=&#123;u<span class="string">'path'</span>: u<span class="string">'/var/log/zabbix'</span>, u<span class="string">'state'</span>: u<span class="string">'directory'</span>&#125;)</div><div class="line">changed: [192.168.31.120] =&gt; (item=&#123;u<span class="string">'path'</span>: u<span class="string">'/var/log/zabbix/zabbix_agentd.log'</span>&#125;)</div><div class="line"></div><div class="line">TASK [source_zabbix_agent : Add zabbix_agent to chkconfig] *********************</div><div class="line">changed: [192.168.31.120]</div><div class="line"></div><div class="line">RUNNING HANDLER [source_zabbix_agent : restart zabbix agent] *******************</div><div class="line">changed: [192.168.31.120]</div><div class="line"></div><div class="line">PLAY RECAP *********************************************************************</div><div class="line">192.168.31.120             : ok=16   changed=15   unreachable=0    failed=0   </div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts2 -m shell -a 'ps -ef | grep zabbix_agentd  | grep -v grep'</span></div><div class="line">192.168.31.120 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">zabbix     9164      1  0 18:35 ?        00:00:00 /usr/<span class="built_in">local</span>/sbin/zabbix_agentd</div><div class="line">zabbix     9167   9164  0 18:35 ?        00:00:00 /usr/<span class="built_in">local</span>/sbin/zabbix_agentd: collector [idle 1 sec]</div><div class="line">zabbix     9168   9164  0 18:35 ?        00:00:00 /usr/<span class="built_in">local</span>/sbin/zabbix_agentd: listener <span class="comment">#1 [waiting for connection]</span></div><div class="line">zabbix     9169   9164  0 18:35 ?        00:00:00 /usr/<span class="built_in">local</span>/sbin/zabbix_agentd: listener <span class="comment">#2 [waiting for connection]</span></div><div class="line">zabbix     9170   9164  0 18:35 ?        00:00:00 /usr/<span class="built_in">local</span>/sbin/zabbix_agentd: listener <span class="comment">#3 [waiting for connection]</span></div><div class="line">zabbix     9171   9164  0 18:35 ?        00:00:00 /usr/<span class="built_in">local</span>/sbin/zabbix_agentd: active checks <span class="comment">#1 [idle 1 sec]</span></div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p><img src="http://note.youdao.com/yws/api/personal/file/5D828A8CCD3643EB8F083F1CCF8C71EB?method=download&amp;shareKey=0810956092871cfbe13f70370cb0395c" alt="image">  </p>
<p>附件：<br><a href="http://note.youdao.com/yws/api/personal/file/554F1EB189BD49ACBDAD71A8B003AC3F?method=download&amp;shareKey=be625cbe4ce873c616ff86f32ea8763b" target="_blank" rel="external">ansible_install_zabbix_server3.2.tar.gz</a><br><a href="http://note.youdao.com/yws/api/personal/file/A9AAE22EB1F64A01B780344178710FAD?method=download&amp;shareKey=6a6454485d9104a40c2fccaffeb33473" target="_blank" rel="external">ansible_install_zabbix_agent3.2.tar.gz</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/03/20/Ansible-Playbooks之安装Zabbix/">http://www.yfshare.vip/2017/03/20/Ansible-Playbooks之安装Zabbix/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Ansible-Playbooks之安装LNMP]]></title>
      <url>http://www.yfshare.vip/2017/03/20/Ansible-Playbooks%E4%B9%8B%E5%AE%89%E8%A3%85LNMP/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>playbooks 是一种简单的配置管理系统与多机器部署系统的基础。与现有的其他系统有不同之处,且非常适合于复杂应用的批量部署<br>Playbooks 的格式是YAML，语法做到最小化  </p>
<p>这里讲述的是使用ansible-playbooks的roles安装LNMP应用<br><a id="more"></a></p>
<h2 id="结构目录"><a href="#结构目录" class="headerlink" title="结构目录"></a>结构目录</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">[root@Ansible ~]<span class="comment"># tree /etc/ansible/</span></div><div class="line">/etc/ansible/</div><div class="line">├── ansible.cfg</div><div class="line">├── hosts</div><div class="line">├── roles</div><div class="line">│   ├── source_nginx</div><div class="line">│   │   ├── files</div><div class="line">│   │   │   ├── <span class="built_in">echo</span>-nginx-module-0.59.tar.gz</div><div class="line">│   │   │   ├── gperftools-2.0.zip</div><div class="line">│   │   │   ├── nginx-1.11.7.tar.gz</div><div class="line">│   │   │   ├── nginx_tcp_proxy_module_nginx1.11.7.zip</div><div class="line">│   │   │   ├── nginx-upstream-jvm-route-nginx1.11.7.zip</div><div class="line">│   │   │   ├── ngx_cache_purge-2.3.tar.gz</div><div class="line">│   │   │   ├── openssl-1.1.0e.tar.gz</div><div class="line">│   │   │   ├── pcre-8.40.zip</div><div class="line">│   │   │   ├── yum.repo</div><div class="line">│   │   │   └── zlib-1.2.11.tar.gz</div><div class="line">│   │   ├── handlers</div><div class="line">│   │   │   └── main.yml</div><div class="line">│   │   ├── tasks</div><div class="line">│   │   │   └── main.yml</div><div class="line">│   │   ├── templates</div><div class="line">│   │   │   ├── comm.conf.j2</div><div class="line">│   │   │   ├── etc_init.d_nginx.txt</div><div class="line">│   │   │   ├── fastcgi.conf.j2</div><div class="line">│   │   │   ├── nginx.conf.j2</div><div class="line">│   │   │   ├── proxy.conf.j2</div><div class="line">│   │   │   └── static.conf.j2</div><div class="line">│   │   └── vars</div><div class="line">│   │       └── main.yml</div><div class="line">│   ├── yum_mysql</div><div class="line">│   │   ├── files</div><div class="line">│   │   │   └── yum.repo</div><div class="line">│   │   ├── handlers</div><div class="line">│   │   │   └── main.yml</div><div class="line">│   │   ├── tasks</div><div class="line">│   │   │   └── main.yml</div><div class="line">│   │   ├── templates</div><div class="line">│   │   │   └── my.cnf.j2</div><div class="line">│   │   └── vars</div><div class="line">│   │       └── main.yml</div><div class="line">│   └── yum_php</div><div class="line">│       ├── files</div><div class="line">│       │   └── yum.repo</div><div class="line">│       ├── handlers</div><div class="line">│       │   └── main.yml</div><div class="line">│       ├── tasks</div><div class="line">│       │   └── main.yml</div><div class="line">│       ├── templates</div><div class="line">│       │   └── www.conf.j2</div><div class="line">│       └── vars</div><div class="line">│           └── main.yml</div><div class="line">└── site.yml</div><div class="line"></div><div class="line">19 directories, 32 files</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h2 id="Ansible之安装LNMP"><a href="#Ansible之安装LNMP" class="headerlink" title="Ansible之安装LNMP"></a>Ansible之安装LNMP</h2><p>参考：<br><a href="http://www.yfshare.vip/2017/03/11/Ansible-Playbooks之安装Nginx/">Ansible-Playbooks之安装Nginx</a><br><a href="HTTP://WWW.YFSHARE.VIP/2017/03/15/ANSIBLE-PLAYBOOKS之安装PHP/">Ansible-Playbooks之安装PHP</a><br><a href="http://www.yfshare.vip/2017/03/16/Ansible-Playbooks之安装Mysql/">Ansible-Playbooks之安装Mysql</a><br>环境：<br>　　　ansible 2.2.1.0<br>　　　Centos 6.6<br>　　　PHP 7.0.16 (fpm-fcgi)<br>　　　Nginx 1.11.7<br>　　　Mysql 5.5.54 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#入口文件</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat site.yml </span></div><div class="line">- hosts: test_hosts</div><div class="line">  user: root</div><div class="line">  roles:</div><div class="line">    - yum_mysql</div><div class="line">    - yum_php</div><div class="line">    - source_nginx</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>注：之前可能是在最后安装的mysql，把之前在PHP上安装的一个插件(php70w-mysql)弄丢了，所以就把mysql放最前面安装了<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div></pre></td><td class="code"><pre><div class="line">[root@Ansible ~]<span class="comment"># ansible-playbook /etc/ansible/site.yml </span></div><div class="line"></div><div class="line">PLAY [test_hosts] **************************************************************</div><div class="line"></div><div class="line">TASK [setup] *******************************************************************</div><div class="line">ok: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_mysql : Install libselinux-python package] ***************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_mysql : Check whether yum.repo file exist] ***************************</div><div class="line">fatal: [192.168.31.110]: FAILED! =&gt; &#123;<span class="string">"changed"</span>: <span class="literal">true</span>, <span class="string">"cmd"</span>: <span class="string">"ls /etc/yum.repos.d/yum.repo"</span>, <span class="string">"delta"</span>: <span class="string">"0:00:00.004362"</span>, <span class="string">"end"</span>: <span class="string">"2017-03-20 12:01:43.959441"</span>, <span class="string">"failed"</span>: <span class="literal">true</span>, <span class="string">"rc"</span>: 2, <span class="string">"start"</span>: <span class="string">"2017-03-20 12:01:43.955079"</span>, <span class="string">"stderr"</span>: <span class="string">"ls: cannot access /etc/yum.repos.d/yum.repo: No such file or directory"</span>, <span class="string">"stdout"</span>: <span class="string">""</span>, <span class="string">"stdout_lines"</span>: [], <span class="string">"warnings"</span>: []&#125;</div><div class="line">...ignoring</div><div class="line"></div><div class="line">TASK [yum_mysql : Copy yum.repo file] ******************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_mysql : Rebuild the yum cache] ***************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"> [WARNING]: Consider using yum module rather than running yum</div><div class="line"></div><div class="line"></div><div class="line">TASK [yum_mysql : Install Mysql Packages] **************************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'state'</span>: u<span class="string">'absent'</span>, u<span class="string">'name'</span>: u<span class="string">'mysql*'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'mysql.x86_64'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'mysql-devel.x86_64'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'mysql-server.x86_64'</span>&#125;)</div><div class="line"></div><div class="line">TASK [yum_mysql : Configure Mysql file] ****************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_php : Install libselinux-python package] *****************************</div><div class="line">ok: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_php : Check whether yum.repo file exist] *****************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_php : Copy yum.repo file] ********************************************</div><div class="line">skipping: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_php : Rebuild the yum cache] *****************************************</div><div class="line">skipping: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_php : Check whether nginx users exist] *******************************</div><div class="line">fatal: [192.168.31.110]: FAILED! =&gt; &#123;<span class="string">"changed"</span>: <span class="literal">true</span>, <span class="string">"cmd"</span>: <span class="string">"id nginx"</span>, <span class="string">"delta"</span>: <span class="string">"0:00:00.005955"</span>, <span class="string">"end"</span>: <span class="string">"2017-03-20 12:14:49.015479"</span>, <span class="string">"failed"</span>: <span class="literal">true</span>, <span class="string">"rc"</span>: 1, <span class="string">"start"</span>: <span class="string">"2017-03-20 12:14:49.009524"</span>, <span class="string">"stderr"</span>: <span class="string">"id: nginx: No such user"</span>, <span class="string">"stdout"</span>: <span class="string">""</span>, <span class="string">"stdout_lines"</span>: [], <span class="string">"warnings"</span>: []&#125;</div><div class="line">...ignoring</div><div class="line"></div><div class="line">TASK [yum_php : The nginx user does not exist, so we need to create it.[The nginx user<span class="string">'s password is 123456]] ***</span></div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_php : Install PHP packages] ******************************************</div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'state<span class="string">': u'</span>absent<span class="string">', u'</span>name<span class="string">': u'</span>php*<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-gd<span class="string">'&#125;)</span></div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>libjpeg*<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-imap<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-ldap<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-odbc<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-pear<span class="string">'&#125;)</span></div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-xml<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-xmlrpc<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-mbstring<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-mcrypt<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-bcmath<span class="string">'&#125;)</span></div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>libmcrypt<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>libmcrypt-devel<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-fpm<span class="string">'&#125;)</span></div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-cli<span class="string">'&#125;)</span></div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-pdo<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-tidy<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-mysql<span class="string">'&#125;)</span></div><div class="line"></div><div class="line">TASK [yum_php : Configure PHP] *************************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_php : Modify file permissions] ***************************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'path<span class="string">': u'</span>/etc/httpd/conf.d/php.conf<span class="string">', u'</span>state<span class="string">': u'</span>file<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'path<span class="string">': u'</span>/var/lib/php/session<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'path<span class="string">': u'</span>/var/lib/php/wsdlcache<span class="string">'&#125;)</span></div><div class="line"></div><div class="line">TASK [source_nginx : disabled iptables] ****************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Set the selinux value to Permissive] **********************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Create download directory] ********************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Install the some tools] ***********************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>unzip<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>zip<span class="string">'&#125;)</span></div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>tar<span class="string">'&#125;)</span></div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>libselinux-python<span class="string">'&#125;)</span></div><div class="line"></div><div class="line">TASK [source_nginx : download some source packages] ****************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'url<span class="string">': u'</span>https://ftp.pcre.org/pub/pcre/pcre-8.40.zip<span class="string">', u'</span>validate_certs<span class="string">': u'</span>no<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'url<span class="string">': u'</span>http://nginx.org/download/nginx-1.11.7.tar.gz<span class="string">'&#125;)</span></div><div class="line"></div><div class="line">TASK [source_nginx : unarchive some source packages] ***************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'src<span class="string">': u'</span>/tmp/download/nginx-1.11.7.tar.gz<span class="string">', u'</span>remote_src<span class="string">': u'</span>yes<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'src<span class="string">': u'</span>/tmp/download/pcre-8.40.zip<span class="string">', u'</span>remote_src<span class="string">': u'</span>yes<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'src<span class="string">': u'</span>files/zlib-1.2.11.tar.gz<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'src<span class="string">': u'</span>files/openssl-1.1.0e.tar.gz<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'src<span class="string">': u'</span>files/gperftools-2.0.zip<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'src<span class="string">': u'</span>files/<span class="built_in">echo</span>-nginx-module-0.59.tar.gz<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'src<span class="string">': u'</span>files/nginx-upstream-jvm-route-nginx1.11.7.zip<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'src<span class="string">': u'</span>files/ngx_cache_purge-2.3.tar.gz<span class="string">'&#125;)</span></div><div class="line"></div><div class="line">TASK [source_nginx : Check whether nginx users exist] **************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : The nginx user does not exist, so we need to create it.[The nginx user's password is 123456]] ***</div><div class="line">skipping: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Install the pcre-8.40 <span class="built_in">source</span> package] *********************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Install the zlib-1.2.11 <span class="built_in">source</span> package] *******************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Install the openssl-1.1.0e <span class="built_in">source</span> package] ****************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Install the some devel packages] **************************</div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'rpm'</span>: u<span class="string">'openssl-devel'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'rpm'</span>: u<span class="string">'pcre-devel'</span>&#125;)</div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'rpm'</span>: u<span class="string">'zlib-devel'</span>&#125;)</div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'rpm'</span>: u<span class="string">'gcc'</span>&#125;)</div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'rpm'</span>: u<span class="string">'gcc-c++'</span>&#125;)</div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'rpm'</span>: u<span class="string">'make'</span>&#125;)</div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'rpm'</span>: u<span class="string">'perl'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'rpm'</span>: u<span class="string">'perl-devel'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'rpm'</span>: u<span class="string">'perl-ExtUtils-Embed'</span>&#125;)</div><div class="line"></div><div class="line">TASK [source_nginx : Install the gperftools-2.0 <span class="built_in">source</span> package] ****************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Install patch package] ************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Play nginx-upstream-jvm-route patche] *********************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Install the Nginx package] ********************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Create some directory] ************************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'path'</span>: u<span class="string">'/tmp/tcmalloc'</span>, u<span class="string">'mode'</span>: u<span class="string">'0777'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'path'</span>: u<span class="string">'/var/proxy_cache/temp'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'path'</span>: u<span class="string">'/var/proxy_cache/cache'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'path'</span>: u<span class="string">'/var/log/nginx'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'path'</span>: u<span class="string">'/usr/local/nginx-1.11.7/conf/vhosts'</span>&#125;)</div><div class="line"></div><div class="line">TASK [source_nginx : <span class="built_in">set</span> nginx parameter] **************************************</div><div class="line">ok: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Copy same files] ******************************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/etc/init.d/nginx'</span>, u<span class="string">'src'</span>: u<span class="string">'templates/etc_init.d_nginx.txt'</span>, u<span class="string">'mode'</span>: u<span class="string">'0755'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/usr/local/nginx-1.11.7/conf/nginx.conf'</span>, u<span class="string">'src'</span>: u<span class="string">'templates/nginx.conf.j2'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/usr/local/nginx-1.11.7/conf/vhosts/proxy.conf'</span>, u<span class="string">'src'</span>: u<span class="string">'templates/proxy.conf.j2'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/usr/local/nginx-1.11.7/conf/vhosts/comm.conf'</span>, u<span class="string">'src'</span>: u<span class="string">'templates/comm.conf.j2'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/usr/local/nginx-1.11.7/conf/vhosts/static.conf'</span>, u<span class="string">'src'</span>: u<span class="string">'templates/static.conf.j2'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/usr/local/nginx-1.11.7/conf/vhosts/fastcgi.conf'</span>, u<span class="string">'src'</span>: u<span class="string">'templates/fastcgi.conf.j2'</span>&#125;)</div><div class="line"></div><div class="line">RUNNING HANDLER [yum_mysql : restart mysql] ************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">RUNNING HANDLER [yum_mysql : Set the mysql database password] ******************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">RUNNING HANDLER [yum_php : restart php-fpm] ************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">RUNNING HANDLER [source_nginx : restart nginx] *********************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">PLAY RECAP *********************************************************************</div><div class="line">192.168.31.110             : ok=36   changed=33   unreachable=0    failed=0   </div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m shell -a '/etc/init.d/nginx status'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">nginx (pid  78698) is running...</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m shell -a '/etc/init.d/php-fpm status'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">php-fpm (pid  78539) is running...</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m shell -a '/etc/init.d/mysqld status'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">mysqld (pid 78413) is running...</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p><img src="http://note.youdao.com/yws/api/personal/file/994FFC90CD3947DE8ED1E8BF19428A63?method=download&amp;shareKey=7e2c02f801b5e0f73c8054dfddbb8474" alt="image">  </p>
<p>附件：<a href="http://note.youdao.com/yws/api/personal/file/6E4594BA860B4DEC8CFE212B8869807A?method=download&amp;shareKey=3e0078221cc76b7e52f5c1e063e3c218" target="_blank" rel="external">ansible_install_LNMP.tar.gz</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/03/20/Ansible-Playbooks之安装LNMP/">http://www.yfshare.vip/2017/03/20/Ansible-Playbooks之安装LNMP/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Ansible-Playbooks之安装Mysql]]></title>
      <url>http://www.yfshare.vip/2017/03/16/Ansible-Playbooks%E4%B9%8B%E5%AE%89%E8%A3%85Mysql/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>playbooks 是一种简单的配置管理系统与多机器部署系统的基础。与现有的其他系统有不同之处,且非常适合于复杂应用的批量部署<br>Playbooks 的格式是YAML，语法做到最小化  </p>
<p>这里讲述的是使用ansible-playbooks的roles安装Mysql应用<br><a id="more"></a></p>
<h2 id="结构目录"><a href="#结构目录" class="headerlink" title="结构目录"></a>结构目录</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">[root@Ansible ~]<span class="comment"># tree /etc/ansible/</span></div><div class="line">/etc/ansible/</div><div class="line">├── ansible.cfg</div><div class="line">├── hosts</div><div class="line">├── roles</div><div class="line">│   └── yum_mysql</div><div class="line">│       ├── files</div><div class="line">│       │   └── yum.repo</div><div class="line">│       ├── handlers</div><div class="line">│       │   └── main.yml</div><div class="line">│       ├── tasks</div><div class="line">│       │   └── main.yml</div><div class="line">│       ├── templates</div><div class="line">│       │   └── my.cnf.j2</div><div class="line">│       └── vars</div><div class="line">│           └── main.yml</div><div class="line">└── site.yml</div><div class="line"></div><div class="line">7 directories, 8 files</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h2 id="Ansible之安装mysql"><a href="#Ansible之安装mysql" class="headerlink" title="Ansible之安装mysql"></a>Ansible之安装mysql</h2><p>环境：<br>　　　ansible 2.2.1.0<br>　　　Centos 6.6<br>　　　Mysql 5.5.54</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#入口文件</span></div><div class="line">[root@Ansible ~]<span class="comment"># cd /etc/ansible/</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat site.yml </span></div><div class="line">- hosts: test_hosts</div><div class="line">  user: root</div><div class="line">  roles:</div><div class="line">    - yum_mysql</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#tasks文件</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat roles/yum_mysql/tasks/main.yml </span></div><div class="line">- name: Install libselinux-python package</div><div class="line">  yum: name=libselinux-python state=installed</div><div class="line"></div><div class="line">- name: Check whether yum.repo file exist</div><div class="line">  shell: ls /etc/yum.repos.d/yum.repo</div><div class="line">  register: result</div><div class="line">  ignore_errors: True</div><div class="line">- name: Copy yum.repo file</div><div class="line">  copy: src=yum.repo dest=/etc/yum.repos.d/ mode=0644 owner=root group=root</div><div class="line">  when: result|failed</div><div class="line">- name: Rebuild the yum cache</div><div class="line">  shell: yum clean all &amp;&amp; yum makecache</div><div class="line">  when: result|failed</div><div class="line"></div><div class="line">- name: Install Mysql Packages</div><div class="line">  yum: name=&#123;&#123;item.name&#125;&#125; state=&#123;&#123;item.state|default(<span class="string">"installed"</span>)&#125;&#125;</div><div class="line">  with_items:</div><div class="line">    - name: <span class="string">"mysql*"</span></div><div class="line">      state: <span class="string">"absent"</span></div><div class="line">    - name: <span class="string">"mysql.x86_64"</span></div><div class="line">    - name: <span class="string">"mysql-devel.x86_64"</span></div><div class="line">    - name: <span class="string">"mysql-server.x86_64"</span></div><div class="line">- name: Configure Mysql file</div><div class="line">  template: src=<span class="string">"templates/my.cnf.j2"</span> dest=<span class="string">"/etc/my.cnf"</span> owner=root group=root mode=0644</div><div class="line">  notify: restart mysql</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#handlers</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat roles/yum_mysql/handlers/main.yml </span></div><div class="line">- name: restart mysql</div><div class="line">  service: name=mysqld state=restarted enabled=yes</div><div class="line">  notify: <span class="string">"Set the mysql database password"</span></div><div class="line">- name: Set the mysql database password</div><div class="line">  shell: /usr/bin/mysqladmin -u root password <span class="string">'123456'</span></div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#变量</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat roles/yum_mysql/vars/main.yml </span></div><div class="line">data_dir: /var/lib/mysql</div><div class="line">socket_dir: /var/lib/mysql/mysql.sock</div><div class="line">mysql_user: mysql</div><div class="line">log_error_dir: /var/<span class="built_in">log</span>/mysqld.log</div><div class="line">pid_dir: /var/run/mysqld/mysqld.pid</div><div class="line">port: 3306</div><div class="line">log_bin: mysql_bin</div><div class="line">binlog_format: mixed</div><div class="line">server_id: 1</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#执行过程</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible-playbook /etc/ansible/site.yml </span></div><div class="line"></div><div class="line">PLAY [test_hosts] **************************************************************</div><div class="line"></div><div class="line">TASK [setup] *******************************************************************</div><div class="line">ok: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_mysql : Install libselinux-python package] ***************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_mysql : Check whether yum.repo file exist] ***************************</div><div class="line">fatal: [192.168.31.110]: FAILED! =&gt; &#123;<span class="string">"changed"</span>: <span class="literal">true</span>, <span class="string">"cmd"</span>: <span class="string">"ls /etc/yum.repos.d/yum.repo"</span>, <span class="string">"delta"</span>: <span class="string">"0:00:00.004198"</span>, <span class="string">"end"</span>: <span class="string">"2017-03-19 21:22:56.861926"</span>, <span class="string">"failed"</span>: <span class="literal">true</span>, <span class="string">"rc"</span>: 2, <span class="string">"start"</span>: <span class="string">"2017-03-19 21:22:56.857728"</span>, <span class="string">"stderr"</span>: <span class="string">"ls: cannot access /etc/yum.repos.d/yum.repo: No such file or directory"</span>, <span class="string">"stdout"</span>: <span class="string">""</span>, <span class="string">"stdout_lines"</span>: [], <span class="string">"warnings"</span>: []&#125;</div><div class="line">...ignoring</div><div class="line"></div><div class="line">TASK [yum_mysql : Copy yum.repo file] ******************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_mysql : Rebuild the yum cache] ***************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"> [WARNING]: Consider using yum module rather than running yum</div><div class="line"></div><div class="line"></div><div class="line">TASK [yum_mysql : Install Mysql Packages] **************************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'state'</span>: u<span class="string">'absent'</span>, u<span class="string">'name'</span>: u<span class="string">'mysql*'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'mysql.x86_64'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'mysql-devel.x86_64'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'mysql-server.x86_64'</span>&#125;)</div><div class="line"></div><div class="line">TASK [yum_mysql : Configure Mysql file] ****************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">RUNNING HANDLER [yum_mysql : restart mysql] ************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">RUNNING HANDLER [yum_mysql : Set the mysql database password] ******************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">PLAY RECAP *********************************************************************</div><div class="line">192.168.31.110             : ok=9    changed=8    unreachable=0    failed=0   </div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m shell -a 'netstat -tunlp | grep 3306'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">tcp        0      0 0.0.0.0:3306                0.0.0.0:*                   LISTEN      2086/mysqld         </div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p><img src="http://note.youdao.com/yws/api/personal/file/033A818FA06C4C438C94678F41FCF2A8?method=download&amp;shareKey=4ede3267cc0b52bd9910fb50efc511a1" alt="image">  </p>
<p>附件：<a href="http://note.youdao.com/yws/api/personal/file/0E0DBA17682F4CF3A42A64675C1198A4?method=download&amp;shareKey=7820632c487fc34e0cf892d0b9dddc55" target="_blank" rel="external">ansible_yum_install_mysql.tar.gz</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/03/16/Ansible-Playbooks之安装Mysql/">http://www.yfshare.vip/2017/03/16/Ansible-Playbooks之安装Mysql/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Ansible Template处理含特殊字符的文件]]></title>
      <url>http://www.yfshare.vip/2017/03/16/Ansible%20Template%E5%A4%84%E7%90%86%E5%90%AB%E7%89%B9%E6%AE%8A%E5%AD%97%E7%AC%A6%E7%9A%84%E6%96%87%E4%BB%B6/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>Ansible Template模块推送文件时，当遇到含有特殊字符的配置文件，如：”;” “#”等，如果不加处理，在执行Ansible-playbooks时会报错，因为这些模块不能被正确解析，如下图所示：<br><a id="more"></a><br><img src="http://note.youdao.com/yws/api/personal/file/28574AC5961C438A82BD5C9D5F0DEA6F?method=download&amp;shareKey=d20001a1397d3ef28cc8717f156ae8ec" alt="image">  </p>
<h2 id="解决办法一"><a href="#解决办法一" class="headerlink" title="解决办法一"></a>解决办法一</h2><p>使用jinja2的Comments，注释掉那些特殊字符，语法：“”，参考：<a href="http://jinja.pocoo.org/docs/2.9/templates/#comments" target="_blank" rel="external">http://jinja.pocoo.org/docs/2.9/templates/#comments</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sed -i <span class="string">'/^;/s/^;/&#123;#;/g'</span> www.conf.j2</div><div class="line">sed -i <span class="string">'/^&#123;#/s/$/#&#125;/g'</span> www.conf.j2</div></pre></td></tr></table></figure></p>
<p>Jinja2分隔符配置如下：<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;% ... %&#125; for Statements</div><div class="line">&#123;&#123; ... &#125;&#125; for Expressions</div><div class="line">&#123;# ... #&#125; for Comments</div><div class="line"># ... ## for Line Statements</div></pre></td></tr></table></figure></p>
<p>参考：<br><a href="http://jinja.pocoo.org/docs/2.9/templates/#list-of-control-structures" target="_blank" rel="external">Statements</a><br><a href="http://jinja.pocoo.org/docs/2.9/templates/#expressions" target="_blank" rel="external">Expressions</a> to print to the template output<br><a href="http://jinja.pocoo.org/docs/2.9/templates/#comments" target="_blank" rel="external">Comments</a> not included in the template output<br><a href="http://jinja.pocoo.org/docs/2.9/templates/#line-statements" target="_blank" rel="external">Line Statements</a></p>
<p>效果图：<br><img src="http://note.youdao.com/yws/api/personal/file/51BAF10EBF3D4355943E9ACFECA5B9F8?method=download&amp;shareKey=32d4520faea8ab17a302998120552bc6" alt="image"><br><img src="http://note.youdao.com/yws/api/personal/file/C2B5E663959A44B5AB4320C4E8172D73?method=download&amp;shareKey=6d22de4ba9bfab8692c051448501ea71" alt="image">  </p>
<h2 id="解决办法二"><a href="#解决办法二" class="headerlink" title="解决办法二"></a>解决办法二</h2><p>使用jinja2的Escaping，把这些特殊字符转义，语法：“ ... ”，参考：<a href="http://jinja.pocoo.org/docs/2.9/templates/#escaping" target="_blank" rel="external">http://jinja.pocoo.org/docs/2.9/templates/#escaping</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sed -i <span class="string">'/^;/s/^;/&#123;% raw %&#125;;/g'</span> www.conf.j2</div><div class="line">sed -i <span class="string">'/^&#123;% raw %&#125;/s/$/&#123;% endraw %&#125;\n/g'</span> www.conf.j2</div></pre></td></tr></table></figure></p>
<p>Jinja2转义符：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">#被raw包含起来的部分被转义，不会被解析</div><div class="line">&#123;% raw %&#125;</div><div class="line">;aaa</div><div class="line">#bbb</div><div class="line">&#123;% endraw %&#125;</div></pre></td></tr></table></figure></p>
<p>效果图：<br><img src="http://note.youdao.com/yws/api/personal/file/126EB155FA6449EDB258833E0F27D85C?method=download&amp;shareKey=220f4e2a393cb1b04dbade233e0e26ad" alt="image"><br><img src="http://note.youdao.com/yws/api/personal/file/B452A096237B456387B5B6FFF734C3BB?method=download&amp;shareKey=b997881e55fa03ad69d78ea8df53a5c8" alt="image">  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/03/16/Ansible">http://www.yfshare.vip/2017/03/16/Ansible</a> Template处理含特殊字符的文件/</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Ansible-Playbooks之安装PHP]]></title>
      <url>http://www.yfshare.vip/2017/03/15/Ansible-Playbooks%E4%B9%8B%E5%AE%89%E8%A3%85PHP/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>playbooks 是一种简单的配置管理系统与多机器部署系统的基础。与现有的其他系统有不同之处,且非常适合于复杂应用的批量部署<br>Playbooks 的格式是YAML，语法做到最小化  </p>
<p>这里讲述的是使用ansible-playbooks的roles安装PHP应用<br><a id="more"></a></p>
<h2 id="结构目录"><a href="#结构目录" class="headerlink" title="结构目录"></a>结构目录</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#目录结构</span></div><div class="line">[root@Ansible ~]<span class="comment"># tree /etc/ansible/</span></div><div class="line">/etc/ansible/</div><div class="line">├── ansible.cfg</div><div class="line">├── hosts</div><div class="line">├── roles</div><div class="line">│   └── yum_php</div><div class="line">│       ├── files</div><div class="line">│       │   └── yum.repo</div><div class="line">│       ├── handlers</div><div class="line">│       │   └── main.yml</div><div class="line">│       ├── tasks</div><div class="line">│       │   └── main.yml</div><div class="line">│       ├── templates</div><div class="line">│       │   └── www.conf.j2</div><div class="line">│       └── vars</div><div class="line">│           └── main.yml</div><div class="line">└── site.yml</div><div class="line"></div><div class="line">7 directories, 8 files</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h2 id="Ansible之Yum安装PHP"><a href="#Ansible之Yum安装PHP" class="headerlink" title="Ansible之Yum安装PHP"></a>Ansible之Yum安装PHP</h2><p>环境：<br>　　　ansible 2.2.1.0<br>　　　Centos 6.6<br>　　　PHP 7.0.16 (fpm-fcgi) (built: Feb 18 2017 10:46:38)  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#入口文件</span></div><div class="line">[root@Ansible ~]<span class="comment"># cd /etc/ansible/</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat site.yml </span></div><div class="line">- hosts: test_hosts</div><div class="line">  user: root</div><div class="line">  roles:</div><div class="line">    - yum_php</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#tasks</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat roles/yum_php/tasks/main.yml </span></div><div class="line">- name: Install libselinux-python package</div><div class="line">  yum: name=libselinux-python state=installed</div><div class="line"></div><div class="line">- name: Check whether yum.repo file exist</div><div class="line">  shell: ls /etc/yum.repos.d/yum.repo</div><div class="line">  register: result</div><div class="line">  ignore_errors: True</div><div class="line">- name: Copy yum.repo file</div><div class="line">  copy: src=yum.repo dest=/etc/yum.repos.d/ mode=0644 owner=root group=root</div><div class="line">  when: result|failed</div><div class="line">- name: Rebuild the yum cache</div><div class="line">  shell: yum clean all &amp;&amp; yum makecache</div><div class="line">  when: result|failed</div><div class="line"></div><div class="line">- name: Check whether nginx users exist</div><div class="line">  shell: id nginx</div><div class="line">  register: result</div><div class="line">  ignore_errors: True</div><div class="line">- name: The nginx user does not exist, so we need to create it.[The nginx user<span class="string">'s password is 123456]</span></div><div class="line">  user: name=nginx createhome=yes home=/home/nginx shell=/bin/bash password="$1$K28XAyId$YUKHvYzbbO9C8RkzGIzNo1" state=present</div><div class="line">  when: result|failed</div><div class="line"></div><div class="line">- name: Install PHP packages</div><div class="line">  yum: name=&#123;&#123;item.name&#125;&#125; state=&#123;&#123;item.state|default("installed")&#125;&#125;</div><div class="line">  with_items:</div><div class="line">    - name: "php*"</div><div class="line">      state: "absent"</div><div class="line">    - name: "php70w"</div><div class="line">    - name: "php70w-gd"</div><div class="line">    - name: "libjpeg*"</div><div class="line">    - name: "php70w-imap"</div><div class="line">    - name: "php70w-ldap"</div><div class="line">    - name: "php70w-odbc"</div><div class="line">    - name: "php70w-pear"</div><div class="line">    - name: "php70w-xml"</div><div class="line">    - name: "php70w-xmlrpc"</div><div class="line">    - name: "php70w-mbstring"</div><div class="line">    - name: "php70w-mcrypt"</div><div class="line">    - name: "php70w-bcmath"</div><div class="line">    - name: "libmcrypt"</div><div class="line">    - name: "libmcrypt-devel"</div><div class="line">    - name: "php70w-fpm"</div><div class="line">    - name: "php70w-cli"</div><div class="line">    - name: "php70w-pdo"</div><div class="line">    - name: "php70w-tidy"</div><div class="line">    - name: "php70w-mysql"</div><div class="line">- name: Configure PHP</div><div class="line">  template: src="templates/www.conf.j2" dest="/etc/php-fpm.d/www.conf" owner=root group=root mode=0644</div><div class="line">- name: Modify file permissions</div><div class="line">  file: path="&#123;&#123;item.path&#125;&#125;" state="&#123;&#123;item.state|default("directory")&#125;&#125;" owner=&#123;&#123;php_user&#125;&#125; group=&#123;&#123;php_group&#125;&#125;</div><div class="line">  with_items:</div><div class="line">    - path: "/etc/httpd/conf.d/php.conf"</div><div class="line">      state: "file"</div><div class="line">    - path: "/var/lib/php/session"</div><div class="line">    - path: "/var/lib/php/wsdlcache"</div><div class="line">  notify: restart php-fpm</div><div class="line">[root@Ansible ansible]#</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#handlers</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat roles/yum_php/handlers/main.yml </span></div><div class="line">- name: restart php-fpm</div><div class="line">  service: name=<span class="string">"php-fpm"</span> state=restarted enabled=yes</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#执行结果</span></div><div class="line">root@Ansible ~]<span class="comment"># ansible-playbook /etc/ansible/site.yml </span></div><div class="line"></div><div class="line">PLAY [test_hosts] **************************************************************</div><div class="line"></div><div class="line">TASK [setup] *******************************************************************</div><div class="line">ok: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_php : Install libselinux-python package] *****************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_php : Check whether yum.repo file exist] *****************************</div><div class="line">fatal: [192.168.31.110]: FAILED! =&gt; &#123;<span class="string">"changed"</span>: <span class="literal">true</span>, <span class="string">"cmd"</span>: <span class="string">"ls /etc/yum.repos.d/yum.repo"</span>, <span class="string">"delta"</span>: <span class="string">"0:00:00.004034"</span>, <span class="string">"end"</span>: <span class="string">"2017-03-20 10:01:53.732814"</span>, <span class="string">"failed"</span>: <span class="literal">true</span>, <span class="string">"rc"</span>: 2, <span class="string">"start"</span>: <span class="string">"2017-03-20 10:01:53.728780"</span>, <span class="string">"stderr"</span>: <span class="string">"ls: cannot access /etc/yum.repos.d/yum.repo: No such file or directory"</span>, <span class="string">"stdout"</span>: <span class="string">""</span>, <span class="string">"stdout_lines"</span>: [], <span class="string">"warnings"</span>: []&#125;</div><div class="line">...ignoring</div><div class="line"></div><div class="line">TASK [yum_php : Copy yum.repo file] ********************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_php : Rebuild the yum cache] *****************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"> [WARNING]: Consider using yum module rather than running yum</div><div class="line"></div><div class="line"></div><div class="line">TASK [yum_php : Check whether nginx users exist] *******************************</div><div class="line">fatal: [192.168.31.110]: FAILED! =&gt; &#123;<span class="string">"changed"</span>: <span class="literal">true</span>, <span class="string">"cmd"</span>: <span class="string">"id nginx"</span>, <span class="string">"delta"</span>: <span class="string">"0:00:00.004049"</span>, <span class="string">"end"</span>: <span class="string">"2017-03-20 10:06:02.226964"</span>, <span class="string">"failed"</span>: <span class="literal">true</span>, <span class="string">"rc"</span>: 1, <span class="string">"start"</span>: <span class="string">"2017-03-20 10:06:02.222915"</span>, <span class="string">"stderr"</span>: <span class="string">"id: nginx: No such user"</span>, <span class="string">"stdout"</span>: <span class="string">""</span>, <span class="string">"stdout_lines"</span>: [], <span class="string">"warnings"</span>: []&#125;</div><div class="line">...ignoring</div><div class="line"></div><div class="line">TASK [yum_php : The nginx user does not exist, so we need to create it.[The nginx user<span class="string">'s password is 123456]] ***</span></div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_php : Install PHP packages] ******************************************</div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'state<span class="string">': u'</span>absent<span class="string">', u'</span>name<span class="string">': u'</span>php*<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-gd<span class="string">'&#125;)</span></div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>libjpeg*<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-imap<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-ldap<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-odbc<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-pear<span class="string">'&#125;)</span></div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-xml<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-xmlrpc<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-mbstring<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-mcrypt<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-bcmath<span class="string">'&#125;)</span></div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>libmcrypt<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>libmcrypt-devel<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-fpm<span class="string">'&#125;)</span></div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-cli<span class="string">'&#125;)</span></div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-pdo<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-tidy<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-mysql<span class="string">'&#125;)</span></div><div class="line"></div><div class="line">TASK [yum_php : Configure PHP] *************************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_php : Modify file permissions] ***************************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'path<span class="string">': u'</span>/etc/httpd/conf.d/php.conf<span class="string">', u'</span>state<span class="string">': u'</span>file<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'path<span class="string">': u'</span>/var/lib/php/session<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'path<span class="string">': u'</span>/var/lib/php/wsdlcache<span class="string">'&#125;)</span></div><div class="line"></div><div class="line">RUNNING HANDLER [yum_php : restart php-fpm] ************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">PLAY RECAP *********************************************************************</div><div class="line">192.168.31.110             : ok=11   changed=10   unreachable=0    failed=0   </div><div class="line">[root@Ansible ~]#</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m shell -a 'netstat -tunlp | grep 9000'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">tcp        0      0 127.0.0.1:9000              0.0.0.0:*                   LISTEN      2197/php-fpm        </div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m shell -a 'ps -ef | grep php-fpm | grep -v grep'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">root       2197      1  0 17:22 ?        00:00:00 php-fpm: master process (/etc/php-fpm.conf)</div><div class="line">nginx      2198   2197  0 17:22 ?        00:00:00 php-fpm: pool www            </div><div class="line">nginx      2199   2197  0 17:22 ?        00:00:00 php-fpm: pool www            </div><div class="line">nginx      2200   2197  0 17:22 ?        00:00:00 php-fpm: pool www            </div><div class="line">nginx      2201   2197  0 17:22 ?        00:00:00 php-fpm: pool www            </div><div class="line">nginx      2203   2197  0 17:22 ?        00:00:00 php-fpm: pool www            </div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p><img src="http://note.youdao.com/yws/api/personal/file/88454320448641189B9E3A30BEC4302D?method=download&amp;shareKey=7eb73e965ae38963c70873cf17a2cadd" alt="image">  </p>
<h2 id="Template遇到特殊字符处理"><a href="#Template遇到特殊字符处理" class="headerlink" title="Template遇到特殊字符处理"></a>Template遇到特殊字符处理</h2><p>注：如果推送的配置文件里含有特殊字符，如：”;” “#”等，是不能用Template模块直接推送的，因为这些不能被解析会报错，如下：<br><img src="http://note.youdao.com/yws/api/personal/file/28574AC5961C438A82BD5C9D5F0DEA6F?method=download&amp;shareKey=d20001a1397d3ef28cc8717f156ae8ec" alt="image">  </p>
<h2 id="解决办法一"><a href="#解决办法一" class="headerlink" title="解决办法一"></a>解决办法一</h2><p>使用jinja2的Comments，注释掉那些特殊字符，语法：“”，参考：<a href="http://jinja.pocoo.org/docs/2.9/templates/#comments" target="_blank" rel="external">http://jinja.pocoo.org/docs/2.9/templates/#comments</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sed -i <span class="string">'/^;/s/^;/&#123;#;/g'</span> www.conf.j2</div><div class="line">sed -i <span class="string">'/^&#123;#/s/$/#&#125;/g'</span> www.conf.j2</div></pre></td></tr></table></figure></p>
<p>Jinja2分隔符配置如下：<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;% ... %&#125; for Statements</div><div class="line">&#123;&#123; ... &#125;&#125; for Expressions</div><div class="line">&#123;# ... #&#125; for Comments</div><div class="line"># ... ## for Line Statements</div></pre></td></tr></table></figure></p>
<p>参考：<br><a href="http://jinja.pocoo.org/docs/2.9/templates/#list-of-control-structures" target="_blank" rel="external">Statements</a><br><a href="http://jinja.pocoo.org/docs/2.9/templates/#expressions" target="_blank" rel="external">Expressions</a> to print to the template output<br><a href="http://jinja.pocoo.org/docs/2.9/templates/#comments" target="_blank" rel="external">Comments</a> not included in the template output<br><a href="http://jinja.pocoo.org/docs/2.9/templates/#line-statements" target="_blank" rel="external">Line Statements</a></p>
<p>效果图：<br><img src="http://note.youdao.com/yws/api/personal/file/51BAF10EBF3D4355943E9ACFECA5B9F8?method=download&amp;shareKey=32d4520faea8ab17a302998120552bc6" alt="image"><br><img src="http://note.youdao.com/yws/api/personal/file/C2B5E663959A44B5AB4320C4E8172D73?method=download&amp;shareKey=6d22de4ba9bfab8692c051448501ea71" alt="image">  </p>
<h2 id="解决办法二"><a href="#解决办法二" class="headerlink" title="解决办法二"></a>解决办法二</h2><p>使用jinja2的Escaping，把这些特殊字符转义，语法：“ ... ”，参考：<a href="http://jinja.pocoo.org/docs/2.9/templates/#escaping" target="_blank" rel="external">http://jinja.pocoo.org/docs/2.9/templates/#escaping</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sed -i <span class="string">'/^;/s/^;/&#123;% raw %&#125;;/g'</span> www.conf.j2</div><div class="line">sed -i <span class="string">'/^&#123;% raw %&#125;/s/$/&#123;% endraw %&#125;\n/g'</span> www.conf.j2</div></pre></td></tr></table></figure></p>
<p>Jinja2转义符：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">#被raw包含起来的部分被转义，不会被解析</div><div class="line">&#123;% raw %&#125;</div><div class="line">;aaa</div><div class="line">#bbb</div><div class="line">&#123;% endraw %&#125;</div></pre></td></tr></table></figure></p>
<p>效果图：<br><img src="http://note.youdao.com/yws/api/personal/file/126EB155FA6449EDB258833E0F27D85C?method=download&amp;shareKey=220f4e2a393cb1b04dbade233e0e26ad" alt="image"><br><img src="http://note.youdao.com/yws/api/personal/file/B452A096237B456387B5B6FFF734C3BB?method=download&amp;shareKey=b997881e55fa03ad69d78ea8df53a5c8" alt="image">  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/8A2FEEE468F34A9CB9F450053DDFD6D6?method=download&amp;shareKey=b18545e048a05feac1536a89b7b897a8" alt="image"></p>
<p>附件：<a href="http://note.youdao.com/yws/api/personal/file/2AD3956E5411473FA5564F584B6B4D30?method=download&amp;shareKey=1c3b772f10c30b6894f116d843676f39" target="_blank" rel="external">ansible_yum_install_php.tar.gz</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/03/15/Ansible-Playbooks之安装PHP/">http://www.yfshare.vip/2017/03/15/Ansible-Playbooks之安装PHP/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Ansible-Playbooks之安装Nginx]]></title>
      <url>http://www.yfshare.vip/2017/03/11/Ansible-Playbooks%E4%B9%8B%E5%AE%89%E8%A3%85Nginx/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>playbooks 是一种简单的配置管理系统与多机器部署系统的基础。与现有的其他系统有不同之处,且非常适合于复杂应用的批量部署<br>Playbooks 的格式是YAML，语法做到最小化  </p>
<p>这里讲述的是使用ansible-playbooks的roles安装Nginx应用<br><a id="more"></a></p>
<h2 id="结构目录"><a href="#结构目录" class="headerlink" title="结构目录"></a>结构目录</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#结构目录</span></div><div class="line">[root@Ansible ansible]<span class="comment"># tree /etc/ansible/</span></div><div class="line">/etc/ansible/</div><div class="line">├── ansible.cfg</div><div class="line">├── hosts</div><div class="line">├── roles</div><div class="line">│   ├── source_nginx</div><div class="line">│   │   ├── files</div><div class="line">│   │   │   ├── <span class="built_in">echo</span>-nginx-module-0.59.tar.gz</div><div class="line">│   │   │   ├── gperftools-2.0.zip</div><div class="line">│   │   │   ├── nginx-1.11.7.tar.gz</div><div class="line">│   │   │   ├── nginx_tcp_proxy_module_nginx1.11.7.zip</div><div class="line">│   │   │   ├── nginx-upstream-jvm-route-nginx1.11.7.zip</div><div class="line">│   │   │   ├── ngx_cache_purge-2.3.tar.gz</div><div class="line">│   │   │   ├── openssl-1.1.0e.tar.gz</div><div class="line">│   │   │   ├── pcre-8.40.zip</div><div class="line">│   │   │   ├── yum.repo</div><div class="line">│   │   │   └── zlib-1.2.11.tar.gz</div><div class="line">│   │   ├── handlers</div><div class="line">│   │   │   └── main.yml</div><div class="line">│   │   ├── tasks</div><div class="line">│   │   │   └── main.yml</div><div class="line">│   │   ├── templates</div><div class="line">│   │   │   ├── comm.conf.j2</div><div class="line">│   │   │   ├── etc_init.d_nginx.txt</div><div class="line">│   │   │   ├── fastcgi.conf.j2</div><div class="line">│   │   │   ├── nginx.conf.j2</div><div class="line">│   │   │   ├── proxy.conf.j2</div><div class="line">│   │   │   └── static.conf.j2</div><div class="line">│   │   └── vars</div><div class="line">│   │       └── main.yml</div><div class="line">│   └── yum_nginx</div><div class="line">│       ├── files</div><div class="line">│       │   ├── comm.conf.j2</div><div class="line">│       │   ├── fastcgi.conf.j2</div><div class="line">│       │   ├── nginx.conf.j2</div><div class="line">│       │   ├── proxy.conf.j2</div><div class="line">│       │   ├── static.conf.j2</div><div class="line">│       │   └── yum.repo</div><div class="line">│       ├── handlers</div><div class="line">│       │   └── main.yml</div><div class="line">│       ├── tasks</div><div class="line">│       │   └── main.yml</div><div class="line">│       ├── templates</div><div class="line">│       └── vars</div><div class="line">│           └── main.yml</div><div class="line">└── site.yml</div><div class="line"></div><div class="line">13 directories, 31 files</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h2 id="Ansible之Yum安装Nginx"><a href="#Ansible之Yum安装Nginx" class="headerlink" title="Ansible之Yum安装Nginx"></a>Ansible之Yum安装Nginx</h2><p>环境：<br>　　　ansible 2.2.1.0<br>　　　Centos 6.6<br>　　　Nginx 1.11.7<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#结构目录</span></div><div class="line">[root@Ansible ansible]<span class="comment"># tree roles/yum_nginx/</span></div><div class="line">roles/yum_nginx/</div><div class="line">├── files</div><div class="line">│   ├── comm.conf.j2</div><div class="line">│   ├── fastcgi.conf.j2</div><div class="line">│   ├── nginx.conf.j2</div><div class="line">│   ├── proxy.conf.j2</div><div class="line">│   ├── static.conf.j2</div><div class="line">│   └── yum.repo</div><div class="line">├── handlers</div><div class="line">│   └── main.yml</div><div class="line">├── tasks</div><div class="line">│   └── main.yml</div><div class="line">├── templates</div><div class="line">└── vars</div><div class="line">    └── main.yml</div><div class="line"></div><div class="line">5 directories, 9 files</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#入口文件</span></div><div class="line">[root@Ansible ~]<span class="comment"># cd /etc/ansible/</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat site.yml </span></div><div class="line">- hosts: test_hosts</div><div class="line">  user: root</div><div class="line">  roles:</div><div class="line">    - yum_nginx</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#变量</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat roles/yum_nginx/vars/main.yml</span></div><div class="line">error_log_path: /var/<span class="built_in">log</span>/nginx/error.log</div><div class="line">error_log_level: warn</div><div class="line">access_log_path: /var/<span class="built_in">log</span>/nginx/access.log</div><div class="line">nginx_pid_path: /var/run/nginx.pid</div><div class="line">worker_connections_size: 10240</div><div class="line">keys_zone: one_cache</div><div class="line">keys_zone_size: 1024m</div><div class="line">inactive_day: 1d</div><div class="line">max_size: 10g</div><div class="line"></div><div class="line">proxy_cache_path: /var/proxy_cache</div><div class="line">nginx_log_path: /var/<span class="built_in">log</span>/nginx</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#tasks文件</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat roles/yum_nginx/tasks/main.yml </span></div><div class="line">- name: disabled iptables</div><div class="line">  service: name=iptables state=stopped</div><div class="line">- name: Set the selinux value to Permissive</div><div class="line">  shell: setenforce 0</div><div class="line"></div><div class="line">- name: Install libselinux-python package</div><div class="line">  yum: name=libselinux-python state=installed</div><div class="line"></div><div class="line">- name: Check whether yum.repo file exist</div><div class="line">  shell: ls /etc/yum.repos.d/yum.repo</div><div class="line">  register: result</div><div class="line">  ignore_errors: True</div><div class="line">- name: Copy yum.repo file</div><div class="line">  copy: src=yum.repo dest=/etc/yum.repos.d/ mode=0644 owner=root group=root</div><div class="line">  when: result|failed</div><div class="line">- name: Rebuild the yum cache</div><div class="line">  shell: yum clean all &amp;&amp; yum makecache</div><div class="line">  when: result|failed</div><div class="line"></div><div class="line">- name: Install nginx package</div><div class="line">  yum: name=nginx state=&#123;&#123;item.state&#125;&#125;</div><div class="line">  with_items:</div><div class="line">    - state: <span class="string">"absent"</span></div><div class="line">    - state: <span class="string">"installed"</span></div><div class="line">- name: <span class="built_in">set</span> nginx parameter</div><div class="line">  set_fact: worker_processes=<span class="string">"&#123;&#123;ansible_processor_cores&#125;&#125;"</span></div><div class="line"></div><div class="line">- name: Configure some files</div><div class="line">  template: src=&#123;&#123;item.src&#125;&#125; dest=&#123;&#123;item.dest&#125;&#125; owner=nginx group=nginx mode=0644</div><div class="line">  with_items:</div><div class="line">    - src: <span class="string">"files/nginx.conf.j2"</span></div><div class="line">      dest: <span class="string">"/etc/nginx/nginx.conf"</span></div><div class="line">    - src: <span class="string">"files/proxy.conf.j2"</span></div><div class="line">      dest: <span class="string">"/etc/nginx/conf.d/proxy.conf"</span></div><div class="line">    - src: <span class="string">"files/comm.conf.j2"</span></div><div class="line">      dest: <span class="string">"/etc/nginx/conf.d/comm.conf"</span></div><div class="line">    - src: <span class="string">"files/static.conf.j2"</span></div><div class="line">      dest: <span class="string">"/etc/nginx/conf.d/static.conf"</span></div><div class="line">    - src: <span class="string">"files/fastcgi.conf.j2"</span></div><div class="line">      dest: <span class="string">"/etc/nginx/conf.d/fastcgi.conf"</span></div><div class="line"></div><div class="line">- name: Create some directory</div><div class="line">  file: path=&#123;&#123;item.path&#125;&#125; state=directory owner=nginx group=nginx mode=0755</div><div class="line">  with_items:</div><div class="line">    - path: <span class="string">"&#123;&#123;proxy_cache_path&#125;&#125;/temp"</span></div><div class="line">    - path: <span class="string">"&#123;&#123;proxy_cache_path&#125;&#125;/cache"</span></div><div class="line">    - path: <span class="string">"&#123;&#123;nginx_log_path&#125;&#125;"</span></div><div class="line">  notify: restart nginx</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#handlers</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat roles/yum_nginx/handlers/main.yml </span></div><div class="line">- name: restart nginx</div><div class="line">  service: name=nginx state=restarted enabled=yes</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#files文件</span></div><div class="line">[root@Ansible ansible]<span class="comment"># ls roles/yum_nginx/files/</span></div><div class="line">comm.conf.j2  fastcgi.conf.j2  nginx.conf.j2  proxy.conf.j2  static.conf.j2  yum.repo</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#执行结果</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible-playbook /etc/ansible/site.yml </span></div><div class="line"></div><div class="line">PLAY [test_hosts] **************************************************************</div><div class="line"></div><div class="line">TASK [setup] *******************************************************************</div><div class="line">ok: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_nginx : disabled iptables] *******************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_nginx : Set the selinux value to Permissive] *************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_nginx : Install libselinux-python package] ***************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_nginx : Check whether yum.repo file exist] ***************************</div><div class="line">fatal: [192.168.31.110]: FAILED! =&gt; &#123;<span class="string">"changed"</span>: <span class="literal">true</span>, <span class="string">"cmd"</span>: <span class="string">"ls /etc/yum.repos.d/yum.repo"</span>, <span class="string">"delta"</span>: <span class="string">"0:00:00.004099"</span>, <span class="string">"end"</span>: <span class="string">"2017-03-19 20:49:37.832598"</span>, <span class="string">"failed"</span>: <span class="literal">true</span>, <span class="string">"rc"</span>: 2, <span class="string">"start"</span>: <span class="string">"2017-03-19 20:49:37.828499"</span>, <span class="string">"stderr"</span>: <span class="string">"ls: cannot access /etc/yum.repos.d/yum.repo: No such file or directory"</span>, <span class="string">"stdout"</span>: <span class="string">""</span>, <span class="string">"stdout_lines"</span>: [], <span class="string">"warnings"</span>: []&#125;</div><div class="line">...ignoring</div><div class="line"></div><div class="line">TASK [yum_nginx : Copy yum.repo file] ******************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_nginx : Rebuild the yum cache] ***************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"> [WARNING]: Consider using yum module rather than running yum</div><div class="line"></div><div class="line"></div><div class="line">TASK [yum_nginx : Install nginx package] ***************************************</div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'state'</span>: u<span class="string">'absent'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'state'</span>: u<span class="string">'installed'</span>&#125;)</div><div class="line"></div><div class="line">TASK [yum_nginx : <span class="built_in">set</span> nginx parameter] *****************************************</div><div class="line">ok: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_nginx : Configure some files] ****************************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/etc/nginx/nginx.conf'</span>, u<span class="string">'src'</span>: u<span class="string">'files/nginx.conf.j2'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/etc/nginx/conf.d/proxy.conf'</span>, u<span class="string">'src'</span>: u<span class="string">'files/proxy.conf.j2'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/etc/nginx/conf.d/comm.conf'</span>, u<span class="string">'src'</span>: u<span class="string">'files/comm.conf.j2'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/etc/nginx/conf.d/static.conf'</span>, u<span class="string">'src'</span>: u<span class="string">'files/static.conf.j2'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/etc/nginx/conf.d/fastcgi.conf'</span>, u<span class="string">'src'</span>: u<span class="string">'files/fastcgi.conf.j2'</span>&#125;)</div><div class="line"></div><div class="line">TASK [yum_nginx : Create some directory] ***************************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'path'</span>: u<span class="string">'/var/proxy_cache/temp'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'path'</span>: u<span class="string">'/var/proxy_cache/cache'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'path'</span>: u<span class="string">'/var/log/nginx'</span>&#125;)</div><div class="line"></div><div class="line">RUNNING HANDLER [yum_nginx : restart nginx] ************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">PLAY RECAP *********************************************************************</div><div class="line">192.168.31.110             : ok=12   changed=10   unreachable=0    failed=0   </div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p><img src="http://note.youdao.com/yws/api/personal/file/F9627F7DD8B043BD975D98B4BC5C20CE?method=download&amp;shareKey=55ec04d11f44dafc5cc94f172fa98c6a" alt="image"><br><img src="http://note.youdao.com/yws/api/personal/file/994FFC90CD3947DE8ED1E8BF19428A63?method=download&amp;shareKey=7e2c02f801b5e0f73c8054dfddbb8474" alt="image">  </p>
<h2 id="Ansible之源码安装Nginx"><a href="#Ansible之源码安装Nginx" class="headerlink" title="Ansible之源码安装Nginx"></a>Ansible之源码安装Nginx</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#结构目录</span></div><div class="line">[root@Ansible ansible]<span class="comment"># tree roles/source_nginx/</span></div><div class="line">roles/source_nginx/</div><div class="line">├── files</div><div class="line">│   ├── <span class="built_in">echo</span>-nginx-module-0.59.tar.gz</div><div class="line">│   ├── gperftools-2.0.zip</div><div class="line">│   ├── nginx-1.11.7.tar.gz</div><div class="line">│   ├── nginx_tcp_proxy_module_nginx1.11.7.zip</div><div class="line">│   ├── nginx-upstream-jvm-route-nginx1.11.7.zip</div><div class="line">│   ├── ngx_cache_purge-2.3.tar.gz</div><div class="line">│   ├── openssl-1.1.0e.tar.gz</div><div class="line">│   ├── pcre-8.40.zip</div><div class="line">│   ├── yum.repo</div><div class="line">│   └── zlib-1.2.11.tar.gz</div><div class="line">├── handlers</div><div class="line">│   └── main.yml</div><div class="line">├── tasks</div><div class="line">│   └── main.yml</div><div class="line">├── templates</div><div class="line">│   ├── comm.conf.j2</div><div class="line">│   ├── etc_init.d_nginx.txt</div><div class="line">│   ├── fastcgi.conf.j2</div><div class="line">│   ├── nginx.conf.j2</div><div class="line">│   ├── proxy.conf.j2</div><div class="line">│   └── static.conf.j2</div><div class="line">└── vars</div><div class="line">    └── main.yml</div><div class="line"></div><div class="line">5 directories, 19 files</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#变量</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat roles/source_nginx/vars/main.yml </span></div><div class="line">nginx_path: /usr/<span class="built_in">local</span>/nginx-1.11.7/sbin/nginx</div><div class="line">nginx_conf_file: /usr/<span class="built_in">local</span>/nginx-1.11.7/conf/nginx.conf</div><div class="line">nginx_conf_dir: /usr/<span class="built_in">local</span>/nginx-1.11.7/conf</div><div class="line"></div><div class="line">error_log_path: /var/<span class="built_in">log</span>/nginx/error.log</div><div class="line">error_log_level: warn</div><div class="line">access_log_path: /var/<span class="built_in">log</span>/nginx/access.log</div><div class="line">nginx_pid_path: /var/run/nginx.pid</div><div class="line">worker_connections_size: 1024</div><div class="line">google_perftools_path: /var/tmp/nginx_profile</div><div class="line">proxy_temp_path: /var/proxy_cache/temp</div><div class="line">proxy_cache_path: /var/proxy_cache/cache</div><div class="line">keys_zone: one_cache</div><div class="line">keys_zone_size: 1024m</div><div class="line">inactive_day: 1d</div><div class="line">max_size: 10g</div><div class="line"></div><div class="line">rewrite_path: http://www.qq.com</div><div class="line">access_zabbix_log_path: /var/<span class="built_in">log</span>/zabbix/access.log</div><div class="line">error_zabbix_log_path: /var/<span class="built_in">log</span>/zabbix/error.log</div><div class="line"></div><div class="line">remote_download_path: /tmp/download</div><div class="line">nginx_install_path: /usr/<span class="built_in">local</span>/nginx-1.11.7</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#tasks</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat roles/source_nginx/tasks/main.yml</span></div><div class="line">- name: disabled iptables</div><div class="line">  shell: /etc/init.d/iptables stop</div><div class="line">- name: Set the selinux value to Permissive</div><div class="line">  shell: setenforce 0</div><div class="line"></div><div class="line">- name: Create download directory</div><div class="line">  file: path=&#123;&#123;remote_download_path&#125;&#125; mode=0755 state=directory</div><div class="line">- name: Install the some tools</div><div class="line">  yum: name=&#123;&#123;item.name&#125;&#125; state=installed</div><div class="line">  with_items:</div><div class="line">    - name: unzip</div><div class="line">    - name: zip</div><div class="line">    - name: tar</div><div class="line">    - name: libselinux-python</div><div class="line"></div><div class="line">- name: download some <span class="built_in">source</span> packages</div><div class="line">  get_url: url=&#123;&#123;item.url&#125;&#125; dest=&#123;&#123;remote_download_path&#125;&#125; validate_certs=&#123;&#123;item.validate_certs|default(<span class="string">"yes"</span>)&#125;&#125;</div><div class="line">  with_items:</div><div class="line">    - url: <span class="string">"https://ftp.pcre.org/pub/pcre/pcre-8.40.zip"</span></div><div class="line">      validate_certs: <span class="string">"no"</span></div><div class="line">    - url: <span class="string">"http://nginx.org/download/nginx-1.11.7.tar.gz"</span></div><div class="line"></div><div class="line">- name: unarchive some <span class="built_in">source</span> packages</div><div class="line">  unarchive: src=&#123;&#123;item.src&#125;&#125; dest=&#123;&#123;remote_download_path&#125;&#125; remote_src=&#123;&#123;item.remote_src|default(<span class="string">"no"</span>)&#125;&#125;</div><div class="line">  with_items: </div><div class="line">    - src: <span class="string">"&#123;&#123;remote_download_path&#125;&#125;/nginx-1.11.7.tar.gz"</span></div><div class="line">      remote_src: <span class="string">"yes"</span></div><div class="line">    - src: <span class="string">"&#123;&#123;remote_download_path&#125;&#125;/pcre-8.40.zip"</span></div><div class="line">      remote_src: <span class="string">"yes"</span></div><div class="line">    - src: <span class="string">"files/zlib-1.2.11.tar.gz"</span></div><div class="line">    - src: <span class="string">"files/openssl-1.1.0e.tar.gz"</span></div><div class="line">    - src: <span class="string">"files/gperftools-2.0.zip"</span></div><div class="line">    - src: <span class="string">"files/echo-nginx-module-0.59.tar.gz"</span></div><div class="line">    - src: <span class="string">"files/nginx-upstream-jvm-route-nginx1.11.7.zip"</span></div><div class="line">    - src: <span class="string">"files/ngx_cache_purge-2.3.tar.gz"</span></div><div class="line"></div><div class="line">- name: Check whether nginx users exist</div><div class="line">  shell: id nginx</div><div class="line">  register: result</div><div class="line">  ignore_errors: True</div><div class="line">- name: The nginx user does not exist, so we need to create it.[The nginx user<span class="string">'s password is 123456]</span></div><div class="line">  user: name=nginx createhome=yes home=/home/nginx shell=/bin/bash password="$1$K28XAyId$YUKHvYzbbO9C8RkzGIzNo1" state=present</div><div class="line">  when: result|failed</div><div class="line"></div><div class="line">- name: Install the pcre-8.40 source package</div><div class="line">  shell: cd &#123;&#123;remote_download_path&#125;&#125;/pcre-8.40/ &amp;&amp; sh ./configure &amp;&amp; make &amp;&amp; make install</div><div class="line">- name: Install the zlib-1.2.11 source package</div><div class="line">  shell: cd &#123;&#123;remote_download_path&#125;&#125;/zlib-1.2.11/ &amp;&amp; sh ./configure &amp;&amp; make &amp;&amp; make install</div><div class="line">- name: Install the openssl-1.1.0e source package</div><div class="line">  shell: cd &#123;&#123;remote_download_path&#125;&#125;/openssl-1.1.0e/ &amp;&amp; sh ./config &amp;&amp; make &amp;&amp; make install</div><div class="line">- name: Install the some devel packages</div><div class="line">  yum: name=&#123;&#123;item.rpm&#125;&#125; state=installed</div><div class="line">  with_items:</div><div class="line">    - rpm: "openssl-devel"</div><div class="line">    - rpm: "pcre-devel"</div><div class="line">    - rpm: "zlib-devel"</div><div class="line">    - rpm: "gcc"</div><div class="line">    - rpm: "gcc-c++"</div><div class="line">    - rpm: "make"</div><div class="line">    - rpm: "perl"</div><div class="line">    - rpm: "perl-devel"</div><div class="line">    - rpm: "perl-ExtUtils-Embed"</div><div class="line">- name: Install the gperftools-2.0 source package</div><div class="line">  shell: cd &#123;&#123;remote_download_path&#125;&#125;/gperftools-2.0/ &amp;&amp; sh ./configure --enable-frame-pointers &amp;&amp; make &amp;&amp; make install &amp;&amp; echo "/usr/local/lib" &gt; /etc/ld.so.conf.d/usr_local_lib.conf &amp;&amp; ldconfig</div><div class="line">- name: Install patch package</div><div class="line">  yum: name=patch state=installed</div><div class="line">- name: Play nginx-upstream-jvm-route patche</div><div class="line">  shell: cd &#123;&#123;remote_download_path&#125;&#125;/nginx-1.11.7/ &amp;&amp; patch -p0 &lt; ../nginx-upstream-jvm-route/jvm_route.patch</div><div class="line">- name: Install the Nginx package</div><div class="line">  shell: cd &#123;&#123;remote_download_path&#125;&#125;/nginx-1.11.7/ &amp;&amp; sh ./configure --prefix=&#123;&#123;nginx_install_path&#125;&#125; --user=nginx --group=nginx --with-http_gzip_static_module --with-http_stub_status_module --with-google_perftools_module --add-module=../echo-nginx-module-0.59 --add-module=../nginx-upstream-jvm-route --with-pcre=../pcre-8.40 --without-http_ssi_module --without-http_autoindex_module --without-mail_pop3_module --without-mail_imap_module --without-mail_smtp_module --add-module=../ngx_cache_purge-2.3 --with-http_ssl_module --with-openssl=../openssl-1.1.0e --with-stream --with-http_mp4_module &amp;&amp; make &amp;&amp; make install</div><div class="line"></div><div class="line">- name: Create some directory</div><div class="line">  file: path=&#123;&#123;item.path&#125;&#125; state=directory mode=&#123;&#123;item.mode|default("0755")&#125;&#125; owner=nginx group=nginx</div><div class="line">  with_items:</div><div class="line">    - path: "/tmp/tcmalloc"</div><div class="line">      mode: "0777"</div><div class="line">    - path: "/var/proxy_cache/temp"</div><div class="line">    - path: "/var/proxy_cache/cache"</div><div class="line">    - path: "/var/log/nginx"</div><div class="line">    - path: "&#123;&#123;nginx_conf_dir&#125;&#125;/vhosts"</div><div class="line"></div><div class="line">- name: set nginx parameter</div><div class="line">  set_fact: worker_processes="&#123;&#123;ansible_processor_cores&#125;&#125;"</div><div class="line">- name: Copy same files</div><div class="line">  template: src=&#123;&#123;item.src&#125;&#125; dest=&#123;&#123;item.dest&#125;&#125; owner=nginx group=nginx mode=&#123;&#123;item.mode|default("0644")&#125;&#125;</div><div class="line">  with_items: </div><div class="line">    - src: "templates/etc_init.d_nginx.txt"</div><div class="line">      dest: "/etc/init.d/nginx"</div><div class="line">      mode: "0755"</div><div class="line">    - src: "templates/nginx.conf.j2"</div><div class="line">      dest: "&#123;&#123;nginx_conf_dir&#125;&#125;/nginx.conf"</div><div class="line">    - src: "templates/proxy.conf.j2"</div><div class="line">      dest: "&#123;&#123;nginx_conf_dir&#125;&#125;/vhosts/proxy.conf"</div><div class="line">    - src: "templates/comm.conf.j2"</div><div class="line">      dest: "&#123;&#123;nginx_conf_dir&#125;&#125;/vhosts/comm.conf"</div><div class="line">    - src: "templates/static.conf.j2"</div><div class="line">      dest: "&#123;&#123;nginx_conf_dir&#125;&#125;/vhosts/static.conf"</div><div class="line">    - src: "templates/fastcgi.conf.j2"</div><div class="line">      dest: "&#123;&#123;nginx_conf_dir&#125;&#125;/vhosts/fastcgi.conf"</div><div class="line">  notify: restart nginx</div><div class="line">[root@Ansible ansible]#</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#handlers</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat roles/source_nginx/handlers/main.yml </span></div><div class="line">- name: restart nginx</div><div class="line">  service: name=nginx state=restarted enabled=yes</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#files</span></div><div class="line">[root@Ansible ansible]<span class="comment"># ls roles/source_nginx/files/</span></div><div class="line"><span class="built_in">echo</span>-nginx-module-0.59.tar.gz  nginx_tcp_proxy_module_nginx1.11.7.zip    openssl-1.1.0e.tar.gz  zlib-1.2.11.tar.gz</div><div class="line">gperftools-2.0.zip             nginx-upstream-jvm-route-nginx1.11.7.zip  pcre-8.40.zip</div><div class="line">nginx-1.11.7.tar.gz            ngx_cache_purge-2.3.tar.gz                yum.repo</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#templates</span></div><div class="line">[root@Ansible ansible]<span class="comment"># ls roles/source_nginx/templates/</span></div><div class="line">comm.conf.j2  etc_init.d_nginx.txt  fastcgi.conf.j2  nginx.conf.j2  proxy.conf.j2  static.conf.j2</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#执行结果</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible-playbook /etc/ansible/site.yml </span></div><div class="line"></div><div class="line">PLAY [test_hosts] **************************************************************</div><div class="line"></div><div class="line">TASK [setup] *******************************************************************</div><div class="line">ok: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : disabled iptables] ****************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Set the selinux value to Permissive] **********************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Create download directory] ********************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Install the some tools] ***********************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'unzip'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'zip'</span>&#125;)</div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'tar'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'libselinux-python'</span>&#125;)</div><div class="line"></div><div class="line">TASK [source_nginx : download some <span class="built_in">source</span> packages] ****************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'url'</span>: u<span class="string">'https://ftp.pcre.org/pub/pcre/pcre-8.40.zip'</span>, u<span class="string">'validate_certs'</span>: u<span class="string">'no'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'url'</span>: u<span class="string">'http://nginx.org/download/nginx-1.11.7.tar.gz'</span>&#125;)</div><div class="line"></div><div class="line">TASK [source_nginx : unarchive some <span class="built_in">source</span> packages] ***************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'src'</span>: u<span class="string">'/tmp/download/nginx-1.11.7.tar.gz'</span>, u<span class="string">'remote_src'</span>: u<span class="string">'yes'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'src'</span>: u<span class="string">'/tmp/download/pcre-8.40.zip'</span>, u<span class="string">'remote_src'</span>: u<span class="string">'yes'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'src'</span>: u<span class="string">'files/zlib-1.2.11.tar.gz'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'src'</span>: u<span class="string">'files/openssl-1.1.0e.tar.gz'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'src'</span>: u<span class="string">'files/gperftools-2.0.zip'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'src'</span>: u<span class="string">'files/echo-nginx-module-0.59.tar.gz'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'src'</span>: u<span class="string">'files/nginx-upstream-jvm-route-nginx1.11.7.zip'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'src'</span>: u<span class="string">'files/ngx_cache_purge-2.3.tar.gz'</span>&#125;)</div><div class="line"></div><div class="line">TASK [source_nginx : Check whether nginx users exist] **************************</div><div class="line">fatal: [192.168.31.110]: FAILED! =&gt; &#123;<span class="string">"changed"</span>: <span class="literal">true</span>, <span class="string">"cmd"</span>: <span class="string">"id nginx"</span>, <span class="string">"delta"</span>: <span class="string">"0:00:00.003932"</span>, <span class="string">"end"</span>: <span class="string">"2017-03-19 20:29:56.963783"</span>, <span class="string">"failed"</span>: <span class="literal">true</span>, <span class="string">"rc"</span>: 1, <span class="string">"start"</span>: <span class="string">"2017-03-19 20:29:56.959851"</span>, <span class="string">"stderr"</span>: <span class="string">"id: nginx: No such user"</span>, <span class="string">"stdout"</span>: <span class="string">""</span>, <span class="string">"stdout_lines"</span>: [], <span class="string">"warnings"</span>: []&#125;</div><div class="line">...ignoring</div><div class="line"></div><div class="line">TASK [source_nginx : The nginx user does not exist, so we need to create it.[The nginx user<span class="string">'s password is 123456]] ***</span></div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Install the pcre-8.40 source package] *********************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Install the zlib-1.2.11 source package] *******************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Install the openssl-1.1.0e source package] ****************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Install the some devel packages] **************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'rpm<span class="string">': u'</span>openssl-devel<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'rpm<span class="string">': u'</span>pcre-devel<span class="string">'&#125;)</span></div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'rpm<span class="string">': u'</span>zlib-devel<span class="string">'&#125;)</span></div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'rpm<span class="string">': u'</span>gcc<span class="string">'&#125;)</span></div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'rpm<span class="string">': u'</span>gcc-c++<span class="string">'&#125;)</span></div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'rpm<span class="string">': u'</span>make<span class="string">'&#125;)</span></div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'rpm<span class="string">': u'</span>perl<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'rpm<span class="string">': u'</span>perl-devel<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'rpm<span class="string">': u'</span>perl-ExtUtils-Embed<span class="string">'&#125;)</span></div><div class="line"></div><div class="line">TASK [source_nginx : Install the gperftools-2.0 source package] ****************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Install patch package] ************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Play nginx-upstream-jvm-route patche] *********************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Install the Nginx package] ********************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Create some directory] ************************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'path<span class="string">': u'</span>/tmp/tcmalloc<span class="string">', u'</span>mode<span class="string">': u'</span>0777<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'path<span class="string">': u'</span>/var/proxy_cache/temp<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'path<span class="string">': u'</span>/var/proxy_cache/cache<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'path<span class="string">': u'</span>/var/<span class="built_in">log</span>/nginx<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'path<span class="string">': u'</span>/usr/<span class="built_in">local</span>/nginx-1.11.7/conf/vhosts<span class="string">'&#125;)</span></div><div class="line"></div><div class="line">TASK [source_nginx : set nginx parameter] **************************************</div><div class="line">ok: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Copy same files] ******************************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'dest<span class="string">': u'</span>/etc/init.d/nginx<span class="string">', u'</span>src<span class="string">': u'</span>templates/etc_init.d_nginx.txt<span class="string">', u'</span>mode<span class="string">': u'</span>0755<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'dest<span class="string">': u'</span>/usr/<span class="built_in">local</span>/nginx-1.11.7/conf/nginx.conf<span class="string">', u'</span>src<span class="string">': u'</span>templates/nginx.conf.j2<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'dest<span class="string">': u'</span>/usr/<span class="built_in">local</span>/nginx-1.11.7/conf/vhosts/proxy.conf<span class="string">', u'</span>src<span class="string">': u'</span>templates/proxy.conf.j2<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'dest<span class="string">': u'</span>/usr/<span class="built_in">local</span>/nginx-1.11.7/conf/vhosts/comm.conf<span class="string">', u'</span>src<span class="string">': u'</span>templates/comm.conf.j2<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'dest<span class="string">': u'</span>/usr/<span class="built_in">local</span>/nginx-1.11.7/conf/vhosts/static.conf<span class="string">', u'</span>src<span class="string">': u'</span>templates/static.conf.j2<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'dest<span class="string">': u'</span>/usr/<span class="built_in">local</span>/nginx-1.11.7/conf/vhosts/fastcgi.conf<span class="string">', u'</span>src<span class="string">': u'</span>templates/fastcgi.conf.j2<span class="string">'&#125;)</span></div><div class="line"></div><div class="line">RUNNING HANDLER [source_nginx : restart nginx] *********************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">PLAY RECAP *********************************************************************</div><div class="line">192.168.31.110             : ok=21   changed=19   unreachable=0    failed=0   </div><div class="line"></div><div class="line">[root@Ansible ~]#</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a '/etc/init.d/nginx status'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">nginx (pid  76973) is running...</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p><img src="http://note.youdao.com/yws/api/personal/file/5F4B8CAE60154D52839B376BFA939C44?method=download&amp;shareKey=803852b9567b3abe6cc336ec5e16294e" alt="image"><br><img src="http://note.youdao.com/yws/api/personal/file/994FFC90CD3947DE8ED1E8BF19428A63?method=download&amp;shareKey=7e2c02f801b5e0f73c8054dfddbb8474" alt="image">  </p>
<p>附件：<a href="http://note.youdao.com/yws/api/personal/file/4BEFB9060722495E8757D94F41FF68DA?method=download&amp;shareKey=a87dc09c478c8fdd5f540b3c6da7d397" target="_blank" rel="external">ansible_install_nginx1.11.7.tar.gz</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/03/11/Ansible-Playbooks之安装Nginx/">http://www.yfshare.vip/2017/03/11/Ansible-Playbooks之安装Nginx/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Mysql备份恢复]]></title>
      <url>http://www.yfshare.vip/2017/03/08/Mysql%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>开启mysql的binlog功能可以有效防止在日常mysql操作过程中因操作失误而导致的数据丢失问题<br>但是，对于DBA来说，第一准则就是<strong>备份重于一切</strong>。<a href="http://www.eygle.com/" target="_blank" rel="external">eygle</a>在DBA<a href="http://www.eygle.com/archives/2006/03/the_four_rule_for_dba.html" target="_blank" rel="external">四大生存法则</a>中也有提到<br><em>我们必需知道,系统总是要崩溃的，没有有效的备份只是等哪一天死！我经常开玩笑的说,唯一会使DBA在梦中惊醒的就是,没有有效的备份.</em><br><a id="more"></a></p>
<h2 id="binlog"><a href="#binlog" class="headerlink" title="binlog"></a>binlog</h2><p>binlog，也称为二进制日志，记录对数据发生或潜在发生更改的SQL语句，并以二进制的形式保存在磁盘中，可以用来查看数据库的变更历史（具体的时间点所有的SQL操作）、数据库增量备份和恢复（增量备份和基于时间点的恢复）、Mysql的复制（主主数据库的复制、主从数据库的复制）</p>
<h2 id="开启binlog"><a href="#开启binlog" class="headerlink" title="开启binlog"></a>开启binlog</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">mysql&gt; show variables like <span class="string">'%log_bin%'</span>;</div><div class="line">+---------------------------------+-------+</div><div class="line">| Variable_name                   | Value |</div><div class="line">+---------------------------------+-------+</div><div class="line">| log_bin                         | ON    |</div><div class="line">| log_bin_trust_function_creators | OFF   |</div><div class="line">| sql_log_bin                     | ON    |</div><div class="line">+---------------------------------+-------+</div><div class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt;</div><div class="line"></div><div class="line">[root@host1 ~]<span class="comment"># grep -i 'bin' /etc/my.cnf | grep -i 'log'</span></div><div class="line">log_bin=mysql_bin</div><div class="line">binlog_format=Mixed</div><div class="line">[root@host1 ~]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@host1 ~]<span class="comment"># /etc/init.d/mysqld restart</span></div><div class="line"></div><div class="line">[root@host1 ~]<span class="comment"># ls /var/lib/mysql | grep 'mysql_bin' | tail -3</span></div><div class="line">mysql_bin.000032</div><div class="line">mysql_bin.000033</div><div class="line">mysql_bin.index</div><div class="line">[root@host1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h2 id="Mysql备份恢复"><a href="#Mysql备份恢复" class="headerlink" title="Mysql备份恢复"></a>Mysql备份恢复</h2><p>环境：Centos 6.6<br>　　　Mysql version： 5.5.54<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#先执行全备操作</span></div><div class="line">[root@host1 ~]<span class="comment"># sh mysql_back.sh </span></div><div class="line">Usage: please input Mysql_Fullbackup|Mysql_Incbackup</div><div class="line"></div><div class="line">[root@host1 ~]<span class="comment"># sh mysql_back.sh Mysql_Fullbackup</span></div><div class="line">Full backup of MySQL database... Please wait.</div><div class="line"></div><div class="line">Mysql database full backup success.</div><div class="line">[root@host1 ~]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@host1 ~]<span class="comment"># tree /backup/mysql_backup/</span></div><div class="line">/backup/mysql_backup/</div><div class="line">├── backup_20170308.log</div><div class="line">├── Full_backup</div><div class="line">│   └── 20170308</div><div class="line">│       ├── all_databases_backup_20170308_17:06:08.sql.gz</div><div class="line">│       └── jack_backup_20170308_17:06:08.sql.gz</div><div class="line">├── Full_backup_time.txt</div><div class="line">├── Inc_backup</div><div class="line">└── mysql_db.txt</div><div class="line"></div><div class="line">3 directories, 5 files</div><div class="line">[root@host1 ~]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@host1 mysql_backup]<span class="comment"># cat backup_20170308.log </span></div><div class="line">[ 2017-03-08 17:06:08 ] - Databases all-databases has been backup successful.</div><div class="line"></div><div class="line">[ 2017-03-08 17:06:08 ] - Databases jack has been backup successful.</div><div class="line">----------------------------------------</div><div class="line"></div><div class="line">[root@host1 mysql_backup]<span class="comment"># cat Full_backup_time.txt </span></div><div class="line">2017-03-08 17:06:08</div><div class="line">[root@host1 mysql_backup]<span class="comment"># cat mysql_db.txt </span></div><div class="line">jack</div><div class="line">[root@host1 mysql_backup]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>向jack库的yfshare表插入几条数据<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">mysql&gt; use jack;</div><div class="line">mysql&gt; select * from yfshare;</div><div class="line">+------+---------+</div><div class="line">| id   | name    |</div><div class="line">+------+---------+</div><div class="line">| 1    | jack    |</div><div class="line">| 2    | yfshare |</div><div class="line">| 3    | tom     |</div><div class="line">| 4    | jerry   |</div><div class="line">| 5    | bob     |</div><div class="line">+------+---------+</div><div class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</div><div class="line">mysql&gt; INSERT INTO yfshare values(6,<span class="string">'aaa'</span>);</div><div class="line">mysql&gt; INSERT INTO yfshare values(7,<span class="string">'bbb'</span>);</div><div class="line">mysql&gt; commit;</div><div class="line">mysql&gt; select * from yfshare;</div><div class="line">+------+---------+</div><div class="line">| id   | name    |</div><div class="line">+------+---------+</div><div class="line">| 1    | jack    |</div><div class="line">| 2    | yfshare |</div><div class="line">| 3    | tom     |</div><div class="line">| 4    | jerry   |</div><div class="line">| 5    | bob     |</div><div class="line">| 6    | aaa     |</div><div class="line">| 7    | bbb     |</div><div class="line">+------+---------+</div><div class="line">7 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt;</div></pre></td></tr></table></figure></p>
<p>然后做增量备份<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@host1 ~]<span class="comment"># sh mysql_back.sh Mysql_Incbackup</span></div><div class="line">Increment backup of MySQL database... Please wait.</div><div class="line"></div><div class="line">Mysql database Increment backup success.</div><div class="line">[root@host1 ~]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@host1 ~]<span class="comment"># tree /backup/mysql_backup/Inc_backup/</span></div><div class="line">/backup/mysql_backup/Inc_backup/</div><div class="line">└── 20170308</div><div class="line">    └── jack_Inc_20170308_17:15:27.zip</div><div class="line"></div><div class="line">1 directory, 1 file</div><div class="line">[root@host1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">再向jack库和yfshare表插入几条数据后，不做备份，假设不小心删除了库jack    </div><div class="line"><span class="code">```</span>bash</div><div class="line">mysql&gt; INSERT INTO yfshare values(8,<span class="emphasis">'ccc'</span>);</div><div class="line">mysql&gt; INSERT INTO yfshare values(9,<span class="emphasis">'ddd'</span>);</div><div class="line">mysql&gt; commit;</div><div class="line"><span class="section">mysql&gt; select * from yfshare;</span></div><div class="line">+------+---------+</div><div class="line"><span class="section">| id   | name    |</span></div><div class="line">+------+---------+</div><div class="line">| 1    | jack    |</div><div class="line">| 2    | yfshare |</div><div class="line">| 3    | tom     |</div><div class="line">| 4    | jerry   |</div><div class="line">| 5    | bob     |</div><div class="line">| 6    | aaa     |</div><div class="line">| 7    | bbb     |</div><div class="line">| 8    | ccc     |</div><div class="line"><span class="section">| 9    | ddd     |</span></div><div class="line">+------+---------+</div><div class="line">9 rows in set (0.00 sec)</div><div class="line">mysql&gt; drop database jack;</div><div class="line">mysql&gt; commit;</div><div class="line">mysql&gt; desc yfshare;</div><div class="line">ERROR 1046 (3D000): No database selected</div><div class="line">mysql&gt; use jack;</div><div class="line">ERROR 1049 (42000): Unknown database <span class="emphasis">'jack'</span></div><div class="line">mysql&gt;</div></pre></td></tr></table></figure>
<p>下面来开始恢复jack库的yfshare表<br>恢复步骤：  </p>
<ol>
<li>恢复jack库的全量备份</li>
<li>恢复jack库的增量备份</li>
<li>通过binlog恢复数据库到删除前</li>
</ol>
<p>恢复思路：先在mysql中新建一个测试库，在测试库导入误删除表所在的库全量增量备份，然后通过binlog恢复到该表删除前一刻，并导入测试库，然后从测试库导出该表的sql，最后导入到正式库<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@host1 mysql_backup]<span class="comment"># mysql -uroot -p123456 jack --one-database &lt; Full_backup/20170308/jack_backup_20170308_17\:06\:08.sql </span></div><div class="line">ERROR 1049 (42000): Unknown database <span class="string">'jack'</span></div><div class="line">[root@host1 mysql_backup]<span class="comment">#</span></div><div class="line"></div><div class="line">这时是因为没有库，所以需要先创建对应的库名，再执行全备恢复操作</div><div class="line">mysql&gt; create database jack;</div><div class="line">mysql&gt; commit;</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#全量备份恢复</span></div><div class="line">[root@host1 mysql_backup]<span class="comment"># gunzip Full_backup/20170308/jack_backup_20170308_17\:06\:08.sql.gz</span></div><div class="line">[root@host1 mysql_backup]<span class="comment"># mysql -uroot -p123456 jack --one-database &lt; Full_backup/20170308/jack_backup_20170308_17\:06\:08.sql</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#增量备份恢复</span></div><div class="line">[root@host1 mysql_backup]<span class="comment"># unzip Inc_backup/20170308/jack_Inc_20170308_17\:15\:27.zip -d Inc_backup/20170308/</span></div><div class="line">[root@host1 mysql_backup]<span class="comment"># mysql -uroot -p123456 jack --one-database &lt; Inc_backup/20170308/jack_Inc_20170308_17\:15\:27.sql</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#先看看恢复的情况</span></div><div class="line">mysql&gt; use jack;</div><div class="line">mysql&gt; show tables;</div><div class="line">+----------------+</div><div class="line">| Tables_in_jack |</div><div class="line">+----------------+</div><div class="line">| aaa            |</div><div class="line">| yfshare        |</div><div class="line">+----------------+</div><div class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; select * from yfshare;</div><div class="line">+------+---------+</div><div class="line">| id   | name    |</div><div class="line">+------+---------+</div><div class="line">| 1    | jack    |</div><div class="line">| 2    | yfshare |</div><div class="line">| 3    | tom     |</div><div class="line">| 4    | jerry   |</div><div class="line">| 5    | bob     |</div><div class="line">| 6    | aaa     |</div><div class="line">| 7    | bbb     |</div><div class="line">+------+---------+</div><div class="line">7 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt;</div></pre></td></tr></table></figure>
<p>现在yfshare表里面只有7条数据，删除前是有9条数据的，而后边的数据没有备份，所以只能通过mysqlbinlog恢复了</p>
<p>增量备份时间是20170308_17:15:27，所以需要把从这个时间点到删除前的操作导出成一个sql文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@host1 mysql_backup]<span class="comment"># tail -3 /var/lib/mysql/mysql_bin.index </span></div><div class="line">./mysql_bin.000031</div><div class="line">./mysql_bin.000032</div><div class="line">./mysql_bin.000033</div><div class="line">[root@host1 mysql_backup]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>binlog的时间格式是：170308 17:15:27<br>mysqlbinlog恢复的时间格式：2017-03-08 17:15:27<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#查找增量备份时记录到了哪个binlog文件</span></div><div class="line"><span class="comment">#因为我们在增量备份文件中记录了备份时间，所以能很快找到是从mysql_bin.000032开始的</span></div><div class="line">[root@host1 tmp]<span class="comment"># mysqlbinlog --no-defaults /var/lib/mysql/mysql_bin.000032 | grep -i '170308 17:15:27'</span></div></pre></td></tr></table></figure></p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#查找删除的时间点</span></div><div class="line"><span class="meta">#可以考虑把所有mysql_bin文件导成sql文件后过滤查找</span></div><div class="line">[root@host1 ~]# mysqlbinlog -d jack /<span class="keyword">var</span>/lib/mysql/mysql_bin<span class="number">.000033</span> &gt; test.sql</div><div class="line"></div><div class="line"><span class="meta">#发现误删除操作的时间是170308 17:18:29</span></div><div class="line"><span class="meta">#170308 17:18:29 server id 1  end_log_pos 602   Query   thread_id=117   exec_time=0     error_code=0</span></div><div class="line">SET TIMESTAMP=<span class="number">1488964709</span><span class="comment">/*!*/</span>;</div><div class="line">DROP TABLE `yfshare` <span class="comment">/* generated by server */</span></div><div class="line"><span class="comment">/*!*/</span>;</div><div class="line"><span class="meta"># at 602</span></div><div class="line"><span class="meta">#170308 17:24:43 server id 1  end_log_pos 683   Query   thread_id=117   exec_time=0     error_code=0</span></div><div class="line">SET TIMESTAMP=<span class="number">1488965083</span><span class="comment">/*!*/</span>;</div><div class="line">drop database jack</div></pre></td></tr></table></figure>
<p>通过查找binlog发现，我们需要恢复的时间是170308 17:18:29<br>这时候我们就可以恢复了<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#因为找到具体的binlog文件和误删除操作时间，所以我们要把期间所有的操作导成一个sql文件，然后恢复</span></div><div class="line">[root<span class="meta">@host1</span> ~]<span class="comment"># mysqlbinlog -d jack --start-datetime="2017-03-08 17:15:27" /var/lib/mysql/mysql_bin.000032 &gt; recover.sql</span></div><div class="line">[root<span class="meta">@host1</span> ~]<span class="comment"># mysqlbinlog -d jack --stop-datetime="2017-03-08 17:18:29" /var/lib/mysql/mysql_bin.000033 &gt;&gt; recover.sql</span></div><div class="line">mysql&gt; use jack;</div><div class="line">mysql&gt; source ~/recover.sql</div><div class="line">mysql&gt; commit;</div><div class="line">mysql&gt; select <span class="symbol">*</span> from yfshare;</div><div class="line">+------+---------+</div><div class="line">|<span class="string"> id   </span>|<span class="string"> name    </span>|</div><div class="line">+------+---------+</div><div class="line">|<span class="string"> 1    </span>|<span class="string"> jack    </span>|</div><div class="line">|<span class="string"> 2    </span>|<span class="string"> yfshare </span>|</div><div class="line">|<span class="string"> 3    </span>|<span class="string"> tom     </span>|</div><div class="line">|<span class="string"> 4    </span>|<span class="string"> jerry   </span>|</div><div class="line">|<span class="string"> 5    </span>|<span class="string"> bob     </span>|</div><div class="line">|<span class="string"> 6    </span>|<span class="string"> aaa     </span>|</div><div class="line">|<span class="string"> 7    </span>|<span class="string"> bbb     </span>|</div><div class="line">|<span class="string"> 8    </span>|<span class="string"> ccc     </span>|</div><div class="line">|<span class="string"> 9    </span>|<span class="string"> ddd     </span>|</div><div class="line">+------+---------+</div><div class="line">9 rows in set (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt;</div></pre></td></tr></table></figure></p>
<p>OK，恢复成功  </p>
<h2 id="Mysql备份恢复脚本"><a href="#Mysql备份恢复脚本" class="headerlink" title="Mysql备份恢复脚本"></a>Mysql备份恢复脚本</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#mysql备份脚本目录结构</span></div><div class="line">[root@host1 ~]<span class="comment"># tree /backup/mysql_backup/</span></div><div class="line">/backup/mysql_backup/</div><div class="line">├── backup_20170308.log</div><div class="line">├── Full_backup</div><div class="line">│   └── 20170308</div><div class="line">│       ├── all_databases_backup_20170308_17:06:08.sql.gz</div><div class="line">│       └── jack_backup_20170308_17:06:08.sql</div><div class="line">├── Full_backup_time.txt</div><div class="line">├── Inc_backup</div><div class="line">│   └── 20170308</div><div class="line">│       ├── jack_Inc_20170308_17:15:27.sql</div><div class="line">│       └── jack_Inc_20170308_17:15:27.zip</div><div class="line">├── mysql_db.txt</div><div class="line">└── mysql_index.txt</div><div class="line"></div><div class="line">4 directories, 8 files</div><div class="line">[root@host1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div></pre></td><td class="code"><pre><div class="line">[root@host1 ~]<span class="comment"># cat mysql_back.sh</span></div><div class="line"><span class="comment">#mysql全量增量备份脚本</span></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="comment"># create user 'mysqlback'@'localhost' identified by '123456';</span></div><div class="line"><span class="comment"># grant select,lock tables,reload,super,file,show view on *.* to 'mysqlback'@'localhost' identified by '123456';</span></div><div class="line"><span class="comment"># flush privileges;</span></div><div class="line"><span class="comment"># \q</span></div><div class="line">DATE=`date <span class="string">'+%Y%m%d'</span>`</div><div class="line">DATE_log=`date <span class="string">'+%Y-%m-%d %H:%M:%S'</span>`</div><div class="line">DATE_filename=`date <span class="string">'+%Y%m%d_%H:%M:%S'</span>`</div><div class="line">DATE_backup_time=`date <span class="string">'+%Y-%m-%d %H:%M:%S'</span>`</div><div class="line"></div><div class="line">mysql_host=<span class="string">"192.168.31.110"</span></div><div class="line">mysql_user=<span class="string">"root"</span></div><div class="line">mysql_pass=<span class="string">"123456"</span></div><div class="line"></div><div class="line">Mysql_Backup=<span class="string">"/backup/mysql_backup"</span></div><div class="line">Full_Backup=<span class="string">"<span class="variable">$Mysql_Backup</span>/Full_backup"</span></div><div class="line">Inc_Backup=<span class="string">"<span class="variable">$Mysql_Backup</span>/Inc_backup"</span></div><div class="line">Mysql_index=<span class="string">"<span class="variable">$Mysql_Backup</span>/mysql_index.txt"</span></div><div class="line"></div><div class="line">Mysql_data=<span class="string">"/var/lib/mysql"</span></div><div class="line">Mysql_bin=<span class="string">"/usr/bin"</span></div><div class="line">Mysql_db=<span class="string">"<span class="variable">$Mysql_Backup</span>/mysql_db.txt"</span></div><div class="line">Mysql_logbin_name=<span class="string">"mysql_bin"</span></div><div class="line">Mysql_binlog=<span class="string">"/usr/bin/mysqlbinlog"</span></div><div class="line"></div><div class="line">MYSQL=<span class="string">"/usr/bin/mysql"</span></div><div class="line">MYSQLDUMP=<span class="string">"/usr/bin/mysqldump"</span></div><div class="line">MYSQLADMIN=<span class="string">"/usr/bin/mysqladmin"</span></div><div class="line">SOCKET=<span class="string">"/var/lib/mysql/mysql.sock"</span></div><div class="line"></div><div class="line">Error_log=<span class="string">"<span class="variable">$Mysql_Backup</span>/backup_error_<span class="variable">$&#123;DATE&#125;</span>.log"</span></div><div class="line">Backup_log=<span class="string">"<span class="variable">$Mysql_Backup</span>/backup_<span class="variable">$&#123;DATE&#125;</span>.log"</span></div><div class="line"></div><div class="line">[ ! <span class="_">-d</span> <span class="string">"<span class="variable">$Mysql_Backup</span>"</span> ] &amp;&amp; mkdir -p <span class="string">"<span class="variable">$Mysql_Backup</span>"</span></div><div class="line">[ ! <span class="_">-d</span> <span class="string">"<span class="variable">$Full_Backup</span>"</span> ] &amp;&amp; mkdir -p <span class="string">"<span class="variable">$Full_Backup</span>"</span></div><div class="line">[ ! <span class="_">-d</span> <span class="string">"<span class="variable">$Inc_Backup</span>"</span> ] &amp;&amp; mkdir -p <span class="string">"<span class="variable">$Inc_Backup</span>"</span></div><div class="line"></div><div class="line"><span class="built_in">cd</span> <span class="variable">$Mysql_Backup</span></div><div class="line"><span class="variable">$MYSQL</span> -u<span class="string">"<span class="variable">$mysql_user</span>"</span> -p<span class="string">"<span class="variable">$mysql_pass</span>"</span> -Ne <span class="string">'show databases'</span> | grep -vw <span class="string">'test'</span> | grep -vw <span class="string">'performance_schema'</span> | grep -vw <span class="string">'information_schema'</span> | grep -vw <span class="string">'mysql'</span> &gt; <span class="variable">$Mysql_db</span></div><div class="line"></div><div class="line"><span class="keyword">function</span> <span class="function"><span class="title">Full</span></span>() &#123;</div><div class="line"><span class="built_in">echo</span> <span class="_">-e</span> <span class="string">'Full backup of MySQL database... Please wait.\n'</span></div><div class="line"><span class="built_in">cd</span> <span class="variable">$Mysql_Backup</span></div><div class="line">[ ! <span class="_">-d</span> <span class="string">"<span class="variable">$Full_Backup</span>"</span>/<span class="string">"<span class="variable">$DATE</span>"</span> ] &amp;&amp; mkdir -p <span class="string">"<span class="variable">$Full_Backup</span>"</span>/<span class="string">"<span class="variable">$DATE</span>"</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$DATE_backup_time</span>"</span> &gt; <span class="string">"<span class="variable">$Mysql_Backup</span>"</span>/Full_backup_time.txt</div><div class="line"></div><div class="line"><span class="comment">#backup all-databases</span></div><div class="line"><span class="variable">$MYSQLDUMP</span> --flush-logs --quick --opt --master-data=2 --tz-utc=<span class="literal">true</span> --ignore-table=mysql.event -u<span class="string">"<span class="variable">$mysql_user</span>"</span> -p<span class="string">"<span class="variable">$mysql_pass</span>"</span> --all-databases | gzip &gt; <span class="string">"<span class="variable">$Full_Backup</span>"</span>/<span class="string">"<span class="variable">$DATE</span>"</span>/all_databases_backup_<span class="string">"<span class="variable">$DATE_filename</span>"</span>.sql.gz</div><div class="line"><span class="keyword">if</span> [ $? <span class="_">-eq</span> 0 ];<span class="keyword">then</span></div><div class="line">  /bin/logger <span class="string">"[ "</span><span class="variable">$DATE_log</span><span class="string">" ] - Databases all-databases has been backup successful."</span></div><div class="line">  <span class="built_in">echo</span> <span class="_">-e</span> <span class="string">"[ "</span><span class="variable">$DATE_log</span><span class="string">" ] - Databases all-databases has been backup successful.\n"</span> &gt;&gt; <span class="string">"<span class="variable">$Backup_log</span>"</span></div><div class="line">  /bin/sleep 5</div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="comment">#Backup a single database</span></div><div class="line">[ ! <span class="_">-s</span> <span class="string">"<span class="variable">$Mysql_db</span>"</span> ] &amp;&amp; <span class="built_in">echo</span> <span class="_">-e</span> <span class="string">'Error: Backup a single database. Do not back up mysql system database.[test|performance_schema|information_schema|mysql]\n'</span> &amp;&amp; <span class="built_in">echo</span> <span class="_">-e</span> <span class="string">'Mysql database full backup success.'</span> &amp;&amp; <span class="built_in">exit</span> 1</div><div class="line"><span class="keyword">for</span> DBNAME <span class="keyword">in</span> `cat <span class="variable">$Mysql_db</span>`</div><div class="line"><span class="keyword">do</span></div><div class="line">  <span class="variable">$MYSQLDUMP</span> --ignore-table=mysql.event --skip-lock-tables --quick --opt --master-data=2 --tz-utc=<span class="literal">true</span> -u<span class="string">"<span class="variable">$mysql_user</span>"</span> -p<span class="string">"<span class="variable">$mysql_pass</span>"</span> -S <span class="string">"<span class="variable">$SOCKET</span>"</span> <span class="string">"<span class="variable">$DBNAME</span>"</span> | gzip &gt; <span class="string">"<span class="variable">$Full_Backup</span>"</span>/<span class="string">"<span class="variable">$DATE</span>"</span>/<span class="string">"<span class="variable">$DBNAME</span>"</span>_backup_<span class="string">"<span class="variable">$DATE_filename</span>"</span>.sql.gz</div><div class="line">  <span class="keyword">if</span> [ $? <span class="_">-eq</span> 0 ];<span class="keyword">then</span></div><div class="line">    /bin/logger <span class="string">"[ "</span><span class="variable">$DATE_log</span><span class="string">" ] - Databases "</span><span class="variable">$&#123;DBNAME&#125;</span><span class="string">" has been backup successful."</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">"[ "</span><span class="variable">$DATE_log</span><span class="string">" ] - Databases "</span><span class="variable">$&#123;DBNAME&#125;</span><span class="string">" has been backup successful."</span> &gt;&gt; <span class="string">"<span class="variable">$Backup_log</span>"</span></div><div class="line">    /bin/sleep 5</div><div class="line">  <span class="keyword">fi</span></div><div class="line"><span class="keyword">done</span></div><div class="line"><span class="built_in">echo</span> <span class="_">-e</span> <span class="string">'----------------------------------------\n'</span> &gt;&gt; <span class="string">"<span class="variable">$Backup_log</span>"</span></div><div class="line"></div><div class="line"><span class="built_in">cd</span> <span class="variable">$Mysql_Backup</span></div><div class="line">find <span class="string">"<span class="variable">$Full_Backup</span>"</span> -mtime +10 | xargs rm -rf &#123;&#125; \; &amp;&gt; /dev/null</div><div class="line"><span class="built_in">echo</span> <span class="string">'Mysql database full backup success.'</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">function</span> <span class="function"><span class="title">Inc</span></span>() &#123;</div><div class="line"><span class="built_in">echo</span> <span class="_">-e</span> <span class="string">'Increment backup of MySQL database... Please wait.\n'</span></div><div class="line">[ ! <span class="_">-f</span> <span class="string">"<span class="variable">$Mysql_Backup</span>"</span>/Full_backup_time.txt ] &amp;&amp; <span class="built_in">echo</span> <span class="_">-e</span> <span class="string">'Error: Please perform a full backup first. command: sh mysql_back.sh Mysql_Fullbackup'</span> &amp;&amp; <span class="built_in">exit</span> 1</div><div class="line"></div><div class="line">[ ! <span class="_">-s</span> <span class="string">"<span class="variable">$Mysql_db</span>"</span> ] &amp;&amp; <span class="built_in">echo</span> <span class="_">-e</span> <span class="string">"Error: file <span class="variable">$Mysql_db</span> is empey. There may only be a system database[test|performance_schema|information_schema|mysql]."</span> &amp;&amp; <span class="built_in">exit</span> 1</div><div class="line"></div><div class="line"><span class="built_in">cd</span> <span class="variable">$Mysql_Backup</span></div><div class="line"></div><div class="line"><span class="string">"<span class="variable">$MYSQLADMIN</span>"</span> -u<span class="string">"<span class="variable">$mysql_user</span>"</span> -p<span class="string">"<span class="variable">$mysql_pass</span>"</span> flush-logs</div><div class="line">awk -F<span class="string">'/'</span> <span class="string">'&#123;print $NF&#125;'</span> <span class="string">"<span class="variable">$Mysql_data</span>"</span>/mysql_bin.index &gt; <span class="string">"<span class="variable">$Mysql_index</span>"</span></div><div class="line"></div><div class="line">[ ! <span class="_">-s</span> <span class="string">"<span class="variable">$Mysql_index</span>"</span> ] &amp;&amp; <span class="built_in">echo</span> <span class="_">-e</span> <span class="string">"Error: Please open the mysql binlog log. The command in the my.cnf file: log_bin=mysql_bin and binlog_format=Mixed"</span> &amp;&amp; <span class="built_in">exit</span> 1</div><div class="line">[ ! <span class="_">-d</span> <span class="string">"<span class="variable">$Inc_Backup</span>"</span>/<span class="string">"<span class="variable">$DATE</span>"</span> ] &amp;&amp; mkdir -p <span class="string">"<span class="variable">$Inc_Backup</span>"</span>/<span class="string">"<span class="variable">$DATE</span>"</span></div><div class="line"></div><div class="line">DATE_starttime=`cat <span class="string">"<span class="variable">$Mysql_Backup</span>"</span>/Full_backup_time.txt`</div><div class="line">start=<span class="string">'--start-datetime'</span></div><div class="line"><span class="keyword">for</span> DBNAME <span class="keyword">in</span> `cat <span class="variable">$Mysql_db</span>`</div><div class="line"><span class="keyword">do</span></div><div class="line">  <span class="keyword">for</span> index <span class="keyword">in</span> `cat <span class="variable">$Mysql_index</span>`</div><div class="line">  <span class="keyword">do</span></div><div class="line">    <span class="string">"<span class="variable">$Mysql_binlog</span>"</span> -u<span class="string">"<span class="variable">$mysql_user</span>"</span> -p<span class="string">"<span class="variable">$mysql_pass</span>"</span> <span class="_">-d</span> <span class="string">"<span class="variable">$DBNAME</span>"</span> <span class="string">"<span class="variable">$start</span>"</span>=<span class="string">"<span class="variable">$DATE_starttime</span>"</span> <span class="string">"<span class="variable">$Mysql_data</span>"</span>/<span class="string">"<span class="variable">$index</span>"</span> &gt;&gt; <span class="string">"<span class="variable">$Inc_Backup</span>"</span>/<span class="string">"<span class="variable">$DATE</span>"</span>/<span class="string">"<span class="variable">$DBNAME</span>"</span>_Inc_<span class="string">"<span class="variable">$DATE_filename</span>"</span>.sql</div><div class="line">    /bin/sleep 1</div><div class="line">  <span class="keyword">done</span></div><div class="line">  <span class="keyword">if</span> [ $? <span class="_">-eq</span> 0 ];<span class="keyword">then</span></div><div class="line">      <span class="built_in">cd</span> <span class="string">"<span class="variable">$Inc_Backup</span>"</span>/<span class="string">"<span class="variable">$DATE</span>"</span></div><div class="line">      /usr/bin/zip -q <span class="string">"<span class="variable">$DBNAME</span>"</span>_Inc_<span class="string">"<span class="variable">$DATE_filename</span>"</span>.zip <span class="string">"<span class="variable">$DBNAME</span>"</span>_Inc_<span class="string">"<span class="variable">$DATE_filename</span>"</span>.sql</div><div class="line">      /bin/logger <span class="string">"[ "</span><span class="variable">$DATE_log</span><span class="string">" ] - Databases "</span><span class="variable">$&#123;DBNAME&#125;</span><span class="string">" has been Inc_backup successful."</span></div><div class="line">      <span class="built_in">echo</span> <span class="string">"[ "</span><span class="variable">$DATE_log</span><span class="string">" ] - Databases "</span><span class="variable">$&#123;DBNAME&#125;</span><span class="string">" has been Inc_backup successful."</span> &gt;&gt; <span class="string">"<span class="variable">$Backup_log</span>"</span></div><div class="line">      rm -rf <span class="string">"<span class="variable">$DBNAME</span>"</span>_Inc_<span class="string">"<span class="variable">$DATE_filename</span>"</span>.sql</div><div class="line">    <span class="keyword">fi</span></div><div class="line"><span class="keyword">done</span></div><div class="line"><span class="built_in">echo</span> <span class="_">-e</span> <span class="string">'----------------------------------------\n'</span> &gt;&gt; <span class="string">"<span class="variable">$Backup_log</span>"</span></div><div class="line"><span class="built_in">cd</span> <span class="variable">$Mysql_Backup</span></div><div class="line">find <span class="string">"<span class="variable">$Inc_Backup</span>"</span> -mtime +10 | xargs rm -rf &#123;&#125; \; &amp;&gt; /dev/null</div><div class="line"><span class="built_in">echo</span> <span class="string">'Mysql database Increment backup success.'</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span> </div><div class="line">	Mysql_Fullbackup)</div><div class="line">		Full;;</div><div class="line">	Mysql_Incbackup)</div><div class="line">		Inc;;</div><div class="line">	*)</div><div class="line">		<span class="built_in">echo</span> <span class="_">-e</span> <span class="string">"Usage: please input Mysql_Fullbackup|Mysql_Incbackup\n"</span>;;</div><div class="line"><span class="keyword">esac</span></div><div class="line">[root@host1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/03/08/Mysql备份恢复/">http://www.yfshare.vip/2017/03/08/Mysql备份恢复/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[部署Ansible Tower]]></title>
      <url>http://www.yfshare.vip/2017/03/07/%E9%83%A8%E7%BD%B2Ansible-Tower/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>Ansible Tower (以前叫’AWX’)是能够帮助任何IT团队更容易使用Ansible的解决方案。该方案基于web<br>Tower允许对用户进行权限控制，即使某用户不能传送某SSH凭证，你也可以通过Tower来对该用户共享该凭证。我们可以通过图形化界面来管理Inventory，也可以对各种各样的云资源做同步。Tower可以记录所有job的日志，也可以与LDAP集成，并且拥有强大的可浏览的REST API。Tower也提供了命令行工具，可以与Jenkins轻松集成。Provisioning回调对自动伸缩拓扑图提供了强大的支持<br><a id="more"></a><br>Tower的免费版本最多支持10个节点，并且Ansible公司会提供强大的支持。可以用Ansible playbook来安装Tower，ansible的版本为1.7x或更高版本<br>安装要求：内存&gt;=2GB,/var &gt;=10GB。否则会安装失败  </p>
<p>官网地址：<a href="https://www.ansible.com/tower" target="_blank" rel="external">https://www.ansible.com/tower</a><br>下载地址(下载免费控制10个机器的授权)：<a href="https://www.ansible.com/license" target="_blank" rel="external">https://www.ansible.com/license</a><br><a href="https://releases.ansible.com/awx/setup/" target="_blank" rel="external">ansible-tower各个版本下载地址</a><br>目前最新版为3.1.0要求：RHEL 7, CentOS 7, or Ubuntu 14.04 LTS or 16.04 LTS, and requires Ansible Core 2.1.X or later.<br>我这里系统是Centos 6.6，所以只能用Tower-3.0.3及以前的版本  </p>
<p>安装前检查：  </p>
<ol>
<li>python版本为2.6</li>
<li>保持网络畅通</li>
<li>内存预留充足，内存&gt;=2GB,/var &gt;=10GB</li>
<li>安装用户为root</li>
</ol>
<p>环境：Centos 6.6<br>　　　ansible 2.2.1.0</p>
<p>安装Tower<br>Ansible tower包含一个简单的基于文本的配置向导来配置安装你的tower，安装Tower需要使用到postgresql数据库<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#配置yum源</span></div><div class="line">注意:除了光盘源外还需要extra(CentOS-Base.repo)</div><div class="line"></div><div class="line"><span class="comment">#CentOS-Base.repo源</span></div><div class="line">[root@Ansible ~]<span class="comment"># cd /etc/yum.repos.d/</span></div><div class="line">[root@Ansible yum.repos.d]<span class="comment"># cat CentOS-Base.repo </span></div><div class="line">[base]</div><div class="line">name=CentOS-<span class="variable">$releasever</span> - Base</div><div class="line">mirrorlist=http://mirrorlist.centos.org/?release=<span class="variable">$releasever</span>&amp;arch=<span class="variable">$basearch</span>&amp;repo=os&amp;infra=<span class="variable">$infra</span></div><div class="line"><span class="comment">#baseurl=http://mirror.centos.org/centos/$releasever/os/$basearch/</span></div><div class="line">gpgcheck=0</div><div class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-6</div><div class="line"></div><div class="line"><span class="comment">#released updates </span></div><div class="line">[updates]</div><div class="line">name=CentOS-<span class="variable">$releasever</span> - Updates</div><div class="line">mirrorlist=http://mirrorlist.centos.org/?release=<span class="variable">$releasever</span>&amp;arch=<span class="variable">$basearch</span>&amp;repo=updates&amp;infra=<span class="variable">$infra</span></div><div class="line"><span class="comment">#baseurl=http://mirror.centos.org/centos/$releasever/updates/$basearch/</span></div><div class="line">gpgcheck=1</div><div class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-6</div><div class="line"></div><div class="line"><span class="comment">#additional packages that may be useful</span></div><div class="line">[extras]</div><div class="line">name=CentOS-<span class="variable">$releasever</span> - Extras</div><div class="line">mirrorlist=http://mirrorlist.centos.org/?release=<span class="variable">$releasever</span>&amp;arch=<span class="variable">$basearch</span>&amp;repo=extras&amp;infra=<span class="variable">$infra</span></div><div class="line"><span class="comment">#baseurl=http://mirror.centos.org/centos/$releasever/extras/$basearch/</span></div><div class="line">gpgcheck=1</div><div class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-6</div><div class="line"></div><div class="line"><span class="comment">#additional packages that extend functionality of existing packages</span></div><div class="line">[centosplus]</div><div class="line">name=CentOS-<span class="variable">$releasever</span> - Plus</div><div class="line">mirrorlist=http://mirrorlist.centos.org/?release=<span class="variable">$releasever</span>&amp;arch=<span class="variable">$basearch</span>&amp;repo=centosplus&amp;infra=<span class="variable">$infra</span></div><div class="line"><span class="comment">#baseurl=http://mirror.centos.org/centos/$releasever/centosplus/$basearch/</span></div><div class="line">gpgcheck=1</div><div class="line">enabled=0</div><div class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-6</div><div class="line"></div><div class="line"><span class="comment">#contrib - packages by Centos Users</span></div><div class="line">[contrib]</div><div class="line">name=CentOS-<span class="variable">$releasever</span> - Contrib</div><div class="line">mirrorlist=http://mirrorlist.centos.org/?release=<span class="variable">$releasever</span>&amp;arch=<span class="variable">$basearch</span>&amp;repo=contrib&amp;infra=<span class="variable">$infra</span></div><div class="line"><span class="comment">#baseurl=http://mirror.centos.org/centos/$releasever/contrib/$basearch/</span></div><div class="line">gpgcheck=1</div><div class="line">enabled=0</div><div class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-6</div><div class="line">[root@Ansible yum.repos.d]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Ansible-Tower的yum源</span></div><div class="line">[root@Ansible yum.repos.d]<span class="comment"># cat Ansible-Tower.repo </span></div><div class="line">[Ansible-Tower]</div><div class="line">name=Ansible Tower Repository - <span class="variable">$releasever</span> <span class="variable">$basearch</span></div><div class="line">baseurl=http://releases.ansible.com/ansible-tower/rpm/epel-6-<span class="variable">$basearch</span></div><div class="line">enabled=1</div><div class="line">gpgcheck=0</div><div class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-ansible-release</div><div class="line">[root@Ansible yum.repos.d]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">[root@Ansible yum.repos.d]<span class="comment"># cat yum.repo </span></div><div class="line">[nginx]</div><div class="line">name=nginx repo</div><div class="line">baseurl=http://nginx.org/packages/centos/6/<span class="variable">$basearch</span>/</div><div class="line">gpgcheck=0</div><div class="line">enabled=1</div><div class="line">  </div><div class="line">[webtatic]</div><div class="line">name=Webtatic Repository EL6 - <span class="variable">$basearch</span></div><div class="line">baseurl=http://repo.webtatic.com/yum/el6/<span class="variable">$basearch</span>/</div><div class="line"><span class="comment">#mirrorlist=http://mirror.webtatic.com/yum/el6/$basearch/mirrorlist</span></div><div class="line">failovermethod=priority</div><div class="line">enabled=1</div><div class="line">gpgcheck=0</div><div class="line"></div><div class="line">[epel] </div><div class="line">name=Extra Packages <span class="keyword">for</span> Enterprise Linux 6 - <span class="variable">$basearch</span> </div><div class="line">baseurl=http://mirrors.aliyun.com/epel/6/<span class="variable">$basearch</span> </div><div class="line">http://mirrors.aliyuncs.com/epel/6/<span class="variable">$basearch</span> </div><div class="line">mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-6&amp;arch=<span class="variable">$basearch</span> </div><div class="line">failovermethod=priority </div><div class="line">enabled=1 </div><div class="line">gpgcheck=0</div><div class="line"></div><div class="line">[remi]</div><div class="line">name=Les RPM de remi pour Enterprise Linux 6 - <span class="variable">$basearch</span></div><div class="line"><span class="comment">#baseurl=http://rpms.famillecollet.com/enterprise/6/remi/$basearch/</span></div><div class="line">mirrorlist=http://rpms.famillecollet.com/enterprise/6/remi/mirror</div><div class="line">enabled=1</div><div class="line">gpgcheck=0</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#安装Tower</span></div><div class="line">[root@Ansible ~]<span class="comment"># wget https://releases.ansible.com/awx/setup/ansible-tower-setup-3.0.3.tar.gz</span></div><div class="line">[root@Ansible ~]<span class="comment"># tar -zxf ansible-tower-setup-3.0.3.tar.gz</span></div><div class="line">[root@Ansible ~]<span class="comment"># cd ansible-tower-setup-3.0.3</span></div><div class="line">[root@Ansible ansible-tower-setup-3.0.3]<span class="comment"># ./setup.sh</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#安装到一半如果在这里报错，是因为连不上数据库，启动postgresql即可</span></div><div class="line">TASK [awx_install : Migrate the Tower database schema (may take awhile when upgrading).] ***</div><div class="line"></div><div class="line"><span class="comment">#解决办法</span></div><div class="line">[root@Ansible ~]<span class="comment"># service postgresql-9.4 initdb</span></div><div class="line">[root@Ansible ~]<span class="comment"># service postgresql-9.4 start</span></div><div class="line">[root@Ansible ~]<span class="comment"># chkconfig postgresql on</span></div><div class="line"></div><div class="line"><span class="comment">#创建用户</span></div><div class="line">[root@Ansible ~]<span class="comment"># id postgres</span></div><div class="line">uid=26(postgres) gid=26(postgres) groups=26(postgres)</div><div class="line">[root@Ansible ~]<span class="comment"># su - postgres</span></div><div class="line">-bash-4.1$ psql</div><div class="line">psql (9.4.11)</div><div class="line">Type <span class="string">"help"</span> <span class="keyword">for</span> help.</div><div class="line"></div><div class="line">postgres=<span class="comment"># CREATE ROLE awx CREATEDB PASSWORD 'admin' LOGIN; </span></div><div class="line">CREATE ROLE</div><div class="line">postgres=<span class="comment"># \q</span></div><div class="line">-bash-4.1$ <span class="built_in">exit</span></div><div class="line"><span class="built_in">logout</span></div><div class="line">[root@Ansible ~]<span class="comment"># sed -i 's#peer#md5#g' /var/lib/pgsql/9.4/data/pg_hba.conf</span></div><div class="line">[root@Ansible ~]<span class="comment"># sed -i 's#ident#md5#g' /var/lib/pgsql/9.4/data/pg_hba.conf</span></div><div class="line">[root@Ansible ~]<span class="comment"># service postgresql-9.4 restart</span></div><div class="line">Stopping postgresql-9.4 service:                           [  OK  ]</div><div class="line">Starting postgresql-9.4 service:                           [  OK  ]</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">测试awx用户连接，输入密码连接，并创建数据库</div><div class="line">[root@Ansible ~]<span class="comment"># psql -U awx -d postgres -h 127.0.0.1</span></div><div class="line">Password <span class="keyword">for</span> user awx: </div><div class="line">psql (9.4.11)</div><div class="line">Type <span class="string">"help"</span> <span class="keyword">for</span> help.</div><div class="line"></div><div class="line">postgres=&gt; create database awx;</div><div class="line">CREATE DATABASE</div><div class="line">postgres=&gt; \q</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>再次./setup.sh进行安装tower<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#inventory配置</span></div><div class="line">[root@Ansible ansible-tower-setup-3.0.3]<span class="comment"># grep -v ^$ inventory</span></div><div class="line">[primary]</div><div class="line">localhost ansible_connection=<span class="built_in">local</span></div><div class="line">[secondary]</div><div class="line">[database]</div><div class="line">[all:vars]</div><div class="line">admin_password=<span class="string">'admin'</span></div><div class="line">redis_password=<span class="string">'1234567'</span></div><div class="line">pg_host=<span class="string">'127.0.0.1'</span></div><div class="line">pg_port=<span class="string">'5432'</span></div><div class="line">pg_database=<span class="string">'awx'</span></div><div class="line">pg_username=<span class="string">'awx'</span></div><div class="line">pg_password=<span class="string">'admin'</span></div><div class="line">[root@Ansible ansible-tower-setup-3.0.3]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@Ansible ansible-tower-setup-3.0.3]<span class="comment"># ./setup.sh</span></div><div class="line">···</div><div class="line">The setup process completed successfully.</div></pre></td></tr></table></figure></p>
<p>访问<a href="http://ip/" target="_blank" rel="external">http://ip/</a> 打开Ansible Tower Dashboard<br><img src="http://note.youdao.com/yws/api/personal/file/2F9139842F074D2BB72B5489E557F6E1?method=download&amp;shareKey=00f221946a4cbec628661e1b4e47529e" alt="image">  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/6E0779F0097A4E50BCB1180C06BC4B5E?method=download&amp;shareKey=4bfd38e9671683e36b4438b0e5f5421d" alt="image">  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/C6B06B214ECF42F89AC434B10E906B05?method=download&amp;shareKey=012de0283dbb99bbc60d74040de5e7dd" alt="image"><br>安装成功  </p>
<p>参考：<a href="http://www.jianshu.com/p/1c6aa6ceeca6" target="_blank" rel="external">http://www.jianshu.com/p/1c6aa6ceeca6</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/03/07/部署Ansible-Tower/">http://www.yfshare.vip/2017/03/07/部署Ansible-Tower/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Oracle数据库备份与恢复 - RMAN备份]]></title>
      <url>http://www.yfshare.vip/2017/02/28/Oracle%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D-RMAN%E5%A4%87%E4%BB%BD/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>如果要说DBA工作中最重要的职责（没有之一），那无疑就是保证客户数据的安全和完整，可以看到几乎任何一本Oracle DBA的技术书籍一定都会把大篇幅来介绍数据库的备份与恢复，从中也可以看到备份和恢复的重要程度。<a href="http://www.eygle.com/" target="_blank" rel="external">eygle</a>曾经总结了<a href="http://www.eygle.com/archives/2006/03/the_four_rule_for_dba.html" target="_blank" rel="external">DBA生存之四大守则</a>的第一条就是：备份重于一切<br><em>我们必需知道,系统总是要崩溃的，没有有效的备份只是等哪一天死！我经常开玩笑的说,唯一会使DBA在梦中惊醒的就是,没有有效的备份.</em><br><a id="more"></a></p>
<h2 id="RMAN概览"><a href="#RMAN概览" class="headerlink" title="RMAN概览"></a>RMAN概览</h2><p>RMAN是Oracle数据库软件自带的备份/恢复工具。RMAN只能用于9i或更高的版本中。它能够备份整个数据库或数据库部件，如表空间、数据文件、控制文件、归档文件以及Spfile参数文件。通过RMAN的方式无论是要备份还是要恢复，都必须先启动实例并加载数据库。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">From Wiki：RMAN (Recovery Manager) is a backup and recovery manager supplied <span class="keyword">for</span> Oracle databases (from version 8) created by the Oracle Corporation. It provides database backup, restore, and recovery capabilities addressing high availability and disaster recovery concerns. Oracle Corporation recommends RMAN as its preferred method <span class="keyword">for</span> backup and recovery and has written <span class="built_in">command</span>-line and graphical (via Oracle Enterprise Manager) interfaces <span class="keyword">for</span> the product.</div></pre></td></tr></table></figure></p>
<h2 id="RMAN之备份"><a href="#RMAN之备份" class="headerlink" title="RMAN之备份"></a>RMAN之备份</h2><p>连接数据库<br>很简单，进入到命令提示符界面：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[oracle@orcl ~]$ rman target /</div><div class="line">Recovery Manager: Release 11.2.0.4.0 - Production on Tue Feb 28 10:51:34 2017</div><div class="line">Copyright (c) 1982, 2011, Oracle and/or its affiliates.  All rights reserved.</div><div class="line">connected to target database: ORCL (DBID=1455780274)</div><div class="line">RMAN&gt;</div></pre></td></tr></table></figure></p>
<p>也可以先启动RMAN，然后再通过CONNECT命令来连接目标数据库：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[oracle@orcl ~]$ rman</div><div class="line">Recovery Manager: Release 11.2.0.4.0 - Production on Tue Feb 28 10:52:45 2017</div><div class="line">Copyright (c) 1982, 2011, Oracle and/or its affiliates.  All rights reserved.</div><div class="line">RMAN&gt; connect target /</div><div class="line">connected to target database: ORCL (DBID=1455780274)</div><div class="line">RMAN&gt;</div></pre></td></tr></table></figure></p>
<p>使用RMAN来做各种类型的备份</p>
<ol>
<li>整库备份<br>整库备份的命令很简单，就是backup database<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; backup database;</div><div class="line"></div><div class="line">Starting backup at 28-FEB-17</div><div class="line">using target database control file instead of recovery catalog</div><div class="line">allocated channel: ORA_DISK_1</div><div class="line">channel ORA_DISK_1: SID=1717 device <span class="built_in">type</span>=DISK</div><div class="line">channel ORA_DISK_1: starting full datafile backup <span class="built_in">set</span></div><div class="line">channel ORA_DISK_1: specifying datafile(s) <span class="keyword">in</span> backup <span class="built_in">set</span></div><div class="line">input datafile file number=00001 name=/u01/data/orcl/system01.dbf</div><div class="line">input datafile file number=00002 name=/u01/data/orcl/sysaux01.dbf</div><div class="line">input datafile file number=00003 name=/u01/data/orcl/undotbs01.dbf</div><div class="line">input datafile file number=00004 name=/u01/data/orcl/users01.dbf</div><div class="line">input datafile file number=00007 name=/u01/data/orcl/dev_paydb.dbf</div><div class="line">input datafile file number=00008 name=/u01/data/orcl/dev_payboxdb.dbf</div><div class="line">input datafile file number=00009 name=/u01/data/orcl/ticket.dbf</div><div class="line">input datafile file number=00005 name=/u01/data/orcl/PAYBOX_FG_PRO.dbf</div><div class="line">input datafile file number=00006 name=/u01/data/orcl/PAYBOX_TEST2SP.dbf</div><div class="line">channel ORA_DISK_1: starting piece 1 at 28-FEB-17</div><div class="line">channel ORA_DISK_1: finished piece 1 at 28-FEB-17</div><div class="line">piece handle=/u01/app/oracle/product/11.2.0.4/db_1/dbs/01rtn1md_1_1 tag=TAG20170228T105613 comment=NONE</div><div class="line">channel ORA_DISK_1: backup <span class="built_in">set</span> complete, elapsed time: 00:40:26</div><div class="line">channel ORA_DISK_1: starting full datafile backup <span class="built_in">set</span></div><div class="line">channel ORA_DISK_1: specifying datafile(s) <span class="keyword">in</span> backup <span class="built_in">set</span></div><div class="line">including current control file <span class="keyword">in</span> backup <span class="built_in">set</span></div><div class="line">including current SPFILE <span class="keyword">in</span> backup <span class="built_in">set</span></div><div class="line">channel ORA_DISK_1: starting piece 1 at 28-FEB-17</div><div class="line">channel ORA_DISK_1: finished piece 1 at 28-FEB-17</div><div class="line">piece handle=/u01/app/oracle/product/11.2.0.4/db_1/dbs/02rtn428_1_1 tag=TAG20170228T105613 comment=NONE</div><div class="line">channel ORA_DISK_1: backup <span class="built_in">set</span> complete, elapsed time: 00:00:01</div><div class="line">Finished backup at 28-FEB-17</div><div class="line"></div><div class="line">RMAN&gt;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>整库备份集生成了两个备份片段：一个存储数据文件，另一个存储控制文件和SPFILE（服务器端初始化参数文件），都被保存到Oracle软件的安装目录下，这是因为没有为备份集指定存储路径，默认情况下就会存储到Oracle软件的安装目录中</p>
<p>真正的备份操作，你肯定希望能够指定备份集的存储位置，没问题，最简单的方式是在执行BACKUP命令时，指定FORMAT参数来自定义备份片段的路径和命令规则<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; BACKUP DATABASE FORMAT <span class="string">'/u01/data/db_bk/bak_%U'</span>;</div></pre></td></tr></table></figure></p>
<p>查看创建的全库备份<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; LIST BACKUP OF DATABASE;</div><div class="line"></div><div class="line">List of Backup Sets</div><div class="line">===================</div><div class="line"></div><div class="line">BS Key  Type LV Size       Device Type Elapsed Time Completion Time</div><div class="line">------- ---- -- ---------- ----------- ------------ ---------------</div><div class="line">1       Full    4.99G      DISK        00:40:17     28-FEB-17      </div><div class="line">        BP Key: 1   Status: AVAILABLE  Compressed: NO  Tag: TAG20170228T105613</div><div class="line">        Piece Name: /u01/app/oracle/product/11.2.0.4/db_1/dbs/01rtn1md_1_1</div><div class="line">  List of Datafiles <span class="keyword">in</span> backup <span class="built_in">set</span> 1</div><div class="line">  File LV Type Ckp SCN    Ckp Time  Name</div><div class="line">  ---- -- ---- ---------- --------- ----</div><div class="line">  1       Full 37643780   28-FEB-17 /u01/data/orcl/system01.dbf</div><div class="line">  2       Full 37643780   28-FEB-17 /u01/data/orcl/sysaux01.dbf</div><div class="line">  3       Full 37643780   28-FEB-17 /u01/data/orcl/undotbs01.dbf</div><div class="line">  4       Full 37643780   28-FEB-17 /u01/data/orcl/users01.dbf</div><div class="line">  5       Full 37643780   28-FEB-17 /u01/data/orcl/PAYBOX_FG_PRO.dbf</div><div class="line">  6       Full 37643780   28-FEB-17 /u01/data/orcl/PAYBOX_TEST2SP.dbf</div><div class="line">  7       Full 37643780   28-FEB-17 /u01/data/orcl/dev_paydb.dbf</div><div class="line">  8       Full 37643780   28-FEB-17 /u01/data/orcl/dev_payboxdb.dbf</div><div class="line">  9       Full 37643780   28-FEB-17 /u01/data/orcl/ticket.dbf</div><div class="line"></div><div class="line">RMAN&gt;</div></pre></td></tr></table></figure></p>
<ol>
<li>表空间的备份<br>rman还可以针对表空间备份<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; BACKUP TABLESPACE USERS;</div><div class="line"></div><div class="line">Starting backup at 28-FEB-17</div><div class="line">using channel ORA_DISK_1</div><div class="line">channel ORA_DISK_1: starting full datafile backup <span class="built_in">set</span></div><div class="line">channel ORA_DISK_1: specifying datafile(s) <span class="keyword">in</span> backup <span class="built_in">set</span></div><div class="line">input datafile file number=00004 name=/u01/data/orcl/users01.dbf</div><div class="line">channel ORA_DISK_1: starting piece 1 at 28-FEB-17</div><div class="line">channel ORA_DISK_1: finished piece 1 at 28-FEB-17</div><div class="line">piece handle=/u01/app/oracle/product/11.2.0.4/db_1/dbs/03rtn5li_1_1 tag=TAG20170228T120402 comment=NONE</div><div class="line">channel ORA_DISK_1: backup <span class="built_in">set</span> complete, elapsed time: 00:01:05</div><div class="line">Finished backup at 28-FEB-17</div><div class="line"></div><div class="line">RMAN&gt;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>查看表空间的备份<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; LIST BACKUP OF TABLESPACE USERS;</div><div class="line"></div><div class="line">List of Backup Sets</div><div class="line">===================</div><div class="line"></div><div class="line">BS Key  Type LV Size       Device Type Elapsed Time Completion Time</div><div class="line">------- ---- -- ---------- ----------- ------------ ---------------</div><div class="line">1       Full    4.99G      DISK        00:40:17     28-FEB-17      </div><div class="line">        BP Key: 1   Status: AVAILABLE  Compressed: NO  Tag: TAG20170228T105613</div><div class="line">        Piece Name: /u01/app/oracle/product/11.2.0.4/db_1/dbs/01rtn1md_1_1</div><div class="line">  List of Datafiles <span class="keyword">in</span> backup <span class="built_in">set</span> 1</div><div class="line">  File LV Type Ckp SCN    Ckp Time  Name</div><div class="line">  ---- -- ---- ---------- --------- ----</div><div class="line">  4       Full 37643780   28-FEB-17 /u01/data/orcl/users01.dbf</div><div class="line"></div><div class="line">BS Key  Type LV Size       Device Type Elapsed Time Completion Time</div><div class="line">------- ---- -- ---------- ----------- ------------ ---------------</div><div class="line">3       Full    415.72M    DISK        00:00:59     28-FEB-17      </div><div class="line">        BP Key: 3   Status: AVAILABLE  Compressed: NO  Tag: TAG20170228T120402</div><div class="line">        Piece Name: /u01/app/oracle/product/11.2.0.4/db_1/dbs/03rtn5li_1_1</div><div class="line">  List of Datafiles <span class="keyword">in</span> backup <span class="built_in">set</span> 3</div><div class="line">  File LV Type Ckp SCN    Ckp Time  Name</div><div class="line">  ---- -- ---- ---------- --------- ----</div><div class="line">  4       Full 37647157   28-FEB-17 /u01/data/orcl/users01.dbf</div><div class="line"></div><div class="line">RMAN&gt;</div></pre></td></tr></table></figure></p>
<p>这里发现USER表空间存在2份备份（因为之前做过一次全量备份）</p>
<p>删除指定的BACKUPSET<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; DELETE BACKUPSET 3;</div><div class="line">using channel ORA_DISK_1</div><div class="line"></div><div class="line">List of Backup Pieces</div><div class="line">BP Key  BS Key  Pc<span class="comment"># Cp# Status      Device Type Piece Name</span></div><div class="line">------- ------- --- --- ----------- ----------- ----------</div><div class="line">3       3       1   1   AVAILABLE   DISK        /u01/app/oracle/product/11.2.0.4/db_1/dbs/03rtn5li_1_1</div><div class="line"></div><div class="line">Do you really want to delete the above objects (enter YES or NO)? YES</div><div class="line">deleted backup piece</div><div class="line">backup piece handle=/u01/app/oracle/product/11.2.0.4/db_1/dbs/03rtn5li_1_1 RECID=3 STAMP=937137843</div><div class="line">Deleted 1 objects</div><div class="line"></div><div class="line">RMAN&gt;</div></pre></td></tr></table></figure></p>
<ol>
<li>数据文件的备份<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">SQL&gt; select file<span class="comment">#,name from v$datafile;</span></div><div class="line"></div><div class="line">     FILE<span class="comment"># NAME</span></div><div class="line">---------- --------------------------------------------------</div><div class="line">	 1 /u01/data/orcl/system01.dbf</div><div class="line">	 2 /u01/data/orcl/sysaux01.dbf</div><div class="line">	 3 /u01/data/orcl/undotbs01.dbf</div><div class="line">	 4 /u01/data/orcl/users01.dbf</div><div class="line">	 5 /u01/data/orcl/PAYBOX_FG_PRO.dbf</div><div class="line">	 6 /u01/data/orcl/PAYBOX_TEST2SP.dbf</div><div class="line">	 7 /u01/data/orcl/dev_paydb.dbf</div><div class="line">	 8 /u01/data/orcl/dev_payboxdb.dbf</div><div class="line">	 9 /u01/data/orcl/ticket.dbf</div><div class="line"></div><div class="line">9 rows selected.</div><div class="line"></div><div class="line">SQL&gt;</div></pre></td></tr></table></figure>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; BACKUP DATAFILE <span class="string">'/u01/data/orcl/users01.dbf'</span>;</div><div class="line"></div><div class="line">Starting backup at 28-FEB-17</div><div class="line">using channel ORA_DISK_1</div><div class="line">channel ORA_DISK_1: starting full datafile backup <span class="built_in">set</span></div><div class="line">channel ORA_DISK_1: specifying datafile(s) <span class="keyword">in</span> backup <span class="built_in">set</span></div><div class="line">input datafile file number=00004 name=/u01/data/orcl/users01.dbf</div><div class="line">channel ORA_DISK_1: starting piece 1 at 28-FEB-17</div><div class="line">channel ORA_DISK_1: finished piece 1 at 28-FEB-17</div><div class="line">piece handle=/u01/app/oracle/product/11.2.0.4/db_1/dbs/04rtn83l_1_1 tag=TAG20170228T124540 comment=NONE</div><div class="line">channel ORA_DISK_1: backup <span class="built_in">set</span> complete, elapsed time: 00:00:07</div><div class="line">Finished backup at 28-FEB-17</div><div class="line"></div><div class="line">RMAN&gt;</div></pre></td></tr></table></figure>
<ol>
<li>控制文件备份<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; BACKUP CURRENT CONTROLFILE;</div><div class="line"></div><div class="line">Starting backup at 28-FEB-17</div><div class="line">using channel ORA_DISK_1</div><div class="line">channel ORA_DISK_1: starting full datafile backup <span class="built_in">set</span></div><div class="line">channel ORA_DISK_1: specifying datafile(s) <span class="keyword">in</span> backup <span class="built_in">set</span></div><div class="line">including current control file <span class="keyword">in</span> backup <span class="built_in">set</span></div><div class="line">channel ORA_DISK_1: starting piece 1 at 28-FEB-17</div><div class="line">channel ORA_DISK_1: finished piece 1 at 28-FEB-17</div><div class="line">piece handle=/u01/app/oracle/product/11.2.0.4/db_1/dbs/05rtn873_1_1 tag=TAG20170228T124731 comment=NONE</div><div class="line">channel ORA_DISK_1: backup <span class="built_in">set</span> complete, elapsed time: 00:00:01</div><div class="line">Finished backup at 28-FEB-17</div><div class="line"></div><div class="line">RMAN&gt;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>查看控制文件备份<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; LIST BACKUP OF CONTROLFILE;</div><div class="line"></div><div class="line">List of Backup Sets</div><div class="line">===================</div><div class="line"></div><div class="line">BS Key  Type LV Size       Device Type Elapsed Time Completion Time</div><div class="line">------- ---- -- ---------- ----------- ------------ ---------------</div><div class="line">2       Full    9.39M      DISK        00:00:05     28-FEB-17      </div><div class="line">        BP Key: 2   Status: AVAILABLE  Compressed: NO  Tag: TAG20170228T105613</div><div class="line">        Piece Name: /u01/app/oracle/product/11.2.0.4/db_1/dbs/02rtn428_1_1</div><div class="line">  Control File Included: Ckp SCN: 37645877     Ckp time: 28-FEB-17</div><div class="line"></div><div class="line">BS Key  Type LV Size       Device Type Elapsed Time Completion Time</div><div class="line">------- ---- -- ---------- ----------- ------------ ---------------</div><div class="line">5       Full    9.36M      DISK        00:00:01     28-FEB-17      </div><div class="line">        BP Key: 5   Status: AVAILABLE  Compressed: NO  Tag: TAG20170228T124731</div><div class="line">        Piece Name: /u01/app/oracle/product/11.2.0.4/db_1/dbs/05rtn873_1_1</div><div class="line">  Control File Included: Ckp SCN: 37648397     Ckp time: 28-FEB-17</div><div class="line"></div><div class="line">RMAN&gt;</div></pre></td></tr></table></figure></p>
<ol>
<li>归档文件的备份<br>归档日志对于数据库介质恢复相当关键，只要拥有相应的归档日志文件，就能确保我们将数据库恢复到备份之后的任意时刻。在RMAN中备份归档日志有以下两种方式：</li>
</ol>
<ul>
<li>利用BACKUP ARCHIVELOG命令备份<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; BACKUP ARCHIVELOG ALL;</div><div class="line"></div><div class="line">Starting backup at 28-FEB-17</div><div class="line">current <span class="built_in">log</span> archived</div><div class="line">using channel ORA_DISK_1</div><div class="line">channel ORA_DISK_1: starting archived <span class="built_in">log</span> backup <span class="built_in">set</span></div><div class="line">channel ORA_DISK_1: specifying archived <span class="built_in">log</span>(s) <span class="keyword">in</span> backup <span class="built_in">set</span></div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=868 RECID=1 STAMP=937050974</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=871 RECID=2 STAMP=937050978</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=872 RECID=3 STAMP=937050981</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=873 RECID=4 STAMP=937052764</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=874 RECID=5 STAMP=937052771</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=875 RECID=6 STAMP=937073029</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=876 RECID=7 STAMP=937079244</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=877 RECID=8 STAMP=937087288</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=878 RECID=9 STAMP=937108830</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=879 RECID=10 STAMP=937124801</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=880 RECID=11 STAMP=937140632</div><div class="line">channel ORA_DISK_1: starting piece 1 at 28-FEB-17</div><div class="line">channel ORA_DISK_1: finished piece 1 at 28-FEB-17</div><div class="line">piece handle=/u01/app/oracle/product/11.2.0.4/db_1/dbs/06rtn8cp_1_1 tag=TAG20170228T125032 comment=NONE</div><div class="line">channel ORA_DISK_1: backup <span class="built_in">set</span> complete, elapsed time: 00:00:15</div><div class="line">Finished backup at 28-FEB-17</div><div class="line"></div><div class="line">RMAN&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>BACKUP ARCHIVELOG命令比较灵活，ALL是指备份当前所有可访问到的归档文件，你还可以通过UNTIL、SCN、TIME、SEQUENCE等参数灵活指定要备份的归档区间。</p>
<ul>
<li>执行BACKUP命令时指定PLUS ARCHIVELOG子句<br>在备份控制文件之前<strong>首先对所有归档文件进行备份</strong>，BACKUP…PLUS ARCHIVELOG命令在备份过程中会依次执行下列步骤:</li>
</ul>
<ol>
<li>运行ALTER SYSTEM ARCHIVE LOG CURRENT语句对当前 Redolog 进行归档</li>
<li>执行BACKUP ARCHIVELOG ALL命令备份所有已归档日志</li>
<li>执行BACKUP命令对指定项进行备份</li>
<li>再次运行ALTER SYSTEM ARCHIVE LOG CURRENT对当前 Redolog 归档</li>
<li>对新生成的尚未备份的归档文件进行备份<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; BACKUP CURRENT CONTROLFILE PLUS ARCHIVELOG;</div><div class="line"></div><div class="line">Starting backup at 28-FEB-17</div><div class="line">current <span class="built_in">log</span> archived</div><div class="line">using channel ORA_DISK_1</div><div class="line">channel ORA_DISK_1: starting archived <span class="built_in">log</span> backup <span class="built_in">set</span></div><div class="line">channel ORA_DISK_1: specifying archived <span class="built_in">log</span>(s) <span class="keyword">in</span> backup <span class="built_in">set</span></div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=868 RECID=1 STAMP=937050974</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=871 RECID=2 STAMP=937050978</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=872 RECID=3 STAMP=937050981</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=873 RECID=4 STAMP=937052764</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=874 RECID=5 STAMP=937052771</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=875 RECID=6 STAMP=937073029</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=876 RECID=7 STAMP=937079244</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=877 RECID=8 STAMP=937087288</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=878 RECID=9 STAMP=937108830</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=879 RECID=10 STAMP=937124801</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=880 RECID=11 STAMP=937140632</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=881 RECID=12 STAMP=937140870</div><div class="line">channel ORA_DISK_1: starting piece 1 at 28-FEB-17</div><div class="line">channel ORA_DISK_1: finished piece 1 at 28-FEB-17</div><div class="line">piece handle=/u01/app/oracle/product/11.2.0.4/db_1/dbs/07rtn8k6_1_1 tag=TAG20170228T125430 comment=NONE</div><div class="line">channel ORA_DISK_1: backup <span class="built_in">set</span> complete, elapsed time: 00:00:03</div><div class="line">Finished backup at 28-FEB-17</div><div class="line"></div><div class="line">Starting backup at 28-FEB-17</div><div class="line">using channel ORA_DISK_1</div><div class="line">channel ORA_DISK_1: starting full datafile backup <span class="built_in">set</span></div><div class="line">channel ORA_DISK_1: specifying datafile(s) <span class="keyword">in</span> backup <span class="built_in">set</span></div><div class="line">including current control file <span class="keyword">in</span> backup <span class="built_in">set</span></div><div class="line">channel ORA_DISK_1: starting piece 1 at 28-FEB-17</div><div class="line">channel ORA_DISK_1: finished piece 1 at 28-FEB-17</div><div class="line">piece handle=/u01/app/oracle/product/11.2.0.4/db_1/dbs/08rtn8ka_1_1 tag=TAG20170228T125434 comment=NONE</div><div class="line">channel ORA_DISK_1: backup <span class="built_in">set</span> complete, elapsed time: 00:00:01</div><div class="line">Finished backup at 28-FEB-17</div><div class="line"></div><div class="line">Starting backup at 28-FEB-17</div><div class="line">current <span class="built_in">log</span> archived</div><div class="line">using channel ORA_DISK_1</div><div class="line">channel ORA_DISK_1: starting archived <span class="built_in">log</span> backup <span class="built_in">set</span></div><div class="line">channel ORA_DISK_1: specifying archived <span class="built_in">log</span>(s) <span class="keyword">in</span> backup <span class="built_in">set</span></div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=882 RECID=13 STAMP=937140878</div><div class="line">channel ORA_DISK_1: starting piece 1 at 28-FEB-17</div><div class="line">channel ORA_DISK_1: finished piece 1 at 28-FEB-17</div><div class="line">piece handle=/u01/app/oracle/product/11.2.0.4/db_1/dbs/09rtn8ke_1_1 tag=TAG20170228T125438 comment=NONE</div><div class="line">channel ORA_DISK_1: backup <span class="built_in">set</span> complete, elapsed time: 00:00:01</div><div class="line">Finished backup at 28-FEB-17</div><div class="line"></div><div class="line">RMAN&gt;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>完成备份之后，可以通过下列命令查看已备份的归档日志片段<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; LIST BACKUP OF ARCHIVELOG ALL;</div><div class="line"></div><div class="line">List of Backup Sets</div><div class="line">===================</div><div class="line"></div><div class="line">BS Key  Size       Device Type Elapsed Time Completion Time</div><div class="line">------- ---------- ----------- ------------ ---------------</div><div class="line">6       319.98M    DISK        00:00:07     28-FEB-17      </div><div class="line">        BP Key: 6   Status: AVAILABLE  Compressed: NO  Tag: TAG20170228T125032</div><div class="line">        Piece Name: /u01/app/oracle/product/11.2.0.4/db_1/dbs/06rtn8cp_1_1</div><div class="line"></div><div class="line">  List of Archived Logs <span class="keyword">in</span> backup <span class="built_in">set</span> 6</div><div class="line">  Thrd Seq     Low SCN    Low Time  Next SCN   Next Time</div><div class="line">  ---- ------- ---------- --------- ---------- ---------</div><div class="line">  1    868     37498935   24-FEB-17 37505736   24-FEB-17</div><div class="line">  1    871     37537046   25-FEB-17 37548296   25-FEB-17</div><div class="line">  1    872     37548296   25-FEB-17 37574822   27-FEB-17</div><div class="line">  1    873     37574822   27-FEB-17 37577191   27-FEB-17</div><div class="line">  1    874     37577191   27-FEB-17 37577232   27-FEB-17</div><div class="line">  1    875     37577232   27-FEB-17 37592150   27-FEB-17</div><div class="line">  1    876     37592150   27-FEB-17 37596510   27-FEB-17</div><div class="line">  1    877     37596510   27-FEB-17 37607071   27-FEB-17</div><div class="line">  1    878     37607071   27-FEB-17 37631135   28-FEB-17</div><div class="line">  1    879     37631135   28-FEB-17 37638288   28-FEB-17</div><div class="line">  1    880     37638288   28-FEB-17 37648486   28-FEB-17</div><div class="line"></div><div class="line">BS Key  Size       Device Type Elapsed Time Completion Time</div><div class="line">------- ---------- ----------- ------------ ---------------</div><div class="line">7       319.98M    DISK        00:00:03     28-FEB-17      </div><div class="line">        BP Key: 7   Status: AVAILABLE  Compressed: NO  Tag: TAG20170228T125430</div><div class="line">        Piece Name: /u01/app/oracle/product/11.2.0.4/db_1/dbs/07rtn8k6_1_1</div><div class="line"></div><div class="line">  List of Archived Logs <span class="keyword">in</span> backup <span class="built_in">set</span> 7</div><div class="line">  Thrd Seq     Low SCN    Low Time  Next SCN   Next Time</div><div class="line">  ---- ------- ---------- --------- ---------- ---------</div><div class="line">  1    868     37498935   24-FEB-17 37505736   24-FEB-17</div><div class="line">  1    871     37537046   25-FEB-17 37548296   25-FEB-17</div><div class="line">  1    872     37548296   25-FEB-17 37574822   27-FEB-17</div><div class="line">  1    873     37574822   27-FEB-17 37577191   27-FEB-17</div><div class="line">  1    874     37577191   27-FEB-17 37577232   27-FEB-17</div><div class="line">  1    875     37577232   27-FEB-17 37592150   27-FEB-17</div><div class="line">  1    876     37592150   27-FEB-17 37596510   27-FEB-17</div><div class="line">  1    877     37596510   27-FEB-17 37607071   27-FEB-17</div><div class="line">  1    878     37607071   27-FEB-17 37631135   28-FEB-17</div><div class="line">  1    879     37631135   28-FEB-17 37638288   28-FEB-17</div><div class="line">  1    880     37638288   28-FEB-17 37648486   28-FEB-17</div><div class="line">  1    881     37648486   28-FEB-17 37648591   28-FEB-17</div><div class="line"></div><div class="line">BS Key  Size       Device Type Elapsed Time Completion Time</div><div class="line">------- ---------- ----------- ------------ ---------------</div><div class="line">9       2.50K      DISK        00:00:00     28-FEB-17      </div><div class="line">        BP Key: 9   Status: AVAILABLE  Compressed: NO  Tag: TAG20170228T125438</div><div class="line">        Piece Name: /u01/app/oracle/product/11.2.0.4/db_1/dbs/09rtn8ke_1_1</div><div class="line"></div><div class="line">  List of Archived Logs <span class="keyword">in</span> backup <span class="built_in">set</span> 9</div><div class="line">  Thrd Seq     Low SCN    Low Time  Next SCN   Next Time</div><div class="line">  ---- ------- ---------- --------- ---------- ---------</div><div class="line">  1    882     37648591   28-FEB-17 37648602   28-FEB-17</div><div class="line"></div><div class="line">RMAN&gt;</div></pre></td></tr></table></figure></p>
<ol>
<li><p>初始化参数文件的备份</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; BACKUP SPFILE;</div><div class="line"></div><div class="line">Starting backup at 28-FEB-17</div><div class="line">using channel ORA_DISK_1</div><div class="line">channel ORA_DISK_1: starting full datafile backup <span class="built_in">set</span></div><div class="line">channel ORA_DISK_1: specifying datafile(s) <span class="keyword">in</span> backup <span class="built_in">set</span></div><div class="line">including current SPFILE <span class="keyword">in</span> backup <span class="built_in">set</span></div><div class="line">channel ORA_DISK_1: starting piece 1 at 28-FEB-17</div><div class="line">channel ORA_DISK_1: finished piece 1 at 28-FEB-17</div><div class="line">piece handle=/u01/app/oracle/product/11.2.0.4/db_1/dbs/0artn91l_1_1 tag=TAG20170228T130141 comment=NONE</div><div class="line">channel ORA_DISK_1: backup <span class="built_in">set</span> complete, elapsed time: 00:00:01</div><div class="line">Finished backup at 28-FEB-17</div><div class="line"></div><div class="line">RMAN&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>对备份集备份</p>
</li>
</ol>
<ul>
<li><p>备份所有备份集</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; BACKUP BACKUPSET ALL;</div></pre></td></tr></table></figure>
</li>
<li><p>备份指定的备份集</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#n=备份集ID，可以同时指定多个，相互间以逗号分隔即可</span></div><div class="line">RMAN&gt; BACKUP BACKUPSET n;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>参考：<a href="http://blog.csdn.net/pan_tian/article/details/46766985" target="_blank" rel="external">http://blog.csdn.net/pan_tian/article/details/46766985</a></p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/02/28/Oracle数据库备份与恢复-RMAN备份/">http://www.yfshare.vip/2017/02/28/Oracle数据库备份与恢复-RMAN备份/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Oracle数据库备份与恢复 - RMAN恢复]]></title>
      <url>http://www.yfshare.vip/2017/02/28/Oracle%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D-RMAN%E6%81%A2%E5%A4%8D/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><h2 id="RMAN恢复原理"><a href="#RMAN恢复原理" class="headerlink" title="RMAN恢复原理"></a>RMAN恢复原理</h2><p>首先还是得理解Oracle数据库恢复的一个原理。数据库恢复是指将数据库恢复到一个一致性的状态，整个恢复操作可以分为两个步骤，数据库修复（RESTORE）和恢复（RECOVER）<br><a href="https://docs.oracle.com/cd/B19306_01/backup.102/b14192/recov001.htm" target="_blank" rel="external">Oracle官方文档</a>上关于Restore和Recover的解释：<br> The two most important RMAN commands used in database recovery are:  </p>
<ul>
<li>RESTORE, which retrieves files from RMAN backups based on the contents of the RMAN repository</li>
<li><p>RECOVER, which performs complete or point-in-time media recovery using available datafiles and redo logs.<br>Restore是指将要恢复的文件从备份集中读取出来。<br>Recover是指应用所有重做日志，将数据库恢复到崩溃前的状态，或者应用部分REDO，将数据库恢复到指定的时间点。<br><img src="http://note.youdao.com/yws/api/personal/file/1D33C7DE579145B8A0B4B2527036349C?method=download&amp;shareKey=839a02001f760c7413f2370bc57a0092" alt="image"><br>上图是一个最典型的恢复过程，数据库在SCN=100时执行了数据库备份，在SCN=500时数据库出现介质错误，需要通过备份进行恢复  </p>
<p>操作步骤：  </p>
</li>
</ul>
<ol>
<li>首先使用SCN=100时创建的数据库备份将数据库恢复到备份时的状态，这个操作就是修复（RESTORE）</li>
<li>然后重新应用SCN 100～500之间生成的所有重做日志，这个操作就是恢复（RECOVER），最后数据库被恢复到崩溃前的状态。<br>由上可知，Oracle数据库中的备份恢复必然是先有备份，然后才能做恢复的操作。不管是RMAN备份恢复，或者是用户管理的备份和恢复，恢复操作都是从备份时间点向前进行恢复，不可能直接将当前状态向后恢复到之前的某个时间点（Oracle 10g R2新推出的Flashback Database特性开始支持，直接从当前时间点向之前的时间点恢复）</li>
</ol>
<h2 id="RMAN如何选择备份集"><a href="#RMAN如何选择备份集" class="headerlink" title="RMAN如何选择备份集"></a>RMAN如何选择备份集</h2><p>很多新接触RMAN的朋友都会有这样的疑问：我执行过很多次备份，早也备份是晚也备份，昨天也备份今天也备份，在恢复的时候，RMAN怎么知道从哪个备份集中选择文件用来恢复呢？<br>答案其实很简单，RMAN一开始也不知道，它只是遵循固定的规则，按照你的要求去寻找合适的备份集罢了，<strong>首先是寻找最近的可用的备份集</strong>（如果没有指定UNTIL子句则从最近的备份开始，如果指定了UNTIL，则从满足UNTIL的备份集开始），<strong>如果能找到，那么运气不错，恢复将会继续正常进行，如果找到了多个，还有更加细致的规则，从中选择一个RMAN觉着最优的备份集来做恢复</strong>（如优先选择镜像复制，因为RMAN认为这样恢复时会更快）。如果最终一个备份集都没找到，嘿嘿，那就只有一个选择了：报错  </p>
<h2 id="RMAN能做哪些恢复"><a href="#RMAN能做哪些恢复" class="headerlink" title="RMAN能做哪些恢复"></a>RMAN能做哪些恢复</h2><p>之前的文章<a href="https://yfshare.github.io/2017/02/28/Oracle数据库备份与恢复-RMAN备份/" target="_blank" rel="external">Oracle数据库备份与恢复 - RMAN备份</a>里有写到RMAN可以做多种备份，包括：</p>
<ol>
<li>整库备份；</li>
<li>表空间的备份；</li>
<li>数据文件的备份；</li>
<li>控制文件备份；</li>
<li>归档文件的备份；</li>
<li>初始化参数文件的备份；  </li>
<li>对备份集备份；  </li>
</ol>
<p>对于恢复，RMAN中提供了多种不同级别的恢复方式，可以恢复整个数据库，恢复某个或某几个表空间，某个或某几个数据文件，单独恢复控制文件，初始化参数文件，或者归档文件等等。能用RMAN备份的都能恢复</p>
<h2 id="RMAN之恢复"><a href="#RMAN之恢复" class="headerlink" title="RMAN之恢复"></a>RMAN之恢复</h2><ol>
<li>对数据库进行完全恢复  </li>
</ol>
<p>如果当前数据库只剩下控制文件和SPFILE，其他数据文件因为某些原因导致全部丢失，不过幸运的是之前创建过整库的备份，并且执行备份操作之后，所有的归档文件和重做日志文件都还在，这种情况下你就可以将数据库恢复到崩溃前那一刻的状态，而这种恢复方式，就叫做完全介质恢复。<br>做数据库完全恢复，需要数据库处于MOUNT状态（如果数据库处于OPEN状态会报ORA-19573错误）<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#启动数据库到加载状态：</span></div><div class="line">RMAN&gt; STARTUP MOUNT;</div><div class="line"></div><div class="line">connected to target database (not started)</div><div class="line">Oracle instance started</div><div class="line">database mounted</div><div class="line"></div><div class="line">Total System Global Area    1071333376 bytes</div><div class="line"></div><div class="line">Fixed Size                     1375792 bytes</div><div class="line">Variable Size                637534672 bytes</div><div class="line">Database Buffers             427819008 bytes</div><div class="line">Redo Buffers                   4603904 bytes</div></pre></td></tr></table></figure></p>
<p>执行恢复操作(恢复分两步，先执行RESTORE DATABASE;，在执行RECOVER DATABASE;)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; restore database;</div><div class="line"></div><div class="line">Starting restore at 15-JUL-15</div><div class="line">allocated channel: ORA_DISK_1</div><div class="line">channel ORA_DISK_1: SID=63 device <span class="built_in">type</span>=DISK</div><div class="line"></div><div class="line">channel ORA_DISK_1: restoring datafile 00001</div><div class="line">input datafile copy RECID=2 STAMP=884555266 file name=E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\DATAFILE\O1_MF_SYSTEM_BSTBH904_.DBF</div><div class="line">destination <span class="keyword">for</span> restore of datafile 00001: E:\APP\TIANPAN\ORADATA\PTIAN\SYSTEM01.DBF</div><div class="line">channel ORA_DISK_1: copied datafile copy of datafile 00001</div><div class="line">output file name=E:\APP\TIANPAN\ORADATA\PTIAN\SYSTEM01.DBF RECID=0 STAMP=0</div><div class="line">channel ORA_DISK_1: restoring datafile 00002</div><div class="line">input datafile copy RECID=3 STAMP=884555292 file name=E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\DATAFILE\O1_MF_SYSAUX_BSTBJDFQ_.DBF</div><div class="line">destination <span class="keyword">for</span> restore of datafile 00002: E:\APP\TIANPAN\ORADATA\PTIAN\SYSAUX01.DBF</div><div class="line">channel ORA_DISK_1: copied datafile copy of datafile 00002</div><div class="line">output file name=E:\APP\TIANPAN\ORADATA\PTIAN\SYSAUX01.DBF RECID=0 STAMP=0</div><div class="line">channel ORA_DISK_1: restoring datafile 00003</div><div class="line">input datafile copy RECID=4 STAMP=884555305 file name=E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\DATAFILE\O1_MF_UNDOTBS1_BSTBK5V1_.DBF</div><div class="line">destination <span class="keyword">for</span> restore of datafile 00003: E:\APP\TIANPAN\ORADATA\PTIAN\UNDOTBS01.DBF</div><div class="line">channel ORA_DISK_1: copied datafile copy of datafile 00003</div><div class="line">output file name=E:\APP\TIANPAN\ORADATA\PTIAN\UNDOTBS01.DBF RECID=0 STAMP=0</div><div class="line">channel ORA_DISK_1: restoring datafile 00004</div><div class="line">input datafile copy RECID=7 STAMP=884555314 file name=E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\DATAFILE\O1_MF_USERS_BSTBKKVB_.DBF</div><div class="line">destination <span class="keyword">for</span> restore of datafile 00004: E:\APP\TIANPAN\ORADATA\PTIAN\USERS01.DBF</div><div class="line">channel ORA_DISK_1: copied datafile copy of datafile 00004</div><div class="line">output file name=E:\APP\TIANPAN\ORADATA\PTIAN\USERS01.DBF RECID=0 STAMP=0</div><div class="line">channel ORA_DISK_1: restoring datafile 00005</div><div class="line">input datafile copy RECID=5 STAMP=884555312 file name=E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\DATAFILE\O1_MF_EXAMPLE_BSTBKF80_.DBF</div><div class="line">destination <span class="keyword">for</span> restore of datafile 00005: E:\APP\TIANPAN\ORADATA\PTIAN\EXAMPLE01.DBF</div><div class="line">channel ORA_DISK_1: copied datafile copy of datafile 00005</div><div class="line">output file name=E:\APP\TIANPAN\ORADATA\PTIAN\EXAMPLE01.DBF RECID=0 STAMP=0</div><div class="line">Finished restore at 15-JUL-15</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; RECOVER DATABASE;</div><div class="line"></div><div class="line">Starting recover at 15-JUL-15</div><div class="line">using channel ORA_DISK_1</div><div class="line"></div><div class="line">starting media recovery</div><div class="line"></div><div class="line">archived <span class="built_in">log</span> <span class="keyword">for</span> thread 1 with sequence 105 is already on disk as file E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_09\O1_MF_1_105_BSWC39YH_.ARC</div><div class="line">archived <span class="built_in">log</span> <span class="keyword">for</span> thread 1 with sequence 106 is already on disk as file E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_10\O1_MF_1_106_BSYCRLNG_.ARC</div><div class="line">archived <span class="built_in">log</span> <span class="keyword">for</span> thread 1 with sequence 107 is already on disk as file E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_11\O1_MF_1_107_BT10F9Y9_.ARC</div><div class="line">archived <span class="built_in">log</span> <span class="keyword">for</span> thread 1 with sequence 108 is already on disk as file E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_11\O1_MF_1_108_BT1M9PW5_.ARC</div><div class="line">archived <span class="built_in">log</span> <span class="keyword">for</span> thread 1 with sequence 109 is already on disk as file E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_15\O1_MF_1_109_BTCH29LR_.ARC</div><div class="line">archived <span class="built_in">log</span> file name=E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_09\O1_MF_1_105_BSWC39YH_.ARC thread=1 sequence=105</div><div class="line">archived <span class="built_in">log</span> file name=E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_10\O1_MF_1_106_BSYCRLNG_.ARC thread=1 sequence=106</div><div class="line">archived <span class="built_in">log</span> file name=E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_11\O1_MF_1_107_BT10F9Y9_.ARC thread=1 sequence=107</div><div class="line">media recovery complete, elapsed time: 00:00:22</div><div class="line">Finished recover at 15-JUL-15</div><div class="line"></div><div class="line">RMAN&gt;</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#打开数据库： </span></div><div class="line">RMAN&gt;  ALTER DATABASE OPEN;</div><div class="line"></div><div class="line">database opened</div><div class="line"></div><div class="line">RMAN&gt;</div></pre></td></tr></table></figure>
<ol>
<li>表空间恢复  </li>
</ol>
<p>在执行恢复之前，如果被操作的表空间未处于OFFLINE状态，必须首先通过ALTER TABLESPACE tablespace_name OFFLINE语句将其置为脱机<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">SQL&gt; select * from v<span class="variable">$tablespace</span>;</div><div class="line">       TS<span class="comment"># NAME                           INCLUDED_IN_DATABASE_BACKUP BIGFILE FLASHBACK_ON ENCRYPT_IN_BACKUP</span></div><div class="line">---------- ------------------------------ --------------------------- ------- ------------ -----------------</div><div class="line">         0 SYSTEM                         YES                         NO      YES          </div><div class="line">         1 SYSAUX                         YES                         NO      YES          </div><div class="line">         2 UNDOTBS1                       YES                         NO      YES          </div><div class="line">         4 USERS                          YES                         NO      YES          </div><div class="line">         3 TEMP                           NO                          NO      YES          </div><div class="line">         6 EXAMPLE                        YES                         NO      YES          </div><div class="line">6 rows selected</div><div class="line">SQL&gt;</div></pre></td></tr></table></figure></p>
<p>以恢复Example表空间为例<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">操作步骤如下： </div><div class="line">RMAN&gt; SQL <span class="string">'ALTER TABLESPACE EXAMPLE OFFLINE IMMEDIATE'</span>; </div><div class="line">RMAN&gt; RESTORE TABLESPACE EXAMPLE; </div><div class="line">RMAN&gt; RECOVER TABLESPACE EXAMPLE; </div><div class="line">RMAN&gt; SQL <span class="string">'ALTER TABLESPACE  EXAMPLE ONLINE'</span>;</div></pre></td></tr></table></figure></p>
<p>上述执行的四个脚本，表示将表空间置于OFFLINE状态，执行RESTORE命令，执行RECOVER命令，最后将表空间置为ONLINE状态<br>示例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; SQL <span class="string">'ALTER TABLESPACE EXAMPLE OFFLINE IMMEDIATE'</span>;</div><div class="line"></div><div class="line">sql statement: ALTER TABLESPACE EXAMPLE OFFLINE IMMEDIATE</div><div class="line"></div><div class="line">RMAN&gt; RESTORE TABLESPACE EXAMPLE;</div><div class="line"></div><div class="line">Starting restore at 15-JUL-15</div><div class="line">using channel ORA_DISK_1</div><div class="line"></div><div class="line">channel ORA_DISK_1: restoring datafile 00005</div><div class="line">input datafile copy RECID=5 STAMP=884555312 file name=E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\DATAFILE\O1_MF_EXAMPLE_BSTBKF80_.DBF</div><div class="line">destination <span class="keyword">for</span> restore of datafile 00005: E:\APP\TIANPAN\ORADATA\PTIAN\EXAMPLE01.DBF</div><div class="line">channel ORA_DISK_1: copied datafile copy of datafile 00005</div><div class="line">output file name=E:\APP\TIANPAN\ORADATA\PTIAN\EXAMPLE01.DBF RECID=0 STAMP=0</div><div class="line">Finished restore at 15-JUL-15</div><div class="line"></div><div class="line">RMAN&gt; RECOVER TABLESPACE EXAMPLE;</div><div class="line"></div><div class="line">Starting recover at 15-JUL-15</div><div class="line">using channel ORA_DISK_1</div><div class="line"></div><div class="line">starting media recovery</div><div class="line"></div><div class="line">archived <span class="built_in">log</span> <span class="keyword">for</span> thread 1 with sequence 105 is already on disk as file E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_09\O1_MF_1_105_BSWC39YH_.ARC</div><div class="line">archived <span class="built_in">log</span> <span class="keyword">for</span> thread 1 with sequence 106 is already on disk as file E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_10\O1_MF_1_106_BSYCRLNG_.ARC</div><div class="line">archived <span class="built_in">log</span> <span class="keyword">for</span> thread 1 with sequence 107 is already on disk as file E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_11\O1_MF_1_107_BT10F9Y9_.ARC</div><div class="line">archived <span class="built_in">log</span> <span class="keyword">for</span> thread 1 with sequence 108 is already on disk as file E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_11\O1_MF_1_108_BT1M9PW5_.ARC</div><div class="line">archived <span class="built_in">log</span> <span class="keyword">for</span> thread 1 with sequence 109 is already on disk as file E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_15\O1_MF_1_109_BTCH29LR_.ARC</div><div class="line">archived <span class="built_in">log</span> file name=E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_09\O1_MF_1_105_BSWC39YH_.ARC thread=1 sequence=105</div><div class="line">archived <span class="built_in">log</span> file name=E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_10\O1_MF_1_106_BSYCRLNG_.ARC thread=1 sequence=106</div><div class="line">archived <span class="built_in">log</span> file name=E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_11\O1_MF_1_107_BT10F9Y9_.ARC thread=1 sequence=107</div><div class="line">media recovery complete, elapsed time: 00:00:03</div><div class="line">Finished recover at 15-JUL-15</div><div class="line"></div><div class="line">RMAN&gt; SQL <span class="string">'ALTER TABLESPACE  EXAMPLE ONLINE'</span>;</div><div class="line"></div><div class="line">sql statement: ALTER TABLESPACE  EXAMPLE ONLINE</div><div class="line"></div><div class="line">RMAN&gt;</div></pre></td></tr></table></figure></p>
<ol>
<li>数据文件的恢复  </li>
</ol>
<p>恢复表空间实际就是恢复其所对应的数据文件（一个表空间可能对应多个数据文件），因此恢复数据文件的操作步骤与上极其相似<br>同样在恢复操作之前，如果需要被恢复的数据文件未处于OFFLINE状态，需要通过ALTER DATABASE DATAFILE … OFFLINE语句将其置为脱机。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">SQL&gt;  select file<span class="comment">#, name,status, enabled from v$datafile;</span></div><div class="line">     FILE<span class="comment"># NAME                                                                             STATUS  ENABLED</span></div><div class="line">---------- -------------------------------------------------------------------------------- ------- ----------</div><div class="line">         1 E:\APP\TIANPAN\ORADATA\PTIAN\SYSTEM01.DBF                                        SYSTEM  READ WRITE</div><div class="line">         2 E:\APP\TIANPAN\ORADATA\PTIAN\SYSAUX01.DBF                                        ONLINE  READ WRITE</div><div class="line">         3 E:\APP\TIANPAN\ORADATA\PTIAN\UNDOTBS01.DBF                                       ONLINE  READ WRITE</div><div class="line">         4 E:\APP\TIANPAN\ORADATA\PTIAN\USERS01.DBF                                         ONLINE  READ WRITE</div><div class="line">         5 E:\APP\TIANPAN\ORADATA\PTIAN\EXAMPLE01.DBF                                       ONLINE  READ WRITE</div><div class="line"></div><div class="line">SQL&gt;</div></pre></td></tr></table></figure></p>
<p>以恢复datafile 5为例<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; SQL <span class="string">'ALTER DATABASE DATAFILE 5 OFFLINE'</span>; </div><div class="line">RMAN&gt; RESTORE DATAFILE 5; </div><div class="line">RMAN&gt; RECOVER DATAFILE 5; </div><div class="line">RMAN&gt; SQL <span class="string">'ALTER DATABASE DATAFILE 5 ONLINE'</span>;</div></pre></td></tr></table></figure></p>
<p>示例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; SQL <span class="string">'ALTER DATABASE DATAFILE 5 OFFLINE'</span>;</div><div class="line"></div><div class="line">sql statement: ALTER DATABASE DATAFILE 5 OFFLINE</div><div class="line"></div><div class="line">RMAN&gt; RESTORE DATAFILE 5;</div><div class="line"></div><div class="line">Starting restore at 15-JUL-15</div><div class="line">using channel ORA_DISK_1</div><div class="line"></div><div class="line">channel ORA_DISK_1: restoring datafile 00005</div><div class="line">input datafile copy RECID=5 STAMP=884555312 file name=E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\DATAFILE\O1_MF_EXAMPLE_BSTBKF80_.DBF</div><div class="line">destination <span class="keyword">for</span> restore of datafile 00005: E:\APP\TIANPAN\ORADATA\PTIAN\EXAMPLE01.DBF</div><div class="line">channel ORA_DISK_1: copied datafile copy of datafile 00005</div><div class="line">output file name=E:\APP\TIANPAN\ORADATA\PTIAN\EXAMPLE01.DBF RECID=0 STAMP=0</div><div class="line">Finished restore at 15-JUL-15</div><div class="line"></div><div class="line">RMAN&gt; RECOVER DATAFILE 5;</div><div class="line"></div><div class="line">Starting recover at 15-JUL-15</div><div class="line">using channel ORA_DISK_1</div><div class="line"></div><div class="line">starting media recovery</div><div class="line"></div><div class="line">archived <span class="built_in">log</span> <span class="keyword">for</span> thread 1 with sequence 105 is already on disk as file E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_09\O1_MF_1_105_BSWC39YH_.ARC</div><div class="line">archived <span class="built_in">log</span> <span class="keyword">for</span> thread 1 with sequence 106 is already on disk as file E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_10\O1_MF_1_106_BSYCRLNG_.ARC</div><div class="line">archived <span class="built_in">log</span> <span class="keyword">for</span> thread 1 with sequence 107 is already on disk as file E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_11\O1_MF_1_107_BT10F9Y9_.ARC</div><div class="line">archived <span class="built_in">log</span> <span class="keyword">for</span> thread 1 with sequence 108 is already on disk as file E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_11\O1_MF_1_108_BT1M9PW5_.ARC</div><div class="line">archived <span class="built_in">log</span> <span class="keyword">for</span> thread 1 with sequence 109 is already on disk as file E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_15\O1_MF_1_109_BTCH29LR_.ARC</div><div class="line">archived <span class="built_in">log</span> file name=E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_09\O1_MF_1_105_BSWC39YH_.ARC thread=1 sequence=105</div><div class="line">archived <span class="built_in">log</span> file name=E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_10\O1_MF_1_106_BSYCRLNG_.ARC thread=1 sequence=106</div><div class="line">archived <span class="built_in">log</span> file name=E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_11\O1_MF_1_107_BT10F9Y9_.ARC thread=1 sequence=107</div><div class="line">media recovery complete, elapsed time: 00:00:04</div><div class="line">Finished recover at 15-JUL-15</div><div class="line"></div><div class="line">RMAN&gt; SQL <span class="string">'ALTER DATABASE DATAFILE 5 ONLINE'</span>;</div><div class="line"></div><div class="line">sql statement: ALTER DATABASE DATAFILE 5 ONLINE</div><div class="line"></div><div class="line">RMAN&gt;</div></pre></td></tr></table></figure></p>
<ol>
<li>归档日志文件的恢复  </li>
</ol>
<p>恢复归档文件也是使用RESTORE命令，如果只是为了在恢复数据文件后应用归档文件，那并不需要手动对归档文件进行恢复，RMAN会在RECOVER的时候自动对适当的归档进行恢复<br>恢复归档文件也非常灵活，RMAN的RECOVER命令中提供了多种限定条件，可以精确指定恢复哪些备份的归档文件，例如，恢复归档序号为20到30之间的归档文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; RESTORE ARCHIVELOG SEQUENCE BETWEEN 20 AND 30;</div></pre></td></tr></table></figure></p>
<p>示例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; RUN&#123; </div><div class="line">2&gt; SET ARCHIVELOG DESTINATION TO <span class="string">'F:\ORACLE\BACKUP\ARCLOG1'</span>; </div><div class="line">3&gt; RESTORE ARCHIVELOG SEQUENCE BETWEEN 15 AND 20; </div><div class="line">4&gt; SET ARCHIVELOG DESTINATION TO <span class="string">'F:\ORACLE\BACKUP\ARCLOG2'</span>; </div><div class="line">5&gt; RESTORE ARCHIVELOG SEQUENCE BETWEEN 21 AND 30; </div><div class="line">6&gt; SET ARCHIVELOG DESTINATION TO <span class="string">'F:\ORACLE\BACKUP\ARCLOG3'</span>; </div><div class="line">7&gt; RESTORE ARCHIVELOG SEQUENCE BETWEEN 31 AND 40;  </div><div class="line">8&gt; &#125;</div></pre></td></tr></table></figure></p>
<ol>
<li>控制文件的恢复  </li>
</ol>
<p>Oracle数据库的控制文件个头不大（最大不超过20000个数据块），Oracle数据库实例启动后（即启动到NOMOUNT模式），要通过加载控制文件确定数据文件、重做日志文件的路径（进入到MOUNT模式），然后才能打开数据库（Finally，OPEN数据库）。因此，没有了控制文件，想顺利启动Oracle数据库是不可能的。<br>控制文件中并不是只有数据文件和重做日志文件的路径，还包括数据库名称、数据库创建信息、表空间信息、数据文件状态、日志文件信息、备份信息、检查点信息等。<br>该文件不仅在数据库启动过程中需要，在Oracle数据库运行过程中，控制文件也需要发挥重要作用，如记录检查点的相关信息、归档文件路径、备份信息（假如采用RMAN执行备份的话），以及数据库发生结构修改（流行词汇形容叫领导班子调整，类似添加删除表空间、数据文件、日志文件）等操作都需要同步到控制文件。如果在Oracle数据库运行过程中，由于某些原因导致控制文件无法访问，则数据库也无法继续正常工作。<br>控制文件是一个二进制文件，不能直接通过文本编辑工具修改，一般这个文件中的内容都是由Oracle自行维护。一个Oracle数据库至少要拥有一个控制文件，鉴于其重要地位，Oracle对其的保护有加，在默认情况下，控制文件就会有两、三份冗余（就是一模一样的文件存在两、三份），这几份文件的一致性由Oracle自动维护，冗余的数量和冗余文件的位置可以由DBA指定，Oracle建议控制文件至少要有两份冗余，并且存储在不同的磁盘中，以提高该文件的可用性。  </p>
<p>查询当前数据库拥有的控制文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">SQL&gt; SELECT NAME FROM V<span class="variable">$CONTROLFILE</span>; </div><div class="line"></div><div class="line">NAME</div><div class="line">--------------------------------------------------------------------------------</div><div class="line">/u01/data/orcl/control01.ctl</div><div class="line">/u01/data/orcl/control02.ctl</div><div class="line"></div><div class="line">SQL&gt; SHOW PARAMETER CONTROL_FILES;</div><div class="line"></div><div class="line">NAME				     TYPE	 VALUE</div><div class="line">------------------------------------ ----------- ------------------------------</div><div class="line">control_files			     string	 /u01/data/orcl/control01.ctl,</div><div class="line">						 /u01/data/orcl/control02.ctl</div><div class="line">SQL&gt;</div></pre></td></tr></table></figure></p>
<p>如果通知文件丢失，可以通过以下集中方式恢复：</p>
<ul>
<li>从自动备份中恢复  </li>
</ul>
<p>由于没有了控制文件，目标数据库只能启动到NOMOUNT状态，不过在启动数据库之前，必须首先通过SET命令设置DBID：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#获取数据库的DBID</span></div><div class="line">SQL&gt; SELECT DBID FROM V<span class="variable">$DATABASE</span>;</div><div class="line"></div><div class="line">      DBID</div><div class="line">----------</div><div class="line">1455780274</div><div class="line"></div><div class="line">SQL&gt;</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; SET DBID=1455780274;</div><div class="line">RMAN&gt; STARTUP NOMOUNT;</div><div class="line">RMAN&gt; RESTORE CONTROLFILE FROM AUTOBACKUP;</div></pre></td></tr></table></figure>
<ul>
<li>从备份集中恢复</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#在启动数据库之前，必须首先通过SET命令设置DBID</span></div><div class="line">RMAN&gt; SET DBID=1415261003;</div><div class="line">RMAN&gt; STARTUP NOMOUNT;</div><div class="line"><span class="comment">#指定控制文件所在备份片段的详细路径</span></div><div class="line">RMAN&gt; RESTORE CONTROLFILE FROM <span class="string">'/u01/app/oracle/product/11.2.0.4/db_1/dbs/05rtn873_1_1'</span>;</div></pre></td></tr></table></figure>
<ul>
<li>还有一种极端的情况，没有备份过控制文件，这时不凑巧的是，控制文件居然坏了。这时我们可以采用<a href="https://yfshare.github.io/2017/02/27/重建oracle控制文件/" target="_blank" rel="external">重构oracle的控制文件来恢复，参考这里</a></li>
</ul>
<ol>
<li>SPFILE初始化参数文件  </li>
</ol>
<p>虽然DBA可以通过BACKUP SPFILE命令手动备份服务器端的初始化参数文件，不过一般都不会主动执行，因为RMAN在备份控制文件时会自动备份SPFILE<br>相对于其他文件的备份，SPFILE最不重要（或者说最容易被恢复）。除了可以通过备份方式保障拥有可用的SPFILE外，数据库在运行过程中也会在Alert文件中留下数据库启动时的初始化参数信息。甚至即使这些都丢失了也没有关系，如果你对数据库足够了解，还是能够手动地创建出一份SPFILE出来，只是麻烦一些罢了。即使是运行中的数据库丢失了SPFILE也不会导致数据库崩溃（只不过下次启动时如果还没有能创建出一份来，数据库就起不来。</p>
<p>通过RMAN恢复初始化参数的过程与恢复控制文件极其类似<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; SET DBID=1415261003;</div><div class="line">RMAN&gt; STARTUP NOMOUNT;</div><div class="line"><span class="comment">#执行恢复命令，将SPFILE恢复到默认路径下</span></div><div class="line">RMAN&gt; RESTORE SPFILE FROM AUTOBACKUP;</div></pre></td></tr></table></figure></p>
<p>参考：<a href="http://blog.csdn.net/pan_tian/article/details/46896017" target="_blank" rel="external">http://blog.csdn.net/pan_tian/article/details/46896017</a></p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/02/28/Oracle数据库备份与恢复-RMAN恢复/">http://www.yfshare.vip/2017/02/28/Oracle数据库备份与恢复-RMAN恢复/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[重建oracle控制文件]]></title>
      <url>http://www.yfshare.vip/2017/02/27/%E9%87%8D%E5%BB%BAoracle%E6%8E%A7%E5%88%B6%E6%96%87%E4%BB%B6/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>环境：CentOS 6.6<br>　　　oracle 11.2.0.4.0  </p>
<p>前几天开发一都比调试存储过程时开了DEBUG，把测试服务器直接搞挂了，最后把测试服务器搞起来了，结果发现oracle数据库也挂了，原因是oracle的控制文件 control02.ctl 损坏了，因为是测试环境，所以没有备份…xxx<br><a id="more"></a><br>控制文件（control file）是一个相当小的文件（最多能增长到64M左右），其中包含Oracle需要的其他文件的一个目录。参数文件告知实例控制文件的位置，控制文件则告知示例数据库和在线重做日志文件的位置。控制文件还告知了Oracle其他一些事情，如已发生检查点的有关信息、数据库名（必须和db_name参数匹配）、创建数据库的时间戳、归档重做日志的历史（有时这会让控制文件变大）、RMAN信息等。<br>控制文件应该通过硬件（RAID）多路保存，如果不支持镜像，则要通过Oracle多路保存。应该有不止一个副本，而且它们应该保存在不同的磁盘上，以防止万一出现磁盘故障而丢失控制文件。丢失控制文件并不是致命的，但是会使恢复变得困难很多。<br>如果丢失了所有的控制文件并且没有任何的备份，我们可以通过重建控制文件来打开数据库。其中，重建控制文件至少需要以下信息：  </p>
<ol>
<li>数据库名</li>
<li>字符集</li>
<li>数据文件名称</li>
<li>初始化参数，包括MAXLOGFILES、MAXLOGMEMBERS、MAXDATAFILES、MAXINSTANCES、MAXLOGHISTORY等；  </li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#查看oracle版本信息</span></div><div class="line">SQL&gt; select * from v<span class="variable">$version</span>;</div><div class="line"></div><div class="line">BANNER</div><div class="line">-----------------------------------------------------------------------------</div><div class="line">Oracle Database 11g Enterprise Edition Release 11.2.0.4.0 - 64bit Production</div><div class="line">PL/SQL Release 11.2.0.4.0 - Production</div><div class="line">CORE	11.2.0.4.0	Production</div><div class="line">TNS <span class="keyword">for</span> Linux: Version 11.2.0.4.0 - Production</div><div class="line">NLSRTL Version 11.2.0.4.0 - Production</div><div class="line"></div><div class="line">SQL&gt;</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#查看oracle控制文件位置</span></div><div class="line">SQL&gt; show parameter control_files</div><div class="line"></div><div class="line">NAME				     TYPE	 VALUE</div><div class="line">------------------------------------ ------- -----------</div><div class="line">control_files			     string	 /u01/data/orcl/control01.ctl,</div><div class="line">						 /u01/data/orcl/control02.ctl</div><div class="line">SQL&gt;</div></pre></td></tr></table></figure>
<p>如果oracle控制文件损坏，强制关闭数据库，然后重启数据库，报ORA-00205错误。需要注意的是，此时执行shutdown immediate命令，数据库无法正常关闭，只能关闭到mounted状态；需要使用shutdown abort命令强制关闭数据库。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">SQL&gt; shutdown immediate</div><div class="line">Database closed.</div><div class="line">ORA-00210: cannot open the specified control file</div><div class="line">ORA-00202: control file: <span class="string">'/u01/data/orcl/control02.ctl'</span></div><div class="line">ORA-27041: unable to open file</div><div class="line">Linux Error: 2: No such file or directory</div><div class="line">Additional information: 3</div><div class="line"></div><div class="line">SQL&gt; select status from v<span class="variable">$instance</span>;</div><div class="line"></div><div class="line">STATUS</div><div class="line">------------</div><div class="line">MOUNTED</div><div class="line"></div><div class="line">SQL&gt; shutdown abort</div><div class="line">ORACLE instance shut down.</div><div class="line">SQL&gt; </div><div class="line">SQL&gt; startup</div><div class="line">ORACLE instance started.</div><div class="line"></div><div class="line">Total System Global Area 941600768 bytes</div><div class="line">Fixed Size 1348860 bytes</div><div class="line">Variable Size 515902212 bytes</div><div class="line">Database Buffers 419430400 bytes</div><div class="line">Redo Buffers 4919296 bytes</div><div class="line">ORA-00205: error <span class="keyword">in</span> identifying control file, check alert <span class="built_in">log</span> <span class="keyword">for</span> more info</div><div class="line"></div><div class="line">SQL&gt;</div></pre></td></tr></table></figure></p>
<p>获取数据库名<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#生成文本格式的参数文件</span></div><div class="line">$ sqlplus / as sysdba</div><div class="line">SQL&gt; create pfile from spfile;</div><div class="line">File created.</div><div class="line">SQL&gt;</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#打开参数文件，查看db_name参数值，即为数据库名称  </span></div><div class="line">[oracle@orcl ~]$ <span class="built_in">cd</span> <span class="variable">$ORACLE_HOME</span>/dbs</div><div class="line">[oracle@orcl dbs]$ cat initorcl.ora </div><div class="line">orcl.__db_cache_size=1107296256</div><div class="line">orcl.__java_pool_size=16777216</div><div class="line">orcl.__large_pool_size=33554432</div><div class="line">orcl.__oracle_base=<span class="string">'/u01/app/oracle'</span><span class="comment">#ORACLE_BASE set from environment</span></div><div class="line">orcl.__pga_aggregate_target=1140850688</div><div class="line">orcl.__sga_target=2130706432</div><div class="line">orcl.__shared_io_pool_size=0</div><div class="line">orcl.__shared_pool_size=369098752</div><div class="line">orcl.__streams_pool_size=0</div><div class="line">*.audit_file_dest=<span class="string">'/u01/app/oracle/admin/orcl/adump'</span></div><div class="line">*.audit_trail=<span class="string">'db'</span></div><div class="line">*.compatible=<span class="string">'11.2.0.4.0'</span></div><div class="line">*.control_files=<span class="string">'/u01/data/orcl/control01.ctl'</span>,<span class="string">'/u01/data/orcl/control02.ctl'</span></div><div class="line">*.db_block_size=8192</div><div class="line">*.db_domain=<span class="string">''</span></div><div class="line">*.db_name=<span class="string">'orcl'</span>   <span class="comment">#oracle数据库名称</span></div><div class="line">*.diagnostic_dest=<span class="string">'/u01/app/oracle'</span></div><div class="line">*.dispatchers=<span class="string">'(PROTOCOL=TCP) (SERVICE=orclXDB)'</span></div><div class="line">*.memory_target=3267362816</div><div class="line">*.nls_language=<span class="string">'SIMPLIFIED CHINESE'</span></div><div class="line">*.open_cursors=300</div><div class="line">*.processes=1500</div><div class="line">*.remote_login_passwordfile=<span class="string">'EXCLUSIVE'</span></div><div class="line">*.sessions=1655</div><div class="line">*.undo_tablespace=<span class="string">'UNDOTBS1'</span></div><div class="line">[oracle@orcl dbs]$</div></pre></td></tr></table></figure>
<p>启动到nomount状态，获取字符集<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#需要执行查询语句select userenv('language') from dual;来获取字符集，因此需要将数据库启动到nomount状态</span></div><div class="line">SQL&gt; startup nomount</div><div class="line">ORACLE instance started.</div><div class="line"></div><div class="line">Total System Global Area 941600768 bytes</div><div class="line">Fixed Size 1348860 bytes</div><div class="line">Variable Size 515902212 bytes</div><div class="line">Database Buffers 419430400 bytes</div><div class="line">Redo Buffers 4919296 bytes</div><div class="line">SQL&gt; </div><div class="line">SQL&gt; select userenv(<span class="string">'language'</span>) from dual;   </div><div class="line"></div><div class="line">USERENV(<span class="string">'LANGUAGE'</span>)</div><div class="line">----------------------------------------------------</div><div class="line">SIMPLIFIED CHINESE_CHINA.US7ASCII</div><div class="line"></div><div class="line">SQL&gt;</div></pre></td></tr></table></figure></p>
<p>获取数据文件名称<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">SQL&gt; select FILE_NAME,TABLESPACE_NAME from dba_data_files;</div><div class="line"></div><div class="line">FILE_NAME			    TABLESPACE_NAME</div><div class="line">----------------------------------- ------------------------------</div><div class="line">/u01/data/orcl/dev_payboxdb.dbf     DEV_PAYBOXDB</div><div class="line">/u01/data/orcl/dev_paydb.dbf	    DEV_PAYDB</div><div class="line">/u01/data/orcl/PAYBOX_FG_PRO.dbf    PAYBOX_FG_PRO</div><div class="line">/u01/data/orcl/PAYBOX_TEST2SP.dbf   PAYBOX_TEST2SP</div><div class="line">/u01/data/orcl/ticket.dbf	    LOTTERYDB</div><div class="line">/u01/data/orcl/users01.dbf	    USERS</div><div class="line">/u01/data/orcl/undotbs01.dbf	    UNDOTBS1</div><div class="line">/u01/data/orcl/sysaux01.dbf	    SYSAUX</div><div class="line">/u01/data/orcl/system01.dbf	    SYSTEM</div><div class="line"></div><div class="line">9 rows selected.</div><div class="line"></div><div class="line">SQL&gt;</div><div class="line"><span class="comment">#获取数据库文件列表</span></div><div class="line">[oracle@orcl orcl]$ ls -lth</div><div class="line">总用量 8.1G</div><div class="line">-rw-r----- 1 oracle oinstall  51M 2月  27 15:09 redo02.log</div><div class="line">-rw-r----- 1 oracle oinstall 503M 2月  27 15:09 users01.dbf</div><div class="line">-rw-r----- 1 oracle oinstall 511M 2月  27 15:09 undotbs01.dbf</div><div class="line">-rw-r----- 1 oracle oinstall 3.7G 2月  27 15:07 system01.dbf</div><div class="line">-rw-r----- 1 oracle oinstall 1.3G 2月  27 15:06 sysaux01.dbf</div><div class="line">-rw-r----- 1 oracle oinstall 513M 2月  27 15:00 temp01.dbf</div><div class="line">-rw-r----- 1 oracle oinstall 501M 2月  27 12:31 ticket.dbf</div><div class="line">-rw-r----- 1 oracle oinstall 501M 2月  27 12:31 dev_payboxdb.dbf</div><div class="line">-rw-r----- 1 oracle oinstall 501M 2月  27 12:31 dev_paydb.dbf</div><div class="line">-rw-r----- 1 oracle oinstall 201M 2月  27 12:31 PAYBOX_TEST2SP.dbf</div><div class="line">-rw-r----- 1 oracle oinstall 201M 2月  27 12:31 PAYBOX_FG_PRO.dbf</div><div class="line">-rw-r----- 1 oracle oinstall  51M 2月  27 12:26 redo01.log</div><div class="line">-rw-r----- 1 oracle oinstall  51M 2月  27 12:26 redo03.log</div><div class="line">-rw-r----- 1 oracle oinstall  51M 2月  25 08:05 redo05.log</div><div class="line">-rw-r----- 1 oracle oinstall  51M 2月  25 06:00 redo04.log</div><div class="line">[oracle@orcl orcl]$</div></pre></td></tr></table></figure></p>
<p>生成创建控制文件脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#DATABASE后面的orcl是示例名，正确设置LOGFILE和DATAFILE的路径及名称，字符集</span></div><div class="line">[oracle@orcl orcl]$ cat create_control.sql </div><div class="line">STARTUP NOMOUNT</div><div class="line">CREATE CONTROLFILE REUSE DATABASE orcl NORESETLOGS ARCHIVELOG</div><div class="line">    MAXLOGFILES 5</div><div class="line">    MAXLOGMEMBERS 3</div><div class="line">    MAXDATAFILES 100</div><div class="line">    MAXINSTANCES 1</div><div class="line">    MAXLOGHISTORY 226</div><div class="line">LOGFILE</div><div class="line">  GROUP 1 <span class="string">'/u01/data/orcl/redo01.log'</span> SIZE 50M,</div><div class="line">  GROUP 2 <span class="string">'/u01/data/orcl/redo02.log'</span> SIZE 50M,</div><div class="line">  GROUP 3 <span class="string">'/u01/data/orcl/redo03.log'</span> SIZE 50M</div><div class="line">DATAFILE</div><div class="line">  <span class="string">'/u01/data/orcl/system01.dbf'</span>,</div><div class="line">  <span class="string">'/u01/data/orcl/sysaux01.dbf'</span>,</div><div class="line">  <span class="string">'/u01/data/orcl/undotbs01.dbf'</span>,</div><div class="line">  <span class="string">'/u01/data/orcl/users01.dbf'</span>,</div><div class="line">  <span class="string">'/u01/data/orcl/ticket.dbf'</span>,</div><div class="line">  <span class="string">'/u01/data/orcl/PAYBOX_TEST2SP.dbf'</span>,</div><div class="line">  <span class="string">'/u01/data/orcl/PAYBOX_FG_PRO.dbf'</span>,</div><div class="line">  <span class="string">'/u01/data/orcl/dev_paydb.dbf'</span>,</div><div class="line">  <span class="string">'/u01/data/orcl/dev_payboxdb.dbf'</span></div><div class="line">CHARACTER SET US7ASCII</div><div class="line">;</div><div class="line">[oracle@orcl orcl]$</div></pre></td></tr></table></figure></p>
<p>重建控制文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#如果上述创建控制文件的脚本的DATAFILE中有系统临时文件，则会报下面的错误：</span></div><div class="line"><span class="comment">#创建控制文件脚本里面不能有左斜杠(\)，否则报错</span></div><div class="line"><span class="comment">#DATAFILE中不能有临时文件/u01/data/orcl/temp01.dbf</span></div><div class="line"><span class="comment">#如果执行出错，执行shutdown abort关闭数据库后，再执行创建控制文件的sql，因为执行了创建控制文件的sql会让oracle处理mount状态</span></div><div class="line">SQL&gt; @/u01/data/orcl/create_control.sql</div><div class="line">ORA-01081: cannot start already-running ORACLE - shut it down first</div><div class="line">CREATE CONTROLFILE REUSE DATABASE \<span class="string">"oracle\" NORESETLOGS ARCHIVELOG</span></div><div class="line">*</div><div class="line">ERROR at line 1:</div><div class="line">ORA-01503: CREATE CONTROLFILE failed</div><div class="line">ORA-01160: file is not a data file</div><div class="line">ORA-01110: data file : '/u01/data/orcl/temp01.dbf'</div><div class="line"></div><div class="line">SQL&gt;</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">SQL&gt; @/u01/data/orcl/create_control.sql</div><div class="line">ORACLE instance started.</div><div class="line"></div><div class="line">Total System Global Area 941600768 bytes</div><div class="line">Fixed Size 1348860 bytes</div><div class="line">Variable Size 515902212 bytes</div><div class="line">Database Buffers 419430400 bytes</div><div class="line">Redo Buffers 4919296 bytes</div><div class="line"></div><div class="line">Control file created.</div><div class="line"></div><div class="line">SQL&gt; </div><div class="line">SQL&gt; select status from v<span class="variable">$instance</span>;</div><div class="line"></div><div class="line">STATUS</div><div class="line">------------</div><div class="line">MOUNTED</div><div class="line"></div><div class="line">SQL&gt;</div></pre></td></tr></table></figure>
<p>打开数据库<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#在打开数据库时，会报错，提示system01数据文件需要执行介质恢复，我们执行recover database即可</span></div><div class="line">SQL&gt; alter database open;</div><div class="line">alter database open</div><div class="line">*</div><div class="line">ERROR at line 1:</div><div class="line">ORA-01113: file 1 needs media recovery</div><div class="line">ORA-01110: data file 1: \<span class="string">'/u01/app/oracle/oradata/HOEGH/system01.dbf\'</span></div><div class="line">SQL&gt; </div><div class="line">SQL&gt; recover database;</div><div class="line">Media recovery complete.</div><div class="line">SQL&gt; </div><div class="line">SQL&gt; alter database open;</div><div class="line"></div><div class="line">Database altered.</div><div class="line"></div><div class="line">SQL&gt; </div><div class="line">SQL&gt; select * from v<span class="variable">$version</span>;</div><div class="line"></div><div class="line">BANNER</div><div class="line">-----------------------------------------------------------------------------</div><div class="line">Oracle Database 11g Enterprise Edition Release 11.2.0.4.0 - 64bit Production</div><div class="line">PL/SQL Release 11.2.0.4.0 - Production</div><div class="line">CORE	11.2.0.4.0	Production</div><div class="line">TNS <span class="keyword">for</span> Linux: Version 11.2.0.4.0 - Production</div><div class="line">NLSRTL Version 11.2.0.4.0 - Production</div><div class="line"></div><div class="line">SQL&gt;</div><div class="line"></div><div class="line">SQL&gt; select tablespace_name from dba_tablespaces;</div><div class="line"></div><div class="line">TABLESPACE_NAME</div><div class="line">------------------------------</div><div class="line">SYSTEM</div><div class="line">SYSAUX</div><div class="line">UNDOTBS1</div><div class="line">TEMP</div><div class="line">USERS</div><div class="line">PAYBOX_FG_PRO</div><div class="line">PAYBOX_TEST2SP</div><div class="line">DEV_PAYDB</div><div class="line">DEV_PAYBOXDB</div><div class="line">LOTTERYDB</div><div class="line"></div><div class="line">10 rows selected.</div><div class="line"></div><div class="line">SQL&gt;</div></pre></td></tr></table></figure></p>
<p>总结<br>下面总结一下重建控制文件的步骤：  </p>
<ol>
<li>获取数据库名；</li>
<li>获取字符集名；</li>
<li>获取数据文件名；</li>
<li>重建控制文件；</li>
<li>执行介质恢复；</li>
<li>打开数据库。</li>
</ol>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/02/27/重建oracle控制文件/">http://www.yfshare.vip/2017/02/27/重建oracle控制文件/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Zabbix安装Graphtree]]></title>
      <url>http://www.yfshare.vip/2017/02/22/Zabbix%E5%AE%89%E8%A3%85Graphtree/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><h2 id="Graphtree功能概述"><a href="#Graphtree功能概述" class="headerlink" title="Graphtree功能概述"></a>Graphtree功能概述</h2><p>Graphtree 由OneOaaS开发并开源出来，OneOaaS专注于国内Zabbix监控技术(包括二次开发)服务，为Zabbix官方中国区合作伙伴  </p>
<ol>
<li>集中展示所有分组设备</li>
<li>集中展示一个分组图像</li>
<li>集中展示一个设备图像<a id="more"></a></li>
<li>展示设备下的Application</li>
<li>展示每个应用下的图像</li>
<li>展示每个应用下的日志</li>
<li>对原声无图的监控项进行绘图</li>
<li>注意事项：主机和组级别下，默认只显示系统初始的图形</li>
</ol>
<h2 id="Zabbix版本要求：3-0-x"><a href="#Zabbix版本要求：3-0-x" class="headerlink" title="Zabbix版本要求：3.0.x"></a>Zabbix版本要求：3.0.x</h2><p>附件：<a href="http://note.youdao.com/yws/api/personal/file/DAB415BB243542CF8CF075B8907EF081?method=download&amp;shareKey=7ade1a3e929ca16ac394d1429a7152ba" target="_blank" rel="external">graphtree3-0-1.patch</a>  </p>
<ol>
<li><p>插件安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#进入zabbix web目录</span></div><div class="line">[root@localhost ~]<span class="comment"># cd /opt/server/nginx-1.2.5/html/zabbix</span></div><div class="line">[root@localhost zabbix]<span class="comment"># wget --no-check-certificate https://raw.githubusercontent.com/OneOaaS/graphtrees/master/graphtree3-0-1.patch</span></div><div class="line">[root@localhost zabbix]<span class="comment"># yum -y install patch  #安装Linux下打补丁的命令</span></div><div class="line">[root@localhost zabbix]<span class="comment"># patch -Np0 &lt; graphtree3-0-1.patch</span></div></pre></td></tr></table></figure>
</li>
<li><p>Graphtree效果图  </p>
</li>
</ol>
<ul>
<li>打开zabbix web界面，找到Graphtrees选项卡</li>
<li>删除提示信息。编辑/opt/server/nginx-1.2.5/html/zabbix/graphtree.right.php 344-350行。具体请参考zabbix web界面的提示信息，如下图：<br><img src="http://note.youdao.com/yws/api/personal/file/ABB674CC417E41D2A3D27F0E4E984C19?method=download&amp;shareKey=46a8a5e4bb870899bc6855316b83e595" alt="image">  </li>
<li>删除上述提示信息后，重新刷新zabbix web界面，即可看到效果<br><img src="http://note.youdao.com/yws/api/personal/file/E000C80252634DFA9A6EE39813914F33?method=download&amp;shareKey=930aa2a35216b44a5a23f62ff9dc2b79" alt="image">  </li>
</ul>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/02/22/Zabbix安装Graphtree/">http://www.yfshare.vip/2017/02/22/Zabbix安装Graphtree/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Hexo+Github绑定域名]]></title>
      <url>http://www.yfshare.vip/2017/02/16/Hexo-Github%E7%BB%91%E5%AE%9A%E5%9F%9F%E5%90%8D/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>绑定域名  </p>
<p>首先去购买一个域名，<a href="https://www.godaddy.com/" target="_blank" rel="external">godaddy</a>或<a href="www.net.cn">万网</a>，听说万网比godaddy买域名便宜些  </p>
<p>效果图：<br><a id="more"></a><br><img src="http://note.youdao.com/yws/api/personal/file/84A29BD1472F43538084B5D94330CC97?method=download&amp;shareKey=57fc58d40de9aac2b6ab49ea3c19f1a4" alt="image"><br>提交资料审核通过后，需要修改域名的DNS地址<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#修改成dnspod的DNS地址</span></div><div class="line">f1g1ns1.dnspod.net</div><div class="line">f1g1ns2.dnspod.net</div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/46849CEF99294860A7696C77176F0CC4?method=download&amp;shareKey=f604e9ed6bd9698bb6447089c76ca2c2" alt="image">  </p>
<p>注册 <a href="https://www.dnspod.cn/SignUp" target="_blank" rel="external">dnspod</a> 在dnspod域名解析添加域名，添加记录<br><img src="http://note.youdao.com/yws/api/personal/file/56E163D5B60C4A5BA0B4B3D78FF36914?method=download&amp;shareKey=88b1692a151014c739bc7f9446329fb1" alt="image">  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/5092974CA79D4889B36CA1BB02DA048B?method=download&amp;shareKey=b45d293e5c715abbd34f57c6dee09f4b" alt="image"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">pwd</span></div><div class="line">/e/GitHup_Data/Hexo_B<span class="built_in">log</span></div><div class="line">$ <span class="built_in">cd</span> <span class="built_in">source</span>/</div><div class="line">$ cat CNAME</div><div class="line">www.yfshare.vip</div></pre></td></tr></table></figure>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ </span>hexo clean</div><div class="line"><span class="variable">$ </span>hexo g</div><div class="line"><span class="variable">$ </span>hexo d</div></pre></td></tr></table></figure>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/02/16/Hexo-Github绑定域名/">http://www.yfshare.vip/2017/02/16/Hexo-Github绑定域名/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Hexo maupassant主题音乐小工具]]></title>
      <url>http://www.yfshare.vip/2017/02/16/Hexo-maupassant%E4%B8%BB%E9%A2%98%E9%9F%B3%E4%B9%90%E5%B0%8F%E5%B7%A5%E5%85%B7/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>maupassant主题音乐小工具实现blog背景音乐的功能  </p>
<p>自己研究的哈，我完全没有学过js脚本，经过我2小时的摸索，我发现可以在侧边栏添加音乐小工具，实现背景音乐的效果<br>灵感来源于官方Githup这句话：<a href="https://www.haomwei.com/technology/maupassant-hexo.html#功能配置" target="_blank" rel="external">https://www.haomwei.com/technology/maupassant-hexo.html#功能配置</a>  </p>
<ul>
<li>widgets - 选择和排列希望使用的侧边栏小工具。</li>
</ul>
<p><a href="https://yfshare.github.io" target="_blank" rel="external">效果图</a>：<br><a id="more"></a><br><img src="http://note.youdao.com/yws/api/personal/file/23FAA10CE84C4441A83A9FEC1C01E2E7?method=download&amp;shareKey=5f8e308c71a0ebed208fafbfddec7c1b" alt="image">  </p>
<p>打开<a href="http://music.163.com/" target="_blank" rel="external">网页云音乐</a>寻找外链播放器代码<br>随便搜索一首歌，我这里用<a href="http://music.163.com/#/song?id=371362" target="_blank" rel="external">小跳蛙</a><br><img src="http://note.youdao.com/yws/api/personal/file/CE00D1E3EBF54F65B5C6925AF8332857?method=download&amp;shareKey=3ca948fa349b1b7eadb5c626cfdfce00" alt="image">  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/4A28038769D14E7C8B57CE19BFB8CAB9?method=download&amp;shareKey=5adab296ead0ff9c5fee07f60393a48e" alt="image"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#网易云音乐HTML代码,把这段代码放到music.jade最下面</span></div><div class="line">&lt;iframe frameborder=<span class="string">"no"</span> border=<span class="string">"0"</span> marginwidth=<span class="string">"0"</span> marginheight=<span class="string">"0"</span> width=330 height=86 src=<span class="string">"//music.163.com/outchain/player?type=2&amp;id=371362&amp;auto=1&amp;height=66"</span>&gt;&lt;/iframe&gt;</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">pwd</span></div><div class="line">Hexo_B<span class="built_in">log</span>/themes/maupassant/layout/_widget</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#创建音乐侧边栏脚本</span></div><div class="line">$ touch music.jade</div><div class="line">$ cat music.jade</div><div class="line">.widget</div><div class="line">  .widget-title</div><div class="line">    i(class=<span class="string">'fa fa-external-music'</span>)= <span class="string">' '</span> + __(<span class="string">'music'</span>)</div><div class="line">  - <span class="keyword">for</span> (var i <span class="keyword">in</span> theme.music)</div><div class="line">    ul</div><div class="line">    a(href=<span class="string">'#&#123;theme.music[i].url&#125;'</span> title=<span class="string">'#&#123;theme.music[i].title&#125;'</span> target=<span class="string">'_blank'</span>) <span class="comment">#&#123;theme.music[i].title&#125;</span></div><div class="line"><span class="comment">#网易云音乐HTML代码</span></div><div class="line">&lt;iframe frameborder=<span class="string">"no"</span> border=<span class="string">"0"</span> marginwidth=<span class="string">"0"</span> marginheight=<span class="string">"0"</span> width=330 height=86 src=<span class="string">"//music.163.com/outchain/player?type=2&amp;id=371362&amp;auto=1&amp;height=66"</span>&gt;&lt;/iframe&gt;</div></pre></td></tr></table></figure>
<p>因为上面一个js脚本用到了music字段(我不懂js脚本，姑且这样称呼吧)，“+ __(‘music’)”，这里的music字段是调用下面的配置文件中的music字段<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#添加侧边栏标签</span></div><div class="line">$ <span class="built_in">pwd</span></div><div class="line">Hexo_B<span class="built_in">log</span>/themes/maupassant</div><div class="line">$ cat languages/zh-CN.yml</div><div class="line">reading_label: 正在查看 %s 下的文章</div><div class="line">blog: 博客</div><div class="line">albums: 相册</div><div class="line">categories: 分类</div><div class="line">tags: 标签</div><div class="line">archive: 归档</div><div class="line">links: 链接</div><div class="line">about: 关于</div><div class="line">recent: 最新文章</div><div class="line">next: 下一页</div><div class="line">previous: 上一页</div><div class="line">notitle: 无题</div><div class="line">blogroll: 友情链接</div><div class="line">music: 音乐   <span class="comment">#添加music字段汉字翻译</span></div><div class="line"><span class="built_in">history</span>: 历史</div><div class="line">rss: 订阅</div><div class="line">guestbook: 留言</div><div class="line">home: 首页</div><div class="line">recent_comments: 最近评论</div><div class="line">Readmore: 阅读更多</div><div class="line">belongsto: 分类于</div><div class="line">contents: 文章目录</div><div class="line">shareto: 分享到</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#在主题配置文件_config.yml中添加侧边栏工具music，在这里配置了才表示启用这个工具</span></div><div class="line">$ <span class="built_in">pwd</span></div><div class="line">Hexo_B<span class="built_in">log</span>/themes/maupassant</div><div class="line">$ head -39 _config.yml | tail</div><div class="line">widgets: <span class="comment">## Six widgets in sidebar provided: search, category, tag, recent_posts, rencent_comments and links.</span></div><div class="line">  - search</div><div class="line">  - category</div><div class="line">  - tag</div><div class="line">  - recent_posts</div><div class="line">  - recent_comments</div><div class="line">  - links</div><div class="line">  - music    <span class="comment">#添加music工具</span></div><div class="line"></div><div class="line">music:</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ hexo clean    <span class="comment">#修改配置文件后需要清空缓存，否则可能修改无效</span></div><div class="line">$ hexo g</div><div class="line">$ hexo d</div></pre></td></tr></table></figure>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/02/16/Hexo-maupassant主题音乐小工具/">http://www.yfshare.vip/2017/02/16/Hexo-maupassant主题音乐小工具/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Hexo接入B站html5播放器]]></title>
      <url>http://www.yfshare.vip/2017/02/15/Hexo%E6%8E%A5%E5%85%A5B%E7%AB%99html5%E6%92%AD%E6%94%BE%E5%99%A8/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>2016年8月15日，B站推出了HTML5播放器，自此，B站成为国内原生支持全平台的HTML5播放器的视频网站<br>2017年1月19日，B站推出了HTML5播放器已支持https<br><a id="more"></a></p>
<p>效果：  </p>
<iframe src="https://www.bilibili.com/html/html5player.html?cid=10046207&aid=6184828" width="680" height="480" frameborder="0" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen></iframe>  


<p>Hexo插入B站播放器代码：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;iframe src=<span class="string">"https://www.bilibili.com/html/html5player.html?cid=10046207&amp;aid=6184828"</span> width=<span class="string">"700"</span> height=<span class="string">"450"</span> frameborder=<span class="string">"0"</span> webkitallowfullscreen mozallowfullscreen allowfullscreen&gt;&lt;/iframe&gt;</div></pre></td></tr></table></figure></p>
<p>注：在<a href="https://www.bilibili.com/" target="_blank" rel="external">B站</a>找到一个自己喜欢的视频，缓存完成后，浏览器右键查看源代码，ctrl+f搜索 cid 或 aid，大概在源代码的380行左右。B 站每个视频都有对应的 aid 和 cid 值<br><img src="http://note.youdao.com/yws/api/personal/file/5D4552C0A7834D93879588D9BF893E5D?method=download&amp;shareKey=22f22e353b99a28c25a9f3f2e3742cd0" alt="image">  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/02/15/Hexo接入B站html5播放器/">http://www.yfshare.vip/2017/02/15/Hexo接入B站html5播放器/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Hexo插件之音乐视频]]></title>
      <url>http://www.yfshare.vip/2017/02/15/Hexo%E6%8F%92%E4%BB%B6%E4%B9%8B%E9%9F%B3%E4%B9%90%E8%A7%86%E9%A2%91/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>效果：<br><div id="aplayer0" class="aplayer" style="margin-bottom: 20px;"></div>
		<script>
			new APlayer({
				element: document.getElementById("aplayer0"),
				narrow: false,
				autoplay: true,
				showlrc: 0,
				music: {
					title: "You Raise Me Up",
					author: "Westlife",
					url: "http://other.web.ra01.sycdn.kuwo.cn/d5a898b9c8d91e8e4486011b7baccdb4/58a3c3b8/resource/n3/128/69/68/992887695.mp3",
					pic: "",
				}
			});
		</script><br><a id="more"></a><br><div id="dplayer0" class="dplayer" style="margin-bottom: 20px;"></div><script>var dplayer0 = new DPlayer({"element":document.getElementById("dplayer0"),"autoplay":false,"theme":"#FADFA3","loop":true,"video":{"url":"http://devtest.qiniudn.com/若能绽放光芒.mp4","pic":"http://devtest.qiniudn.com/若能绽放光芒.png"},"danmaku":{"api":"http://dplayer.daoapp.io","id":"9E2E3368B56CDBB4","token":"tokendemo"}});</script></p>
<p>Hexo官方插件：<a href="https://hexo.io/plugins/" target="_blank" rel="external">https://hexo.io/plugins/</a>  </p>
<p>需要用到两个播放器插件  </p>
<ul>
<li>hexo-tag-aplayer：<a href="https://github.com/grzhan/hexo-tag-aplayer#upstream-issue" target="_blank" rel="external">https://github.com/grzhan/hexo-tag-aplayer#upstream-issue</a>  </li>
<li>hexo-tag-dplayer：<a href="https://github.com/NextMoe/hexo-tag-dplayer" target="_blank" rel="external">https://github.com/NextMoe/hexo-tag-dplayer</a>  </li>
</ul>
<p>两款插件基于 <a href="https://github.com/DIYgod" target="_blank" rel="external">DIYgod</a> 编写的 html5 播放器 <a href="https://github.com/DIYgod/APlayer" target="_blank" rel="external">APlayer</a> 和 <a href="https://github.com/DIYgod/DPlayer" target="_blank" rel="external">DPlayer</a> 开发  </p>
<p>安装插件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">pwd</span></div><div class="line">/e/GitHup_Data/Hexo_B<span class="built_in">log</span></div><div class="line">$ npm install hexo-tag-dplayer --save</div><div class="line">$ npm install hexo-tag-aplayer --save</div></pre></td></tr></table></figure></p>
<p>安装成功后，在Markdown文档中添加 APlayer 和 DPlayer 标签即可  </p>
<p>APlayer和DPlayer代码：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#APlayer Usage:</span></div><div class="line">&#123;% aplayer title author url [picture_url, narrow, autoplay, width:xxx, lrc:xxx] %&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&#123;% aplayer <span class="string">"You Raise Me Up"</span> <span class="string">"Westlife"</span> <span class="string">"http://other.web.ra01.sycdn.kuwo.cn/d5a898b9c8d91e8e4486011b7baccdb4/58a3c3b8/resource/n3/128/69/68/992887695.mp3"</span> <span class="string">"autoplay"</span> %&#125;</div><div class="line">&#123;% dplayer <span class="string">"url=http://devtest.qiniudn.com/若能绽放光芒.mp4"</span> <span class="string">"api=http://dplayer.daoapp.io"</span> <span class="string">"pic=http://devtest.qiniudn.com/若能绽放光芒.png"</span> <span class="string">"id=9E2E3368B56CDBB4"</span> <span class="string">"loop=yes"</span> <span class="string">"theme=#FADFA3"</span> <span class="string">"autoplay=false"</span> <span class="string">"token=tokendemo"</span> %&#125;</div></pre></td></tr></table></figure>
<p>注：dplayer存在BUG，研究了会但还是不会咋整，就把官方的贴出来了，嘿<br>参考：<a href="https://dplayer.js.org/docs/#/?id=usage" target="_blank" rel="external">https://dplayer.js.org/docs/#/?id=usage</a><br><a href="https://github.com/NextMoe/hexo-tag-dplayer" target="_blank" rel="external">https://github.com/NextMoe/hexo-tag-dplayer</a><br><a href="https://github.com/DIYgod/DPlayer" target="_blank" rel="external">https://github.com/DIYgod/DPlayer</a><br><a href="https://login926.top/2016/07/20/HexoMedia/" target="_blank" rel="external">https://login926.top/2016/07/20/HexoMedia/</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/02/15/Hexo插件之音乐视频/">http://www.yfshare.vip/2017/02/15/Hexo插件之音乐视频/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Hexo maupassant主题添加百度统计]]></title>
      <url>http://www.yfshare.vip/2017/02/14/Hexo-maupassant%E4%B8%BB%E9%A2%98%E6%B7%BB%E5%8A%A0%E7%99%BE%E5%BA%A6%E7%BB%9F%E8%AE%A1/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>百度统计：  </p>
<p>百度统计的结果至少需要等待半天时间才会有结果显示的哦(如果没有配置错误的话)<br>效果图：<br><a id="more"></a><br><img src="http://note.youdao.com/yws/api/personal/file/24CC1BB013334E6781854D6C820B1A45?method=download&amp;shareKey=a8dae77a9d9ea38701f59db854c0e7d5" alt="image">  </p>
<p>首先<a href="http://tongji.baidu.com/web/register" target="_blank" rel="external">注册 - 站长版</a>百度统计帐号并<a href="http://tongji.baidu.com/web/welcome/login" target="_blank" rel="external">登录</a><br>在管理选项卡新建站点<br><img src="http://note.youdao.com/yws/api/personal/file/85E4DD4B634A4CD3B9A68CB6B5809FBE?method=download&amp;shareKey=c84e499af592e81e6a4aaad72ee1f9c2" alt="image"><br><img src="http://note.youdao.com/yws/api/personal/file/D3F00C30C8F7463AB76242CD3F370890?method=download&amp;shareKey=e66264eee77d55dc8fa5cc954e5fd0c9" alt="image"><br><img src="http://note.youdao.com/yws/api/personal/file/4ECA09DB922545EA95C7861492C6B482?method=download&amp;shareKey=5126ffa078b6076ad076230fce71c41b" alt="image">  </p>
<p>从百度统计网站获取统计ID填入maupassant主题的_config.yml<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">pwd</span></div><div class="line">/e/GitHup_Data/Hexo_B<span class="built_in">log</span>/themes/maupassant</div><div class="line">$ grep -i <span class="string">'baidu_analytics'</span> _config.yml</div><div class="line">baidu_analytics: baidu_analytic_id <span class="comment">## Your Baidu Analytics tracking id, e.g. 8006843039519956000</span></div></pre></td></tr></table></figure></p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ </span>hexo clean</div><div class="line"><span class="variable">$ </span>hexo g</div><div class="line"><span class="variable">$ </span>hexo d</div></pre></td></tr></table></figure>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/02/14/Hexo-maupassant主题添加百度统计/">http://www.yfshare.vip/2017/02/14/Hexo-maupassant主题添加百度统计/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Hexo创建404页面]]></title>
      <url>http://www.yfshare.vip/2017/02/14/Hexo%E5%88%9B%E5%BB%BA404%E9%A1%B5%E9%9D%A2/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>其实这个页面很简单，但我个人喜欢干净的页面，所以觉得挺好<br><a href="https://yfshare.github.io//404.html" target="_blank" rel="external">效果图</a>：<br><a id="more"></a><br><img src="http://note.youdao.com/yws/api/personal/file/F3B47D6155FC47D6ACA5D8C3C9A3C531?method=download&amp;shareKey=097f1b43c4b8819fa334c44c5891e595" alt="image">  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">pwd</span></div><div class="line">/e/GitHup_Data/Hexo_B<span class="built_in">log</span></div><div class="line">$ hexo new page 404</div><div class="line">INFO  Created: E:\GitHup_Data\Hexo_B<span class="built_in">log</span>\<span class="built_in">source</span>\404\index.md</div><div class="line">$ <span class="built_in">cd</span> <span class="built_in">source</span>/404/</div><div class="line">$ cat index.md</div><div class="line">title: 404 Not Found：该页无法显示</div><div class="line">toc: <span class="literal">false</span></div><div class="line">comments: <span class="literal">false</span></div><div class="line">permalink: /404</div><div class="line">---</div><div class="line">&lt;style <span class="built_in">type</span>=<span class="string">"text/css"</span>&gt;</div><div class="line">        .article-header &#123;</div><div class="line">                padding: 0;</div><div class="line">                padding-top: 26px;</div><div class="line">                border-left: none;</div><div class="line">                text-align: center;</div><div class="line">        &#125;</div><div class="line">        .article-header:hover &#123;</div><div class="line">                border-left: none;</div><div class="line">        &#125;</div><div class="line">        .article-title &#123;</div><div class="line">                font-size: 2.1em;</div><div class="line">        &#125;</div><div class="line">        strong a &#123;</div><div class="line">                color: <span class="comment">#747474;</span></div><div class="line">        &#125;</div><div class="line">        .article-meta &#123;</div><div class="line">                display: none;</div><div class="line">        &#125;</div><div class="line">        .share &#123;</div><div class="line">                display: none;</div><div class="line">        &#125;</div><div class="line">        .ds-meta &#123;</div><div class="line">                display: none;</div><div class="line">        &#125;</div><div class="line">        .player &#123;</div><div class="line">                margin-left: -10px;</div><div class="line">        &#125;</div><div class="line">        .sign &#123;</div><div class="line">                text-align: right;</div><div class="line">                font-style: italic;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">#page-visit &#123;</span></div><div class="line">                display: none;</div><div class="line">        &#125;</div><div class="line">        .center &#123;</div><div class="line">                text-align: center;</div><div class="line">                height: 2.5em;</div><div class="line">                font-weight: bold;</div><div class="line">        &#125;</div><div class="line">        .article-entry hr &#123;</div><div class="line">                margin: 0;</div><div class="line">        &#125;</div><div class="line">        .pic &#123;</div><div class="line">                text-align: center;</div><div class="line">                margin: 0;</div><div class="line">        &#125;</div><div class="line">        .pic br &#123;</div><div class="line">                display: none;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">#container .article-info-post.article-info &#123;</span></div><div class="line">        display: none;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">#container .article .article-title &#123;</span></div><div class="line">        padding: 0;</div><div class="line">        &#125;</div><div class="line">&lt;/style&gt;</div></pre></td></tr></table></figure>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ </span>hexo g</div><div class="line"><span class="variable">$ </span>hexo d</div></pre></td></tr></table></figure>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/02/14/Hexo创建404页面/">http://www.yfshare.vip/2017/02/14/Hexo创建404页面/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Hexo添加RSS订阅功能]]></title>
      <url>http://www.yfshare.vip/2017/02/14/Hexo%E6%B7%BB%E5%8A%A0RSS%E8%AE%A2%E9%98%85%E5%8A%9F%E8%83%BD/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>Hexo添加RSS订阅功能  </p>
<p>先看看效果图：<br><a id="more"></a><br><img src="http://note.youdao.com/yws/api/personal/file/C236CE34602842F7BEDDD7E5C6610287?method=download&amp;shareKey=00f25ff8a255ccb1e62f24daaa506474" alt="image">  </p>
<p>首先安装安装hexo-generator-feed<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">pwd</span></div><div class="line">/e/GitHup_Data/Hexo_B<span class="built_in">log</span></div><div class="line">$ npm install hexo-generator-feed --save</div></pre></td></tr></table></figure></p>
<p>配置Hexo根目录_config.yml，配置RSS订阅<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">pwd</span></div><div class="line">/e/GitHup_Data/Hexo_B<span class="built_in">log</span></div><div class="line">$ head -72 _config.yml | tail -7</div><div class="line">plugin:</div><div class="line">- hexo-generator-feed</div><div class="line"><span class="comment">#Feed Atom</span></div><div class="line">feed:</div><div class="line"><span class="built_in">type</span>: atom</div><div class="line">path: atom.xml</div><div class="line"><span class="built_in">limit</span>: 20</div></pre></td></tr></table></figure></p>
<p>配置主题下的_config.yml，添加RSS订阅链接<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">pwd</span></div><div class="line">/e/GitHup_Data/Hexo_B<span class="built_in">log</span></div><div class="line">$ <span class="built_in">cd</span> themes/maupassant/</div><div class="line">$ tail -3 _config.yml</div><div class="line"><span class="comment"># SubNav</span></div><div class="line">subnav:</div><div class="line">rss: <span class="string">"/atom.xml"</span></div></pre></td></tr></table></figure></p>
<p>添加之后，运行hexo g后，就会在页面上生成RSS图标<br><img src="http://note.youdao.com/yws/api/personal/file/E808B018F8CB4145A42A20531780077C?method=download&amp;shareKey=32d712cfbfe310797ea8f9749a83e747" alt="image">  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/02/14/Hexo添加RSS订阅功能/">http://www.yfshare.vip/2017/02/14/Hexo添加RSS订阅功能/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Hexo添加版权说明]]></title>
      <url>http://www.yfshare.vip/2017/02/14/Hexo%E6%B7%BB%E5%8A%A0%E7%89%88%E6%9D%83%E8%AF%B4%E6%98%8E/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>博客是文字创造的产物，是知识共享的一种形式。尊重版权意味着是对作者劳动成功的肯定和赞赏。当我们无视版权的时候，这意味着知识是没有价值的，创造是无关痛痒的，脑力劳动和创意活动的价值在现实中被无情地扼杀。当你引用一个人的观点却不加以注明的时候，当你盗用一个人的创意却不给予报酬的时候，试问谁还会愿意为这个社会贡献创意和想法呢？<br><a id="more"></a><br>在博客根目录创建一个scripts的文件夹<br>在scritps文件夹内，新建一个AddTail.js脚本文件，内容如下<br>在博客根目录，新建一个tail.md文件，里面写想要展示的版本说明内容<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">pwd</span></div><div class="line">/e/GitHup_Data/Hexo_B<span class="built_in">log</span></div><div class="line">$ mkdir scripts</div><div class="line">$ cat scripts/AddTail.js</div><div class="line">// Filename: AddTail.js</div><div class="line">// Author: Colin</div><div class="line">// Date: 2016/06/02</div><div class="line">// Based on the script by KUANG Qi: http://kuangqi.me/tricks/append<span class="_">-a</span>-copyright-info-after-every-post/</div><div class="line"></div><div class="line">// Add a tail to every post from tail.md</div><div class="line">// Great <span class="keyword">for</span> adding copyright info</div><div class="line"></div><div class="line">var fs = require(<span class="string">'fs'</span>);</div><div class="line"></div><div class="line">hexo.extend.filter.register(<span class="string">'before_post_render'</span>, <span class="keyword">function</span>(data)&#123;</div><div class="line">        <span class="keyword">if</span>(data.copyright == <span class="literal">false</span>) <span class="built_in">return</span> data;</div><div class="line"></div><div class="line">        // Add seperate line</div><div class="line">        data.content += <span class="string">'\n___\n'</span>;</div><div class="line"></div><div class="line">        // Try to <span class="built_in">read</span> tail.md</div><div class="line">        try &#123;</div><div class="line">                var file_content = fs.readFileSync(<span class="string">'tail.md'</span>);</div><div class="line">                <span class="keyword">if</span>(file_content &amp;&amp; data.content.length &gt; 50)</div><div class="line">                &#123;</div><div class="line">                        data.content += file_content;</div><div class="line">                &#125;</div><div class="line">        &#125; catch (err) &#123;</div><div class="line">                <span class="keyword">if</span> (err.code !== <span class="string">'ENOENT'</span>) throw err;</div><div class="line"></div><div class="line">                // No process <span class="keyword">for</span> ENOENT error</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // 添加具体文章链接, 不需要去掉即可</div><div class="line">        var permalink = <span class="string">'\n本文出自"Jack Wang Blog"：'</span> + data.permalink;</div><div class="line">        data.content += permalink;</div><div class="line"></div><div class="line">        <span class="built_in">return</span> data;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">$ cat tail.md</div><div class="line">本作品采用[知识共享署名 2.5 中国大陆许可协议](https://creativecommons.org/licenses/by/2.5/cn/)进行许可，欢迎转载，但转载请注明来自[Jack Wang B<span class="built_in">log</span>](https://yfshare.github.io)，并保持转载后文章内容的完整。本人保留所有版权相关权利。</div><div class="line"></div><div class="line">$ hexo clean</div><div class="line">$ hexo g</div><div class="line">$ hexo deploy</div></pre></td></tr></table></figure></p>
<p>效果图：<br><img src="http://note.youdao.com/yws/api/personal/file/85DA80DB248F4F71A3A5D32FA7970457?method=download&amp;shareKey=15345a6812577d1860858e38ff2734e4" alt="image">  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/02/14/Hexo添加版权说明/">http://www.yfshare.vip/2017/02/14/Hexo添加版权说明/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Hexo maupassant主题添加多说评论系统]]></title>
      <url>http://www.yfshare.vip/2017/02/14/Hexo-maupassant%E4%B8%BB%E9%A2%98%E6%B7%BB%E5%8A%A0%E5%A4%9A%E8%AF%B4%E8%AF%84%E8%AE%BA%E7%B3%BB%E7%BB%9F/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>Hexo maupassant主题添加多说评论系统  </p>
<p>查看效果<br><a id="more"></a><br><img src="http://note.youdao.com/yws/api/personal/file/804AA9EC4321495386EBAB8F13C8C2EB?method=download&amp;shareKey=f772eecd7e83c252667291edb9a2e9f8" alt="image">  </p>
<p>登录<a href="http://yfshare.duoshuo.com" target="_blank" rel="external">多说官网</a><br><a href="http://duoshuo.com/create-site/" target="_blank" rel="external">创建站点</a><br><img src="http://note.youdao.com/yws/api/personal/file/766F52EF87224EB5AA7F9574F1A522AC?method=download&amp;shareKey=382814d963e4e2d578139705ae739b23" alt="image"></p>
<p>站点创建成功后，设置相关属性<br><img src="http://note.youdao.com/yws/api/personal/file/7E04F5162EA140E9B03F390F9C526156?method=download&amp;shareKey=a9ff4b32519b0c54650b9209ec75fe3b" alt="image">  </p>
<p>配置Hexo，使其使用多说评论系统<br>修改maupassant主题的_config.yml文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">pwd</span></div><div class="line">/e/GitHup_Data/Hexo_B<span class="built_in">log</span>/themes/maupassant</div><div class="line">$ grep -i <span class="string">'^duoshuo'</span> _config.yml</div><div class="line">duoshuo: yfshare <span class="comment">## Your duoshuo_shortname, e.g. username</span></div><div class="line"><span class="comment">#这里的duoshuo_shortname是在创建多说站点时，在多说域名那输入的字段</span></div><div class="line"></div><div class="line"><span class="comment"># hexo g</span></div><div class="line"><span class="comment"># hexo server</span></div></pre></td></tr></table></figure></p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/02/14/Hexo-maupassant主题添加多说评论系统/">http://www.yfshare.vip/2017/02/14/Hexo-maupassant主题添加多说评论系统/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[安装maupassant-hexo主题]]></title>
      <url>http://www.yfshare.vip/2017/02/13/%E5%AE%89%E8%A3%85maupassant-hexo%E4%B8%BB%E9%A2%98/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>Maupassant最初是由Cho大神为Typecho平台设计开发的一套响应式模板，体积只有20KB，在各种尺寸的设备上表现出色。由于其简洁大气的风格受到许多用户喜爱，目前也已经被移植到了多个平台上，例如：</p>
<p>Typecho：<a href="https://github.com/pagecho/maupassant/" target="_blank" rel="external">https://github.com/pagecho/maupassant/</a><br>Octopress：<a href="https://github.com/pagecho/mewpassant/" target="_blank" rel="external">https://github.com/pagecho/mewpassant/</a><br>Farbox：<a href="https://github.com/pagecho/Maupassant-farbox/" target="_blank" rel="external">https://github.com/pagecho/Maupassant-farbox/</a><br>Wordpress：<a href="https://github.com/iMuFeng/maupassant/" target="_blank" rel="external">https://github.com/iMuFeng/maupassant/</a><br>Ghost: <a href="https://github.com/LjxPrime/maupassant/" target="_blank" rel="external">https://github.com/LjxPrime/maupassant/</a><br><a id="more"></a><br>Hexo更换maupassant主题：<br>参考：<a href="https://github.com/tufu9441/maupassant-hexo" target="_blank" rel="external">https://github.com/tufu9441/maupassant-hexo</a><br>淘宝npm源：<a href="http://npm.taobao.org/" target="_blank" rel="external">http://npm.taobao.org/</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">pwd</span></div><div class="line">/e/GitHup_Data/Hexo_B<span class="built_in">log</span></div><div class="line">$ git <span class="built_in">clone</span> https://github.com/tufu9441/maupassant-hexo.git themes/maupassant</div><div class="line">$ npm install hexo-renderer-jade --save</div><div class="line">$ npm install hexo-renderer-sass --save   <span class="comment">#在国内网络原因，这个是安装不了的，可以使用taobao npm源解决</span></div><div class="line">$ npm install -g cnpm --registry=https://registry.npm.taobao.org   <span class="comment">#使用taobao源的cnpm代替官方的npm</span></div><div class="line">$ cnpm install hexo-renderer-sass --save   <span class="comment">#安装hexo-renderer-sass插件</span></div><div class="line">$ grep -i <span class="string">'^theme'</span> _config.yml</div><div class="line">theme: maupassant</div><div class="line">$ hexo g</div><div class="line">$ hexo server</div><div class="line"></div><div class="line">$ hexo deploy</div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/5068DA269F7B404BABDE5FC96C4CB002?method=download&amp;shareKey=4f37242ddca3be850964313ceadf8c4d" alt="image">  </p>
<p>个人觉得还有个不错的主题哦。Githup上都有安装的方法哦~<br><a href="https://github.com/iissnan/hexo-theme-next" target="_blank" rel="external">https://github.com/iissnan/hexo-theme-next</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/02/13/安装maupassant-hexo主题/">http://www.yfshare.vip/2017/02/13/安装maupassant-hexo主题/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[使用GitHub-Hexo搭建免费静态Blog]]></title>
      <url>http://www.yfshare.vip/2017/02/13/%E4%BD%BF%E7%94%A8GitHub-Hexo%E6%90%AD%E5%BB%BA%E5%85%8D%E8%B4%B9%E9%9D%99%E6%80%81Blog/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>Hexo官网：<a href="https://hexo.io/zh-cn/" target="_blank" rel="external">https://hexo.io/zh-cn/</a><br>Hexo官方安装文档：<a href="https://hexo.io/zh-cn/docs/" target="_blank" rel="external">https://hexo.io/zh-cn/docs/</a>  </p>
<h2 id="了解Hexo优点"><a href="#了解Hexo优点" class="headerlink" title="了解Hexo优点"></a>了解Hexo优点</h2><table>
<thead>
<tr>
<th>优点</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>超快速度</td>
<td>Node.js 所带来的超快生成速度，让上百个页面在几秒内瞬间完成渲染</td>
</tr>
<tr>
<td>一键部署</td>
<td>只需一条指令即可部署到 GitHub Pages, Heroku 或其他网站</td>
</tr>
<tr>
<td>支持Markdown</td>
<td>Hexo 支持 GitHub Flavored Markdown 的所有功能，甚至可以整合 Octopress 的大多数插件</td>
</tr>
<tr>
<td>丰富的插件</td>
<td>Hexo 拥有强大的插件系统，安装插件可以让 Hexo 支持 Jade, CoffeeScript</td>
</tr>
</tbody>
</table>
<a id="more"></a>
<p>环境：Hexo 3.x<br>　　　Windows7 x64Bit  </p>
<h2 id="安装Git-for-Windows"><a href="#安装Git-for-Windows" class="headerlink" title="安装Git for Windows"></a>安装Git for Windows</h2><p>Git for Windows下载地址：<a href="https://git-for-windows.github.io/" target="_blank" rel="external">https://git-for-windows.github.io/</a><br><a href="http://note.youdao.com/yws/api/personal/file/E8BA4EC159A44DD2BBD1A1B93FF92071?method=download&amp;shareKey=f77cb49e8f2061364c5c2bf65b2ce716" target="_blank" rel="external">Git for Windows 2.11下载地址</a>  </p>
<h2 id="安装Node-JS"><a href="#安装Node-JS" class="headerlink" title="安装Node.JS"></a>安装Node.JS</h2><p>Node.js是一个基于Chrome的V8 JavaScript引擎的JavaScript运行时环境<br>Node.JS for Windows下载地址：<a href="https://nodejs.org/en/" target="_blank" rel="external">https://nodejs.org/en/</a><br><a href="http://note.youdao.com/yws/api/personal/file/5FCECD3216F247288C3C160C212E02A7?method=download&amp;shareKey=21cd785dbd7a375ba7aa6604afecce45" target="_blank" rel="external">node.js-v7.5.0-x64.msi下载地址</a><br>旧版的Node.JS需要配置path环境变量，新版的在安装时会自动配置Path，即可以直接使用npm命令<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">C:\&gt;npm --help</div><div class="line">Usage: npm &lt;<span class="built_in">command</span>&gt;</div><div class="line"><span class="built_in">where</span> &lt;<span class="built_in">command</span>&gt; is one of:</div><div class="line">    access, adduser, bin, bugs, c, cache, completion, config,</div><div class="line">    ddp, dedupe, deprecate, dist-tag, docs, doctor, edit,</div><div class="line">    explore, get, <span class="built_in">help</span>, <span class="built_in">help</span>-search, i, init, install,</div><div class="line">    install-test, it, link, list, ln, login, <span class="built_in">logout</span>, ls,</div><div class="line">    outdated, owner, pack, ping, prefix, prune, publish, rb,</div><div class="line">    rebuild, repo, restart, root, run, run-script, s, se,</div><div class="line">    search, <span class="built_in">set</span>, shrinkwrap, star, stars, start, stop, t, team,</div><div class="line">    <span class="built_in">test</span>, tst, un, uninstall, unpublish, unstar, up, update, v,</div><div class="line">    version, view, whoami</div><div class="line">    </div><div class="line">npm &lt;cmd&gt; -h     quick <span class="built_in">help</span> on &lt;cmd&gt;</div><div class="line">npm <span class="_">-l</span>           display full usage info</div><div class="line">npm <span class="built_in">help</span> &lt;term&gt;  search <span class="keyword">for</span> <span class="built_in">help</span> on &lt;term&gt;</div><div class="line">npm <span class="built_in">help</span> npm     involved overview</div><div class="line"></div><div class="line">Specify configs <span class="keyword">in</span> the ini-formatted file:</div><div class="line">    C:\Users\yfshare\.npmrc</div><div class="line">or on the <span class="built_in">command</span> line via: npm &lt;<span class="built_in">command</span>&gt; --key value</div><div class="line">Config info can be viewed via: npm <span class="built_in">help</span> config</div><div class="line"></div><div class="line">npm@4.1.2 C:\Program Files\nodejs\node_modules\npm</div><div class="line">C:\&gt;</div></pre></td></tr></table></figure></p>
<h2 id="安装Hexo"><a href="#安装Hexo" class="headerlink" title="安装Hexo"></a>安装Hexo</h2><p>打开Windows桌面上的Git shell<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">npm install hexo-cli -g  <span class="comment">#安装到这里了C:\Users\yfshare\AppData\Roaming\npm</span></div><div class="line">npm install -g cnpm --registry=https://registry.npm.taobao.org  <span class="comment">#更换npm源</span></div><div class="line">npm install hexo --save</div></pre></td></tr></table></figure></p>
<h2 id="初始化Hexo配置"><a href="#初始化Hexo配置" class="headerlink" title="初始化Hexo配置"></a>初始化Hexo配置</h2><p>创建Hexo文件夹<br>安装完成后，建立Data目录(随意，目录最好不要有空格特殊字符之类的)，进入 Git Shell 切换到 E:\GitHup_Data\GitHup\Hexo 执行下面的指令：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">cd</span> /E/GitHup_Data/Hexo_B<span class="built_in">log</span>/  <span class="comment">#GitHup是bash环境，切换路径命令</span></div><div class="line">$ hexo init</div><div class="line">$ npm install</div><div class="line">$ ls</div><div class="line">_config.yml  node_modules/  package.json  scaffolds/  <span class="built_in">source</span>/  themes/</div></pre></td></tr></table></figure></p>
<p>安装Hexo插件<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">$ cd /E/GitHup_Data/Hexo_Blog/</div><div class="line">$ npm <span class="keyword">install</span> hexo-generator-<span class="keyword">index</span> <span class="comment">--save</span></div><div class="line">$ npm <span class="keyword">install</span> hexo-generator-<span class="keyword">archive</span> <span class="comment">--save</span></div><div class="line">$ npm <span class="keyword">install</span> hexo-generator-<span class="keyword">category</span> <span class="comment">--save</span></div><div class="line">$ npm <span class="keyword">install</span> hexo-generator-tag <span class="comment">--save</span></div><div class="line">$ npm <span class="keyword">install</span> hexo-<span class="keyword">server</span> <span class="comment">--save</span></div><div class="line">$ npm <span class="keyword">install</span> hexo-deployer-git <span class="comment">--save</span></div><div class="line">$ npm <span class="keyword">install</span> hexo-deployer-heroku <span class="comment">--save</span></div><div class="line">$ npm <span class="keyword">install</span> hexo-deployer-rsync <span class="comment">--save</span></div><div class="line">$ npm <span class="keyword">install</span> hexo-deployer-openshift <span class="comment">--save</span></div><div class="line">$ npm <span class="keyword">install</span> hexo-renderer-marked@<span class="number">0.2</span> <span class="comment">--save</span></div><div class="line">$ npm <span class="keyword">install</span> hexo-renderer-stylus@<span class="number">0.2</span> <span class="comment">--save</span></div><div class="line">$ npm <span class="keyword">install</span> hexo-generator-feed@<span class="number">1</span> <span class="comment">--save</span></div><div class="line">$ npm <span class="keyword">install</span> hexo-generator-sitemap@<span class="number">1</span> <span class="comment">--save</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$ hexo -v</div><div class="line">hexo-cli: 1.0.2</div><div class="line">os: Windows_NT 6.1.7601 win32 x64</div><div class="line">http_parser: 2.7.0</div><div class="line">node: 7.5.0</div><div class="line">v8: 5.4.500.48</div><div class="line">uv: 1.10.2</div><div class="line">zlib: 1.2.8</div><div class="line">ares: 1.10.1-DEV</div><div class="line">modules: 51</div><div class="line">openssl: 1.0.2k</div><div class="line">icu: 58.2</div><div class="line">unicode: 9.0</div><div class="line">cldr: 30.0.3</div><div class="line">tz: 2016j</div></pre></td></tr></table></figure>
<p>本地验收<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">cd</span> /E/GitHup_Data/Hexo_B<span class="built_in">log</span>/</div><div class="line">$ hexo g  <span class="comment">#生成public文件夹</span></div><div class="line">$ hexo server</div><div class="line">INFO  Start processing</div><div class="line">INFO  Hexo is running at http://localhost:4000/. Press Ctrl+C to stop.</div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/F50DFC5051A046F093861703CDBAA7ED?method=download&amp;shareKey=7103cfa4850d3b9beb0fa05b2a650176" alt="image">  </p>
<p>Hexo简写命令<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">hexo</span> n <span class="comment">#生成文章，或者source\_posts手动编辑</span></div><div class="line">hexo s <span class="comment">#本地发布预览效果</span></div><div class="line">hexo g <span class="comment">#生成public静态文件</span></div><div class="line"><span class="comment">#最后手动同步更新至GitHub</span></div></pre></td></tr></table></figure></p>
<h2 id="配置Hexo"><a href="#配置Hexo" class="headerlink" title="配置Hexo"></a>配置Hexo</h2><p>参考官方文档：<a href="https://hexo.io/zh-cn/docs/configuration.html" target="_blank" rel="external">https://hexo.io/zh-cn/docs/configuration.html</a><br>在配置过程中请使用<a href="http://www.yamllint.com/" target="_blank" rel="external">yamllint</a>来保证自己的yaml语法正确  </p>
<p>网站存放在子目录<br>如果您的网站存放在子目录中，例如 <a href="http://yoursite.com/blog" target="_blank" rel="external">http://yoursite.com/blog</a> ，则请将您的 url设为 <a href="http://yoursite.com/blog" target="_blank" rel="external">http://yoursite.com/blog</a> 并把 root 设为 /blog/  </p>
<p>在本地的hexo目录下的source目录下新建CNAME文件，内容为youdomain<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">cd</span> /e/GitHup_Data/Hexo_B<span class="built_in">log</span>/<span class="built_in">source</span>/</div><div class="line">$ ls</div><div class="line">_posts/  CNAME</div><div class="line">$ cat CNAME</div><div class="line">https://yfshare.github.io/Hexo_B<span class="built_in">log</span></div></pre></td></tr></table></figure></p>
<p>Hexo主题设置<br>官方主题库：<a href="https://hexo.io/themes/" target="_blank" rel="external">https://hexo.io/themes/</a><br>参考文档：<a href="http://jiji262.github.io/2016/04/15/2016-04-15-hexo-github-pages-blog/" target="_blank" rel="external">http://jiji262.github.io/2016/04/15/2016-04-15-hexo-github-pages-blog/</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">cd</span> /e/GitHup_Data/Hexo_B<span class="built_in">log</span>/themes</div><div class="line">$ hexo clean</div><div class="line">$ git <span class="built_in">clone</span> https://github.com/luuman/hexo-theme-spfk</div><div class="line"><span class="comment">#修改Hexo目录下的_config.yml配置文件中的theme属性，将其设置为hexo-theme-spfk(新下载的主题)</span></div><div class="line">$ grep -i <span class="string">'^theme'</span> ../_config.yml</div><div class="line">theme: landscape</div><div class="line">$ sed -i <span class="string">'/^theme/s/landscape/hexo-theme-spfk/'</span> ../_config.yml</div><div class="line">$ grep -i <span class="string">'^theme'</span> ../_config.yml</div><div class="line">theme: hexo-theme-spfk</div><div class="line">$</div><div class="line"><span class="comment">#更换主题</span></div><div class="line">$ <span class="built_in">cd</span> hexo-theme-spfk/</div><div class="line">$ git pull</div><div class="line">Already up-to-date.</div><div class="line">$ <span class="built_in">cd</span> /e/GitHup_Data/Hexo_B<span class="built_in">log</span>/</div><div class="line">$ hexo g   <span class="comment">#必须要切换到Hexo根目录才能执行hexo g命令，否则报错</span></div><div class="line">$ hexo server  <span class="comment">#同上</span></div></pre></td></tr></table></figure></p>
<p>更换新主题成功<br><img src="http://note.youdao.com/yws/api/personal/file/1A69C10346B44ADAB7B07C13E25575C4?method=download&amp;shareKey=bea475262c87db06114d0c19442f516a" alt="image">  </p>
<p>Github shell连接 Githup.com<br>参考：<a href="https://help.github.com/articles/connecting-to-github-with-ssh/" target="_blank" rel="external">https://help.github.com/articles/connecting-to-github-with-ssh/</a><br>生成SSH KEY<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">$ ssh-keygen -t rsa -b 4096 -C <span class="string">"your_email@example.com"</span></div><div class="line">Generating public/private rsa key pair.</div><div class="line">Enter file in which to save the key (/c/Users/yfshare/.ssh/id_rsa):</div><div class="line">Enter passphrase (empty for no passphrase):  <span class="comment">#这里输入密码，Github的密码</span></div><div class="line">Enter same passphrase again:</div><div class="line">Your identification has been saved in /c/Users/yfshare/.ssh/id_rsa.</div><div class="line">Your public key has been saved in /c/Users/yfshare/.ssh/id_rsa.pub.</div><div class="line">The key fingerprint is:</div><div class="line">SHA256:Vuxj3gxPJPaNv5/jUffiaSwsN2ufyCsyQ your_email<span class="meta">@example.com</span></div><div class="line">The key's randomart image is:</div><div class="line">+---[RSA 4096]----+</div><div class="line">|<span class="string">                 </span>|</div><div class="line">|<span class="string">         .  . .  </span>|</div><div class="line">|<span class="string">          =o.=   </span>|</div><div class="line">|<span class="string">        E+=+ooo  </span>|</div><div class="line">|<span class="string">        So==+.. o</span>|</div><div class="line">|<span class="string">       . o+B .  +</span>|</div><div class="line">|<span class="string">          .o++o..</span>|</div><div class="line">|<span class="string">          + O.=*o</span>|</div><div class="line">|<span class="string">          .O.BO=o</span>|</div><div class="line">+----[SHA256]-----+</div><div class="line">$</div></pre></td></tr></table></figure></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ cd ~/<span class="selector-class">.ssh</span></div><div class="line">$ ls</div><div class="line">id_rsa  id_rsa<span class="selector-class">.pub</span></div><div class="line">$ cat id_rsa<span class="selector-class">.pub</span>   <span class="selector-id">#github</span> ssh公钥</div><div class="line">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDjABJRUmtfpxTOiaPlItHVbzmnTVTh1OhYP2uSu3mgsACthhuZ9pVQz44flE1KUSnPaxPiYOfUXkHQ/ZKeZY/xs2bLXQUglZHuAVopyhsmnUUZy4Ycz9cUw8meC2YfdIyBnUNgSt0cVRGEAaaO7gOfPqWRCcGW8m1493LD+YhPNIQkFyQK0BzUkkOkkCnpZkoQaUF7XYtmVcrN/Yg66Pwr0hSZKLqL4Q0fPYj9ZligiaE54FKQ9ORVJskrOuw8Xp/P2sdGlmbRMu9W9w6qOTlLw7KrctsqjM2Up7X20lzassdgqweqwda your_email@example.com</div></pre></td></tr></table></figure>
<p>然后把生成的ssh key添加到Githup上<br>登录Githup – Settings – SSH and GPG keys — New SSH key<br><img src="http://note.youdao.com/yws/api/personal/file/9994071BDE794AC29EB6DD24B1B3DC5E?method=download&amp;shareKey=c94ba1280c017e87856ae0fa7ae96fec" alt="image">  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ ssh -T git@github.com   <span class="comment">#登录GitHup</span></div><div class="line">Enter passphrase <span class="keyword">for</span> key <span class="string">'/c/Users/yfshare/.ssh/id_rsa'</span>:</div><div class="line">Hi yfshare! You<span class="string">'ve successfully authenticated, but GitHub does not provide shell access.</span></div><div class="line">#登录GitHup成功</div></pre></td></tr></table></figure>
<h2 id="部署静态网页到GitHub"><a href="#部署静态网页到GitHub" class="headerlink" title="部署静态网页到GitHub"></a>部署静态网页到GitHub</h2><p>Githup<a href="https://github.com/" target="_blank" rel="external">注册</a>略，<a href="https://github.com/login?return_to=%2Fjoin" target="_blank" rel="external">登录</a>Githup<br>建立与你用户名对应的仓库，仓库名必须为[your_user_name.github.io]<br>登录GitHup – New repository – yfshare.github.io(Repository name)<br>等待审核通过后，访问：<a href="https://github.com/yfshare/yfshare.github.io" target="_blank" rel="external">https://github.com/yfshare/yfshare.github.io</a><br><img src="http://note.youdao.com/yws/api/personal/file/C9FBCA72F4CD4D58A91D7AAB24D94889?method=download&amp;shareKey=934b518e3706aa5964b124dc9bdba86e" alt="image">  </p>
<p>上传Hexo代码到Githup<br>参考：<a href="https://hexo.io/zh-cn/docs/deployment.html" target="_blank" rel="external">https://hexo.io/zh-cn/docs/deployment.html</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">pwd</span></div><div class="line">/e/GitHup_Data/Hexo_B<span class="built_in">log</span></div><div class="line">$ tail -6 _config.yml</div><div class="line"><span class="comment"># Deployment</span></div><div class="line"><span class="comment">## Docs: https://hexo.io/docs/deployment.html</span></div><div class="line">deploy:</div><div class="line">  <span class="built_in">type</span>: git</div><div class="line">  repository: git@github.com:yfshare/yfshare.github.io.git</div><div class="line">  branch: master</div><div class="line">$ hexo deploy</div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/919BDBDA225F429581329E9D396BD06E?method=download&amp;shareKey=97eb5d3e1bf0e7a8a20dc8a3251e0dc5" alt="image">  </p>
<p>访问：<a href="https://yfshare.github.io/" target="_blank" rel="external">https://yfshare.github.io/</a><br><img src="http://note.youdao.com/yws/api/personal/file/1A8F036079E944758528DE2B0C968A66?method=download&amp;shareKey=ebafa32ad50767e7f0dadd9fdc9b944d" alt="image"><br>如果能打开网页就说明部署成功了  </p>
<p>创建小文章：<br>参考：<a href="https://hexo.io/zh-cn/docs/writing.html" target="_blank" rel="external">https://hexo.io/zh-cn/docs/writing.html</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#写文档前需要把hexo停止，如果运行了hexo server的话，否则可能会生成2篇相同的文章</span></div><div class="line">$ <span class="built_in">cd</span> /e/GitHup_Data/Hexo_B<span class="built_in">log</span></div><div class="line">$ hexo new <span class="string">"使用GitHub+Hexo搭建免费静态Blog"</span></div><div class="line">INFO  Created: E:\GitHup_Data\Hexo_B<span class="built_in">log</span>\<span class="built_in">source</span>\_posts\使用GitHub-Hexo搭建免费静态Blog.md   <span class="comment">#生成的.md文件使用支持markdown语法的编辑器来编辑文档，如：Sublime Text 3等</span></div><div class="line">$ hexo server</div></pre></td></tr></table></figure></p>
<p>再次访问<a href="http://localhost:4000时发现多了一篇文章" target="_blank" rel="external">http://localhost:4000时发现多了一篇文章</a><br><img src="http://note.youdao.com/yws/api/personal/file/B0D6C30338CE45C8AC9B24A54D2B8B49?method=download&amp;shareKey=b3f670355809ed823f9565d976f57221" alt="image">  </p>
<p><a href="http://www.sublimetext.com/3" target="_blank" rel="external">Sublime Text 3下载地址</a><br>参考：<a href="https://hexo.io/zh-cn/docs/configuration.html" target="_blank" rel="external">https://hexo.io/zh-cn/docs/configuration.html</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">$ cat <span class="built_in">source</span>/_posts/使用GitHub-Hexo搭建免费静态Blog.md</div><div class="line">---</div><div class="line">title: 使用GitHub+Hexo搭建免费静态B<span class="built_in">log</span></div><div class="line">date: 2017-02-13 14:33:54</div><div class="line">tags: [GitHub,Hexo]</div><div class="line">---</div><div class="line">This is a <span class="built_in">test</span> page.</div><div class="line"></div><div class="line">$ hexo g   <span class="comment">#把markdown生成静态网页</span></div><div class="line">INFO  Start processing</div><div class="line">INFO  Files loaded <span class="keyword">in</span> 760 ms</div><div class="line">INFO  Deleted: tags/GitHub-Hexo/index.html</div><div class="line">INFO  Generated: atom.xml</div><div class="line">INFO  Generated: sitemap.xml</div><div class="line">INFO  Generated: archives/index.html</div><div class="line">INFO  Generated: archives/2017/02/index.html</div><div class="line">INFO  Generated: 2017/02/13/hello-world/index.html</div><div class="line">INFO  Generated: 2017/02/13/使用GitHub-Hexo搭建免费静态B<span class="built_in">log</span>/index.html</div><div class="line">INFO  Generated: archives/2017/index.html</div><div class="line">INFO  Generated: index.html</div><div class="line">INFO  Generated: tags/Hexo/index.html</div><div class="line">INFO  Generated: tags/GitHub/index.html</div><div class="line">INFO  10 files generated <span class="keyword">in</span> 259 ms</div></pre></td></tr></table></figure></p>
<p>定制化博客：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#修改_config.yml</span></div><div class="line">$ <span class="built_in">pwd</span></div><div class="line">/e/GitHup_Data/Hexo_B<span class="built_in">log</span></div><div class="line">$ head -n 11 _config.yml | tail -7</div><div class="line"><span class="comment"># Site</span></div><div class="line">title: Jack Wang B<span class="built_in">log</span></div><div class="line">subtitle:</div><div class="line">description: B<span class="built_in">log</span></div><div class="line">author: Jack Wang</div><div class="line">language: CN</div><div class="line">timezone: <span class="string">"Asia/Shanghai"</span></div><div class="line"></div><div class="line"><span class="comment">#修改theme信息，即theme的_config.yml</span></div><div class="line">$ <span class="built_in">cd</span> themes/hexo-theme-spfk/</div><div class="line">$ ls</div><div class="line">_config.yml  languages/  layout/  package.json  README.md  <span class="built_in">source</span>/</div><div class="line"></div><div class="line"><span class="comment">#简单修改</span></div><div class="line">$ grep -v <span class="string">'#'</span> _config.yml | grep -v ^$</div><div class="line">menu:</div><div class="line">  博客首页: /Home</div><div class="line">  作品展示: /works</div><div class="line">  留言打卡: /about</div><div class="line">  前端导航: /FrontEndGuide</div><div class="line">avatar: img/head.jpg</div><div class="line">favicon: img/favicon.png</div><div class="line">subnav:</div><div class="line">  mail: <span class="string">"http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=Uyo1IDsyITYTNTwrPjI6P30wPD4"</span></div><div class="line">  github: <span class="string">"https://yfshare.github.io/"</span></div><div class="line">  QQ: <span class="string">"http://wpa.qq.com/msgrd?V=1&amp;Uin=838554604"</span></div><div class="line">disqus:</div><div class="line">  shortname:</div><div class="line">duoshuo:</div><div class="line">  on: <span class="literal">true</span></div><div class="line">  domain:</div><div class="line">youyan:</div><div class="line">  id:</div><div class="line">background:</div><div class="line">  on: <span class="literal">true</span></div><div class="line">  background_sum: 24</div><div class="line">  background_image: 109</div><div class="line">highlight_style:</div><div class="line">  on: <span class="literal">true</span></div><div class="line">  inline_code: 5</div><div class="line">  code_block: 5</div><div class="line">blockquote_style:</div><div class="line">left_col_width: 300</div><div class="line">toc_nowrap: <span class="literal">false</span></div><div class="line">animate: <span class="literal">true</span></div><div class="line">tagcloud: <span class="literal">true</span></div><div class="line">friends:</div><div class="line">  name: http://luuman.github.io/</div><div class="line">aboutme: 纯海迷、爱运动、爱交友、爱旅行、喜欢接触新鲜事物、迎接新的挑战，更爱游离于错综复杂的编码与逻辑中</div><div class="line">open_in_new: <span class="literal">false</span></div><div class="line">rss: /atom.xml</div><div class="line">fancybox: <span class="literal">true</span></div><div class="line">mathjax: <span class="literal">false</span></div><div class="line">baidushare: <span class="literal">true</span></div><div class="line">google_analytics:</div><div class="line">baidu_analytics:</div><div class="line">visit_counter:</div><div class="line">  on: <span class="literal">true</span></div><div class="line">  site_visit: 海贼到访数</div><div class="line">  page_visit: 本页阅读量</div><div class="line">TipTitle: <span class="literal">true</span></div><div class="line">$</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo deploy   <span class="comment">#推送代码到Githup</span></div></pre></td></tr></table></figure>
<p>访问：<a href="https://yfshare.github.io" target="_blank" rel="external">https://yfshare.github.io</a> 即可<br><img src="http://note.youdao.com/yws/api/personal/file/4D20AC823BA0467A8A7662371FFA143A?method=download&amp;shareKey=6aabadd2208b268f4f9dece6ecf70286" alt="image">  </p>
<p><a href="http://openmail.qq.com/cgi-bin/dy_template?sid=aITh-q3yfoUkTn8n&amp;t=index&amp;sub=&amp;r=7d887de7d8816f125839155a7c4f8f16" target="_blank" rel="external">QQ邮箱开放平台</a>  </p>
<p>参考文档：<a href="http://www.cnblogs.com/zhcncn/p/4097881.html" target="_blank" rel="external">http://www.cnblogs.com/zhcncn/p/4097881.html</a><br>　　　　　<a href="http://www.jianshu.com/p/05289a4bc8b2" target="_blank" rel="external">http://www.jianshu.com/p/05289a4bc8b2</a><br>　　　　　<a href="https://qiutc.me/post/使用hexo-github搭建静态博客.html" target="_blank" rel="external">https://qiutc.me/post/使用hexo-github搭建静态博客.html</a><br>　　　　　<a href="https://wsgzao.github.io/post/hexo-guide/#" target="_blank" rel="external">https://wsgzao.github.io/post/hexo-guide/#</a><br>　　　　　<a href="https://xuanwo.org/2015/03/26/hexo-intor/" target="_blank" rel="external">https://xuanwo.org/2015/03/26/hexo-intor/</a><br>　　　　　<a href="http://jiji262.github.io/2016/04/15/2016-04-15-hexo-github-pages-blog/" target="_blank" rel="external">http://jiji262.github.io/2016/04/15/2016-04-15-hexo-github-pages-blog/</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/02/13/使用GitHub-Hexo搭建免费静态Blog/">http://www.yfshare.vip/2017/02/13/使用GitHub-Hexo搭建免费静态Blog/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Redis HA+Sentinel]]></title>
      <url>http://www.yfshare.vip/2016/11/18/Redis-HA-Sentinel/</url>
      <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>sentinel是一个管理redis实例的工具，它可以实现对redis的监控、通知、自动故障转移。sentinel不断的检测redis实例是否可以正常工作，通过API向其他程序报告redis的状态，如果redis master不能工作，则会自动启动故障转移进程，将其中的一个slave提升为master，其他的slave重新设置新的master服务器。<br><a id="more"></a></p>
<h4 id="Sentinel介绍"><a href="#Sentinel介绍" class="headerlink" title="Sentinel介绍"></a>Sentinel介绍</h4><p>Redis Sentinel是一个分布式架构，包含若干个Sentinel节点和Redis数据节点，每个Sentinel节点会对数据节点和其余Sentinel节点进行监控，当发现节点不可达时，会对节点做下线标识.<br>如果被标识的是主节点，他还会选择和其他Sentinel节点进行“协商”，当大多数的Sentinel节点都认为主节点不可达时，他们会选举出一个Sentinel节点来完成自动故障转移工作，同时将这个变化通知给Redis应用方.<br>整个过程完全自动，不需要人工介入，所以可以很好解决Redis的高可用问题.  </p>
<p>redis主从复制<br>Redis主从复制可将主节点数据同步给从节点，从节点此时有两个作用:  </p>
<ul>
<li>一旦主节点宕机，从节点作为主节点的备份可以随时顶上来</li>
<li>扩展主节点的读能力，分担主节点读压力</li>
</ul>
<p>环境：<br>　　　Centos 7.4<br>　　　Redis version：3.2.10  </p>
<p>分别有3个Sentinel节点，1个主节点，2个从节点组成一个Redis Sentinel<br>Role | IP | Port<br>—|—|—<br>master | 192.168.1.100 | 6379<br>slave1 | 192.168.1.101 | 6379<br>slave2 | 192.168.1.200 | 6379<br>Sentinel1 | 192.168.1.100 | 26379<br>Sentinel2 | 192.168.1.101 | 26379<br>Sentinel3 | 192.168.1.200 | 26379</p>
<h4 id="配置redis"><a href="#配置redis" class="headerlink" title="配置redis"></a>配置redis</h4><p>关闭防火墙和selinux<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># iptables -F</span></div><div class="line">[root@localhost ~]<span class="comment"># setenforce 0</span></div></pre></td></tr></table></figure></p>
<p>三个redis部署在不同的服务器上<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># yum install -y https://mirrors.aliyun.com/epel/epel-release-latest-7.noarch.rpm</span></div><div class="line">[root@localhost ~]<span class="comment"># yum clean all</span></div><div class="line">[root@localhost ~]<span class="comment"># yum install redis</span></div></pre></td></tr></table></figure></p>
<p><img src="https://note.youdao.com/yws/api/personal/file/E073E30FDFBC4276B112D4C796DF6709?method=download&amp;shareKey=0ff579ce084b511e88d0d5dbc1c8a792" alt="redis主从关系">  </p>
<p>master redis配置<br>打井号的为主要配置，其余为默认配置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># grep -v '^#' /etc/redis.conf |grep -v '^$'</span></div><div class="line"><span class="built_in">bind</span> 192.168.1.100        <span class="comment">#</span></div><div class="line">protected-mode yes        <span class="comment">#</span></div><div class="line">port 6379                 <span class="comment">#</span></div><div class="line">tcp-backlog 511</div><div class="line">timeout 0</div><div class="line">tcp-keepalive 300</div><div class="line">daemonize yes             <span class="comment">#</span></div><div class="line">supervised no</div><div class="line">pidfile /var/run/redis_6379.pid</div><div class="line">loglevel notice</div><div class="line">logfile /var/<span class="built_in">log</span>/redis/redis.log</div><div class="line">databases 16</div><div class="line">save 900 1</div><div class="line">save 300 10</div><div class="line">save 60 10000</div><div class="line">stop-writes-on-bgsave-error yes</div><div class="line">rdbcompression yes</div><div class="line">rdbchecksum yes</div><div class="line">dbfilename dump.rdb</div><div class="line">dir /var/lib/redis</div><div class="line">slave-serve-stale-data yes</div><div class="line">slave-read-only yes</div><div class="line">repl-diskless-sync no</div><div class="line">repl-diskless-sync-delay 5</div><div class="line">repl-disable-tcp-nodelay no</div><div class="line">slave-priority 100</div><div class="line">requirepass 1234567           <span class="comment">#</span></div><div class="line">appendonly no</div><div class="line">appendfilename <span class="string">"appendonly.aof"</span></div><div class="line">appendfsync everysec</div><div class="line">no-appendfsync-on-rewrite no</div><div class="line">auto-aof-rewrite-percentage 100</div><div class="line">auto-aof-rewrite-min-size 64mb</div><div class="line">aof-load-truncated yes</div><div class="line">lua-time-limit 5000</div><div class="line">slowlog-log-slower-than 10000</div><div class="line">slowlog-max-len 128</div><div class="line">latency-monitor-threshold 0</div><div class="line">notify-keyspace-events <span class="string">""</span></div><div class="line"><span class="built_in">hash</span>-max-ziplist-entries 512</div><div class="line"><span class="built_in">hash</span>-max-ziplist-value 64</div><div class="line">list-max-ziplist-size -2</div><div class="line">list-compress-depth 0</div><div class="line"><span class="built_in">set</span>-max-intset-entries 512</div><div class="line">zset-max-ziplist-entries 128</div><div class="line">zset-max-ziplist-value 64</div><div class="line">hll-sparse-max-bytes 3000</div><div class="line">activerehashing yes</div><div class="line">client-output-buffer-limit normal 0 0 0</div><div class="line">client-output-buffer-limit slave 256mb 64mb 60</div><div class="line">client-output-buffer-limit pubsub 32mb 8mb 60</div><div class="line">hz 10</div><div class="line">aof-rewrite-incremental-fsync yes</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>slave1 redis配置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># grep -v '^#' /etc/redis.conf |grep -v '^$'</span></div><div class="line"><span class="built_in">bind</span> 192.168.1.101               <span class="comment">#</span></div><div class="line">protected-mode yes               <span class="comment">#</span></div><div class="line">port 6379                        <span class="comment">#</span></div><div class="line">tcp-backlog 511</div><div class="line">timeout 0</div><div class="line">tcp-keepalive 300</div><div class="line">daemonize yes                    <span class="comment">#</span></div><div class="line">supervised no</div><div class="line">pidfile /var/run/redis_6379.pid</div><div class="line">loglevel notice</div><div class="line">logfile /var/<span class="built_in">log</span>/redis/redis.log</div><div class="line">databases 16</div><div class="line">save 900 1</div><div class="line">save 300 10</div><div class="line">save 60 10000</div><div class="line">stop-writes-on-bgsave-error yes</div><div class="line">rdbcompression yes</div><div class="line">rdbchecksum yes</div><div class="line">dbfilename dump.rdb</div><div class="line">dir /var/lib/redis</div><div class="line">slaveof 192.168.1.100 6379           <span class="comment">#</span></div><div class="line">masterauth <span class="string">"1234567"</span>                 <span class="comment">#</span></div><div class="line">slave-serve-stale-data yes</div><div class="line">slave-read-only yes</div><div class="line">repl-diskless-sync no</div><div class="line">repl-diskless-sync-delay 5</div><div class="line">repl-disable-tcp-nodelay no</div><div class="line">slave-priority 100</div><div class="line">appendonly no</div><div class="line">appendfilename <span class="string">"appendonly.aof"</span></div><div class="line">appendfsync everysec</div><div class="line">no-appendfsync-on-rewrite no</div><div class="line">auto-aof-rewrite-percentage 100</div><div class="line">auto-aof-rewrite-min-size 64mb</div><div class="line">aof-load-truncated yes</div><div class="line">lua-time-limit 5000</div><div class="line">slowlog-log-slower-than 10000</div><div class="line">slowlog-max-len 128</div><div class="line">latency-monitor-threshold 0</div><div class="line">notify-keyspace-events <span class="string">""</span></div><div class="line"><span class="built_in">hash</span>-max-ziplist-entries 512</div><div class="line"><span class="built_in">hash</span>-max-ziplist-value 64</div><div class="line">list-max-ziplist-size -2</div><div class="line">list-compress-depth 0</div><div class="line"><span class="built_in">set</span>-max-intset-entries 512</div><div class="line">zset-max-ziplist-entries 128</div><div class="line">zset-max-ziplist-value 64</div><div class="line">hll-sparse-max-bytes 3000</div><div class="line">activerehashing yes</div><div class="line">client-output-buffer-limit normal 0 0 0</div><div class="line">client-output-buffer-limit slave 256mb 64mb 60</div><div class="line">client-output-buffer-limit pubsub 32mb 8mb 60</div><div class="line">hz 10</div><div class="line">aof-rewrite-incremental-fsync yes</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>slave2 redis配置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># grep -v '^#' /etc/redis.conf |grep -v '^$'</span></div><div class="line"><span class="built_in">bind</span> 192.168.1.200                <span class="comment">#</span></div><div class="line">protected-mode yes                <span class="comment">#</span></div><div class="line">port 6379                         <span class="comment">#</span></div><div class="line">tcp-backlog 511</div><div class="line">timeout 0</div><div class="line">tcp-keepalive 300</div><div class="line">daemonize yes                     <span class="comment">#</span></div><div class="line">supervised no</div><div class="line">pidfile /var/run/redis_6379.pid</div><div class="line">loglevel notice</div><div class="line">logfile /var/<span class="built_in">log</span>/redis/redis.log</div><div class="line">databases 16</div><div class="line">save 900 1</div><div class="line">save 300 10</div><div class="line">save 60 10000</div><div class="line">stop-writes-on-bgsave-error yes</div><div class="line">rdbcompression yes</div><div class="line">rdbchecksum yes</div><div class="line">dbfilename dump.rdb</div><div class="line">dir /var/lib/redis</div><div class="line">slaveof 192.168.1.100 6379        <span class="comment">#</span></div><div class="line">masterauth <span class="string">"1234567"</span>              <span class="comment">#</span></div><div class="line">slave-serve-stale-data yes</div><div class="line">slave-read-only yes</div><div class="line">repl-diskless-sync no</div><div class="line">repl-diskless-sync-delay 5</div><div class="line">repl-disable-tcp-nodelay no</div><div class="line">slave-priority 100</div><div class="line">appendonly no</div><div class="line">appendfilename <span class="string">"appendonly.aof"</span></div><div class="line">appendfsync everysec</div><div class="line">no-appendfsync-on-rewrite no</div><div class="line">auto-aof-rewrite-percentage 100</div><div class="line">auto-aof-rewrite-min-size 64mb</div><div class="line">aof-load-truncated yes</div><div class="line">lua-time-limit 5000</div><div class="line">slowlog-log-slower-than 10000</div><div class="line">slowlog-max-len 128</div><div class="line">latency-monitor-threshold 0</div><div class="line">notify-keyspace-events <span class="string">""</span></div><div class="line"><span class="built_in">hash</span>-max-ziplist-entries 512</div><div class="line"><span class="built_in">hash</span>-max-ziplist-value 64</div><div class="line">list-max-ziplist-size -2</div><div class="line">list-compress-depth 0</div><div class="line"><span class="built_in">set</span>-max-intset-entries 512</div><div class="line">zset-max-ziplist-entries 128</div><div class="line">zset-max-ziplist-value 64</div><div class="line">hll-sparse-max-bytes 3000</div><div class="line">activerehashing yes</div><div class="line">client-output-buffer-limit normal 0 0 0</div><div class="line">client-output-buffer-limit slave 256mb 64mb 60</div><div class="line">client-output-buffer-limit pubsub 32mb 8mb 60</div><div class="line">hz 10</div><div class="line">aof-rewrite-incremental-fsync yes</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<h4 id="启动redis"><a href="#启动redis" class="headerlink" title="启动redis"></a>启动redis</h4><p>先启动redis master，在启动redis slave<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># redis-server /etc/redis.conf</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># redis-cli -h 192.168.1.100 -p 6379 -a '1234567'</span></div><div class="line">192.168.1.100:6379&gt; info replication</div><div class="line"><span class="comment"># Replication</span></div><div class="line">role:master</div><div class="line">connected_slaves:2</div><div class="line">slave0:ip=192.168.1.101,port=6379,state=online,offset=1,lag=0</div><div class="line">slave1:ip=192.168.1.200,port=6379,state=online,offset=1,lag=0</div><div class="line">master_repl_offset:1</div><div class="line">repl_backlog_active:1</div><div class="line">repl_backlog_size:1048576</div><div class="line">repl_backlog_first_byte_offset:2</div><div class="line">repl_backlog_histlen:0</div><div class="line">192.168.1.100:6379&gt;</div></pre></td></tr></table></figure>
<h4 id="部署Sentinel节点"><a href="#部署Sentinel节点" class="headerlink" title="部署Sentinel节点"></a>部署Sentinel节点</h4><p>三个Sentinel部署在不同的服务器上  </p>
<p>Sentinel1配置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># grep -iv '^#' /etc/redis-sentinel.conf | grep -iv '^$'</span></div><div class="line"><span class="built_in">bind</span> 192.168.1.100        <span class="comment">#</span></div><div class="line">port 26379                <span class="comment">#</span></div><div class="line">daemon yes                <span class="comment">#</span></div><div class="line">dir <span class="string">"/opt/redis-sentinel/data"</span>       <span class="comment">#</span></div><div class="line"><span class="comment">#当前Sentinel节点监控192.168.1.100:6379这个主节点</span></div><div class="line"><span class="comment">#2代表判断主节点失败至少需要2个Sentinel节点同意</span></div><div class="line"><span class="comment">#mymaster是主节点的别名</span></div><div class="line">sentinel monitor mymaster 192.168.1.100 6379 2    <span class="comment">#</span></div><div class="line">sentinel auth-pass mymaster 1234567               <span class="comment">#redis启动了身份验证</span></div><div class="line"><span class="comment">#每个Sentinel节点都要定期PING命令来判断Redis数据节点和其余Sentinel节点是否可达，如果超过30000毫秒且没有回复，则判定不可达</span></div><div class="line">sentinel down-after-milliseconds mymaster 30000</div><div class="line"><span class="comment">#当Sentinel节点集合对主节点故障判定达成一致时，Sentinel领导者节点会做故障转移操作，选出新的主节点，原来的从节点会向新的主节点发起复制操作，限制每次向新的主节点发起复制操作的从节点个数为1</span></div><div class="line">sentinel parallel-syncs mymaster 1</div><div class="line"><span class="comment">#故障转移超时时间为180000毫秒</span></div><div class="line">sentinel failover-timeout mymaster 180000</div><div class="line">logfile /var/<span class="built_in">log</span>/redis/sentinel.log</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<h4 id="启动sentinel"><a href="#启动sentinel" class="headerlink" title="启动sentinel"></a>启动sentinel</h4><p><img src="https://note.youdao.com/yws/api/personal/file/4FE2253C42C4407BBF2CFD8702B70DDA?method=download&amp;shareKey=bdc18c3e861af6b6dea8bf8c6a6c5339" alt="Sentinelt拓扑图"><br>当部署号Redis Sentinel之后，会有如下变化  </p>
<ul>
<li>Sentinel节点自动发现了从节点、其余Sentinel节点  </li>
<li>去掉了默认配置，例如：<code>parallel-syncs</code>、<code>failover-timeout</code>  </li>
<li>新添加了纪元(epoch)参数  </li>
</ul>
<p>需要先启动sentinel再启动redis<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># redis-sentinel /etc/redis-sentinel.conf &amp;</span></div><div class="line">[root@localhost ~]<span class="comment"># redis-server /etc/redis.conf</span></div></pre></td></tr></table></figure></p>
<p>查看日志<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">11116:X 28 Apr 00:59:09.095 <span class="comment"># WARNING: The TCP backlog setting of 511 cannot be enforced be cause /proc/sys/net/core/somaxconn is set to the lower value of 128.11116:X 28 Apr 00:59:09.095 # Sentinel ID is 1f8abc9be76435a72401e236767cced5c8d535ba</span></div><div class="line">11116:X 28 Apr 00:59:09.095 <span class="comment"># +monitor master mymaster 192.168.1.100 6379 quorum 2</span></div><div class="line">11116:X 28 Apr 00:59:29.978 * +sentinel sentinel 8f2a2091de02341d21d8f5fb9e00cbf72112e007 192.168.1.200 26379 @ mymaster 192.168.1.100 637911116:X 28 Apr 00:59:31.748 * +sentinel sentinel 9b905b81691a53a5b2ae53b7bbb9b286f047f5b6 192.168.1.101 26379 @ mymaster 192.168.1.100 637911116:X 28 Apr 00:59:49.953 * +slave slave 192.168.1.101:6379 192.168.1.101 6379 @ mymaster 192.168.1.100 637911116:X 28 Apr 00:59:49.967 * +slave slave 192.168.1.200:6379 192.168.1.200 6379 @ mymaster 192.168.1.100 6379</div></pre></td></tr></table></figure></p>
<p>通过redis sentinel日志可以看到redis-192.168.1.101和redis-192.168.1.200已经加入到mymaster组，现在mymaster组有三台redis服务器了  </p>
<p>在主节点上看<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">192.168.1.100:6379&gt; info replication</div><div class="line"><span class="comment"># Replication</span></div><div class="line">role:master</div><div class="line">connected_slaves:2</div><div class="line">slave0:ip=192.168.1.101,port=6379,state=online,offset=132341,lag=1</div><div class="line">slave1:ip=192.168.1.200,port=6379,state=online,offset=132341,lag=1</div><div class="line">master_repl_offset:132341</div><div class="line">repl_backlog_active:1</div><div class="line">repl_backlog_size:1048576</div><div class="line">repl_backlog_first_byte_offset:2</div><div class="line">repl_backlog_histlen:132340</div><div class="line">192.168.1.100:6379&gt;</div></pre></td></tr></table></figure></p>
<p>在从节点上看<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">192.168.1.101:6379&gt; info replication</div><div class="line"><span class="comment"># Replication</span></div><div class="line">role:slave</div><div class="line">master_host:192.168.1.100</div><div class="line">master_port:6379</div><div class="line">master_link_status:down</div><div class="line">master_last_io_seconds_ago:-1</div><div class="line">master_sync_in_progress:0</div><div class="line">slave_repl_offset:421</div><div class="line">master_link_down_since_seconds:43</div><div class="line">slave_priority:100</div><div class="line">slave_read_only:1</div><div class="line">connected_slaves:0</div><div class="line">master_repl_offset:0</div><div class="line">repl_backlog_active:0</div><div class="line">repl_backlog_size:1048576</div><div class="line">repl_backlog_first_byte_offset:0</div><div class="line">repl_backlog_histlen:0</div><div class="line">192.168.1.101:6379&gt;</div></pre></td></tr></table></figure></p>
<h4 id="测试Sentinel的故障转移"><a href="#测试Sentinel的故障转移" class="headerlink" title="测试Sentinel的故障转移"></a>测试Sentinel的故障转移</h4><p><img src="https://note.youdao.com/yws/api/personal/file/944C4B085C2C47819121FA6349C756FF?method=download&amp;shareKey=6d541872aca92f1f23c4c6fd4568d419" alt="redis节点终止复制">  </p>
<p>Redis Sentinel对主节点进行客观下线（Objectively Down， 简称 ODOWN）的判断，确认主节点不可达，则通知从节点中止复制主节点的操作<br>当主节点下线时长超过配置的下线时长30000秒，<code>Redis Sentinel</code>执行故障转移操作  </p>
<p>手动让redis master(192.168.1.100)下线<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># ps -ef |grep -i redis | egrep -iv 'color|grep'</span></div><div class="line">root      11120      1  0 00:59 ?        00:00:05 redis-server 192.168.1.100:6379</div><div class="line">[root@localhost ~]<span class="comment"># kill 11120</span></div></pre></td></tr></table></figure></p>
<p>再来看下redis sentinel日志<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">11116:X 28 Apr 01:13:24.489 <span class="comment"># +sdown master mymaster 192.168.1.100 6379</span></div><div class="line">11116:X 28 Apr 01:13:24.531 <span class="comment"># +new-epoch 1</span></div><div class="line">11116:X 28 Apr 01:13:24.533 <span class="comment"># +vote-for-leader 9b905b81691a53a5b2ae53b7bbb9b286f047f5b6 1</span></div><div class="line">11116:X 28 Apr 01:13:24.566 <span class="comment"># +odown master mymaster 192.168.1.100 6379 #quorum 3/2</span></div><div class="line">11116:X 28 Apr 01:13:24.567 <span class="comment"># Next failover delay: I will not start a failover before Sat Apr 28 01:19:24 201811116:X 28 Apr 01:13:25.238 # +config-update-from sentinel 9b905b81691a53a5b2ae53b7bbb9b286f047f5b6 192.168.1.101 26379 @ mymaster 192.168.1.100 637911116:X 28 Apr 01:13:25.239 # +switch-master mymaster 192.168.1.100 6379 192.168.1.200 6379</span></div><div class="line">11116:X 28 Apr 01:13:25.240 * +slave slave 192.168.1.101:6379 192.168.1.101 6379 @ mymaster 192.168.1.200 6379</div></pre></td></tr></table></figure></p>
<p>通过日志观察，现在redis master切换到redis-192.168.1.200上了<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">192.168.1.200:6379&gt; info replication</div><div class="line"><span class="comment"># Replication</span></div><div class="line">role:master</div><div class="line">connected_slaves:0</div><div class="line">master_repl_offset:0</div><div class="line">repl_backlog_active:0</div><div class="line">repl_backlog_size:1048576</div><div class="line">repl_backlog_first_byte_offset:0</div><div class="line">repl_backlog_histlen:0</div><div class="line">192.168.1.200:6379&gt;</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">192.168.1.101:6379&gt; info replication</div><div class="line"><span class="comment"># Replication</span></div><div class="line">role:slave</div><div class="line">master_host:192.168.1.200</div><div class="line">master_port:6379</div><div class="line">master_link_status:down</div><div class="line">master_last_io_seconds_ago:-1</div><div class="line">master_sync_in_progress:0</div><div class="line">slave_repl_offset:1</div><div class="line">master_link_down_since_seconds:1524849879</div><div class="line">slave_priority:100</div><div class="line">slave_read_only:1</div><div class="line">connected_slaves:0</div><div class="line">master_repl_offset:0</div><div class="line">repl_backlog_active:0</div><div class="line">repl_backlog_size:1048576</div><div class="line">repl_backlog_first_byte_offset:0</div><div class="line">repl_backlog_histlen:0</div><div class="line">192.168.1.101:6379&gt;</div></pre></td></tr></table></figure>
<p><img src="https://note.youdao.com/yws/api/personal/file/5EDB333796B64D89AE22BE52AA3568A4?method=download&amp;shareKey=762ff90f872888bf53fbbd3f107be608" alt="redis降级"><br>从上面的逻辑架构和故障转移试验中，可以看出Redis Sentinel的以下几个功能  </p>
<ul>
<li>监控：Sentinel节点会定期检测Redis数据节点和其余Sentinel节点是否可达  </li>
<li>通知：Sentinel节点会将故障转移通知给应用方  </li>
<li>主节点故障转移：实现从节点晋升为主节点并维护后续正确的主从关系  </li>
<li>配置提供者：在Redis Sentinel结构中，客户端在初始化的时候连接的是Sentinel节点集合，从中获取主节点信息  </li>
</ul>
<p><img src="https://note.youdao.com/yws/api/personal/file/63A94A6AE11442378D1791244FD1BF2E?method=download&amp;shareKey=7db2ae3f78913cb6a11bfedaee09ea4c" alt="redis连接中断"><br>现在启动redis-192.168.1.100，再来看看下redis sentinel日志<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">11116:X 28 Apr 01:26:08.209 * +convert-to-slave slave 192.168.1.100:6379 192.168.1.100 6379 @ mymaster 192.168.1.200 6379</div></pre></td></tr></table></figure></p>
<p>通过查看redis sentinel日志，当redis-192.168.1.100上线后，角色转换为slave了<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">192.168.1.100:6379&gt; info replication</div><div class="line"><span class="comment"># Replication</span></div><div class="line">role:slave</div><div class="line">master_host:192.168.1.200</div><div class="line">master_port:6379</div><div class="line">master_link_status:up</div><div class="line">master_last_io_seconds_ago:0</div><div class="line">master_sync_in_progress:0</div><div class="line">slave_repl_offset:82068</div><div class="line">slave_priority:100</div><div class="line">slave_read_only:1</div><div class="line">connected_slaves:0</div><div class="line">master_repl_offset:0</div><div class="line">repl_backlog_active:0</div><div class="line">repl_backlog_size:1048576</div><div class="line">repl_backlog_first_byte_offset:0</div><div class="line">repl_backlog_histlen:0</div><div class="line">192.168.1.100:6379&gt;</div></pre></td></tr></table></figure></p>
<h4 id="数据测试"><a href="#数据测试" class="headerlink" title="数据测试"></a>数据测试</h4><p>redis主节点数据写入测试<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">192.168.1.100:6379&gt; <span class="built_in">set</span> myname jack_wang</div><div class="line">OK</div><div class="line">192.168.1.100:6379&gt;</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">192.168.1.101:6379&gt; keys *</div><div class="line">1) <span class="string">"myname"</span></div><div class="line">192.168.1.101:6379&gt;</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">192.168.1.200:6379&gt; keys *</div><div class="line">1) <span class="string">"myname"</span></div><div class="line">192.168.1.200:6379&gt;</div></pre></td></tr></table></figure>
<p>OK，测试成功。  </p>
<p>注：这个版本的redis好像没有<code>sentinel</code>命令<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">192.168.1.100:6379&gt; sentinel masters</div><div class="line">(error) ERR unknown <span class="built_in">command</span> <span class="string">'sentinel'</span></div></pre></td></tr></table></figure></p>
<p>参考：<a href="https://blog.csdn.net/men_wen/article/details/72724406" target="_blank" rel="external">https://blog.csdn.net/men_wen/article/details/72724406</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2016/11/18/Redis-HA-Sentinel/">http://www.yfshare.vip/2016/11/18/Redis-HA-Sentinel/</a></p>
]]></content>
    </entry>
    
  
  
</search>

<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Blog"><title>k8s集群水平扩展(HPA) | Jack Wang Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">k8s集群水平扩展(HPA)</h1><a id="logo" href="/.">Jack Wang Blog</a><p class="description">Goals determine what you are going to be</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa icon-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">k8s集群水平扩展(HPA)</h1><div class="post-meta">Jan 28, 2019<span> | </span><span class="category"><a href="/categories/K8S/">K8S</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2019/01/28/k8s集群水平扩展-HPA/" href="/2019/01/28/k8s集群水平扩展-HPA/#disqus_thread" class="disqus-comment-count"></a><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#简介"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#工作流程"><span class="toc-number">2.</span> <span class="toc-text">工作流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#自动伸缩算法"><span class="toc-number">3.</span> <span class="toc-text">自动伸缩算法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#环境说明"><span class="toc-number">4.</span> <span class="toc-text">环境说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#部署HPA"><span class="toc-number">5.</span> <span class="toc-text">部署HPA</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#创建Deployment-POD应用nginx"><span class="toc-number">5.1.</span> <span class="toc-text">创建Deployment POD应用nginx</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#创建nginx应用的HPA"><span class="toc-number">5.2.</span> <span class="toc-text">创建nginx应用的HPA</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Q1"><span class="toc-number">5.2.1.</span> <span class="toc-text">Q1</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Q2"><span class="toc-number">5.2.2.</span> <span class="toc-text">Q2</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HPA测试"><span class="toc-number">6.</span> <span class="toc-text">HPA测试</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#autoscaling-v1"><span class="toc-number">6.1.</span> <span class="toc-text">autoscaling/v1</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#autoscaling-v2beta1"><span class="toc-number">6.2.</span> <span class="toc-text">autoscaling/v2beta1</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#autoscaling-v2beta2"><span class="toc-number">6.3.</span> <span class="toc-text">autoscaling/v2beta2</span></a></li></ol></li></ol></div></div><div class="post-content"><script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>Horizontal Pod Autoscaling，简称HPA，是Kubernetes中实现POD水平自动伸缩的功能。<br><a id="more"></a></p>
<h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>K8S集群可以通过Replication Controller的scale机制完成服务的扩容或缩容，实现具有伸缩性的服务。<br>K8S自动伸缩分为：  </p>
<ul>
<li>sacle手动伸缩。见<a href="http://www.yfshare.vip/2018/05/28/k8s%E6%BB%9A%E5%8A%A8%E5%8D%87%E7%BA%A7-RollingUpdate/">k8s滚动升级(RollingUpdate)</a>  </li>
<li>autoscale自动伸缩，见<a href="http://www.yfshare.vip/2019/01/28/k8s%E9%9B%86%E7%BE%A4%E6%B0%B4%E5%B9%B3%E6%89%A9%E5%B1%95-HPA/#autoscaling-v2beta2">HPA</a>。  </li>
</ul>
<p>自动扩展主要分为两种：  </p>
<ul>
<li>水平扩展(scale out)，针对于实例数目的增减。  </li>
<li>垂直扩展(scal up)，即单个实例可以使用的资源的增减, 比如增加cpu和增大内存。  </li>
</ul>
<p>HPA属于前者。它可以根据CPU使用率或应用自定义metrics自动扩展Pod数量(支持 replication controller、deployment 和 replica set)。<br><img src="https://note.youdao.com/yws/api/personal/file/F521C66C09BD4EA0A0D7B1C02AF49CE9?method=download&amp;shareKey=fb8d078ed30b70f326f6d6e37c1b3cc3" alt="HPA架构">  </p>
<p>获取metrics的两种方式：  </p>
<ul>
<li>Heapster：heapster提供metrics服务，但是在v1(autoscaling/v1)版本中仅支持以CPU作为扩展度量指标。而其他比如：内存，网络流量，qps等目前处于beta阶段(autoscaling/v2beta1)。  </li>
<li>Cousom：同样处于beta阶段(autoscaling/v2beta1)，但是涉及到自定义的REST API的开发，复杂度会大一些，并且当需要从自定义的监控中获取数据时，只能设置绝对值，无法设置使用率。  </li>
</ul>
<h4 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h4><ul>
<li>创建HPA资源，设定目标CPU使用率限额，以及最大/最小实例数，一定要设置Pod的资源限制参数: <code>request</code>，否则HPA不会工作。  </li>
<li>控制管理器每隔30s(在<code>kube-controller-manager.service</code>中可以通过<code>–horizontal-pod-autoscaler-sync-period</code>修改)查询metrics的资源使用情况。  </li>
<li>然后与创建时设定的值和指标做对比(平均值之和/限额)，求出目标调整的实例个数。  </li>
<li>目标调整的实例数不能超过第一条中设定的最大/最小实例数。如果没有超过，则扩容；超过，则扩容至最大的实例个数。  </li>
<li>重复第2-4步。  </li>
</ul>
<h4 id="自动伸缩算法"><a href="#自动伸缩算法" class="headerlink" title="自动伸缩算法"></a>自动伸缩算法</h4><p>HPA Controller会通过调整副本数量使得CPU使用率尽量向期望值靠近，而且不是完全相等。另官方考虑到自动扩展的决策可能需要一段时间才会生效：例如当pod所需要的CPU负荷过大，从而在创建一个新pod的过程中，系统的CPU使用量可能会同样在有一个攀升的过程。所以在每一次作出决策后的一段时间内，将不再进行扩展决策。对于扩容而言，这个时间段为3分钟，缩容为5分钟(可以通过<code>--horizontal-pod-autoscaler-downscale-delay</code>，<code>--horizontal-pod-autoscaler-upscale-delay</code>进行调整)。  </p>
<ul>
<li>HPA Controller中有一个tolerance（容忍力）的概念，它允许一定范围内的使用量的不稳定，现在默认为0.1，这也是出于维护系统稳定性的考虑。例如设定HPA调度策略为cpu使用率高于50%触发扩容，那么只有当使用率大于55%或者小于45%才会触发伸缩活动，HPA会尽力把Pod的使用率控制在这个范围之间。  </li>
<li>具体的每次扩容或者缩容的多少Pod的算法为：Ceil(前采集到的使用率 / 用户自定义的使用率) * Pod数量)。  </li>
<li>每次最大扩容pod数量不会超过当前副本数量的2倍。  </li>
</ul>
<h4 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h4><table>
<thead>
<tr>
<th>角色</th>
<th>IP</th>
<th>操作系统版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>master</td>
<td>192.168.1.201</td>
<td>centos 7.4</td>
</tr>
<tr>
<td>etcd1</td>
<td>192.168.1.201</td>
<td>centos 7.4</td>
</tr>
<tr>
<td>etcd2</td>
<td>192.168.1.202</td>
<td>centos 7.4</td>
</tr>
<tr>
<td>etcd3</td>
<td>192.168.1.203</td>
<td>centos 7.4</td>
</tr>
<tr>
<td>node1</td>
<td>192.168.1.204</td>
<td>centos 7.4</td>
</tr>
<tr>
<td>node2</td>
<td>192.168.1.205</td>
<td>centos 7.4</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>环境</th>
<th>软件版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>kubectl server</td>
<td>v1.9.2</td>
</tr>
<tr>
<td>kubectl client</td>
<td>v1.9.2</td>
</tr>
<tr>
<td>Go</td>
<td>go1.9.2</td>
</tr>
<tr>
<td>etcdctl</td>
<td>3.2.15</td>
</tr>
<tr>
<td>etcd</td>
<td>3.2.15</td>
</tr>
<tr>
<td>flanneld</td>
<td>v0.10.0</td>
</tr>
<tr>
<td>cfssl</td>
<td>1.2.0</td>
</tr>
<tr>
<td>docker</td>
<td>18.09.1-beta1</td>
</tr>
</tbody>
</table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># kubectl cluster-info</span></div><div class="line">Kubernetes master is running at https://192.168.1.201:6443</div><div class="line">Heapster is running at https://192.168.1.201:6443/api/v1/namespaces/kube-system/services/heapster/proxy</div><div class="line">monitoring-grafana is running at https://192.168.1.201:6443/api/v1/namespaces/kube-system/services/monitoring-grafana/proxy</div><div class="line">monitoring-influxdb is running at https://192.168.1.201:6443/api/v1/namespaces/kube-system/services/monitoring-influxdb/proxy</div><div class="line">To further debug and diagnose cluster problems, use <span class="string">'kubectl cluster-info dump'</span>.</div><div class="line">[root@master ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment">#  kubectl -s http://192.168.1.201:8080 get componentstatuses </span></div><div class="line">NAME                 STATUS    MESSAGE              ERROR</div><div class="line">controller-manager   Healthy   ok                   </div><div class="line">etcd-2               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;   </div><div class="line">etcd-1               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;   </div><div class="line">scheduler            Healthy   ok                   </div><div class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;   </div><div class="line">[root@master ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># kubectl get nodes</span></div><div class="line">NAME            STATUS    ROLES     AGE       VERSION</div><div class="line">192.168.1.204   Ready     &lt;none&gt;    21h       v1.9.2</div><div class="line">192.168.1.205   Ready     &lt;none&gt;    21h       v1.9.2</div><div class="line">[root@master ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h4 id="部署HPA"><a href="#部署HPA" class="headerlink" title="部署HPA"></a>部署HPA</h4><p>先准备一套K8S集群环境，<a href="http://www.yfshare.vip/2018/02/23/%E9%83%A8%E7%BD%B2TLS-k8s/">环境部署</a>略。  </p>
<h5 id="创建Deployment-POD应用nginx"><a href="#创建Deployment-POD应用nginx" class="headerlink" title="创建Deployment POD应用nginx"></a>创建Deployment POD应用nginx</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># cat nginx.yml </span></div><div class="line">apiVersion: extensions/v1beta1</div><div class="line">kind: Deployment</div><div class="line">metadata:</div><div class="line">  name: nginx</div><div class="line">spec:</div><div class="line">  replicas: 1</div><div class="line">  template:</div><div class="line">    metadata:</div><div class="line">      labels:</div><div class="line">        app: nginx-hpa</div><div class="line">    spec:</div><div class="line">      containers:</div><div class="line">      - name: nginx</div><div class="line">        image: nginx:latest</div><div class="line">        ports:</div><div class="line">        - containerPort: 80</div><div class="line">          name: http</div><div class="line">          protocol: TCP</div><div class="line">        resources:</div><div class="line">          requests:</div><div class="line">            cpu: 0.01</div><div class="line">            memory: 25Mi</div><div class="line">          limits:</div><div class="line">            cpu: 0.05</div><div class="line">            memory: 60Mi</div><div class="line">---</div><div class="line">apiVersion: v1</div><div class="line">kind: Service</div><div class="line">metadata:</div><div class="line">  name: nginx</div><div class="line">  labels:</div><div class="line">    app: nginx-hpa</div><div class="line">spec:</div><div class="line">  selector:</div><div class="line">    app: nginx-hpa</div><div class="line">  <span class="built_in">type</span>: NodePort</div><div class="line">  ports:</div><div class="line">  - name: http</div><div class="line">    protocol: TCP</div><div class="line">    port: 80</div><div class="line">    targetPort: 80</div><div class="line">    nodePort: 30080</div><div class="line">[root@master ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># kubectl apply -f nginx.yml</span></div><div class="line">[root@master ~]<span class="comment"># kubectl get pod -o wide</span></div><div class="line">NAME                     READY     STATUS    RESTARTS   AGE       IP            NODE</div><div class="line">nginx-5dcf548595-bk9cr   1/1       Running   1          14h       172.30.94.2   192.168.1.205</div><div class="line">[root@master ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h5 id="创建nginx应用的HPA"><a href="#创建nginx应用的HPA" class="headerlink" title="创建nginx应用的HPA"></a>创建nginx应用的HPA</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># cat nginx-hpa-cpu.yml </span></div><div class="line">apiVersion: autoscaling/v1</div><div class="line">kind: HorizontalPodAutoscaler</div><div class="line">metadata:</div><div class="line">  name: nginx-hpa</div><div class="line">spec:</div><div class="line">  scaleTargetRef:</div><div class="line">    apiVersion: extensions/v1beta1</div><div class="line">    kind: Deployment</div><div class="line">    name: nginx</div><div class="line">  minReplicas: 1</div><div class="line">  maxReplicas: 5</div><div class="line">  targetCPUUtilizationPercentage: 70</div><div class="line">[root@master ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># kubectl apply -f nginx-hpa-cpu.yml</span></div><div class="line">[root@master ~]<span class="comment"># kubectl get hpa</span></div><div class="line">NAME        REFERENCE          TARGETS    MINPODS   MAXPODS   REPLICAS   AGE</div><div class="line">nginx-hpa   Deployment/nginx   &lt;unknown&gt; / 70%   1         5         1          14h</div><div class="line">[root@master ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h6 id="Q1"><a href="#Q1" class="headerlink" title="Q1"></a>Q1</h6><p>这时发现nginx-hpa获取不到当前的CPU情况（TARGETS）。等待几分钟后执行<code>kubectl describe hpa</code>发现HPA报错信息如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># kubectl describe hpa</span></div><div class="line">Name:                                                  nginx-hpa</div><div class="line">Namespace:                                             default</div><div class="line">Labels:                                                &lt;none&gt;</div><div class="line">Annotations:                                           kubectl.kubernetes.io/last-applied-configuration=&#123;<span class="string">"apiVersion"</span>:<span class="string">"au</span></div><div class="line">toscaling/v1",<span class="string">"kind"</span>:<span class="string">"HorizontalPodAutoscaler"</span>,<span class="string">"metadata"</span>:&#123;<span class="string">"annotations"</span>:&#123;&#125;,<span class="string">"name"</span>:<span class="string">"nginx-hpa"</span>,<span class="string">"namespace"</span>:<span class="string">"default"</span>&#125;,<span class="string">"spec"</span>:&#123;<span class="string">"maxReplic...</span></div><div class="line">CreationTimestamp:                                     Sat, 26 Jan 2019 22:23:08 +0800</div><div class="line">Reference:                                             Deployment/nginx</div><div class="line">Metrics:                                               ( current / target )</div><div class="line">  resource cpu on pods  (as a percentage of request):  &lt;unknown&gt; / 70%</div><div class="line">Min replicas:                                          1</div><div class="line">Max replicas:                                          5</div><div class="line">Conditions:</div><div class="line">  Type           Status  Reason                   Message</div><div class="line">  ----           ------  ------                   -------</div><div class="line">  AbleToScale    True    SucceededGetScale        the HPA controller was able to get the target's current scale</div><div class="line">  ScalingActive  False   FailedGetResourceMetric  the HPA was unable to compute the replica count: unable to get metrics for resource cpu: unable to fetch metrics from API: the server could not find the requested resource (get pods.metrics.k8s.io)</div><div class="line">Events:</div><div class="line">  Type     Reason                        Age               From                       Message</div><div class="line">  ----     ------                        ----              ----                       -------</div><div class="line">  Warning  FailedComputeMetricsReplicas  1m (x12 over 3m)  horizontal-pod-autoscaler  failed to get cpu utilization: unable to get metrics for resource cpu: unable to fetch metrics from API: the server could not find the requested resource (get pods.metrics.k8s.io)</div><div class="line">  Warning  FailedGetResourceMetric       1m (x13 over 3m) horizontal-pod-autoscaler  unable to get metrics for resource cpu: unable to fetch metrics from API: the server could not find the requested resource (get pods.metrics.k8s.io)</div><div class="line">[root@master ~]#</div></pre></td></tr></table></figure></p>
<p>大概意思是HPA无法通过API获取到metrics值。<br>解决办法：<br>在<code>/etc/systemd/system/kube-controller-manager.service</code>配置文件中新增<code>--horizontal-pod-autoscaler-use-rest-clients=false</code>配置参数。然后重启kube-controller-manager服务即可。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">kube-controller-manager<span class="string">'s parameter --horizontal-pod-autoscaler-use-rest-clients in k8s 1.9.0 default value is true , while in k8s 1.8.x is false</span></div><div class="line">change it to false and it works.</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># cat /etc/systemd/system/kube-controller-manager.service </span></div><div class="line">[Unit]</div><div class="line">Description=Kubernetes Controller Manager</div><div class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line"></div><div class="line">[Service]</div><div class="line">ExecStart=/usr/<span class="built_in">local</span>/k8s/bin/kube-controller-manager \</div><div class="line">  --address=127.0.0.1 \</div><div class="line">  --master=http://192.168.1.201:8080 \</div><div class="line">  --allocate-node-cidrs=<span class="literal">true</span> \</div><div class="line">  --service-cluster-ip-range=172.16.0.0/16 \</div><div class="line">  --cluster-cidr=172.30.0.0/16 \</div><div class="line">  --cluster-name=kubernetes \</div><div class="line">  --cluster-signing-cert-file=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  --cluster-signing-key-file=/etc/kubernetes/ssl/ca-key.pem \</div><div class="line">  --service-account-private-key-file=/etc/kubernetes/ssl/ca-key.pem \</div><div class="line">  --root-ca-file=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  --leader-elect=<span class="literal">true</span> \</div><div class="line">  --horizontal-pod-autoscaler-use-rest-clients=<span class="literal">false</span> \</div><div class="line">  --v=2</div><div class="line">Restart=on-failure</div><div class="line">RestartSec=5</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div><div class="line">[root@master ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># systemctl daemon-reload</span></div><div class="line">[root@master ~]<span class="comment"># systemctl restart kube-controller-manager</span></div></pre></td></tr></table></figure>
<h6 id="Q2"><a href="#Q2" class="headerlink" title="Q2"></a>Q2</h6><p>配置并重启完成kube-controller-manager服务后，执行<code>kubectl delete -f nginx-hpa-cpu.yml</code>和<code>kubectl apply -f nginx-hpa-cpu.yml</code>重新创建服务后，发现出现新的错误，信息如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># kubectl describe hpa</span></div><div class="line">Name:                                                  nginx-hpa</div><div class="line">Namespace:                                             default</div><div class="line">Labels:                                                &lt;none&gt;</div><div class="line">Annotations:                                           kubectl.kubernetes.io/last-applied-configuration=&#123;<span class="string">"apiVersion"</span>:<span class="string">"au</span></div><div class="line">scaling/v1",<span class="string">"kind"</span>:<span class="string">"HorizontalPodAutoscaler"</span>,<span class="string">"metadata"</span>:&#123;<span class="string">"annotations"</span>:&#123;&#125;,<span class="string">"name"</span>:<span class="string">"nginx-hpa"</span>,<span class="string">"namespace"</span>:<span class="string">"default"</span>&#125;,<span class="string">"spec&#123;"</span>maxRepl...</div><div class="line">CreationTimestamp:                                     Sun, 27 Jan 2019 00:18:02 +0800</div><div class="line">Reference:                                             Deployment/nginx</div><div class="line">Metrics:                                               ( current / target )</div><div class="line">  resource cpu on pods  (as a percentage of request):  &lt;unknown&gt; / 70%</div><div class="line">M<span class="keyword">in</span> replicas:                                          1</div><div class="line">Max replicas:                                          5</div><div class="line">Conditions:</div><div class="line">  Type           Status  Reason                   Message</div><div class="line">  ----           ------  ------                   -------</div><div class="line">  AbleToScale    True    SucceededGetScale        the HPA controller was able to get the target<span class="string">'s current scale</span></div><div class="line">  ScalingActive  False   FailedGetResourceMetric  the HPA was unable to compute the replica count: unable to get metrics r resource cpu: failed to get pod resource metrics: an error on the server ("Error: 'dial tcp 172.30.9.4:8082: getsockoptconnection timed out<span class="string">'\nTrying to reach: '</span>http://172.30.9.4:8082/apis/metrics/v1alpha1/namespaces/default/pods?labelSelect=app%3Dnginx-hpa<span class="string">'") has prevented the request from succeeding (get services http:heapster:)</span></div><div class="line">Events:</div><div class="line">  Type     Reason                        Age               From                       Message</div><div class="line">  ----     ------                        ----              ----                       -------</div><div class="line">  Warning  FailedUpdateStatus            2m                horizontal-pod-autoscaler  Operation cannot be fulfilled on hozontalpodautoscalers.autoscaling "nginx-hpa": the object has been modified; please apply your changes to the latest versi and try again</div><div class="line">  Warning  FailedGetResourceMetric       24s (x3 over 4m)  horizontal-pod-autoscaler  unable to get metrics for resource u: failed to get pod resource metrics: an error on the server ("Error: 'dial tcp 172.30.9.4:8082: getsockopt: connection med out<span class="string">'\nTrying to reach: '</span>http://172.30.9.4:8082/apis/metrics/v1alpha1/namespaces/default/pods?labelSelector=app%3Dnginhpa<span class="string">'") has prevented the request from succeeding (get services http:heapster:)</span></div><div class="line">  Warning  FailedComputeMetricsReplicas  24s (x3 over 4m)  horizontal-pod-autoscaler  failed to get cpu utilization: unab to get metrics for resource cpu: failed to get pod resource metrics: an error on the server ("Error: 'dial tcp 172.30.9.4:8082: getsockopt: connection timed out<span class="string">'\nTrying to reach: '</span>http://172.30.9.4:8082/apis/metrics/v1alpha1/namespaces/defaulpods?labelSelector=app%3Dnginx-hpa<span class="string">'") has prevented the request from succeeding (get services http:heapster:)</span></div><div class="line">[root@master ~]#</div></pre></td></tr></table></figure></p>
<p>意思是HPA无法连接heapster服务。于是检查heapster服务是否异常。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># kubectl get pod -o wide -n kube-system</span></div><div class="line">NAME                                   READY     STATUS    RESTARTS   AGE         IP           NODE</div><div class="line">heapster-6d5c495969-2rgcr              1/1       Running   2          20h         172.30.9.4   192.168.1.204</div><div class="line">kubernetes-dashboard-cbbf9945c-bkvbk   1/1       Running   2          20h         172.30.9.3   192.168.1.204</div><div class="line">monitoring-grafana-67d68bf9c6-zv928    1/1       Running   2          20h         172.30.9.2   192.168.1.204</div><div class="line">monitoring-influxdb-7c4c46745f-kbxgb   1/1       Running   0          &lt;invalid&gt;   172.30.9.5   192.168.1.204</div><div class="line">[root@master ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>访问kube-dashboard发现POD是可以通过heapster获取到CPU内存的信息的。如下，说明heapster工作正常。<br><img src="https://note.youdao.com/yws/api/personal/file/D33884AB9908421C9276A7C46836CF58?method=download&amp;shareKey=24be8fb4d86c0390d173cac851934a4c" alt="kube-dashboard"><br>于是到node节点手动curl访问连接异常的URL。经测试在node1节点上访问正常。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># curl 'http://172.30.9.4:8082/apis/metrics/v1alpha1/namespaces/default/pods?labelSelector=app%3Dnginx-hpa'</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"metadata"</span>: &#123;&#125;,</div><div class="line">  <span class="string">"items"</span>: [</div><div class="line">   &#123;</div><div class="line">    <span class="string">"metadata"</span>: &#123;</div><div class="line">     <span class="string">"name"</span>: <span class="string">"nginx-5dcf548595-bk9cr"</span>,</div><div class="line">     <span class="string">"namespace"</span>: <span class="string">"default"</span>,</div><div class="line">     <span class="string">"creationTimestamp"</span>: <span class="string">"2019-01-27T07:29:43Z"</span></div><div class="line">    &#125;,</div><div class="line">    <span class="string">"timestamp"</span>: <span class="string">"2019-01-27T07:29:00Z"</span>,</div><div class="line">    <span class="string">"window"</span>: <span class="string">"1m0s"</span>,</div><div class="line">    <span class="string">"containers"</span>: [</div><div class="line">     &#123;</div><div class="line">      <span class="string">"name"</span>: <span class="string">"nginx"</span>,</div><div class="line">      <span class="string">"usage"</span>: &#123;</div><div class="line">       <span class="string">"cpu"</span>: <span class="string">"0"</span>,</div><div class="line">       <span class="string">"memory"</span>: <span class="string">"2820Ki"</span></div><div class="line">      &#125;</div><div class="line">     &#125;</div><div class="line">    ]</div><div class="line">   &#125;</div><div class="line">  ]</div><div class="line"> &#125;</div><div class="line"> [root@node1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>于是到kube-master上访问测试，发现HPA无法访问到heapster。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># curl 'http://172.30.9.4:8082/apis/metrics/v1alpha1/namespaces/default/pods?labelSelector=app%3Dnginx-hpa'</span></div><div class="line">curl: (7) Failed connect to 172.30.9.4:8082; Connection timed out</div><div class="line">[root@master ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>接下来我们来测试下网络情况，发现kube-master无法Ping通heapster的POD地址。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># ping 172.30.9.4</span></div><div class="line">PING 172.30.9.4 (172.30.9.4) 56(84) bytes of data.</div><div class="line">^C</div><div class="line">--- 172.30.9.4 ping statistics ---</div><div class="line">2 packets transmitted, 0 received, 100% packet loss, time 1002ms</div><div class="line"></div><div class="line">[root@master ~]<span class="comment"># telnet 172.30.9.4 8082</span></div><div class="line">Trying 172.30.9.4...</div><div class="line">telnet: connect to address 172.30.9.4: Connection timed out</div><div class="line">[root@master ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>测试发现是网络不通导致的。解决办法是在kube-master上安装flannel网络。<br>如果flannel网络的IP地址丢失，重启flannel网卡<code>systemctl restart flanneld</code>即可解决。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># ip a</span></div><div class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1</div><div class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</div><div class="line">    inet 127.0.0.1/8 scope host lo</div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line">    inet6 ::1/128 scope host </div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</div><div class="line">    link/ether 00:0c:29:48:f6:1d brd ff:ff:ff:ff:ff:ff</div><div class="line">    inet 192.168.1.201/24 brd 192.168.1.255 scope global ens33</div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line">    inet6 fe80::22d8:9dda:6705:ec09/64 scope link </div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line">3: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN </div><div class="line">    link/ether 6e:05:c0:9c:34:3f brd ff:ff:ff:ff:ff:ff</div><div class="line">    inet 172.30.13.0/32 scope global flannel.1</div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line">    inet6 fe80::6c05:c0ff:fe9c:343f/64 scope link </div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>再测试下kube-master到heapster POD的网络情况：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># ping 172.30.9.4 -c 4</span></div><div class="line">PING 172.30.9.4 (172.30.9.4) 56(84) bytes of data.</div><div class="line">64 bytes from 172.30.9.4: icmp_seq=1 ttl=63 time=2.15 ms</div><div class="line">64 bytes from 172.30.9.4: icmp_seq=2 ttl=63 time=1.27 ms</div><div class="line">64 bytes from 172.30.9.4: icmp_seq=3 ttl=63 time=1.30 ms</div><div class="line">64 bytes from 172.30.9.4: icmp_seq=4 ttl=63 time=1.66 ms</div><div class="line"></div><div class="line">--- 172.30.9.4 ping statistics ---</div><div class="line">4 packets transmitted, 4 received, 0% packet loss, time 3003ms</div><div class="line">rtt min/avg/max/mdev = 1.277/1.599/2.150/0.354 ms</div><div class="line">[root@master ~]<span class="comment"># telnet 172.30.9.4 8082</span></div><div class="line">Trying 172.30.9.4...</div><div class="line">telnet: connect to address 172.30.9.4: Connection refused</div><div class="line">[root@master ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>重新导入nginx-hpa-cpu.yml文件，然后等待几分钟…<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># kubectl delete -f nginx-hpa-cpu.yml </span></div><div class="line">horizontalpodautoscaler <span class="string">"nginx-hpa"</span> deleted</div><div class="line">[root@localhost ~]<span class="comment"># </span></div><div class="line">[root@localhost ~]<span class="comment"># kubectl apply -f nginx-hpa-cpu.yml </span></div><div class="line">horizontalpodautoscaler <span class="string">"nginx-hpa"</span> created</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>OK，HPA连接heapster成功。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># kubectl get hpa</span></div><div class="line">NAME        REFERENCE          TARGETS    MINPODS   MAXPODS   REPLICAS   AGE</div><div class="line">nginx-hpa   Deployment/nginx   0% / 70%   1         5         1          39s</div><div class="line">[root@localhost ~]<span class="comment"># </span></div><div class="line">[root@localhost ~]<span class="comment"># kubectl describe hpa</span></div><div class="line">Name:                                                  nginx-hpa</div><div class="line">Namespace:                                             default</div><div class="line">Labels:                                                &lt;none&gt;</div><div class="line">Annotations:                                           kubectl.kubernetes.io/last-applied-configuration=&#123;<span class="string">"apiVersion"</span>:<span class="string">"au</span></div><div class="line">toscaling/v1",<span class="string">"kind"</span>:<span class="string">"HorizontalPodAutoscaler"</span>,<span class="string">"metadata"</span>:&#123;<span class="string">"annotations"</span>:&#123;&#125;,<span class="string">"name"</span>:<span class="string">"nginx-hpa"</span>,<span class="string">"namespace"</span>:<span class="string">"default"</span>&#125;,<span class="string">"spec"</span>:&#123;<span class="string">"maxRepl...</span></div><div class="line">CreationTimestamp:                                     Sun, 27 Jan 2019 01:04:25 +0800</div><div class="line">Reference:                                             Deployment/nginx</div><div class="line">Metrics:                                               ( current / target )</div><div class="line">  resource cpu on pods  (as a percentage of request):  0% (0) / 70%</div><div class="line">Min replicas:                                          1</div><div class="line">Max replicas:                                          5</div><div class="line">Conditions:</div><div class="line">  Type            Status  Reason            Message</div><div class="line">  ----            ------  ------            -------</div><div class="line">  AbleToScale     True    ReadyForNewScale  the last scale time was sufficiently old as to warrant a new scale</div><div class="line">  ScalingActive   True    ValidMetricFound  the HPA was able to succesfully calculate a replica count from cpu resource utilization (percentage of request)</div><div class="line">  ScalingLimited  True    TooFewReplicas    the desired replica count is increasing faster than the maximum scale rate</div><div class="line">Events:           &lt;none&gt;</div><div class="line">[root@localhost ~]#</div></pre></td></tr></table></figure></p>
<h4 id="HPA测试"><a href="#HPA测试" class="headerlink" title="HPA测试"></a>HPA测试</h4><p>截至目前，HPA支持的API版本有三个。分别是<code>autoscaling/v1</code>，<code>autoscaling/v2beta1</code>，<code>autoscaling/v2beta2</code>。其中<code>autoscaling/v1</code>只支持CPU一种伸缩指标；在<code>autoscaling/v2beta1</code>中增加支持custom metrics；在<code>autoscaling/v2beta2</code>中增加支持external metrics。<br>详细说明参考：  </p>
<ul>
<li><a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/" target="_blank" rel="external">官方接口文档</a>  </li>
<li><a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/#appendix-horizontal-pod-autoscaler-status-conditions" target="_blank" rel="external">autoscaling/v2beta2示例</a>  </li>
<li><a href="https://yq.aliyun.com/articles/672398?spm=a2c4e.11153940.blogcont673889.15.4a0226a9rLnJ2p" target="_blank" rel="external">Kubernetes 弹性伸缩全场景解析</a>  </li>
</ul>
<p>官方说明，在k8s 1.11版本，HPA将不再从heapster上获取指标。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">The HorizontalPodAutoscaler normally fetches metrics from a series of aggregated APIs (metrics.k8s.io, custom.metrics.k8s.io, and external.metrics.k8s.io). The metrics.k8s.io API is usually provided by metrics-server, <span class="built_in">which</span> needs to be launched separately. See metrics-server <span class="keyword">for</span> instructions. The HorizontalPodAutoscaler can also fetch metrics directly from Heapster.</div><div class="line"></div><div class="line">Note:</div><div class="line">FEATURE STATE: Kubernetes 1.11 deprecated</div><div class="line">Fetching metrics from Heapster is deprecated as of Kubernetes 1.11.</div></pre></td></tr></table></figure></p>
<h5 id="autoscaling-v1"><a href="#autoscaling-v1" class="headerlink" title="autoscaling/v1"></a>autoscaling/v1</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># cat nginx-hpa-cpu.yml </span></div><div class="line">apiVersion: autoscaling/v1</div><div class="line">kind: HorizontalPodAutoscaler</div><div class="line">metadata:</div><div class="line">  name: nginx-hpa</div><div class="line">spec:</div><div class="line">  scaleTargetRef:</div><div class="line">    apiVersion: extensions/v1beta1</div><div class="line">    kind: Deployment</div><div class="line">    name: nginx</div><div class="line">  minReplicas: 1</div><div class="line">  maxReplicas: 5</div><div class="line">  targetCPUUtilizationPercentage: 70</div><div class="line">[root@master ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>这里只针对CPU的HPA 压力测试。<br>压测命令<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># cat test.sh </span></div><div class="line"><span class="keyword">while</span> <span class="literal">true</span></div><div class="line"><span class="keyword">do</span></div><div class="line">	wget -q -O- http://192.168.1.204:30080</div><div class="line"><span class="keyword">done</span></div><div class="line">[root@node1 ~]<span class="comment"># sh test.sh</span></div></pre></td></tr></table></figure></p>
<p>观察HPA当前负载和POD的情况<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># kubectl get hpa</span></div><div class="line">NAME        REFERENCE          TARGETS    MINPODS   MAXPODS   REPLICAS   AGE</div><div class="line">nginx-hpa   Deployment/nginx   0% / 70%   1         5         1          14h</div><div class="line">[root@master ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># kubectl get hpa</span></div><div class="line">NAME        REFERENCE          TARGETS     MINPODS   MAXPODS   REPLICAS   AGE</div><div class="line">nginx-hpa   Deployment/nginx   14% / 70%   1         5         1          14h</div><div class="line">[root@master ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>当负载飙升时，HPA会按照定义的规则开始创建新的POD副本(定义POD的CPU阈值为70%)。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># kubectl get hpa</span></div><div class="line">NAME        REFERENCE          TARGETS      MINPODS   MAXPODS   REPLICAS   AGE</div><div class="line">nginx-hpa   Deployment/nginx   180% / 70%   1         5         3          14h</div><div class="line">[root@master ~]<span class="comment">#</span></div><div class="line">[root@master ~]<span class="comment"># kubectl get pod -o wide</span></div><div class="line">NAME                     READY     STATUS    RESTARTS   AGE       IP            NODE</div><div class="line">nginx-5dcf548595-bk9cr   1/1       Running   1          15h       172.30.94.2   192.168.1.205</div><div class="line">nginx-5dcf548595-pdndb   1/1       Running   0          1m        172.30.94.4   192.168.1.205</div><div class="line">nginx-5dcf548595-z9d6h   1/1       Running   0          1m        172.30.94.3   192.168.1.205</div><div class="line">[root@master ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>继续压测，会发现POD副本数量继续增加（REPLICAS从3到5）。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># kubectl get hpa</span></div><div class="line">NAME        REFERENCE          TARGETS      MINPODS   MAXPODS   REPLICAS   AGE</div><div class="line">nginx-hpa   Deployment/nginx   139% / 70%   1         5         5          14h</div><div class="line">[root@master ~]<span class="comment">#</span></div><div class="line">[root@master ~]<span class="comment"># kubectl get pod -o wide</span></div><div class="line">NAME                     READY     STATUS              RESTARTS   AGE       IP            NODE</div><div class="line">nginx-5dcf548595-9gmqf   0/1       ContainerCreating   0          39s       &lt;none&gt;        192.168.1.204</div><div class="line">nginx-5dcf548595-bk9cr   1/1       Running             1          15h       172.30.94.2   192.168.1.205</div><div class="line">nginx-5dcf548595-pdndb   1/1       Running             0          10m       172.30.94.4   192.168.1.205</div><div class="line">nginx-5dcf548595-r7n4b   1/1       Running             0          39s       172.30.94.5   192.168.1.205</div><div class="line">nginx-5dcf548595-z9d6h   1/1       Running             0          10m       172.30.94.3   192.168.1.205</div><div class="line">[root@master ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>当REPLICAS达到定义的上限时，即使当前CPU的压力仍然很大，REPLICAS也不会再增加了。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># kubectl get hpa</span></div><div class="line">NAME        REFERENCE          TARGETS     MINPODS   MAXPODS   REPLICAS   AGE</div><div class="line">nginx-hpa   Deployment/nginx   112% / 70%   1         5         5          14h</div><div class="line">[root@master ~]<span class="comment">#</span></div><div class="line">[root@master ~]<span class="comment"># kubectl get pod -o wide</span></div><div class="line">NAME                     READY     STATUS    RESTARTS   AGE       IP            NODE</div><div class="line">nginx-5dcf548595-9gmqf   1/1       Running   0          2m        172.30.9.6    192.168.1.204</div><div class="line">nginx-5dcf548595-bk9cr   1/1       Running   1          15h       172.30.94.2   192.168.1.205</div><div class="line">nginx-5dcf548595-pdndb   1/1       Running   0          12m       172.30.94.4   192.168.1.205</div><div class="line">nginx-5dcf548595-r7n4b   1/1       Running   0          2m        172.30.94.5   192.168.1.205</div><div class="line">nginx-5dcf548595-z9d6h   1/1       Running   0          12m       172.30.94.3   192.168.1.205</div><div class="line">[root@master ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>停止压测，当CPU负载降低时，HPA会自动减少POD的数量。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># kubectl get hpa</span></div><div class="line">NAME        REFERENCE          TARGETS     MINPODS   MAXPODS   REPLICAS   AGE</div><div class="line">nginx-hpa   Deployment/nginx   40% / 70%   1         5         3          14h</div><div class="line">[root@master ~]<span class="comment">#</span></div><div class="line">[root@master ~]<span class="comment"># kubectl get pod -o wide</span></div><div class="line">NAME                     READY     STATUS    RESTARTS   AGE       IP            NODE</div><div class="line">nginx-5dcf548595-pdndb   1/1       Running   0          16m       172.30.94.4   192.168.1.205</div><div class="line">nginx-5dcf548595-r7n4b   1/1       Running   0          6m        172.30.94.5   192.168.1.205</div><div class="line">nginx-5dcf548595-z9d6h   1/1       Running   0          16m       172.30.94.3   192.168.1.205</div><div class="line">[root@master ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>慢慢的，HPA会减少POD的数量，直到降低到最小POD数(MINPODS)。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># kubectl get hpa</span></div><div class="line">NAME        REFERENCE          TARGETS      MINPODS   MAXPODS   REPLICAS   AGE</div><div class="line">nginx-hpa   Deployment/nginx   0% / 70%   1         5         1          15h</div><div class="line">[root@master ~]<span class="comment">#</span></div><div class="line">[root@master ~]<span class="comment"># kubectl get pod -o wide</span></div><div class="line">NAME                     READY     STATUS    RESTARTS   AGE       IP            NODE</div><div class="line">nginx-5dcf548595-z9d6h   1/1       Running   0          1h        172.30.94.3   192.168.1.205</div><div class="line">[root@master ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>通过kube-dashboard观察这个过程的变化。<br><img src="https://note.youdao.com/yws/api/personal/file/F629DAA40F784576824CBD41240103B0?method=download&amp;shareKey=aef82ab7b8bf8633212a7f4679686de2" alt="kube-dashboard"><br><img src="https://note.youdao.com/yws/api/personal/file/3BE7F7C0A7DD4E8C841D3F3E9A4BCB08?method=download&amp;shareKey=09d40ca0da02667398ba75864d50e837" alt="kube-dashboard"><br><img src="https://note.youdao.com/yws/api/personal/file/FE3468620FB64868BF110C6AE9FAE2E5?method=download&amp;shareKey=97d1289d99000d823e02495f6cf1057f" alt="kube-dashboard"><br>通过HPA的日志信息查看到它伸缩的过程。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># kubectl describe hpa</span></div><div class="line">Name:                                                  nginx-hpa</div><div class="line">Namespace:                                             default</div><div class="line">Labels:                                                &lt;none&gt;</div><div class="line">Annotations:                                           kubectl.kubernetes.io/last-applied-configuration=&#123;<span class="string">"apiVersion"</span>:<span class="string">"au</span></div><div class="line">toscaling/v1",<span class="string">"kind"</span>:<span class="string">"HorizontalPodAutoscaler"</span>,<span class="string">"metadata"</span>:&#123;<span class="string">"annotations"</span>:&#123;&#125;,<span class="string">"name"</span>:<span class="string">"nginx-hpa"</span>,<span class="string">"namespace"</span>:<span class="string">"default"</span>&#125;,<span class="string">"spec"</span>:&#123;<span class="string">"maxRepl...CreationTimestamp:                                     Sun, 27 Jan 2019 01:04:25 +0800</span></div><div class="line">Reference:                                             Deployment/nginx</div><div class="line">Metrics:                                               ( current / target )</div><div class="line">  resource cpu on pods  (as a percentage of request):  0% (0) / 70%</div><div class="line">Min replicas:                                          1</div><div class="line">Max replicas:                                          5</div><div class="line">Conditions:</div><div class="line">  Type            Status  Reason            Message</div><div class="line">  ----            ------  ------            -------</div><div class="line">  AbleToScale     False   BackoffDownscale  the time since the previous scale is still within the downscale forbidden window</div><div class="line">  ScalingActive   True    ValidMetricFound  the HPA was able to succesfully calculate a replica count from cpu resource utilization (percentage of request)  ScalingLimited  True    TooFewReplicas    the desired replica count is increasing faster than the maximum scale rate</div><div class="line">Events:</div><div class="line">  Type    Reason             Age               From                       Message</div><div class="line">  ----    ------             ----              ----                       -------</div><div class="line">  Normal  SuccessfulRescale  41m (x2 over 1h)  horizontal-pod-autoscaler  New size: 5; reason: cpu resource utilization (percentage of request) above target</div><div class="line">  Normal  SuccessfulRescale  29m (x2 over 1h)  horizontal-pod-autoscaler  New size: 3; reason: All metrics below target</div><div class="line">  Normal  SuccessfulRescale  17m               horizontal-pod-autoscaler  New size: 2; reason: All metrics below target</div><div class="line">  Normal  SuccessfulRescale  8m (x2 over 1h)   horizontal-pod-autoscaler  New size: 3; reason: cpu resource utilization (percentage of request) above target</div><div class="line">  Normal  SuccessfulRescale  3m (x2 over 12m)  horizontal-pod-autoscaler  New size: 1; reason: All metrics below target</div><div class="line">[root@master ~]#</div></pre></td></tr></table></figure></p>
<h5 id="autoscaling-v2beta1"><a href="#autoscaling-v2beta1" class="headerlink" title="autoscaling/v2beta1"></a>autoscaling/v2beta1</h5><p><code>autoscaling/v2beta1</code>中增加支持custom metrics。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># cat nginx-hpa-v2beta1.yml </span></div><div class="line">apiVersion: autoscaling/v2beta1</div><div class="line">kind: HorizontalPodAutoscaler</div><div class="line">metadata:</div><div class="line">  name: nginx-hpa</div><div class="line">spec:</div><div class="line">  scaleTargetRef:</div><div class="line">    apiVersion: extensions/v1beta1</div><div class="line">    kind: Deployment</div><div class="line">    name: nginx</div><div class="line">  minReplicas: 1</div><div class="line">  maxReplicas: 5</div><div class="line">  metrics:</div><div class="line">    - <span class="built_in">type</span>: Resource</div><div class="line">      resource:</div><div class="line">        name: memory</div><div class="line">        targetAverageUtilization: 70</div><div class="line">    - <span class="built_in">type</span>: Resource</div><div class="line">      resource:</div><div class="line">        name: cpu</div><div class="line">        targetAverageUtilization: 70</div><div class="line">[root@master ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># kubectl apply -f nginx-hpa-v2beta1.yml</span></div></pre></td></tr></table></figure>
<p>等待几分钟后…<br>观察发现前面10%是内存的使用百分比，后面0%是CPU的使用百分比。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># kubectl get hpa nginx-hpa</span></div><div class="line">NAME        REFERENCE          TARGETS               MINPODS   MAXPODS   REPLICAS   AGE</div><div class="line">nginx-hpa   Deployment/nginx   10% / 70%, 0% / 70%   1         5         1          51s</div><div class="line">[root@master ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># kubectl describe hpa nginx-hpa</span></div><div class="line">Name:                                                     nginx-hpa</div><div class="line">Namespace:                                                default</div><div class="line">Labels:                                                   &lt;none&gt;</div><div class="line">Annotations:                                              kubectl.kubernetes.io/last-applied-configuration=&#123;<span class="string">"apiVersion"</span>:</div><div class="line"><span class="string">"autoscaling/v2beta1"</span>,<span class="string">"kind"</span>:<span class="string">"HorizontalPodAutoscaler"</span>,<span class="string">"metadata"</span>:&#123;<span class="string">"annotations"</span>:&#123;&#125;,<span class="string">"name"</span>:<span class="string">"nginx-hpa"</span>,<span class="string">"namespace"</span>:<span class="string">"default"</span>&#125;,<span class="string">"spec"</span>:&#123;<span class="string">"ma...CreationTimestamp:                                        Mon, 28 Jan 2019 22:22:01 +0800</span></div><div class="line">Reference:                                                Deployment/nginx</div><div class="line">Metrics:                                                  ( current / target )</div><div class="line">  resource memory on pods  (as a percentage of request):  10% (2670592) / 70%</div><div class="line">  resource cpu on pods  (as a percentage of request):     0% (0) / 70%</div><div class="line">Min replicas:                                             1</div><div class="line">Max replicas:                                             5</div><div class="line">Conditions:</div><div class="line">  Type            Status  Reason              Message</div><div class="line">  ----            ------  ------              -------</div><div class="line">  AbleToScale     True    ReadyForNewScale    the last scale time was sufficiently old as to warrant a new scale</div><div class="line">  ScalingActive   True    ValidMetricFound    the HPA was able to succesfully calculate a replica count from memory resou</div><div class="line">rce utilization (percentage of request)  ScalingLimited  False   DesiredWithinRange  the desired count is within the acceptable range</div><div class="line">Events:           &lt;none&gt;</div><div class="line"></div><div class="line">[root@master ~]#</div></pre></td></tr></table></figure>
<h5 id="autoscaling-v2beta2"><a href="#autoscaling-v2beta2" class="headerlink" title="autoscaling/v2beta2"></a>autoscaling/v2beta2</h5><p><code>autoscaling/v2beta2</code>测试发现目前k8s 1.9.2暂不支持这个API版本。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># kubectl get hpa.v2beta2.autoscaling -o yaml</span></div><div class="line">the server doesn<span class="string">'t have a resource type "hpa" in group "v2beta2.autoscaling"</span></div><div class="line">[root@master ~]#</div></pre></td></tr></table></figure></p>
<p>参考：<br><a href="http://blog.51cto.com/ylw6006/2113848" target="_blank" rel="external">http://blog.51cto.com/ylw6006/2113848</a><br><a href="https://blog.frognew.com/2017/01/kubernetes-pod-scale.html" target="_blank" rel="external">https://blog.frognew.com/2017/01/kubernetes-pod-scale.html</a><br><a href="https://k8smeetup.github.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/" target="_blank" rel="external">https://k8smeetup.github.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/</a><br><a href="https://blog.csdn.net/qq_17016649/article/details/79297796" target="_blank" rel="external">https://blog.csdn.net/qq_17016649/article/details/79297796</a><br><a href="https://github.com/kubernetes/kubernetes/issues/57673" target="_blank" rel="external">https://github.com/kubernetes/kubernetes/issues/57673</a>  </p>
<p>附件：<br><a href="https://note.youdao.com/yws/api/personal/file/9D8378F87D324B679D38A854BE9E812A?method=download&amp;shareKey=67aef289e4b6d60a0a47d38c1a6d2554" target="_blank" rel="external">HPA测试配置文件.zip</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2019/01/28/k8s集群水平扩展-HPA/">http://www.yfshare.vip/2019/01/28/k8s集群水平扩展-HPA/</a></p>
</div><script type="text/javascript" src="/js/share.js?v=2.0.0" async></script><a data-url="http://www.yfshare.vip/2019/01/28/k8s集群水平扩展-HPA/" data-id="cjth80djp004vn8m52t3uztpc" class="article-share-link">分享到</a><div class="tags"><a href="/tags/k8s/">k8s</a><a href="/tags/docker/">docker</a><a href="/tags/HPA/">HPA</a><a href="/tags/cpu/">cpu</a><a href="/tags/memory/">memory</a></div><div class="post-nav"><a href="/2019/01/20/Grafana日志聚合工具Loki/" class="next">Grafana日志聚合工具Loki</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论 「请确保 disqus.com 可以正常加载」</button></div><script>var disqus_shortname = 'yfshare';
var disqus_identifier = '2019/01/28/k8s集群水平扩展-HPA/';
var disqus_title = 'k8s集群水平扩展(HPA)';
var disqus_url = 'http://www.yfshare.vip/2019/01/28/k8s集群水平扩展-HPA/';
$('.btn_click_load').click(function() {
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  $('.btn_click_load').css('display','none');
});
$.ajax({
  url: 'https://disqus.com/favicon.ico',
  timeout: 3000,
  type: 'GET',
  success: (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    $('.btn_click_load').css('display','none');
  })(),
  error: function() {
    $('.btn_click_load').css('display','block');
  }
});</script><script id="dsq-count-scr" src="//yfshare.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Ansible/">Ansible</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Atlassian/">Atlassian</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Database/">Database</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ELK/">ELK</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Jenkins/">Jenkins</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/K8S/">K8S</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Monitor/">Monitor</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Security/">Security</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Virtualization/">Virtualization</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/WEB/">WEB</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Windows/">Windows</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/版本控制系统/">版本控制系统</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维知识体系/">运维知识体系</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/01/28/k8s集群水平扩展-HPA/">k8s集群水平扩展(HPA)</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/20/Grafana日志聚合工具Loki/">Grafana日志聚合工具Loki</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/06/Python十行代码爬抖音/">Python十行代码爬抖音</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/04/Python升级/">Python升级</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/29/node-exporter自定义key/">node_exporter自定义key</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/04/Python运算符/">Python运算符</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/27/运维知识体系之操作系统层/">运维知识体系之操作系统层</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/04/部署jenkins项目/">部署jenkins项目</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/30/部署Zabbix-3-4/">部署Zabbix 3.4</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/21/Ansible部署Jenkins环境/">Ansible部署Jenkins环境</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://yfshare.blog.51cto.com/" title="酱油瓶 博客" target="_blank">酱油瓶 博客</a><ul></ul><a href="http://zerosre.com/" title="龙哥zero 博客" target="_blank">龙哥zero 博客</a><ul></ul><a href="http://renzhiyuan.blog.51cto.com/" title="任志远Ray 博客" target="_blank">任志远Ray 博客</a><ul></ul><a href="http://rongrong.njdgwl.com" title="浩子的 博客" target="_blank">浩子的 博客</a><ul></ul><a href="http://www.cnblogs.com/aresxin/" title="欣哥aresxin 博客" target="_blank">欣哥aresxin 博客</a><ul></ul><a href="http://securityit.cn/" title="万马奔腾" target="_blank">万马奔腾</a></div><div class="widget"><div class="widget-title"><i class="fa fa-external-resources"> 资源站</i></div><ul></ul><a href="http://mirror.symnds.com/distributions/CentOS-vault/" title="Centos镜像站" target="_blank">Centos镜像站</a><ul></ul><a href="http://www.rpmfind.net/" title="rpmfind mirror" target="_blank">rpmfind mirror</a><ul></ul><a href="http://rpm.org/" title="rpm.org" target="_blank">rpm.org</a><ul></ul><a href="http://rpm.pbone.net/" title="rpm search" target="_blank">rpm search</a><ul></ul><a href="http://download.chinaunix.net/" title="chinaunix download" target="_blank">chinaunix download</a><ul></ul><a href="http://www.anquanquan.info/" title="安全圈info" target="_blank">安全圈info</a><ul></ul><a href="http://source.tosimp.net/" title="Tosimp 资源站" target="_blank">Tosimp 资源站</a></div><div class="widget"><div class="widget-title"><i class="fa fa-external-music"> 音乐</i></div></div><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=371362&auto=1&height=66"></iframe><div class="widget"><div class="widget-title"><i class="fa fa-external-game"> 游戏</i></div><ul></ul><a href="/2048" title="2048小游戏" target="_blank">2048小游戏</a><ul></ul><a href="/tantanqiu" title="变色弹球跳台阶小游戏" target="_blank">变色弹球跳台阶小游戏</a></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//yfshare.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">Jack Wang Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=2.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=2.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=2.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?3890bdc1bfaccae9364479b65f36fbd2";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=2.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=2.0.0"></script></div></body></html>
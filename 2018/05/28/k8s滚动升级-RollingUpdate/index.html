<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Blog"><title>k8s滚动升级(RollingUpdate) | Jack Wang Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">k8s滚动升级(RollingUpdate)</h1><a id="logo" href="/.">Jack Wang Blog</a><p class="description">Goals determine what you are going to be</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa icon-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">k8s滚动升级(RollingUpdate)</h1><div class="post-meta">May 28, 2018<span> | </span><span class="category"><a href="/categories/K8S/">K8S</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2018/05/28/k8s滚动升级-RollingUpdate/" href="/2018/05/28/k8s滚动升级-RollingUpdate/#disqus_thread" class="disqus-comment-count"></a><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#调度流程"><span class="toc-number">1.</span> <span class="toc-text">调度流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#环境说明"><span class="toc-number">2.</span> <span class="toc-text">环境说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RollingUpdate"><span class="toc-number">3.</span> <span class="toc-text">RollingUpdate</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#版本回滚"><span class="toc-number">4.</span> <span class="toc-text">版本回滚</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q-amp-A"><span class="toc-number">5.</span> <span class="toc-text">Q & A</span></a></li></ol></div></div><div class="post-content"><script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>kubernets scheduler主要负责的工作是：接受API Server创建的新Pod，并为其安排一个主机，将信息写入etcd中。<br><a id="more"></a></p>
<h4 id="调度流程"><a href="#调度流程" class="headerlink" title="调度流程"></a>调度流程</h4><p>kubernetes调度器通过API Server查找还未分配主机的Pod，并尝试为这些Pod分配主机。  </p>
<ul>
<li>客户端提交创建请求，可以通过API Server的Restful API，也可以使用kubectl命令行工具。支持的数据类型包括JSON和YAML  </li>
<li>API Server处理用户请求，存储Pod数据到etcd  </li>
<li>调度器通过API Server查看未绑定的Pod。尝试为Pod分配主机  </li>
<li>过滤主机：调度器用一组规则过滤掉不符合要求的主机。比如Pod指定了所需要的资源量，那么可用资源比Pod需要的资源量少的主机会被过滤掉  </li>
<li>主机打分：对第一步筛选出的符合要求的主机进行打分，在主机打分阶段，调度器会考虑一些整体优化策略，比如把容一个Replication Controller的副本分布到不同的主机上，使用最低负载的主机等  </li>
<li>选择主机：选择打分最高的主机，进行binding操作，结果存储到etcd中  </li>
<li>所选主机对于的kubelet根据调度结果执行Pod创建操作  </li>
</ul>
<p>kubernetes中实现的过滤规则主要包括以下几种(在 <code>kubernetes/plugin/pkg/scheduler/algorithm/predicates</code> 中实现)：<br>参考：<a href="https://blog.csdn.net/horsefoot/article/details/51263364" target="_blank" rel="external">https://blog.csdn.net/horsefoot/article/details/51263364</a>  </p>
<ul>
<li><code>NoDiskConflict</code>：检查在此主机上是否存在卷冲突。如果这个主机已经挂载了卷，其它同样使用这个卷的Pod不能调度到这个主机上。  </li>
<li><code>NoVolumeZoneConflict</code>：检查给定的zone限制前提下，检查如果在此主机上部署Pod是否存在卷冲突。  </li>
<li><code>PodFitsResources</code>：检查主机的资源是否满足Pod的需求。根据实际已经分配的资源量做调度，而不是使用已实际使用的资源量做调度。  </li>
<li><code>PodFitsHostPorts</code>：检查Pod内每一个容器所需的HostPort是否已被其它容器占用。如果有所需的HostPort不满足需求，那么Pod不能调度到这个主机上。  </li>
<li><code>HostName</code>：检查主机名称是不是Pod指定的HostName。  </li>
<li><code>MatchNodeSelector</code>：检查主机的标签是否满足Pod的<em>nodeSelector</em>属性需求。  </li>
<li><code>MaxEBSVolumeCount</code>：确保已挂载的EBS存储卷不超过设置的最大值，默认值是39。它会检查直接使用的存储卷，和间接使用这种类型存储的PVC。计算不同卷的总目，如果新的Pod部署上去后卷的数目会超过设置的最大值，那么Pod不能调度到这个主机上。  </li>
<li><code>MaxGCEPDVolumeCount</code>：确保已挂载的GCE存储卷不超过设置的最大值，默认值是16。规则同上。  </li>
</ul>
<h4 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h4><p>环境：<br>　　　k8s v1.9.2<br>　　　centos v7.4<br>　　　tomcat v8.0/9.0<br>　　　docker v18.05.0-ce  </p>
<table>
<thead>
<tr>
<th>节点名称</th>
<th>IP</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>KUBE-MASTER+ETCD1</td>
<td>192.168.1.201</td>
<td>部署nginx反向代理</td>
</tr>
<tr>
<td>KUBE-ETCD2</td>
<td>192.168.1.202</td>
<td>-</td>
</tr>
<tr>
<td>KUBE-ETCD3</td>
<td>192.168.1.203</td>
<td>-</td>
</tr>
<tr>
<td>KUBE-NODE1</td>
<td>192.168.1.204</td>
<td>-</td>
</tr>
<tr>
<td>KUBE-NODE2</td>
<td>192.168.1.205</td>
<td>-</td>
</tr>
<tr>
<td>KUBE-NODE3</td>
<td>192.168.1.206</td>
<td>-</td>
</tr>
</tbody>
</table>
<h4 id="RollingUpdate"><a href="#RollingUpdate" class="headerlink" title="RollingUpdate"></a>RollingUpdate</h4><p><img src="https://note.youdao.com/yws/api/personal/file/E01D734A3356410D9E20FA9D247A8083?method=download&amp;shareKey=ea26f2c05d91a3bf6ddb99a9dc3cc5f0" alt="Kubernetes rolling-update升级流程图"><br>查看tomcat编排文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># cat tomcat.yml </span></div><div class="line">apiVersion: apps/v1beta2</div><div class="line">kind: Deployment</div><div class="line">metadata:</div><div class="line">  name: tomcat-deployment</div><div class="line">  namespace: web</div><div class="line">spec:</div><div class="line">  replicas: 2</div><div class="line">  selector:</div><div class="line">    matchLabels: </div><div class="line">      app: tomcat</div><div class="line">  template:</div><div class="line">    metadata:</div><div class="line">      labels: </div><div class="line">        app: tomcat</div><div class="line">    spec:</div><div class="line">      nodeSelector:</div><div class="line">        nodelabel: tomcat</div><div class="line">      containers:</div><div class="line">      - name: tomcat</div><div class="line">        image: tomcat:8.0</div><div class="line">        imagePullPolicy: Always</div><div class="line">        ports:</div><div class="line">          - containerPort: 8080</div><div class="line">        volumeMounts:</div><div class="line">          - name: time</div><div class="line">            mountPath: <span class="string">"/etc/localtime"</span></div><div class="line">            <span class="built_in">read</span>Only: <span class="literal">true</span></div><div class="line">      volumes:</div><div class="line">        - name: time</div><div class="line">          hostPath:</div><div class="line">            path: <span class="string">"/etc/localtime"</span></div><div class="line">---</div><div class="line">apiVersion: v1</div><div class="line">kind: Service</div><div class="line">metadata:</div><div class="line">  name: tomcat-service</div><div class="line">  namespace: web</div><div class="line">  labels:</div><div class="line">    app: tomcat-service</div><div class="line">spec:</div><div class="line">  <span class="built_in">type</span>: NodePort</div><div class="line">  selector:</div><div class="line">    app: tomcat</div><div class="line">  ports:</div><div class="line">  - port: 8080</div><div class="line">    nodePort: 38080</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>查看k8s节点信息：<br>这里应用<code>replicas: 2</code>且固定了端口，所以Label的Node数必须比应用个数大一个，否则会失败<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># kubectl get nodes</span></div><div class="line">NAME            STATUS    ROLES     AGE       VERSION</div><div class="line">192.168.1.204   Ready     &lt;none&gt;    1d        v1.9.2</div><div class="line">192.168.1.205   Ready     &lt;none&gt;    1d        v1.9.2</div><div class="line">192.168.1.206   Ready     &lt;none&gt;    5h        v1.9.2</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>应用tomcat编排文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># kubectl label node 192.168.1.204 192.168.1.205 192.168.1.206 "nodelabel=tomcat"</span></div><div class="line">[root@localhost ~]<span class="comment"># kubectl create namespace web</span></div><div class="line">[root@localhost ~]<span class="comment"># kubectl apply -f tomcat.yml</span></div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment"># kubectl get pod  -n web -o wide</span></div><div class="line">NAME                                 READY     STATUS    RESTARTS   AGE       IP            NODE</div><div class="line">tomcat-deployment-5768d76c66-jwlhp   1/1       Running   0          46s       172.30.5.2    192.168.1.205</div><div class="line">tomcat-deployment-5768d76c66-sxcj6   1/1       Running   0          46s       172.30.79.2   192.168.1.204</div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line">[root@localhost ~]<span class="comment"># kubectl get svc  -n web -o wide</span></div><div class="line">NAME             TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE       SELECTOR</div><div class="line">tomcat-service   NodePort   172.16.30.72   &lt;none&gt;        8080:38080/TCP   21s       app=tomcat</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>查看应用部署状态：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># kubectl rollout status deployment tomcat-deployment --namespace=web</span></div><div class="line">deployment <span class="string">"tomcat-deployment"</span> successfully rolled out</div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#升级前tomcat为8.0版本</span></div><div class="line">[root@localhost ~]<span class="comment"># kubectl describe pod tomcat-deployment-5768d76c66-jwlhp -n web | grep -i 'image:'</span></div><div class="line">    Image:          tomcat:8.0</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>升级应用：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># kubectl set image deployment tomcat-deployment tomcat=tomcat:9.0 --namespace=web --record</span></div><div class="line">deployment <span class="string">"tomcat-deployment"</span> image updated</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>查看升级结果：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># kubectl get pod -n web -o wide</span></div><div class="line">NAME                                 READY     STATUS    RESTARTS   AGE       IP            NODE</div><div class="line">tomcat-deployment-54b6<span class="built_in">fc</span>9b99-6jr2x   1/1       Running   0          1m        172.30.79.3   192.168.1.204</div><div class="line">tomcat-deployment-54b6<span class="built_in">fc</span>9b99-c6rs9   1/1       Running   0          1m        172.30.27.2   192.168.1.206</div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line">[root@localhost ~]<span class="comment"># kubectl rollout status deployment tomcat-deployment --namespace=web</span></div><div class="line">Waiting <span class="keyword">for</span> rollout to finish: 1 out of 2 new replicas have been updated...</div><div class="line">Waiting <span class="keyword">for</span> rollout to finish: 1 out of 2 new replicas have been updated...</div><div class="line">Waiting <span class="keyword">for</span> rollout to finish: 1 out of 2 new replicas have been updated...</div><div class="line">Waiting <span class="keyword">for</span> rollout to finish: 1 old replicas are pending termination...</div><div class="line">Waiting <span class="keyword">for</span> rollout to finish: 1 old replicas are pending termination...</div><div class="line">deployment <span class="string">"tomcat-deployment"</span> successfully rolled out</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># kubectl describe deployment tomcat-deployment --namespace=web</span></div><div class="line">Name:                   tomcat-deployment</div><div class="line">Namespace:              web</div><div class="line">CreationTimestamp:      Mon, 28 May 2018 17:28:27 +0800</div><div class="line">Labels:                 app=tomcat</div><div class="line">Annotations:            deployment.kubernetes.io/revision=2</div><div class="line">                        kubectl.kubernetes.io/last-applied-configuration=&#123;<span class="string">"apiVersion"</span>:<span class="string">"apps/v1beta2"</span>,<span class="string">"kind"</span>:<span class="string">"Deployment"</span>,<span class="string">"metadata"</span>:&#123;<span class="string">"annotations"</span>:&#123;&#125;,<span class="string">"name"</span>:<span class="string">"tomcat-deployment"</span>,<span class="string">"namespace"</span>:<span class="string">"web"</span>&#125;,<span class="string">"spec"</span>:&#123;<span class="string">"replicas"</span>:2,<span class="string">"selec...                        kubernetes.io/change-cause=kubectl set image deployment tomcat-deployment tomcat=tomcat:9.0 --namespace=web --record=trueSelector:               app=tomcat</span></div><div class="line">Replicas:               2 desired | 2 updated | 2 total | 2 available | 0 unavailable</div><div class="line">StrategyType:           RollingUpdate</div><div class="line">MinReadySeconds:        0</div><div class="line">RollingUpdateStrategy:  25% max unavailable, 25% max surge</div><div class="line">Pod Template:</div><div class="line">  Labels:  app=tomcat</div><div class="line">  Containers:</div><div class="line">   tomcat:</div><div class="line">    Image:        tomcat:9.0</div><div class="line">    Port:         8080/TCP</div><div class="line">    Environment:  &lt;none&gt;</div><div class="line">    Mounts:</div><div class="line">      /etc/localtime from time (ro)</div><div class="line">  Volumes:</div><div class="line">   time:</div><div class="line">    Type:          HostPath (bare host directory volume)</div><div class="line">    Path:          /etc/localtime</div><div class="line">    HostPathType:  </div><div class="line">Conditions:</div><div class="line">  Type           Status  Reason</div><div class="line">  ----           ------  ------</div><div class="line">  Available      True    MinimumReplicasAvailable</div><div class="line">  Progressing    True    NewReplicaSetAvailable</div><div class="line">OldReplicaSets:  &lt;none&gt;</div><div class="line">NewReplicaSet:   tomcat-deployment-54b6fc9b99 (2/2 replicas created)</div><div class="line">Events:</div><div class="line">  Type    Reason             Age   From                   Message</div><div class="line">  ----    ------             ----  ----                   -------</div><div class="line">  Normal  ScalingReplicaSet  4m    deployment-controller  Scaled up replica set tomcat-deployment-5768d76c66 to 2</div><div class="line">  Normal  ScalingReplicaSet  1m    deployment-controller  Scaled up replica set tomcat-deployment-54b6fc9b99 to 1</div><div class="line">  Normal  ScalingReplicaSet  1m    deployment-controller  Scaled down replica set tomcat-deployment-5768d76c66 to 1</div><div class="line">  Normal  ScalingReplicaSet  1m    deployment-controller  Scaled up replica set tomcat-deployment-54b6fc9b99 to 2</div><div class="line">  Normal  ScalingReplicaSet  52s   deployment-controller  Scaled down replica set tomcat-deployment-5768d76c66 to 0</div><div class="line">[root@localhost ~]#</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#tomcat成功升级到9.0版本</span></div><div class="line">[root@localhost ~]<span class="comment"># kubectl describe pod tomcat-deployment-54b6fc9b99-6jr2x -n web | grep -i 'image:'</span></div><div class="line">    Image:          tomcat:9.0</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>查看deployments版本：<br>由于之前在升级(set image)时添加<code>--record</code>参数，故在查看历史版本时会记录操作的指令<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># kubectl rollout history deployment tomcat-deployment --namespace=web</span></div><div class="line">deployments <span class="string">"tomcat-deployment"</span></div><div class="line">REVISION  CHANGE-CAUSE</div><div class="line">1         &lt;none&gt;</div><div class="line">2         kubectl <span class="built_in">set</span> image deployment tomcat-deployment tomcat=tomcat:9.0 --namespace=web --record=<span class="literal">true</span></div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<h4 id="版本回滚"><a href="#版本回滚" class="headerlink" title="版本回滚"></a>版本回滚</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># kubectl rollout undo deployment tomcat-deployment --namespace=web --to-revision=1</span></div><div class="line">deployment <span class="string">"tomcat-deployment"</span></div><div class="line">[root@localhost ~]<span class="comment"># kubectl rollout history deployment tomcat-deployment --namespace=web</span></div><div class="line">deployments <span class="string">"tomcat-deployment"</span></div><div class="line">REVISION  CHANGE-CAUSE</div><div class="line">2         kubectl <span class="built_in">set</span> image deployment tomcat-deployment tomcat=tomcat:9.0 --namespace=web --record=<span class="literal">true</span></div><div class="line">3         &lt;none&gt;</div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>查看回滚版本结果：<br>tomcat成功回退到8.0版本了<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># kubectl get pod -n web -o wide</span></div><div class="line">NAME                                 READY     STATUS    RESTARTS   AGE       IP            NODE</div><div class="line">tomcat-deployment-5768d76c66-bjwlc   1/1       Running   0          3m        172.30.5.2    192.168.1.205</div><div class="line">tomcat-deployment-5768d76c66-bz5rf   1/1       Running   0          2m        172.30.79.2   192.168.1.204</div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line">[root@localhost ~]<span class="comment"># kubectl describe pod tomcat-deployment-5768d76c66-bjwlc -n web | grep -i 'image:'</span></div><div class="line">    Image:          tomcat:8.0</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>查看版本回滚历史：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># kubectl describe deployment tomcat-deployment --namespace=web</span></div><div class="line">Name:                   tomcat-deployment</div><div class="line">Namespace:              web</div><div class="line">CreationTimestamp:      Mon, 28 May 2018 17:28:27 +0800</div><div class="line">Labels:                 app=tomcat</div><div class="line">Annotations:            deployment.kubernetes.io/revision=3</div><div class="line">                        kubectl.kubernetes.io/last-applied-configuration=&#123;<span class="string">"apiVersion"</span>:<span class="string">"apps/v1beta2"</span>,<span class="string">"kind"</span>:<span class="string">"Deployment"</span>,<span class="string">"metadata"</span>:&#123;<span class="string">"annotations"</span>:&#123;&#125;,<span class="string">"name"</span>:<span class="string">"tomcat-deployment"</span>,<span class="string">"namespace"</span>:<span class="string">"web"</span>&#125;,<span class="string">"spec"</span>:&#123;<span class="string">"replicas"</span>:2,<span class="string">"selec...Selector:               app=tomcat</span></div><div class="line">Replicas:               2 desired | 2 updated | 2 total | 2 available | 0 unavailable</div><div class="line">StrategyType:           RollingUpdate</div><div class="line">MinReadySeconds:        0</div><div class="line">RollingUpdateStrategy:  25% max unavailable, 25% max surge</div><div class="line">Pod Template:</div><div class="line">  Labels:  app=tomcat</div><div class="line">  Containers:</div><div class="line">   tomcat:</div><div class="line">    Image:        tomcat:8.0</div><div class="line">    Port:         8080/TCP</div><div class="line">    Environment:  &lt;none&gt;</div><div class="line">    Mounts:</div><div class="line">      /etc/localtime from time (ro)</div><div class="line">  Volumes:</div><div class="line">   time:</div><div class="line">    Type:          HostPath (bare host directory volume)</div><div class="line">    Path:          /etc/localtime</div><div class="line">    HostPathType:  </div><div class="line">Conditions:</div><div class="line">  Type           Status  Reason</div><div class="line">  ----           ------  ------</div><div class="line">  Available      True    MinimumReplicasAvailable</div><div class="line">  Progressing    True    NewReplicaSetAvailable</div><div class="line">OldReplicaSets:  &lt;none&gt;</div><div class="line">NewReplicaSet:   tomcat-deployment-5768d76c66 (2/2 replicas created)</div><div class="line">Events:</div><div class="line">  Type    Reason              Age               From                   Message</div><div class="line">  ----    ------              ----              ----                   -------</div><div class="line">  Normal  ScalingReplicaSet   55m               deployment-controller  Scaled up replica set tomcat-deployment-54b6fc9b99 to 1</div><div class="line">  Normal  ScalingReplicaSet   55m               deployment-controller  Scaled down replica set tomcat-deployment-5768d76c66 to 1</div><div class="line">  Normal  ScalingReplicaSet   55m               deployment-controller  Scaled up replica set tomcat-deployment-54b6fc9b99 to 2</div><div class="line">  Normal  ScalingReplicaSet   54m               deployment-controller  Scaled down replica set tomcat-deployment-5768d76c66 to 0</div><div class="line">  Normal  ScalingReplicaSet   4m                deployment-controller  Scaled up replica set tomcat-deployment-5768d76c66 to 1</div><div class="line">  Normal  DeploymentRollback  4m                deployment-controller  Rolled back deployment "tomcat-deployment<span class="string">" to revision 1</span></div><div class="line">  Normal  ScalingReplicaSet   4m (x2 over 58m)  deployment-controller  Scaled up replica set tomcat-deployment-5768d76c66 to 2</div><div class="line">  Normal  ScalingReplicaSet   4m                deployment-controller  Scaled down replica set tomcat-deployment-54b6fc9b99 to 1</div><div class="line">  Normal  ScalingReplicaSet   3m                deployment-controller  Scaled down replica set tomcat-deployment-54b6fc9b99 to 0</div><div class="line">[root@localhost ~]#</div></pre></td></tr></table></figure></p>
<p>注：在升级容器应用版本和回滚时，测试发现会约有2-3秒时间会出现应用访问故障。<br>测试情况为：Nginx反向代理所有Node IP地址+应用端口号。建议该应用端口号在Label Node上全局唯一。  </p>
<p>参数说明：<br>参考：<a href="https://www.jianshu.com/p/6bc8e0ae65d1" target="_blank" rel="external">https://www.jianshu.com/p/6bc8e0ae65d1</a><br><a href="https://www.ipcpu.com/2017/09/kubernetes-rolling-update/" target="_blank" rel="external">https://www.ipcpu.com/2017/09/kubernetes-rolling-update/</a>  </p>
<ul>
<li><code>maxSurge</code>与<code>maxUnavailable</code><br> maxSurge: 1 表示滚动升级时会先启动1个pod；maxUnavailable: 1 表示滚动升级时允许的最大Unavailable的pod个数</li>
<li><code>terminationGracePeriodSeconds</code><br> k8s将会给应用发送SIGTERM信号，可以用来正确、优雅地关闭应用,默认为30秒。如果需要更优雅地关闭，则可以使用k8s提供的pre-stop lifecycle hook 的配置声明，将会在发送SIGTERM之前执行  </li>
<li><code>livenessProbe</code>与<code>readinessProbe</code><br> livenessProbe是kubernetes认为该pod是存活的，不存在则需要kill掉，然后再新启动一个，以达到replicas指定的个数；readinessProbe是kubernetes认为该pod是启动成功的，这里根据每个应用的特性，自己去判断，可以执行command，也可以进行httpGet  </li>
</ul>
<h4 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q &amp; A"></a>Q &amp; A</h4><p>Question1：<br>如果报下面的错误，是k8s在调度时发现无可用的Node，因应用需要的主机端口在Node上被占用，无法完成RollingUpdate。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Warning  FailedScheduling  12s (x26 over 6m)  default-scheduler  0/2 nodes are available: 2 PodFitsHostPorts.</div></pre></td></tr></table></figure></p>
<p>思考：<br>应用升级成功，升级后NodeIP改变，怎么访问容器应用？<br>Answer：直接通过POD的IP和端口号可以访问容器应用，但POD的IP地址是不可靠的，如：当POD所在Node发生故障时，POD会被K8S重新调度到另一个POD，这是POD的IP地址就发生了变化，应用将无法访问。部署分布式容器应用，多个实例同时提供服务，容器应用前面配置一个负载均衡来实现转发。K8S的<code>kind:server</code>就是用来解决这些核心问题的。<br>测试经过：<code>kind:Deployment+service</code>部署的应用，访问任何一个NodeIP+端口号都可以，<code>kind:Deloyment</code>部署应用，访问应用只能用所在的Node IP+端口号才可以。  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2018/05/28/k8s滚动升级-RollingUpdate/">http://www.yfshare.vip/2018/05/28/k8s滚动升级-RollingUpdate/</a></p>
</div><script type="text/javascript" src="/js/share.js?v=2.0.0" async></script><a data-url="http://www.yfshare.vip/2018/05/28/k8s滚动升级-RollingUpdate/" data-id="cjmnif0o0004lgom5teapzxak" class="article-share-link">分享到</a><div class="tags"><a href="/tags/k8s/">k8s</a><a href="/tags/RollingUpdate/">RollingUpdate</a></div><div class="post-nav"><a href="/2018/06/21/Ansible部署Jenkins环境/" class="pre">Ansible部署Jenkins环境</a><a href="/2018/05/21/Ansible部署TLS-K8S/" class="next">Ansible部署TLS K8S</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论 「请确保 disqus.com 可以正常加载」</button></div><script>var disqus_shortname = 'yfshare';
var disqus_identifier = '2018/05/28/k8s滚动升级-RollingUpdate/';
var disqus_title = 'k8s滚动升级(RollingUpdate)';
var disqus_url = 'http://www.yfshare.vip/2018/05/28/k8s滚动升级-RollingUpdate/';
$('.btn_click_load').click(function() {
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  $('.btn_click_load').css('display','none');
});
$.ajax({
  url: 'https://disqus.com/favicon.ico',
  timeout: 3000,
  type: 'GET',
  success: (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    $('.btn_click_load').css('display','none');
  })(),
  error: function() {
    $('.btn_click_load').css('display','block');
  }
});</script><script id="dsq-count-scr" src="//yfshare.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Ansible/">Ansible</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Atlassian/">Atlassian</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Database/">Database</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ELK/">ELK</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Jenkins/">Jenkins</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/K8S/">K8S</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Security/">Security</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Virtualization/">Virtualization</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/WEB/">WEB</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Windows/">Windows</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Zabbix/">Zabbix</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/版本控制系统/">版本控制系统</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维知识体系/">运维知识体系</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/09/29/node-exporter自定义key/">node_exporter自定义key</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/04/Python运算符/">Python运算符</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/27/运维知识体系之操作系统层/">运维知识体系之操作系统层</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/04/部署jenkins项目/">部署jenkins项目</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/30/部署Zabbix-3-4/">部署Zabbix 3.4</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/21/Ansible部署Jenkins环境/">Ansible部署Jenkins环境</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/28/k8s滚动升级-RollingUpdate/">k8s滚动升级(RollingUpdate)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/21/Ansible部署TLS-K8S/">Ansible部署TLS K8S</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/17/glusterfs做持久化存储/">glusterfs做持久化存储</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/14/Prometheus监控TLS-Kubernetes集群/">Prometheus监控TLS Kubernetes集群</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://yfshare.blog.51cto.com/" title="酱油瓶 博客" target="_blank">酱油瓶 博客</a><ul></ul><a href="http://zerosre.com/" title="龙哥zero 博客" target="_blank">龙哥zero 博客</a><ul></ul><a href="http://renzhiyuan.blog.51cto.com/" title="任志远Ray 博客" target="_blank">任志远Ray 博客</a><ul></ul><a href="http://rongrong.njdgwl.com" title="浩子的 博客" target="_blank">浩子的 博客</a><ul></ul><a href="http://www.cnblogs.com/aresxin/" title="欣哥aresxin 博客" target="_blank">欣哥aresxin 博客</a><ul></ul><a href="http://securityit.cn/" title="万马奔腾" target="_blank">万马奔腾</a></div><div class="widget"><div class="widget-title"><i class="fa fa-external-resources"> 资源站</i></div><ul></ul><a href="http://mirror.symnds.com/distributions/CentOS-vault/" title="Centos镜像站" target="_blank">Centos镜像站</a><ul></ul><a href="http://www.rpmfind.net/" title="rpmfind mirror" target="_blank">rpmfind mirror</a><ul></ul><a href="http://rpm.org/" title="rpm.org" target="_blank">rpm.org</a><ul></ul><a href="http://rpm.pbone.net/" title="rpm search" target="_blank">rpm search</a><ul></ul><a href="http://download.chinaunix.net/" title="chinaunix download" target="_blank">chinaunix download</a><ul></ul><a href="http://www.anquanquan.info/" title="安全圈info" target="_blank">安全圈info</a><ul></ul><a href="http://source.tosimp.net/" title="Tosimp 资源站" target="_blank">Tosimp 资源站</a></div><div class="widget"><div class="widget-title"><i class="fa fa-external-music"> 音乐</i></div></div><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=371362&auto=1&height=66"></iframe><div class="widget"><div class="widget-title"><i class="fa fa-external-game"> 游戏</i></div><ul></ul><a href="/2048" title="2048小游戏" target="_blank">2048小游戏</a><ul></ul><a href="/tantanqiu" title="变色弹球跳台阶小游戏" target="_blank">变色弹球跳台阶小游戏</a></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//yfshare.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">Jack Wang Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=2.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=2.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=2.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?3890bdc1bfaccae9364479b65f36fbd2";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=2.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=2.0.0"></script></div></body></html>
<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Blog"><title>Prometheus监控TLS Kubernetes集群 | Jack Wang Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Prometheus监控TLS Kubernetes集群</h1><a id="logo" href="/.">Jack Wang Blog</a><p class="description">Goals determine what you are going to be</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa icon-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Prometheus监控TLS Kubernetes集群</h1><div class="post-meta">Mar 14, 2018<span> | </span><span class="category"><a href="/categories/K8S/">K8S</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2018/03/14/Prometheus监控TLS-Kubernetes集群/" href="/2018/03/14/Prometheus监控TLS-Kubernetes集群/#disqus_thread" class="disqus-comment-count"></a><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#Prometheus简介"><span class="toc-number">1.</span> <span class="toc-text">Prometheus简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#环境说明"><span class="toc-number">2.</span> <span class="toc-text">环境说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#部署node-exporter"><span class="toc-number">3.</span> <span class="toc-text">部署node-exporter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#部署Service-Account"><span class="toc-number">4.</span> <span class="toc-text">部署Service Account</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#部署Prometheus-alertmanager配置文件"><span class="toc-number">5.</span> <span class="toc-text">部署Prometheus alertmanager配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#部署Prometheus的配置文件"><span class="toc-number">6.</span> <span class="toc-text">部署Prometheus的配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#部署prometheus"><span class="toc-number">7.</span> <span class="toc-text">部署prometheus</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#访问prometheus"><span class="toc-number">8.</span> <span class="toc-text">访问prometheus</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#访问Alertmanager"><span class="toc-number">9.</span> <span class="toc-text">访问Alertmanager</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#告警规则"><span class="toc-number">10.</span> <span class="toc-text">告警规则</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#查询监控数据"><span class="toc-number">10.1.</span> <span class="toc-text">查询监控数据</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q-amp-A"><span class="toc-number">11.</span> <span class="toc-text">Q&A</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Prometheus监控Kubernetes-HTTP集群"><span class="toc-number">12.</span> <span class="toc-text">Prometheus监控Kubernetes HTTP集群</span></a></li></ol></div></div><div class="post-content"><script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>当我们完成Kubernetes集群环境部署后，就需要提取Kubernets集群中POD的日志提取和监控。当集群内的N台服务器在Kubernets的管理下自动创建和销毁POD，但在这种情况下，我们就不方便及时获取所有POD和服务器的运行状态及资源消耗状态，给我们感觉是，驾驶着一辆没有仪表盘的跑车在高速公路上飙车，给人一种心慌的感觉。<br>在以前的工作中，用过Nagios，Cacti，zabbix等监控工具。但在Kubernets集群中，这些工具并不适用。因此，我们需要引入新的监控工具Prometheus。<br><a id="more"></a></p>
<h4 id="Prometheus简介"><a href="#Prometheus简介" class="headerlink" title="Prometheus简介"></a>Prometheus简介</h4><p>Prometheus是SoundCloud开源的一款监控软件。它的实现参考了Google内部的监控实现， 与同样源自Google的Kubernetes项目十分搭配。Prometheus集成了数据采集，存储，异常告警多项功能，是一款一体化的完整方案。它针对大规模的集群环境设计了拉取式的数据采集方式、多维度数据存储格式以及服务发现等创新功能。<br>与传统监控工具相比，Prometheus 可以通过服务发现掌握集群内部已经暴露的监控点，然后主动拉取所有监控数据。通过这样的架构设计，我们仅需要向Kubernetes集群中部署一份Prometheus实例，它就可以通过向<code>apiserver</code>查询集群状态，然后向所有已经支持Prometheus metrics的kubelet获取所有Pod的运行数据。如果我们想采集底层服务器运行状态，通过DaemonSet在所有服务器上运行配套的node-exporter之后，Prometheus就可以自动采集到新的这部分数据。<br>这种动态发现的架构，非常适合服务器和程序都不固定的Kubernetes集群环境，同时也大大降低了运维的负担。  </p>
<p>Prometheus官网：<a href="https://prometheus.io/" target="_blank" rel="external">https://prometheus.io/</a><br>Prometheus官方下载地址：<a href="https://prometheus.io/download/" target="_blank" rel="external">https://prometheus.io/download/</a><br>Prometheus官方文档地址：<a href="https://prometheus.io/docs/introduction/overview/" target="_blank" rel="external">https://prometheus.io/docs/introduction/overview/</a>  </p>
<h4 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h4><p>环境：<br>　　　Prometheus v2.2.0<br>　　　node-exporter v0.15.2<br>　　　Kubernetes v1.8.2<br>　　　Centos 7.4  </p>
<table>
<thead>
<tr>
<th>角色</th>
<th>IP</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>k8s master</td>
<td>192.168.1.195</td>
<td>k8s master</td>
</tr>
<tr>
<td>k8s node</td>
<td>192.168.1.198</td>
<td>k8s node、Prometheus、node-exporter</td>
</tr>
<tr>
<td>k8s node</td>
<td>192.168.1.199</td>
<td>k8s node、Prometheus、node-exporter</td>
</tr>
</tbody>
</table>
<h4 id="部署node-exporter"><a href="#部署node-exporter" class="headerlink" title="部署node-exporter"></a>部署node-exporter</h4><p>node-exporter可以用于监控底层的服务器指标<br>下面是官方解释：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Prometheus exporter <span class="keyword">for</span> hardware and OS metrics exposed by *NIX kernels, written <span class="keyword">in</span> Go with pluggable metric collectors.</div><div class="line">The WMI exporter is recommended <span class="keyword">for</span> Windows users.</div></pre></td></tr></table></figure></p>
<p>node-exporter Github：<a href="https://github.com/prometheus/node_exporter" target="_blank" rel="external">https://github.com/prometheus/node_exporter</a>  </p>
<p>为了能够收集每个节点的信息，这里使用<code>DaemonSet</code>的形式部署PODS  </p>
<p>node-exporter.yaml：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">---</div><div class="line">apiVersion: extensions/v1beta1</div><div class="line">kind: DaemonSet</div><div class="line">metadata:</div><div class="line">  name: node-exporter</div><div class="line">  namespace: kube-ops</div><div class="line">  labels:</div><div class="line">    k8s-app: node-exporter</div><div class="line">spec:</div><div class="line">  template:</div><div class="line">    metadata:</div><div class="line">      labels:</div><div class="line">        k8s-app: node-exporter</div><div class="line">    spec:</div><div class="line">      containers:</div><div class="line">      - image: prom/node-exporter:latest</div><div class="line">        name: node-exporter</div><div class="line">        ports:</div><div class="line">        - containerPort: 9100</div><div class="line">          hostPort: 9100</div><div class="line">          protocol: TCP</div><div class="line">          name: http</div><div class="line">        volumeMounts:</div><div class="line">          - name: time</div><div class="line">            mountPath: /etc/localtime</div><div class="line">            <span class="built_in">read</span>Only: <span class="literal">true</span></div><div class="line">      volumes:</div><div class="line">        - name: time</div><div class="line">          hostPath:</div><div class="line">            path: /etc/localtime</div><div class="line">---</div><div class="line">apiVersion: v1</div><div class="line">kind: Service</div><div class="line">metadata:</div><div class="line">  labels:</div><div class="line">    k8s-app: node-exporter</div><div class="line">  name: node-exporter</div><div class="line">  namespace: kube-ops</div><div class="line">spec:</div><div class="line">  ports:</div><div class="line">  - name: http</div><div class="line">    port: 9100</div><div class="line">    targetPort: 9100</div><div class="line">    protocol: TCP</div><div class="line">  selector:</div><div class="line">    k8s-app: node-exporter</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@localhost prometheus]<span class="comment"># kubectl create namespace kube-ops</span></div><div class="line">[root@localhost prometheus]<span class="comment"># kubectl apply -f node-exporter.yaml</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@localhost prometheus]<span class="comment"># kubectl get pod -o wide -n kube-ops</span></div><div class="line">NAME                         READY     STATUS    RESTARTS   AGE       IP            NODE</div><div class="line">node-exporter-8d66t          1/1       Running   0          1h        172.30.41.5   192.168.1.199</div><div class="line">node-exporter-xn5ss          1/1       Running   0          1h        172.30.57.6   192.168.1.198</div><div class="line">[root@localhost prometheus]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@localhost prometheus]<span class="comment"># kubectl get svc -o wide -n kube-ops</span></div><div class="line">NAME            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE       SELECTOR</div><div class="line">node-exporter   ClusterIP   172.16.152.14   &lt;none&gt;        9100/TCP   1h        k8s-app=node-exporter</div><div class="line">[root@localhost prometheus]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h4 id="部署Service-Account"><a href="#部署Service-Account" class="headerlink" title="部署Service Account"></a>部署Service Account</h4><p>Kubernetes在1.8.0之后启用了RBAC特性，因此我们需要先通过RBAC授权，然后Prometheus通过RBAC连接Kubernetes集群，否则被拒绝后，将无法连接到K8s的API-SERVER<br>参考：<a href="https://kubernetes.io/docs/admin/authorization/rbac/" target="_blank" rel="external">https://kubernetes.io/docs/admin/authorization/rbac/</a>  </p>
<p>prometheus-service-account.yml：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">apiVersion: v1</div><div class="line">kind: ServiceAccount</div><div class="line">metadata:</div><div class="line">  name: prometheus</div><div class="line">  namespace: kube-ops</div><div class="line">---</div><div class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</div><div class="line">kind: ClusterRole</div><div class="line">metadata:</div><div class="line">  name: prometheus</div><div class="line">  namespace: kube-ops</div><div class="line">rules:</div><div class="line">- apiGroups: [<span class="string">""</span>]</div><div class="line">  resources:</div><div class="line">  - nodes</div><div class="line">  - nodes/proxy</div><div class="line">  - services</div><div class="line">  - endpoints</div><div class="line">  - pods</div><div class="line">  verbs: [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>]</div><div class="line">- nonResourceURLs: [<span class="string">"/metrics"</span>]</div><div class="line">  verbs: [<span class="string">"get"</span>]</div><div class="line">---</div><div class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</div><div class="line">kind: ClusterRoleBinding</div><div class="line">metadata:</div><div class="line">  name: prometheus</div><div class="line">  namespace: kube-ops</div><div class="line">roleRef:</div><div class="line">  apiGroup: rbac.authorization.k8s.io</div><div class="line">  kind: ClusterRole</div><div class="line">  name: prometheus</div><div class="line">subjects:</div><div class="line">- kind: ServiceAccount</div><div class="line">  name: prometheus</div><div class="line">  namespace: kube-ops</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@localhost prometheus]<span class="comment"># kubectl apply -f prometheus-service-account.yml</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@localhost prometheus]<span class="comment"># kubectl get ServiceAccount -n kube-ops</span></div><div class="line">NAME         SECRETS   AGE</div><div class="line">default      1         1d</div><div class="line">prometheus   1         55m</div><div class="line">[root@localhost prometheus]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h4 id="部署Prometheus-alertmanager配置文件"><a href="#部署Prometheus-alertmanager配置文件" class="headerlink" title="部署Prometheus alertmanager配置文件"></a>部署Prometheus alertmanager配置文件</h4><p>使用ConfigMap的形式来设置Prometheus的配置文件<br>参考：<a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/" target="_blank" rel="external">https://prometheus.io/docs/prometheus/latest/configuration/configuration/</a>  </p>
<p>prometheus-alertmanager-config.yml：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">kind: ConfigMap</div><div class="line">apiVersion: v1</div><div class="line">metadata:</div><div class="line">  name: alertmanager</div><div class="line">  namespace: kube-ops</div><div class="line">data:</div><div class="line">  config.yml: |-</div><div class="line">    global:</div><div class="line">      smtp_smarthost: <span class="string">'smtp.exmail.qq.com:465'</span></div><div class="line">      smtp_from: <span class="string">'user1@example.com'</span></div><div class="line">      smtp_auth_username: <span class="string">'user1@example.com'</span></div><div class="line">      smtp_auth_password: <span class="string">'password'</span></div><div class="line">      smtp_require_tls: <span class="literal">false</span></div><div class="line">  </div><div class="line">      resolve_timeout: 5m</div><div class="line"></div><div class="line">    templates:</div><div class="line">      - <span class="string">'/etc/alertmanager/*.tmpl'</span></div><div class="line"></div><div class="line">    route:</div><div class="line">      receiver: email</div><div class="line">      group_wait: 30s</div><div class="line">      group_interval: 5m</div><div class="line">      repeat_interval: 10d</div><div class="line">      group_by: [alertname]</div><div class="line">      routes:</div><div class="line">      - receiver: email</div><div class="line">        group_wait: 10s</div><div class="line">        match:</div><div class="line">          team: node</div><div class="line">    receivers:</div><div class="line">    - name: email</div><div class="line">      email_configs:</div><div class="line">      - send_resolved: <span class="literal">true</span></div><div class="line">        to: <span class="string">'user2@example.com,user3@example.com'</span></div></pre></td></tr></table></figure></p>
<ul>
<li><code>repeat_interval</code>：指定告警发送间隔时间  </li>
<li><code>to: &#39;user2@example.com,user3@example.com&#39;</code>指定多个收件人，每个收件人邮箱之间用<code>逗号</code>隔开  </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@localhst prometheus]<span class="comment"># kubectl apply -f prometheus-alertmanager-config.yml</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@localhst prometheus]<span class="comment"># kubectl get ConfigMap -n kube-ops</span></div><div class="line">NAME                DATA      AGE</div><div class="line">alertmanager        2         21h</div><div class="line">[root@localhst prometheus]<span class="comment">#</span></div></pre></td></tr></table></figure>
<ul>
<li>需要修改<code>global.smtp*</code>和<code>receivers.name.email_configs</code>相关的邮件信息  </li>
</ul>
<h4 id="部署Prometheus的配置文件"><a href="#部署Prometheus的配置文件" class="headerlink" title="部署Prometheus的配置文件"></a>部署Prometheus的配置文件</h4><p>prometheus-config.yaml：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div></pre></td><td class="code"><pre><div class="line">apiVersion: v1</div><div class="line">kind: ConfigMap</div><div class="line">metadata:</div><div class="line">  name: prometheus-config</div><div class="line">  namespace: kube-ops</div><div class="line">data:</div><div class="line">  prometheus.yml: |</div><div class="line">    global:</div><div class="line">      scrape_interval: 30s</div><div class="line">      scrape_timeout: 30s</div><div class="line">    alerting:</div><div class="line">      alertmanagers:</div><div class="line">        - static_configs:</div><div class="line">            - targets: [<span class="string">"192.168.1.198:9093"</span>]</div><div class="line">    rule_files:</div><div class="line">      - <span class="string">"rules.yml"</span></div><div class="line">    scrape_configs:</div><div class="line">    - job_name: <span class="string">'prometheus'</span></div><div class="line">      static_configs:</div><div class="line">        - targets: [<span class="string">'localhost:9090'</span>]</div><div class="line"></div><div class="line">    - job_name: <span class="string">'kubernetes-apiservers'</span></div><div class="line">      kubernetes_sd_configs:</div><div class="line">      - role: endpoints</div><div class="line">      scheme: https</div><div class="line">      tls_config:</div><div class="line">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</div><div class="line">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</div><div class="line">      relabel_configs:</div><div class="line">      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</div><div class="line">        action: keep</div><div class="line">        regex: default;kubernetes;https</div><div class="line"></div><div class="line">    - job_name: <span class="string">'kubernetes-nodes'</span></div><div class="line">      scheme: https</div><div class="line">      tls_config:</div><div class="line">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</div><div class="line">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</div><div class="line">      kubernetes_sd_configs:</div><div class="line">      - role: node</div><div class="line">      relabel_configs:</div><div class="line">      - action: labelmap</div><div class="line">        regex: __meta_kubernetes_node_label_(.+)</div><div class="line">      - target_label: __address__</div><div class="line">        replacement: 192.168.1.195:6443</div><div class="line">      - source_labels: [__meta_kubernetes_node_name]</div><div class="line">        regex: (.+)</div><div class="line">        target_label: __metrics_path__</div><div class="line">        replacement: /api/v1/nodes/<span class="variable">$&#123;1&#125;</span>/proxy/metrics</div><div class="line"></div><div class="line">    - job_name: <span class="string">'kubernetes-cadvisor'</span></div><div class="line">      scheme: https</div><div class="line">      tls_config:</div><div class="line">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</div><div class="line">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</div><div class="line">      kubernetes_sd_configs:</div><div class="line">      - role: node</div><div class="line">      relabel_configs:</div><div class="line">      - action: labelmap</div><div class="line">        regex: __meta_kubernetes_node_label_(.+)</div><div class="line">      - target_label: __address__</div><div class="line">        replacement: 192.168.1.195:6443</div><div class="line">      - source_labels: [__meta_kubernetes_node_name]</div><div class="line">        regex: (.+)</div><div class="line">        target_label: __metrics_path__</div><div class="line">        replacement: /api/v1/nodes/<span class="variable">$&#123;1&#125;</span>/proxy/metrics/cadvisor</div><div class="line"></div><div class="line">    - job_name: <span class="string">'kubernetes-node-exporter'</span></div><div class="line">      scheme: http</div><div class="line">      tls_config:</div><div class="line">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</div><div class="line">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</div><div class="line">      kubernetes_sd_configs:</div><div class="line">      - role: node</div><div class="line">      relabel_configs:</div><div class="line">      - action: labelmap</div><div class="line">        regex: __meta_kubernetes_node_label_(.+)</div><div class="line">      - source_labels: [__meta_kubernetes_role]</div><div class="line">        action: replace</div><div class="line">        target_label: kubernetes_role</div><div class="line">      - source_labels: [__address__]</div><div class="line">        regex: <span class="string">'(.*):10250'</span></div><div class="line">        replacement: <span class="string">'$&#123;1&#125;:9100'</span></div><div class="line">        target_label: __address__</div><div class="line"></div><div class="line">  rules.yml: |</div><div class="line">    groups:</div><div class="line">    - name: rule</div><div class="line">      rules:</div><div class="line">      - alert: NodeFilesystemUsage</div><div class="line">        expr: (node_filesystem_size&#123;device=<span class="string">"rootfs"</span>&#125; - node_filesystem_free&#123;device=<span class="string">"rootfs"</span>&#125;) / node_filesystem_size&#123;device=<span class="string">"rootfs"</span>&#125; * 100 &gt; 80</div><div class="line">        <span class="keyword">for</span>: 2m</div><div class="line">        labels:</div><div class="line">          team: node</div><div class="line">        annotations:</div><div class="line">          summary: <span class="string">"&#123;&#123;<span class="variable">$labels</span>.instance&#125;&#125;: High Filesystem usage detected"</span></div><div class="line">          description: <span class="string">"&#123;&#123;<span class="variable">$labels</span>.instance&#125;&#125;: Filesystem usage is above 80% (current value is: &#123;&#123; <span class="variable">$value</span> &#125;&#125;"</span></div><div class="line">      - alert: NodeMemoryUsage</div><div class="line">        expr: (node_memory_MemTotal - (node_memory_MemFree+node_memory_Buffers+node_memory_Cached )) / node_memory_MemTotal * 100 &gt; 80</div><div class="line">        <span class="keyword">for</span>: 2m</div><div class="line">        labels:</div><div class="line">          team: node</div><div class="line">        annotations:</div><div class="line">          summary: <span class="string">"&#123;&#123;<span class="variable">$labels</span>.instance&#125;&#125;: High Memory usage detected"</span></div><div class="line">          description: <span class="string">"&#123;&#123;<span class="variable">$labels</span>.instance&#125;&#125;: Memory usage is above 80% (current value is: &#123;&#123; <span class="variable">$value</span> &#125;&#125;"</span></div><div class="line">      - alert: NodeCPUUsage</div><div class="line">        expr: (100 - (avg by (instance) (irate(node_cpu&#123;job=<span class="string">"kubernetes-node-exporter"</span>,mode=<span class="string">"idle"</span>&#125;[5m])) * 100)) &gt; 80</div><div class="line">        <span class="keyword">for</span>: 2m</div><div class="line">        labels:</div><div class="line">          team: node</div><div class="line">        annotations:</div><div class="line">          summary: <span class="string">"&#123;&#123;<span class="variable">$labels</span>.instance&#125;&#125;: High CPU usage detected"</span></div><div class="line">          description: <span class="string">"&#123;&#123;<span class="variable">$labels</span>.instance&#125;&#125;: CPU usage is above 80% (current value is: &#123;&#123; <span class="variable">$value</span> &#125;&#125;"</span></div></pre></td></tr></table></figure></p>
<ul>
<li><code>job_name: &#39;kubernetes-node-exporter&#39;</code>中替换31672端口为9100，该端口是<code>node-exporter</code>暴露的<code>NodePort</code>端口，这里需要根据实际情况填写<br>在前面node-exporter.yaml中指定了<code>targetPort: 9100</code>，所以这里的端口需要修改为9100  </li>
<li><code>kubernetes.default.svc:443</code>为k8s api地址，如果安装k8s时不是使用的默认DNS，则需要手动修改  </li>
<li>新增了Prometheus alertmanagers，需要修改<code>alerting.alertmanagers.static_configs.targets</code>的IP地址，这时Prometheus和alertmanagers是两个docker容器，IP为运行alertmanagers的宿主机的IP地址  </li>
<li>新增了Prometheus alertmanagers告警规则，添加<code>rule_files</code>(指定报警规则)，并增加三条规则(rules.yml)  </li>
<li>这里新增的三条报警规则分别是：节点的文件系统，节点内存，CPU的使用量。如果大于了80%的话就触发label为<code>team=node</code>的<code>receiver</code>(alertmanager  配置文件中配置)，可以看到上面的配置就会匹配<code>email</code>这个<code>receiver</code>  </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@localhost prometheus]<span class="comment"># kubectl apply -f prometheus-config.yaml</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@localhst prometheus]<span class="comment"># kubectl get ConfigMap -n kube-ops</span></div><div class="line">NAME                DATA      AGE</div><div class="line">alertmanager        2         21h</div><div class="line">prometheus-config   1         21h</div><div class="line">[root@localhst prometheus]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h4 id="部署prometheus"><a href="#部署prometheus" class="headerlink" title="部署prometheus"></a>部署prometheus</h4><p>使用Deployment的形式来设置Prometheus<br>参考：<a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" target="_blank" rel="external">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/</a>  </p>
<p>创建Node Label:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># kubectl label node 192.168.1.198 "appNodes=pro-00-monitor"</span></div><div class="line">node <span class="string">"192.168.1.198"</span> labeled</div><div class="line">[root@localhost ~]<span class="comment"># kubectl get node -a -l "appNodes=pro-00-monitor"</span></div><div class="line">NAME            STATUS    ROLES     AGE       VERSION</div><div class="line">192.168.1.198   Ready     &lt;none&gt;    24m       v1.9.2</div><div class="line">[root@localhost ~]<span class="comment"># </span></div><div class="line">[root@localhost ~]<span class="comment"># mkdir -p /data/monitor   #创建数据挂载目录</span></div></pre></td></tr></table></figure></p>
<p>prometheus-deploy.yaml:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line">apiVersion: extensions/v1beta1</div><div class="line">kind: Deployment</div><div class="line">metadata:</div><div class="line">  labels:</div><div class="line">    k8s-app: prometheus</div><div class="line">  name: prometheus</div><div class="line">  namespace: kube-ops</div><div class="line">spec:</div><div class="line">  replicas: 1</div><div class="line">  template:</div><div class="line">    metadata:</div><div class="line">      labels:</div><div class="line">        k8s-app: prometheus</div><div class="line">    spec:</div><div class="line">      nodeSelector:</div><div class="line">        appNodes: pro-00-monitor</div><div class="line">      securityContext:</div><div class="line">        runAsUser: 0</div><div class="line">      serviceAccountName: prometheus</div><div class="line">      containers:</div><div class="line">      - image: prom/prometheus:v2.2.0</div><div class="line">        name: prometheus</div><div class="line">        <span class="built_in">command</span>:</div><div class="line">        - <span class="string">"/bin/prometheus"</span></div><div class="line">        args:</div><div class="line">        - <span class="string">"--config.file=/etc/prometheus/prometheus.yml"</span></div><div class="line">        - <span class="string">"--storage.tsdb.path=/prometheus"</span></div><div class="line">        - <span class="string">"--storage.tsdb.retention=15d"</span></div><div class="line">        ports:</div><div class="line">        - containerPort: 9090</div><div class="line">          hostPort: 9090</div><div class="line">          protocol: TCP</div><div class="line">          name: http</div><div class="line">        volumeMounts:</div><div class="line">        - mountPath: <span class="string">"/prometheus"</span></div><div class="line">          name: data</div><div class="line">          subPath: prometheus/data</div><div class="line">        - mountPath: <span class="string">"/etc/prometheus"</span></div><div class="line">          name: config-volume</div><div class="line">        - mountPath: <span class="string">"/etc/localtime"</span></div><div class="line">          name: time</div><div class="line">          <span class="built_in">read</span>Only: <span class="literal">true</span></div><div class="line">        resources:</div><div class="line">          requests:</div><div class="line">            cpu: 1</div><div class="line">            memory: 1Gi</div><div class="line">          limits:</div><div class="line">            cpu: 1</div><div class="line">            memory: 2Gi</div><div class="line">      - image: prom/alertmanager:v0.14.0</div><div class="line">        name: alertmanager</div><div class="line">        args: </div><div class="line">        - <span class="string">"--config.file=/etc/alertmanager/config.yml"</span></div><div class="line">        - <span class="string">"--storage.path=/alertmanager"</span></div><div class="line">        ports:</div><div class="line">        - containerPort: 9093</div><div class="line">          hostPort: 9093</div><div class="line">          protocol: TCP</div><div class="line">          name: http</div><div class="line">        volumeMounts:</div><div class="line">        - name: alertmanager-config-volume</div><div class="line">          mountPath: /etc/alertmanager</div><div class="line">        resources:</div><div class="line">          requests:</div><div class="line">            memory: 500Mi</div><div class="line">          limits:</div><div class="line">            memory: 1024Mi</div><div class="line"></div><div class="line">      volumes:</div><div class="line">      - name: data</div><div class="line">        hostPath:</div><div class="line">          path: <span class="string">"/data/monitor"</span></div><div class="line">      - name: time</div><div class="line">        hostPath:</div><div class="line">          path: <span class="string">"/etc/localtime"</span></div><div class="line">      - configMap:</div><div class="line">          name: prometheus-config</div><div class="line">        name: config-volume</div><div class="line">      - name: alertmanager-config-volume</div><div class="line">        configMap:</div><div class="line">          name: alertmanager</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@localhost prometheus]<span class="comment"># kubectl apply -f prometheus-deploy.yaml</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@localhost prometheus]<span class="comment"># kubectl get pod -o wide -n kube-ops</span></div><div class="line">prometheus-fc7685cc7-rwlc7   1/1       Running   0          34s       172.30.57.7   192.168.1.198</div><div class="line">[root@localhost prometheus]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@localhst ~]<span class="comment"># netstat -tunlp |egrep '9090|9093'</span></div><div class="line">tcp6       0      0 :::9090                 :::*                    LISTEN      4023/docker-proxy   </div><div class="line">tcp6       0      0 :::9093                 :::*                    LISTEN      3983/docker-proxy   </div><div class="line">[root@localhst ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h4 id="访问prometheus"><a href="#访问prometheus" class="headerlink" title="访问prometheus"></a>访问prometheus</h4><p>prometheus启动成功后，我们就可以打开prometheus dashboard查看了，访问 <a href="http://ip:9090/graph" target="_blank" rel="external">http://ip:9090/graph</a> ，点<code>status</code>–&gt;<code>Targets</code><br>可以看到prometheus已经成功访问到k8s api-server并获取到监控指标<br><img src="https://note.youdao.com/yws/api/personal/file/5A5C1E0628B743DFA4F4B2B73F2429EC?method=download&amp;shareKey=202dd33859c3cb11ad6ae23b375830c0" alt="prometheus_dashboard">  </p>
<h4 id="访问Alertmanager"><a href="#访问Alertmanager" class="headerlink" title="访问Alertmanager"></a>访问Alertmanager</h4><p>alertmanager启动后，我们可以打开alertmanager Dashboard查看，访问 <a href="http://ip:9093" target="_blank" rel="external">http://ip:9093</a><br>当然在prometheus dashboard也可以查看，在status –&gt; Runtime &amp; Build Information 最底部<br><img src="https://note.youdao.com/yws/api/personal/file/98EFE5C15FC540FA908C5C1497D91920?method=download&amp;shareKey=0b20c6a63adc15aeaa13dd0d4a5ea71b" alt="prometheus_dashboard"><br><img src="https://note.youdao.com/yws/api/personal/file/2D1F17C7438142699F963870A6390F11?method=download&amp;shareKey=2402d8b386b7043bd5f1f786f887a6d7" alt="alertmanager_dashboard">  </p>
<h4 id="告警规则"><a href="#告警规则" class="headerlink" title="告警规则"></a>告警规则</h4><p>在Prometheus定义的rules生效后，可以在Status –&gt;Rules 这里看到<br><img src="https://note.youdao.com/yws/api/personal/file/9B322CA7B9D94AC2A64A4D0F6EF7782E?method=download&amp;shareKey=ec1e3d77582b99329a81377f5b06af3c" alt="Prometheus_rules">  </p>
<ul>
<li>点击的<code>expr</code>会直接跳转到<code>Prometheus graph</code>页面查询，在制定报警规则的时候，可以先在Prometheus中测试表达式  </li>
</ul>
<p>在Prometheus的Alerts这里可以看到触发告警规则的状态<br><img src="https://note.youdao.com/yws/api/personal/file/BFEF5FDAB48243208845A6B9ECB73E82?method=download&amp;shareKey=cb282de4e9235539cfd9de06c25bb8f8" alt="Prometheus_alerts">  </p>
<p>目前有三台主机成功触发规则<br><img src="https://note.youdao.com/yws/api/personal/file/99BC064346EF4145B7BFC379074D6E95?method=download&amp;shareKey=dbb2f00e073c3decc6ac212e89afde20" alt="Prometheus_alerts"><br>一个报警信息在生命周期内有下面3中状态：  </p>
<ul>
<li><code>inactive</code>: 表示当前报警信息既不是<code>firing</code>状态也不是<code>pending</code>状态  </li>
<li><code>pending</code>: 表示在设置的阈值时间范围内被激活。这时Prometheus处于等待状态，大概等待3分钟左右，整合所有的告警条目，等待集中发送给Alertmanager  </li>
<li><code>firing</code>: 表示超过设置的阈值时间被激活。这时Prometheus处于发送告警到Alertmanager阶段，也是最终状态  </li>
</ul>
<p>触发规则后，也可以在Alertmanager Dashboard上看到<br><img src="https://note.youdao.com/yws/api/personal/file/286134D8EF3840CEA3007194B8DC3F94?method=download&amp;shareKey=0fed791095cd1092ac1edd0d5371afc2" alt="Alertmanager_dashboard">  </p>
<p>最后来一张，我们成功收到Alertmanager的告警邮件截图<br><img src="https://note.youdao.com/yws/api/personal/file/76A8767C9A4A4D918619F8FAEBC1D5C6?method=download&amp;shareKey=f1e80c27014145cc5690093c25dda3d1" alt="Alertmanager_mail">  </p>
<h5 id="查询监控数据"><a href="#查询监控数据" class="headerlink" title="查询监控数据"></a>查询监控数据</h5><p>Prometheus提供了<code>API</code>的方式进行数据查询，同样可以使用<code>query语言</code>进行复杂的查询任务<br>点<code>Graph</code><br>查询每个POD的CPU使用情况，输入：<br><code>sum by (pod_name)( rate(container_cpu_usage_seconds_total{image!=&quot;&quot;, pod_name!=&quot;&quot;}[1m] ) )</code><br><img src="https://note.youdao.com/yws/api/personal/file/B481FAA4C243432B866A7F842B360E5D?method=download&amp;shareKey=29a94a564c7abd86ff5f1317ffb76abe" alt="prometheus_dashboard"><br><img src="https://note.youdao.com/yws/api/personal/file/6ED534C0E64B4E12A72B5BD9E3851277?method=download&amp;shareKey=440bb39fc1c4e47e8e812b283553d30e" alt="prometheus_dashboard">  </p>
<p>更多查询条件参考：<br><a href="https://prometheus.io/docs/prometheus/latest/querying/basics/" target="_blank" rel="external">https://prometheus.io/docs/prometheus/latest/querying/basics/</a><br><a href="https://prometheus.io/docs/prometheus/latest/querying/api/" target="_blank" rel="external">https://prometheus.io/docs/prometheus/latest/querying/api/</a><br><a href="https://prometheus.io/docs/prometheus/latest/querying/examples/" target="_blank" rel="external">https://prometheus.io/docs/prometheus/latest/querying/examples/</a>  </p>
<h4 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h4><p>Question：<br>如果遇到下面的报错：<br><img src="https://note.youdao.com/yws/api/personal/file/8657660A593F4FFBBC965F98A79D973E?method=download&amp;shareKey=7eb28760c6b0ae77dabd41cadb223118" alt="prometheus_error"><br><img src="https://note.youdao.com/yws/api/personal/file/1CFA492189C44463B3D098625571B0BB?method=download&amp;shareKey=2b33b854b21704a8f10d677b3e645ee2" alt="prometheus_error">  </p>
<p>Answer：<br>在<code>prometheus-deploy.yaml</code>中<code>spec.spec.</code>下增加如下配置：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">securityContext:</div><div class="line">  runAsUser: 0</div></pre></td></tr></table></figure></p>
<p>详细配置参考上面prometheus-deploy.yaml配置文件<br>参考：<a href="https://github.com/prometheus/prometheus/issues/2939" target="_blank" rel="external">https://github.com/prometheus/prometheus/issues/2939</a>  </p>
<p>Question：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">level=error ts=2018-04-23T13:08:34.417214948Z <span class="built_in">caller</span>=notify.go:303 component=dispatcher msg=<span class="string">"Error on notify"</span> err=<span class="string">"dial t</span></div><div class="line">cp 14.18.245.164:25: getsockopt: connection timed out"level=error ts=2018-04-23T13:08:34.417316796Z <span class="built_in">caller</span>=dispatch.go:266 component=dispatcher msg=<span class="string">"Notify for alerts failed"</span> </div><div class="line">num_alerts=3 err=<span class="string">"dial tcp 14.18.245.164:25: getsockopt: connection timed out"</span></div></pre></td></tr></table></figure></p>
<p>Answer：<br>遇到上面的报错，首先先检查下docker容器是否联网，再测试下与smtp服务器是否正常通讯<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">telnet smtp.qq.com 25</div></pre></td></tr></table></figure></p>
<p>在测试过程中发现，腾讯邮箱(个人QQ邮件+企业邮箱)，只支持SMTP SSL 465端口，且不支持TLS，<code>smtp_require_tls</code>这个参数官方默认是<code>true</code>，这里需要设置为 <code>smtp_require_tls: false</code>，使用不同邮箱的SMTP 需要具体测试。  </p>
<h4 id="Prometheus监控Kubernetes-HTTP集群"><a href="#Prometheus监控Kubernetes-HTTP集群" class="headerlink" title="Prometheus监控Kubernetes HTTP集群"></a>Prometheus监控Kubernetes HTTP集群</h4><p>环境：<br>　　　Prometheus v1.0.1<br>　　　node-exporter v0.15.2<br>　　　Kubernetes v1.8.2  </p>
<p>服务器环境如上  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#获取k8s kube-apiserver地址和端口</span></div><div class="line">[root@localhost ~]<span class="comment"># netstat -tunlp |grep -i kube-apiserver</span></div><div class="line">tcp        0      0 192.168.1.195:6443      0.0.0.0:*               LISTEN      4555/kube-apiserver </div><div class="line">tcp        0      0 192.168.1.195:8080      0.0.0.0:*               LISTEN      4555/kube-apiserver </div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@localhost prometheus]<span class="comment"># kubectl apply -f node-exporter.yaml </span></div><div class="line">[root@localhost prometheus]<span class="comment"># kubectl apply -f prometheus-config.yaml </span></div><div class="line">[root@localhost prometheus]<span class="comment"># kubectl apply -f prometheus-deploy.yaml</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@localhost prometheus]<span class="comment"># kubectl get pod -n kube-ops -o wide</span></div><div class="line">NAME                          READY     STATUS    RESTARTS   AGE       IP            NODE</div><div class="line">node-exporter-hjgds           1/1       Running   0          23m       172.30.41.5   192.168.1.199</div><div class="line">node-exporter-zmlcg           1/1       Running   0          23m       172.30.57.6   192.168.1.198</div><div class="line">prometheus-5f86bc8bc5-tbnxp   1/1       Running   0          10m       172.30.41.6   192.168.1.199</div><div class="line">[root@localhost prometheus]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@localhost prometheus]<span class="comment"># kubectl get svc -n kube-ops -o wide</span></div><div class="line">NAME            TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE       SELECTOR</div><div class="line">node-exporter   ClusterIP   172.16.40.83   &lt;none&gt;        9100/TCP   24m       k8s-app=node-exporter</div><div class="line">[root@localhost prometheus]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@localhost prometheus]<span class="comment"># kubectl get ConfigMap -n kube-ops -o wide</span></div><div class="line">NAME                DATA      AGE</div><div class="line">prometheus-config   1         22m</div><div class="line">[root@localhost prometheus]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p><img src="https://note.youdao.com/yws/api/personal/file/15FCF902C5EB4A54A3728C01830296A5?method=download&amp;shareKey=29ebc89d7b0cc24633dbcf0918e2d9ab" alt="prometheus_dashboard_http">  </p>
<p>其他的同上，Prometheus监控Kubernetes HTTP集群配置文件见附件<br>注：经测试，目前只发现<code>Prometheus v1.0.1</code>支持，测试其他版本都有报错  </p>
<p>参考：<br><a href="https://blog.qikqiak.com/post/kubernetes-monitor-prometheus-grafana/" target="_blank" rel="external">https://blog.qikqiak.com/post/kubernetes-monitor-prometheus-grafana/</a><br><a href="https://blog.qikqiak.com/post/update-prometheus-2-in-kubernetes/" target="_blank" rel="external">https://blog.qikqiak.com/post/update-prometheus-2-in-kubernetes/</a><br><a href="https://github.com/cnych/k8s-repo/tree/master/prometheus" target="_blank" rel="external">https://github.com/cnych/k8s-repo/tree/master/prometheus</a><br><a href="https://blog.qikqiak.com/post/alertmanager-of-prometheus-in-practice/" target="_blank" rel="external">https://blog.qikqiak.com/post/alertmanager-of-prometheus-in-practice/</a><br><a href="https://blog.csdn.net/qq_21398167/article/details/76008594?locationnum=10&amp;fps=1" target="_blank" rel="external">https://blog.csdn.net/qq_21398167/article/details/76008594?locationnum=10&amp;fps=1</a><br><a href="https://segmentfault.com/a/1190000008695463" target="_blank" rel="external">https://segmentfault.com/a/1190000008695463</a><br><a href="https://prometheus.io/docs/alerting/overview/" target="_blank" rel="external">https://prometheus.io/docs/alerting/overview/</a>  </p>
<p>附件：<br><a href="https://note.youdao.com/yws/api/personal/file/E0F2C93038D3412091FDA362DB3B5C77?method=download&amp;shareKey=debbdb748ebf0483c64e3ee2e3e5eb0d" target="_blank" rel="external">Prometheus监控TLS K8S配置文件.zip</a><br><a href="https://note.youdao.com/yws/api/personal/file/E14D629E3CD24DB180F879AC4B8D89F3?method=download&amp;shareKey=ec648c66a75a232d80cd93ed540b3960" target="_blank" rel="external">Prometheus监控K8S HTTP配置文件.zip</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2018/03/14/Prometheus监控TLS-Kubernetes集群/">http://www.yfshare.vip/2018/03/14/Prometheus监控TLS-Kubernetes集群/</a></p>
</div><script type="text/javascript" src="/js/share.js?v=2.0.0" async></script><a data-url="http://www.yfshare.vip/2018/03/14/Prometheus监控TLS-Kubernetes集群/" data-id="cjrggk8fs003d24m5g5gd9oqz" class="article-share-link">分享到</a><div class="tags"><a href="/tags/Prometheus/">Prometheus</a><a href="/tags/Kubernetes/">Kubernetes</a><a href="/tags/K8S/">K8S</a></div><div class="post-nav"><a href="/2018/03/17/glusterfs做持久化存储/" class="pre">glusterfs做持久化存储</a><a href="/2018/02/23/部署TLS-k8s/" class="next">部署TLS k8s</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论 「请确保 disqus.com 可以正常加载」</button></div><script>var disqus_shortname = 'yfshare';
var disqus_identifier = '2018/03/14/Prometheus监控TLS-Kubernetes集群/';
var disqus_title = 'Prometheus监控TLS Kubernetes集群';
var disqus_url = 'http://www.yfshare.vip/2018/03/14/Prometheus监控TLS-Kubernetes集群/';
$('.btn_click_load').click(function() {
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  $('.btn_click_load').css('display','none');
});
$.ajax({
  url: 'https://disqus.com/favicon.ico',
  timeout: 3000,
  type: 'GET',
  success: (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    $('.btn_click_load').css('display','none');
  })(),
  error: function() {
    $('.btn_click_load').css('display','block');
  }
});</script><script id="dsq-count-scr" src="//yfshare.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Ansible/">Ansible</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Atlassian/">Atlassian</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Database/">Database</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ELK/">ELK</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Jenkins/">Jenkins</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/K8S/">K8S</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Security/">Security</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Virtualization/">Virtualization</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/WEB/">WEB</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Windows/">Windows</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Zabbix/">Zabbix</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/版本控制系统/">版本控制系统</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维知识体系/">运维知识体系</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/01/28/k8s集群水平扩展-HPA/">k8s集群水平扩展(HPA)</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/20/Grafana日志聚合工具Loki/">Grafana日志聚合工具Loki</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/06/Python十行代码爬抖音/">Python十行代码爬抖音</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/04/Python升级/">Python升级</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/29/node-exporter自定义key/">node_exporter自定义key</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/04/Python运算符/">Python运算符</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/27/运维知识体系之操作系统层/">运维知识体系之操作系统层</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/04/部署jenkins项目/">部署jenkins项目</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/30/部署Zabbix-3-4/">部署Zabbix 3.4</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/21/Ansible部署Jenkins环境/">Ansible部署Jenkins环境</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://yfshare.blog.51cto.com/" title="酱油瓶 博客" target="_blank">酱油瓶 博客</a><ul></ul><a href="http://zerosre.com/" title="龙哥zero 博客" target="_blank">龙哥zero 博客</a><ul></ul><a href="http://renzhiyuan.blog.51cto.com/" title="任志远Ray 博客" target="_blank">任志远Ray 博客</a><ul></ul><a href="http://rongrong.njdgwl.com" title="浩子的 博客" target="_blank">浩子的 博客</a><ul></ul><a href="http://www.cnblogs.com/aresxin/" title="欣哥aresxin 博客" target="_blank">欣哥aresxin 博客</a><ul></ul><a href="http://securityit.cn/" title="万马奔腾" target="_blank">万马奔腾</a></div><div class="widget"><div class="widget-title"><i class="fa fa-external-resources"> 资源站</i></div><ul></ul><a href="http://mirror.symnds.com/distributions/CentOS-vault/" title="Centos镜像站" target="_blank">Centos镜像站</a><ul></ul><a href="http://www.rpmfind.net/" title="rpmfind mirror" target="_blank">rpmfind mirror</a><ul></ul><a href="http://rpm.org/" title="rpm.org" target="_blank">rpm.org</a><ul></ul><a href="http://rpm.pbone.net/" title="rpm search" target="_blank">rpm search</a><ul></ul><a href="http://download.chinaunix.net/" title="chinaunix download" target="_blank">chinaunix download</a><ul></ul><a href="http://www.anquanquan.info/" title="安全圈info" target="_blank">安全圈info</a><ul></ul><a href="http://source.tosimp.net/" title="Tosimp 资源站" target="_blank">Tosimp 资源站</a></div><div class="widget"><div class="widget-title"><i class="fa fa-external-music"> 音乐</i></div></div><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=371362&auto=1&height=66"></iframe><div class="widget"><div class="widget-title"><i class="fa fa-external-game"> 游戏</i></div><ul></ul><a href="/2048" title="2048小游戏" target="_blank">2048小游戏</a><ul></ul><a href="/tantanqiu" title="变色弹球跳台阶小游戏" target="_blank">变色弹球跳台阶小游戏</a></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//yfshare.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">Jack Wang Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=2.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=2.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=2.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?3890bdc1bfaccae9364479b65f36fbd2";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=2.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=2.0.0"></script></div></body></html>
<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Blog"><title>部署TLS k8s | Jack Wang Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">部署TLS k8s</h1><a id="logo" href="/.">Jack Wang Blog</a><p class="description">Goals determine what you are going to be</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa icon-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">部署TLS k8s</h1><div class="post-meta">Feb 23, 2018<span> | </span><span class="category"><a href="/categories/K8S/">K8S</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2018/02/23/部署TLS-k8s/" href="/2018/02/23/部署TLS-k8s/#disqus_thread" class="disqus-comment-count"></a><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#基础配置"><span class="toc-number">1.</span> <span class="toc-text">基础配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#环境说明"><span class="toc-number">2.</span> <span class="toc-text">环境说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建-CA-证书和秘钥"><span class="toc-number">3.</span> <span class="toc-text">创建 CA 证书和秘钥</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#安装-CFSSL"><span class="toc-number">3.1.</span> <span class="toc-text">安装 CFSSL</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#创建-CA-Certificate-Authority"><span class="toc-number">3.2.</span> <span class="toc-text">创建 CA (Certificate Authority)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#创建-CA-证书签名请求"><span class="toc-number">3.3.</span> <span class="toc-text">创建 CA 证书签名请求</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#生成-CA-证书和私钥"><span class="toc-number">3.4.</span> <span class="toc-text">生成 CA 证书和私钥</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#分发证书"><span class="toc-number">3.5.</span> <span class="toc-text">分发证书</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#部署高可用-etcd-集群"><span class="toc-number">4.</span> <span class="toc-text">部署高可用 etcd 集群</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#安装-Etcd"><span class="toc-number">4.1.</span> <span class="toc-text">安装 Etcd</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#创建-TLS-秘钥和证书"><span class="toc-number">4.2.</span> <span class="toc-text">创建 TLS 秘钥和证书</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#部署Flannel-网络"><span class="toc-number">5.</span> <span class="toc-text">部署Flannel 网络</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#创建-TLS-秘钥和证书-1"><span class="toc-number">5.1.</span> <span class="toc-text">创建 TLS 秘钥和证书</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#docker集成flanneld网络"><span class="toc-number">5.1.1.</span> <span class="toc-text">docker集成flanneld网络</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#部署-k8s-master-节点"><span class="toc-number">6.</span> <span class="toc-text">部署 k8s master 节点</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#创建-kubernetes-证书"><span class="toc-number">6.1.</span> <span class="toc-text">创建 kubernetes 证书</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#配置和启动-kube-apiserver"><span class="toc-number">6.2.</span> <span class="toc-text">配置和启动 kube-apiserver</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#配置和启动-kube-controller-manager"><span class="toc-number">6.3.</span> <span class="toc-text">配置和启动 kube-controller-manager</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#配置和启动-kube-scheduler"><span class="toc-number">6.4.</span> <span class="toc-text">配置和启动 kube-scheduler</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#部署-kubectl-client节点"><span class="toc-number">7.</span> <span class="toc-text">部署 kubectl client节点</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#创建-admin-证书"><span class="toc-number">7.1.</span> <span class="toc-text">创建 admin 证书</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#查看集群状态"><span class="toc-number">7.1.1.</span> <span class="toc-text">查看集群状态</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#部署-K8S-Node-节点"><span class="toc-number">8.</span> <span class="toc-text">部署 K8S Node 节点</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#安装和配置-kubelet"><span class="toc-number">8.1.</span> <span class="toc-text">安装和配置 kubelet</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Q-amp-A-master日志报RBAC-DENY-user-“kubelet-bootstrap”-groups错误"><span class="toc-number">8.1.1.</span> <span class="toc-text">Q&A master日志报RBAC DENY: user “kubelet-bootstrap” groups错误</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#通过-kubelet-的-TLS-证书请求"><span class="toc-number">8.2.</span> <span class="toc-text">通过 kubelet 的 TLS 证书请求</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#多个Node节点加入"><span class="toc-number">8.2.1.</span> <span class="toc-text">多个Node节点加入</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#配置-kube-proxy"><span class="toc-number">8.3.</span> <span class="toc-text">配置 kube-proxy</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#验证集群功能"><span class="toc-number">8.4.</span> <span class="toc-text">验证集群功能</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#部署-kubedns-插件"><span class="toc-number">9.</span> <span class="toc-text">部署 kubedns 插件</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#系统预定义的-RoleBinding"><span class="toc-number">9.1.</span> <span class="toc-text">系统预定义的 RoleBinding</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#配置-kube-dns-服务"><span class="toc-number">9.2.</span> <span class="toc-text">配置 kube-dns 服务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#创建nginx-服务测试dns"><span class="toc-number">9.3.</span> <span class="toc-text">创建nginx 服务测试dns</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#部署-heapster-插件"><span class="toc-number">10.</span> <span class="toc-text">部署 heapster 插件</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#配置rbac"><span class="toc-number">10.1.</span> <span class="toc-text">配置rbac</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#配置-influxdb-deployment"><span class="toc-number">10.2.</span> <span class="toc-text">配置 influxdb-deployment</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#配置-heapster-deployment"><span class="toc-number">10.3.</span> <span class="toc-text">配置 heapster-deployment</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#配置-grafana-deployment"><span class="toc-number">10.4.</span> <span class="toc-text">配置 grafana-deployment</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#访问grafana"><span class="toc-number">10.4.1.</span> <span class="toc-text">访问grafana</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#部署-dashboard-插件"><span class="toc-number">11.</span> <span class="toc-text">部署 dashboard 插件</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#访问dashboard"><span class="toc-number">11.1.</span> <span class="toc-text">访问dashboard</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#保存镜像"><span class="toc-number">11.2.</span> <span class="toc-text">保存镜像</span></a></li></ol></li></ol></div></div><div class="post-content"><script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>Kubernetes是一个开源的，用于管理云平台中多个主机上的容器化的应用，Kubernetes的目标是让部署容器化的应用简单并且高效(powerful)，Kubernetes提供了应用部署，规划，更新，维护的一种机制。Kubernetes一个核心的特点就是能够自主的管理容器来保证云平台中的容器按照用户的期望状态运行。<br><a id="more"></a><br>环境：<br>　　　Centos 7.4.1708<br>　　　dockers 18.02.0-ce-rc1<br>　　　kubernetes v1.9.2<br>　　　etcd 3.2.15  </p>
<p>k8s下载地址：<a href="https://github.com/kubernetes/kubernetes/releases" target="_blank" rel="external">https://github.com/kubernetes/kubernetes/releases</a><br><a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.9.md#v192" target="_blank" rel="external">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.9.md#v192</a>  </p>
<h4 id="基础配置"><a href="#基础配置" class="headerlink" title="基础配置"></a>基础配置</h4><p>同步时间，所有节点均操作<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime -a</span></div><div class="line"><span class="comment"># ntpdate s1a.time.edu.cn</span></div><div class="line"><span class="comment"># crontab -l</span></div><div class="line">* */3 * * * ntpdate s1a.time.edu.cn &amp;&gt; /dev/null</div><div class="line"><span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>设置主机名<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># hostname master1.example.com</span></div><div class="line">[root@master2 ~]<span class="comment"># hostname master2.example.com</span></div><div class="line">[root@master3 ~]<span class="comment"># hostname master3.example.com</span></div><div class="line">[root@node1 ~]<span class="comment"># hostname node1.example.com</span></div><div class="line">[root@node2 ~]<span class="comment"># hostname node2.example.com</span></div><div class="line"></div><div class="line"><span class="comment">#三个节点均做hosts解析</span></div><div class="line"><span class="comment"># tail -5 /etc/hosts</span></div><div class="line">192.168.1.195 master1.example.com master1</div><div class="line">192.168.1.196 master2.example.com master2</div><div class="line">192.168.1.197 master3.example.com master3</div><div class="line">192.168.1.198 node1.example.com node1</div><div class="line">192.168.1.199 node2.example.com node2</div><div class="line"><span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>关闭防火墙和Selinux，所有节点都操作<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">iptables -F</div><div class="line">systemctl stop firewalld</div><div class="line">systemctl <span class="built_in">disable</span> firewalld</div><div class="line">setenforce 0</div></pre></td></tr></table></figure></p>
<h4 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h4><table>
<thead>
<tr>
<th>角色</th>
<th>IP</th>
<th>组件</th>
</tr>
</thead>
<tbody>
<tr>
<td>Kube-Master + ETCD1</td>
<td>192.168.1.195</td>
<td>etcd、kube-apiserver、kube-controller-manager、kube-scheduler、Flannel</td>
</tr>
<tr>
<td>ETCD2</td>
<td>192.168.1.196</td>
<td>etcd</td>
</tr>
<tr>
<td>ETCD3</td>
<td>192.168.1.197</td>
<td>etcd</td>
</tr>
<tr>
<td>Kube-Node1</td>
<td>192.168.1.198</td>
<td>kubelet、kube-proxy、docker、Flannel</td>
</tr>
<tr>
<td>Kube-Node2</td>
<td>192.168.1.199</td>
<td>kubelet、kube-proxy、docker、Flannel</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>名称</th>
<th>网段/地址</th>
<th>参数</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>Service_CIDR</td>
<td>172.16.0.0/16</td>
<td><code>--service-cluster-ip-range</code></td>
<td>服务 网段</td>
</tr>
<tr>
<td>Cluster_CIDR</td>
<td>172.30.0.0/16</td>
<td><code>--cluster-cidr</code></td>
<td>POD 网段</td>
</tr>
<tr>
<td>CLUSTER_KUBERNETES_SVC_IP</td>
<td>172.16.0.1</td>
<td>-</td>
<td>kubernetes 服务IP，SERVICE_CIDR 中第一个IP</td>
</tr>
<tr>
<td>CLUSTER_DNS_SVC_IP</td>
<td>172.16.0.2</td>
<td>-</td>
<td>集群DNS 服务IP，SERVICE_CIDR 中第二个IP</td>
</tr>
<tr>
<td>NODE_PORT_RANGE</td>
<td>8400-9000</td>
<td>服务端口 范围</td>
</tr>
<tr>
<td>CLUSTER_DNS_DOMAIN</td>
<td>-</td>
<td><code>cluster.local.</code></td>
<td>集群DNS域名</td>
</tr>
<tr>
<td>FLANNEL_ETCD_PREFIX</td>
<td>-</td>
<td><code>/kubernetes/network</code></td>
<td>flanneld 网络配置前缀</td>
</tr>
</tbody>
</table>
<p>安装Docker<br>在node1/node2这2个节点都安装docker引擎<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">yum remove docker docker-common docker-selinux docker-engine -y</div><div class="line">yum install -y yum-utils device-mapper-persistent-data lvm2</div><div class="line">yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</div><div class="line">yum-config-manager --enable docker-ce-edge</div><div class="line">yum-config-manager --enable docker-ce-test</div><div class="line">yum install docker-ce -y</div><div class="line">systemctl <span class="built_in">enable</span> docker</div><div class="line">systemctl start docker</div></pre></td></tr></table></figure></p>
<h4 id="创建-CA-证书和秘钥"><a href="#创建-CA-证书和秘钥" class="headerlink" title="创建 CA 证书和秘钥"></a>创建 CA 证书和秘钥</h4><p>kubernetes 系统各组件需要使用 TLS 证书对通信进行加密，这里使用 CloudFlare 的 PKI 工具集 cfssl 来生成 Certificate Authority (CA) 证书和秘钥文件，CA 是自签名的证书，用来签名后续创建的其它 TLS 证书  </p>
<h5 id="安装-CFSSL"><a href="#安装-CFSSL" class="headerlink" title="安装 CFSSL"></a>安装 CFSSL</h5><p>cfssl下载地址：<a href="https://github.com/cloudflare/cfssl/releases" target="_blank" rel="external">https://github.com/cloudflare/cfssl/releases</a><br><a href="https://note.youdao.com/yws/api/personal/file/E9CE8AF7520D47F69337DCE8F6DBAC9E?method=download&amp;shareKey=240e513d965d3476e1aeaae363ca8689" target="_blank" rel="external">cfssl R1.2工具包本地下载</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -O /usr/local/bin/cfssl</span></div><div class="line">[root@master1 ~]<span class="comment"># wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -O /usr/local/bin/cfssljson</span></div><div class="line">[root@master1 ~]<span class="comment"># wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 -O /usr/local/bin/cfssl-certinfo</span></div><div class="line">[root@master1 ~]<span class="comment"># chmod +x /usr/local/bin/cfssl*</span></div><div class="line">[root@master1 ~]<span class="comment"># mkdir ssl &amp;&amp; cd ssl</span></div><div class="line"></div><div class="line"><span class="comment">#测试</span></div><div class="line">[root@master1 ssl]<span class="comment"># cfssl print-defaults config &gt; config.json</span></div><div class="line">[root@master1 ssl]<span class="comment"># cfssl print-defaults csr &gt; csr.json</span></div></pre></td></tr></table></figure></p>
<h5 id="创建-CA-Certificate-Authority"><a href="#创建-CA-Certificate-Authority" class="headerlink" title="创建 CA (Certificate Authority)"></a>创建 CA (Certificate Authority)</h5><table>
<thead>
<tr>
<th>证书名称</th>
<th>配置文件</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>ca.pem</td>
<td>ca-config.json</td>
<td>CA 配置文件</td>
</tr>
<tr>
<td>etcd.pem</td>
<td>ca-csr.json</td>
<td>CA 证书</td>
</tr>
</tbody>
</table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># cat ca-config.json </span></div><div class="line">&#123;</div><div class="line">  <span class="string">"signing"</span>: &#123;</div><div class="line">    <span class="string">"default"</span>: &#123;</div><div class="line">      <span class="string">"expiry"</span>: <span class="string">"8760h"</span></div><div class="line">    &#125;,</div><div class="line">    <span class="string">"profiles"</span>: &#123;</div><div class="line">      <span class="string">"kubernetes"</span>: &#123;</div><div class="line">        <span class="string">"usages"</span>: [</div><div class="line">            <span class="string">"signing"</span>,</div><div class="line">            <span class="string">"key encipherment"</span>,</div><div class="line">            <span class="string">"server auth"</span>,</div><div class="line">            <span class="string">"client auth"</span></div><div class="line">        ],</div><div class="line">        <span class="string">"expiry"</span>: <span class="string">"8760h"</span></div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">[root@master1 ssl]<span class="comment">#</span></div></pre></td></tr></table></figure>
<ul>
<li>ca-config.json：可以定义多个 profiles，分别指定不同的过期时间、使用场景等参数；后续在签名证书时使用某个 profile；</li>
<li>signing：表示该证书可用于签名其它证书；生成的 ca.pem 证书中 CA=TRUE；</li>
<li>server auth：表示 client 可以用该 CA 对 server 提供的证书进行验证；</li>
<li>client auth：表示 server 可以用该 CA 对 client 提供的证书进行验证；</li>
</ul>
<h5 id="创建-CA-证书签名请求"><a href="#创建-CA-证书签名请求" class="headerlink" title="创建 CA 证书签名请求"></a>创建 CA 证书签名请求</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># cat ca-csr.json </span></div><div class="line">&#123;</div><div class="line">  <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</div><div class="line">  <span class="string">"key"</span>: &#123;</div><div class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</div><div class="line">    <span class="string">"size"</span>: 2048</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"names"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</div><div class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</div><div class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line">[root@master1 ssl]<span class="comment">#</span></div></pre></td></tr></table></figure>
<ul>
<li>“CN”：Common Name，kube-apiserver 从证书中提取该字段作为请求的用户名 (User Name)；浏览器使用该字段验证网站是否合法；</li>
<li>“O”：Organization，kube-apiserver 从证书中提取该字段作为请求用户所属的组 (Group)；</li>
</ul>
<h5 id="生成-CA-证书和私钥"><a href="#生成-CA-证书和私钥" class="headerlink" title="生成 CA 证书和私钥"></a>生成 CA 证书和私钥</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># cfssl gencert -initca ca-csr.json | cfssljson -bare ca</span></div><div class="line"></div><div class="line">[root@master1 ssl]<span class="comment"># ls ca*</span></div><div class="line">ca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem</div><div class="line">[root@master1 ssl]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h5 id="分发证书"><a href="#分发证书" class="headerlink" title="分发证书"></a>分发证书</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># mkdir -p /etc/kubernetes/ssl</span></div><div class="line">[root@master1 ssl]<span class="comment"># cp ca* /etc/kubernetes/ssl</span></div><div class="line">[root@master1 ssl]<span class="comment"># ls /etc/kubernetes/ssl/</span></div><div class="line">ca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem</div><div class="line">[root@master1 ssl]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># ssh root@192.168.1.196 "mkdir -p /etc/kubernetes/ssl"</span></div><div class="line">[root@master1 ssl]<span class="comment"># scp /etc/kubernetes/ssl/ca* root@192.168.1.196:/etc/kubernetes/ssl/</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># ssh root@192.168.1.197 "mkdir -p /etc/kubernetes/ssl"</span></div><div class="line">[root@master1 ssl]<span class="comment"># scp /etc/kubernetes/ssl/ca* root@192.168.1.197:/etc/kubernetes/ssl/</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># ssh root@192.168.1.198 "mkdir -p /etc/kubernetes/ssl"</span></div><div class="line">[root@master1 ssl]<span class="comment"># scp /etc/kubernetes/ssl/ca* root@192.168.1.198:/etc/kubernetes/ssl/</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># ssh root@192.168.1.199 "mkdir -p /etc/kubernetes/ssl"</span></div><div class="line">[root@master1 ssl]<span class="comment"># scp /etc/kubernetes/ssl/ca* root@192.168.1.199:/etc/kubernetes/ssl/</span></div></pre></td></tr></table></figure>
<h4 id="部署高可用-etcd-集群"><a href="#部署高可用-etcd-集群" class="headerlink" title="部署高可用 etcd 集群"></a>部署高可用 etcd 集群</h4><p>需要关闭 selinux，关闭防火墙，ntpdate 时间同步<br>kuberntes 系统使用 etcd 存储所有数据，这里和kuberntes master安装到一起<br>三个etcd分别取名为：etcd1、etcd2、etcd3  </p>
<table>
<thead>
<tr>
<th>集群名称</th>
<th>IP</th>
<th>集群地址</th>
</tr>
</thead>
<tbody>
<tr>
<td>etcd1</td>
<td>192.168.1.195</td>
<td><a href="https://192.168.1.195:2379" target="_blank" rel="external">https://192.168.1.195:2379</a></td>
</tr>
<tr>
<td>etcd2</td>
<td>192.168.1.196</td>
<td><a href="https://192.168.1.196:2379" target="_blank" rel="external">https://192.168.1.196:2379</a></td>
</tr>
<tr>
<td>etcd3</td>
<td>192.168.1.197</td>
<td><a href="https://192.168.1.197:2379" target="_blank" rel="external">https://192.168.1.197:2379</a></td>
</tr>
</tbody>
</table>
<h5 id="安装-Etcd"><a href="#安装-Etcd" class="headerlink" title="安装 Etcd"></a>安装 Etcd</h5><p><strong>三个节点master均安装</strong><br>etcd下载地址：<a href="https://github.com/coreos/etcd/releases" target="_blank" rel="external">https://github.com/coreos/etcd/releases</a><br><a href="https://note.youdao.com/yws/api/personal/file/A48C40B53E5442D0A87D037CF9683155?method=download&amp;shareKey=1925129c3689f9cf58802e996e8103bb" target="_blank" rel="external">etcd-v3.2.15本地下载</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># wget https://github.com/coreos/etcd/releases/download/v3.2.15/etcd-v3.2.15-linux-amd64.tar.gz</span></div><div class="line">[root@master1 ~]<span class="comment"># tar -zxf etcd-v3.2.15-linux-amd64.tar.gz</span></div><div class="line">[root@master1 ~]<span class="comment"># cp -a etcd-v3.2.15-linux-amd64/etcd* /usr/local/bin/</span></div></pre></td></tr></table></figure></p>
<h5 id="创建-TLS-秘钥和证书"><a href="#创建-TLS-秘钥和证书" class="headerlink" title="创建 TLS 秘钥和证书"></a>创建 TLS 秘钥和证书</h5><p>为了保证通信安全，客户端(如 etcdctl) 与 etcd 集群、etcd 集群之间的通信需要使用 TLS 加密  </p>
<p>创建 etcd 证书签名请求<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># mkdir -p ssl/</span></div><div class="line">[root@master1 ~]<span class="comment"># cd ssl/</span></div><div class="line">[root@master1 ssl]<span class="comment"># cat etcd-csr.json </span></div><div class="line">&#123;</div><div class="line">  <span class="string">"CN"</span>: <span class="string">"etcd"</span>,</div><div class="line">  <span class="string">"hosts"</span>: [</div><div class="line">    <span class="string">"127.0.0.1"</span>,</div><div class="line">    <span class="string">"192.168.1.195"</span>,</div><div class="line">    <span class="string">"192.168.1.196"</span>,</div><div class="line">    <span class="string">"192.168.1.197"</span></div><div class="line">  ],</div><div class="line">  <span class="string">"key"</span>: &#123;</div><div class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</div><div class="line">    <span class="string">"size"</span>: 2048</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"names"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</div><div class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</div><div class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line">[root@master1 ssl]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<ul>
<li>hosts 字段指定授权使用该证书的 etcd 节点 IP</li>
</ul>
<p>生成 etcd 证书和私钥<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># cfssl gencert -ca=/etc/kubernetes/ssl/ca.pem -ca-key=/etc/kubernetes/ssl/ca-key.pem -config=/etc/kubernetes/ssl/ca-config.json -profile=kubernetes etcd-csr.json | cfssljson -bare etcd</span></div><div class="line">[root@master1 ssl]<span class="comment"># ls etcd*</span></div><div class="line">etcd.csr  etcd-csr.json  etcd-key.pem  etcd.pem</div><div class="line">[root@master1 ssl]<span class="comment"># mkdir -p /etc/etcd/ssl</span></div><div class="line">[root@master1 ssl]<span class="comment"># cp etcd*.pem /etc/etcd/ssl/</span></div></pre></td></tr></table></figure></p>
<p>创建 etcd 的 systemd unit 文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># mkdir -p /var/lib/etcd</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># cat etcd.service </span></div><div class="line">[Unit]</div><div class="line">Description=Etcd Server</div><div class="line">After=network.target</div><div class="line">After=network-online.target</div><div class="line">Wants=network-online.target</div><div class="line">Documentation=https://github.com/coreos</div><div class="line"></div><div class="line">[Service]</div><div class="line">Type=notify</div><div class="line">WorkingDirectory=/var/lib/etcd/</div><div class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/etcd \</div><div class="line">  --name=etcd1 \</div><div class="line">  --cert-file=/etc/etcd/ssl/etcd.pem \</div><div class="line">  --key-file=/etc/etcd/ssl/etcd-key.pem \</div><div class="line">  --peer-cert-file=/etc/etcd/ssl/etcd.pem \</div><div class="line">  --peer-key-file=/etc/etcd/ssl/etcd-key.pem \</div><div class="line">  --trusted-ca-file=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  --peer-trusted-ca-file=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  --initial-advertise-peer-urls=https://192.168.1.195:2380 \</div><div class="line">  --listen-peer-urls=https://192.168.1.195:2380 \</div><div class="line">  --listen-client-urls=https://192.168.1.195:2379,http://127.0.0.1:2379 \</div><div class="line">  --advertise-client-urls=https://192.168.1.195:2379 \</div><div class="line">  --initial-cluster-token=etcd-cluster-0 \</div><div class="line">  --initial-cluster=etcd1=https://192.168.1.195:2380,etcd2=https://192.168.1.196:2380,etcd3=https://192.168.1.197:2380 \</div><div class="line">  --initial-cluster-state=new \</div><div class="line">  --data-dir=/var/lib/etcd</div><div class="line">Restart=on-failure</div><div class="line">RestartSec=5</div><div class="line">LimitNOFILE=65536</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<ul>
<li>指定 etcd 的工作目录和数据目录为<code>/var/lib/etcd</code>，需在启动服务前创建这个目录</li>
<li><code>--name</code>为当前etcd的名称，<strong>每个etcd节点名字不能相同</strong></li>
<li><code>--initial-advertise-peer-urls</code>，<code>--listen-peer-urls</code>，<code>--listen-client-urls</code>，<code>--advertise-client-urls</code>这四个参数需要修改为<strong>当前节点的IP地址</strong>  </li>
<li><code>--initial-cluster</code>参数为，etcd集群所有节点的IP地址</li>
<li>为了保证通信安全，需要指定 etcd 的公私钥(<code>cert-file</code>和<code>key-file</code>)、Peers 通信的公私钥和 CA 证书(<code>peer-cert-file</code>、<code>peer-key-file</code>、<code>peer-trusted-ca-file</code>)、客户端的CA证书（<code>trusted-ca-file</code>）</li>
<li><code>--initial-cluster-state</code>值为 new 时，<code>--name</code> 的参数值必须位于 <code>--initial-cluster</code> 列表中</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># mv etcd.service /etc/systemd/system/</span></div></pre></td></tr></table></figure>
<p>分发etcd证书<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># ssh root@192.168.1.196 "mkdir -p /var/lib/etcd"</span></div><div class="line">[root@master1 ~]<span class="comment"># ssh root@192.168.1.196 "mkdir -p /etc/etcd/ssl"</span></div><div class="line">[root@master1 ~]<span class="comment"># scp /etc/etcd/ssl/etcd* root@192.168.1.196:/etc/etcd/ssl/</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># ssh root@192.168.1.197 "mkdir -p /var/lib/etcd"</span></div><div class="line">[root@master1 ~]<span class="comment"># ssh root@192.168.1.197 "mkdir -p /etc/etcd/ssl"</span></div><div class="line">[root@master1 ~]<span class="comment"># scp /etc/etcd/ssl/etcd* root@192.168.1.197:/etc/etcd/ssl/</span></div></pre></td></tr></table></figure>
<p>分发etcd.service<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># scp /etc/systemd/system/etcd.service root@192.168.1.196:/etc/systemd/system/</span></div><div class="line">[root@master1 ~]<span class="comment"># scp /etc/systemd/system/etcd.service root@192.168.1.197:/etc/systemd/system/</span></div></pre></td></tr></table></figure></p>
<p>启动 etcd 服务<br>依次启动所有节点的etcd服务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">systemctl daemon-reload</div><div class="line">systemctl <span class="built_in">enable</span> etcd</div><div class="line">systemctl start etcd</div></pre></td></tr></table></figure></p>
<ul>
<li>最先启动的 etcd 进程会卡住一段时间，再等待其它节点上的 etcd 进程加入集群，这是正常现象</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># export ETCDCTL_API=3</span></div><div class="line">[root@master1 ~]<span class="comment"># etcdctl --cacert=/etc/kubernetes/ssl/ca.pem --cert=/etc/etcd/ssl/etcd.pem --key=/etc/etcd/ssl/etcd-key.pem --endpoints=https://192.168.1.195:2379,https://192.168.1.196:2379,https://192.168.1.197:2379 endpoint health</span></div><div class="line">https://192.168.1.197:2379 is healthy: successfully committed proposal: took = 1.631081ms</div><div class="line">https://192.168.1.195:2379 is healthy: successfully committed proposal: took = 1.187637ms</div><div class="line">https://192.168.1.196:2379 is healthy: successfully committed proposal: took = 1.461928ms</div></pre></td></tr></table></figure>
<h4 id="部署Flannel-网络"><a href="#部署Flannel-网络" class="headerlink" title="部署Flannel 网络"></a>部署Flannel 网络</h4><p>Flannel是 CoreOS 团队针对 Kubernetes 设计的一个覆盖网络（Overlay Network）工具，其目的在于帮助每一个使用 Kuberentes 的 CoreOS 主机拥有一个完整的子网。简单来说，它的功能是让集群中的不同节点主机创建的Docker容器都具有全集群唯一的虚拟IP地址，因为在默认的Docker配置中，每个节点上的Docker服务会分别负责所在节点容器的IP分配。这样会导致一个问题，不同节点上容器可能获得相同的内外IP地址。Flannel的设计目的就是为集群中的所有节点重新规划IP地址的使用规则，从而使得不同节点上的容器能够获得“同属一个内网”且”不重复的”IP地址，并让属于不同节点上的容器能够直接通过内网IP通信。   </p>
<p>Flannel通过Etcd服务维护了一张节点间的路由表<br>参考：<a href="http://dockone.io/article/618" target="_blank" rel="external">http://dockone.io/article/618</a>  </p>
<p>flannel下载地址：<a href="https://github.com/coreos/flannel/releases" target="_blank" rel="external">https://github.com/coreos/flannel/releases</a><br><a href="https://note.youdao.com/yws/api/personal/file/5447ED8CA54D48EF86FB0668FDE54DFF?method=download&amp;shareKey=a9a38141e456fc88a678fdc1309a3dc9" target="_blank" rel="external">flannel-v0.10.0本地下载</a>  </p>
<table>
<thead>
<tr>
<th>节点名称</th>
<th>节点IP</th>
<th>分配地址</th>
</tr>
</thead>
<tbody>
<tr>
<td>node1</td>
<td>192.168.1.198</td>
<td>172.30.57.0</td>
</tr>
<tr>
<td>node2</td>
<td>192.168.1.199</td>
<td>172.30.41.0</td>
</tr>
</tbody>
</table>
<p>在安装有cfssl工具的服务器上操作  </p>
<h5 id="创建-TLS-秘钥和证书-1"><a href="#创建-TLS-秘钥和证书-1" class="headerlink" title="创建 TLS 秘钥和证书"></a>创建 TLS 秘钥和证书</h5><p>etcd 集群启用了双向 TLS 认证，所以需要为 flanneld 指定与 etcd 集群通信的 CA 和秘钥  </p>
<p>创建 CA 配置文件<br>创建 flanneld 证书签名请求<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># cat flanneld-csr.json </span></div><div class="line">&#123;</div><div class="line">  <span class="string">"CN"</span>: <span class="string">"flanneld"</span>,</div><div class="line">  <span class="string">"hosts"</span>: [],</div><div class="line">  <span class="string">"key"</span>: &#123;</div><div class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</div><div class="line">    <span class="string">"size"</span>: 2048</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"names"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</div><div class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</div><div class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line">[root@master1 ssl]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<ul>
<li>hosts 字段为空  </li>
</ul>
<p>生成 flanneld 证书和私钥<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># cfssl gencert -ca=/etc/kubernetes/ssl/ca.pem -ca-key=/etc/kubernetes/ssl/ca-key.pem -config=/etc/kubernetes/ssl/ca-config.json -profile=kubernetes flanneld-csr.json | cfssljson -bare flanneld</span></div><div class="line">[root@master1 ssl]<span class="comment"># ls flanneld*</span></div><div class="line">flanneld.csr  flanneld-csr.json  flanneld-key.pem  flanneld.pem</div><div class="line">[root@master1 ssl]<span class="comment"># mkdir -p /etc/flanneld/ssl</span></div><div class="line">[root@master1 ssl]<span class="comment"># cp -a flanneld*.pem /etc/flanneld/ssl</span></div></pre></td></tr></table></figure></p>
<p>分发flanneld证书<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># ssh root@192.168.1.198 "mkdir -p /etc/flanneld/ssl"</span></div><div class="line">[root@master1 ssl]<span class="comment"># scp /etc/flanneld/ssl/flanneld* root@192.168.1.198:/etc/flanneld/ssl/</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># ssh root@192.168.1.199 "mkdir -p /etc/flanneld/ssl"</span></div><div class="line">[root@master1 ssl]<span class="comment"># scp /etc/flanneld/ssl/flanneld* root@192.168.1.199:/etc/flanneld/ssl/</span></div></pre></td></tr></table></figure>
<p>向 etcd 写入集群 Pod 网段信息<br>使用 etcd v2 API 写入配置<br>前面执行了<code>export ETCDCTL_API=3</code>，这个命令会调用<code>etcd v3 API</code>，所以需要重新打开一个xshell窗口，否则会报错<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># etcdctl --endpoints=https://192.168.1.195:2379,https://192.168.1.195:2379,https://192.168.1.195:2379 --ca-file=/etc/kubernetes/ssl/ca.pem --cert-file=/etc/flanneld/ssl/flanneld.pem --key-file=/etc/flanneld/ssl/flanneld-key.pem set /kubernetes/network/config '&#123;"Network":"'172.30.0.0/16'", "SubnetLen": 24, "Backend": &#123;"Type": "vxlan"&#125;&#125;'</span></div><div class="line">&#123;<span class="string">"Network"</span>:<span class="string">"172.30.0.0/16"</span>, <span class="string">"SubnetLen"</span>: 24, <span class="string">"Backend"</span>: &#123;<span class="string">"Type"</span>: <span class="string">"vxlan"</span>&#125;&#125;</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#查看POD网段信息</span></div><div class="line">[root@master1 ~]<span class="comment"># etcdctl --endpoints=https://192.168.1.195:2379,https://192.168.1.195:2379,https://192.168.1.195:2379 --ca-file=/etc/kubernetes/ssl/ca.pem --cert-file=/etc/flanneld/ssl/flanneld.pem --key-file=/etc/flanneld/ssl/flanneld-key.pem get /kubernetes/network/config</span></div><div class="line">&#123;<span class="string">"Network"</span>:<span class="string">"172.30.0.0/16"</span>, <span class="string">"SubnetLen"</span>: 24, <span class="string">"Backend"</span>: &#123;<span class="string">"Type"</span>: <span class="string">"vxlan"</span>&#125;&#125;</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>安装和配置 flanneld<br>在node1/node2节点安装，master不安装flannel<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># wget https://github.com/coreos/flannel/releases/download/v0.10.0/flannel-v0.10.0-linux-amd64.tar.gz</span></div><div class="line">[root@node1 ~]<span class="comment"># mkdir flannel</span></div><div class="line">[root@node1 ~]<span class="comment"># tar -zxf flannel-v0.10.0-linux-amd64.tar.gz -C flannel</span></div><div class="line">[root@node1 ~]<span class="comment"># cp -a flannel/&#123;flanneld,mk-docker-opts.sh&#125; /usr/local/bin/</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># cat flanneld.service </span></div><div class="line">[Unit]</div><div class="line">Description=Flanneld overlay address etcd agent</div><div class="line">After=network.target</div><div class="line">After=network-online.target</div><div class="line">Wants=network-online.target</div><div class="line">After=etcd.service</div><div class="line">Before=docker.service</div><div class="line"></div><div class="line">[Service]</div><div class="line">Type=notify</div><div class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/flanneld \</div><div class="line">  -etcd-cafile=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  -etcd-certfile=/etc/flanneld/ssl/flanneld.pem \</div><div class="line">  -etcd-keyfile=/etc/flanneld/ssl/flanneld-key.pem \</div><div class="line">  -etcd-endpoints=https://192.168.1.195:2379,https://192.168.1.195:2379,https://192.168.1.195:2379 \</div><div class="line">  -etcd-prefix=/kubernetes/network</div><div class="line">ExecStartPost=/usr/<span class="built_in">local</span>/bin/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS <span class="_">-d</span> /run/flannel/docker</div><div class="line">Restart=on-failure</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div><div class="line">RequiredBy=docker.service</div><div class="line">[root@node1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<ul>
<li>mk-docker-opts.sh脚本将分配给 flanneld 的 Pod 子网网段信息写入到 /run/flannel/docker 文件中，后续 docker 启动时使用这个文件中参数值设置 docker0 网桥；</li>
<li>flanneld 使用系统缺省路由所在的接口和其它节点通信，对于有多个网络接口的机器（如，内网和公网），可以用 –iface 选项值指定通信接口(上面的 systemd unit 文件没指定这个选项)，如本着 Vagrant + Virtualbox，就要指定–iface=enp0s8；</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># cp flanneld.service /etc/systemd/system/</span></div></pre></td></tr></table></figure>
<p>启动 flanneld<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">systemctl daemon-reload</div><div class="line">systemctl <span class="built_in">enable</span> flanneld</div><div class="line">systemctl start flanneld</div></pre></td></tr></table></figure></p>
<h6 id="docker集成flanneld网络"><a href="#docker集成flanneld网络" class="headerlink" title="docker集成flanneld网络"></a>docker集成flanneld网络</h6><p>让docker0网卡使用flanneld网络网段地址<br><a href="https://note.youdao.com/yws/api/personal/file/2137351870BB4393A12F4BEC6388DA44?method=download&amp;shareKey=c2e7067c0a4236332b684c8de6881018" target="_blank" rel="external">docker.service-yum</a>安装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># grep -iv '#' /usr/lib/systemd/system/docker.service</span></div><div class="line">[Unit]</div><div class="line">Description=Docker Application Container Engine</div><div class="line">Documentation=https://docs.docker.com</div><div class="line">After=network-online.target firewalld.service</div><div class="line">Wants=network-online.target</div><div class="line"></div><div class="line">[Service]</div><div class="line">Type=notify</div><div class="line"></div><div class="line"><span class="comment">#新增下面两个参数</span></div><div class="line">ExecStart=/usr/bin/dockerd <span class="variable">$DOCKER_NETWORK_OPTIONS</span></div><div class="line">EnvironmentFile=/run/flannel/docker</div><div class="line"></div><div class="line">ExecReload=/bin/<span class="built_in">kill</span> <span class="_">-s</span> HUP <span class="variable">$MAINPID</span></div><div class="line">LimitNOFILE=infinity</div><div class="line">LimitNPROC=infinity</div><div class="line">LimitCORE=infinity</div><div class="line">TimeoutStartSec=0</div><div class="line">Delegate=yes</div><div class="line">KillMode=process</div><div class="line">Restart=on-failure</div><div class="line">StartLimitBurst=3</div><div class="line">StartLimitInterval=60s</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div><div class="line">[root@node1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># systemctl restart docker</span></div></pre></td></tr></table></figure>
<p>检查 flanneld 服务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># ifconfig flannel.1</span></div><div class="line">flannel.1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1450</div><div class="line">        inet 172.30.57.0  netmask 255.255.255.255  broadcast 0.0.0.0</div><div class="line">        inet6 fe80::7890:e0ff:fe20:836e  prefixlen 64  scopeid 0x20&lt;link&gt;</div><div class="line">        ether 7a:90:e0:20:83:6e  txqueuelen 0  (Ethernet)</div><div class="line">        RX packets 0  bytes 0 (0.0 B)</div><div class="line">        RX errors 0  dropped 0  overruns 0  frame 0</div><div class="line">        TX packets 0  bytes 0 (0.0 B)</div><div class="line">        TX errors 0  dropped 8 overruns 0  carrier 0  collisions 0</div><div class="line"></div><div class="line">[root@node1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<ul>
<li>其他节点安装flanneld同上</li>
</ul>
<p>检查分配给各 flanneld 的 Pod 网段信息<br>查看集群 Pod 网段(/16)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># etcdctl --endpoints=https://192.168.1.195:2379,https://192.168.1.195:2379,https://192.168.1.195:2379 --ca-file=/etc/kubernetes/ssl/ca.pem --cert-file=/etc/flanneld/ssl/flanneld.pem --key-file=/etc/flanneld/ssl/flanneld-key.pem get /kubernetes/network/config</span></div><div class="line">&#123;<span class="string">"Network"</span>:<span class="string">"172.30.0.0/16"</span>, <span class="string">"SubnetLen"</span>: 24, <span class="string">"Backend"</span>: &#123;<span class="string">"Type"</span>: <span class="string">"vxlan"</span>&#125;&#125;</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>查看已分配的 Pod 子网段列表(/24)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># etcdctl --endpoints=https://192.168.1.195:2379,https://192.168.1.195:2379,https://192.168.1.195:2379 --ca-file=/etc/kubernetes/ssl/ca.pem --cert-file=/etc/flanneld/ssl/flanneld.pem --key-file=/etc/flanneld/ssl/flanneld-key.pem ls /kubernetes/network/subnets</span></div><div class="line">/kubernetes/network/subnets/172.30.57.0-24</div></pre></td></tr></table></figure></p>
<p>查看某一 Pod 网段对应的 flanneld 进程监听的 IP 和网络参数<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># etcdctl --endpoints=https://192.168.1.195:2379,https://192.168.1.195:2379,https://192.168.1.195:2379 --ca-file=/etc/kubernetes/ssl/ca.pem --cert-file=/etc</span></div><div class="line">/flanneld/ssl/flanneld.pem --key-file=/etc/flanneld/ssl/flanneld-key.pem get /kubernetes/network/subnets/172.30.57.0-24</div><div class="line">&#123;<span class="string">"PublicIP"</span>:<span class="string">"192.168.1.198"</span>,<span class="string">"BackendType"</span>:<span class="string">"vxlan"</span>,<span class="string">"BackendData"</span>:&#123;<span class="string">"VtepMAC"</span>:<span class="string">"7a:90:e0:20:83:6e"</span>&#125;&#125;</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>确保各节点间 Pod 网段能互联互通<br>在各节点上部署完 Flannel 后，查看已分配的 Pod 子网段列表(/24)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># etcdctl --endpoints=https://192.168.1.195:2379,https://192.168.1.195:2379,https://192.168.1.195:2379 --ca-file=/etc/kubernetes/ssl/ca.pem --cert-file=/etc/flanneld/ssl/flanneld.pem --key-file=/etc/flanneld/ssl/flanneld-key.pem ls /kubernetes/network/subnets</span></div><div class="line">/kubernetes/network/subnets/172.30.41.0-24</div><div class="line">/kubernetes/network/subnets/172.30.57.0-24</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>当前两个节点分配的 Pod 网段分别是：172.30.42.0-24、172.30.100.0-24<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># ip a | egrep -i 'docker0|flannel.1'</span></div><div class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN </div><div class="line">    inet 172.30.57.1/24 brd 172.30.57.255 scope global docker0</div><div class="line">4: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN </div><div class="line">    inet 172.30.57.0/32 scope global flannel.1</div><div class="line">[root@node1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@node2 ~]<span class="comment"># ip a | egrep -i 'docker0|flannel.1'</span></div><div class="line">3: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN </div><div class="line">    inet 172.30.42.0/32 scope global flannel.1</div><div class="line">4: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN </div><div class="line">    inet 172.30.42.1/24 brd 172.30.41.255 scope global docker0</div><div class="line">[root@node2 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>在各节点上分配 ping 这两个网段的网关地址，确保能通<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># ping 172.30.57.0 -c 4</span></div><div class="line">[root@node1 ~]<span class="comment"># ping 172.30.42.0 -c 4</span></div></pre></td></tr></table></figure></p>
<h4 id="部署-k8s-master-节点"><a href="#部署-k8s-master-节点" class="headerlink" title="部署 k8s master 节点"></a>部署 k8s master 节点</h4><p>kubernetes master 节点包含的组件:  </p>
<ul>
<li>kube-apiserver</li>
<li>kube-scheduler</li>
<li>kube-controller-manager</li>
</ul>
<p>这三个组件需要部署在同一台机器上  </p>
<ul>
<li><code>kube-scheduler</code>、<code>kube-controller-manager</code> 和 <code>kube-apiserver</code> 三者的功能紧密相关；</li>
<li>同时只能有一个 <code>kube-scheduler</code>、<code>kube-controller-manager</code> 进程处于工作状态，如果运行多个，则需要通过选举产生一个 leader；</li>
</ul>
<p>kubernetes发布版 tarball(下载脚本) 下载地址：<a href="https://github.com/kubernetes/kubernetes/releases" target="_blank" rel="external">https://github.com/kubernetes/kubernetes/releases</a><br>kubernetes CHANGELOG(server/client) 下载地址：<a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG.md" target="_blank" rel="external">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG.md</a>  </p>
<table>
<thead>
<tr>
<th>Service</th>
<th>通讯地址</th>
</tr>
</thead>
<tbody>
<tr>
<td>kube-apiserver</td>
<td>192.168.1.195:6443</td>
</tr>
<tr>
<td>kube-controll</td>
<td>127.0.0.1:10252</td>
</tr>
<tr>
<td>kube-schedule</td>
<td>127.0.0.1:10251</td>
</tr>
</tbody>
</table>
<p><a href="https://pan.baidu.com/s/1sngFMlZ" target="_blank" rel="external">百度网盘packages目录，密码：nwzk</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># wget https://dl.k8s.io/v1.9.2/kubernetes-server-linux-amd64.tar.gz -O kubernetes-server-linux-amd64-v1.9.2.tar.gz</span></div><div class="line">[root@master1 ~]<span class="comment"># tar -zxf kubernetes-server-linux-amd64-v1.9.2.tar.gz</span></div><div class="line">[root@master1 ~]<span class="comment"># cd kubernetes</span></div><div class="line">[root@master1 kubernetes]<span class="comment"># tar -zxf kubernetes-src.tar.gz </span></div><div class="line">[root@master1 kubernetes]<span class="comment"># cp -r server/bin/&#123;kube-apiserver,kube-controller-manager,kube-scheduler,kubectl,kube-proxy,kubelet&#125; /usr/local/bin/</span></div></pre></td></tr></table></figure></p>
<h5 id="创建-kubernetes-证书"><a href="#创建-kubernetes-证书" class="headerlink" title="创建 kubernetes 证书"></a>创建 kubernetes 证书</h5><p>创建 kubernetes 证书签名请求<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># cd ~/ssl/</span></div><div class="line">[root@master1 ssl]<span class="comment"># cat kubernetes-csr.json</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</div><div class="line">  <span class="string">"hosts"</span>: [</div><div class="line">    <span class="string">"127.0.0.1"</span>,</div><div class="line">    <span class="string">"192.168.1.195"</span>,</div><div class="line">    <span class="string">"172.16.0.1"</span>,</div><div class="line">    <span class="string">"kubernetes"</span>,</div><div class="line">    <span class="string">"kubernetes.default"</span>,</div><div class="line">    <span class="string">"kubernetes.default.svc"</span>,</div><div class="line">    <span class="string">"kubernetes.default.svc.cluster"</span>,</div><div class="line">    <span class="string">"kubernetes.default.svc.cluster.local"</span></div><div class="line">  ],</div><div class="line">  <span class="string">"key"</span>: &#123;</div><div class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</div><div class="line">    <span class="string">"size"</span>: 2048</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"names"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</div><div class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</div><div class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line">[root@master1 ssl]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<ul>
<li><code>192.168.1.195</code>为当前部署的 master 机器 IP  </li>
<li><code>172.16.0.1</code>kubernetes 服务 IP (预分配，一般是 SERVICE_CIDR 中第一个IP)  </li>
<li>如果 hosts 字段不为空则需要指定授权使用该证书的 IP 或域名列表，所以上面分别指定了当前部署的 master 节点主机 IP；  </li>
<li>还需要添加 kube-apiserver 注册的名为 kubernetes 的服务 IP (Service Cluster IP)，一般是 kube-apiserver –service-cluster-ip-range 选项值指定的网段的第一个IP，如 “172.16.0.1”；  </li>
</ul>
<p>生成 kubernetes 证书和私钥<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># cd ssl/</span></div><div class="line">[root@master1 ssl]<span class="comment"># cfssl gencert -ca=/etc/kubernetes/ssl/ca.pem -ca-key=/etc/kubernetes/ssl/ca-key.pem -config=/etc/kubernetes/ssl/ca-config.json -profile=kubernetes kubernetes-csr.json | cfssljson -bare kubernetes</span></div><div class="line">[root@master1 ssl]<span class="comment"># ls kubernetes*</span></div><div class="line">kubernetes.csr  kubernetes-csr.json  kubernetes-key.pem  kubernetes.pem</div><div class="line">[root@master1 ssl]<span class="comment"># mkdir -p /etc/kubernetes/ssl/</span></div><div class="line">[root@master1 ssl]<span class="comment"># mv kubernetes*.pem /etc/kubernetes/ssl/</span></div></pre></td></tr></table></figure></p>
<h5 id="配置和启动-kube-apiserver"><a href="#配置和启动-kube-apiserver" class="headerlink" title="配置和启动 kube-apiserver"></a>配置和启动 kube-apiserver</h5><p>创建 kube-apiserver 使用的客户端 token 文件<br>kubelet 首次启动时向 kube-apiserver 发送 TLS Bootstrapping 请求，kube-apiserver 验证 kubelet 请求中的 token 是否与它配置的 token.csv 一致，如果一致则自动为 kubelet生成证书和秘钥<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#生成TLS Bootstrapping 使用的 Token</span></div><div class="line">[root@master1 ~]<span class="comment"># head -c 16 /dev/urandom | od -An -t x | tr -d ' '</span></div><div class="line">6240b18d950d086ff9eb596e215d243f</div><div class="line">[root@master1 ssl]<span class="comment"># cat token.csv </span></div><div class="line">6240b18d950d086ff9eb596e215d243f,kubelet-bootstrap,10001,<span class="string">"system:kubelet-bootstrap"</span></div><div class="line">[root@master1 ssl]<span class="comment"># mv token.csv /etc/kubernetes/</span></div><div class="line">[root@master1 ssl]<span class="comment"># cat basic-auth.csv </span></div><div class="line">admin,admin@123,1</div><div class="line"><span class="built_in">readonly</span>,<span class="built_in">readonly</span>,2</div><div class="line">[root@master1 ssl]<span class="comment"># mv basic-auth.csv /etc/kubernetes/</span></div></pre></td></tr></table></figure></p>
<p>创建 kube-apiserver 的 systemd unit 文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># cat kube-apiserver.service </span></div><div class="line">[Unit]</div><div class="line">Description=Kubernetes API Server</div><div class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line">After=network.target</div><div class="line"></div><div class="line">[Service]</div><div class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/kube-apiserver \</div><div class="line">  --admission-control=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota \</div><div class="line">  --advertise-address=192.168.1.195 \</div><div class="line">  --bind-address=192.168.1.195 \</div><div class="line">  --insecure-bind-address=192.168.1.195 \</div><div class="line">  --authorization-mode=RBAC \</div><div class="line">  --runtime-config=rbac.authorization.k8s.io/v1alpha1 \</div><div class="line">  --kubelet-https=<span class="literal">true</span> \</div><div class="line">  --token-auth-file=/etc/kubernetes/token.csv \</div><div class="line">  --service-cluster-ip-range=172.16.0.0/16 \</div><div class="line">  --service-node-port-range=8400-9000 \</div><div class="line">  --tls-cert-file=/etc/kubernetes/ssl/kubernetes.pem \</div><div class="line">  --tls-private-key-file=/etc/kubernetes/ssl/kubernetes-key.pem \</div><div class="line">  --client-ca-file=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  --service-account-key-file=/etc/kubernetes/ssl/ca-key.pem \</div><div class="line">  --etcd-cafile=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  --etcd-certfile=/etc/kubernetes/ssl/kubernetes.pem \</div><div class="line">  --etcd-keyfile=/etc/kubernetes/ssl/kubernetes-key.pem \</div><div class="line">  --etcd-servers=https://192.168.1.195:2379,https://192.168.1.196:2379,https://192.168.1.197:2379 \</div><div class="line">  --enable-swagger-ui=<span class="literal">true</span> \</div><div class="line">  --allow-privileged=<span class="literal">true</span> \</div><div class="line">  --apiserver-count=3 \</div><div class="line">  --audit-log-maxage=30 \</div><div class="line">  --audit-log-maxbackup=3 \</div><div class="line">  --audit-log-maxsize=100 \</div><div class="line">  --audit-log-path=/var/lib/audit.log \</div><div class="line">  --event-ttl=1h \</div><div class="line">  --v=2</div><div class="line">Restart=on-failure</div><div class="line">RestartSec=5</div><div class="line">Type=notify</div><div class="line">LimitNOFILE=65536</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div><div class="line">[root@master1 ssl]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<ul>
<li><code>--bind-address=192.168.1.195</code>为当前部署的 master 机器 IP，但不能为 <code>127.0.0.1</code>  </li>
<li><code>--insecure-bind-address=192.168.1.195</code>为当前部署的 master 机器 IP  </li>
<li><code>--service-cluster-ip-range</code> 指定 Service Cluster IP 地址段，该地址段不能路由可达  </li>
<li><code>--service-node-port-range=&quot;8400-9000&quot;</code> 指定 NodePort 的端口范围  </li>
<li><code>--etcd-servers=&quot;https://192.168.1.195:2379,https://192.168.1.195:2379,https://192.168.1.195:2379&quot;</code>为etcd 集群服务地址列表  </li>
<li>kube-apiserver 1.6 版本开始使用 etcd v3 API 和存储格式  </li>
<li><code>--authorization-mode=RBAC</code> 指定在安全端口使用 RBAC 授权模式，拒绝未通过授权的请求  </li>
<li>kube-scheduler、kube-controller-manager 一般和 kube-apiserver 部署在同一台机器上，它们使用非安全端口和 kube-apiserver通信  </li>
<li>kube-proxy、kubectl 通过在使用的证书里指定相关的 User、Group 来达到通过 RBAC 授权的目的  </li>
<li>如果使用了 kubelet TLS Boostrap 机制，则不能再指定<code>--kubelet-certificate-authority</code>，<code>--kubelet-client-certificate</code>和<code>--kubelet-client-key</code>选项，否则后续 kube-apiserver 校验 kubelet 证书时出现 ”x509: certificate signed by unknown authority“ 错误  </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># cp -a kube-apiserver.service /etc/systemd/system/</span></div></pre></td></tr></table></figure>
<p>启动kube-apiserver<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># systemctl daemon-reload</span></div><div class="line">[root@master1 ~]<span class="comment"># systemctl enable kube-apiserver</span></div><div class="line">[root@master1 ~]<span class="comment"># systemctl start kube-apiserver</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># netstat -tunlp |grep kube-apiserve</span></div><div class="line">tcp        0      0 192.168.1.195:6443      0.0.0.0:*               LISTEN      19206/kube-apiserve </div><div class="line">tcp        0      0 192.168.1.195:8080      0.0.0.0:*               LISTEN      19206/kube-apiserve </div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#不能有任何报错</span></div><div class="line">[root@master1 ~]<span class="comment"># systemctl status kube-apiserver</span></div><div class="line">● kube-apiserver.service - Kubernetes API Server</div><div class="line">   Loaded: loaded (/etc/systemd/system/kube-apiserver.service; enabled; vendor preset: disabled)</div><div class="line">   Active: active (running) since Mon 2018-01-29 10:53:14 CST; 15min ago</div><div class="line">     Docs: https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line"> Main PID: 19206 (kube-apiserver)</div><div class="line">   CGroup: /system.slice/kube-apiserver.service</div><div class="line">           └─19206 /usr/<span class="built_in">local</span>/bin/kube-apiserver --admission-control=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota --advertise-address=...</div><div class="line"></div><div class="line">Jan 29 11:08:14 master1.example.com kube-apiserver[19206]: I0129 11:08:14.947346   19206 wrap.go:42] PUT /apis/apiregistration.k8s.io/v1beta1/apiservices/v1beta...95:42960]</div><div class="line">Jan 29 11:08:14 master1.example.com kube-apiserver[19206]: I0129 11:08:14.947470   19206 wrap.go:42] PUT /apis/apiregistration.k8s.io/v1beta1/apiservices/v1beta...95:42960]</div><div class="line">Jan 29 11:08:14 master1.example.com kube-apiserver[19206]: I0129 11:08:14.948643   19206 wrap.go:42] PUT /apis/apiregistration.k8s.io/v1beta1/apiservices/v1beta...95:42960]</div><div class="line">Jan 29 11:08:14 master1.example.com kube-apiserver[19206]: I0129 11:08:14.997905   19206 wrap.go:42] GET /api/v1/services: (1.191044ms) 200 [[kube-apiserver/v1....95:42960]</div><div class="line">Jan 29 11:08:15 master1.example.com kube-apiserver[19206]: I0129 11:08:15.003220   19206 wrap.go:42] GET /api/v1/services: (1.016741ms) 200 [[kube-apiserver/v1....95:42960]</div><div class="line">Jan 29 11:08:15 master1.example.com kube-apiserver[19206]: I0129 11:08:15.054109   19206 wrap.go:42] GET /api/v1/namespaces/kube-system: (1.388292ms) 200 [[kube...95:42960]</div><div class="line">Jan 29 11:08:15 master1.example.com kube-apiserver[19206]: I0129 11:08:15.055377   19206 wrap.go:42] GET /api/v1/namespaces/kube-public: (1.053295ms) 200 [[kube...95:42960]</div><div class="line">Jan 29 11:08:15 master1.example.com kube-apiserver[19206]: I0129 11:08:15.405477   19206 wrap.go:42] GET /api/v1/namespaces/default: (1.48537ms) 200 [[kube-apis...95:42960]</div><div class="line">Jan 29 11:08:15 master1.example.com kube-apiserver[19206]: I0129 11:08:15.407091   19206 wrap.go:42] GET /api/v1/namespaces/default/services/kubernetes: (1.0559...95:42960]</div><div class="line">Jan 29 11:08:15 master1.example.com kube-apiserver[19206]: I0129 11:08:15.408295   19206 wrap.go:42] GET /api/v1/namespaces/default/endpoints/kubernetes: (971.4….195:42960</div><div class="line">]Hint: Some lines were ellipsized, use <span class="_">-l</span> to show <span class="keyword">in</span> full.</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h5 id="配置和启动-kube-controller-manager"><a href="#配置和启动-kube-controller-manager" class="headerlink" title="配置和启动 kube-controller-manager"></a>配置和启动 kube-controller-manager</h5><p>创建 kube-controller-manager 的 systemd unit 文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># cat kube-controller-manager.service</span></div><div class="line">[Unit]</div><div class="line">Description=Kubernetes Controller Manager</div><div class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line"></div><div class="line">[Service]</div><div class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/kube-controller-manager \</div><div class="line">  --address=127.0.0.1 \</div><div class="line">  --master=http://192.168.1.195:8080 \</div><div class="line">  --allocate-node-cidrs=<span class="literal">true</span> \</div><div class="line">  --service-cluster-ip-range=172.16.0.0/16 \</div><div class="line">  --cluster-cidr=172.30.0.0/16 \</div><div class="line">  --cluster-name=kubernetes \</div><div class="line">  --cluster-signing-cert-file=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  --cluster-signing-key-file=/etc/kubernetes/ssl/ca-key.pem \</div><div class="line">  --service-account-private-key-file=/etc/kubernetes/ssl/ca-key.pem \</div><div class="line">  --root-ca-file=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  --leader-elect=<span class="literal">true</span> \</div><div class="line">  --v=2</div><div class="line">Restart=on-failure</div><div class="line">RestartSec=5</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div><div class="line">[root@master1 ssl]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<ul>
<li><code>--address</code>值必须为 127.0.0.1，因为当前 kube-apiserver 期望 scheduler 和 controller-manager 在同一台机器</li>
<li><code>--master=http://192.168.1.195:8080</code>：使用非安全 8080 端口与 kube-apiserver 通信</li>
<li><code>--cluster-cidr</code> 指定 Cluster 中 Pod 的 CIDR 范围，该网段在各 Node 间必须路由可达(flanneld保证)</li>
<li><code>--service-cluster-ip-range</code> 参数指定 Cluster 中 Service 的CIDR范围，该网络在各 Node 间必须路由不可达，必须和 kube-apiserver 中的参数一致</li>
<li><code>--cluster-signing-*</code> 指定的证书和私钥文件用来签名为 TLS BootStrap 创建的证书和私钥</li>
<li><code>--root-ca-file</code> 用来对 kube-apiserver 证书进行校验，指定该参数后，才会在Pod 容器的 ServiceAccount 中放置该 CA 证书文件</li>
<li><code>--leader-elect=true</code> 部署多台机器组成的 master 集群时选举产生一处于工作状态的 kube-controller-manager 进程</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># cp kube-controller-manager.service /etc/systemd/system/</span></div></pre></td></tr></table></figure>
<p>启动 kube-controller-manager<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># systemctl daemon-reload</span></div><div class="line">[root@master1 ~]<span class="comment"># systemctl enable kube-controller-manager</span></div><div class="line">[root@master1 ~]<span class="comment"># systemctl start kube-controller-manager</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># netstat -tunlp | grep -i kube-controll</span></div><div class="line">tcp        0      0 127.0.0.1:10252         0.0.0.0:*               LISTEN      19300/kube-controll </div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># systemctl status kube-controller-manager</span></div><div class="line">● kube-controller-manager.service - Kubernetes Controller Manager</div><div class="line">   Loaded: loaded (/etc/systemd/system/kube-controller-manager.service; enabled; vendor preset: disabled)</div><div class="line">   Active: active (running) since Thu 2018-02-01 14:57:01 CST; 41s ago</div><div class="line">     Docs: https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line"> Main PID: 7798 (kube-controller)</div><div class="line">   CGroup: /system.slice/kube-controller-manager.service</div><div class="line">           └─7798 /usr/<span class="built_in">local</span>/bin/kube-controller-manager --address=127.0.0.1 --master=http://192.168.1.195:8080 --allocate-node-cidrs=<span class="literal">true</span> --service-cluster-ip-range=172...</div><div class="line"></div><div class="line">Jan 29 11:10:14 master1.example.com kube-controller-manager[7798]: I0201 14:57:12.832889    7798 controller_utils.go:1019] Waiting <span class="keyword">for</span> caches to sync <span class="keyword">for</span> cidrall...ntroller</div><div class="line">Jan 29 11:10:14 master1.example.com kube-controller-manager[7798]: I0201 14:57:12.832920    7798 taint_controller.go:181] Starting NoExecuteTaintManager</div><div class="line">Jan 29 11:10:15 master1.example.com kube-controller-manager[7798]: I0201 14:57:12.932953    7798 controller_utils.go:1026] Caches are synced <span class="keyword">for</span> cidrallocator controller</div><div class="line">Jan 29 11:10:15 master1.example.com kube-controller-manager[7798]: I0201 14:57:13.549661    7798 resource_quota_controller.go:434] syncing resource quota control... &#123;apps v</div><div class="line">Jan 29 11:10:15 master1.example.com kube-controller-manager[7798]: I0201 14:57:13.549766    7798 controller_utils.go:1019] Waiting <span class="keyword">for</span> caches to sync <span class="keyword">for</span> resourc...ntroller</div><div class="line">Jan 29 11:10:15 master1.example.com kube-controller-manager[7798]: I0201 14:57:13.649852    7798 controller_utils.go:1026] Caches are synced <span class="keyword">for</span> resource quota controller</div><div class="line">Jan 29 11:10:15 master1.example.com kube-controller-manager[7798]: I0201 14:57:13.696714    7798 garbagecollector.go:182] syncing garbage collector with updated ...onregist</div><div class="line">Jan 29 11:10:15 master1.example.com kube-controller-manager[7798]: I0201 14:57:15.046578    7798 controller_utils.go:1019] Waiting <span class="keyword">for</span> caches to sync <span class="keyword">for</span> garbage...ntroller</div><div class="line">Jan 29 11:10:15 master1.example.com kube-controller-manager[7798]: I0201 14:57:15.146718    7798 controller_utils.go:1026] Caches are synced <span class="keyword">for</span> garbage collecto...ntroller</div><div class="line">Jan 29 11:10:15 master1.example.com kube-controller-manager[7798]: I0201 14:57:15.146731    7798 garbagecollector.go:219] synced garbage collector</div><div class="line">Hint: Some lines were ellipsized, use <span class="_">-l</span> to show <span class="keyword">in</span> full.</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h5 id="配置和启动-kube-scheduler"><a href="#配置和启动-kube-scheduler" class="headerlink" title="配置和启动 kube-scheduler"></a>配置和启动 kube-scheduler</h5><p>创建 kube-scheduler 的 systemd unit 文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># cat kube-scheduler.service </span></div><div class="line">[Unit]</div><div class="line">Description=Kubernetes Scheduler</div><div class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line"></div><div class="line">[Service]</div><div class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/kube-scheduler \</div><div class="line">  --address=127.0.0.1 \</div><div class="line">  --master=http://192.168.1.195:8080 \</div><div class="line">  --leader-elect=<span class="literal">true</span> \</div><div class="line">  --v=2</div><div class="line">Restart=on-failure</div><div class="line">RestartSec=5</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div><div class="line">[root@master1 ssl]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<ul>
<li><code>--address</code> 值必须为 127.0.0.1，因为当前 kube-apiserver 期望 scheduler 和 controller-manager 在同一台机器</li>
<li><code>--master=http:/192.168.1.195:8080</code>：使用非安全 8080 端口与 kube-apiserver 通信</li>
<li><code>--leader-elect=true</code>部署多台机器组成的 master 集群时选举产生一处于工作状态的 kube-controller-manager 进程</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># cp -a kube-scheduler.service /etc/systemd/system/</span></div></pre></td></tr></table></figure>
<p>启动 kube-scheduler<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># systemctl daemon-reload</span></div><div class="line">[root@master1 ~]<span class="comment"># systemctl enable kube-scheduler</span></div><div class="line">[root@master1 ~]<span class="comment"># systemctl start kube-scheduler</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># systemctl status kube-scheduler</span></div><div class="line">● kube-scheduler.service - Kubernetes Scheduler</div><div class="line">   Loaded: loaded (/etc/systemd/system/kube-scheduler.service; enabled; vendor preset: disabled)</div><div class="line">   Active: active (running) since Mon 2018-01-29 11:27:07 CST; 2min 34s ago</div><div class="line">     Docs: https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line"> Main PID: 19360 (kube-scheduler)</div><div class="line">   CGroup: /system.slice/kube-scheduler.service</div><div class="line">           └─19360 /usr/<span class="built_in">local</span>/bin/kube-scheduler --address=127.0.0.1 --master=http://192.168.1.195:8080 --leader-elect=<span class="literal">true</span> --v=2</div><div class="line"></div><div class="line">Jan 29 11:27:07 master1.example.com systemd[1]: Starting Kubernetes Scheduler...</div><div class="line">Jan 29 11:27:07 master1.example.com kube-scheduler[19360]: W0129 11:27:07.324795   19360 server.go:159] WARNING: all flags than --config are deprecated. Please ...ile ASAP.</div><div class="line">Jan 29 11:27:07 master1.example.com kube-scheduler[19360]: I0129 11:27:07.325298   19360 server.go:551] Version: v1.9.2</div><div class="line">Jan 29 11:27:07 master1.example.com kube-scheduler[19360]: I0129 11:27:07.325412   19360 factory.go:837] Creating scheduler from algorithm provider <span class="string">'DefaultProvider'</span></div><div class="line">Jan 29 11:27:07 master1.example.com kube-scheduler[19360]: I0129 11:27:07.325419   19360 factory.go:898] Creating scheduler with fit predicates <span class="string">'map[CheckNodeDi...&#123;&#125; NoDisk</span></div><div class="line">Jan 29 11:27:07 master1.example.com kube-scheduler[19360]: I0129 11:27:07.325564   19360 server.go:570] starting healthz server on 127.0.0.1:10251</div><div class="line">Jan 29 11:27:08 master1.example.com kube-scheduler[19360]: I0129 11:27:08.126353   19360 controller_utils.go:1019] Waiting for caches to sync for scheduler controller</div><div class="line">Jan 29 11:27:08 master1.example.com kube-scheduler[19360]: I0129 11:27:08.226450   19360 controller_utils.go:1026] Caches are synced for scheduler controller</div><div class="line">Jan 29 11:27:08 master1.example.com kube-scheduler[19360]: I0129 11:27:08.226468   19360 leaderelection.go:174] attempting to acquire leader lease...</div><div class="line">Jan 29 11:27:08 master1.example.com kube-scheduler[19360]: I0129 11:27:08.232415   19360 leaderelection.go:184] successfully acquired lease kube-system/kube-scheduler</div><div class="line">Hint: Some lines were ellipsized, use -l to show in full.</div><div class="line">[root@master1 ~]#</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># netstat -tunlp | grep -i kube-schedule</span></div><div class="line">tcp        0      0 127.0.0.1:10251         0.0.0.0:*               LISTEN      19360/kube-schedule </div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h4 id="部署-kubectl-client节点"><a href="#部署-kubectl-client节点" class="headerlink" title="部署 kubectl client节点"></a>部署 kubectl client节点</h4><p>kubernetes发布版 tarball(下载脚本) 下载地址：<a href="https://github.com/kubernetes/kubernetes/releases" target="_blank" rel="external">https://github.com/kubernetes/kubernetes/releases</a><br>kubernetes CHANGELOG(server/client) 下载地址：<a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG.md" target="_blank" rel="external">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG.md</a><br><a href="https://pan.baidu.com/s/1sngFMlZ" target="_blank" rel="external">百度网盘packages目录，密码：nwzk</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># wget https://dl.k8s.io/v1.9.2/kubernetes-client-linux-amd64.tar.gz -O kubernetes-client-linux-amd64-v1.9.2.tar.gz</span></div><div class="line">[root@master1 ~]<span class="comment"># tar -zxf kubernetes-client-linux-amd64-v1.9.2.tar.gz</span></div><div class="line">[root@master1 ~]<span class="comment"># cp -a kubernetes/client/bin/kube* /usr/local/bin/</span></div></pre></td></tr></table></figure></p>
<h5 id="创建-admin-证书"><a href="#创建-admin-证书" class="headerlink" title="创建 admin 证书"></a>创建 admin 证书</h5><p>kubectl 与 kube-apiserver 的安全端口通信，需要为安全通信提供 TLS 证书和秘钥  </p>
<p>创建 admin 证书签名请求<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># cat admin-csr.json</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"CN"</span>: <span class="string">"admin"</span>,</div><div class="line">  <span class="string">"hosts"</span>: [],</div><div class="line">  <span class="string">"key"</span>: &#123;</div><div class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</div><div class="line">    <span class="string">"size"</span>: 2048</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"names"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</div><div class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">      <span class="string">"O"</span>: <span class="string">"system:masters"</span>,</div><div class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>kube-apiserver</code> 使用 <code>RBAC</code> 对客户端(如 <code>kubelet</code>、<code>kube-proxy</code>、<code>Pod</code>)请求进行授权  </li>
<li><code>kube-apiserver</code> 预定义了一些 <code>RBAC</code> 使用的 <code>RoleBindings</code>，如 <code>cluster-admin</code> 将 Group <code>system:masters</code> 与 Role <code>cluster-admin</code> 绑定，该 Role 授予了调用<code>kube-apiserver</code> <strong>所有 API</strong>的权限  </li>
<li>O 指定该证书的 Group 为 <code>system:masters</code>，<code>kubelet</code> 使用该证书访问 <code>kube-apiserver</code> 时 ，由于证书被 CA 签名，所以认证通过，同时由于证书用户组为经过预授权的 <code>system:masters</code>，所以被授予访问所有 API 的权限  </li>
<li>hosts 属性值为空列表  </li>
</ul>
<p>生成admin证书和私钥<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># cfssl gencert -ca=/etc/kubernetes/ssl/ca.pem -ca-key=/etc/kubernetes/ssl/ca-key.pem -config=/etc/kubernetes/ssl/ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin</span></div><div class="line">[root@master1 ssl]<span class="comment"># ls admin*</span></div><div class="line">admin.csr  admin-csr.json  admin-key.pem  admin.pem</div><div class="line">[root@master1 ssl]<span class="comment"># mv admin*.pem /etc/kubernetes/ssl/</span></div></pre></td></tr></table></figure></p>
<p>创建 kubectl kubeconfig 文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 设置集群参数</span></div><div class="line">[root@master1 ~]<span class="comment"># kubectl config set-cluster kubernetes --certificate-authority=/etc/kubernetes/ssl/ca.pem --embed-certs=true --server=https://192.168.1.195:6443</span></div><div class="line"><span class="comment"># 设置客户端认证参数</span></div><div class="line">[root@master1 ~]<span class="comment"># kubectl config set-credentials admin --client-certificate=/etc/kubernetes/ssl/admin.pem --embed-certs=true --client-key=/etc/kubernetes/ssl/admin-key.pem</span></div><div class="line"><span class="comment"># 设置上下文参数</span></div><div class="line">[root@master1 ~]<span class="comment"># kubectl config set-context kubernetes --cluster=kubernetes --user=admin</span></div><div class="line"><span class="comment"># 设置默认上下文</span></div><div class="line">[root@master1 ~]<span class="comment"># kubectl config use-context kubernetes</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># ls ~/.kube/</span></div><div class="line">config</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<ul>
<li>设置集群参数和客户端认证参数时 <code>--embed-certs</code> 都为 <code>true</code>，这会将 <code>certificate-authority</code>、<code>client-certificate</code> 和 <code>client-key</code> 指向的证书文件内容写入到生成的 <code>kube-proxy.kubeconfig</code> 文件中  </li>
<li><code>kube-proxy.pem</code> 证书中 CN 为 <code>system:kube-proxy</code>，<code>kube-apiserver</code> 预定义的 RoleBinding <code>cluster-admin</code> 将User <code>system:kube-proxy</code> 与 Role <code>system:node-proxier</code> 绑定，该 Role 授予了调用 <code>kube-apiserver</code> Proxy 相关 API 的权限  </li>
<li><code>admin.pem</code> 证书 O 字段值为 <code>system:masters</code>，<code>kube-apiserver</code> 预定义的 RoleBinding <code>cluster-admin</code> 将 Group <code>system:masters</code> 与 Role <code>cluster-admin</code> 绑定，该 Role 授予了调用<code>kube-apiserver</code> 相关 API 的权限  </li>
<li>生成的 kubeconfig 被保存到 <code>~/.kube/config</code> 文件  </li>
</ul>
<p>分发 kubeconfig 文件<br>将 <code>~/.kube/config</code> 文件拷贝到运行 kubelet 命令的机器的 <code>~/.kube/</code> 目录下</p>
<p>其他服务器部署kubectl-client工具<br>先在需要解压安装kubernetes-client-linux-amd64-v1.9.2.tar.gz<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># ssh root@192.168.1.196 "mkdir -p /etc/kubernetes/ssl/"</span></div><div class="line">[root@master1 ~]<span class="comment"># scp /etc/kubernetes/ssl/admin* root@192.168.1.196:/etc/kubernetes/ssl/</span></div><div class="line">[root@master1 ~]<span class="comment"># ssh root@192.168.1.196 "mkdir -p ~/.kube/"</span></div><div class="line">[root@master1 ~]<span class="comment"># scp ~/.kube/config root@192.168.1.196:~/.kube/</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@master2 ~]<span class="comment"># kubectl get componentstatuses</span></div><div class="line">NAME                 STATUS    MESSAGE              ERROR</div><div class="line">controller-manager   Healthy   ok                   </div><div class="line">scheduler            Healthy   ok                   </div><div class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;   </div><div class="line">etcd-1               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;   </div><div class="line">etcd-2               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;   </div><div class="line">[root@master2 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>如果遇到下面的错误，需要检查kubectl是否可以与api-server通讯<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># kubectl get componentstatuses</span></div><div class="line">The connection to the server localhost:8080 was refused - did you specify the right host or port?</div></pre></td></tr></table></figure></p>
<h6 id="查看集群状态"><a href="#查看集群状态" class="headerlink" title="查看集群状态"></a>查看集群状态</h6><p>查看k8s 查看各组件信息<br>需要先安装kubectl命令(kubernetes-client)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get componentstatuses</span></div><div class="line">NAME                 STATUS    MESSAGE              ERROR</div><div class="line">controller-manager   Healthy   ok                   </div><div class="line">scheduler            Healthy   ok                   </div><div class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;   </div><div class="line">etcd-1               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;   </div><div class="line">etcd-2               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;   </div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>或<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl -s http://192.168.1.195:8080 get componentstatuses</span></div><div class="line">NAME                 STATUS    MESSAGE              ERROR</div><div class="line">scheduler            Healthy   ok                   </div><div class="line">controller-manager   Healthy   ok                   </div><div class="line">etcd-2               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;   </div><div class="line">etcd-1               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;   </div><div class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;   </div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>查看k8s svc地址(服务虚拟IP)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get svc kubernetes</span></div><div class="line">NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</div><div class="line">kubernetes   ClusterIP   172.16.0.1   &lt;none&gt;        443/TCP   1d</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>或<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get service</span></div><div class="line">NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</div><div class="line">kubernetes   ClusterIP   172.16.0.1   &lt;none&gt;        443/TCP   1d</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>查看集群信息<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl cluster-info</span></div><div class="line">Kubernetes master is running at https://192.168.1.195:6443</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<h4 id="部署-K8S-Node-节点"><a href="#部署-K8S-Node-节点" class="headerlink" title="部署 K8S Node 节点"></a>部署 K8S Node 节点</h4><p>kubernetes Node 节点包含如下组件：  </p>
<ul>
<li>flanneld</li>
<li>docker</li>
<li>kubelet</li>
<li>kube-proxy</li>
</ul>
<h5 id="安装和配置-kubelet"><a href="#安装和配置-kubelet" class="headerlink" title="安装和配置 kubelet"></a>安装和配置 kubelet</h5><p>kubelet 启动时向 <code>kube-apiserver</code> 发送 <code>TLS bootstrapping</code> 请求，需要先将 <code>bootstrap token</code> 文件中的 <code>kubelet-bootstrap</code> 用户赋予 <code>system:node-bootstrapper</code> 角色，然后 kubelet 才有权限创建认证请求(certificatesigningrequests)  </p>
<p><strong>kubelet 和kube-proxy 在node1/node2上部署</strong><br><a href="https://pan.baidu.com/s/1sngFMlZ" target="_blank" rel="external">百度网盘packages目录，密码：nwzk</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># wget https://dl.k8s.io/v1.9.2/kubernetes-server-linux-amd64.tar.gz -O kubernetes-server-linux-amd64-v1.9.2.tar.gz</span></div><div class="line">[root@node1 ~]<span class="comment"># tar -zxf kubernetes-server-linux-amd64-v1.9.2.tar.gz</span></div><div class="line">[root@node1 ~]<span class="comment"># cp -a kubernetes/server/bin/&#123;kube-proxy,kubelet&#125; /usr/local/bin/</span></div></pre></td></tr></table></figure></p>
<p>把在安装有cfssl 工具的服务器(这里是在master1)上生成的admin相关证书和key拷贝到node1上<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># ssh root@192.168.1.198 "mkdir -p /etc/kubernetes/ssl/"</span></div><div class="line">[root@master1 ~]<span class="comment"># scp /etc/kubernetes/ssl/admin* root@192.168.1.198:/etc/kubernetes/ssl/</span></div><div class="line">[root@master1 ~]<span class="comment"># ssh root@192.168.1.198 "mkdir -p ~/.kube/"</span></div><div class="line">[root@master1 ~]<span class="comment"># scp ~/.kube/config root@192.168.1.198:~/.kube/</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#如果kubectl命令没有，需要安装kubernetes-client-linux-amd64-v1.9.2.tar.gz</span></div><div class="line"><span class="comment">#如果有多个节点，这条命令只执行一次</span></div><div class="line">[root@node1 ~]<span class="comment"># kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --user=kubelet-bootstrap</span></div></pre></td></tr></table></figure>
<ul>
<li><code>--user=kubelet-bootstrap</code> 是master服务器文件 <code>/etc/kubernetes/token.csv</code> 中指定的用户名，同时也写入了文件 <code>/etc/kubernetes/bootstrap.kubeconfig</code> </li>
</ul>
<p>如果报下面错误，需要先安装kubectl工具，参考上面操作<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@node2 ~]<span class="comment"># kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --user=kubelet-bootstrap</span></div><div class="line">The connection to the server localhost:8080 was refused - did you specify the right host or port?</div><div class="line">[root@node2 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>创建 kubelet bootstrapping kubeconfig 文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 设置集群参数</span></div><div class="line">[root@node1 ~]<span class="comment"># kubectl config set-cluster kubernetes --certificate-authority=/etc/kubernetes/ssl/ca.pem --embed-certs=true --server=https://192.168.1.195:6443 --kubeconfig=bootstrap.kubeconfig</span></div><div class="line"><span class="comment"># 设置客户端认证参数</span></div><div class="line">[root@node1 ~]<span class="comment"># kubectl config set-credentials kubelet-bootstrap --token=6240b18d950d086ff9eb596e215d243f --kubeconfig=bootstrap.kubeconfig</span></div><div class="line"><span class="comment"># 设置上下文参数</span></div><div class="line">[root@node1 ~]<span class="comment"># kubectl config set-context default --cluster=kubernetes --user=kubelet-bootstrap --kubeconfig=bootstrap.kubeconfig</span></div><div class="line"><span class="comment"># 设置默认上下文</span></div><div class="line">[root@node1 ~]<span class="comment"># kubectl config use-context default --kubeconfig=bootstrap.kubeconfig</span></div><div class="line">[root@node1 ~]<span class="comment"># ls bootstrap.kubeconfig </span></div><div class="line">bootstrap.kubeconfig</div><div class="line">[root@node1 ~]<span class="comment"># mv bootstrap.kubeconfig /etc/kubernetes/</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># mkdir -p /var/lib/kubelet</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># cat kubelet.service </span></div><div class="line">[Unit]</div><div class="line">Description=Kubernetes Kubelet</div><div class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line">After=docker.service</div><div class="line">Requires=docker.service</div><div class="line"></div><div class="line">[Service]</div><div class="line">WorkingDirectory=/var/lib/kubelet</div><div class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/kubelet \</div><div class="line">  --address=192.168.1.198 \</div><div class="line">  --hostname-override=192.168.1.198 \</div><div class="line">  --pod-infra-container-image=registry.access.redhat.com/rhel7/pod-infrastructure:latest \</div><div class="line">  --experimental-bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig \</div><div class="line">  --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \</div><div class="line">  --require-kubeconfig \</div><div class="line">  --cert-dir=/etc/kubernetes/ssl \</div><div class="line">  --cluster-dns=223.5.5.5,223.6.6.6,8.8.8.8 \</div><div class="line">  --cluster-domain=aliyun.com. \</div><div class="line">  --hairpin-mode promiscuous-bridge \</div><div class="line">  --allow-privileged=<span class="literal">true</span> \</div><div class="line">  --serialize-image-pulls=<span class="literal">false</span> \</div><div class="line">  --logtostderr=<span class="literal">true</span> \</div><div class="line">  --v=2</div><div class="line"><span class="comment">#kubelet cAdvisor 默认在所有接口监听 4194 端口的请求, 以下iptables限制内网访问</span></div><div class="line">ExecStartPost=/sbin/iptables -A INPUT <span class="_">-s</span> 172.30.0.0/16 -p tcp --dport 4194 -j ACCEPT</div><div class="line">ExecStartPost=/sbin/iptables -A INPUT <span class="_">-s</span> 172.16.0.0/16 -p tcp --dport 4194 -j ACCEPT</div><div class="line">ExecStartPost=/sbin/iptables -A INPUT <span class="_">-s</span> 192.168.0.0/16 -p tcp --dport 4194 -j ACCEPT</div><div class="line">ExecStartPost=/sbin/iptables -A INPUT -p tcp --dport 4194 -j DROP</div><div class="line">Restart=on-failure</div><div class="line">RestartSec=5</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div><div class="line">[root@node1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<ul>
<li><code>--address</code> 不能设置为 <code>127.0.0.1</code>，否则后续 Pods 访问 kubelet 的 API 接口时会失败，因为 Pods 访问的 127.0.0.1 指向自己而不是 kubelet。<code>--address</code>设置为当前部署的节点 IP  </li>
<li>如果设置了 <code>--hostname-override</code> 选项，则 kube-proxy 也需要设置该选项，否则会出现找不到 Node 的情况。<code>--hostname-override</code>设置为当前部署的节点 IP  </li>
<li><code>--cluster-dns</code>设置为集群 DNS 服务 IP (从 SERVICE_CIDR 中预分配)，此环境中使用的 SERVICE_CIDR为172.16.0.0/16，可在master的kube-apiserver配置文件中看到  </li>
<li><code>--cluster-domain</code>设置为集群 DNS 域名  </li>
<li><code>--experimental-bootstrap-kubeconfig</code> 指向 bootstrap kubeconfig 文件，kubelet 使用该文件中的用户名和 token 向 kube-apiserver 发送 TLS Bootstrapping 请求  </li>
<li>管理员通过了 CSR 请求后，kubelet 自动在 <code>--cert-dir</code> 目录创建证书和私钥文件(<code>kubelet-client.crt</code> 和 <code>kubelet-client.key</code>)，然后写入 <code>--kubeconfig</code> 文件(自动创建 <code>--kubeconfig</code> 指定的文件)  </li>
<li>建议在 <code>--kubeconfig</code> 配置文件中指定 <code>kube-apiserver</code> 地址，如果未指定 <code>--api-servers</code> 选项，则必须指定 <code>--require-kubeconfig</code> 选项后才从配置文件中读取 kue-apiserver 的地址，否则 kubelet 启动后将找不到 kube-apiserver (日志中提示未找到 API Server），<code>kubectl get nodes</code> 不会返回对应的 Node 信息  </li>
<li><code>--cluster-dns</code> 指定 kubedns 的 Service IP(可以先分配，后续创建 kubedns 服务时指定该 IP)，<code>--cluster-domain</code> 指定域名后缀，这两个参数同时指定后才会生效  </li>
<li>kubelet cAdvisor 默认在<strong>所有接口</strong>监听 4194 端口的请求，对于有外网的机器来说不安全，<code>ExecStartPost</code> 选项指定的 iptables 规则只允许内网机器访问 4194 端口  </li>
<li><code>--cluster-dns</code>：集群DNS服务IP(从 SERVICE_CIDR 中预分配)。经测试，如果k8s内部没有搭建DNS，建议使用外部公共DNS地址。如果该DNS不存在，将会影响业务对域名的解析  </li>
<li><code>--cluster-domain</code>：集群 DNS 域名。经测试，此DNS域名后缀必须为真实域名后缀，k8s会写入到POD的/etc/resolv.conf文件中。如果使用默认的DNS后缀(cluster.local.)，因该DNS后缀不存在，故在解析DNS时会超时，会严重影响业务</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># mv kubelet.service /etc/systemd/system/kubelet.service</span></div></pre></td></tr></table></figure>
<p>启动 kubelet<br>v1.8版后，需要手动绑定 system:nodes组到 system:node的clusterrole<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#kubelet-node-clusterbinding为名称，可自定义。如果有多个节点加入，名称不能相同</span></div><div class="line">[root@master1 ~]<span class="comment"># kubectl create clusterrolebinding kubelet-node-clusterbinding --clusterrole=system:node --user=system:node:192.168.1.198</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#启动kubelet需要关闭swap分区  </span></div><div class="line">[root@node1 ~]<span class="comment"># swapoff -a</span></div><div class="line">[root@node1 ~]<span class="comment"># systemctl daemon-reload</span></div><div class="line">[root@node1 ~]<span class="comment"># systemctl enable kubelet</span></div><div class="line">[root@node1 ~]<span class="comment"># systemctl start kubelet</span></div></pre></td></tr></table></figure>
<p>需要关闭swap分区，否则会报下面的错误<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Feb  1 16:56:59 k8s-4 kubelet: error: failed to run Kubelet: Running with swap on is not supported, please <span class="built_in">disable</span> swap! or <span class="built_in">set</span> --fail-swap-on flag to false. /proc/swaps contained: [Filename<span class="comment">#011#011#011#011Type#011#011Size#011Used#011Priority /dev/dm-1 partition#0112097148#01116#011-1]</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># systemctl status kubelet</span></div><div class="line">● kubelet.service - Kubernetes Kubelet</div><div class="line">   Loaded: loaded (/etc/systemd/system/kubelet.service; enabled; vendor preset: disabled)</div><div class="line">   Active: active (running) since Thu 2018-02-01 16:41:49 CST; 7min ago</div><div class="line">     Docs: https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line">  Process: 30456 ExecStartPost=/sbin/iptables -A INPUT -p tcp --dport 4194 -j DROP (code=exited, status=0/SUCCESS)</div><div class="line">  Process: 30452 ExecStartPost=/sbin/iptables -A INPUT <span class="_">-s</span> 192.168.0.0/16 -p tcp --dport 4194 -j ACCEPT (code=exited, status=0/SUCCESS)</div><div class="line">  Process: 30451 ExecStartPost=/sbin/iptables -A INPUT <span class="_">-s</span> 172.16.0.0/16 -p tcp --dport 4194 -j ACCEPT (code=exited, status=0/SUCCESS)</div><div class="line">  Process: 30446 ExecStartPost=/sbin/iptables -A INPUT <span class="_">-s</span> 172.30.0.0/16 -p tcp --dport 4194 -j ACCEPT (code=exited, status=0/SUCCESS)</div><div class="line"> Main PID: 30445 (kubelet)</div><div class="line">   Memory: 11.7M</div><div class="line">   CGroup: /system.slice/kubelet.service</div><div class="line">           └─30445 /usr/<span class="built_in">local</span>/bin/kubelet --address=192.168.1.198 --hostname-override=192.168.1.198 --pod-infra-container-image=registry.access.redhat.com/rhel7/pod-infr...</div><div class="line"></div><div class="line">Feb 01 16:41:49 node1.example.com kubelet[30445]: I0201 16:41:49.807803   30445 controller.go:114] kubelet config controller: starting controller</div><div class="line">Feb 01 16:41:49 node1.example.com kubelet[30445]: I0201 16:41:49.807806   30445 controller.go:118] kubelet config controller: validating combination of defaults and flags</div><div class="line">Feb 01 16:41:49 node1.example.com kubelet[30445]: I0201 16:41:49.812805   30445 mount_linux.go:202] Detected OS with systemd</div><div class="line">Feb 01 16:41:49 node1.example.com kubelet[30445]: W0201 16:41:49.812875   30445 cni.go:171] Unable to update cni config: No networks found <span class="keyword">in</span> /etc/cni/net.d</div><div class="line">Feb 01 16:41:49 node1.example.com kubelet[30445]: I0201 16:41:49.815926   30445 server.go:182] Version: v1.9.2</div><div class="line">Feb 01 16:41:49 node1.example.com kubelet[30445]: I0201 16:41:49.815950   30445 feature_gate.go:220] feature gates: &amp;&#123;&#123;&#125; map[]&#125;</div><div class="line">Feb 01 16:41:49 node1.example.com kubelet[30445]: W0201 16:41:49.816011   30445 server.go:280] --require-kubeconfig is deprecated. Set --kubeconfig without usi...ubeconfig.</div><div class="line">Feb 01 16:41:49 node1.example.com kubelet[30445]: I0201 16:41:49.816019   30445 plugins.go:101] No cloud provider specified.</div><div class="line">Feb 01 16:41:49 node1.example.com kubelet[30445]: I0201 16:41:49.816025   30445 server.go:303] No cloud provider specified: <span class="string">""</span> from the config file: <span class="string">""</span></div><div class="line">Feb 01 16:41:49 node1.example.com kubelet[30445]: I0201 16:41:49.816036   30445 bootstrap.go:58] Using bootstrap kubeconfig to generate TLS client cert, key an...onfig file</div><div class="line">Hint: Some lines were ellipsized, use <span class="_">-l</span> to show <span class="keyword">in</span> full.</div><div class="line">[root@node1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h6 id="Q-amp-A-master日志报RBAC-DENY-user-“kubelet-bootstrap”-groups错误"><a href="#Q-amp-A-master日志报RBAC-DENY-user-“kubelet-bootstrap”-groups错误" class="headerlink" title="Q&amp;A master日志报RBAC DENY: user “kubelet-bootstrap” groups错误"></a>Q&amp;A master日志报RBAC DENY: user “kubelet-bootstrap” groups错误</h6><p>启动kubelet服务后，需要看master的kube-apiserver日志(/var/log/messages)中没有如下报错，才算启动成功。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Feb  1 03:41:53 master1 kube-apiserver: I0201 16:41:53.245112    8202 rbac.go:116] RBAC DENY: user <span class="string">"kubelet-bootstrap"</span> groups [<span class="string">"system:kubelet-bootstrap"</span> <span class="string">"system:authentica</span></div><div class="line">ted"] cannot <span class="string">"create"</span> resource <span class="string">"certificatesigningrequests.certificates.k8s.io/nodeclient"</span> cluster-wide</div></pre></td></tr></table></figure></p>
<p>如果在启动node时，master的/var/log/messages日志报上面的错误，原因如下：<br>1.8版本之前，开启<code>rbac</code>后，apiserver默认绑定<code>system:nodes</code>组到<code>system:node</code>的clusterrole。但v1.8之后，此绑定默认不存在，<strong>需要手工绑定</strong>，否则kubelet启动后会报认证错误，使用kubectl get nodes查看无法成为Ready状态。  </p>
<p>默认角色与默认角色绑定<br>API Server会创建一组默认的ClusterRole和<code>ClusterRoleBinding</code>对象。这些默认对象中有许多包含<code>system:前缀</code>，表明这些资源由Kubernetes基础组件“拥有”。 对这些资源的修改可能导致非功能性集群(<code>non-functional cluster</code>)<br>这个角色定义了kubelets的权限。如果这个角色被修改，可能会导致kubelets无法正常工作。<br>所有默认的<code>ClusterRole</code>和<code>ClusterRoleBinding</code>对象都会被标记为<code>kubernetes.io/bootstrapping=rbac-defaults</code>  </p>
<p><code>kubectl get clusterrolebinding</code>和<code>kubectl get clusterrole</code>可以查看系统中的角色与角色绑定<br><code>kubectl get clusterrolebindings system:node -o yaml</code>或<code>kubectl describe clusterrolebindings system:node</code>查看<code>system:node</code>角色绑定的详细信息  </p>
<p>查看 system:node 角色绑定的详细信息<br>system:node角色默认绑定为空<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl describe clusterrolebindings system:node</span></div><div class="line">Name:         system:node</div><div class="line">Labels:       kubernetes.io/bootstrapping=rbac-defaults</div><div class="line">Annotations:  rbac.authorization.kubernetes.io/autoupdate=<span class="literal">true</span></div><div class="line">Role:</div><div class="line">  Kind:  ClusterRole</div><div class="line">  Name:  system:node</div><div class="line">Subjects:</div><div class="line">  Kind  Name  Namespace</div><div class="line">  ----  ----  ---------</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>在整个集群范围内将 system:node ClusterRole 授予用户<code>system:node:192.168.1.198</code>或组<code>system:nodes</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl describe clusterrolebindings kubelet-node-clusterbinding  </span></div><div class="line">Name:         kubelet-node-clusterbinding</div><div class="line">Labels:       &lt;none&gt;</div><div class="line">Annotations:  &lt;none&gt;</div><div class="line">Role:</div><div class="line">  Kind:  ClusterRole</div><div class="line">  Name:  system:node</div><div class="line">Subjects:</div><div class="line">  Kind  Name                       Namespace</div><div class="line">  ----  ----                       ---------</div><div class="line">  User  system:node:192.168.1.198  </div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<h5 id="通过-kubelet-的-TLS-证书请求"><a href="#通过-kubelet-的-TLS-证书请求" class="headerlink" title="通过 kubelet 的 TLS 证书请求"></a>通过 kubelet 的 TLS 证书请求</h5><p>kubelet 首次启动时向 kube-apiserver 发送证书签名请求，必须通过后 kubernetes 系统才会将该 Node 加入到集群  </p>
<p>查看未授权的 CSR 请求:<br>下面如果没有获取到也代表kubelet没有启动成功<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get csr</span></div><div class="line">NAME                                                   AGE       REQUESTOR           CONDITION</div><div class="line">node-csr-DeFIxWS7IZimyAUaZGtIh8q4sp_CiNHL2bO1cwEm26U   9m        kubelet-bootstrap   Pending</div><div class="line">[root@master1 ~]<span class="comment"># </span></div><div class="line">[root@master1 ~]<span class="comment"># kubectl get nodes</span></div><div class="line">No resources found.</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>通过 CSR 请求:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl certificate approve node-csr-DeFIxWS7IZimyAUaZGtIh8q4sp_CiNHL2bO1cwEm26U</span></div><div class="line">certificatesigningrequest <span class="string">"node-csr-DeFIxWS7IZimyAUaZGtIh8q4sp_CiNHL2bO1cwEm26U"</span> approved</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get csr</span></div><div class="line">NAME                                                   AGE       REQUESTOR           CONDITION</div><div class="line">node-csr-DeFIxWS7IZimyAUaZGtIh8q4sp_CiNHL2bO1cwEm26U   13m       kubelet-bootstrap   Approved,Issued</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>自动生成了 kubelet kubeconfig 文件和公私钥<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># ls -l /etc/kubernetes/kubelet.kubeconfig</span></div><div class="line">-rw------- 1 root root 2280 Jan 31 19:19 /etc/kubernetes/kubelet.kubeconfig</div><div class="line">[root@node1 ~]<span class="comment"># ls -l /etc/kubernetes/ssl/kubelet*</span></div><div class="line">-rw-r--r-- 1 root root 1046 Jan 31 19:19 /etc/kubernetes/ssl/kubelet-client.crt</div><div class="line">-rw------- 1 root root  227 Jan 31 19:18 /etc/kubernetes/ssl/kubelet-client.key</div><div class="line">-rw-r--r-- 1 root root 1115 Jan 31 19:15 /etc/kubernetes/ssl/kubelet.crt</div><div class="line">-rw------- 1 root root 1675 Jan 31 19:15 /etc/kubernetes/ssl/kubelet.key</div><div class="line">[root@node1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>如果节点状态变为Ready才算成功，查看日志都已经正常<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get nodes</span></div><div class="line">NAME            STATUS    ROLES     AGE       VERSION</div><div class="line">192.168.1.198   Ready     &lt;none&gt;    25m       v1.9.2</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>参考：<a href="http://blog.csdn.net/zhaihaifei/article/details/79098564" target="_blank" rel="external">http://blog.csdn.net/zhaihaifei/article/details/79098564</a>  </p>
<h6 id="多个Node节点加入"><a href="#多个Node节点加入" class="headerlink" title="多个Node节点加入"></a>多个Node节点加入</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl describe clusterrolebindings kubelet-node199-clusterbinding  </span></div><div class="line">Name:         kubelet-node199-clusterbinding</div><div class="line">Labels:       &lt;none&gt;</div><div class="line">Annotations:  &lt;none&gt;</div><div class="line">Role:</div><div class="line">  Kind:  ClusterRole</div><div class="line">  Name:  system:node</div><div class="line">Subjects:</div><div class="line">  Kind  Name                       Namespace</div><div class="line">  ----  ----                       ---------</div><div class="line">  User  system:node:192.168.1.199  </div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get nodes</span></div><div class="line">NAME            STATUS    ROLES     AGE       VERSION</div><div class="line">192.168.1.198   Ready     &lt;none&gt;    3h        v1.9.2</div><div class="line">192.168.1.199   Ready     &lt;none&gt;    2m        v1.9.2</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h5 id="配置-kube-proxy"><a href="#配置-kube-proxy" class="headerlink" title="配置 kube-proxy"></a>配置 kube-proxy</h5><p>创建 kube-proxy 证书签名请求<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># cat kube-proxy-csr.json </span></div><div class="line">&#123;</div><div class="line">  <span class="string">"CN"</span>: <span class="string">"system:kube-proxy"</span>,</div><div class="line">  <span class="string">"hosts"</span>: [],</div><div class="line">  <span class="string">"key"</span>: &#123;</div><div class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</div><div class="line">    <span class="string">"size"</span>: 2048</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"names"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</div><div class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</div><div class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</div><div class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line">[root@master1 ssl]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<ul>
<li>CN 指定该证书的 User 为 <code>system:kube-proxy</code>；</li>
<li>kube-apiserver 预定义的 RoleBinding <code>system:node-proxier</code> 将User <code>system:kube-proxy</code> 与 Role <code>system:node-proxier</code> 绑定，该 Role 授予了调用 <code>kube-apiserver</code> Proxy 相关 API 的权限；</li>
<li>hosts 属性值为空列表</li>
</ul>
<p>生成 kube-proxy 客户端证书和私钥<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># cfssl gencert -ca=/etc/kubernetes/ssl/ca.pem -ca-key=/etc/kubernetes/ssl/ca-key.pem -config=/etc/kubernetes/ssl/ca-config.json -profile=kubernetes  kube-proxy-csr.json | cfssljson -bare kube-proxy</span></div><div class="line">[root@master1 ssl]<span class="comment"># ls kube-proxy*</span></div><div class="line">kube-proxy.csr  kube-proxy-csr.json  kube-proxy-key.pem  kube-proxy.pem</div><div class="line">[root@master1 ssl]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>把在安装有cfssl 工具的服务器(这里是在master1)上生成的kube-proxy 相关证书和key拷贝到node1上<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ssl]<span class="comment"># scp kube-proxy*.pem root@192.168.1.198:/etc/kubernetes/ssl/</span></div></pre></td></tr></table></figure></p>
<p>创建 kube-proxy kubeconfig 文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 设置集群参数</span></div><div class="line">[root@node1 ~]<span class="comment"># kubectl config set-cluster kubernetes --certificate-authority=/etc/kubernetes/ssl/ca.pem --embed-certs=true --server=https://192.168.1.195:6443 --kubeconfig=kube-proxy.kubeconfig</span></div><div class="line"><span class="comment"># 设置客户端认证参数</span></div><div class="line">[root@node1 ~]<span class="comment"># kubectl config set-credentials kube-proxy --client-certificate=/etc/kubernetes/ssl/kube-proxy.pem --client-key=/etc/kubernetes/ssl/kube-proxy-key.pem --embed-certs=true --kubeconfig=kube-proxy.kubeconfig</span></div><div class="line"><span class="comment">#设置上下文参数</span></div><div class="line">[root@node1 ~]<span class="comment"># kubectl config set-context default --cluster=kubernetes --user=kube-proxy --kubeconfig=kube-proxy.kubeconfig</span></div><div class="line"><span class="comment">#设置默认上下文</span></div><div class="line">[root@node1 ~]<span class="comment"># kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># mv kube-proxy.kubeconfig /etc/kubernetes/</span></div></pre></td></tr></table></figure>
<ul>
<li>设置集群参数和客户端认证参数时 <code>--embed-certs</code> 都为 <code>true</code>，这会将 <code>certificate-authority</code>、<code>client-certificate</code> 和 <code>client-key</code> 指向的证书文件内容写入到生成的 <code>kube-proxy.kubeconfig</code> 文件中</li>
<li><code>kube-proxy.pem</code> 证书中 CN 为 <code>system:kube-proxy</code>，<code>kube-apiserver</code> 预定义的 RoleBinding <code>cluster-admin</code> 将User <code>system:kube-proxy</code> 与 Role <code>system:node-proxier</code> 绑定，该 Role 授予了调用 <code>kube-apiserver Proxy</code> 相关 API 的权限</li>
</ul>
<p>创建 kube-proxy 的 systemd unit 文件<br>创建工作目录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># mkdir -p /var/lib/kube-proxy</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># cat kube-proxy.service </span></div><div class="line">[Unit]</div><div class="line">Description=Kubernetes Kube-Proxy Server</div><div class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line">After=network.target</div><div class="line"></div><div class="line">[Service]</div><div class="line">WorkingDirectory=/var/lib/kube-proxy</div><div class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/kube-proxy \</div><div class="line">  --bind-address=192.168.1.198 \</div><div class="line">  --hostname-override=192.168.1.198 \</div><div class="line">  --cluster-cidr=172.30.0.0/16 \</div><div class="line">  --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig \</div><div class="line">  --logtostderr=<span class="literal">true</span> \</div><div class="line">  --v=2</div><div class="line">Restart=on-failure</div><div class="line">RestartSec=5</div><div class="line">LimitNOFILE=65536</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div><div class="line">[root@node1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<ul>
<li><code>--hostname-override</code> 参数值<strong>必须</strong>与 kubelet 的值一致，否则 kube-proxy 启动后会找不到该 Node，从而不会创建任何 iptables 规则  </li>
<li><code>--cluster-cidr</code> <strong>必须</strong>与 kube-controller-manager 的 <code>--cluster-cidr</code> 选项值一致，172.30.0.0/16  </li>
<li>kube-proxy 根据 <code>--cluster-cidr</code> 判断集群内部和外部流量，指定 <code>--cluster-cidr</code> 或 <code>--masquerade-all</code> 选项后 kube-proxy 才会对访问 Service IP 的请求做 SNAT  </li>
<li><code>--kubeconfig</code> 指定的配置文件嵌入了 kube-apiserver 的地址、用户名、证书、秘钥等请求和认证信息  </li>
<li>预定义的 RoleBinding <code>cluster-admin</code> 将User <code>system:kube-proxy</code> 与 Role <code>system:node-proxier</code> 绑定，该 Role 授予了调用 <code>kube-apiserver</code> Proxy 相关 API 的权限</li>
</ul>
<p>启动 kube-proxy<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># cp kube-proxy.service /etc/systemd/system/</span></div><div class="line">[root@node1 ~]<span class="comment"># systemctl daemon-reload</span></div><div class="line">[root@node1 ~]<span class="comment"># systemctl enable kube-proxy</span></div><div class="line">[root@node1 ~]<span class="comment"># systemctl start kube-proxy</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># systemctl status kube-proxy</span></div><div class="line">● kube-proxy.service - Kubernetes Kube-Proxy Server</div><div class="line">   Loaded: loaded (/etc/systemd/system/kube-proxy.service; enabled; vendor preset: disabled)</div><div class="line">   Active: active (running) since Fri 2018-02-02 14:24:10 CST; 15s ago</div><div class="line">     Docs: https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line"> Main PID: 3660 (kube-proxy)</div><div class="line">   Memory: 8.7M</div><div class="line">   CGroup: /system.slice/kube-proxy.service</div><div class="line">           ‣ 3660 /usr/<span class="built_in">local</span>/bin/kube-proxy --bind-address=192.168.1.198 --hostname-override=192.168.1.198 --cluster-cidr=172.30.0.0/16 --kubeconfig=/etc/kubernetes/kube...</div><div class="line"></div><div class="line">Feb 02 14:24:10 node1.example.com kube-proxy[3660]: I0202 14:24:10.223982    3660 conntrack.go:98] Set sysctl <span class="string">'net/netfilter/nf_conntrack_tcp_timeout_established'</span> to 86400</div><div class="line">Feb 02 14:24:10 node1.example.com kube-proxy[3660]: I0202 14:24:10.224981    3660 conntrack.go:98] Set sysctl <span class="string">'net/netfilter/nf_conntrack_tcp_timeout_close_wait'</span> to 3600</div><div class="line">Feb 02 14:24:10 node1.example.com kube-proxy[3660]: I0202 14:24:10.225415    3660 config.go:202] Starting service config controller</div><div class="line">Feb 02 14:24:10 node1.example.com kube-proxy[3660]: I0202 14:24:10.225427    3660 controller_utils.go:1019] Waiting <span class="keyword">for</span> caches to sync <span class="keyword">for</span> service config controller</div><div class="line">Feb 02 14:24:10 node1.example.com kube-proxy[3660]: I0202 14:24:10.225514    3660 config.go:102] Starting endpoints config controller</div><div class="line">Feb 02 14:24:10 node1.example.com kube-proxy[3660]: I0202 14:24:10.225523    3660 controller_utils.go:1019] Waiting <span class="keyword">for</span> caches to sync <span class="keyword">for</span> endpoints config controller</div><div class="line">Feb 02 14:24:10 node1.example.com kube-proxy[3660]: I0202 14:24:10.325575    3660 controller_utils.go:1026] Caches are synced <span class="keyword">for</span> service config controller</div><div class="line">Feb 02 14:24:10 node1.example.com kube-proxy[3660]: I0202 14:24:10.325624    3660 proxier.go:984] Not syncing iptables until Services and Endpoints have been re...om master</div><div class="line">Feb 02 14:24:10 node1.example.com kube-proxy[3660]: I0202 14:24:10.326087    3660 controller_utils.go:1026] Caches are synced <span class="keyword">for</span> endpoints config controller</div><div class="line">Feb 02 14:24:10 node1.example.com kube-proxy[3660]: I0202 14:24:10.326163    3660 proxier.go:329] Adding new service port <span class="string">"default/kubernetes:https"</span> at 172.16.0.1:443/TCP</div><div class="line">Hint: Some lines were ellipsized, use <span class="_">-l</span> to show <span class="keyword">in</span> full.</div><div class="line">[root@node1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h5 id="验证集群功能"><a href="#验证集群功能" class="headerlink" title="验证集群功能"></a>验证集群功能</h5><p>定义文件:<br><a href="https://note.youdao.com/yws/api/personal/file/DBEF82CCEFC040ACAE8F919C9E381633?method=download&amp;shareKey=8f85df5224bf4e4a7480fd6dd60fd5d6" target="_blank" rel="external">nginx-ds.yml</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># cat nginx-ds.yml </span></div><div class="line">apiVersion: v1</div><div class="line">kind: Service</div><div class="line">metadata:</div><div class="line">  name: nginx-ds</div><div class="line">  labels:</div><div class="line">    app: nginx-ds</div><div class="line">spec:</div><div class="line">  <span class="built_in">type</span>: NodePort</div><div class="line">  selector:</div><div class="line">    app: nginx-ds</div><div class="line">  ports:</div><div class="line">  - name: http</div><div class="line">    port: 80</div><div class="line">    targetPort: 80</div><div class="line"></div><div class="line">---</div><div class="line"></div><div class="line">apiVersion: extensions/v1beta1</div><div class="line">kind: DaemonSet</div><div class="line">metadata:</div><div class="line">  name: nginx-ds</div><div class="line">  labels:</div><div class="line">    addonmanager.kubernetes.io/mode: Reconcile</div><div class="line">spec:</div><div class="line">  template:</div><div class="line">    metadata:</div><div class="line">      labels:</div><div class="line">        app: nginx-ds</div><div class="line">    spec:</div><div class="line">      containers:</div><div class="line">      - name: my-nginx</div><div class="line">        image: nginx:1.7.9</div><div class="line">        ports:</div><div class="line">        - containerPort: 80</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl create -f nginx-ds.yml</span></div></pre></td></tr></table></figure>
<p>检查各 Node 上的 Pod IP 连通性<br>当前k8s上有两个Node，在nginx-ds.yml中使用的是<code>DaemonSet</code>模式，所以会在每个Node上启动这个Pod<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#DaemonSet官方解释</span></div><div class="line">A DaemonSet ensures that all (or some) Nodes run a copy of a Pod. As nodes are added to the cluster, Pods are added to them. As nodes are removed from the cluster, those Pods are garbage collected. Deleting a DaemonSet will clean up the Pods it created.</div></pre></td></tr></table></figure></p>
<p>参考：<a href="https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/#what-is-a-daemonset" target="_blank" rel="external">https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/#what-is-a-daemonset</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#两个nginx容器的IP地址不同</span></div><div class="line">[root@master1 ~]<span class="comment"># kubectl get pods  -o wide</span></div><div class="line">NAME             READY     STATUS    RESTARTS   AGE       IP            NODE</div><div class="line">nginx-ds-9p9pl   1/1       Running   0          4s        172.30.57.2   192.168.1.198</div><div class="line">nginx-ds-tvp6b   1/1       Running   0          4s        172.30.41.2   192.168.1.199</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>检查服务 IP 和端口可达性<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get svc |grep nginx-ds</span></div><div class="line">nginx-ds     NodePort    172.16.117.40   &lt;none&gt;        80:8446/TCP   5m</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<ul>
<li>服务IP：172.16.117.40</li>
<li>服务端口：80</li>
<li>NodePort端口：8446</li>
</ul>
<p>在所有 Node 上执行，IP为nginx-ds的CLUSTER-IP(执行<code>kubectl get svc |grep nginx-ds</code>命令获取)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># curl 172.16.117.40</span></div></pre></td></tr></table></figure></p>
<p>检查服务的 NodePort 可达性<br>在外部机器的浏览器访问 <a href="http://192.168.1.198:8446/" target="_blank" rel="external">http://192.168.1.198:8446/</a><br><img src="https://note.youdao.com/yws/api/personal/file/58CE3B07349943BCAF3AD33C2186D3E0?method=download&amp;shareKey=2d79cfcc3db594d9e8beac43af44de55" alt="k8s_nginx"><br>预期输出 nginx 欢迎页面内容</p>
<h4 id="部署-kubedns-插件"><a href="#部署-kubedns-插件" class="headerlink" title="部署 kubedns 插件"></a>部署 kubedns 插件</h4><p>官方文件目录：kubernetes/cluster/addons/dns<br><a href="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/#pods-dns-config" target="_blank" rel="external">https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/#pods-dns-config</a>  </p>
<h5 id="系统预定义的-RoleBinding"><a href="#系统预定义的-RoleBinding" class="headerlink" title="系统预定义的 RoleBinding"></a>系统预定义的 RoleBinding</h5><p>预定义的 RoleBinding <code>system:kube-dns</code> 将 kube-system 命名空间的 <code>kube-dns</code> ServiceAccount 与 <code>system:kube-dns</code> Role 绑定， 该 Role 具有访问 kube-apiserver DNS 相关 API 的权限<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get clusterrolebindings system:kube-dns -o yaml</span></div><div class="line">apiVersion: rbac.authorization.k8s.io/v1</div><div class="line">kind: ClusterRoleBinding</div><div class="line">metadata:</div><div class="line">  annotations:</div><div class="line">    rbac.authorization.kubernetes.io/autoupdate: <span class="string">"true"</span></div><div class="line">  creationTimestamp: 2018-01-31T11:03:07Z</div><div class="line">  labels:</div><div class="line">    kubernetes.io/bootstrapping: rbac-defaults</div><div class="line">  name: system:kube-dns</div><div class="line">  resourceVersion: <span class="string">"86"</span></div><div class="line">  selfLink: /apis/rbac.authorization.k8s.io/v1/clusterrolebindings/system%3Akube-dns</div><div class="line">  uid: 51871810-0676-11e8-8cb0-1e2d0a5bc3f5</div><div class="line">roleRef:</div><div class="line">  apiGroup: rbac.authorization.k8s.io</div><div class="line">  kind: ClusterRole</div><div class="line">  name: system:kube-dns</div><div class="line">subjects:</div><div class="line">- kind: ServiceAccount</div><div class="line">  name: kube-dns</div><div class="line">  namespace: kube-system</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p><code>kubedns-controller.yaml</code> 中定义的 Pods 时使用了 <code>kubedns-sa.yaml</code> 文件定义的 <code>kube-dns</code> ServiceAccount，所以具有访问 kube-apiserver DNS 相关 API 的权限  </p>
<h5 id="配置-kube-dns-服务"><a href="#配置-kube-dns-服务" class="headerlink" title="配置 kube-dns 服务"></a>配置 kube-dns 服务</h5><p><a href="https://note.youdao.com/yws/api/personal/file/71B930661BD94F2495278744F67152ED?method=download&amp;shareKey=9545d5ea1a76180ceb41f96c8ad20e88" target="_blank" rel="external">busybox.yaml</a><br><a href="https://note.youdao.com/yws/api/personal/file/12BDDDB36A4E4C40BFBFCF45CA3136F5?method=download&amp;shareKey=e3dfda08a42733a5c60b05e86ece7e75" target="_blank" rel="external">kube-dns.yaml</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@master1 dns]<span class="comment"># pwd</span></div><div class="line">/root/dns</div><div class="line">[root@master1 dns]<span class="comment"># ls</span></div><div class="line">busybox.yaml  kube-dns.yaml</div><div class="line">[root@master1 dns]<span class="comment"># egrep -i 'clusterIP|image|domain|server=/cluster' kube-dns.yaml </span></div><div class="line">  clusterIP: 172.16.0.2</div><div class="line">        image: registry.cn-hangzhou.aliyuncs.com/google_containers/k8s-dns-kube-dns-amd64:1.14.7</div><div class="line">        - --domain=cluster.local.</div><div class="line">        image: registry.cn-hangzhou.aliyuncs.com/google_containers/k8s-dns-dnsmasq-nanny-amd64:1.14.7</div><div class="line">        - --server=/cluster.local/127.0.0.1<span class="comment">#10053</span></div><div class="line">        image: registry.cn-hangzhou.aliyuncs.com/google_containers/k8s-dns-sidecar-amd64:1.14.7</div><div class="line">[root@master1 dns]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<ul>
<li>需要将 <code>clusterIP</code> 设置为集群环境变量中变量 <code>CLUSTER_DNS_SVC_IP</code> 值，这个 IP 需要和 kubelet 的 <code>—cluster-dns</code> 参数值一致；</li>
</ul>
<p>配置 kube-dns Deployment  </p>
<ul>
<li><code>--domain</code> 为集群环境文档 变量 CLUSTER_DNS_DOMAIN 的值  </li>
<li>使用系统已经做了 RoleBinding 的 <code>kube-dns</code> ServiceAccount，该账户具有访问 kube-apiserver DNS 相关 API 的权限</li>
</ul>
<p>创建DNS<br><code>kubectl create -f kube-dns.yaml</code>创建dns，<code>kubectl delete -f kube-dns.yaml</code>删除dns<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl create -f dns/busybox.yaml</span></div><div class="line"></div><div class="line">[root@master1 ~]<span class="comment"># kubectl get pods -o wide</span></div><div class="line">NAME                               READY     STATUS    RESTARTS   AGE       IP            NODE</div><div class="line">busybox                            1/1       Running   0          19s       172.30.57.2   192.168.1.198</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl create -f dns/kube-dns.yaml</span></div><div class="line">[root@master1 ~]<span class="comment"># </span></div><div class="line">[root@master1 ~]<span class="comment"># kubectl get pods -o wide -n kube-system</span></div><div class="line">NAME                                    READY     STATUS    RESTARTS   AGE       IP            NODE</div><div class="line">kube-dns-9d8b5fb76-vz6ll                3/3       Running   0          1h        172.30.41.5   192.168.1.199</div><div class="line">[root@master1 ~]<span class="comment"># </span></div><div class="line">[root@master1 ~]<span class="comment"># kubectl get svc -o wide -n kube-system</span></div><div class="line">NAME                   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE       SELECTOR</div><div class="line">kube-dns               ClusterIP   172.16.0.2       &lt;none&gt;        53/UDP,53/TCP   1h        k8s-app=kube-dns</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>如果报错了，可以通过这条命令查看报错日志<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl describe pod kube-dns-9d8b5fb76-vz6ll --namespace=kube-system</span></div></pre></td></tr></table></figure></p>
<h5 id="创建nginx-服务测试dns"><a href="#创建nginx-服务测试dns" class="headerlink" title="创建nginx 服务测试dns"></a>创建nginx 服务测试dns</h5><p><a href="https://note.youdao.com/yws/api/personal/file/8782A994D7724D0988B354247623586A?method=download&amp;shareKey=54f9b7b40dd83181ad97d0f87a541c48" target="_blank" rel="external">nginx-deployment.yaml</a><br><a href="https://note.youdao.com/yws/api/personal/file/D71364D682964ECCB6B291105F5004DE?method=download&amp;shareKey=12e6ed9da3fe5b732853490da4267c32" target="_blank" rel="external">nginx-service.yaml</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl create -f nginx-deployment.yaml</span></div><div class="line">[root@master1 ~]<span class="comment"># kubectl create -f nginx-service.yaml</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get pods -o wide</span></div><div class="line">NAME                               READY     STATUS    RESTARTS   AGE       IP            NODE</div><div class="line">nginx-deployment<span class="_">-d</span>8d99448f-rb57v   1/1       Running   0          11m       172.30.41.2   192.168.1.199</div><div class="line">[root@master1 ~]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@master1 ~]<span class="comment"># kubectl get svc -o wide</span></div><div class="line">NAME            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)       AGE       SELECTOR</div><div class="line">kubernetes      ClusterIP   172.16.0.1       &lt;none&gt;        443/TCP       7d        &lt;none&gt;</div><div class="line">nginx-service   NodePort    172.16.215.237   &lt;none&gt;        88:8527/TCP   2d        app=nginx</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl exec busybox -it nslookup nginx-service</span></div><div class="line">Server:    172.16.0.2</div><div class="line">Address 1: 172.16.0.2 kube-dns.kube-system.svc.cluster.local</div><div class="line"></div><div class="line">Name:      nginx-service</div><div class="line">Address 1: 172.16.215.237 nginx-service.default.svc.cluster.local</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h4 id="部署-heapster-插件"><a href="#部署-heapster-插件" class="headerlink" title="部署 heapster 插件"></a>部署 heapster 插件</h4><p>heapster release下载页面：<a href="https://github.com/kubernetes/heapster/releases" target="_blank" rel="external">https://github.com/kubernetes/heapster/releases</a><br><a href="https://note.youdao.com/yws/api/personal/file/1D279E2FC1834C328D2A32586B1BA43E?method=download&amp;shareKey=7466236d2b9cb7747d6657d0b2da0392" target="_blank" rel="external">heapster-v1.5.0.tar.gz</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># wget https://codeload.github.com/kubernetes/heapster/tar.gz/v1.5.0 -O heapster-v1.5.0.tar.gz</span></div><div class="line">[root@master1 ~]<span class="comment"># tar -zxf heapster-v1.5.0.tar.gz</span></div><div class="line">[root@master1 ~]<span class="comment"># cd heapster-1.5.0/deploy/kube-config/influxdb</span></div><div class="line">[root@master1 influxdb]<span class="comment"># ls</span></div><div class="line">grafana.yaml  heapster.yaml  influxdb.yaml</div><div class="line">[root@master1 influxdb]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<h5 id="配置rbac"><a href="#配置rbac" class="headerlink" title="配置rbac"></a>配置rbac</h5><p><a href="https://note.youdao.com/yws/api/personal/file/CD179F4A7D4B47CA9F0FF2A55F033F6D?method=download&amp;shareKey=d80b32bb27faf201ba5ede4282aff019" target="_blank" rel="external">heapster-rbac.yaml</a><br>无需修改配置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 influxdb]<span class="comment"># pwd</span></div><div class="line">/root/heapster-1.5.0/deploy/kube-config/influxdb</div><div class="line">[root@master1 influxdb]<span class="comment"># kubectl create -f ../rbac/heapster-rbac.yaml</span></div></pre></td></tr></table></figure></p>
<p>如果不执行heapster-rbac.yaml文件，则会报下面的错误：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">E0518 06:08:09.927460       1 reflector.go:190] k8s.io/heapster/metrics/util/util.go:30: Failed to list *v1.Node: nodes is forbidden: User <span class="string">"system:serviceaccount:kube-system:heapster"</span> cannot list nodes at the cluster scope</div></pre></td></tr></table></figure></p>
<p>如果在启动docker容器时，一直处于<code>ContainerCreating</code>状态，且最后报下面的错误：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Warning  FailedCreatePodSandBox  34s (x11 over 43s)  kubelet, 192.168.1.204  Failed create pod sandbox.</div><div class="line">Normal   SandboxChanged          33s (x11 over 43s)  kubelet, 192.168.1.204  Pod sandbox changed, it will be killed and re-created.</div></pre></td></tr></table></figure></p>
<p>执行<code>journalctl --since 01:02:00 -u kubelet</code>查看日志发现，正在下载<code>registry.access.redhat.com/rhel7/pod-infrastructure:latest</code>docker镜像。<br>解决办法是：kube-node节点缺少<code>registry.access.redhat.com/rhel7/pod-infrastructure:latest</code>docker镜像。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker pull registry.access.redhat.com/rhel7/pod-infrastructure:latest</div></pre></td></tr></table></figure></p>
<h5 id="配置-influxdb-deployment"><a href="#配置-influxdb-deployment" class="headerlink" title="配置 influxdb-deployment"></a>配置 influxdb-deployment</h5><p><a href="https://note.youdao.com/yws/api/personal/file/BD2A861AB9B54032889A0C3D1E983190?method=download&amp;shareKey=516e9d2b54547090128c4c6d5aa220b5" target="_blank" rel="external">influxdb.yaml</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master1 influxdb]<span class="comment"># egrep -i 'image|nodeport' influxdb.yaml </span></div><div class="line">        image: lvanneo/heapster-influxdb-amd64:v1.1.1        <span class="comment">#修改image镜像</span></div><div class="line">  <span class="built_in">type</span>: NodePort</div><div class="line">[root@master1 influxdb]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 influxdb]<span class="comment"># pwd</span></div><div class="line">/root/heapster-1.5.0/deploy/kube-config/influxdb</div><div class="line">[root@master1 influxdb]<span class="comment"># kubectl create -f influxdb.yaml</span></div></pre></td></tr></table></figure>
<p>查看influxdb数据库集群地址和端口<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master1 influxdb]<span class="comment"># kubectl get svc -o wide -n kube-system</span></div><div class="line">NAME                  TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)         AGE       SELECTOR</div><div class="line">monitoring-influxdb   NodePort    172.16.38.42   &lt;none&gt;        8086:8898/TCP   14s       k8s-app=influxdb</div><div class="line">[root@master1 influxdb]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<h5 id="配置-heapster-deployment"><a href="#配置-heapster-deployment" class="headerlink" title="配置 heapster-deployment"></a>配置 heapster-deployment</h5><p><a href="https://note.youdao.com/yws/api/personal/file/92E6D9F454164EA1A1EAB607CF87B17D?method=download&amp;shareKey=02e9edb636da9a1807d040d9fcb5e01a" target="_blank" rel="external">heapster.yaml</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@master1 influxdb]<span class="comment"># egrep -i 'image:|source|sink' heapster.yaml </span></div><div class="line">        image: lvanneo/heapster-amd64:v1.3.0-beta.1            <span class="comment">#修改image镜像</span></div><div class="line">        - --source=kubernetes:https://192.168.1.195:6443      <span class="comment">#指定kube-apiserver认证地址</span></div><div class="line">        - --sink=influxdb:http://172.16.38.42:8086       <span class="comment">#指定influxdb数据库CLUSTER-IP地址</span></div><div class="line">[root@master1 influxdb]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 influxdb]<span class="comment"># pwd</span></div><div class="line">/root/heapster-1.5.0/deploy/kube-config/influxdb</div><div class="line">[root@master1 influxdb]<span class="comment"># kubectl create -f heapster.yaml</span></div></pre></td></tr></table></figure>
<p>查看heapster集群地址和端口<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">    [root@master1 influxdb]<span class="comment"># kubectl get svc -o wide -n kube-system</span></div><div class="line">NAME                  TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE       SELECTOR</div><div class="line">heapster              ClusterIP   172.16.202.225   &lt;none&gt;        80/TCP          12s       k8s-app=heapster</div><div class="line">[root@master1 influxdb]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<h5 id="配置-grafana-deployment"><a href="#配置-grafana-deployment" class="headerlink" title="配置 grafana-deployment"></a>配置 grafana-deployment</h5><p><a href="https://note.youdao.com/yws/api/personal/file/F2F784AEBF0145E2964FC3C412F6AB73?method=download&amp;shareKey=b94e4b769899c636ae4761f33b97afde" target="_blank" rel="external">grafana.yaml</a><br>修改如下配置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@master1 influxdb]<span class="comment"># egrep -i 'image|value: /|type: nodeport' grafana.yaml </span></div><div class="line">        image: lvanneo/heapster-grafana-amd64:v4.0.2           <span class="comment">#修改image镜像</span></div><div class="line">          <span class="comment"># value: /api/v1/namespaces/kube-system/services/monitoring-grafana/proxy    #默认</span></div><div class="line">          value: /         <span class="comment">#默认</span></div><div class="line">  <span class="built_in">type</span>: NodePort           <span class="comment">#去掉注释</span></div><div class="line">[root@master1 influxdb]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 influxdb]<span class="comment"># pwd</span></div><div class="line">/root/heapster-1.5.0/deploy/kube-config/influxdb</div><div class="line">[root@master1 influxdb]<span class="comment"># kubectl create -f grafana.yaml</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 influxdb]<span class="comment"># kubectl get svc -o wide -n kube-system</span></div><div class="line">NAME                  TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE       SELECTOR</div><div class="line">monitoring-grafana     NodePort    172.16.207.209   &lt;none&gt;        80:8642/TCP     31m       k8s-app=grafana</div></pre></td></tr></table></figure>
<p>检查 Deployment<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get deployments -n kube-system | grep -E 'heapster|monitoring'</span></div><div class="line">heapster              1         1         1            1           25m</div><div class="line">monitoring-grafana    1         1         1            1           53s</div><div class="line">monitoring-influxdb   1         1         1            1           28m</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>检查 Pods<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get pods -n kube-system -o wide </span></div><div class="line">NAME                                    READY     STATUS    RESTARTS   AGE       IP            NODE</div><div class="line">heapster-5<span class="built_in">fc</span>8f648dc-pn4lm               1/1       Running   0          1h        172.30.57.4   192.168.1.198</div><div class="line">monitoring-grafana-57b8fcd7b4-67r2j     1/1       Running   0          28m       172.30.57.5   192.168.1.198</div><div class="line">monitoring-influxdb-68d87d45f5-5d7qs    1/1       Running   0          1h        172.30.41.3   192.168.1.199</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>需要逐一检查下各docker的logs有没有报错信息  </p>
<h6 id="访问grafana"><a href="#访问grafana" class="headerlink" title="访问grafana"></a>访问grafana</h6><p>访问 <a href="http://192.168.1.198:8642/" target="_blank" rel="external">http://192.168.1.198:8642/</a><br>配置influxdb-datasource<br><img src="https://note.youdao.com/yws/api/personal/file/A4614D24871C427489359C1827DC7548?method=download&amp;shareKey=abbb42575786c75c1b28c88c32d985b7" alt="grafana"><br><img src="https://note.youdao.com/yws/api/personal/file/91D96DCEF1D849729511049E94482122?method=download&amp;shareKey=55ebe8b0392e107d9344d58f3bd7ede1" alt="grafana"><br><img src="https://note.youdao.com/yws/api/personal/file/66317BF04C6A4C8281095808373DD48E?method=download&amp;shareKey=82c36a103ee293f3bdc6c03c3b997674" alt="grafana"><br><img src="https://note.youdao.com/yws/api/personal/file/534929F4400246E7ACA46CEB42D4540D?method=download&amp;shareKey=0a8aa8882c217c30dabb72e8f9050480" alt="grafana"><br><img src="https://note.youdao.com/yws/api/personal/file/E765DF64401B40A7BA3ACC9EF4BFFB98?method=download&amp;shareKey=9e289a2a510957a395f3abb799f2601f" alt="grafana">  </p>
<h4 id="部署-dashboard-插件"><a href="#部署-dashboard-插件" class="headerlink" title="部署 dashboard 插件"></a>部署 dashboard 插件</h4><p><a href="https://note.youdao.com/yws/api/personal/file/A1CFC0139B514BF7B6C0CD3D6F53531B?method=download&amp;shareKey=c70aa3e74b26c22fa42337538f8fba36" target="_blank" rel="external">kubernetes-dashboard.yaml</a><br>通过rbac 认证<code>kind: ServiceAccount</code>调用认证文件(<code>/etc/kubernetes/bootstrap.kubeconfig</code>和<code>/etc/kubernetes/kube-proxy.kubeconfig</code>)，访问的接口<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># egrep -i 'image|apiserver|heapster-host|nodeport' kubernetes-dashboard.yaml </span></div><div class="line">        image: k8scn/kubernetes-dashboard-amd64:v1.8.0</div><div class="line">          - --apiserver-host=http://192.168.1.195:8080</div><div class="line">          - --heapster-host=http://172.16.202.225</div><div class="line">  <span class="built_in">type</span>: NodePort</div><div class="line">      <span class="comment">#nodePort: 38443    #k8s kind:server 可以使用nodePort指定端口</span></div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl create -f kubernetes-dashboard.yaml</span></div></pre></td></tr></table></figure>
<p>查看kubernetes-dashboard分配的Node<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get pod -o wide -n kube-system</span></div><div class="line">NAME                                    READY     STATUS    RESTARTS   AGE       IP            NODE</div><div class="line">kubernetes-dashboard-666fbbf977-v9vsh   1/1       Running   0          49s       172.30.41.4   192.168.1.199</div></pre></td></tr></table></figure></p>
<p>查看kubernetes-dashboard分配的 NodePort<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get svc -o wide -n kube-system</span></div><div class="line">NAME                   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE       SELECTOR</div><div class="line">kubernetes-dashboard   NodePort    172.16.59.24     &lt;none&gt;        443:8847/TCP    39m       k8s-app=kubernetes-dashboard</div></pre></td></tr></table></figure></p>
<ul>
<li>NodePort 8847映射到 dashboard pod 80端口  </li>
</ul>
<p>检查 controller<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl get deployment kubernetes-dashboard  -n kube-system</span></div><div class="line">NAME                   DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</div><div class="line">kubernetes-dashboard   1         1         1            1           15m</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>获取集群服务地址列表<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@master1 ~]<span class="comment"># kubectl cluster-info</span></div><div class="line">Kubernetes master is running at https://192.168.1.195:6443</div><div class="line">Heapster is running at https://192.168.1.195:6443/api/v1/namespaces/kube-system/services/heapster/proxy</div><div class="line">KubeDNS is running at https://192.168.1.195:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</div><div class="line">monitoring-grafana is running at https://192.168.1.195:6443/api/v1/namespaces/kube-system/services/monitoring-grafana/proxy</div><div class="line">monitoring-influxdb is running at https://192.168.1.195:6443/api/v1/namespaces/kube-system/services/monitoring-influxdb/proxy</div><div class="line"></div><div class="line">To further debug and diagnose cluster problems, use <span class="string">'kubectl cluster-info dump'</span>.</div><div class="line">[root@master1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<h5 id="访问dashboard"><a href="#访问dashboard" class="headerlink" title="访问dashboard"></a>访问dashboard</h5><p>kubernetes-dashboard 服务暴露了 NodePort，可以使用 <a href="http://NodeIP:nodePort" target="_blank" rel="external">http://NodeIP:nodePort</a> 地址访问 dashboard  </p>
<p>访问 <a href="https://192.168.1.199:8847" target="_blank" rel="external">https://192.168.1.199:8847</a> 访问k8s dashboard，经测试火狐浏览器可以，但360浏览器打不开，报404<br><img src="https://note.youdao.com/yws/api/personal/file/045DBC6BEB45413AAA3C638456310A02?method=download&amp;shareKey=f5da2b7cde024379197726cbd1cf86a5" alt="k8s-dashboard"><br><img src="https://note.youdao.com/yws/api/personal/file/C62DEA5E39544B70A3DE0F3C4286EAB6?method=download&amp;shareKey=0d549ebb275806b21dcfe84bfec751c2" alt="k8s-dashboard"><br><img src="https://note.youdao.com/yws/api/personal/file/64C58F5AE8284F75BEB4A3DACC7C9A8A?method=download&amp;shareKey=c60811cb5ac18d5a9bd86c903fdef485" alt="k8s-dashboard">  </p>
<p>如果不安装<code>Heapster/influxdb</code>等插件，k8s-dashboard不能展示<code>Pod</code>，<code>Nodes</code>的<code>CPU</code>，<code>内存</code>等 metric 图形  </p>
<h5 id="保存镜像"><a href="#保存镜像" class="headerlink" title="保存镜像"></a>保存镜像</h5><p>导出镜像<br><a href="https://pan.baidu.com/s/1sngFMlZ" target="_blank" rel="external">镜像保存在百度网盘packages目录，密码：nwzk</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">docker save k8scn/kubernetes-dashboard-amd64:v1.8.0 &gt; kubernetes-dashboard-amd64-v1.8.0.tar.gz</div><div class="line">docker save registry.cn-hangzhou.aliyuncs.com/google_containers/k8s-dns-sidecar-amd64:1.14.7 &gt; k8s-dns-sidecar-amd64-1.14.7.tar.gz</div><div class="line">docker save registry.cn-hangzhou.aliyuncs.com/google_containers/k8s-dns-kube-dns-amd64:1.14.7 &gt; k8s-dns-kube-dns-amd64-1.14.7.tar.gz</div><div class="line">docker save registry.cn-hangzhou.aliyuncs.com/google_containers/k8s-dns-dnsmasq-nanny-amd64:1.14.7 &gt; k8s-dns-dnsmasq-nanny-amd64-1.14.7.tar.gz</div><div class="line">docker save lvanneo/heapster-influxdb-amd64:v1.1.1 &gt; heapster-influxdb-amd64-v1.1.1.tar.gz</div><div class="line">docker save lvanneo/heapster-grafana-amd64:v4.0.2 &gt; heapster-grafana-amd64-v4.0.2.tar.gz</div><div class="line">docker save lvanneo/heapster-amd64:v1.3.0-beta.1 &gt; heapster-amd64-v1.3.0-beta.1.tar.gz</div><div class="line">docker save k8scn/kubernetes-dashboard-amd64:v1.8.0 &gt; kubernetes-dashboard-amd64-v1.8.0.tar.gz</div></pre></td></tr></table></figure></p>
<p>导入镜像<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker load -i kubernetes-dashboard-amd64-v1.8.0.tar.gz</div></pre></td></tr></table></figure></p>
<p>参考：<a href="https://github.com/opsnull/follow-me-install-kubernetes-cluster" target="_blank" rel="external">https://github.com/opsnull/follow-me-install-kubernetes-cluster</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2018/02/23/部署TLS-k8s/">http://www.yfshare.vip/2018/02/23/部署TLS-k8s/</a></p>
</div><script type="text/javascript" src="/js/share.js?v=2.0.0" async></script><a data-url="http://www.yfshare.vip/2018/02/23/部署TLS-k8s/" data-id="cjj5s3pxv00fc30m5rqqp686i" class="article-share-link">分享到</a><div class="tags"><a href="/tags/k8s/">k8s</a><a href="/tags/kubernetes/">kubernetes</a><a href="/tags/TLS/">TLS</a></div><div class="post-nav"><a href="/2018/03/14/Prometheus监控TLS-Kubernetes集群/" class="pre">Prometheus监控TLS Kubernetes集群</a><a href="/2018/01/11/自建docker私有仓库-Vmware-Harbor/" class="next">自建docker私有仓库(Vmware Harbor)</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论 「请确保 disqus.com 可以正常加载」</button></div><script>var disqus_shortname = 'yfshare';
var disqus_identifier = '2018/02/23/部署TLS-k8s/';
var disqus_title = '部署TLS k8s';
var disqus_url = 'http://www.yfshare.vip/2018/02/23/部署TLS-k8s/';
$('.btn_click_load').click(function() {
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  $('.btn_click_load').css('display','none');
});
$.ajax({
  url: 'https://disqus.com/favicon.ico',
  timeout: 3000,
  type: 'GET',
  success: (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    $('.btn_click_load').css('display','none');
  })(),
  error: function() {
    $('.btn_click_load').css('display','block');
  }
});</script><script id="dsq-count-scr" src="//yfshare.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Ansible/">Ansible</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Atlassian/">Atlassian</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Database/">Database</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ELK/">ELK</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Jenkins/">Jenkins</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/K8S/">K8S</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Security/">Security</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Virtualization/">Virtualization</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/WEB/">WEB</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Windows/">Windows</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Zabbix/">Zabbix</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/版本控制系统/">版本控制系统</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/06/30/部署Zabbix 3.4/">部署Zabbix 3.4</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/21/Ansible部署Jenkins环境/">Ansible部署Jenkins环境</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/28/k8s滚动升级-RollingUpdate/">k8s滚动升级(RollingUpdate)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/21/Ansible部署TLS-K8S/">Ansible部署TLS K8S</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/17/glusterfs做持久化存储/">glusterfs做持久化存储</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/14/Prometheus监控TLS-Kubernetes集群/">Prometheus监控TLS Kubernetes集群</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/02/23/部署TLS-k8s/">部署TLS k8s</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/11/自建docker私有仓库-Vmware-Harbor/">自建docker私有仓库(Vmware Harbor)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/20/The-Docker-of-Jira7-2-0-and-Confluence6-0-0/">The Docker of Jira7.2.0 and Confluence6.0.0</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/20/自建docker私有仓库-Registry/">自建docker私有仓库(Registry)</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://yfshare.blog.51cto.com/" title="酱油瓶 博客" target="_blank">酱油瓶 博客</a><ul></ul><a href="http://zerosre.com/" title="龙哥zero 博客" target="_blank">龙哥zero 博客</a><ul></ul><a href="http://renzhiyuan.blog.51cto.com/" title="任志远Ray 博客" target="_blank">任志远Ray 博客</a><ul></ul><a href="http://rongrong.njdgwl.com" title="浩子的 博客" target="_blank">浩子的 博客</a><ul></ul><a href="http://www.cnblogs.com/aresxin/" title="欣哥aresxin 博客" target="_blank">欣哥aresxin 博客</a><ul></ul><a href="http://securityit.cn/" title="万马奔腾" target="_blank">万马奔腾</a></div><div class="widget"><div class="widget-title"><i class="fa fa-external-resources"> 资源站</i></div><ul></ul><a href="http://mirror.symnds.com/distributions/CentOS-vault/" title="Centos镜像站" target="_blank">Centos镜像站</a><ul></ul><a href="http://www.rpmfind.net/" title="rpmfind mirror" target="_blank">rpmfind mirror</a><ul></ul><a href="http://rpm.org/" title="rpm.org" target="_blank">rpm.org</a><ul></ul><a href="http://rpm.pbone.net/" title="rpm search" target="_blank">rpm search</a><ul></ul><a href="http://download.chinaunix.net/" title="chinaunix download" target="_blank">chinaunix download</a><ul></ul><a href="http://www.anquanquan.info/" title="安全圈info" target="_blank">安全圈info</a><ul></ul><a href="http://source.tosimp.net/" title="Tosimp 资源站" target="_blank">Tosimp 资源站</a></div><div class="widget"><div class="widget-title"><i class="fa fa-external-music"> 音乐</i></div></div><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=371362&auto=1&height=66"></iframe><div class="widget"><div class="widget-title"><i class="fa fa-external-game"> 游戏</i></div><ul></ul><a href="/2048" title="2048小游戏" target="_blank">2048小游戏</a><ul></ul><a href="/tantanqiu" title="变色弹球跳台阶小游戏" target="_blank">变色弹球跳台阶小游戏</a></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//yfshare.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">Jack Wang Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=2.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=2.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=2.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?3890bdc1bfaccae9364479b65f36fbd2";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=2.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=2.0.0"></script></div></body></html>
<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Jack Wang Blog</title>
  <subtitle>Goals determine what you are going to be</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.yfshare.vip/"/>
  <updated>2017-12-14T15:19:01.478Z</updated>
  <id>http://www.yfshare.vip/</id>
  
  <author>
    <name>Jack Wang</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>The Redmine_svn of docker</title>
    <link href="http://www.yfshare.vip/2017/12/14/The-Redmine-svn-of-docker/"/>
    <id>http://www.yfshare.vip/2017/12/14/The-Redmine-svn-of-docker/</id>
    <published>2017-12-14T14:51:08.000Z</published>
    <updated>2017-12-14T15:19:01.478Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/APlayer.min.js"> </script><script src="/assets/js/DPlayer.min.js"> </script><p>The redmine + svn + apache2 of Docker 应用基于Debian系统部署，经改造后只需要 PULL+Compose后即可正常工作<br><a id="more"></a></p>
<h2 id="Supported-tags-and-respective-Dockerfile-links"><a href="#Supported-tags-and-respective-Dockerfile-links" class="headerlink" title="Supported tags and respective Dockerfile links"></a>Supported tags and respective Dockerfile links</h2><ul>
<li><code>latest</code>(<a href="https://github.com/yfshare/Docker/blob/master/Redmine_svn/Dockerfile" target="_blank" rel="external">latest/Dockerfile</a>)</li>
<li><code>3.4</code>(<a href="https://github.com/yfshare/Docker/blob/master/Redmine_svn/Dockerfile_3.4" target="_blank" rel="external">3.4/Dockerfile</a>)</li>
</ul>
<p>镜像地址：<a href="https://hub.docker.com/r/yfshare/redmine_svn/" target="_blank" rel="external">https://hub.docker.com/r/yfshare/redmine_svn/</a>  </p>
<h3 id="The-redmine-3-4-svn-apache2-of-Docker"><a href="#The-redmine-3-4-svn-apache2-of-Docker" class="headerlink" title="The redmine 3.4+svn+apache2 of Docker"></a>The redmine 3.4+svn+apache2 of Docker</h3><p>基于Docker hub里redmine 3.4（docker pull redmine:3.4）（<a href="https://hub.docker.com/_/redmine/" target="_blank" rel="external">https://hub.docker.com/_/redmine/</a> ）改造而成。</p>
<h4 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h4><p>使用到的环境变量有：  </p>
<ul>
<li><code>MYSQL_ROOT_PASSWORD</code>：MYSQL的ROOT密码，需要和REDMINE_DB_PASSWORD变量值一致</li>
<li><code>MYSQL_DATABASE</code>：MYSQL上创建存储redmine的库名</li>
<li><code>SVN_ROOT</code>：存储SVN REPO的父目录</li>
<li><code>SVN_DIR</code>：SVN REPO项目目录，一般放在变量SVN_ROOT下</li>
<li><code>REDMINE_DB_MYSQL</code>：存储REDMINE的MYSQL DOCKER容器名，建议不要修改；如果修改它同时也需要修改docker-compose</li>
<li><code>REDMINE_DB_PASSWORD</code>：REDMINE连接MYSQL Docker的密码，REDMINE_DB_PASSWORD需要和MYSQL_ROOT_PASSWORD密码一致</li>
<li><code>REDMINE_DB_ENCODING</code>：新建MYSQL库REDMINE的字符集</li>
<li><code>REDMINE_MAIL_ADDRESS</code>：发送REDMINE的邮件地址（configuration.yml）</li>
<li><code>REDMINE_MAIL_DOMAIN</code>：发送REDMINE的邮件域名（configuration.yml）</li>
<li><code>REDMINE_MAIL_USER</code>：发送REDMINE的邮件用户名（configuration.yml）</li>
<li><code>REDMINE_MAIL_PASSWD</code>：发送REDMINE的邮件密码（configuration.yml）</li>
<li>以上变量是在Dockerfile自定义的，如需要其他变量，请参考（<a href="https://hub.docker.com/_/redmine/" target="_blank" rel="external">https://hub.docker.com/_/redmine/</a> ） ，因调用的redmine:3.4，因此也支持它的变量</li>
</ul>
<h4 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cat Dockerfile</span></div><div class="line">FROM docker.io/redmine:3.4</div><div class="line">RUN apt-get update \</div><div class="line">    &amp;&amp; apt-get install -y subversion subversion-tools apache2 libapache2-svn apache2-utils vim \</div><div class="line">    &amp;&amp; useradd apache</div><div class="line"></div><div class="line">RUN <span class="built_in">echo</span> <span class="string">''</span> &gt;/tmp/main</div><div class="line">COPY configure /</div><div class="line"></div><div class="line">VOLUME /usr/src/redmine/files</div><div class="line"></div><div class="line">RUN <span class="built_in">echo</span> <span class="string">"[ ! -d \$&#123;SVN_DIR&#125; ] &amp;&amp; svnadmin create \$&#123;SVN_DIR&#125;"</span> &gt;&gt;/tmp/redmine_svn.sh \</div><div class="line">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"[ -d /Authconf ] &amp;&amp; mv /Authconf \$&#123;SVN_ROOT&#125;/ &amp;&amp; sed -i \"s#^password-db \= passwd#password-db \= \$&#123;SVN_ROOT&#125;\/Authconf\/passwd#g\" \$&#123;SVN_ROOT&#125;/Authconf/svnserve.conf &amp;&amp; sed -i \"s#^authz-db \= authz#authz-db \= \$&#123;SVN_ROOT&#125;\/Authconf\/authz#g\" \$&#123;SVN_ROOT&#125;/Authconf/svnserve.conf &amp;&amp; \mv \$&#123;SVN_ROOT&#125;/Authconf/svnserve.conf \$&#123;SVN_DIR&#125;/conf/"</span> &gt;&gt; /tmp/redmine_svn.sh \</div><div class="line">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"[ -f /dav_svn.conf ] &amp;&amp; mv /dav_svn.conf /etc/apache2/mods-enabled/ &amp;&amp; sed -i \"s#SVNPath SVN_DIR#SVNPath \$&#123;SVN_DIR&#125;#g\" /etc/apache2/mods-enabled/dav_svn.conf &amp;&amp; sed -i \"s#Location \/svn#Location \/\`echo \$&#123;SVN_DIR&#125; | awk -F '/' '&#123;print \$NF&#125;'\`#g\" /etc/apache2/mods-enabled/dav_svn.conf &amp;&amp; sed -i \"/Include the virtual host configurations/aServerName localhost\:80\" /etc/apache2/apache2.conf"</span> &gt;&gt; /tmp/redmine_svn.sh \</div><div class="line">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"[ -f /svnpass ] &amp;&amp;  mv /svnpass /etc/apache2/.svnpass"</span> &gt;&gt; /tmp/redmine_svn.sh \</div><div class="line">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"[ -f /dav_svn.authz ]&amp;&amp; mv /dav_svn.authz /etc/apache2/ &amp;&amp; sed -i \"s#SVN_DIR#\`echo \$&#123;SVN_DIR&#125; | awk -F '/' '&#123;print \$NF&#125;'\`#g\" /etc/apache2/dav_svn.authz"</span> &gt;&gt; /tmp/redmine_svn.sh \</div><div class="line">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"[ -f /configuration.yml ] &amp;&amp; \mv /configuration.yml /usr/src/redmine/config &amp;&amp; sed -i \"s#domain\: 'DOMAIN'#domain\: '\$&#123;REDMINE_MAIL_DOMAIN&#125;'#g\" /usr/src/redmine/config/configuration.yml &amp;&amp; sed -i \"s#address\: \\\"MAIL_ADDRESS\\\"#address\: \\\"\$&#123;REDMINE_MAIL_ADDRESS&#125;\\\"#g\" /usr/src/redmine/config/configuration.yml &amp;&amp; sed -i \"s#user_name\: 'MAILADDR'#user_name\: '\$&#123;REDMINE_MAIL_USER&#125;'#g\" /usr/src/redmine/config/configuration.yml &amp;&amp; sed -i \"s#password\: 'PASSWORD'#password\: '\$&#123;REDMINE_MAIL_PASSWD&#125;'#g\" /usr/src/redmine/config/configuration.yml"</span> &gt;&gt; /tmp/redmine_svn.sh \</div><div class="line">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"chown apache:apache \$&#123;SVN_ROOT&#125; -R &amp;&amp; chown apache:apache /etc/apache2 -R"</span> &gt;&gt; /tmp/redmine_svn.sh \</div><div class="line">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"/etc/init.d/apache2 start &amp;"</span> &gt;&gt; /tmp/redmine_svn.sh \</div><div class="line">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"svnserve -d -r \$&#123;SVN_ROOT&#125; --log-file \$&#123;SVN_ROOT&#125;/svn.log &amp;"</span> &gt;&gt;/tmp/redmine_svn.sh \</div><div class="line">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"sleep 5 &amp;&amp; /docker-entrypoint.sh rails server -b 0.0.0.0 &amp;"</span> &gt;&gt;/tmp/redmine_svn.sh \</div><div class="line">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"tail -f /tmp/main"</span> &gt;&gt;/tmp/redmine_svn.sh \</div><div class="line">    &amp;&amp; chmod +x /tmp/redmine_svn.sh</div><div class="line"></div><div class="line">EXPOSE 3000 3690 80</div><div class="line"></div><div class="line">ENTRYPOINT [<span class="string">"/bin/sh"</span>,<span class="string">"/tmp/redmine_svn.sh"</span>]</div><div class="line"><span class="comment">#</span></div></pre></td></tr></table></figure>
<h4 id="Docker-Compose"><a href="#Docker-Compose" class="headerlink" title="Docker Compose"></a>Docker Compose</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">version: <span class="string">'2'</span></div><div class="line">services:</div><div class="line">  db:</div><div class="line">    image: mysql:5.7</div><div class="line">    container_name: mysql</div><div class="line">    environment:</div><div class="line">      MYSQL_ROOT_PASSWORD: <span class="string">'example12'</span></div><div class="line">      MYSQL_DATABASE: redmine</div><div class="line">    ports:</div><div class="line">      - 3306:3306</div><div class="line">    volumes:</div><div class="line">      - /data/docker_mount/mysql:/var/lib/mysql</div><div class="line">    restart: always</div><div class="line"></div><div class="line">  redmine_svn:</div><div class="line">    image: yfshare/redmine_svn:3.4</div><div class="line">    container_name: redmine_svn</div><div class="line">    ports:</div><div class="line">      - 3000:3000</div><div class="line">      - 3690:3690</div><div class="line">      - 80:80</div><div class="line">    links:</div><div class="line">      - db</div><div class="line">    environment:</div><div class="line">      SVN_ROOT: <span class="string">'/usr/src/SvnRepos'</span></div><div class="line">      SVN_DIR: <span class="string">'/usr/src/SvnRepos/Soros'</span></div><div class="line">      REDMINE_DB_MYSQL: db</div><div class="line">      REDMINE_DB_PASSWORD: <span class="string">'example12'</span></div><div class="line">      REDMINE_DB_ENCODING: <span class="string">'utf8'</span></div><div class="line">      REDMINE_MAIL_ADDRESS: <span class="string">'smtp.exmail.qq.com'</span></div><div class="line">      REDMINE_MAIL_DOMAIN: <span class="string">'example.com'</span></div><div class="line">      REDMINE_MAIL_USER: <span class="string">'username'</span></div><div class="line">      REDMINE_MAIL_PASSWD: <span class="string">'password'</span></div><div class="line">    volumes:</div><div class="line">      - /data/docker_mount/redmine/files:/usr/src/redmine/files</div><div class="line">      - /data/docker_mount/SvnRepos:/usr/src/SvnRepos</div><div class="line">    restart: always</div></pre></td></tr></table></figure>
<h4 id="部署Docker"><a href="#部署Docker" class="headerlink" title="部署Docker"></a>部署Docker</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">docker pull yfshare/redmine_svn</div><div class="line">docker-compose <span class="_">-f</span> docker-redmine_svn_mysql.yml up <span class="_">-d</span></div></pre></td></tr></table></figure>
<h4 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h4><ul>
<li><p>在redmine载入默认配置时，请选择“English“，而不是”简体中文“ 否则报下面错误  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">无法载入默认设置：Mysql2::Error: Incorrect string value: <span class="string">'\xE7\xAE\xA1\xE7\x90\x86...'</span> <span class="keyword">for</span> column <span class="string">'name'</span> at row 1: INSERT INTO `roles` (`name`, `issues_visibility`, `position`) VALUES (<span class="string">'管理人员'</span>, <span class="string">'all'</span>, 1)</div></pre></td></tr></table></figure>
</li>
<li><p>redmine默认用户名密码为：<code>admin</code> / <code>admin</code></p>
</li>
<li>TortoiseSVN访问SVN默认用户名密码为：<code>svnadmin</code> / <code>administrator#!001</code></li>
<li>http访问SVN默认用户名密码为：<code>svnadmin</code> / <code>administrator#!001</code></li>
</ul>
<h3 id="The-redmine-latest-svn-apache2-of-Docker"><a href="#The-redmine-latest-svn-apache2-of-Docker" class="headerlink" title="The redmine latest+svn+apache2 of Docker"></a>The redmine latest+svn+apache2 of Docker</h3><h4 id="不同点"><a href="#不同点" class="headerlink" title="不同点"></a>不同点</h4><ul>
<li>其他与The redmine 3.4+svn+apache2 of Docker相同，不同的是在build时取消了FROM docker.io/redmine版本号，此时会拉取最新的版本，同时docker-compose也要去掉版本号即可</li>
</ul>
<h4 id="Docker-Compose-1"><a href="#Docker-Compose-1" class="headerlink" title="Docker Compose"></a>Docker Compose</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">version: <span class="string">'2'</span></div><div class="line">services:</div><div class="line">  db:</div><div class="line">    image: mysql</div><div class="line">    container_name: mysql</div><div class="line">    environment:</div><div class="line">      MYSQL_ROOT_PASSWORD: <span class="string">'example12'</span></div><div class="line">      MYSQL_DATABASE: redmine</div><div class="line">    ports:</div><div class="line">      - 3306:3306</div><div class="line">    volumes:</div><div class="line">      - /data/docker_mount/mysql:/var/lib/mysql</div><div class="line">    restart: always</div><div class="line"></div><div class="line">  redmine_svn:</div><div class="line">    image: yfshare/redmine_svn</div><div class="line">    container_name: redmine_svn</div><div class="line">    ports:</div><div class="line">      - 3000:3000</div><div class="line">      - 3690:3690</div><div class="line">      - 80:80</div><div class="line">    links:</div><div class="line">      - db</div><div class="line">    environment:</div><div class="line">      SVN_ROOT: <span class="string">'/usr/src/SvnRepos'</span></div><div class="line">      SVN_DIR: <span class="string">'/usr/src/SvnRepos/Soros'</span></div><div class="line">      REDMINE_DB_MYSQL: db</div><div class="line">      REDMINE_DB_PASSWORD: <span class="string">'example12'</span></div><div class="line">      REDMINE_DB_ENCODING: <span class="string">'utf8'</span></div><div class="line">      REDMINE_MAIL_ADDRESS: <span class="string">'smtp.exmail.qq.com'</span></div><div class="line">      REDMINE_MAIL_DOMAIN: <span class="string">'example.com'</span></div><div class="line">      REDMINE_MAIL_USER: <span class="string">'username'</span></div><div class="line">      REDMINE_MAIL_PASSWD: <span class="string">'password'</span></div><div class="line">    volumes:</div><div class="line">      - /data/docker_mount/redmine/files:/usr/src/redmine/files</div><div class="line">      - /data/docker_mount/SvnRepos:/usr/src/SvnRepos</div><div class="line">    restart: always</div></pre></td></tr></table></figure>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#编译Dockerfile生成Docker images</span></div><div class="line">docker build -t yfshare/redmine_svn <span class="_">-f</span> Dockerfile .</div><div class="line"></div><div class="line"><span class="comment">#拉取镜像</span></div><div class="line">docker pull yfshare/redmine_svn</div><div class="line"></div><div class="line"><span class="comment">#使用docker-compose 生成docker容器</span></div><div class="line">docker-compose <span class="_">-f</span> docker-redmine_svn_mysql.yml up <span class="_">-d</span></div></pre></td></tr></table></figure>
<p>然后</p>
<ul>
<li>通过 <code>http://localhost:3000</code>访问Redmine</li>
<li><code>http://localhost/SvnRepos</code>通过WEB界面访问SVN</li>
<li>通过 TortoiseSVN <code>svn://localhost:3690/SvnRepos</code> 访问SVN</li>
<li>通过<code>3306</code>端口访问mysql  </li>
</ul>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/12/14/The-Redmine-svn-of-docker/">http://www.yfshare.vip/2017/12/14/The-Redmine-svn-of-docker/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;The redmine + svn + apache2 of Docker 应用基于Debian系统部署，经改造后只需要 PULL+Compose后即可正常工作&lt;br&gt;
    
    </summary>
    
      <category term="Docker" scheme="http://www.yfshare.vip/categories/Docker/"/>
    
    
      <category term="Mysql" scheme="http://www.yfshare.vip/tags/Mysql/"/>
    
      <category term="Docker" scheme="http://www.yfshare.vip/tags/Docker/"/>
    
      <category term="Redmine" scheme="http://www.yfshare.vip/tags/Redmine/"/>
    
      <category term="Svn" scheme="http://www.yfshare.vip/tags/Svn/"/>
    
      <category term="Apache" scheme="http://www.yfshare.vip/tags/Apache/"/>
    
  </entry>
  
  <entry>
    <title>关于kernel: nf_conntrack: table full, dropping packet问题</title>
    <link href="http://www.yfshare.vip/2017/12/05/%E5%85%B3%E4%BA%8Ekernel-nf-conntrack-table-full-dropping-packet%E9%97%AE%E9%A2%98/"/>
    <id>http://www.yfshare.vip/2017/12/05/关于kernel-nf-conntrack-table-full-dropping-packet问题/</id>
    <published>2017-12-05T14:01:25.000Z</published>
    <updated>2017-12-05T14:06:57.191Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/APlayer.min.js"> </script><script src="/assets/js/DPlayer.min.js"> </script><p><code>/var/log/messages</code>报错信息：<code>kernel: nf_conntrack: table full, dropping packet</code><br><a id="more"></a><br>问题背景：公司线上活动（可以理解为秒杀）瞬时流量比平时高好几倍，目前最高瞬时流量为25W/秒(requests)，最低时瞬时流量为6W/秒(requests)<br>而<code>/var/log/messages</code>日志一直报上述错误，直到活动结束  </p>
<p>当时，深刻了解到iptables的这个报错，会造成拒绝服务的问题。查资料后，需要关闭iptables，但服务器在阿里云VPC网络内，使用的是阿里云的安全组策略，故iptables没有打开。后排查，虽iptables和firewalld没开，但是Centos7 还是加载了这个<code>nf_conntrack</code>模块，而导致出现了上面这个问题。  </p>
<p>网上说有三种方法，分别为：  </p>
<ul>
<li>修改参数法</li>
<li>使用RAW表，跳过记录法</li>
<li>移除模块法</li>
</ul>
<p>因服务器没有使用iptables和firewalld，故采用的是<code>移除模块法</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># /sbin/lsmod | egrep 'ip_tables|conntrack'</span></div><div class="line">nf_conntrack_ipv4      19108  2 </div><div class="line">nf_defrag_ipv4         12729  1 nf_conntrack_ipv4</div><div class="line">xt_conntrack           12760  1 </div><div class="line">nf_conntrack          111302  5 nf_nat,nf_nat_ipv4,xt_conntrack,nf_nat_masquerade_ipv4,nf_conntrack_ipv4</div><div class="line">ip_tables              27115  2 iptable_filter,iptable_nat</div><div class="line"><span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p><code>state</code>模块和<code>nf_conntrack</code>之间是有依赖关系，想要卸载<code>nf_conntrack</code>模块的话，必须也要把<code>state</code>模块移除，不然，其会自动启用nf_conntrack模块。  </p>
<p>卸载模块前需要先关闭iptables和firewalld，如果发现firewalld或iptables没有启用，但是卸载模块时，还是提示模块正在使用，则把iptables或firewalld启动后再关闭，再尝试卸载模块。  </p>
<p>操作方法如下：  </p>
<ul>
<li>先将/etc/sysconfig/iptables 中包含state的语句移除，并restart iptables</li>
<li>执行语句<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#这里是参考文档作者的</span></div><div class="line">modprobe -r xt_NOTRACK nf_conntrack_netbios_ns nf_conntrack_ipv4 xt_state</div><div class="line">modprobe -r nf_conntrack</div><div class="line"></div><div class="line"><span class="comment">#这里是我实际卸载的模块</span></div><div class="line">modprobe -r nf_conntrack_netbios_ns xt_state</div><div class="line">modprobe -r nf_conntrack</div></pre></td></tr></table></figure>
</li>
</ul>
<p>执行完查看/proc/net/ 下面如果没用了 nf_conntrack ，就证明模块移除成功了  </p>
<p>总结（以下摘录原文作者）：<br>以上三种方法种，如果像<code>web这样的操作访问量并发不大</code>的情况下，建议通过第一种方法实现。因为nf_conntrack模块的作用不仅仅只用于记录状态，iptables还可以通过对该模块的使有达到动态过滤的作用。如我在用ab动测试的一台服务器上进行并发模拟时，在/var/log/message里发现如下的日志<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Apr 22 15:21:46 localhost kernel: possible SYN flooding on port 80. Sending cookies.</div><div class="line">Apr 22 15:22:46 localhost kernel: possible SYN flooding on port 80. Sending cookies.</div></pre></td></tr></table></figure></p>
<p>而此时iptables会智能的将发动SYN flood攻击的IP暂时拒绝掉<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ab -c 500 -n 5000 "http://192.168.10.177/"</span></div><div class="line">This is ApacheBench, Version 2.0.40-dev &lt;<span class="variable">$Revision</span>: 1.146 $&gt; apache-2.0</div><div class="line">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</div><div class="line">Copyright 2006 The Apache Software Foundation, http://www.apache.org/</div><div class="line">Benchmarking 192.168.10.177 (be patient)</div><div class="line">apr_socket_recv: Connection reset by peer (104)</div><div class="line">Total of 68 requests completed</div></pre></td></tr></table></figure></p>
<p>如上所以，我用ab操作时，其就会收到apr_socket_recv 的错误提示 。我在网上查询到其具体实现的原理如下：  </p>
<ul>
<li><p>传统的防火墙只能进行静态过滤，而 iptables 除了这个基本的功能之外还可以进行动态过滤，即可以对连接状态进行跟踪，通常称为 conntrack 。 但这不意味着它只能对 TCP 这样的面向连接的协议有效，它还可以对 UDP， ICMP 这种无连接的协议进行跟踪。  </p>
</li>
<li><p>iptables 中的连接跟踪是通过 state 模块来实现的，是在PREROUTING 链中完成的，除了本地主机产生的数据包，它们是在 OUTPUT 链中完成。 它把“连接”划分为四种状态：NEW， ESTABLISHED， RELATED 和 INVALID。连接跟踪当前的所有连接状态可以通过 /proc/net/nf_conntrack 来查看（注意，在一些稍微旧的 Linux 系统上是 /proc/net/ip_conntrack）  </p>
</li>
<li>当 conntrack 第一次看到相关的数据包时，就会把状态标记为 NEW ，比如 TCP 协议中收到第一个 SYN 数据包。当连接的双方都有数据包收发并且还将继续匹配到这些数据包时，连接状态就会变为 ESTABLISHED 。而 RELATED 状态是指一个新的连接，但这个连接和某个已知的连接有关系，比如 FTP 协议中的数据传输连接。INVALID 状态是说数据包和已知的任何连接都不匹配</li>
</ul>
<p>当然，仅仅利用iptables conntrack自动实现syn flood 等DDOS攻击时很弱的。而现成的动态过滤和DDOS防护的方法是很多的。比如netstat脚本实现，iptalbes限制每秒进行连接数，nginx/apache的连接数限制模块及fail2ban日志分析法………… ，所以在具有以上防护的情况下，非常推荐将web 、squid/varnish等应用所在的服务器配置为RAW方式 。我在现网一台150M/S 的cache server上将80和3128两个端口全部NOTRACK之后，conntrack hash表由瞬满直线下降到只有几百条。<br>最后，最不推荐使用的第三种方法，因为第三种方法会将state模块也一块儿移除掉。  </p>
<p>参考：<br><a href="http://www.361way.com/ip_conntrack-tablefull/1717.html" target="_blank" rel="external">http://www.361way.com/ip_conntrack-tablefull/1717.html</a><br><a href="http://www.361way.com/%E5%86%8D%E7%9C%8Bnf_conntrack-table-full%E9%97%AE%E9%A2%98/2404.html" target="_blank" rel="external">http://www.361way.com/%E5%86%8D%E7%9C%8Bnf_conntrack-table-full%E9%97%AE%E9%A2%98/2404.html</a><br><a href="http://jaseywang.me/2012/08/16/%E8%A7%A3%E5%86%B3-nf_conntrack-table-full-dropping-packet-%E7%9A%84%E5%87%A0%E7%A7%8D%E6%80%9D%E8%B7%AF/" target="_blank" rel="external">http://jaseywang.me/2012/08/16/%E8%A7%A3%E5%86%B3-nf_conntrack-table-full-dropping-packet-%E7%9A%84%E5%87%A0%E7%A7%8D%E6%80%9D%E8%B7%AF/</a><br><a href="https://wiki.khnet.info/index.php/Conntrack_tuning" target="_blank" rel="external">https://wiki.khnet.info/index.php/Conntrack_tuning</a><br><a href="http://blog.zol.com.cn/2608/article_2607945.html" target="_blank" rel="external">http://blog.zol.com.cn/2608/article_2607945.html</a><br><a href="http://blog.csdn.net/dog250/article/details/7262619" target="_blank" rel="external">http://blog.csdn.net/dog250/article/details/7262619</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/12/05/关于kernel-nf-conntrack-table-full-dropping-packet问题/">http://www.yfshare.vip/2017/12/05/关于kernel-nf-conntrack-table-full-dropping-packet问题/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;code&gt;/var/log/messages&lt;/code&gt;报错信息：&lt;code&gt;kernel: nf_conntrack: table full, dropping packet&lt;/code&gt;&lt;br&gt;
    
    </summary>
    
      <category term="Linux" scheme="http://www.yfshare.vip/categories/Linux/"/>
    
    
      <category term="Kernel" scheme="http://www.yfshare.vip/tags/Kernel/"/>
    
      <category term="nf_conntrack" scheme="http://www.yfshare.vip/tags/nf-conntrack/"/>
    
      <category term="dropping packet" scheme="http://www.yfshare.vip/tags/dropping-packet/"/>
    
  </entry>
  
  <entry>
    <title>ElasticSearch集群(基础)</title>
    <link href="http://www.yfshare.vip/2017/12/04/ElasticSearch%E9%9B%86%E7%BE%A4-%E5%9F%BA%E7%A1%80/"/>
    <id>http://www.yfshare.vip/2017/12/04/ElasticSearch集群-基础/</id>
    <published>2017-12-04T15:36:21.000Z</published>
    <updated>2017-12-18T13:12:38.663Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/APlayer.min.js"> </script><script src="/assets/js/DPlayer.min.js"> </script><p>这里分享的是ELK集群基础安装文档，<a href="http://www.yfshare.vip/2017/11/22/ELK%E5%AE%89%E8%A3%85-%E5%9F%BA%E7%A1%80/">这里是 ELK安装基础</a><br><a id="more"></a><br>环境：Centos 6.6<br>　　　ElasticSearch 5.1.1<br>　　　Logstash 5.1.1<br>　　　Kibana 5.1.1  </p>
<h4 id="安装集群管理软件"><a href="#安装集群管理软件" class="headerlink" title="安装集群管理软件"></a>安装集群管理软件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#安装ElasticSearch</span></div><div class="line">[root@ELK ~]<span class="comment"># yum -y install elasticsearch-5.1.1.rpm</span></div><div class="line"></div><div class="line"><span class="comment">#ELK node1配置</span></div><div class="line">[root@ELK ~]<span class="comment"># mkdir /etc/elasticsearch/data -p</span></div><div class="line">[root@ELK ~]<span class="comment"># id elasticsearch</span></div><div class="line">uid=498(elasticsearch) gid=499(elasticsearch) groups=499(elasticsearch)</div><div class="line">[root@ELK ~]<span class="comment"># chgrp elasticsearch /etc/elasticsearch/data/ -R</span></div><div class="line">[root@ELK ~]<span class="comment"># chmod 775 /etc/elasticsearch/data/ -R</span></div><div class="line">[root@ELK ~]<span class="comment"># java -version</span></div><div class="line">java version <span class="string">"1.8.0_112"</span></div><div class="line">Java(TM) SE Runtime Environment (build 1.8.0_112-b15)</div><div class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.112-b15, mixed mode)</div><div class="line">[root@ELK ~]<span class="comment"># ln -s /usr/local/jdk1.8.0_112/bin/java /usr/bin/</span></div><div class="line"></div><div class="line">[root@ELK ~]<span class="comment"># grep -v ^# /etc/elasticsearch/elasticsearch.yml | grep -v ^$</span></div><div class="line">cluster.name: <span class="string">"ES-cluster"</span></div><div class="line">node.name: <span class="string">"es-node01"</span></div><div class="line">node.master: <span class="literal">true</span></div><div class="line">node.data: <span class="literal">true</span></div><div class="line">http.enabled: <span class="literal">true</span></div><div class="line">path.data: /etc/elasticsearch/data</div><div class="line">path.logs: /var/<span class="built_in">log</span>/elasticsearch</div><div class="line">network.host: 0.0.0.0</div><div class="line">http.port: 9200</div><div class="line">http.cors.enabled: <span class="literal">true</span></div><div class="line">http.cors.allow-origin: <span class="string">"*"</span></div><div class="line">discovery.zen.ping.unicast.hosts: [<span class="string">"192.168.31.100"</span>, <span class="string">"192.168.31.110"</span>]</div><div class="line">discovery.zen.minimum_master_nodes: 1</div><div class="line"><span class="comment">#discovery.zen.minimum_master_nodes（默认是1）：这个参数控制的是，一个节点需要看到的具有master节点资格的最小数量，然后才能在集群中做操作。官方的推荐值是(N/2)+1，其中N是具有master资格的节点的数量（我们的情况是3，因此这个参数设置为2，但对于只有2个节点的情况，设置为2就有些问题了，一个节点DOWN掉后，你肯定连不上2台服务器了，这点需要注意）</span></div><div class="line">gateway.recover_after_nodes: 2</div><div class="line">[root@ELK ~]<span class="comment">#</span></div><div class="line">[root@ELK ~]<span class="comment"># /etc/init.d/elasticsearch start</span></div><div class="line">[root@ELK ~]<span class="comment"># netstat -tunlp | grep 9200</span></div><div class="line">tcp        0      0 :::9200                     :::*                        LISTEN      33156/java          </div><div class="line">[root@ELK ~]<span class="comment"># netstat -tunlp | grep 9300</span></div><div class="line">tcp        0      0 :::9300                     :::*                        LISTEN      33156/java          </div><div class="line">[root@ELK ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#ELK node2配置</span></div><div class="line"><span class="comment">#node2配置和node1配置相同(略)</span></div></pre></td></tr></table></figure>
<h4 id="测试集群状态"><a href="#测试集群状态" class="headerlink" title="测试集群状态"></a>测试集群状态</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">[root@ELK ~]<span class="comment"># curl localhost:9200/_cat/nodes?v     #获取集群中节点列表</span></div><div class="line">ip             heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name</div><div class="line">192.168.31.100            4          81  99    4.32    3.28     3.46 mdi       -      es-node01</div><div class="line">192.168.31.110            3          94   5    0.07    0.03     0.01 mdi       *      es-node02</div><div class="line">[root@ELK ~]<span class="comment"># </span></div><div class="line">[root@ELK ~]<span class="comment"># curl localhost:9200/_cat/health?v    #集群健康检查</span></div><div class="line">epoch      timestamp cluster    status node.total node.data shards pri relo init unassign pending_tasks max_task_wait_time active_shards_percent</div><div class="line">1482982586 11:36:26  ES-cluster green           2         2     22  11    0    0        0             0                  -                100.0%</div><div class="line">[root@ELK ~]<span class="comment">#</span></div><div class="line">[root@ELK ~]<span class="comment"># curl 'localhost:9200/_cat/indices?v'  #获取ElasticSearch索引</span></div><div class="line">health status index                       uuid                   pri rep docs.count docs.deleted store.size pri.store.size</div><div class="line">green  open   logstash-message-2016.12.29 qkvr3jmWQei1oBhEy9VnCA   5   1         28            0    376.3kb        188.1kb</div><div class="line">green  open   logstash-nginx-2016.12.29   B9p9qwjsTlaE4<span class="built_in">fc</span>ZcIgJag   5   1          5            0      104kb           52kb</div><div class="line">green  open   .kibana                     bNLdONDMRdWK2-HdYkUuAA   1   1          3            0     34.1kb           17kb</div><div class="line">[root@ELK ~]<span class="comment">#</span></div><div class="line"></div><div class="line">//注：当ElasticSearch配置完成后，node2会复制node1的索引</div><div class="line">[root@ELK2 ~]<span class="comment"># curl 'localhost:9200/_cat/indices?v'</span></div><div class="line">health status index                       uuid                   pri rep docs.count docs.deleted store.size pri.store.size</div><div class="line">green  open   logstash-message-2016.12.29 qkvr3jmWQei1oBhEy9VnCA   5   1         28            0    376.3kb        188.1kb</div><div class="line">green  open   .kibana                     bNLdONDMRdWK2-HdYkUuAA   1   1          3            0     34.1kb           17kb</div><div class="line">green  open   logstash-nginx-2016.12.29   B9p9qwjsTlaE4<span class="built_in">fc</span>ZcIgJag   5   1          5            0      104kb           52kb</div><div class="line">[root@ELK2 ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#ElasticSearch集群日志文件位置：</span></div><div class="line">[root@ELK ~]<span class="comment"># ls /var/log/elasticsearch/</span></div><div class="line">ES-cluster_deprecation.log             ES-cluster_index_search_slowlog.log</div><div class="line">ES-cluster_index_indexing_slowlog.log  ES-cluster.log</div><div class="line">[root@ELK ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h4 id="安装elasticsearch-head插件"><a href="#安装elasticsearch-head插件" class="headerlink" title="安装elasticsearch-head插件"></a>安装elasticsearch-head插件</h4><p>由于Elasticsearch 5.0 head插件不能以插件形式安装，因此需要单独安装<br>参考：<a href="https://github.com/mobz/elasticsearch-head" target="_blank" rel="external">https://github.com/mobz/elasticsearch-head</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">Running as a plugin of Elasticsearch</div><div class="line"></div><div class="line">Install elasticsearch-head:</div><div class="line">– <span class="keyword">for</span> Elasticsearch 5.x:</div><div class="line">site plugins are not supported. Run elasticsearch-head as a standalone server</div><div class="line">– <span class="keyword">for</span> Elasticsearch 2.x – 4.x:</div><div class="line">sudo elasticsearch/bin/plugin install mobz/elasticsearch-head</div><div class="line">– <span class="keyword">for</span> Elasticsearch 1.x:</div><div class="line">sudo elasticsearch/bin/plugin -install mobz/elasticsearch-head/1.x</div><div class="line">– <span class="keyword">for</span> Elasticsearch 0.9:</div><div class="line">sudo elasticsearch/bin/plugin -install mobz/elasticsearch-head/0.9</div><div class="line">open http://localhost:9200/_plugin/head/</div><div class="line"></div><div class="line">Running with built <span class="keyword">in</span> server：</div><div class="line"><span class="built_in">enable</span> cors by adding http.cors.enabled: <span class="literal">true</span> <span class="keyword">in</span> elasticsearch configuration. Don’t forget to also <span class="built_in">set</span> http.cors.allow-origin because no origin allowed by default. http.cors.allow-origin: <span class="string">"*"</span> is valid value, however it’s considered as a security risk as your cluster is open to cross origin from anywhere. Check Elasticsearch documentation on this parameter: https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-http.html<span class="comment">#modules-http</span></div><div class="line">git <span class="built_in">clone</span> git://github.com/mobz/elasticsearch-head.git</div><div class="line"><span class="built_in">cd</span> elasticsearch-head</div><div class="line">npm install</div><div class="line">grunt server</div><div class="line">open http://localhost:9100/</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#npm命令需要安装nodejs</span></div><div class="line">[root@ELK ~]<span class="comment"># wget https://nodejs.org/dist/v0.12.16/node-v0.12.16.tar.gz</span></div><div class="line">[root@ELK ~]<span class="comment"># tar -zxf node-v0.12.16.tar.gz </span></div><div class="line">[root@ELK ~]<span class="comment"># cd node-v0.12.16</span></div><div class="line">[root@ELK node-v0.12.16]<span class="comment">#</span></div><div class="line">[root@ELK node-v0.12.16]<span class="comment"># ./configure --prefix=/usr/local/node-v0.12.16</span></div><div class="line">[root@ELK node-v0.12.16]<span class="comment"># make &amp;&amp; make install</span></div><div class="line">[root@ELK ~]<span class="comment"># ls -l /usr/local/node-v0.12.16/bin/npm</span></div><div class="line">lrwxrwxrwx 1 root root 38 Dec 28 12:43 /usr/<span class="built_in">local</span>/node-v0.12.16/bin/npm -&gt; ../lib/node_modules/npm/bin/npm-cli.js</div><div class="line">[root@ELK ~]<span class="comment"># ln -s /usr/local/node-v0.12.16/bin/npm /usr/bin/</span></div><div class="line">[root@ELK ~]<span class="comment"># ll /usr/bin/npm </span></div><div class="line">lrwxrwxrwx 1 root root 32 Dec 28 14:31 /usr/bin/npm -&gt; /usr/<span class="built_in">local</span>/node-v0.12.16/bin/npm</div><div class="line">[root@ELK ~]<span class="comment">#</span></div><div class="line">[root@ELK ~]<span class="comment"># ln -s /usr/local/node-v0.12.16/bin/node /usr/bin/</span></div><div class="line">[root@ELK ~]<span class="comment"># ll /usr/bin/node </span></div><div class="line">lrwxrwxrwx 1 root root 33 Dec 28 15:06 /usr/bin/node -&gt; /usr/<span class="built_in">local</span>/node-v0.12.16/bin/node</div><div class="line">[root@ELK ~]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@ELK ~]<span class="comment"># yum -y install git</span></div><div class="line">[root@ELK ~]<span class="comment"># cd /usr/local/</span></div><div class="line">[root@ELK <span class="built_in">local</span>]<span class="comment"># git clone git://github.com/mobz/elasticsearch-head.git</span></div><div class="line">[root@ELK <span class="built_in">local</span>]<span class="comment"># cd elasticsearch-head</span></div><div class="line">[root@ELK elasticsearch-head]<span class="comment"># npm install</span></div><div class="line"><span class="comment">#如果在elasticsearch-head目录下node_modules/grunt下如果没有grunt二进制程序，则需要执行</span></div><div class="line">[root@ELK ~]<span class="comment"># cd /usr/local/elasticsearch-head/</span></div><div class="line">[root@ELK elasticsearch-head]<span class="comment"># npm install grunt --save</span></div><div class="line">[root@ELK elasticsearch-head]<span class="comment"># ls</span></div><div class="line">Dockerfile                          grunt_fileSets.js  node_modules                  README.textile  <span class="built_in">test</span></div><div class="line">elasticsearch-head.sublime-project  index.html         package.json                  _site</div><div class="line">Gruntfile.js                        LICENCE            plugin-descriptor.properties  src</div><div class="line">[root@ELK elasticsearch-head]<span class="comment"># ls -l node_modules/grunt/bin/grunt</span></div><div class="line">-rwxr-xr-x 1 root root 53 Apr  6  2016 node_modules/grunt/bin/grunt</div><div class="line">[root@ELK elasticsearch-head]<span class="comment">#</span></div><div class="line">[root@ELK elasticsearch-head]<span class="comment"># head -98 Gruntfile.js | tail -9</span></div><div class="line">		connect: &#123;</div><div class="line">			server: &#123;</div><div class="line">				options: &#123;</div><div class="line">					hostname: <span class="string">'0.0.0.0'</span>,   <span class="comment">#添加这行</span></div><div class="line">					port: 9100,</div><div class="line">					base: <span class="string">'.'</span>,</div><div class="line">					keepalive: <span class="literal">true</span></div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">[root@ELK elasticsearch-head]<span class="comment"># /usr/local/elasticsearch-head/node_modules/grunt/bin/grunt server  #如果执行报错看下面的解决办法</span></div><div class="line">Running <span class="string">"connect:server"</span> (connect) task</div><div class="line">Waiting forever...</div><div class="line">Started connect web server on http://localhost:9100</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#最新安装步骤</span></div><div class="line">yum -y install git make gcc gcc-c++ wget bzip2</div><div class="line">wget https://nodejs.org/dist/v8.9.3/node-v8.9.3.tar.gz</div><div class="line">tar -zxf node-v8.9.3.tar.gz</div><div class="line"><span class="built_in">cd</span> node-v8.9.3</div><div class="line">./configure --prefix=/usr/<span class="built_in">local</span>/node-v8.9.3</div><div class="line">make &amp;&amp; make install</div><div class="line">ln <span class="_">-s</span> /usr/<span class="built_in">local</span>/node-v8.9.3/bin/npm /usr/bin/</div><div class="line">ln <span class="_">-s</span> /usr/<span class="built_in">local</span>/node-v8.9.3/bin/node /usr/bin/</div><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/ &amp;&amp; git <span class="built_in">clone</span> https://github.com/mobz/elasticsearch-head.git</div><div class="line">mkdir -p /tmp/phantomjs/ &amp;&amp; wget https://github.com/Medium/phantomjs/releases/download/v2.1.1/phantomjs-2.1.1-linux-x86_64.tar.bz2 -O /tmp/phantomjs/phantomjs-2.1.1-linux-x86_64.tar.bz2</div><div class="line"><span class="built_in">cd</span> elasticsearch-head/ &amp;&amp; npm install</div><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/elasticsearch-head/ &amp;&amp; npm install grunt --save</div><div class="line">npm install grunt-contrib-clean --registry=https://registry.npm.taobao.org</div><div class="line">npm install grunt-contrib-concat --registry=https://registry.npm.taobao.org</div><div class="line">npm install grunt-contrib-watch --registry=https://registry.npm.taobao.org</div><div class="line">npm install grunt-contrib-connect --registry=https://registry.npm.taobao.org</div><div class="line">npm install grunt-contrib-copy --registry=https://registry.npm.taobao.org</div><div class="line">npm install grunt-contrib-jasmine --registry=https://registry.npm.taobao.org</div><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/elasticsearch-head/ &amp;&amp; sed -i <span class="string">"/port: 9100/ihostname: '0.0.0.0',"</span> Gruntfile.js</div><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/elasticsearch-head/ &amp;&amp; /usr/<span class="built_in">local</span>/elasticsearch-head/node_modules/grunt/bin/grunt server &amp;</div></pre></td></tr></table></figure>
<h4 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h4><p>听说有些依赖在国内解决不了，已经考虑使用Docker<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># docker pull salgat/elasticsearch-head</span></div><div class="line"><span class="comment"># docker run -d --name elasticsearch-head -p9100:9100 docker.io/salgat/elasticsearch-head</span></div></pre></td></tr></table></figure></p>
<p>官方也提供了elasticsearch-head在Docker容器中使用的方法<br>Running with docker<br>for Elasticsearch 5.x: <code>docker run -p 9100:9100 mobz/elasticsearch-head:5</code><br>for Elasticsearch 2.x: <code>docker run -p 9100:9100 mobz/elasticsearch-head:2</code><br>for Elasticsearch 1.x: <code>docker run -p 9100:9100 mobz/elasticsearch-head:1</code><br>for fans of alpine there is mobz/elasticsearch-head:5-alpine<br>open <code>http://localhost:9100/</code>  </p>
<h4 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q &amp; A"></a>Q &amp; A</h4><p>如果服务器重启了，有时发现执行<figure class="highlight plain"><figcaption><span>server```报错```Fatal error: Unable to find local grunt.```，需要重新按照Question1的解决方法操作一下，也可以执行下面的脚本  </span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">```bash</div><div class="line">[root@ELK ~]# cat check_es_head_grunt.sh </div><div class="line">#!/bin/bash</div><div class="line"># Auther: yfshare</div><div class="line"># Date:2016-12-29</div><div class="line">eshead_dir=&quot;/usr/local/elasticsearch-head&quot;</div><div class="line">grunt_dir=&quot;$eshead_dir/node_modules/grunt&quot;</div><div class="line">grunt_bin=&quot;$grunt_dir/bin/grunt&quot;</div><div class="line"></div><div class="line">kill -9 `ps -ef | grep -iw &apos;grunt&apos; | grep -v grep | awk &apos;&#123;print $2&#125;&apos;` &amp;&gt;/dev/null</div><div class="line">[ ! -x &quot;$grunt_bin&quot; ] &amp;&amp; chmod 755 &quot;$grunt_bin&quot;</div><div class="line">echo &apos;&apos;</div><div class="line">echo &apos;Please wait a moment.&apos;</div><div class="line">cd &quot;$eshead_dir&quot;</div><div class="line">npm install grunt --save-dev &amp;&gt; /dev/null</div><div class="line">cd &quot;$eshead_dir&quot;</div><div class="line">&quot;$grunt_bin&quot; server &amp;</div><div class="line">[ $? -eq 0 ] &amp;&amp; echo &apos;start ok.&apos;</div><div class="line">[root@ELK ~]#</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@ELK ~]<span class="comment"># sh check_es_head_grunt.sh </span></div><div class="line"></div><div class="line">Please <span class="built_in">wait</span> a moment.</div><div class="line">start ok.</div><div class="line">Running <span class="string">"connect:server"</span> (connect) task</div><div class="line">Waiting forever...</div><div class="line">Started connect web server on http://localhost:9100</div><div class="line"></div><div class="line">[root@ELK ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>Question1：如果报下面的错误：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@ELK ~]<span class="comment"># /usr/local/elasticsearch-head/node_modules/grunt/bin/grunt server  </span></div><div class="line">grunt-cli: The grunt <span class="built_in">command</span> line interface (v1.2.0)  </div><div class="line">Fatal error: Unable to find <span class="built_in">local</span> grunt.</div><div class="line">If you<span class="string">'re seeing this message, grunt hasn'</span>t been installed locally to</div><div class="line">your project. For more information about installing and configuring grunt,</div><div class="line">please see the Getting Started guide:  </div><div class="line">http://gruntjs.com/getting-started  </div><div class="line">[root@ELK ~]<span class="comment">#  </span></div><div class="line"></div><div class="line">Answer：  </div><div class="line">[root@ELK ~]<span class="comment"># cd /usr/local/elasticsearch-head/  </span></div><div class="line">[root@ELK elasticsearch-head]<span class="comment"># npm install grunt --save-dev  </span></div><div class="line">再执行/usr/<span class="built_in">local</span>/elasticsearch-head/node_modules/grunt/bin/grunt server就OK了</div></pre></td></tr></table></figure></p>
<p>Question2：<br>之前修改ElasticSearch 5.1的network.host的IP时，不管修改成什么(注释network.host除外)，重启均报错，开始以为是不能绑定IP地址。之前有注意到日志里的报错的<figure class="highlight plain"><figcaption><span>checks failed. max number of threads [1024] for user [elasticsearch] is too low, increase to at least [2048]```因为注释了network.host后ElasticSearch能起来，所以没意识到是它的问题  </span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">```bash</div><div class="line">#ElasticSearch日志报错</div><div class="line">[2016-12-28T16:57:23,190][INFO ][o.e.n.Node               ] [es-node01] starting ...</div><div class="line">[2016-12-28T16:57:24,616][INFO ][o.e.t.TransportService   ] [es-node01] publish_address &#123;192.168.31.100:9300&#125;, bound_addresses &#123;192.168.31.100:9300&#125;</div><div class="line">[2016-12-28T16:57:24,686][INFO ][o.e.b.BootstrapCheck     ] [es-node01] bound or publishing to a non-loopback or non-link-local address, enforcing bootstrap checks</div><div class="line">[2016-12-28T16:57:24,708][ERROR][o.e.b.Bootstrap          ] [es-node01] node validation exception</div><div class="line">bootstrap checks failed</div><div class="line">max number of threads [1024] for user [elasticsearch] is too low, increase to at least [2048]</div><div class="line">[2016-12-28T16:57:24,739][INFO ][o.e.n.Node               ] [es-node01] stopping ...</div><div class="line">[2016-12-28T16:57:25,275][INFO ][o.e.n.Node               ] [es-node01] stopped</div><div class="line">[2016-12-28T16:57:25,277][INFO ][o.e.n.Node               ] [es-node01] closing ...</div><div class="line">[2016-12-28T16:57:25,500][INFO ][o.e.n.Node               ] [es-node01] closed</div></pre></td></tr></table></figure></p>
<p>Answer：修改<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">关于ElasticSearch5.1的network.host设置  </div><div class="line">参考：https://www.elastic.co/guide/en/elasticsearch/reference/5.1/modules-network.html#common-network-settings</div><div class="line">```bash</div><div class="line">[root@ELK ~]# grep -v ^# /etc/security/limits.conf | grep -v ^$</div><div class="line">elasticsearch	soft	nproc	2048</div><div class="line">elasticsearch	hard	nproc	4096</div><div class="line">[root@ELK ~]#</div></pre></td></tr></table></figure></p>
<p>Question3：<br>如果执行<code>/usr/local/elasticsearch-head/node_modules/grunt/bin/grunt server</code>报下面的错误<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">[root@ELK-test ~]<span class="comment"># /usr/local/elasticsearch-head/node_modules/grunt/bin/grunt server</span></div><div class="line">grunt-cli: The grunt <span class="built_in">command</span> line interface (v1.2.0)</div><div class="line"></div><div class="line">Fatal error: Unable to find <span class="built_in">local</span> grunt.</div><div class="line"></div><div class="line">If you<span class="string">'re seeing this message, grunt hasn'</span>t been installed locally to</div><div class="line">your project. For more information about installing and configuring grunt,</div><div class="line">please see the Getting Started guide:</div><div class="line"></div><div class="line">http://gruntjs.com/getting-started</div><div class="line">[root@ELK-test ~]<span class="comment">#</span></div><div class="line"></div><div class="line">Answer：</div><div class="line"><span class="comment">#进入elasticsearch-head安装目录即可，因为在别的地方找不到Gruntfile.js文件</span></div><div class="line">[root@ELK-test ~]<span class="comment"># cd /usr/local/elasticsearch-head/</span></div></pre></td></tr></table></figure></p>
<p>Question4：<br>如果执行<code>/usr/local/elasticsearch-head/node_modules/grunt/bin/grunt server</code>报下面的错误<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">[root@ELK-test elasticsearch-head]<span class="comment"># /usr/local/elasticsearch-head/node_modules/grunt/bin/grunt server</span></div><div class="line">&gt;&gt; Local Npm module <span class="string">"grunt-contrib-clean"</span> not found. Is it installed?</div><div class="line">&gt;&gt; Local Npm module <span class="string">"grunt-contrib-concat"</span> not found. Is it installed?</div><div class="line">&gt;&gt; Local Npm module <span class="string">"grunt-contrib-watch"</span> not found. Is it installed?</div><div class="line">&gt;&gt; Local Npm module <span class="string">"grunt-contrib-connect"</span> not found. Is it installed?</div><div class="line">&gt;&gt; Local Npm module <span class="string">"grunt-contrib-copy"</span> not found. Is it installed?</div><div class="line">&gt;&gt; Local Npm module <span class="string">"grunt-contrib-jasmine"</span> not found. Is it installed?</div><div class="line">Warning: Task <span class="string">"connect:server"</span> not found. Use --force to continue.</div><div class="line"></div><div class="line">Aborted due to warnings.</div><div class="line">[root@ELK-test elasticsearch-head]<span class="comment">#</span></div><div class="line"></div><div class="line">Answer：</div><div class="line">出现以下提示，为Gruntfile.js引用的，缺少以下包</div><div class="line">[root@ELK-test elasticsearch-head]<span class="comment"># npm install grunt-contrib-clean --registry=https://registry.npm.taobao.org</span></div><div class="line">[root@ELK-test elasticsearch-head]<span class="comment"># npm install grunt-contrib-concat --registry=https://registry.npm.taobao.org</span></div><div class="line">[root@ELK-test elasticsearch-head]<span class="comment"># npm install grunt-contrib-watch --registry=https://registry.npm.taobao.org</span></div><div class="line">[root@ELK-test elasticsearch-head]<span class="comment"># npm install grunt-contrib-connect --registry=https://registry.npm.taobao.org</span></div><div class="line">[root@ELK-test elasticsearch-head]<span class="comment"># npm install grunt-contrib-copy --registry=https://registry.npm.taobao.org</span></div><div class="line">[root@ELK-test elasticsearch-head]<span class="comment"># npm install grunt-contrib-jasmine --registry=https://registry.npm.taobao.org</span></div><div class="line"></div><div class="line">[root@ELK-test elasticsearch-head]<span class="comment"># /usr/local/elasticsearch-head/node_modules/grunt/bin/grunt server &amp;</span></div><div class="line">[1] 22877</div><div class="line">[root@ELK-test elasticsearch-head]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>Question5：<br>如果在执行<code>npm install</code>时报如下错误  </p>
<p>Answer：可以先下载其所需的文件再执行<code>npm install</code>安装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mkdir -p /tmp/phantomjs/</div><div class="line">wget https://github.com/Medium/phantomjs/releases/download/v2.1.1/phantomjs-2.1.1-linux-x86_64.tar.bz2 -O /tmp/phantomjs/phantomjs-2.1.1-linux-x86_64.tar.bz2</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#npm install</span></div><div class="line">npm WARN deprecated coffee-script@1.10.0: CoffeeScript on NPM has moved to <span class="string">"coffeescript"</span> (no hyphen)</div><div class="line">npm WARN deprecated http2@3.3.7: Use the built-in module <span class="keyword">in</span> node 9.0.0 or newer, instead</div><div class="line"></div><div class="line">&gt; phantomjs-prebuilt@2.1.16 install /usr/<span class="built_in">local</span>/elasticsearch-head/node_modules/phantomjs-prebuilt</div><div class="line">&gt; node install.js</div><div class="line"></div><div class="line">PhantomJS not found on PATH</div><div class="line">Downloading https://github.com/Medium/phantomjs/releases/download/v2.1.1/phantomjs-2.1.1-linux-x86_64.tar.bz2</div><div class="line">Saving to /tmp/phantomjs/phantomjs-2.1.1-linux-x86_64.tar.bz2</div><div class="line">Receiving...</div><div class="line"></div><div class="line">Error making request.</div><div class="line">Error: connect ETIMEDOUT 52.216.82.152:443</div><div class="line">    at Object._errnoException (util.js:1024:11)</div><div class="line">    at _exceptionWithHostPort (util.js:1046:20)</div><div class="line">    at TCPConnectWrap.afterConnect [as oncomplete] (net.js:1182:14)</div><div class="line"></div><div class="line">Please report this full <span class="built_in">log</span> at https://github.com/Medium/phantomjs</div><div class="line">npm WARN elasticsearch-head@0.0.0 license should be a valid SPDX license expression</div><div class="line">npm WARN optional SKIPPING OPTIONAL DEPENDENCY: fsevents@1.1.3 (node_modules/fsevents):</div><div class="line">npm WARN notsup SKIPPING OPTIONAL DEPENDENCY: Unsupported platform <span class="keyword">for</span> fsevents@1.1.3: wanted &#123;<span class="string">"os"</span>:<span class="string">"darwin"</span>,<span class="string">"arch"</span>:<span class="string">"any"</span>&#125; (current: &#123;<span class="string">"os"</span>:<span class="string">"linux"</span>,<span class="string">"arch"</span>:<span class="string">"x64"</span>&#125;)</div><div class="line"></div><div class="line">npm ERR! code ELIFECYCLE</div><div class="line">npm ERR! errno 1</div><div class="line">npm ERR! phantomjs-prebuilt@2.1.16 install: `node install.js`</div><div class="line">npm ERR! Exit status 1</div><div class="line">npm ERR! </div><div class="line">npm ERR! Failed at the phantomjs-prebuilt@2.1.16 install script.</div><div class="line">npm ERR! This is probably not a problem with npm. There is likely additional logging output above.</div><div class="line"></div><div class="line">npm ERR! A complete <span class="built_in">log</span> of this run can be found <span class="keyword">in</span>:</div><div class="line">npm ERR!     /root/.npm/_logs/2017-12-16T02_18_46_188Z-debug.log</div></pre></td></tr></table></figure>
<p>注：集群配置完成后，需要把Logstash里的ElasticSearch的地址修改正确<br>即：Logstash配置文件的output关于ElasticSearch的配置<br><figure class="highlight puppet"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">output</span> &#123;</div><div class="line">        elasticsearch &#123;</div><div class="line">                <span class="attr">hosts</span> =&gt; [<span class="string">"192.168.31.100:9200"</span>]</div><div class="line">                <span class="attr">index</span> =&gt; <span class="string">"logstash-nginx-%&#123;+YYYY.MM.dd&#125;"</span></div><div class="line">        &#125;</div></pre></td></tr></table></figure></p>
<h4 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h4><p><img src="http://note.youdao.com/yws/api/personal/file/6034AE21E6DD472EA31F19BACF3BB39C?method=download&amp;shareKey=c1e28da86983aaae6e3d6961ab74b314" alt="image"><br><img src="http://note.youdao.com/yws/api/personal/file/0B60DD50A74C4E5D99F9BF97C0FB2FD1?method=download&amp;shareKey=f5bdfc6cc8fa4cbac65d30607cd1463e" alt="image"><br><img src="http://note.youdao.com/yws/api/personal/file/03465D12C20840FDB100ACD61C2AB152?method=download&amp;shareKey=49f66cf16d4ed5a8c37ff7e91d9558c7" alt="image"><br><img src="http://note.youdao.com/yws/api/personal/file/3EB4A9FD353C46A5BD1C99AB94D2B5A2?method=download&amp;shareKey=201db35f0c4ca938b4e844ca7d964b7a" alt="image"><br><img src="http://note.youdao.com/yws/api/personal/file/66D98E66A0EA48DC8E763C15E8A90D77?method=download&amp;shareKey=9dbeb81b55fa0717d16179e04fe8b32d" alt="image"><br><img src="http://note.youdao.com/yws/api/personal/file/C675C13D627D4035967A809951E48D73?method=download&amp;shareKey=610e0f92a9d468b21df21f3f12b03b93" alt="image">  </p>
<p>2台elasticsearch，显示一台master和一台slave才是正常的<br><img src="http://note.youdao.com/yws/api/personal/file/C0E9213A27E1487D8D8B2C1E2A625861?method=download&amp;shareKey=cb8459b1788cd846bf9f7cd73196dcb2" alt="es_cluster">  </p>
<p>本文参考：<a href="https://www.chinasa.net/archives/325.html" target="_blank" rel="external">https://www.chinasa.net/archives/325.html</a><br>　　　　　<a href="http://zerosre.com/2016/12/20/k8s日志管理-三/" target="_blank" rel="external">http://zerosre.com/2016/12/20/k8s日志管理-三/</a><br>　　　　　<a href="http://hnr520.blog.51cto.com/4484939/1867033" target="_blank" rel="external">http://hnr520.blog.51cto.com/4484939/1867033</a><br>nodejs下载地址：<a href="https://nodejs.org/en/blog/release/v0.12.16/" target="_blank" rel="external">https://nodejs.org/en/blog/release/v0.12.16/</a>  </p>
<p>附件：<br><a href="http://note.youdao.com/yws/api/personal/file/9DF4FD46C39F4D198FA28E31175946FF?method=download&amp;shareKey=fb14484fc213e29de7d11fb267bd073b" target="_blank" rel="external">yum.repo</a><br><a href="http://note.youdao.com/yws/api/personal/file/7394DDCE364F4C47A2059C3B977A0173?method=download&amp;shareKey=33a242bfa78c38aa6e2eec84967633cc" target="_blank" rel="external">elasticsearch-head.zip</a><br><a href="http://note.youdao.com/yws/api/personal/file/E85D6B24C1944F5BB7FF562141E542C2?method=download&amp;shareKey=4b9be8a44632f563f29c6aa9e4eee9db" target="_blank" rel="external">node-v0.12.16.tar.gz</a><br><a href="http://note.youdao.com/yws/api/personal/file/10CB6262193249F8ABB874BDCA4AF1F8?method=download&amp;shareKey=19b78be82de892d54a42a473a212cee5" target="_blank" rel="external">phantomjs-2.1.1-linux-x86_64.tar.bz2</a><br><a href="http://note.youdao.com/yws/api/personal/file/46615981B34F4DCEB51313876E3F481A?method=download&amp;shareKey=bed7ee555658949beaae23dfe6e34b33" target="_blank" rel="external">check_es_head_grunt.sh</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/12/04/ElasticSearch集群-基础/">http://www.yfshare.vip/2017/12/04/ElasticSearch集群-基础/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;这里分享的是ELK集群基础安装文档，&lt;a href=&quot;http://www.yfshare.vip/2017/11/22/ELK%E5%AE%89%E8%A3%85-%E5%9F%BA%E7%A1%80/&quot;&gt;这里是 ELK安装基础&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
      <category term="ELK" scheme="http://www.yfshare.vip/categories/ELK/"/>
    
    
      <category term="ELK" scheme="http://www.yfshare.vip/tags/ELK/"/>
    
      <category term="Cluster" scheme="http://www.yfshare.vip/tags/Cluster/"/>
    
      <category term="Elasticsearch-Head" scheme="http://www.yfshare.vip/tags/Elasticsearch-Head/"/>
    
  </entry>
  
  <entry>
    <title>timelion请求语法</title>
    <link href="http://www.yfshare.vip/2017/12/04/timelion%E8%AF%B7%E6%B1%82%E8%AF%AD%E6%B3%95/"/>
    <id>http://www.yfshare.vip/2017/12/04/timelion请求语法/</id>
    <published>2017-12-04T15:33:39.000Z</published>
    <updated>2017-12-04T15:34:41.540Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/APlayer.min.js"> </script><script src="/assets/js/DPlayer.min.js"> </script><p>ES2.0 开始提供了一个崭新的 pipeline aggregation 特性，但是 Kibana 似乎并没有立刻跟进这方面的意思，相反，Elastic 公司推出了另一个实验室产品：Timelion。<br><a id="more"></a><br>timelion 的用法在官博里已经有介绍。尤其是最近两篇如何用 timelion 实现异常告警的文章，更是从 ES 的 pipeline aggregation 细节和场景一路讲到 timelion 具体操作，我这里几乎没有再重新讲一遍 timelion 操作入门的必要了。不过，官方却一直没有列出来 timelion 支持的请求语法的文档，而是在页面上通过点击图标的方式下拉帮助。  </p>
<h5 id="可视化效果类"><a href="#可视化效果类" class="headerlink" title="可视化效果类"></a>可视化效果类</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">.bars(<span class="variable">$width</span>): 用柱状图展示数组</div><div class="line">.lines(<span class="variable">$width</span>, <span class="variable">$fill</span>, <span class="variable">$show</span>, <span class="variable">$steps</span>): 用折线图展示数组</div><div class="line">.points(): 用散点图展示数组</div><div class="line">.color(<span class="string">"#c6c6c6"</span>): 改变颜色</div><div class="line">.hide(): 隐藏该数组</div><div class="line">.label(<span class="string">"change from %s"</span>): 标签</div><div class="line">.legend(<span class="variable">$position</span>, <span class="variable">$column</span>): 图例位置</div><div class="line">.yaxis(<span class="variable">$yaxis_number</span>, <span class="variable">$min</span>, <span class="variable">$max</span>, <span class="variable">$position</span>): 设置 Y 轴属性，.yaxis(2) 表示第二根 Y 轴</div></pre></td></tr></table></figure>
<h5 id="数据运算类"><a href="#数据运算类" class="headerlink" title="数据运算类"></a>数据运算类</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">.abs(): 对整个数组元素求绝对值</div><div class="line">.precision(<span class="variable">$number</span>): 浮点数精度</div><div class="line">.testcast(<span class="variable">$count</span>, <span class="variable">$alpha</span>, <span class="variable">$beta</span>, <span class="variable">$gamma</span>): holt-winters 预测</div><div class="line">.cusum(<span class="variable">$base</span>): 数组元素之和，再加上 <span class="variable">$base</span></div><div class="line">.derivative(): 对数组求导数</div><div class="line">.divide(<span class="variable">$divisor</span>): 数组元素除法</div><div class="line">.multiply(<span class="variable">$multiplier</span>): 数组元素乘法</div><div class="line">.subtract(<span class="variable">$term</span>): 数组元素减法</div><div class="line">.sum(<span class="variable">$term</span>): 数组元素加法</div><div class="line">.add(): 同 .sum()</div><div class="line">.plus(): 同 .sum()</div><div class="line">.first(): 返回第一个元素</div><div class="line">.movingaverage(<span class="variable">$window</span>): 用指定的窗口大小计算移动平均值</div><div class="line">.mvavg(): .movingaverage() 的简写</div><div class="line">.movingstd(<span class="variable">$window</span>): 用指定的窗口大小计算移动标准差</div><div class="line">.mvstd(): .movingstd() 的简写</div></pre></td></tr></table></figure>
<h5 id="数据源设定类"><a href="#数据源设定类" class="headerlink" title="数据源设定类"></a>数据源设定类</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">.elasticsearch(): 从 ES 读取数据</div><div class="line">.es(q=<span class="string">"querystring"</span>, metric=<span class="string">"cardinality:uid"</span>, index=<span class="string">"logstash-*"</span>, offset=<span class="string">"-1d"</span>): .elasticsearch() 的简写</div><div class="line">.graphite(metric=<span class="string">"path.to.*.data"</span>, offset=<span class="string">"-1d"</span>): 从 graphite 读取数据</div><div class="line">.quandl(): 从 quandl.com 读取 quandl 码</div><div class="line">.worldbank_indicators(): 从 worldbank.org 读取国家数据</div><div class="line">.wbi(): .worldbank_indicators() 的简写</div><div class="line">.worldbank(): 从 worldbank.org 读取数据</div><div class="line">.wb(): .worldbanck() 的简写</div></pre></td></tr></table></figure>
<p>参考：<a href="https://elasticsearch.cn/article/24" target="_blank" rel="external">https://elasticsearch.cn/article/24</a><br>更多参考：<a href="https://elasticsearch.cn/article/" target="_blank" rel="external">https://elasticsearch.cn/article/</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/12/04/timelion请求语法/">http://www.yfshare.vip/2017/12/04/timelion请求语法/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ES2.0 开始提供了一个崭新的 pipeline aggregation 特性，但是 Kibana 似乎并没有立刻跟进这方面的意思，相反，Elastic 公司推出了另一个实验室产品：Timelion。&lt;br&gt;
    
    </summary>
    
      <category term="ELK" scheme="http://www.yfshare.vip/categories/ELK/"/>
    
    
      <category term="ELK" scheme="http://www.yfshare.vip/tags/ELK/"/>
    
      <category term="Kibana" scheme="http://www.yfshare.vip/tags/Kibana/"/>
    
  </entry>
  
  <entry>
    <title>Logstash监控</title>
    <link href="http://www.yfshare.vip/2017/12/04/Logstash%E7%9B%91%E6%8E%A7/"/>
    <id>http://www.yfshare.vip/2017/12/04/Logstash监控/</id>
    <published>2017-12-04T15:31:09.000Z</published>
    <updated>2017-12-04T15:32:39.987Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/APlayer.min.js"> </script><script src="/assets/js/DPlayer.min.js"> </script><p> Logstash监控指标<br> <a id="more"></a><br>环境：Logstash 5.6.1  </p>
<h4 id="通过jvm监控"><a href="#通过jvm监控" class="headerlink" title="通过jvm监控"></a>通过jvm监控</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">[root@ELK-test ~]<span class="comment"># curl -s localhost:9600/_node/stats/jvm?pretty=true</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"host"</span> : <span class="string">"ELK-test"</span>,</div><div class="line">  <span class="string">"version"</span> : <span class="string">"5.6.1"</span>,</div><div class="line">  <span class="string">"http_address"</span> : <span class="string">"127.0.0.1:9600"</span>,</div><div class="line">  <span class="string">"id"</span> : <span class="string">"6eaac40c-2e2a-4e04-8fce-10e938c9dc0d"</span>,</div><div class="line">  <span class="string">"name"</span> : <span class="string">"ELK-test"</span>,</div><div class="line">  <span class="string">"jvm"</span> : &#123;</div><div class="line">    <span class="string">"threads"</span> : &#123;</div><div class="line">      <span class="string">"count"</span> : 67,</div><div class="line">      <span class="string">"peak_count"</span> : 68</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"mem"</span> : &#123;</div><div class="line">      <span class="string">"heap_used_percent"</span> : 17,</div><div class="line">      <span class="string">"heap_committed_in_bytes"</span> : 340779008,</div><div class="line">      <span class="string">"heap_max_in_bytes"</span> : 1056309248,</div><div class="line">      <span class="string">"heap_used_in_bytes"</span> : 181136632,</div><div class="line">      <span class="string">"non_heap_used_in_bytes"</span> : 112857424,</div><div class="line">      <span class="string">"non_heap_committed_in_bytes"</span> : 120733696,</div><div class="line">      <span class="string">"pools"</span> : &#123;</div><div class="line">        <span class="string">"survivor"</span> : &#123;</div><div class="line">          <span class="string">"peak_used_in_bytes"</span> : 17432576,</div><div class="line">          <span class="string">"used_in_bytes"</span> : 5437952,</div><div class="line">          <span class="string">"peak_max_in_bytes"</span> : 17432576,</div><div class="line">          <span class="string">"max_in_bytes"</span> : 17432576,</div><div class="line">          <span class="string">"committed_in_bytes"</span> : 17432576</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"old"</span> : &#123;</div><div class="line">          <span class="string">"peak_used_in_bytes"</span> : 130825496,</div><div class="line">          <span class="string">"used_in_bytes"</span> : 130825496,</div><div class="line">          <span class="string">"peak_max_in_bytes"</span> : 899284992,</div><div class="line">          <span class="string">"max_in_bytes"</span> : 899284992,</div><div class="line">          <span class="string">"committed_in_bytes"</span> : 183754752</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"young"</span> : &#123;</div><div class="line">          <span class="string">"peak_used_in_bytes"</span> : 139591680,</div><div class="line">          <span class="string">"used_in_bytes"</span> : 44873184,</div><div class="line">          <span class="string">"peak_max_in_bytes"</span> : 139591680,</div><div class="line">          <span class="string">"max_in_bytes"</span> : 139591680,</div><div class="line">          <span class="string">"committed_in_bytes"</span> : 139591680</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"gc"</span> : &#123;</div><div class="line">      <span class="string">"collectors"</span> : &#123;</div><div class="line">        <span class="string">"old"</span> : &#123;</div><div class="line">          <span class="string">"collection_time_in_millis"</span> : 375,</div><div class="line">          <span class="string">"collection_count"</span> : 5</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"young"</span> : &#123;</div><div class="line">          <span class="string">"collection_time_in_millis"</span> : 44399,</div><div class="line">          <span class="string">"collection_count"</span> : 3181</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"uptime_in_millis"</span> : 186066906</div><div class="line">  &#125;</div><div class="line">&#125;[root@ELK-test ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h4 id="通过process监控"><a href="#通过process监控" class="headerlink" title="通过process监控"></a>通过process监控</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">[root@ELK-test ~]<span class="comment"># curl -s localhost:9600/_node/stats/process?pretty=true</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"host"</span> : <span class="string">"ELK-test"</span>,</div><div class="line">  <span class="string">"version"</span> : <span class="string">"5.6.1"</span>,</div><div class="line">  <span class="string">"http_address"</span> : <span class="string">"127.0.0.1:9600"</span>,</div><div class="line">  <span class="string">"id"</span> : <span class="string">"6eaac40c-2e2a-4e04-8fce-10e938c9dc0d"</span>,</div><div class="line">  <span class="string">"name"</span> : <span class="string">"ELK-test"</span>,</div><div class="line">  <span class="string">"process"</span> : &#123;</div><div class="line">    <span class="string">"open_file_descriptors"</span> : 202,</div><div class="line">    <span class="string">"peak_open_file_descriptors"</span> : 202,</div><div class="line">    <span class="string">"max_file_descriptors"</span> : 4096,</div><div class="line">    <span class="string">"mem"</span> : &#123;</div><div class="line">      <span class="string">"total_virtual_in_bytes"</span> : 3939852288</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"cpu"</span> : &#123;</div><div class="line">      <span class="string">"total_in_millis"</span> : 3338270,</div><div class="line">      <span class="string">"percent"</span> : 0,</div><div class="line">      <span class="string">"load_average"</span> : &#123;</div><div class="line">        <span class="string">"1m"</span> : 0.54,</div><div class="line">        <span class="string">"5m"</span> : 0.32,</div><div class="line">        <span class="string">"15m"</span> : 0.31</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;[root@ELK-test ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h4 id="通过pipeline监控"><a href="#通过pipeline监控" class="headerlink" title="通过pipeline监控"></a>通过pipeline监控</h4><p>这里可以看到每个插件的日志处理情况（数量，耗时等），如果使用了grok插件，还显示正则匹配失败的数量、每个字段匹配的正则表达式个数等很有用的排障和性能调优信息<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div></pre></td><td class="code"><pre><div class="line">[root@ELK-test ~]<span class="comment"># curl -s localhost:9600/_node/stats/pipeline?pretty=true</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"host"</span> : <span class="string">"ELK-test"</span>,</div><div class="line">  <span class="string">"version"</span> : <span class="string">"5.6.1"</span>,</div><div class="line">  <span class="string">"http_address"</span> : <span class="string">"127.0.0.1:9600"</span>,</div><div class="line">  <span class="string">"id"</span> : <span class="string">"6eaac40c-2e2a-4e04-8fce-10e938c9dc0d"</span>,</div><div class="line">  <span class="string">"name"</span> : <span class="string">"ELK-test"</span>,</div><div class="line">  <span class="string">"pipeline"</span> : &#123;</div><div class="line">    <span class="string">"events"</span> : &#123;</div><div class="line">      <span class="string">"duration_in_millis"</span> : 3671575,</div><div class="line">      <span class="string">"in"</span> : 1621595,</div><div class="line">      <span class="string">"out"</span> : 1621595,</div><div class="line">      <span class="string">"filtered"</span> : 1621595,</div><div class="line">      <span class="string">"queue_push_duration_in_millis"</span> : 295900</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"plugins"</span> : &#123;</div><div class="line">      <span class="string">"inputs"</span> : [ &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-2"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"out"</span> : 1621595,</div><div class="line">          <span class="string">"queue_push_duration_in_millis"</span> : 295900</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"current_connections"</span> : 1,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"beats"</span>,</div><div class="line">        <span class="string">"peak_connections"</span> : 1</div><div class="line">      &#125; ],</div><div class="line">      <span class="string">"filters"</span> : [ ],</div><div class="line">      <span class="string">"outputs"</span> : [ &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-16"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 307125,</div><div class="line">          <span class="string">"in"</span> : 411982,</div><div class="line">          <span class="string">"out"</span> : 411982</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-37"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 0,</div><div class="line">          <span class="string">"in"</span> : 0,</div><div class="line">          <span class="string">"out"</span> : 0</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-28"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 71536,</div><div class="line">          <span class="string">"in"</span> : 11323,</div><div class="line">          <span class="string">"out"</span> : 11323</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-30"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 8323,</div><div class="line">          <span class="string">"in"</span> : 1200,</div><div class="line">          <span class="string">"out"</span> : 1200</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-33"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 0,</div><div class="line">          <span class="string">"in"</span> : 0,</div><div class="line">          <span class="string">"out"</span> : 0</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-40"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 3373,</div><div class="line">          <span class="string">"in"</span> : 154,</div><div class="line">          <span class="string">"out"</span> : 154</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-17"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 24148,</div><div class="line">          <span class="string">"in"</span> : 3444,</div><div class="line">          <span class="string">"out"</span> : 3444</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-31"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 0,</div><div class="line">          <span class="string">"in"</span> : 0,</div><div class="line">          <span class="string">"out"</span> : 0</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-3"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 12911,</div><div class="line">          <span class="string">"in"</span> : 1007,</div><div class="line">          <span class="string">"out"</span> : 1007</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-32"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 3564,</div><div class="line">          <span class="string">"in"</span> : 285,</div><div class="line">          <span class="string">"out"</span> : 285</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-25"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 717356,</div><div class="line">          <span class="string">"in"</span> : 407063,</div><div class="line">          <span class="string">"out"</span> : 407063</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-23"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 29538,</div><div class="line">          <span class="string">"in"</span> : 2054,</div><div class="line">          <span class="string">"out"</span> : 2054</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-11"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 0,</div><div class="line">          <span class="string">"in"</span> : 0,</div><div class="line">          <span class="string">"out"</span> : 0</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-12"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 1805,</div><div class="line">          <span class="string">"in"</span> : 104,</div><div class="line">          <span class="string">"out"</span> : 104</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-10"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 4454,</div><div class="line">          <span class="string">"in"</span> : 838,</div><div class="line">          <span class="string">"out"</span> : 838</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-13"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 0,</div><div class="line">          <span class="string">"in"</span> : 0,</div><div class="line">          <span class="string">"out"</span> : 0</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-20"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 35142,</div><div class="line">          <span class="string">"in"</span> : 4872,</div><div class="line">          <span class="string">"out"</span> : 4872</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-22"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 1334,</div><div class="line">          <span class="string">"in"</span> : 107,</div><div class="line">          <span class="string">"out"</span> : 107</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-21"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 0,</div><div class="line">          <span class="string">"in"</span> : 0,</div><div class="line">          <span class="string">"out"</span> : 0</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-29"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 4538,</div><div class="line">          <span class="string">"in"</span> : 429,</div><div class="line">          <span class="string">"out"</span> : 429</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-24"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 73579,</div><div class="line">          <span class="string">"in"</span> : 10990,</div><div class="line">          <span class="string">"out"</span> : 10990</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-39"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 0,</div><div class="line">          <span class="string">"in"</span> : 0,</div><div class="line">          <span class="string">"out"</span> : 0</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-15"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 34938,</div><div class="line">          <span class="string">"in"</span> : 3095,</div><div class="line">          <span class="string">"out"</span> : 3095</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-9"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 0,</div><div class="line">          <span class="string">"in"</span> : 0,</div><div class="line">          <span class="string">"out"</span> : 0</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-26"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 793240,</div><div class="line">          <span class="string">"in"</span> : 424502,</div><div class="line">          <span class="string">"out"</span> : 424502</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-18"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 32408,</div><div class="line">          <span class="string">"in"</span> : 5051,</div><div class="line">          <span class="string">"out"</span> : 5051</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-36"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 6709,</div><div class="line">          <span class="string">"in"</span> : 2142,</div><div class="line">          <span class="string">"out"</span> : 2142</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-7"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 27306,</div><div class="line">          <span class="string">"in"</span> : 1791,</div><div class="line">          <span class="string">"out"</span> : 1791</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-35"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 2960,</div><div class="line">          <span class="string">"in"</span> : 24,</div><div class="line">          <span class="string">"out"</span> : 24</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-5"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 867,</div><div class="line">          <span class="string">"in"</span> : 1,</div><div class="line">          <span class="string">"out"</span> : 1</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-4"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 19048,</div><div class="line">          <span class="string">"in"</span> : 3088,</div><div class="line">          <span class="string">"out"</span> : 3088</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-8"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 340928,</div><div class="line">          <span class="string">"in"</span> : 306042,</div><div class="line">          <span class="string">"out"</span> : 306042</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-19"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 26274,</div><div class="line">          <span class="string">"in"</span> : 3311,</div><div class="line">          <span class="string">"out"</span> : 3311</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-27"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 512,</div><div class="line">          <span class="string">"in"</span> : 3,</div><div class="line">          <span class="string">"out"</span> : 3</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-14"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 1477,</div><div class="line">          <span class="string">"in"</span> : 329,</div><div class="line">          <span class="string">"out"</span> : 329</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-38"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 6962,</div><div class="line">          <span class="string">"in"</span> : 3773,</div><div class="line">          <span class="string">"out"</span> : 3773</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-6"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 2092,</div><div class="line">          <span class="string">"in"</span> : 989,</div><div class="line">          <span class="string">"out"</span> : 989</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="string">"id"</span> : <span class="string">"87303f752c45ebe8feaa4dafabb419ceb4188803-34"</span>,</div><div class="line">        <span class="string">"events"</span> : &#123;</div><div class="line">          <span class="string">"duration_in_millis"</span> : 8653,</div><div class="line">          <span class="string">"in"</span> : 1152,</div><div class="line">          <span class="string">"out"</span> : 1152</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"name"</span> : <span class="string">"elasticsearch"</span></div><div class="line">      &#125; ]</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"reloads"</span> : &#123;</div><div class="line">      <span class="string">"last_error"</span> : null,</div><div class="line">      <span class="string">"successes"</span> : 0,</div><div class="line">      <span class="string">"last_success_timestamp"</span> : null,</div><div class="line">      <span class="string">"last_failure_timestamp"</span> : null,</div><div class="line">      <span class="string">"failures"</span> : 0</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"queue"</span> : &#123;</div><div class="line">      <span class="string">"type"</span> : <span class="string">"memory"</span></div><div class="line">    &#125;,</div><div class="line">    <span class="string">"id"</span> : <span class="string">"main"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">[root@ELK-test ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/12/04/Logstash监控/">http://www.yfshare.vip/2017/12/04/Logstash监控/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt; Logstash监控指标&lt;br&gt;
    
    </summary>
    
      <category term="ELK" scheme="http://www.yfshare.vip/categories/ELK/"/>
    
    
      <category term="ELK" scheme="http://www.yfshare.vip/tags/ELK/"/>
    
      <category term="Logstash" scheme="http://www.yfshare.vip/tags/Logstash/"/>
    
  </entry>
  
  <entry>
    <title>Grok正则语法</title>
    <link href="http://www.yfshare.vip/2017/11/22/Grok%E6%AD%A3%E5%88%99%E8%AF%AD%E6%B3%95/"/>
    <id>http://www.yfshare.vip/2017/11/22/Grok正则语法/</id>
    <published>2017-11-22T14:40:41.000Z</published>
    <updated>2017-11-22T14:43:16.444Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/APlayer.min.js"> </script><script src="/assets/js/DPlayer.min.js"> </script><p>官方提供的grok表达式：<a href="https://github.com/logstash-plugins/logstash-patterns-core/tree/master/patterns" target="_blank" rel="external">https://github.com/logstash-plugins/logstash-patterns-core/tree/master/patterns</a><br>grok在线调试：<a href="https://grokdebug.herokuapp.com/" target="_blank" rel="external">https://grokdebug.herokuapp.com/</a><br><a id="more"></a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div></pre></td><td class="code"><pre><div class="line">USERNAME [a-zA-Z0-9._-]+</div><div class="line">USER %&#123;USERNAME&#125;</div><div class="line">EMAILLOCALPART [a-zA-Z][a-zA-Z0-9_.+-=:]+</div><div class="line">EMAILADDRESS %&#123;EMAILLOCALPART&#125;@%&#123;HOSTNAME&#125;</div><div class="line">INT (?:[+-]?(?:[0-9]+))</div><div class="line">BASE10NUM (?&lt;![0-9.+-])(?&gt;[+-]?(?:(?:[0-9]+(?:\.[0-9]+)?)|(?:\.[0-9]+)))</div><div class="line">NUMBER (?:%&#123;BASE10NUM&#125;)</div><div class="line">BASE16NUM (?&lt;![0-9A-Fa<span class="_">-f</span>])(?:[+-]?(?:0x)?(?:[0-9A-Fa<span class="_">-f</span>]+))</div><div class="line">BASE16FLOAT \b(?&lt;![0-9A-Fa-f.])(?:[+-]?(?:0x)?(?:(?:[0-9A-Fa<span class="_">-f</span>]+(?:\.[0-9A-Fa<span class="_">-f</span>]*)?)|(?:\.[0-9A-Fa<span class="_">-f</span>]+)))\b</div><div class="line"></div><div class="line">POSINT \b(?:[1-9][0-9]*)\b</div><div class="line">NONNEGINT \b(?:[0-9]+)\b</div><div class="line">WORD \b\w+\b</div><div class="line">NOTSPACE \S+</div><div class="line">SPACE \s*</div><div class="line">DATA .*?</div><div class="line">GREEDYDATA .*</div><div class="line">QUOTEDSTRING (?&gt;(?&lt;!\\)(?&gt;<span class="string">"(?&gt;\\.|[^\\"</span>]+)+<span class="string">"|"</span><span class="string">"|(?&gt;'(?&gt;\\.|[^\\']+)+')|''|(?&gt;`(?&gt;\\.|[^\\`]+)+`)|``))</span></div><div class="line">UUID [A-Fa-f0-9]&#123;8&#125;-(?:[A-Fa-f0-9]&#123;4&#125;-)&#123;3&#125;[A-Fa-f0-9]&#123;12&#125;</div><div class="line"># URN, allowing use of RFC 2141 section 2.3 reserved characters</div><div class="line">URN urn:[0-9A-Za-z][0-9A-Za-z-]&#123;0,31&#125;:(?:%[0-9a-fA-F]&#123;2&#125;|[0-9A-Za-z()+,.:=@;<span class="variable">$_</span>!*'/?#-])+</div><div class="line"></div><div class="line"># Networking</div><div class="line">MAC (?:%&#123;CISCOMAC&#125;|%&#123;WINDOWSMAC&#125;|%&#123;COMMONMAC&#125;)</div><div class="line">CISCOMAC (?:(?:[A-Fa-f0-9]&#123;4&#125;\.)&#123;2&#125;[A-Fa-f0-9]&#123;4&#125;)</div><div class="line">WINDOWSMAC (?:(?:[A-Fa-f0-9]&#123;2&#125;-)&#123;5&#125;[A-Fa-f0-9]&#123;2&#125;)</div><div class="line">COMMONMAC (?:(?:[A-Fa-f0-9]&#123;2&#125;:)&#123;5&#125;[A-Fa-f0-9]&#123;2&#125;)</div><div class="line">IPV6 ((([0-9A-Fa-f]&#123;1,4&#125;:)&#123;7&#125;([0-9A-Fa-f]&#123;1,4&#125;|:))|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;6&#125;(:[0-9A-Fa-f]&#123;1,4&#125;|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d))&#123;3&#125;)|:))|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;5&#125;(((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;1,2&#125;)|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d))&#123;3&#125;)|:))|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;4&#125;(((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;1,3&#125;)|((:[0-9A-Fa-f]&#123;1,4&#125;)?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d))&#123;3&#125;))|:))|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;3&#125;(((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;1,4&#125;)|((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;0,2&#125;:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d))&#123;3&#125;))|:))|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;2&#125;(((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;1,5&#125;)|((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;0,3&#125;:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d))&#123;3&#125;))|:))|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;1&#125;(((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;1,6&#125;)|((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;0,4&#125;:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d))&#123;3&#125;))|:))|(:(((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;1,7&#125;)|((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;0,5&#125;:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d))&#123;3&#125;))|:)))(%.+)?</div><div class="line">IPV4 (?&lt;![0-9])(?:(?:[0-1]?[0-9]&#123;1,2&#125;|2[0-4][0-9]|25[0-5])[.](?:[0-1]?[0-9]&#123;1,2&#125;|2[0-4][0-9]|25[0-5])[.](?:[0-1]?[0-9]&#123;1,2&#125;|2[0-4][0-9]|25[0-5])[.](?:[0-1]?[0-9]&#123;1,2&#125;|2[0-4][0-9]|25[0-5]))(?![0-9])</div><div class="line">IP (?:%&#123;IPV6&#125;|%&#123;IPV4&#125;)</div><div class="line">HOSTNAME \b(?:[0-9A-Za-z][0-9A-Za-z-]&#123;0,62&#125;)(?:\.(?:[0-9A-Za-z][0-9A-Za-z-]&#123;0,62&#125;))*(\.?|\b)</div><div class="line">IPORHOST (?:%&#123;IP&#125;|%&#123;HOSTNAME&#125;)</div><div class="line">HOSTPORT %&#123;IPORHOST&#125;:%&#123;POSINT&#125;</div><div class="line"></div><div class="line"># paths</div><div class="line">PATH (?:%&#123;UNIXPATH&#125;|%&#123;WINPATH&#125;)</div><div class="line">UNIXPATH (/([\w_%!<span class="variable">$@</span>:.,+~-]+|\\.)*)+</div><div class="line">TTY (?:/dev/(pts|tty([pq])?)(\w+)?/?(?:[0-9]+))</div><div class="line">WINPATH (?&gt;[A-Za-z]+:|\\)(?:\\[^\\?*]*)+</div><div class="line">URIPROTO [A-Za-z]+(\+[A-Za-z+]+)?</div><div class="line">URIHOST %&#123;IPORHOST&#125;(?::%&#123;POSINT:port&#125;)?</div><div class="line"># uripath comes loosely from RFC1738, but mostly from what Firefox</div><div class="line"># doesn't turn into %XX</div><div class="line">URIPATH (?:/[A-Za-z0-9$.+!*'()&#123;&#125;,~:;=@#%&amp;_\-]*)+</div><div class="line">#URIPARAM \?(?:[A-Za-z0-9]+(?:=(?:[^&amp;]*))?(?:&amp;(?:[A-Za-z0-9]+(?:=(?:[^&amp;]*))?)?)*)?</div><div class="line">URIPARAM \?[A-Za-z0-9$.+!*'|()&#123;&#125;,~@#%&amp;/=:;_?\-\[\]&lt;&gt;]*</div><div class="line">URIPATHPARAM %&#123;URIPATH&#125;(?:%&#123;URIPARAM&#125;)?</div><div class="line">URI %&#123;URIPROTO&#125;://(?:%&#123;USER&#125;(?::[^@]*)?@)?(?:%&#123;URIHOST&#125;)?(?:%&#123;URIPATHPARAM&#125;)?</div><div class="line"></div><div class="line"># Months: January, Feb, 3, 03, 12, December</div><div class="line">MONTH \b(?:[Jj]an(?:uary|uar)?|[Ff]eb(?:ruary|ruar)?|[Mm](?:a|ä)?r(?:ch|z)?|[Aa]pr(?:il)?|[Mm]a(?:y|i)?|[Jj]un(?:e|i)?|[Jj]ul(?:y)?|[Aa]ug(?:ust)?|[Ss]ep(?:tember)?|[Oo](?:c|k)?t(?:ober)?|[Nn]ov(?:ember)?|[Dd]e(?:c|z)(?:ember)?)\b</div><div class="line">MONTHNUM (?:0?[1-9]|1[0-2])</div><div class="line">MONTHNUM2 (?:0[1-9]|1[0-2])</div><div class="line">MONTHDAY (?:(?:0[1-9])|(?:[12][0-9])|(?:3[01])|[1-9])</div><div class="line"></div><div class="line"># Days: Monday, Tue, Thu, etc...</div><div class="line">DAY (?:Mon(?:day)?|Tue(?:sday)?|Wed(?:nesday)?|Thu(?:rsday)?|Fri(?:day)?|Sat(?:urday)?|Sun(?:day)?)</div><div class="line"></div><div class="line"># Years?</div><div class="line">YEAR (?&gt;\d\d)&#123;1,2&#125;</div><div class="line">HOUR (?:2[0123]|[01]?[0-9])</div><div class="line">MINUTE (?:[0-5][0-9])</div><div class="line"># '60' is a leap second in most time standards and thus is valid.</div><div class="line">SECOND (?:(?:[0-5]?[0-9]|60)(?:[:.,][0-9]+)?)</div><div class="line">TIME (?!&lt;[0-9])%&#123;HOUR&#125;:%&#123;MINUTE&#125;(?::%&#123;SECOND&#125;)(?![0-9])</div><div class="line"># datestamp is YYYY/MM/DD-HH:MM:SS.UUUU (or something like it)</div><div class="line">DATE_US %&#123;MONTHNUM&#125;[/-]%&#123;MONTHDAY&#125;[/-]%&#123;YEAR&#125;</div><div class="line">DATE_EU %&#123;MONTHDAY&#125;[./-]%&#123;MONTHNUM&#125;[./-]%&#123;YEAR&#125;</div><div class="line">ISO8601_TIMEZONE (?:Z|[+-]%&#123;HOUR&#125;(?::?%&#123;MINUTE&#125;))</div><div class="line">ISO8601_SECOND (?:%&#123;SECOND&#125;|60)</div><div class="line">TIMESTAMP_ISO8601 %&#123;YEAR&#125;-%&#123;MONTHNUM&#125;-%&#123;MONTHDAY&#125;[T ]%&#123;HOUR&#125;:?%&#123;MINUTE&#125;(?::?%&#123;SECOND&#125;)?%&#123;ISO8601_TIMEZONE&#125;?</div><div class="line">DATE %&#123;DATE_US&#125;|%&#123;DATE_EU&#125;</div><div class="line">DATESTAMP %&#123;DATE&#125;[- ]%&#123;TIME&#125;</div><div class="line">TZ (?:[APMCE][SD]T|UTC)</div><div class="line">DATESTAMP_RFC822 %&#123;DAY&#125; %&#123;MONTH&#125; %&#123;MONTHDAY&#125; %&#123;YEAR&#125; %&#123;TIME&#125; %&#123;TZ&#125;</div><div class="line">DATESTAMP_RFC2822 %&#123;DAY&#125;, %&#123;MONTHDAY&#125; %&#123;MONTH&#125; %&#123;YEAR&#125; %&#123;TIME&#125; %&#123;ISO8601_TIMEZONE&#125;</div><div class="line">DATESTAMP_OTHER %&#123;DAY&#125; %&#123;MONTH&#125; %&#123;MONTHDAY&#125; %&#123;TIME&#125; %&#123;TZ&#125; %&#123;YEAR&#125;</div><div class="line">DATESTAMP_EVENTLOG %&#123;YEAR&#125;%&#123;MONTHNUM2&#125;%&#123;MONTHDAY&#125;%&#123;HOUR&#125;%&#123;MINUTE&#125;%&#123;SECOND&#125;</div><div class="line"></div><div class="line"># Syslog Dates: Month Day HH:MM:SS</div><div class="line">SYSLOGTIMESTAMP %&#123;MONTH&#125; +%&#123;MONTHDAY&#125; %&#123;TIME&#125;</div><div class="line">PROG [\x21-\x5a\x5c\x5e-\x7e]+</div><div class="line">SYSLOGPROG %&#123;PROG:program&#125;(?:\[%&#123;POSINT:pid&#125;\])?</div><div class="line">SYSLOGHOST %&#123;IPORHOST&#125;</div><div class="line">SYSLOGFACILITY &lt;%&#123;NONNEGINT:facility&#125;.%&#123;NONNEGINT:priority&#125;&gt;</div><div class="line">HTTPDATE %&#123;MONTHDAY&#125;/%&#123;MONTH&#125;/%&#123;YEAR&#125;:%&#123;TIME&#125; %&#123;INT&#125;</div><div class="line"></div><div class="line"># Shortcuts</div><div class="line">QS %&#123;QUOTEDSTRING&#125;</div><div class="line"></div><div class="line"># Log formats</div><div class="line">SYSLOGBASE %&#123;SYSLOGTIMESTAMP:timestamp&#125; (?:%&#123;SYSLOGFACILITY&#125; )?%&#123;SYSLOGHOST:logsource&#125; %&#123;SYSLOGPROG&#125;:</div><div class="line"></div><div class="line"># Log Levels</div><div class="line">LOGLEVEL ([Aa]lert|ALERT|[Tt]race|TRACE|[Dd]ebug|DEBUG|[Nn]otice|NOTICE|[Ii]nfo|INFO|[Ww]arn?(?:ing)?|WARN?(?:ING)?|[Ee]rr?(?:or)?|ERR?(?:OR)?|[Cc]rit?(?:ical)?|CRIT?(?:ICAL)?|[Ff]atal|FATAL|[Ss]evere|SEVERE|EMERG(?:ENCY)?|[Ee]merg(?:ency)?)</div></pre></td></tr></table></figure></p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/11/22/Grok正则语法/">http://www.yfshare.vip/2017/11/22/Grok正则语法/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;官方提供的grok表达式：&lt;a href=&quot;https://github.com/logstash-plugins/logstash-patterns-core/tree/master/patterns&quot;&gt;https://github.com/logstash-plugins/logstash-patterns-core/tree/master/patterns&lt;/a&gt;&lt;br&gt;grok在线调试：&lt;a href=&quot;https://grokdebug.herokuapp.com/&quot;&gt;https://grokdebug.herokuapp.com/&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
      <category term="ELK" scheme="http://www.yfshare.vip/categories/ELK/"/>
    
    
      <category term="Grok" scheme="http://www.yfshare.vip/tags/Grok/"/>
    
  </entry>
  
  <entry>
    <title>Logstash配置语法</title>
    <link href="http://www.yfshare.vip/2017/11/22/Logstash%E9%85%8D%E7%BD%AE%E8%AF%AD%E6%B3%95/"/>
    <id>http://www.yfshare.vip/2017/11/22/Logstash配置语法/</id>
    <published>2017-11-22T14:26:39.000Z</published>
    <updated>2017-11-22T14:36:00.441Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/APlayer.min.js"> </script><script src="/assets/js/DPlayer.min.js"> </script><p>Logstash 社区通常习惯用 shipper，broker 和 indexer 来描述数据流中不同进程各自的角色<br><a id="more"></a><br>Logstash设计了自己的DSL。包含有  </p>
<ul>
<li>区域</li>
<li>注释</li>
<li>数据类型(布尔值，字符串，数值，数组，哈希)</li>
<li>条件判断</li>
<li>字段引用等<br><img src="http://note.youdao.com/yws/api/personal/file/5ABEC6BA6184467BA639CD46B67E6AD1?method=download&amp;shareKey=6411709c4a0ddd05944af76c3744134d" alt="Lostash角色">  </li>
</ul>
<h4 id="区段-section"><a href="#区段-section" class="headerlink" title="区段(section)"></a>区段(section)</h4><p>Logstash用<code>{}</code>来定义区域。区域内可以包括插件区域定义，可以在一个区域内定义多个插件。插件区域内则可以定义键值对设置。示例如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">input &#123;</div><div class="line">    stdin &#123;&#125;</div><div class="line">    syslog &#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h4><p>Logstash 支持少量的数据值类型：</p>
<ul>
<li>bool<br><code>debug =&gt; true</code></li>
<li>string<br><code>host =&gt; &quot;hostname&quot;</code></li>
<li>number<br><code>port =&gt; 514</code></li>
<li>array<br><code>match =&gt; [&quot;datetime&quot;, &quot;UNIX&quot;, &quot;ISO8601&quot;]</code></li>
<li>hash  <figure class="highlight coq"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">options =&gt; &#123;</div><div class="line">    key1 =&gt; <span class="string">"value1"</span>,</div><div class="line">    key2 =&gt; <span class="string">"value2"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>注：如果你用的版本低于 1.2.0，哈希的语法跟数组是一样的，如： <code>match =&gt; [ &quot;field1&quot;, &quot;pattern1&quot;, &quot;field2&quot;, &quot;pattern2&quot; ]</code>  </p>
<h4 id="字段引用-field-reference"><a href="#字段引用-field-reference" class="headerlink" title="字段引用(field reference)"></a>字段引用(field reference)</h4><p>字段是Logstash::Event对象的属性。之前提过事件就像一个哈希一样，所以可以想象字段就像一个键值对。<br>如果在Logstash配置中使用字段的值，只需要把字段的名字写在中括号 [] 里就行了，这就叫字段引用。<br>对于嵌套字段(也就是多维哈希表，或者叫哈希的哈希)，每层的字段名都写在 [] 里。如，可以从 geoip 里这样获取 longitude 值<br><code>[geoip][location][0]</code><br>注：logstash 的数组也支持倒序下标，即<code>[geoip][location][-1]</code>可以获取数组最后一个元素的值。<br>Logstash 还支持变量内插，在字符串里使用字段引用的方法是：<br><code>&quot;the longitude is %{[geoip][location][0]}&quot;</code>  </p>
<h4 id="条件判断-condition"><a href="#条件判断-condition" class="headerlink" title="条件判断(condition)"></a>条件判断(condition)</h4><p>Logstash从 1.3.0 版开始支持条件判断和表达式。<br>表达式支持下面这些操作符：  </p>
<ul>
<li><code>==</code>(等于), <code>!=</code>(不等于), <code>&lt;</code>(小于), <code>&gt;</code>(大于), <code>&lt;=</code>(小于等于), <code>&gt;=</code>(大于等于)  </li>
<li><code>=~</code>(匹配正则), <code>!~</code>（不匹配正则）  </li>
<li><code>in</code>(包含), <code>not in</code>(不包含)  </li>
<li><code>and</code>(与), <code>or</code>(或), <code>nand</code>(非与), <code>xor</code>(非或)  </li>
<li><code>()</code>(复合表达式), <code>!()</code>(对复合表达式结果取反)<br>通常来说，你都会在表达式里用到字段引用。为了尽量展示全面各种表达式，下面虚拟一个示例：  <figure class="highlight markdown"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">if "_grokparsefailure" not in [tags] &#123;</div><div class="line">&#125; else if [<span class="string">status</span>] !~ /^2\d\d/ or ( [<span class="string">url</span>] == "/noc.gif" nand [<span class="string">geoip</span>][<span class="symbol">city</span>] != "beijing" ) &#123;</div><div class="line">&#125; else &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="命令行参数"><a href="#命令行参数" class="headerlink" title="命令行参数"></a>命令行参数</h4><p>Logstash 提供了一个 shell 脚本叫 logstash 方便快速运行。它支持以下参数：  </p>
<ul>
<li><p><code>-e</code><br>意即执行。我们在 “Hello World” 的时候已经用过这个参数了。事实上你可以不写任何具体配置，直接运行 <code>bin/logstash -e &#39;&#39;</code> 达到相同效果。这个参数的默认值是下面这样：  </p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class">input </span>&#123;</div><div class="line">    <span class="class">stdin </span>&#123; &#125;</div><div class="line">&#125;</div><div class="line"><span class="class">output </span>&#123;</div><div class="line">    <span class="class">stdout </span>&#123; &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p><code>--config</code> 或 <code>-f</code><br>意即文件。真实运用中，我们会写很长的配置，甚至可能超过 shell 所能支持的 1024 个字符长度。所以我们必把配置固化到文件里，然后通过 <code>bin/logstash -f agent.conf</code> 这样的形式来运行。<br>此外，logstash 还提供一个方便我们规划和书写配置的小功能。你可以直接用 <code>bin/logstash -f /etc/logstash.d/</code> 来运行。logstash 会自动读取 <code>/etc/logstash.d/</code> 目录下所有<code>*.conf</code>的文本文件，然后在自己内存里拼接成一个完整的大配置文件，再去执行。<br>#注意：logstash 列出目录下所有文件时，是字母排序的。而 logstash 配置段的 <code>filter</code> 和 <code>output</code> 都是顺序执行，所以顺序非常重要。采用多文件管理的用户，推荐采用数字编号方式命名配置文件，同时在配置中，严谨采用 if 判断限定不同日志的动作。</p>
</li>
<li><code>--configtest</code> 或 <code>-t</code><br>意即测试。用来测试 Logstash 读取到的配置文件语法是否能正常解析。Logstash 配置语法是用 <code>grammar.treetop</code> 定义的。尤其是使用了上一条提到的读取目录方式的读者，尤其要提前测试。  </li>
<li><code>--log</code> 或 <code>-l</code><br>意即日志。Logstash 默认输出日志到标准错误。生产环境下你可以通过<code>bin/logstash -l logs/logstash.log</code>命令来统一存储日志。  </li>
<li><code>--pipeline-workers</code> 或 <code>-w</code><br>运行 filter 和 output 的 pipeline 线程数量。默认是 CPU 核数。  </li>
<li><code>--pipeline-batch-size</code> 或 <code>-b</code><br>每个 Logstash pipeline 线程，在执行具体的 filter 和 output 函数之前，最多能累积的日志条数。默认是 125 条。越大性能越好，同样也会消耗越多的 JVM 内存。  <ul>
<li><code>--pipeline-batch-delay</code> 或 <code>-u</code><br>每个 Logstash pipeline 线程，在打包批量日志的时候，最多等待几毫秒。默认是 5 ms。  </li>
</ul>
</li>
<li><code>--pluginpath</code> 或 <code>-P</code><br>可以写自己的插件，然后用<code>bin/logstash --pluginpath /path/to/own/plugins</code>加载它们。  </li>
<li><code>--verbose</code><br>输出一定的调试日志。  </li>
<li><code>--debug</code><br>输出更多的调试日志。  </li>
</ul>
<h4 id="设置文件"><a href="#设置文件" class="headerlink" title="设置文件"></a>设置文件</h4><p>从 Logstash 5.0 开始，新增了<code>$LS_HOME/config/logstash.yml</code> 文件，可以将所有的命令行参数都通过 <code>YAML</code> 文件方式设置。同时为了反映命令行配置参数的层级关系，参数也都改成用.而不是-了。<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">pipeline:</span></div><div class="line"><span class="symbol">    workers:</span> <span class="number">24</span></div><div class="line"><span class="symbol">    batch:</span></div><div class="line"><span class="symbol">        size:</span> <span class="number">125</span></div><div class="line"><span class="symbol">        delay:</span> <span class="number">5</span></div></pre></td></tr></table></figure></p>
<p>参考文档：<a href="http://kibana.logstash.es/content/logstash/get-start/full-config.html" target="_blank" rel="external">http://kibana.logstash.es/content/logstash/get-start/full-config.html</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/11/22/Logstash配置语法/">http://www.yfshare.vip/2017/11/22/Logstash配置语法/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Logstash 社区通常习惯用 shipper，broker 和 indexer 来描述数据流中不同进程各自的角色&lt;br&gt;
    
    </summary>
    
      <category term="ELK" scheme="http://www.yfshare.vip/categories/ELK/"/>
    
    
      <category term="Logstash" scheme="http://www.yfshare.vip/tags/Logstash/"/>
    
  </entry>
  
  <entry>
    <title>ELK安装(基础)</title>
    <link href="http://www.yfshare.vip/2017/11/22/ELK%E5%AE%89%E8%A3%85-%E5%9F%BA%E7%A1%80/"/>
    <id>http://www.yfshare.vip/2017/11/22/ELK安装-基础/</id>
    <published>2017-11-22T13:28:46.000Z</published>
    <updated>2017-11-22T13:46:46.545Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/APlayer.min.js"> </script><script src="/assets/js/DPlayer.min.js"> </script><p>ELK是三个开源软件的缩写，分别表示：Elasticsearch , Logstash, Kibana , 它们都是开源软件<br><a id="more"></a></p>
<ol>
<li>Elasticsearch是一个高度可扩展的开源全文搜索和分析引擎，特点：分布式、零配置、自动发现、索引自动分片、索引副本机制、restful风格接口、多数据源、自动搜索负载等。</li>
<li>Logstash 是一个完全开源的工具，对日志收集、分析、并存储。</li>
<li>Kibana 是一个数据可视化平台，可以通过将数据转化为酷炫而强大的图像而实现与数据的交互，为Logstash和elasticsearch提供WEB界面。<br>将三者的收集加工，存储分析和可视转化整合在一起就形成了 ELK<br>目前这三个软件最新版为logstash-5.1.1、elasticsearch-5.1.1、kibana-5.1.1 （文章很早前写的）</li>
</ol>
<p>ELK官网：<a href="https://www.elastic.co/" target="_blank" rel="external">https://www.elastic.co/</a><br>ELK下载：<a href="https://www.elastic.co/downloads" target="_blank" rel="external">https://www.elastic.co/downloads</a><br>ELK官方文档：<a href="https://www.elastic.co/guide/index.html" target="_blank" rel="external">https://www.elastic.co/guide/index.html</a><br>ELK中文指南：<a href="http://kibana.logstash.es/content/logstash/" target="_blank" rel="external">http://kibana.logstash.es/content/logstash/</a><br>　　　　　　　<a href="https://endymecy.gitbooks.io/elasticsearch-guide-chinese/content/getting-started/README.html" target="_blank" rel="external">https://endymecy.gitbooks.io/elasticsearch-guide-chinese/content/getting-started/README.html</a><br>　　　　　　　<a href="http://udn.yyuap.com/doc/logstash-best-practice-cn/index.html" target="_blank" rel="external">http://udn.yyuap.com/doc/logstash-best-practice-cn/index.html</a>  </p>
<p>环境：Centos 6.6<br>　　　ElasticSearch 5.1.1<br>　　　Logstash 5.1.1<br>　　　Kibana 5.1.1  </p>
<p>要求：JDK 1.8+，最好是1.8.0_73  </p>
<p>安装elasticsearch参考文档：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/install-elasticsearch.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/reference/5.1/install-elasticsearch.html</a><br>安装kibana参考文档：<a href="https://www.elastic.co/guide/en/kibana/5.1/install.html" target="_blank" rel="external">https://www.elastic.co/guide/en/kibana/5.1/install.html</a><br>安装logstash参考文档：<a href="https://www.elastic.co/guide/en/logstash/5.1/installing-logstash.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/5.1/installing-logstash.html</a><br>简单测试参考：<a href="https://www.elastic.co/guide/en/logstash/5.1/first-event.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/5.1/first-event.html</a>  </p>
<h3 id="环境部署"><a href="#环境部署" class="headerlink" title="环境部署"></a>环境部署</h3><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@ELK ~]<span class="comment"># wget http://download.oracle.com/otn/java/jdk/8u73-b02/jdk-8u73-linux-x64.tar.gz?AuthParam=1481271284_8426bd60d7c0a8e617ffa072288f5b3d</span></div><div class="line">[root@ELK ~]<span class="comment"># wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.1.1.rpm</span></div><div class="line">[root@ELK ~]<span class="comment"># wget https://artifacts.elastic.co/downloads/kibana/kibana-5.1.1-x86_64.rpm</span></div><div class="line">[root@ELK ~]<span class="comment"># wget https://artifacts.elastic.co/downloads/logstash/logstash-5.1.1.rpm</span></div><div class="line"></div><div class="line">[root@ELK ~]<span class="comment"># java -version</span></div><div class="line"><span class="keyword">java </span>version <span class="string">"1.8.0_73"</span></div><div class="line"><span class="keyword">Java(TM) </span>SE Runtime Environment (<span class="keyword">build </span><span class="number">1</span>.<span class="number">8</span>.<span class="number">0</span>_73-<span class="keyword">b02)</span></div><div class="line"><span class="keyword">Java </span>HotSpot(TM) <span class="number">64</span>-<span class="keyword">Bit </span>Server VM (<span class="keyword">build </span><span class="number">25</span>.<span class="number">73</span>-<span class="keyword">b02, </span>mixed mode)</div><div class="line">[root@ELK ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#安装elasticsearch</span></div><div class="line">[root@ELK ~]<span class="comment"># yum -y install elasticsearch-5.1.1.rpm</span></div><div class="line">[root@ELK ~]<span class="comment"># mkdir -p /var/log/elasticsearch</span></div><div class="line">[root@ELK ~]<span class="comment"># grep -v '^$' /etc/elasticsearch/elasticsearch.yml | grep -v ^#</span></div><div class="line">path.data: /etc/elasticsearch/data  <span class="comment">#数据文件存放路径</span></div><div class="line">path.logs: /var/<span class="built_in">log</span>/elasticsearch   <span class="comment">#日志文件存放路径</span></div><div class="line"><span class="comment">#注：Elasticsearch本身是不允许外界访问的，所以只能把network.host设置为127.0.0.1或0.0.0.0，而它默认也是这个值，如果设为其他的值，日志里面会报错，Elasticsearch起不来</span></div><div class="line">[root@ELK ~]<span class="comment">#</span></div><div class="line">[root@ELK ~]<span class="comment"># mkdir -p /etc/elasticsearch/data/</span></div><div class="line">[root@ELK ~]<span class="comment"># chmod 775 /etc/elasticsearch/data/</span></div><div class="line">[root@ELK ~]<span class="comment"># chgrp elasticsearch /etc/elasticsearch/data/ -R</span></div><div class="line">[root@ELK ~]<span class="comment"># chkconfig --add elasticsearch</span></div><div class="line">[root@ELK ~]<span class="comment"># chkconfig elasticsearch on</span></div><div class="line">[root@ELK ~]<span class="comment"># /etc/init.d/elasticsearch start</span></div><div class="line"></div><div class="line"><span class="comment">#在Centos7中用systemctl start elasticsearch时，报" elasticsearch[10925]: which: no java in (/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin)"，需要在" /etc/sysconfig/elasticsearch "配置文件中指定“JAVA_HOME”路径</span></div><div class="line"></div><div class="line">[root@ELK ~]<span class="comment"># ps -ef | grep elasticsearch | grep -v grep</span></div><div class="line">498        3508      1 75 19:20 ?        00:00:10 /usr/<span class="built_in">local</span>/jdk1.8.0_73/bin/java -Xms2g -Xmx2g -XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFraction=75 -XX:+UseCMSInitiatingOccupancyOnly -XX:+DisableExplicitGC -XX:+AlwaysPreTouch -server -Xss1m -Djava.awt.headless=<span class="literal">true</span> -Dfile.encoding=UTF-8 -Djna.nosys=<span class="literal">true</span> -Djdk.io.permissionsUseCanonicalPath=<span class="literal">true</span> -Dio.netty.noUnsafe=<span class="literal">true</span> -Dio.netty.noKeySetOptimization=<span class="literal">true</span> -D<span class="built_in">log</span>4j.shutdownHookEnabled=<span class="literal">false</span> -D<span class="built_in">log</span>4j2.disable.jmx=<span class="literal">true</span> -D<span class="built_in">log</span>4j.skipJansi=<span class="literal">true</span> -XX:+HeapDumpOnOutOfMemoryError -Des.path.home=/usr/share/elasticsearch -cp /usr/share/elasticsearch/lib/elasticsearch-5.1.1.jar:/usr/share/elasticsearch/lib/* org.elasticsearch.bootstrap.Elasticsearch -p /var/run/elasticsearch/elasticsearch.pid <span class="_">-d</span> -Edefault.path.logs=/var/<span class="built_in">log</span>/elasticsearch -Edefault.path.data=/var/lib/elasticsearch -Edefault.path.conf=/etc/elasticsearch</div><div class="line">[root@ELK ~]<span class="comment">#</span></div><div class="line"><span class="comment">#通过日志观察，elasticsearch监听了9200(http port)和9300俩端口</span></div><div class="line">[root@ELK ~]<span class="comment"># ss -tunlp | grep 9200</span></div><div class="line">tcp    LISTEN     0      128     ::ffff:127.0.0.1:9200                 :::*      users:((<span class="string">"java"</span>,3508,108))</div><div class="line">tcp    LISTEN     0      128                  ::1:9200                 :::*      users:((<span class="string">"java"</span>,3508,109))</div><div class="line">[root@ELK ~]<span class="comment"># ss -tunlp | grep 9300</span></div><div class="line">tcp    LISTEN     0      128     ::ffff:127.0.0.1:9300                 :::*      users:((<span class="string">"java"</span>,3508,101))</div><div class="line">tcp    LISTEN     0      128                  ::1:9300                 :::*      users:((<span class="string">"java"</span>,3508,99))</div><div class="line">[root@ELK ~]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@ELK ~]<span class="comment"># curl 'http://localhost:9200'   #显示这个就表示启动成功了</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"name"</span> : <span class="string">"mlayMmR"</span>,</div><div class="line">  <span class="string">"cluster_name"</span> : <span class="string">"elasticsearch"</span>,</div><div class="line">  <span class="string">"cluster_uuid"</span> : <span class="string">"QIe1zquiRS24X-NsfmwTNA"</span>,</div><div class="line">  <span class="string">"version"</span> : &#123;</div><div class="line">    <span class="string">"number"</span> : <span class="string">"5.6.1"</span>,</div><div class="line">    <span class="string">"build_hash"</span> : <span class="string">"667b497"</span>,</div><div class="line">    <span class="string">"build_date"</span> : <span class="string">"2017-09-14T19:22:05.189Z"</span>,</div><div class="line">    <span class="string">"build_snapshot"</span> : <span class="literal">false</span>,</div><div class="line">    <span class="string">"lucene_version"</span> : <span class="string">"6.6.1"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"tagline"</span> : <span class="string">"You Know, for Search"</span></div><div class="line">&#125;</div><div class="line">[root@ELK ~]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@ELK ~]<span class="comment"># curl localhost:9200/_cat/health?v   #集群健康检查</span></div><div class="line">epoch      timestamp cluster       status node.total node.data shards pri relo init unassign pending_tasks max_task_wait_time active_shards_percent</div><div class="line">1481282834 19:27:14  elasticsearch yellow          1         1      1   1    0    0        1             0                  -                 50.0%</div><div class="line">[root@ELK ~]<span class="comment"># curl localhost:9200/_cat/nodes?v    #获取集群中节点列表</span></div><div class="line">ip        heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name</div><div class="line">127.0.0.1            3          96   9    0.06    0.20     0.19 mdi       *      9AsElX3</div><div class="line">[root@ELK ~]<span class="comment">#</span></div><div class="line">[root@ELK ~]<span class="comment"># curl localhost:9200/_cat/allocation?v</span></div><div class="line">shards disk.indices disk.used disk.avail disk.total disk.percent host      ip        node</div><div class="line">     1        3.1kb     4.7gb     44.3gb       49gb            9 127.0.0.1 127.0.0.1 9AsElX3</div><div class="line">     1                                                                               UNASSIGNED</div><div class="line">[root@ELK ~]<span class="comment">#</span></div><div class="line">[root@ELK ~]<span class="comment"># curl 'localhost:9200/_cat/indices?v'     #获取ElasticSearch索引</span></div><div class="line">health status index                       uuid                   pri rep docs.count docs.deleted store.size pri.store.size</div><div class="line">yellow open   logstash-message-2016.12.23 6apP2ZYOQnyewF9E7zNIsQ   5   1       1999            0      1.1mb          1.1mb</div><div class="line">yellow open   logstash-message-2016.12.27 5cisTsn1RKS3oUcAcTERbw   5   1       1195            0    924.6kb        924.6kb</div><div class="line">yellow open   .kibana                     z4SDEnWrRnePE3tcz_woLA   1   1          2            0      9.6kb          9.6kb</div><div class="line">[root@ELK ~]<span class="comment">#</span></div><div class="line"><span class="comment">#yellow黄色意味着某些复制没有（或者还未）被分配。因为现在是单节点所以不能被复制，当另一节点加入集群后会复制，则会变成绿色</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#安装kibana</span></div><div class="line">[root@ELK ~]<span class="comment"># yum -y install kibana-5.1.1-x86_64.rpm</span></div><div class="line">[root@ELK ~]<span class="comment"># grep -v '^$' /etc/kibana/kibana.yml | grep -v '^#'</span></div><div class="line">server.host: <span class="string">"192.168.31.100"</span></div><div class="line">elasticsearch.url: <span class="string">"http://localhost:9200"</span></div><div class="line">[root@ELK ~]<span class="comment">#</span></div><div class="line">[root@ELK ~]<span class="comment"># chkconfig --add kibana</span></div><div class="line">[root@ELK ~]<span class="comment"># chkconfig kibana on</span></div><div class="line">[root@ELK ~]<span class="comment"># /etc/init.d/kibana start</span></div><div class="line">kibana started</div><div class="line">[root@ELK ~]<span class="comment"># ps -ef | grep kibana | grep -v grep</span></div><div class="line">kibana     3613      1 37 19:38 pts/0    00:00:16 /usr/share/kibana/bin/../node/bin/node --no-warnings /usr/share/kibana/bin/../src/cli -c /etc/kibana/kibana.yml</div><div class="line">[root@ELK ~]<span class="comment"># ss -tunlp | grep 5601</span></div><div class="line">tcp    LISTEN     0      128       192.168.31.100:5601                  *:*      users:((<span class="string">"node"</span>,3613,11))</div><div class="line">[root@ELK ~]<span class="comment">#</span></div><div class="line"><span class="comment">#kibana日志文件位置</span></div><div class="line">[root@ELK ~]<span class="comment"># ls /var/log/kibana/</span></div><div class="line">kibana.stderr  kibana.stdout</div><div class="line">[root@ELK ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#安装logstash</span></div><div class="line"><span class="comment">#需要对Java做软链接，链接到/usr/bin/java，否则安装logstash-5.1.1.rpm时报错</span></div><div class="line">[root@ELK ~]<span class="comment"># ln -s /usr/local/jdk1.8.0_73/bin/java /usr/bin/</span></div><div class="line">[root@ELK ~]<span class="comment"># whereis java</span></div><div class="line">java: /usr/bin/java</div><div class="line">[root@ELK ~]<span class="comment">#</span></div><div class="line">[root@ELK ~]<span class="comment"># yum -y install logstash-5.1.1.rpm</span></div><div class="line">[root@ELK ~]<span class="comment"># ls /usr/share/logstash/bin/</span></div><div class="line">cpdump  logstash  logstash.bat  logstash.lib.sh  logstash-plugin  logstash-plugin.bat  setup.bat  system-install</div><div class="line">[root@ELK ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h3 id="logstash调试"><a href="#logstash调试" class="headerlink" title="logstash调试"></a>logstash调试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#简单测试1</span></div><div class="line">[root@ELK ~]<span class="comment"># /usr/share/logstash/bin/logstash --path.settings /etc/logstash -e 'input &#123; stdin &#123; &#125; &#125; output &#123; stdout &#123;&#125; &#125;'</span></div><div class="line">Sending Logstash<span class="string">'s logs to /var/log/logstash which is now configured via log4j2.properties</span></div><div class="line">The stdin plugin is now waiting for input:</div><div class="line">hello world</div><div class="line">2016-12-12T09:36:50.758Z 0.0.0.0 hello world</div><div class="line">...</div><div class="line">注：要加--path.settings /etc/logstash指定配置文件目录，否则报错</div><div class="line">#再启一个窗口可以看到logstash进程，不能关掉上面测试命令，screen(crtl+D)后台运行</div><div class="line">[root@ELK ~]# ps -ef | grep logstash</div><div class="line">root       1934   1153 14 17:33 pts/0    00:03:35 /usr/local/jdk1.8.0_73/bin/java -XX:+UseParNewGC -XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFraction=75 -XX:+UseCMSInitiatingOccupancyOnly -XX:+DisableExplicitGC -Djava.awt.headless=true -Dfile.encoding=UTF-8 -XX:+HeapDumpOnOutOfMemoryError -Xmx1g -Xms256m -Xss2048k -Djffi.boot.library.path=/usr/share/logstash/vendor/jruby/lib/jni -Xbootclasspath/a:/usr/share/logstash/vendor/jruby/lib/jruby.jar -classpath : -Djruby.home=/usr/share/logstash/vendor/jruby -Djruby.lib=/usr/share/logstash/vendor/jruby/lib -Djruby.script=jruby -Djruby.shell=/bin/sh org.jruby.Main --1.9 /usr/share/logstash/lib/bootstrap/environment.rb logstash/runner.rb --path.settings /etc/logstash -e input &#123; stdin &#123; &#125; &#125; output &#123; stdout &#123;&#125; &#125;</div><div class="line">root       2012   1982  0 17:57 pts/2    00:00:00 grep logstash</div><div class="line">[root@ELK ~]#</div><div class="line">#Logstash日志文件位置</div><div class="line">[root@ELK ~]# tail -f /var/log/logstash/logstash-plain.log</div><div class="line">[2016-12-12T17:34:11,669][INFO ][logstash.agent           ] No config files found in path &#123;:path=&gt;"/etc/logstash/conf.d/*"&#125;</div><div class="line">[2016-12-12T17:34:12,498][INFO ][logstash.pipeline        ] Starting pipeline &#123;"id"=&gt;"main", "pipeline.workers"=&gt;1, "pipeline.batch.size"=&gt;125, "pipeline.batch.delay"=&gt;5, "pipeline.max_inflight"=&gt;125&#125;</div><div class="line">[2016-12-12T17:34:12,517][INFO ][logstash.pipeline        ] Pipeline main started</div><div class="line">[2016-12-12T17:34:13,000][INFO ][logstash.agent           ] Successfully started Logstash API endpoint &#123;:port=&gt;9600&#125;</div><div class="line">···</div></pre></td></tr></table></figure>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#简单测试2</span></div><div class="line">[root@<span class="type">ELK</span> ~]<span class="comment"># cat /etc/logstash/conf.d/test.conf </span></div><div class="line">input &#123;</div><div class="line">	<span class="literal">stdin</span> &#123;&#125;</div><div class="line">&#125;</div><div class="line">output &#123;</div><div class="line">	<span class="literal">stdout</span> &#123;</div><div class="line">		codec =&gt; rubydebug&#123;&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">[root@<span class="type">ELK</span> ~]<span class="comment">#</span></div><div class="line">[root@<span class="type">ELK</span> ~]<span class="comment"># /usr/share/logstash/bin/logstash --path.settings /etc/logstash -f /etc/logstash/conf.d/test.conf</span></div><div class="line"><span class="type">Sending</span> <span class="type">Logstash</span>'s logs to /<span class="keyword">var</span>/log/logstash which <span class="keyword">is</span> now configured via log4j2.properties</div><div class="line"><span class="type">The</span> <span class="literal">stdin</span> plugin <span class="keyword">is</span> now waiting <span class="keyword">for</span> input:</div><div class="line"></div><div class="line">&#123;</div><div class="line">    <span class="string">"@timestamp"</span> =&gt; <span class="number">2016</span>-<span class="number">12</span>-<span class="number">13</span>T09:<span class="number">24</span>:<span class="number">18</span>.<span class="number">123</span>Z,</div><div class="line">      <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,</div><div class="line">          <span class="string">"host"</span> =&gt; <span class="string">"0.0.0.0"</span>,</div><div class="line">       <span class="string">"message"</span> =&gt; <span class="string">""</span>,</div><div class="line">          <span class="string">"tags"</span> =&gt; []</div><div class="line">&#125;</div><div class="line">hello world</div><div class="line">&#123;</div><div class="line">    <span class="string">"@timestamp"</span> =&gt; <span class="number">2016</span>-<span class="number">12</span>-<span class="number">13</span>T09:<span class="number">24</span>:<span class="number">26</span>.<span class="number">328</span>Z,</div><div class="line">      <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,</div><div class="line">          <span class="string">"host"</span> =&gt; <span class="string">"0.0.0.0"</span>,</div><div class="line">       <span class="string">"message"</span> =&gt; <span class="string">"hello world"</span>,</div><div class="line">          <span class="string">"tags"</span> =&gt; []</div><div class="line">&#125;</div><div class="line"><span class="comment">#host 标记事件发生在哪里。</span></div><div class="line"><span class="comment">#type 标记事件的唯一类型。</span></div><div class="line"><span class="comment">#tags 标记事件的某方面属性。这是一个数组，一个事件可以有多个标签。</span></div><div class="line"><span class="comment">#注：每个 logstash 过滤插件，都会有四个方法叫 add_tag, remove_tag, add_field 和 remove_field。它们在插件过滤匹配成功时生效</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#后台运行Logstash</span></div><div class="line">1. nohup /usr/share/logstash/bin/logstash --path.settings /etc/logstash <span class="_">-f</span> /etc/logstash/conf.d/test.conf &amp;</div><div class="line">2. screen -S logstash_start</div><div class="line">screen会新开一个会话</div><div class="line">输入/usr/share/logstash/bin/logstash --path.settings /etc/logstash <span class="_">-f</span> /etc/logstash/conf.d/test.conf，按ctrl+A+D</div><div class="line">[root@ELK ~]<span class="comment"># ps -ef | grep logstash | grep -v grep</span></div><div class="line">root      11458      1  0 17:34 ?        00:00:00 SCREEN -S logstash_start</div><div class="line">root      11505  11459 55 17:35 pts/2    00:00:54 /usr/<span class="built_in">local</span>/jdk1.8.0_73/bin/java -XX:+UseParNewGC -XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFraction=75 -XX:+UseCMSInitiatingOccupancyOnly -XX:+DisableExplicitGC -Djava.awt.headless=<span class="literal">true</span> -Dfile.encoding=UTF-8 -XX:+HeapDumpOnOutOfMemoryError -Xmx1g -Xms256m -Xss2048k -Djffi.boot.library.path=/usr/share/logstash/vendor/jruby/lib/jni -Xbootclasspath/a:/usr/share/logstash/vendor/jruby/lib/jruby.jar -classpath : -Djruby.home=/usr/share/logstash/vendor/jruby -Djruby.lib=/usr/share/logstash/vendor/jruby/lib -Djruby.script=jruby -Djruby.shell=/bin/sh org.jruby.Main --1.9 /usr/share/logstash/lib/bootstrap/environment.rb logstash/runner.rb --path.settings /etc/logstash <span class="_">-f</span> /etc/logstash/conf.d/test.conf</div><div class="line">logstash  11554      1 79 17:36 ?        00:00:22 /usr/bin/java -XX:+UseParNewGC -XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFraction=75 -XX:+UseCMSInitiatingOccupancyOnly -XX:+DisableExplicitGC -Djava.awt.headless=<span class="literal">true</span> -Dfile.encoding=UTF-8 -XX:+HeapDumpOnOutOfMemoryError -Xmx1g -Xms256m -Xss2048k -Djffi.boot.library.path=/usr/share/logstash/vendor/jruby/lib/jni -Xbootclasspath/a:/usr/share/logstash/vendor/jruby/lib/jruby.jar -classpath : -Djruby.home=/usr/share/logstash/vendor/jruby -Djruby.lib=/usr/share/logstash/vendor/jruby/lib -Djruby.script=jruby -Djruby.shell=/bin/sh org.jruby.Main --1.9 /usr/share/logstash/lib/bootstrap/environment.rb logstash/runner.rb --path.settings /etc/logstash</div><div class="line">[root@ELK ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">logstash-output-stdout插件，最主要的用途是调试。在其不太有效时，加上命令行参数 -vv 运行，查看更多详细的调试信息</div></pre></td></tr></table></figure>
<h3 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q &amp; A"></a>Q &amp; A</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#如果启动多个logstash需要手动指定 --path.data /data/ELK_data/logstash/data_1.21_program 才行，否则报错.</span></div><div class="line"></div><div class="line">报错信息：Logstash could not be started because there is already another instance using the configured data directory.  If you wish to run multiple instances, you must change the <span class="string">"path.data"</span> setting.</div><div class="line"></div><div class="line">[root@ELK ~]<span class="comment"># /usr/share/logstash/bin/logstash --path.settings /etc/logstash/ -f /etc/logstash/conf.d/logstash_192.168.1.21.conf --path.data /data/ELK_data/logstash/data_1.21_program</span></div><div class="line">Sending Logstash<span class="string">'s logs to /data/ELK_data/logstash/logs which is now configured via log4j2.properties</span></div></pre></td></tr></table></figure>
<p>访问<a href="http://ip:5601打开kibana首页" target="_blank" rel="external">http://ip:5601打开kibana首页</a><br><img src="http://note.youdao.com/yws/api/personal/file/12B3FD77299D42BAB4FA2226F3C5EDF2?method=download&amp;shareKey=c514141f708fb56c52d0b33d4a40cf8d" alt="image">  </p>
<p>logstash流程图：<br><img src="http://note.youdao.com/yws/api/personal/file/C09204B066524EA4BC2893B6224E02A6?method=download&amp;shareKey=fe98a78bb4797c7d75f6e8d8350e7c4e" alt="image">  </p>
<p>===============================<br>Question1：如果日志里面报内核问题，可以忽略，我现在用的是Centos 6.6，内核是2.6，所以会报错..<br>参考：<a href="https://discuss.elastic.co/t/elasticsearch-warn-unable-to-install-syscall-filter/42819/1" target="_blank" rel="external">https://discuss.elastic.co/t/elasticsearch-warn-unable-to-install-syscall-filter/42819/1</a><br><img src="http://note.youdao.com/yws/api/personal/file/F11F2EFCDC334D0AA76BBE60643FD2EF?method=download&amp;shareKey=4b5f95081f8a0e4024ade293e181707d" alt="image">  </p>
<p>Question2：<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">需要对Java做软链接，链接到<span class="meta-keyword">/usr/</span>bin/java，否则安装logstash<span class="number">-5.1</span><span class="number">.1</span>.rpm时报错</div><div class="line"><span class="meta">#报错信息如下：↓↓↓↓↓↓↓↓↓</span></div><div class="line">Running Transaction</div><div class="line">  Installing : <span class="number">1</span>:logstash<span class="number">-5.1</span><span class="number">.1</span><span class="number">-1.</span>noarch                                                                                          <span class="number">1</span>/<span class="number">1</span> </div><div class="line">Using provided startup.options file: <span class="meta-keyword">/etc/</span>logstash/startup.options</div><div class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/logstash/</span>vendor<span class="meta-keyword">/jruby/</span>bin/jruby: line <span class="number">388</span>: <span class="meta-keyword">/usr/</span>bin/java: No such file or directory</div><div class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/logstash/</span>vendor<span class="meta-keyword">/jruby/</span>bin/jruby: line <span class="number">388</span>: exec: <span class="meta-keyword">/usr/</span>bin/java: cannot execute: No such file or directory</div><div class="line">Unable to install system startup script for Logstash.</div><div class="line">  Verifying  : <span class="number">1</span>:logstash<span class="number">-5.1</span><span class="number">.1</span><span class="number">-1.</span>noarch                                                                                          <span class="number">1</span>/<span class="number">1</span> </div><div class="line"><span class="symbol"></span></div><div class="line">Installed:</div><div class="line">  logstash.noarch <span class="number">1</span>:<span class="number">5.1</span><span class="number">.1</span><span class="number">-1</span>                                                                                                    </div><div class="line"></div><div class="line">Complete!</div><div class="line">[root@ELK ~]<span class="meta">#</span></div><div class="line"><span class="meta">#↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span></div><div class="line">卸载重新安装logstash<span class="number">-5.1</span><span class="number">.1</span>.rpm即可</div><div class="line">[root@ELK ~]<span class="meta"># ln -s /usr/local/jdk1.8.0_73/bin/java /usr/bin/</span></div><div class="line">[root@ELK ~]<span class="meta"># whereis java</span></div><div class="line"><span class="symbol">java:</span> <span class="meta-keyword">/usr/</span>bin/java</div><div class="line">[root@ELK ~]<span class="meta">#</span></div></pre></td></tr></table></figure></p>
<p>Question3：简单测试时需要指定配置文件路径，yum否则报错<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root<span class="meta">@ELK</span> ~]# /usr/share/logstash/bin/logstash -e <span class="string">'input &#123; stdin &#123; &#125; &#125; output &#123; stdout &#123;&#125; &#125;'</span></div><div class="line">WARNING: Could not find logstash.yml which <span class="keyword">is</span> typically located <span class="keyword">in</span> $LS_HOME/config or /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults</div><div class="line">Could not find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using <span class="keyword">default</span> config which logs to console</div><div class="line">The stdin plugin <span class="keyword">is</span> now waiting <span class="keyword">for</span> input:</div><div class="line"><span class="number">17</span>:<span class="number">06</span>:<span class="number">57.595</span> [[main]-pipeline-manager] INFO  logstash.pipeline - Starting pipeline &#123;<span class="string">"id"</span>=&gt;<span class="string">"main"</span>, <span class="string">"pipeline.workers"</span>=&gt;<span class="number">1</span>, <span class="string">"pipeline.batch.size"</span>=&gt;<span class="number">125</span>, <span class="string">"pipeline.batch.delay"</span>=&gt;<span class="number">5</span>, <span class="string">"pipeline.max_inflight"</span>=&gt;<span class="number">125</span>&#125;</div><div class="line"><span class="number">17</span>:<span class="number">06</span>:<span class="number">57.607</span> [[main]-pipeline-manager] INFO  logstash.pipeline - Pipeline main started</div><div class="line"><span class="number">17</span>:<span class="number">06</span>:<span class="number">57.738</span> [Api Webserver] INFO  logstash.agent - Successfully started Logstash API endpoint &#123;:port=&gt;<span class="number">9600</span>&#125;</div><div class="line">hello world</div><div class="line"><span class="number">2016</span><span class="number">-12</span><span class="number">-12</span>T09:<span class="number">10</span>:<span class="number">08.651</span>Z <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> hello world</div><div class="line"><span class="number">17</span>:<span class="number">10</span>:<span class="number">14.145</span> [LogStash::Runner] WARN  logstash.agent - stopping pipeline &#123;:id=&gt;<span class="string">"main"</span>&#125;</div><div class="line">[root<span class="meta">@ELK</span> ~]#</div><div class="line">注：要加--path.settings /etc/logstash指定配置文件目录，否则报错↑↑↑</div><div class="line">正确方法：</div><div class="line">[root<span class="meta">@ELK</span> ~]# /usr/share/logstash/bin/logstash --path.settings /etc/logstash -e <span class="string">'input &#123; stdin &#123; &#125; &#125; output &#123; stdout &#123;&#125; &#125;'</span></div></pre></td></tr></table></figure></p>
<p>Question4：访问Kibana时返回502，如下图：<br>解决办法是：检查下当前电脑是否有打开翻墙软件或IE代理<br><img src="http://note.youdao.com/yws/api/personal/file/A89D2F7B081341BC98AF4D563A8071EE?method=download&amp;shareKey=9d88dec8bbae431f93f6609a4527fa43" alt="Kibana_502">  </p>
<p>附件：<br><a href="http://note.youdao.com/yws/api/personal/file/361B0F5AD67B4909A88EBA48DA8752E1?method=download&amp;shareKey=a693da8e5d71c8ee627cf20bef32b233" target="_blank" rel="external">logstash-5.1.1.rpm</a><br><a href="http://note.youdao.com/yws/api/personal/file/61BD9F64C30A40ED954AE45758804059?method=download&amp;shareKey=381ac62877d82b385f600470a6b81cc2" target="_blank" rel="external">kibana-5.1.1-x86_64.rpm</a><br><a href="http://note.youdao.com/yws/api/personal/file/35D87D7FF5394DDC8EDC3CEB84AC9295?method=download&amp;shareKey=73b2b4d7d169653b407798ceb90e837" target="_blank" rel="external">elasticsearch-5.1.1.rpm</a><br><a href="http://note.youdao.com/share/?id=79ab2b5e16b3d5b484023689fb07918e&amp;type=note#/" target="_blank" rel="external">jdk-8u73-linux-x64.gz</a></p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/11/22/ELK安装-基础/">http://www.yfshare.vip/2017/11/22/ELK安装-基础/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ELK是三个开源软件的缩写，分别表示：Elasticsearch , Logstash, Kibana , 它们都是开源软件&lt;br&gt;
    
    </summary>
    
      <category term="ELK" scheme="http://www.yfshare.vip/categories/ELK/"/>
    
    
      <category term="ELK" scheme="http://www.yfshare.vip/tags/ELK/"/>
    
      <category term="Elasticsearch" scheme="http://www.yfshare.vip/tags/Elasticsearch/"/>
    
      <category term="Logstash" scheme="http://www.yfshare.vip/tags/Logstash/"/>
    
      <category term="Kibana" scheme="http://www.yfshare.vip/tags/Kibana/"/>
    
  </entry>
  
  <entry>
    <title>Logstash插件</title>
    <link href="http://www.yfshare.vip/2017/11/18/Logstash%E6%8F%92%E4%BB%B6/"/>
    <id>http://www.yfshare.vip/2017/11/18/Logstash插件/</id>
    <published>2017-11-17T16:00:00.000Z</published>
    <updated>2017-11-17T15:54:56.973Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/APlayer.min.js"> </script><script src="/assets/js/DPlayer.min.js"> </script><p>Logstash插件主要分为（常用插件）：input、filter、output、Codec等<br><a id="more"></a><br>Logstash input plugins：<a href="https://www.elastic.co/guide/en/logstash/5.1/input-plugins.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/5.1/input-plugins.html</a><br>Logstash filter plugins：<a href="https://www.elastic.co/guide/en/logstash/5.1/filter-plugins.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/5.1/filter-plugins.html</a><br>Logstash output plugins：<a href="https://www.elastic.co/guide/en/logstash/5.1/output-plugins.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/5.1/output-plugins.html</a><br>Logstash Codec plugins：<a href="https://www.elastic.co/guide/en/logstash/5.1/codec-plugins.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/5.1/codec-plugins.html</a>  </p>
<p>环境：Centos 6.6<br>　　　ElasticSearch 5.1.1<br>　　　Logstash 5.1.1<br>　　　Kibana 5.1.1  </p>
<h4 id="Logstash的codec用法之Logstash展示Nginx日志"><a href="#Logstash的codec用法之Logstash展示Nginx日志" class="headerlink" title="Logstash的codec用法之Logstash展示Nginx日志"></a>Logstash的codec用法之Logstash展示Nginx日志</h4><p>参考：<a href="https://www.elastic.co/guide/en/logstash/5.1/codec-plugins.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/5.1/codec-plugins.html</a><br><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">#文件必须以.<span class="keyword">conf</span>结尾，因为Logstash默认扫描*.<span class="keyword">conf</span>文件</div><div class="line">[root@ELK ~]# <span class="keyword">cat</span> /etc/logstash/              #在用grok时可以直接调用<span class="keyword">conf</span>.<span class="keyword">d</span>/nginx.<span class="keyword">conf</span> </div><div class="line"><span class="keyword">input</span> &#123;</div><div class="line">	<span class="keyword">file</span> &#123;</div><div class="line">		path =&gt; [<span class="string">"/var/log/nginx/access.log"</span>]</div><div class="line">		<span class="keyword">type</span> =&gt; <span class="string">"nginx"</span></div><div class="line">		start_position =&gt; <span class="string">"beginning"</span>  #这里参数可以写beginning和end</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">output &#123;</div><div class="line">	stdout &#123;</div><div class="line">		codec =&gt; rubydebug&#123;&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">[root@ELK ~]#</div><div class="line">[root@ELK ~]# /usr/share/logstash/bin/logstash --path.settings /etc/logstash/ -f /etc/logstash/<span class="keyword">conf</span>.<span class="keyword">d</span>/nginx.<span class="keyword">conf</span> </div><div class="line">Sending Logstash's logs to /<span class="keyword">var</span>/<span class="keyword">log</span>/logstash <span class="keyword">which</span> is now configured via log4j2.properties</div><div class="line">&#123;</div><div class="line">          <span class="string">"path"</span> =&gt; <span class="string">"/var/log/nginx/access.log"</span>,</div><div class="line">    <span class="string">"@timestamp"</span> =&gt; 2016-12-14T03:39:56.805Z,</div><div class="line">      <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,</div><div class="line">          <span class="string">"host"</span> =&gt; <span class="string">"0.0.0.0"</span>,</div><div class="line">       <span class="string">"message"</span> =&gt; <span class="string">"192.168.31.100 - - [13/Dec/2016:18:22:21 +0800] \"</span>GET / HTTP/1.1\<span class="string">" 200 612 \"</span>-\<span class="string">" \"</span>curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.15.3 zlib/1.2.3 libidn/1.18 libssh2/1.4.2\<span class="string">" \"</span>-\<span class="string">""</span>,</div><div class="line">          <span class="string">"type"</span> =&gt; <span class="string">"nginx"</span>,</div><div class="line">          <span class="string">"tags"</span> =&gt; []</div><div class="line">&#125;</div><div class="line">....</div><div class="line">#当再次请求Nginx时（即Nginx access.<span class="keyword">log</span>日志再次输出时），会打印到屏幕</div></pre></td></tr></table></figure></p>
<p>注，beginning和end区别：<br><code>beginning是文件从头开始读取</code>，<code>end是读取最新内容</code>。第一次读取后会生成缓存文件 (隐藏文件)记录读取的进度，如：<code>.sincedb_d883144359d3b4f516b37dba51fab2a2(隐藏文件)</code>。rpm安装的在<code>/var/lib/logstash/plugins/inputs/file</code>这个目录下，具体位置需要搜索。  </p>
<h4 id="Logstash的codec插件之multiline用法"><a href="#Logstash的codec插件之multiline用法" class="headerlink" title="Logstash的codec插件之multiline用法"></a>Logstash的codec插件之multiline用法</h4><p>参考：<a href="https://www.elastic.co/guide/en/logstash/5.1/plugins-codecs-multiline.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/5.1/plugins-codecs-multiline.html</a><br><a href="https://kibana.logstash.es/content/logstash/plugins/codec/multiline.html" target="_blank" rel="external">https://kibana.logstash.es/content/logstash/plugins/codec/multiline.html</a>  </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">[root@ELK ~]<span class="comment"># cat /etc/logstash/conf.d/multiline.conf </span></div><div class="line">input &#123;</div><div class="line">	stdin &#123;</div><div class="line">		codec =&gt; multiline &#123;</div><div class="line">			pattern =&gt; <span class="string">"^\["</span></div><div class="line">			negate =&gt; <span class="keyword">true</span></div><div class="line">			what =&gt; <span class="string">"previous"</span></div><div class="line">			&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">output &#123;</div><div class="line">	stdout &#123;</div><div class="line">		codec =&gt; rubydebug&#123;&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">[root@ELK ~]<span class="comment">#</span></div><div class="line"><span class="comment">#测试配置文件语法</span></div><div class="line">[root@ELK ~]<span class="comment"># /usr/share/logstash/bin/logstash --path.settings /etc/logstash/ -f /etc/logstash/conf.d/multiline.conf -t</span></div><div class="line">Sending Logstash<span class="string">'s logs to /var/log/logstash which is now configured via log4j2.properties</span></div><div class="line">Configuration OK</div><div class="line">[root@ELK ~]#</div><div class="line">[root@ELK ~]# /usr/share/logstash/bin/logstash --path.settings /etc/logstash/ -f /etc/logstash/conf.d/multiline.conf</div><div class="line">Sending Logstash's logs to /<span class="keyword">var</span>/log/logstash which is now configured via log4j2.properties</div><div class="line">The stdin plugin is now waiting <span class="keyword">for</span> input:</div><div class="line">[hello world]</div><div class="line">[Windows of the world]</div><div class="line">&#123;</div><div class="line">    <span class="string">"@timestamp"</span> =&gt; <span class="number">2016</span><span class="number">-12</span><span class="number">-14</span>T07:<span class="number">53</span>:<span class="number">20.808</span>Z,</div><div class="line">      <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,</div><div class="line">          <span class="string">"host"</span> =&gt; <span class="string">"0.0.0.0"</span>,</div><div class="line">       <span class="string">"message"</span> =&gt; <span class="string">"[hello world]"</span>,</div><div class="line">          <span class="string">"tags"</span> =&gt; []</div><div class="line">&#125;</div><div class="line">Good mornning</div><div class="line">[</div><div class="line">&#123;</div><div class="line">    <span class="string">"@timestamp"</span> =&gt; <span class="number">2016</span><span class="number">-12</span><span class="number">-14</span>T07:<span class="number">54</span>:<span class="number">00.060</span>Z,</div><div class="line">      <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,</div><div class="line">          <span class="string">"host"</span> =&gt; <span class="string">"0.0.0.0"</span>,</div><div class="line">       <span class="string">"message"</span> =&gt; <span class="string">"[Windows of the world]\nGood mornning"</span>,</div><div class="line">          <span class="string">"tags"</span> =&gt; [</div><div class="line">        [<span class="number">0</span>] <span class="string">"multiline"</span></div><div class="line">    ]</div><div class="line">&#125;</div><div class="line"><span class="comment">#multiline插件是以“[”做标记，如果出现“[”，则把两个“[”之间的内容在message输出，“[”是结尾符</span></div></pre></td></tr></table></figure>
<h4 id="Logstash的filter插件之grok用法"><a href="#Logstash的filter插件之grok用法" class="headerlink" title="Logstash的filter插件之grok用法"></a>Logstash的filter插件之grok用法</h4><p>参考：<a href="https://www.elastic.co/guide/en/logstash/5.1/plugins-filters-grok.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/5.1/plugins-filters-grok.html</a><br><a href="http://kibana.logstash.es/content/logstash/plugins/filter/grok.html" target="_blank" rel="external">http://kibana.logstash.es/content/logstash/plugins/filter/grok.html</a>  </p>
<p>主要是做正则匹配，拆分<br>下面两个地址需要拨VPN才能访问：<br>官方提供的grok表达式：<a href="https://github.com/logstash-plugins/logstash-patterns-core/tree/master/patterns" target="_blank" rel="external">https://github.com/logstash-plugins/logstash-patterns-core/tree/master/patterns</a><br>grok在线调试：<a href="https://grokdebug.herokuapp.com/" target="_blank" rel="external">https://grokdebug.herokuapp.com/</a><br>grok正则表达式：<a href="https://github.com/logstash-plugins/logstash-patterns-core/blob/master/patterns/grok-patterns" target="_blank" rel="external">https://github.com/logstash-plugins/logstash-patterns-core/blob/master/patterns/grok-patterns</a><br>在用grok时可以直接调用，也可以自己写，如：<br><img src="http://note.youdao.com/yws/api/personal/file/9E3F41215A5B44F98B4DE31A1D194559?method=download&amp;shareKey=694a15483adc321844d8f3ac40ff77b7" alt="image">  </p>
<p>grok里正则在这里<a href="https://grokdebug.herokuapp.com/" target="_blank" rel="external">调试</a><br><img src="http://note.youdao.com/yws/api/personal/file/CBEC3EEBC35B457CBC28DFE516A32D28?method=download&amp;shareKey=fe1269199d3998d52b92fdb53814dc6f" alt="image">  </p>
<p>#日志内容本身都是一个类似于key-value 的格式，但是格式具体的样式却是多种多样的。logstash提供filters/kv插件，帮助处理不同样式的key-value日志，变成实际的LogStash::Event数据。  </p>
<p>#kv没用会，下面是摘抄的示例<br><a href="https://kibana.logstash.es/content/logstash/plugins/filter/kv.html" target="_blank" rel="external">https://kibana.logstash.es/content/logstash/plugins/filter/kv.html</a><br><a href="https://www.elastic.co/guide/en/logstash/current/plugins-filters-kv.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/current/plugins-filters-kv.html</a><br><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line">#解析<span class="keyword">test</span>.<span class="keyword">log</span>文件内容</div><div class="line">[root@ELK ~]# <span class="keyword">cat</span> /root/<span class="keyword">test</span>.<span class="keyword">log</span> </div><div class="line">192.168.31.105 - - [14/<span class="keyword">Dec</span>/2016:15:17:56 +0800] <span class="string">"GET / HTTP/1.1"</span> 304 0 <span class="string">"-"</span> <span class="string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/47.0.2526.106 Safari/537.36"</span> <span class="string">"-"</span></div><div class="line">[root@ELK ~]#</div><div class="line">[root@ELK ~]# <span class="keyword">cat</span> /etc/logstash/<span class="keyword">conf</span>.<span class="keyword">d</span>/samp.<span class="keyword">conf</span> </div><div class="line"><span class="keyword">input</span> &#123;</div><div class="line">	<span class="keyword">file</span> &#123;</div><div class="line">		path =&gt; <span class="string">"/root/test.log"</span></div><div class="line">		start_position =&gt; <span class="string">"beginning"</span></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">filter &#123;</div><div class="line">	grok &#123;</div><div class="line">		match =&gt; [<span class="string">"message"</span>,<span class="string">"%&#123;IPV4:remote_addr&#125; \- %&#123;USERNAME:remote_user&#125; \[%&#123;DATA:time_local&#125;\] (?&lt;http_request&gt;\"</span>[A-Za-z][A-Za-z]+\s*\/\s*[A-Za-z][A-Za-z]+\/[0-9][0-9]*\.[0-9][0-9]*\<span class="string">") (?&lt;status&gt;[0-9][0-9]*) (?&lt;body_bytes_sent&gt;[0-9][0-9]*) (?&lt;http_referer&gt;\"</span>[\s\S]*?\<span class="string">") (?&lt;http_user_agent&gt;\"</span>[\s\S]*?\<span class="string">") (?&lt;http_x_forwarded_for&gt;\"</span>[\s\S]*?\<span class="string">")"</span>]</div><div class="line">	&#125;</div><div class="line">    kv &#123;</div><div class="line">        source =&gt; <span class="string">"http_user_agent"</span></div><div class="line">        field_split =&gt; <span class="string">";"</span></div><div class="line">        value_split =&gt; <span class="string">"="</span></div><div class="line">        remove_field =&gt; [ <span class="string">"\\"</span>"]</div><div class="line">        &#125;</div><div class="line">	urldecode &#123;</div><div class="line">		all_fields =&gt; true</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">#这里的kv插件好像没有效果额..，kv适合有规律的拆分</div><div class="line">output &#123;</div><div class="line">	stdout &#123;</div><div class="line">		codec =&gt; rubydebug</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">[root@ELK ~]#</div><div class="line">[root@ELK ~]# /usr/share/logstash/bin/logstash --path.settings /etc/logstash/ -f /etc/logstash/<span class="keyword">conf</span>.<span class="keyword">d</span>/samp.<span class="keyword">conf</span> -t</div><div class="line">Sending Logstash's logs to /<span class="keyword">var</span>/<span class="keyword">log</span>/logstash <span class="keyword">which</span> is now configured via log4j2.properties</div><div class="line">Configuration OK</div><div class="line">[root@ELK ~]# /usr/share/logstash/bin/logstash --path.settings /etc/logstash/ -f /etc/logstash/<span class="keyword">conf</span>.<span class="keyword">d</span>/samp.<span class="keyword">conf</span></div><div class="line">Sending Logstash's logs to /<span class="keyword">var</span>/<span class="keyword">log</span>/logstash <span class="keyword">which</span> is now configured via log4j2.properties</div><div class="line">&#123;</div><div class="line">             <span class="string">"remote_addr"</span> =&gt; <span class="string">"192.168.31.105"</span>,</div><div class="line">         <span class="string">"body_bytes_sent"</span> =&gt; <span class="string">"0"</span>,</div><div class="line">              <span class="string">"time_local"</span> =&gt; <span class="string">"14/Dec/2016:15:17:56 +0800"</span>,</div><div class="line">                 <span class="string">"message"</span> =&gt; <span class="string">"192.168.31.105 - - [14/Dec/2016:15:17:56 +0800] \"</span>GET / HTTP/1.1\<span class="string">" 304 0 \"</span>-\<span class="string">" \"</span>Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/47.0.2526.106 Safari/537.36\<span class="string">" \"</span>-\<span class="string">""</span>,</div><div class="line">                    <span class="string">"tags"</span> =&gt; [],</div><div class="line">         <span class="string">"http_user_agent"</span> =&gt; <span class="string">"\"</span>Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/47.0.2526.106 Safari/537.36\<span class="string">""</span>,</div><div class="line">             <span class="string">"remote_user"</span> =&gt; <span class="string">"-"</span>,</div><div class="line">                    <span class="string">"path"</span> =&gt; <span class="string">"/root/test.log"</span>,</div><div class="line">              <span class="string">"@timestamp"</span> =&gt; 2016-12-14T16:05:20.443Z,</div><div class="line">            <span class="string">"http_referer"</span> =&gt; <span class="string">"\"</span>-\<span class="string">""</span>,</div><div class="line">                <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,</div><div class="line">                    <span class="string">"host"</span> =&gt; <span class="string">"0.0.0.0"</span>,</div><div class="line">    <span class="string">"http_x_forwarded_for"</span> =&gt; <span class="string">"\"</span>-\<span class="string">""</span>,</div><div class="line">            <span class="string">"http_request"</span> =&gt; <span class="string">"\"</span>GET / HTTP/1.1\<span class="string">""</span>,</div><div class="line">                  <span class="string">"status"</span> =&gt; <span class="string">"304"</span></div><div class="line">&#125;</div><div class="line">...</div><div class="line">[root@ELK ~]#</div><div class="line">#Logstash日志输出</div><div class="line">[root@ELK ~]# tail -f /<span class="keyword">var</span>/<span class="keyword">log</span>/logstash/logstash-plain.<span class="keyword">log</span> </div><div class="line">[2016-12-15T00:02:28,195][INFO ][logstash.runner          ] Using config.test_and_exit mode. Config Validation Result: OK. Exiting Logstash</div><div class="line">[2016-12-15T00:05:21,397][INFO ][logstash.pipeline        ] Starting pipeline &#123;<span class="string">"id"</span>=&gt;<span class="string">"main"</span>, <span class="string">"pipeline.workers"</span>=&gt;1, <span class="string">"pipeline.batch.size"</span>=&gt;125, <span class="string">"pipeline.batch.delay"</span>=&gt;5, <span class="string">"pipeline.max_inflight"</span>=&gt;125&#125;</div><div class="line">[2016-12-15T00:05:21,477][INFO ][logstash.pipeline        ] Pipeline main started</div><div class="line">[2016-12-15T00:05:22,156][INFO ][logstash.agent           ] Successfully started Logstash API endpoint &#123;:port=&gt;9600&#125;</div><div class="line">...</div><div class="line">[root@ELK ~]#</div></pre></td></tr></table></figure></p>
<p>示例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">filter &#123;</div><div class="line">    ruby &#123;</div><div class="line">        init =&gt; <span class="string">"@kname = ['method','uri','verb']"</span></div><div class="line">        code =&gt; <span class="string">"</span></div><div class="line">            new_event = LogStash::Event.new(Hash[@kname.zip(event.get('request').split('|'))])</div><div class="line">            new_event.remove('@timestamp')</div><div class="line">            event.append(new_event)</div><div class="line">        "</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> [uri] &#123;</div><div class="line">        ruby &#123;</div><div class="line">            init =&gt; <span class="string">"@kname = ['url_path','url_args']"</span></div><div class="line">            code =&gt; <span class="string">"</span></div><div class="line">                new_event = LogStash::Event.new(Hash[@kname.zip(event.get('uri').split('?'))])</div><div class="line">                new_event.remove('@timestamp')</div><div class="line">                event.append(new_event)</div><div class="line">            "</div><div class="line">        &#125;</div><div class="line">        kv &#123;</div><div class="line">            prefix =&gt; <span class="string">"url_"</span></div><div class="line">            <span class="built_in">source</span> =&gt; <span class="string">"url_args"</span></div><div class="line">            field_split =&gt; <span class="string">"&amp;"</span></div><div class="line">            remove_field =&gt; [ <span class="string">"url_args"</span>, <span class="string">"uri"</span>, <span class="string">"request"</span> ]</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#解释</span></div><div class="line">Nginx 访问日志中的 <span class="variable">$request</span>，通过这段配置，可以详细切分成 method, url_path, verb, url_a, url_b ...</div><div class="line"></div><div class="line">进一步的，如果 url_args 中有过多字段，可能导致 Elasticsearch 集群因为频繁 update mapping 或者消耗太多内存在 cluster state 上而宕机。所以，更优的选择，是只保留明确有用的 url_args 内容，其他部分舍去</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">kv &#123;</div><div class="line">    prefix =&gt; <span class="string">"url_"</span></div><div class="line">    <span class="built_in">source</span> =&gt; <span class="string">"url_args"</span></div><div class="line">    field_split =&gt; <span class="string">"&amp;"</span></div><div class="line">    include_keys =&gt; [ <span class="string">"uid"</span>, <span class="string">"cip"</span> ]</div><div class="line">    remove_field =&gt; [ <span class="string">"url_args"</span>, <span class="string">"uri"</span>, <span class="string">"request"</span> ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#grok分析/var/log/secure日志</span></div><div class="line">input &#123;</div><div class="line">   file &#123;</div><div class="line">	path =&gt; [<span class="string">"/var/log/secure"</span>]</div><div class="line">	start_position =&gt; <span class="string">"end"</span></div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">filter &#123;</div><div class="line">		grok &#123;</div><div class="line">   			match =&gt; [<span class="string">"message"</span>,<span class="string">".* sshd\[\d+\]: (?&lt;status&gt;\S+) .* (?&lt;ClientIP&gt;(?:\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;)?) .*"</span>]</div><div class="line">		&#125;</div><div class="line">&#125;</div><div class="line">output &#123;</div><div class="line">    stdout &#123;</div><div class="line">		codec =&gt; rubydebug&#123;&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Logstash的filter插件之json用法"><a href="#Logstash的filter插件之json用法" class="headerlink" title="Logstash的filter插件之json用法"></a>Logstash的filter插件之json用法</h4><p>参考：<a href="https://www.elastic.co/guide/en/logstash/5.1/plugins-filters-json.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/5.1/plugins-filters-json.html</a><br><a href="https://kibana.logstash.es/content/logstash/plugins/filter/json.html" target="_blank" rel="external">https://kibana.logstash.es/content/logstash/plugins/filter/json.html</a><br><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line">#修改Nginx日志格式</div><div class="line">[root@ELK ~]# head -32 /etc/nginx/nginx.<span class="keyword">conf</span> | tail -15</div><div class="line">#    log_format  main  '<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] <span class="string">"$request"</span> '</div><div class="line">#                      '<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> <span class="string">"$http_referer"</span> '</div><div class="line">#                      '<span class="string">"$http_user_agent"</span> <span class="string">"$http_x_forwarded_for"</span>';</div><div class="line"></div><div class="line">    log_format json '&#123;<span class="string">"clinet"</span>:<span class="string">"$remote_addr"</span>,'</div><div class="line">		'<span class="string">"@timestamp"</span>:<span class="string">"$time_iso8601"</span>,'</div><div class="line">		'<span class="string">"@version"</span>:<span class="string">"1"</span>,'</div><div class="line">		'<span class="string">"host"</span>:<span class="string">"$server_addr"</span>,'</div><div class="line">		'<span class="string">"size"</span>:<span class="variable">$body_bytes_sent</span>,'</div><div class="line">		'<span class="string">"responsetime"</span>:<span class="variable">$request_time</span>,'</div><div class="line">		'<span class="string">"domain"</span>:<span class="string">"$host"</span>,'</div><div class="line">		'<span class="string">"status"</span>:<span class="string">"$status"</span>,'</div><div class="line">		'<span class="string">"ua"</span>:<span class="string">"$http_user_agent"</span>&#125;';</div><div class="line"></div><div class="line">    access_log  /<span class="keyword">var</span>/<span class="keyword">log</span>/nginx/access.<span class="keyword">log</span>  json;</div><div class="line">[root@ELK ~]#</div><div class="line">[root@ELK ~]# <span class="keyword">cat</span> /etc/logstash/<span class="keyword">conf</span>.<span class="keyword">d</span>/json.<span class="keyword">conf</span> </div><div class="line"><span class="keyword">input</span> &#123;</div><div class="line">	<span class="keyword">file</span> &#123;</div><div class="line">		path =&gt; [<span class="string">"/var/log/nginx/access.log"</span>]</div><div class="line">		<span class="keyword">type</span> =&gt; <span class="string">"Nginx"</span></div><div class="line">		start_position =&gt; <span class="string">"end"</span></div><div class="line">		codec =&gt; json</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">output &#123;</div><div class="line">	stdout &#123;</div><div class="line">		codec =&gt; rubydebug&#123;&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">[root@ELK ~]#</div><div class="line">[root@ELK ~]# /usr/share/logstash/bin/logstash --path.settings /etc/logstash/ -f /etc/logstash/<span class="keyword">conf</span>.<span class="keyword">d</span>/json.<span class="keyword">conf</span> -t</div><div class="line">Sending Logstash's logs to /<span class="keyword">var</span>/<span class="keyword">log</span>/logstash <span class="keyword">which</span> is now configured via log4j2.properties</div><div class="line">Configuration OK</div><div class="line">[root@ELK ~]#</div><div class="line">[root@ELK ~]# /usr/share/logstash/bin/logstash --path.settings /etc/logstash/ -f /etc/logstash/<span class="keyword">conf</span>.<span class="keyword">d</span>/json.<span class="keyword">conf</span></div><div class="line">Sending Logstash's logs to /<span class="keyword">var</span>/<span class="keyword">log</span>/logstash <span class="keyword">which</span> is now configured via log4j2.properties</div><div class="line">&#123;</div><div class="line">            <span class="string">"path"</span> =&gt; <span class="string">"/var/log/nginx/access.log"</span>,</div><div class="line">      <span class="string">"@timestamp"</span> =&gt; 2016-12-15T07:33:00.000Z,</div><div class="line">            <span class="string">"size"</span> =&gt; 0,</div><div class="line">          <span class="string">"domain"</span> =&gt; <span class="string">"192.168.31.100"</span>,</div><div class="line">        <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,</div><div class="line">            <span class="string">"host"</span> =&gt; <span class="string">"192.168.31.100"</span>,</div><div class="line">    <span class="string">"responsetime"</span> =&gt; 0.0,</div><div class="line">              <span class="string">"ua"</span> =&gt; <span class="string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/47.0.2526.106 Safari/537.36"</span>,</div><div class="line">            <span class="string">"type"</span> =&gt; <span class="string">"Nginx"</span>,</div><div class="line">          <span class="string">"clinet"</span> =&gt; <span class="string">"192.168.31.105"</span>,</div><div class="line">          <span class="string">"status"</span> =&gt; <span class="string">"304"</span>,</div><div class="line">            <span class="string">"tags"</span> =&gt; []</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Logstash的filter插件之geoip用法"><a href="#Logstash的filter插件之geoip用法" class="headerlink" title="Logstash的filter插件之geoip用法"></a>Logstash的filter插件之geoip用法</h4><p>参考：<a href="https://www.elastic.co/guide/en/logstash/5.1/plugins-filters-geoip.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/5.1/plugins-filters-geoip.html</a><br><a href="https://kibana.logstash.es/content/logstash/plugins/filter/geoip.html" target="_blank" rel="external">https://kibana.logstash.es/content/logstash/plugins/filter/geoip.html</a><br>GeoIP 是最常见的免费IP地址归类查询库<br><figure class="highlight puppet"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># logstash v5.6.4</span></div><div class="line"><span class="comment"># logstash 配置文件</span></div><div class="line"><span class="comment"># cat logstash_10.20.conf</span></div><div class="line"><span class="keyword">input</span> &#123;</div><div class="line">   file &#123;</div><div class="line">	<span class="attr">path</span> =&gt; [<span class="string">"/root/test.log"</span>]</div><div class="line">	<span class="attr">start_position</span> =&gt; <span class="string">"end"</span></div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">filter</span> &#123;</div><div class="line">	grok &#123;</div><div class="line">   		<span class="attr">match</span> =&gt; [<span class="string">"message"</span>,<span class="string">"%&#123;IPV4:remote_addr&#125; [\-] %&#123;USERNAME:remote_user&#125; \[%&#123;DATA:time_local&#125;\] \"(?&lt;request&gt;[^\"]*)\" (?&lt;status&gt;\d+) (?&lt;body_bytes_sent&gt;\d+) \"(?&lt;http_referer&gt;[^\"]*)\" \"(?&lt;http_user_agent&gt;[^\"]*)\" \"%&#123;IPV4:http_x_forwarded_for&#125;"</span>]	&#125;</div><div class="line">	<span class="keyword">geoip</span> &#123;</div><div class="line">		<span class="attr">source</span> =&gt; <span class="string">"http_x_forwarded_for"</span></div><div class="line">		<span class="attr">fields</span> =&gt; [<span class="string">"ip"</span>,<span class="string">"city_name"</span>,<span class="string">"country_name"</span>,<span class="string">"location"</span>,<span class="string">"latitude"</span>,<span class="string">"longitude"</span>,<span class="string">"timezone"</span>,<span class="string">"region_name"</span>]</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">output</span> &#123;</div><div class="line">	stdout &#123;</div><div class="line">		<span class="attr">codec</span> =&gt; rubydebug&#123;&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#nginx 日志</span></div><div class="line">100.116.46.20 - - [15/Nov/2017:11:59:34 +0800] <span class="string">"GET /static/js/util/plugins/cordova-plugin-geolocation/www/geolocation.js HTTP/1.0"</span> 200 8629 <span class="string">"https://qian.julend.com/static/pageHtml/loan.html?s_qian=iOS"</span> <span class="string">"Mozilla/5.0 (iPhone; CPU iPhone OS 10_3_3 like Mac OS X) AppleWebKit/603.3.8 (KHTML, like Gecko) Mobile/14G60 GrowingIO/0.9.47-20170111143620 (4303466304)"</span> <span class="string">"27.8.223.7"</span></div><div class="line"></div><div class="line"><span class="comment">#nginx grok匹配</span></div><div class="line">%&#123;IPV4:remote_addr&#125; [\-] %&#123;USERNAME:remote_user&#125; \[%&#123;DATA:time_local&#125;\] \<span class="string">"(?&lt;request&gt;[^\"]*)\" (?&lt;status&gt;\d+) (?&lt;body_bytes_sent&gt;\d+) \"(?&lt;http_referer&gt;[^\"]*)\" \"(?&lt;http_user_agent&gt;[^\"]*)\" \"%&#123;IPV4:http_x_forwarded_for&#125;</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># /usr/share/logstash/bin/logstash --path.settings /etc/logstash/ -f /etc/logstash/conf.d/logstash_10.20.conf --path.data /data/elk_data/logstash/</span></div><div class="line">dataSending Logstash<span class="string">'s logs to /data/elk_data/logstash/logs which is now configured via log4j2.properties</span></div><div class="line">&#123;</div><div class="line">             "remote_addr" =&gt; "100.116.46.20",</div><div class="line">                 "request" =&gt; "GET /static/js/util/plugins/cordova-plugin-geolocation/www/geolocation.js HTTP/1.0",</div><div class="line">                   "geoip" =&gt; &#123;</div><div class="line">           "city_name" =&gt; "Chongqing",</div><div class="line">            "timezone" =&gt; "Asia/Shanghai",</div><div class="line">                  "ip" =&gt; "27.8.223.7",</div><div class="line">            "latitude" =&gt; 29.5628,</div><div class="line">        "country_name" =&gt; "China",</div><div class="line">         "region_name" =&gt; "Chongqing",</div><div class="line">            "location" =&gt; &#123;</div><div class="line">            "lon" =&gt; 106.5528,</div><div class="line">            "lat" =&gt; 29.5628</div><div class="line">        &#125;,</div><div class="line">           "longitude" =&gt; 106.5528</div><div class="line">    &#125;,</div><div class="line">         "body_bytes_sent" =&gt; "8629",</div><div class="line">              "time_local" =&gt; "15/Nov/2017:11:59:34 +0800",</div><div class="line">                 "message" =&gt; "100.116.46.20 - - [15/Nov/2017:11:59:34 +0800] \"GET /static/js/util/plugins/cordova-plugin-geolocation/www/geolocation.js HTTP/1.0\" 200 8629 \"https://qian.julend.com/static/pageHtml/loan.html?s_qian=iOS\" \"Mozilla/5.0 (iPhone; CPU iPhone OS 10_3_3 like Mac OS X) AppleWebKit/603.3.8 (KHTML, like Gecko) Mobile/14G60 GrowingIO/0.9.47-20170111143620 (4303466304)\" \"27.8.223.7\"",</div><div class="line">         "http_user_agent" =&gt; "Mozilla/5.0 (iPhone; CPU iPhone OS 10_3_3 like Mac OS X) AppleWebKit/603.3.8 (KHTML, like Gecko) Mobile/14G60 GrowingIO/0.9.47-20170111143620(4303466304)", </div><div class="line">             "remote_user" =&gt; "-",</div><div class="line">                    "path" =&gt; "/root/test.log",</div><div class="line">              "@timestamp" =&gt; 2017-11-15T06:16:03.829Z,</div><div class="line">            "http_referer" =&gt; "https://qian.julend.com/static/pageHtml/loan.html?s_qian=iOS",</div><div class="line">                "@version" =&gt; "1",</div><div class="line">                    "host" =&gt; "elk-cluster3",</div><div class="line">    "http_x_forwarded_for" =&gt; "27.8.223.7",</div><div class="line">                  "status" =&gt; "200"</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 去掉geoip后，nginx日志拆分</span></div><div class="line">&#123;</div><div class="line">             <span class="string">"remote_addr"</span> =&gt; <span class="string">"100.116.46.20"</span>,</div><div class="line">                 <span class="string">"request"</span> =&gt; <span class="string">"GET /static/js/util/plugins/cordova-plugin-geolocation/www/geolocation.js HTTP/1.0"</span>,</div><div class="line">         <span class="string">"body_bytes_sent"</span> =&gt; <span class="string">"8629"</span>,</div><div class="line">              <span class="string">"time_local"</span> =&gt; <span class="string">"15/Nov/2017:10:59:34 +0800"</span>,</div><div class="line">                 <span class="string">"message"</span> =&gt; <span class="string">"100.116.46.20 - - [15/Nov/2017:10:59:34 +0800] \"GET /static/js/util/plugins/cordova-plugin-geolocation/www/geolocation.js HTTP/1.0\" 200 8629 \"https://qian.julend.com/static/pageHtml/loan.html?s_qian=iOS\" \"Mozilla/5.0 (iPhone; CPU iPhone OS 10_3_3 like Mac OS X) AppleWebKit/603.3.8 (KHTML, like Gecko) Mobile/14G60 GrowingIO/0.9.47-20170111143620 (4303466304)\" \"27.8.223.7\""</span>,</div><div class="line">         <span class="string">"http_user_agent"</span> =&gt; <span class="string">"Mozilla/5.0 (iPhone; CPU iPhone OS 10_3_3 like Mac OS X) AppleWebKit/603.3.8 (KHTML, like Gecko) Mobile/14G60 GrowingIO/0.9.47-20170111143620 (4303466304)"</span>,</div><div class="line">             <span class="string">"remote_user"</span> =&gt; <span class="string">"-"</span>,</div><div class="line">                    <span class="string">"path"</span> =&gt; <span class="string">"/root/test.log"</span>,</div><div class="line">              <span class="string">"@timestamp"</span> =&gt; 2017-11-15T06:01:24.940Z,</div><div class="line">            <span class="string">"http_referer"</span> =&gt; <span class="string">"https://qian.julend.com/static/pageHtml/loan.html?s_qian=iOS"</span>,</div><div class="line">                <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,</div><div class="line">                    <span class="string">"host"</span> =&gt; <span class="string">"elk-cluster3"</span>,</div><div class="line">    <span class="string">"http_x_forwarded_for"</span> =&gt; <span class="string">"27.8.223.7"</span>,</div><div class="line">                  <span class="string">"status"</span> =&gt; <span class="string">"200"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Logstash的filter插件之date时间处理"><a href="#Logstash的filter插件之date时间处理" class="headerlink" title="Logstash的filter插件之date时间处理"></a>Logstash的filter插件之date时间处理</h4><p>参考：<a href="https://www.elastic.co/guide/en/logstash/5.6/plugins-filters-date.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/5.6/plugins-filters-date.html</a><br><a href="https://kibana.logstash.es/content/logstash/plugins/filter/date.html" target="_blank" rel="external">https://kibana.logstash.es/content/logstash/plugins/filter/date.html</a><br>filters/date 插件可以用来转换你的日志记录中的时间字符串，变成 LogStash::Timestamp 对象，然后转存到 @timestamp 字段里<br><code>注意：因为在稍后的 outputs/elasticsearch 中常用的 %{+YYYY.MM.dd} 这种写法必须读取 @timestamp 数据，所以一定不要直接删掉这个字段保留自己的字段，而是应该用 filters/date 转换后删除自己的字段！</code>  </p>
<p><code>建议打开 Nginx 的 access_log 配置项的 buffer 参数，对极限响应性能有极大提升！</code></p>
<p>filters/date 插件支持五种时间格式  </p>
<ul>
<li>ISO8601<br>类似 “2011-04-19T03:44:01.103Z” 这样的格式。具体Z后面可以有 “08:00”也可以没有，”.103”这个也可以没有。常用场景里来说，Nginx 的 log_format 配置里就可以使用 $time_iso8601 变量来记录请求时间成这种格式。  </li>
<li>UNIX<br>UNIX 时间戳格式，记录的是从 1970 年起始至今的总秒数。Squid 的默认日志格式中就使用了这种格式。  </li>
<li>UNIX_MS<br>这个时间戳则是从 1970 年起始至今的总毫秒数。据我所知，JavaScript 里经常使用这个时间格式。  </li>
<li>TAI64N<br>TAI64N 格式比较少见，是这个样子的：@4000000052f88ea32489532c。我目前只知道常见应用中， qmail 会用这个格式。  </li>
<li>Joda-Time 库<br>Logstash 内部使用了 Java 的 Joda 时间库来作时间处理。所以我们可以使用 Joda 库所支持的时间格式来作具体定义。Joda 时间格式定义见下表：</li>
</ul>
<p>时间格式：  </p>
<table>
<thead>
<tr>
<th>Symbol</th>
<th>Meaning</th>
<th>Presentation</th>
<th>Examples</th>
</tr>
</thead>
<tbody>
<tr>
<td>G</td>
<td>era</td>
<td>text</td>
<td>AD</td>
</tr>
<tr>
<td>C</td>
<td>century of era (&gt;=0)</td>
<td>number</td>
<td>20</td>
</tr>
<tr>
<td>Y</td>
<td>year of era (&gt;=0)</td>
<td>year</td>
<td>1996</td>
</tr>
<tr>
<td>x</td>
<td>weekyear</td>
<td>year</td>
<td>1996</td>
</tr>
<tr>
<td>w</td>
<td>week of weekyear</td>
<td>number</td>
<td>27</td>
</tr>
<tr>
<td>e</td>
<td>day of week</td>
<td>number</td>
<td>2</td>
</tr>
<tr>
<td>E</td>
<td>day of week</td>
<td>text</td>
<td>Tuesday; Tue</td>
</tr>
<tr>
<td>y</td>
<td>year</td>
<td>year</td>
<td>1996</td>
</tr>
<tr>
<td>D</td>
<td>day of year</td>
<td>number</td>
<td>189</td>
</tr>
<tr>
<td>M</td>
<td>month of year</td>
<td>month</td>
<td>July; Jul; 07</td>
</tr>
<tr>
<td>d</td>
<td>day of month</td>
<td>number</td>
<td>10</td>
</tr>
<tr>
<td>a</td>
<td>halfday of day</td>
<td>text</td>
<td>PM</td>
</tr>
<tr>
<td>K</td>
<td>hour of halfday (0~11)</td>
<td>number</td>
<td>0</td>
</tr>
<tr>
<td>h</td>
<td>clockhour of halfday (1~12)</td>
<td>number</td>
<td>12</td>
</tr>
<tr>
<td>H</td>
<td>hour of day (0~23)</td>
<td>number</td>
<td>0</td>
</tr>
<tr>
<td>k</td>
<td>clockhour of day (1~24)</td>
<td>number</td>
<td>24</td>
</tr>
<tr>
<td>m</td>
<td>minute of hour</td>
<td>number</td>
<td>30</td>
</tr>
<tr>
<td>s</td>
<td>second of minute</td>
<td>number</td>
<td>55</td>
</tr>
<tr>
<td>S</td>
<td>fraction of second</td>
<td>number</td>
<td>978</td>
</tr>
<tr>
<td>z</td>
<td>time zone</td>
<td>text</td>
<td>Pacific Standard Time; PST</td>
</tr>
<tr>
<td>Z</td>
<td>time zone offset/id</td>
<td>zone</td>
<td>-0800; -08:00; America/Los_Angeles</td>
</tr>
<tr>
<td>‘</td>
<td>escape for text</td>
<td>delimiter</td>
<td></td>
</tr>
<tr>
<td>‘’</td>
<td>single quote</td>
<td>literal</td>
<td>‘</td>
</tr>
</tbody>
</table>
<p><a href="http://joda-time.sourceforge.net/apidocs/org/joda/time/format/DateTimeFormat.html" target="_blank" rel="external">http://joda-time.sourceforge.net/apidocs/org/joda/time/format/DateTimeFormat.html</a>  </p>
<p>Joda 时间格式的配置：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">filter &#123;</div><div class="line">    grok &#123;</div><div class="line">        match =&gt; [<span class="string">"message"</span>, <span class="string">"%&#123;HTTPDATE:logdate&#125;"</span>]</div><div class="line">    &#125;</div><div class="line">    date &#123;</div><div class="line">        match =&gt; [<span class="string">"logdate"</span>, <span class="string">"dd/MMM/yyyy:HH:mm:ss Z"</span>]</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>注意：时区偏移量只需要用一个字母 <code>Z</code> 即可  </p>
<h4 id="Logstash的filter插件之secure日志切割"><a href="#Logstash的filter插件之secure日志切割" class="headerlink" title="Logstash的filter插件之secure日志切割"></a>Logstash的filter插件之secure日志切割</h4><p>参考：<a href="https://www.elastic.co/guide/en/logstash/5.6/plugins-filters-mutate.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/5.6/plugins-filters-mutate.html</a><br>这个需要配合filebeat操作<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># grep -iv '#' /etc/filebeat/filebeat.yml |grep -iv '^$'</span></div><div class="line">filebeat.prospectors:</div><div class="line">- input_type: <span class="built_in">log</span></div><div class="line">  paths:</div><div class="line">    - /var/<span class="built_in">log</span>/secure</div><div class="line">  document_type: secure_2.250</div><div class="line">  exclude_lines: [<span class="string">"system"</span>]      <span class="comment">#过滤不含system日志</span></div><div class="line">  include_lines: [<span class="string">"Accepted"</span>]    <span class="comment">#过滤含Accepted的日志</span></div><div class="line">output.logstash:</div><div class="line">  hosts: [<span class="string">"192.168.1.41:5044"</span>]</div><div class="line"><span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#logstash配置文件</span></div><div class="line"><span class="comment"># cat logstash_test.conf</span></div><div class="line">input &#123;</div><div class="line">	beats &#123;</div><div class="line">		port =&gt; 5045</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">filter &#123;</div><div class="line">	<span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">'secure_2.250'</span>&#123;</div><div class="line">		grok &#123;</div><div class="line">   			match =&gt; [<span class="string">"message"</span>,<span class="string">".* sshd\[\d+\]: (?&lt;status&gt;\S+) .* (?&lt;ClientIP&gt;(?:\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;)?) .*"</span>]        <span class="comment">#正则过滤secure日志，且赋值到message字段</span></div><div class="line">		&#125;</div><div class="line"> 		mutate&#123;</div><div class="line">     			split =&gt; [<span class="string">"message"</span>,<span class="string">" "</span>]     <span class="comment">#把message字段以空格拆分，message字段的值来自grok</span></div><div class="line">	        	add_field =&gt;   &#123;</div><div class="line">        	    		<span class="string">"username"</span> =&gt; <span class="string">"%&#123;[message][8]&#125;"</span>         <span class="comment">#数组是以0开始的，第9个字段在数组里角标为8</span></div><div class="line">	            		<span class="string">"loginip"</span> =&gt; <span class="string">"%&#123;[message][10]&#125;"</span></div><div class="line">        	    		<span class="string">"login_result"</span> =&gt; <span class="string">"%&#123;[message][5]&#125;"</span></div><div class="line">        		&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">output &#123;</div><div class="line">	stdout &#123;</div><div class="line">		codec =&gt; rubydebug&#123;&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#输出结果</span></div><div class="line">&#123;</div><div class="line">          <span class="string">"offset"</span> =&gt; 136859,</div><div class="line">      <span class="string">"input_type"</span> =&gt; <span class="string">"log"</span>,</div><div class="line">          <span class="string">"source"</span> =&gt; <span class="string">"/var/log/secure"</span>,</div><div class="line">    <span class="string">"login_result"</span> =&gt; <span class="string">"Accepted"</span>,</div><div class="line">         <span class="string">"message"</span> =&gt; [</div><div class="line">        [ 0] <span class="string">"Nov"</span>,</div><div class="line">        [ 1] <span class="string">"16"</span>,</div><div class="line">        [ 2] <span class="string">"14:38:14"</span>,</div><div class="line">        [ 3] <span class="string">"localhost"</span>,</div><div class="line">        [ 4] <span class="string">"sshd[9305]:"</span>,</div><div class="line">        [ 5] <span class="string">"Accepted"</span>,</div><div class="line">        [ 6] <span class="string">"publickey"</span>,</div><div class="line">        [ 7] <span class="string">"for"</span>,</div><div class="line">        [ 8] <span class="string">"yfshare"</span>,</div><div class="line">        [ 9] <span class="string">"from"</span>,</div><div class="line">        [10] <span class="string">"192.168.1.123"</span>,</div><div class="line">        [11] <span class="string">"port"</span>,</div><div class="line">        [12] <span class="string">"2269"</span>,</div><div class="line">        [13] <span class="string">"ssh2:"</span>,</div><div class="line">        [14] <span class="string">"RSA"</span>,</div><div class="line">        [15] <span class="string">"51:37:66:2f:2b:c0:74:d1:0b:15:f8:9c:7f:84:64:0a"</span></div><div class="line">    ],</div><div class="line">            <span class="string">"type"</span> =&gt; <span class="string">"secure_2.250"</span>,</div><div class="line">        <span class="string">"ClientIP"</span> =&gt; <span class="string">"192.168.1.123"</span>,</div><div class="line">            <span class="string">"tags"</span> =&gt; [</div><div class="line">        [0] <span class="string">"beats_input_codec_plain_applied"</span></div><div class="line">    ],</div><div class="line">      <span class="string">"@timestamp"</span> =&gt; 2017-11-16T06:38:19.012Z,</div><div class="line">         <span class="string">"loginip"</span> =&gt; <span class="string">"192.168.1.123"</span>,</div><div class="line">        <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,</div><div class="line">            <span class="string">"beat"</span> =&gt; &#123;</div><div class="line">            <span class="string">"name"</span> =&gt; <span class="string">"localhost"</span>,</div><div class="line">        <span class="string">"hostname"</span> =&gt; <span class="string">"localhost"</span>,</div><div class="line">         <span class="string">"version"</span> =&gt; <span class="string">"5.6.4"</span></div><div class="line">    &#125;,</div><div class="line">            <span class="string">"host"</span> =&gt; <span class="string">"localhost"</span>,</div><div class="line">          <span class="string">"status"</span> =&gt; <span class="string">"Accepted"</span>,</div><div class="line">        <span class="string">"username"</span> =&gt; <span class="string">"yfshare"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在Kibana上的Visualize上选择Data Table。<br><img src="https://note.youdao.com/yws/api/personal/file/D6AC34D06690457AB5DBA55FC9A7768E?method=download&amp;shareKey=90c8da2df75c8d76924f8127a5e586a4" alt="Kianan_Visualize_dataTable"><br>如果报上面的错误<code>no cached mapping for this field. refresh field list from the management &gt; index patterns pageTransform</code><br>原因是我们自己新增字段后，Kibana上index是之前加上的，新增字段不存在会报错，刷新下index即可<br>解决方案是：<code>management &gt; index patterns</code>，刷新对应的index即可<br><img src="https://note.youdao.com/yws/api/personal/file/52309F704287411BA92143E8BEE341D0?method=download&amp;shareKey=55aa29e1eb3960f040f21e887c82c4fb" alt="Kianan_Visualize_dataTable">  </p>
<h4 id="Logstash的output插件之发生email"><a href="#Logstash的output插件之发生email" class="headerlink" title="Logstash的output插件之发生email"></a>Logstash的output插件之发生email</h4><p>参考：<a href="https://www.elastic.co/guide/en/logstash/5.1/plugins-outputs-email.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/5.1/plugins-outputs-email.html</a><br><a href="https://kibana.logstash.es/content/logstash/plugins/output/email.html" target="_blank" rel="external">https://kibana.logstash.es/content/logstash/plugins/output/email.html</a><br>outputs/email 插件支持 SMTP 协议和 sendmail 两种方式，通过 <code>via</code> 参数设置。SMTP 方式有较多的 options 参数可配置。sendmail 只能利用本机上的 sendmail 服务来完成  </p>
<p>126 邮箱发送到 qq 邮箱示例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">output &#123;</div><div class="line">    email &#123;</div><div class="line">        port           =&gt;    <span class="string">"25"</span></div><div class="line">        address        =&gt;    <span class="string">"smtp.126.com"</span></div><div class="line">        username       =&gt;    <span class="string">"test@126.com"</span></div><div class="line">        password       =&gt;    <span class="string">""</span></div><div class="line">        authentication =&gt;    <span class="string">"plain"</span></div><div class="line">        use_tls        =&gt;    <span class="literal">true</span></div><div class="line">        from           =&gt;    <span class="string">"test@126.com"</span></div><div class="line">        subject        =&gt;    <span class="string">"Warning: %&#123;title&#125;"</span></div><div class="line">        to             =&gt;    <span class="string">"test@qq.com"</span></div><div class="line">        via            =&gt;    <span class="string">"smtp"</span></div><div class="line">        body           =&gt;    <span class="string">"%&#123;message&#125;"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Logstash的output插件之发生HDFS"><a href="#Logstash的output插件之发生HDFS" class="headerlink" title="Logstash的output插件之发生HDFS"></a>Logstash的output插件之发生HDFS</h4><p>参考：<a href="https://www.elastic.co/guide/en/logstash/5.6/plugins-outputs-webhdfs.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/5.6/plugins-outputs-webhdfs.html</a><br><a href="https://kibana.logstash.es/content/logstash/plugins/output/hdfs.html" target="_blank" rel="external">https://kibana.logstash.es/content/logstash/plugins/output/hdfs.html</a><br>该插件最初来源于社区，目前已被官方收录，Logstash 5.6支持，使用的是Hadoop的 WebHDFS 接口，其本质是发送 POST 数据<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">input &#123;</div><div class="line">  ...</div><div class="line">&#125;</div><div class="line">filter &#123;</div><div class="line">  ...</div><div class="line">&#125;</div><div class="line">output &#123;</div><div class="line">  webhdfs &#123;</div><div class="line">    host =&gt; <span class="string">"127.0.0.1"</span>                 <span class="comment"># (required)</span></div><div class="line">    port =&gt; 50070                       <span class="comment"># (optional, default: 50070)</span></div><div class="line">    path =&gt; <span class="string">"/user/logstash/dt=%&#123;+YYYY-MM-dd&#125;/logstash-%&#123;+HH&#125;.log"</span>  <span class="comment"># (required)</span></div><div class="line">    user =&gt; <span class="string">"hue"</span>                       <span class="comment"># (required)</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>更多插件请见：<a href="https://kibana.logstash.es/content/logstash/plugins/filter/" target="_blank" rel="external">https://kibana.logstash.es/content/logstash/plugins/filter/</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/11/18/Logstash插件/">http://www.yfshare.vip/2017/11/18/Logstash插件/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Logstash插件主要分为（常用插件）：input、filter、output、Codec等&lt;br&gt;
    
    </summary>
    
      <category term="ELK" scheme="http://www.yfshare.vip/categories/ELK/"/>
    
    
      <category term="ELK" scheme="http://www.yfshare.vip/tags/ELK/"/>
    
      <category term="Logstash" scheme="http://www.yfshare.vip/tags/Logstash/"/>
    
      <category term="插件" scheme="http://www.yfshare.vip/tags/%E6%8F%92%E4%BB%B6/"/>
    
  </entry>
  
  <entry>
    <title>Elasticsearch监控相关</title>
    <link href="http://www.yfshare.vip/2017/11/14/Elasticsearch%E7%9B%91%E6%8E%A7%E7%9B%B8%E5%85%B3/"/>
    <id>http://www.yfshare.vip/2017/11/14/Elasticsearch监控相关/</id>
    <published>2017-11-14T15:05:33.000Z</published>
    <updated>2017-11-14T15:08:38.845Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/APlayer.min.js"> </script><script src="/assets/js/DPlayer.min.js"> </script><p>Elasticsearch相关监控接口<br><a id="more"></a></p>
<h4 id="监控相关接口"><a href="#监控相关接口" class="headerlink" title="监控相关接口"></a>监控相关接口</h4><h5 id="集群健康状态"><a href="#集群健康状态" class="headerlink" title="集群健康状态"></a>集群健康状态</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">[root@ELK-test ~]<span class="comment"># curl -XGET -u elastic:password http://localhost:9200/_cluster/health?pretty</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"cluster_name"</span> : <span class="string">"Julend_ES-cluster"</span>,</div><div class="line">  <span class="string">"status"</span> : <span class="string">"green"</span>,</div><div class="line">  <span class="string">"timed_out"</span> : <span class="literal">false</span>,</div><div class="line">  <span class="string">"number_of_nodes"</span> : 3,</div><div class="line">  <span class="string">"number_of_data_nodes"</span> : 3,</div><div class="line">  <span class="string">"active_primary_shards"</span> : 5929,</div><div class="line">  <span class="string">"active_shards"</span> : 11859,</div><div class="line">  <span class="string">"relocating_shards"</span> : 0,</div><div class="line">  <span class="string">"initializing_shards"</span> : 0,</div><div class="line">  <span class="string">"unassigned_shards"</span> : 0,</div><div class="line">  <span class="string">"delayed_unassigned_shards"</span> : 0,</div><div class="line">  <span class="string">"number_of_pending_tasks"</span> : 0,</div><div class="line">  <span class="string">"number_of_in_flight_fetch"</span> : 0,</div><div class="line">  <span class="string">"task_max_waiting_in_queue_millis"</span> : 0,</div><div class="line">  <span class="string">"active_shards_percent_as_number"</span> : 100.0</div><div class="line">&#125;</div><div class="line">[root@ELK-test ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>status状态信息：  </p>
<ul>
<li>green（绿灯）：所有分片正常运行，集群非常健康</li>
<li>yellow（黄灯）：所有主分片正常运行，但副本分片有缺失。这种情况指Elasticsearch当前是正常运行的，但有一定风险</li>
<li>red（红灯）：有主分片缺失。这部分数据完全不可用。而Elasticsearch在写入端是简单的取余算法，轮到这个分片上的数据也会持续写入报错</li>
</ul>
<p>其他数据：  </p>
<ul>
<li><code>number_of_nodes</code>: 集群内的总节点数</li>
<li><code>number_of_data_nodes</code>: 集群内的总数据节点数</li>
<li><code>active_primary_shards</code>：集群内所有索引的主分片总数</li>
<li><code>active_shards</code>: 集群内所有索引的分片总数</li>
<li><code>relocating_shards</code>：正在迁移的分片数</li>
<li><code>Initializing_shards</code>：正在初始化的分片数</li>
<li><code>unassigned_shards</code>：未分配到具体节点上的分片数</li>
<li><code>delayed_unassigned_shards</code>：延时待分配到具体节点上的分片数</li>
</ul>
<p>level请求参数<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -XGET -u elastic:admin@julend  http://localhost:9200/_cluster/health?level=indices</div></pre></td></tr></table></figure></p>
<h5 id="节点状态"><a href="#节点状态" class="headerlink" title="节点状态"></a>节点状态</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XGET -u elastic:password http://localhost:9200/_nodes/stats?pretty=true</span></div><div class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</div><div class="line">                                 Dload  Upload   Total   Spent    Left  Speed</div><div class="line">100 42846  100 42846    0     0   5123      0  0:00:08  0:00:08 --:--:-- 12874</div><div class="line">&#123;</div><div class="line">  <span class="string">"_nodes"</span> : &#123;</div><div class="line">    <span class="string">"total"</span> : 3,</div><div class="line">    <span class="string">"successful"</span> : 3,</div><div class="line">    <span class="string">"failed"</span> : 0</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"cluster_name"</span> : <span class="string">"Julend_ES-cluster"</span>,</div><div class="line">  <span class="string">"nodes"</span> : &#123;</div><div class="line">    <span class="string">"mXtk8dQeQh-amui-d5pVoA"</span> : &#123;</div><div class="line">      <span class="string">"timestamp"</span> : 1509868787579,</div><div class="line">      <span class="string">"name"</span> : <span class="string">"Julend_es1"</span>,</div><div class="line">      <span class="string">"transport_address"</span> : <span class="string">"192.168.1.41:9300"</span>,</div><div class="line">      <span class="string">"host"</span> : <span class="string">"192.168.1.41"</span>,</div><div class="line">      <span class="string">"ip"</span> : <span class="string">"192.168.1.41:9300"</span>,</div><div class="line">      <span class="string">"roles"</span> : [</div><div class="line">        <span class="string">"master"</span>,</div><div class="line">        <span class="string">"data"</span>,</div><div class="line">        <span class="string">"ingest"</span></div><div class="line">      ],</div><div class="line">...</div></pre></td></tr></table></figure>
<h5 id="索引信息"><a href="#索引信息" class="headerlink" title="索引信息"></a>索引信息</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XGET -u elastic:password http://localhost:9200/_nodes/stats?pretty=true</span></div><div class="line">...</div><div class="line">        <span class="string">"store"</span> : &#123;</div><div class="line">          <span class="string">"size_in_bytes"</span> : 38046324034,</div><div class="line">          <span class="string">"throttle_time_in_millis"</span> : 0</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"indexing"</span> : &#123;</div><div class="line">          <span class="string">"index_total"</span> : 21895145,</div><div class="line">          <span class="string">"index_time_in_millis"</span> : 4513185,</div><div class="line">          <span class="string">"index_current"</span> : 0,</div><div class="line">          <span class="string">"index_failed"</span> : 0,</div><div class="line">          <span class="string">"delete_total"</span> : 0,</div><div class="line">          <span class="string">"delete_time_in_millis"</span> : 0,</div><div class="line">          <span class="string">"delete_current"</span> : 0,</div><div class="line">          <span class="string">"noop_update_total"</span> : 0,</div><div class="line">          <span class="string">"is_throttled"</span> : <span class="literal">false</span>,</div><div class="line">          <span class="string">"throttle_time_in_millis"</span> : 0</div><div class="line">        &#125;,</div><div class="line">...</div></pre></td></tr></table></figure>
<ul>
<li><code>docs.count</code> 是节点上存储的数据条目总数</li>
<li><code>store.size_in_bytes</code> 是节点上存储的数据占用磁盘实际大小</li>
<li><code>store.throttle_time_in_millis</code> 则是Elasticsearch进程在做segment merge时出现磁盘限速的时长。如果在Elasticsearch日志中经常看到限速声明，则这个值也会偏大</li>
<li><code>indexing.index_total</code> 是一个递增的累计数，表示节点完成的数据写入总次数</li>
<li><code>indexing.delete_total</code> 记录删除的数据条数</li>
<li><code>indexing.is_throttled</code> 为Elasticsearch 2.0新增计数，因为从此Elasticsearch开始自动管理throttle</li>
</ul>
<h5 id="读取性能"><a href="#读取性能" class="headerlink" title="读取性能"></a>读取性能</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XGET -u elastic:password http://localhost:9200/_nodes/stats?pretty=true</span></div><div class="line">...</div><div class="line">        <span class="string">"get"</span> : &#123;</div><div class="line">          <span class="string">"total"</span> : 167,</div><div class="line">          <span class="string">"time_in_millis"</span> : 18,</div><div class="line">          <span class="string">"exists_total"</span> : 167,</div><div class="line">          <span class="string">"exists_time_in_millis"</span> : 18,</div><div class="line">          <span class="string">"missing_total"</span> : 0,</div><div class="line">          <span class="string">"missing_time_in_millis"</span> : 0,</div><div class="line">          <span class="string">"current"</span> : 0</div><div class="line">        &#125;,</div><div class="line">...</div></pre></td></tr></table></figure>
<ul>
<li><code>get</code> 显示的是直接使用<code>_id</code>读取数据的状态</li>
</ul>
<h5 id="搜索性能"><a href="#搜索性能" class="headerlink" title="搜索性能"></a>搜索性能</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XGET -u elastic:password http://localhost:9200/_nodes/stats?pretty=true</span></div><div class="line">...</div><div class="line">        <span class="string">"search"</span> : &#123;</div><div class="line">          <span class="string">"open_contexts"</span> : 0,</div><div class="line">          <span class="string">"query_total"</span> : 10560,</div><div class="line">          <span class="string">"query_time_in_millis"</span> : 12189,</div><div class="line">          <span class="string">"query_current"</span> : 0,</div><div class="line">          <span class="string">"fetch_total"</span> : 7078,</div><div class="line">          <span class="string">"fetch_time_in_millis"</span> : 3383,</div><div class="line">          <span class="string">"fetch_current"</span> : 0,</div><div class="line">          <span class="string">"scroll_total"</span> : 1150,</div><div class="line">          <span class="string">"scroll_time_in_millis"</span> : 6697,</div><div class="line">          <span class="string">"scroll_current"</span> : 0,</div><div class="line">          <span class="string">"suggest_total"</span> : 0,</div><div class="line">          <span class="string">"suggest_time_in_millis"</span> : 0,</div><div class="line">          <span class="string">"suggest_current"</span> : 0</div><div class="line">        &#125;,</div><div class="line">...</div></pre></td></tr></table></figure>
<ul>
<li><code>search.open_contexts</code> 表示当前正在进行的搜索</li>
<li><code>search.query_total</code> 表示节点启动以来完成的搜索数</li>
<li><code>search.query_time_in_millis</code> 表示完成上次搜索花费的时间总和。search.query_time_in_millis除以 search.query_total 越大，说明性能越差，可以通过Elasticsearch 的slowlog获取具体的搜索语句，做出针对性的优化</li>
<li><code>search.fetch_total</code> 等指标含义类似。因为Elasticsearch的搜索默认是<code>query-then-fetch</code>式的，所以fetch一般小而快。如果计算search.fetch_time_in_millis &gt; search.query_time_in_millis，说明有人采用了较大的size参数做分页查询，通过showlog抓到具体的语句，相机优化成 scan式搜索</li>
</ul>
<h5 id="段合并性能"><a href="#段合并性能" class="headerlink" title="段合并性能"></a>段合并性能</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XGET -u elastic:password http://localhost:9200/_nodes/stats?pretty=true</span></div><div class="line">...</div><div class="line">        <span class="string">"merges"</span> : &#123;</div><div class="line">          <span class="string">"current"</span> : 0,</div><div class="line">          <span class="string">"current_docs"</span> : 0,</div><div class="line">          <span class="string">"current_size_in_bytes"</span> : 0,</div><div class="line">          <span class="string">"total"</span> : 15675,</div><div class="line">          <span class="string">"total_time_in_millis"</span> : 8422758,38 16295         </div><div class="line">          <span class="string">"total_docs"</span> : 142493991,</div><div class="line">          <span class="string">"total_size_in_bytes"</span> : 75031786583,</div><div class="line">          <span class="string">"total_stopped_time_in_millis"</span> : 0,</div><div class="line">          <span class="string">"total_throttled_time_in_millis"</span> : 222454,</div><div class="line">          <span class="string">"total_auto_throttle_in_bytes"</span> : 839578885310</div><div class="line">          &#125;,</div><div class="line">...</div></pre></td></tr></table></figure>
<ul>
<li><code>merges</code> 数据分为两部分，current开头的是当前正在发生的段合并行为统计；total开头的历史统计总数。作为ELK，以数据写入压力为主，merges相关数据会比较突出</li>
</ul>
<h5 id="过滤器缓存"><a href="#过滤器缓存" class="headerlink" title="过滤器缓存"></a>过滤器缓存</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XGET -u elastic:password http://localhost:9200/_nodes/stats?pretty=true</span></div><div class="line">...</div><div class="line"><span class="string">"filter_cache"</span>: &#123;</div><div class="line">    <span class="string">"memory_size_in_bytes"</span>: 48,</div><div class="line">    <span class="string">"evictions"</span>: 0</div><div class="line">&#125;,</div><div class="line">...</div></pre></td></tr></table></figure>
<ul>
<li><code>filter_cache.memory_size_in_bytes</code> 表示过滤器缓存使用的内存</li>
<li><code>filter_cache.evictions</code> 表示因内存满被回收的缓存大小，如果这个数比较大，说明过滤器缓存大小不足，或者过滤器本身不太适合缓存<br><em>注：过滤器缓存是建立在 megment 基础上，在当天新日志搜索中，存在大量或多或少的 segment。一个5G的segment和一个2M的segment，发生一次<code>filter_cache.evictions</code> 对搜索性能影响区别是巨大的。但节点状态中本身这个计数并不能反应这点区别。所以尽量减少这个数值，如果搜索本身感觉不慢，这几个值也无所谓</em>  </li>
</ul>
<h5 id="id缓存"><a href="#id缓存" class="headerlink" title="id缓存"></a>id缓存</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XGET -u elastic:password http://localhost:9200/_nodes/stats?pretty=true</span></div><div class="line">...</div><div class="line"><span class="string">"id_cache"</span>: &#123;</div><div class="line">    <span class="string">"memory_size_in_bytes"</span>: 0</div><div class="line">&#125;,</div><div class="line">...</div></pre></td></tr></table></figure>
<ul>
<li><code>id_cache</code> 是 <code>parent/child mappings</code> 使用的内存。不过在ELK中，一般不会用到这个性能，所以此处数据一般为0  </li>
</ul>
<h5 id="fielddata"><a href="#fielddata" class="headerlink" title="fielddata"></a>fielddata</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XGET -u elastic:password http://localhost:9200/_nodes/stats?pretty=true</span></div><div class="line">...</div><div class="line">        <span class="string">"fielddata"</span> : &#123;</div><div class="line">          <span class="string">"memory_size_in_bytes"</span> : 32480,</div><div class="line">          <span class="string">"evictions"</span> : 0</div><div class="line">        &#125;,</div><div class="line">...</div></pre></td></tr></table></figure>
<p>此处显示fielddata使用的内存大小。fielddata用来做聚合、排序等工作。  </p>
<h5 id="segments"><a href="#segments" class="headerlink" title="segments"></a>segments</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XGET -u elastic:password http://localhost:9200/_nodes/stats?pretty=true</span></div><div class="line">...</div><div class="line">        <span class="string">"segments"</span> : &#123;</div><div class="line">          <span class="string">"count"</span> : 18741,</div><div class="line">          <span class="string">"memory_in_bytes"</span> : 193556533,</div><div class="line">          <span class="string">"terms_memory_in_bytes"</span> : 152266264,</div><div class="line">          <span class="string">"stored_fields_memory_in_bytes"</span> : 17067832,</div><div class="line">          <span class="string">"term_vectors_memory_in_bytes"</span> : 0,</div><div class="line">          <span class="string">"norms_memory_in_bytes"</span> : 13141184,</div><div class="line">          <span class="string">"points_memory_in_bytes"</span> : 2426489,</div><div class="line">          <span class="string">"doc_values_memory_in_bytes"</span> : 8654764,</div><div class="line">          <span class="string">"index_writer_memory_in_bytes"</span> : 0,</div><div class="line">          <span class="string">"version_map_memory_in_bytes"</span> : 0,</div><div class="line">          <span class="string">"fixed_bit_set_memory_in_bytes"</span> : 1552,</div><div class="line">          <span class="string">"max_unsafe_auto_id_timestamp"</span> : 1509866960317,</div><div class="line">          <span class="string">"file_sizes"</span> : &#123; &#125;</div><div class="line">        &#125;,</div><div class="line">...</div></pre></td></tr></table></figure>
<ul>
<li><code>segments.count</code> 表示节点上所有索引的segment 数目总和。一般来说，一个索引通常会有50-150个 segment ，再多就对性能有较大影响了（可能merge 速度跟不上新segment 出现的速度）。  </li>
<li><code>segments.memory_in_bytes</code>  表示segment本身底层数据结构所使用的内存大小。像索引的倒排表，词典，bloom Filter（Elasticsearch 1.4以后默认关闭）等，所以过多的segment会导致这个数值迅速变大。  </li>
</ul>
<h4 id="任务管理"><a href="#任务管理" class="headerlink" title="任务管理"></a>任务管理</h4><h5 id="等待执行的任务列表"><a href="#等待执行的任务列表" class="headerlink" title="等待执行的任务列表"></a>等待执行的任务列表</h5><p>master只有集群状态的数据维护，一般来说，这个任务列表都是空的<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XGET -u elastic:password http://localhost:9200/_cluster/pending_tasks?pretty</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"tasks"</span> : [ ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果遇到集群有异常，比如频繁更新索引，数据恢复，分片分配或者初始化的时候反复出错，就会看到一些任务了。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#集群故障了，出现了很多任务</span></div><div class="line"><span class="comment"># curl -XGET -u elastic:password http://localhost:9200/_cluster/pending_tasks?pretty</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"tasks"</span> : [</div><div class="line">    &#123;</div><div class="line">      <span class="string">"insert_order"</span> : 1959,</div><div class="line">      <span class="string">"priority"</span> : <span class="string">"URGENT"</span>,</div><div class="line">      <span class="string">"source"</span> : <span class="string">"shard-started shard id [[192.168.1.24-thirdparty_errorlog-2017.11.02][2]], allocation id [rUOqVHjmTZiqL</span></div><div class="line">COvSaYDnA], primary term [0], message [after existing recovery]",      <span class="string">"executing"</span> : <span class="literal">true</span>,</div><div class="line">      <span class="string">"time_in_queue_millis"</span> : 833,</div><div class="line">      <span class="string">"time_in_queue"</span> : <span class="string">"833ms"</span></div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="string">"insert_order"</span> : 1960,</div><div class="line">      <span class="string">"priority"</span> : <span class="string">"URGENT"</span>,</div><div class="line">      <span class="string">"source"</span> : <span class="string">"shard-started shard id [[192.168.1.21-thirdparty_log-2017.11.02][4]], allocation id [kmyECWLXRSKM4YDlsX</span></div><div class="line">mRcA], primary term [0], message [after existing recovery]",      <span class="string">"executing"</span> : <span class="literal">false</span>,</div><div class="line">      <span class="string">"time_in_queue_millis"</span> : 809,</div><div class="line">      <span class="string">"time_in_queue"</span> : <span class="string">"809ms"</span></div><div class="line">    &#125;,</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>集群存储长期数据导致索引映射数据确实大到了master节点内存不足以快速处理的地步。<br>根据实际情况，可以选择：  </p>
<ul>
<li>索引特别多：给master加内存</li>
<li>索引字段太多：改用nested object 方式节省字段数量</li>
<li>索引多到内存不够了：把一部分数据拆出来到另一个集群</li>
</ul>
<h5 id="新版任务管理"><a href="#新版任务管理" class="headerlink" title="新版任务管理"></a>新版任务管理</h5><p>新版任务并没有独立的接口，发起的具体某次search、snapshot、reindex等操作，自动就成了一个任务。而任务的列表可以通过<code>/_tasks</code>或者<code>/_cat/tasks</code>接口来获取。和其他操作一样，手动操作用cat，写程序时用JSON接口。  </p>
<p>取消某个任务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XGET -u elastic:admin@julend http://localhost:9200/_cat/tasks?v #获取当前任务</span></div><div class="line">action                         task_id                       parent_task_id                <span class="built_in">type</span> start_time    timest</div><div class="line">amp  running_time ip           nodeindices:monitor/stats          Go1e5drSSum7gbrKpIef8g:175591 -                             transport 1509884620079 20:23:</div><div class="line">40  487ms        192.168.1.43 Julend_es3indices:monitor/stats[n]       VQf-ph7NRTeiEVHqAT4pRw:140954 Go1e5drSSum7gbrKpIef8g:175591 netty     1509884619871 20:23:</div><div class="line">39  410.2ms      192.168.1.42 Julend_es2cluster:monitor/tasks/lists    mXtk8dQeQh-amui<span class="_">-d</span>5pVoA:145705 -                             transport 1509884621290 20:23:</div><div class="line">41  17.3ms       192.168.1.41 Julend_es1cluster:monitor/tasks/lists[n] VQf-ph7NRTeiEVHqAT4pRw:140959 mXtk8dQeQh-amui<span class="_">-d</span>5pVoA:145705 netty     1509884620249 20:23:</div><div class="line">40  32ms         192.168.1.42 Julend_es2cluster:monitor/tasks/lists[n] Go1e5drSSum7gbrKpIef8g:175595 mXtk8dQeQh-amui<span class="_">-d</span>5pVoA:145705 netty     1509884620544 20:23:</div><div class="line">40  21.4ms       192.168.1.43 Julend_es3cluster:monitor/tasks/lists[n] mXtk8dQeQh-amui<span class="_">-d</span>5pVoA:145706 mXtk8dQeQh-amui<span class="_">-d</span>5pVoA:145705 direct    1509884621306 20:23:</div><div class="line">41  1.3ms        192.168.1.41 Julend_es1</div><div class="line"></div><div class="line"><span class="comment"># curl -XPOST 'http://localhost:9200/_tasks/task_id:175591/_cancel'</span></div></pre></td></tr></table></figure></p>
<p>而 search任务和 reindex任务不同。Elasticsearch从5.1.1版本开始支持取消还在运行的search任务，但这个行为并不能立即生效。<br>默认情况下，对search tasks的管理粒度是以segment为单位的。即，这个搜索会在执行完当前segment后才停止。历史索引已经经过 forcemerge接口优化，一个分片里面只有一个segment，那么这个cancel可以认为是无效的。<br>对于这种情况，Elasticsearch提供了另一个更细粒度但是也更消耗资源的方法。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPOST 'http://localhost:9200/_cluster/settings' -d '&#123;</span></div><div class="line">    <span class="string">"persistent"</span>: &#123;</div><div class="line">        <span class="string">"search.low_level_cancellation"</span>: <span class="literal">true</span></div><div class="line">    &#125;</div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure></p>
<p>这时，所有的搜索任务，都会定期检查自己是否被取消了。也这可能导致比较慢的搜索，执行时间更加漫长。  </p>
<h5 id="cat接口命令行使用"><a href="#cat接口命令行使用" class="headerlink" title="cat接口命令行使用"></a>cat接口命令行使用</h5><p>用户日常运维，可以读取各种监控数据  </p>
<ul>
<li><code>/_cat/nodes</code></li>
<li><code>/_cat/shards</code></li>
<li><code>/_cat/shards/{index}</code></li>
<li><code>/_cat/aliases</code></li>
<li><code>/_cat/aliases/{alias}</code></li>
<li><code>/_cat/tasks</code></li>
<li><code>/_cat/master</code></li>
<li><code>/_cat/plugins</code></li>
<li><code>/_cat/fielddata</code></li>
<li><code>/_cat/fielddata/{fields}</code></li>
<li><code>/_cat/pending_tasks</code></li>
<li><code>/_cat/count</code></li>
<li><code>/_cat/count/{index}</code></li>
<li><code>/_cat/snapshots/{repository}</code></li>
<li><code>/_cat/recovery</code></li>
<li><code>/_cat/recovery/{index}</code></li>
<li><code>/_cat/segments</code></li>
<li><code>/_cat/segments/{index}</code></li>
<li><code>/_cat/thread_pool</code></li>
<li><code>/_cat/thread_pool/{thread_pools}/_cat/nodeattrs</code></li>
<li><code>/_cat/allocation</code></li>
<li><code>/_cat/repositories</code></li>
<li><code>/_cat/health</code></li>
<li><code>/_cat/indices</code></li>
<li><code>/_cat/indices/{index}</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XGET -u elastic:password http://localhost:9200/_cat/nodes?help</span></div><div class="line">id           | id,nodeId      | unique node id           </div><div class="line">pid          | p              | process id               </div><div class="line">ip           | i              | ip address               </div><div class="line">port         | po             | bound transport port     </div><div class="line">http_address | http           | bound http address       </div><div class="line">version      | v              | es version</div><div class="line">...</div></pre></td></tr></table></figure>
<h5 id="bigdesk"><a href="#bigdesk" class="headerlink" title="bigdesk"></a>bigdesk</h5><p>地址：<a href="https://github.com/hlstudio/bigdesk" target="_blank" rel="external">https://github.com/hlstudio/bigdesk</a><br>bigdesk是一款针对Elasticsearch 性能的开源实时监控方案。  </p>
<h5 id="zabbix-trapper"><a href="#zabbix-trapper" class="headerlink" title="zabbix trapper"></a>zabbix trapper</h5><p>地址：<a href="https://github.com/Wprosdocimo/Elasticsearch-zabbix" target="_blank" rel="external">https://github.com/Wprosdocimo/Elasticsearch-zabbix</a><br><a href="https://github.com/untergeek/zabbix-grab-bag/blob/master/Elasticsearch/es_stats_zabbix.README.md" target="_blank" rel="external">https://github.com/untergeek/zabbix-grab-bag/blob/master/Elasticsearch/es_stats_zabbix.README.md</a>  </p>
<h4 id="Percolator接口"><a href="#Percolator接口" class="headerlink" title="Percolator接口"></a>Percolator接口</h4><p>ELK stack告警方式：  </p>
<ol>
<li>对于匹配报警，采用Elasticsearch的 Percolator接口做响应告警。  </li>
<li>对于时序统计，采用定时任务方式，发送Elasticsearch aggs请求，分析响应体报警。</li>
</ol>
<p>在Elasticsearch 5.0后，对Percolator 功能大幅改造，而现在作为一种 mapping类型，在创建索引时需要预先定义。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPUT http://localhost:9200/syslog -d '&#123;</span></div><div class="line">    <span class="string">"mappings"</span>: &#123;</div><div class="line">        <span class="string">"syslog"</span>: &#123;</div><div class="line">            <span class="string">"properties"</span>: &#123;</div><div class="line">                <span class="string">"message"</span>: &#123;</div><div class="line">                    <span class="string">"type"</span>: <span class="string">"text"</span></div><div class="line">                &#125;,</div><div class="line">                <span class="string">"severity"</span>: &#123;</div><div class="line">                    <span class="string">"type"</span>: <span class="string">"long"</span></div><div class="line">                &#125;,</div><div class="line">                <span class="string">"program"</span>: &#123;</div><div class="line">                    <span class="string">"type"</span>: <span class="string">"keyword"</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"queries"</span>: &#123;</div><div class="line">            <span class="string">"properties"</span>: &#123;</div><div class="line">                <span class="string">"query"</span>: &#123;</div><div class="line">                    <span class="string">"type"</span>: <span class="string">"percolator"</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">    &#125;</div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure></p>
<p>然后往 <code>syslog/queries</code> 里注册两条 percolator 请求规则：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPUT http://localhost:9200/syslog/queries/memory -d '&#123;</span></div><div class="line">    <span class="string">"query"</span>: &#123;</div><div class="line">        <span class="string">"query_string"</span>: &#123;</div><div class="line">            <span class="string">"default_field"</span>: <span class="string">"message"</span>,</div><div class="line">            <span class="string">"default_operator"</span>: <span class="string">"OR"</span>,</div><div class="line">            <span class="string">"query"</span>: <span class="string">"mem DMA segfault page allocation AND severity: &gt;2 AND program:kernel"</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPUT http://localhost:9200/syslog/queries/disk -d '&#123;</span></div><div class="line">    <span class="string">"query"</span>: &#123;</div><div class="line">        <span class="string">"query_string"</span>: &#123;</div><div class="line">            <span class="string">"default_field"</span>: <span class="string">"message"</span>,</div><div class="line">            <span class="string">"default_operator"</span>: <span class="string">"OR"</span>,</div><div class="line">            <span class="string">"query"</span>: <span class="string">"scsi sata hdd sda AND severity:&gt;2 AND program:kernal"</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure>
<p>然后，将标准的数据写入请求改成通过搜索接口进行：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPOST http://localhost:9200/syslog/_search -d '&#123;</span></div><div class="line">    <span class="string">"query"</span>: &#123;</div><div class="line">        <span class="string">"percolate"</span>: &#123;</div><div class="line">            <span class="string">"field"</span>: <span class="string">"query"</span>,</div><div class="line">            <span class="string">"document_type"</span>: <span class="string">"syslog"</span>,</div><div class="line">            <span class="string">"document"</span>: &#123;</div><div class="line">                <span class="string">"program"</span>: <span class="string">"kernel"</span>,</div><div class="line">                <span class="string">"severity"</span>: 3,</div><div class="line">                <span class="string">"message"</span>: <span class="string">"swapper/0: page allocation failure: order:4, mode:0x4020"</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure></p>
<p>得到的结果如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    ...</div><div class="line">    <span class="string">"hits"</span>: [</div><div class="line">        &#123;</div><div class="line">            <span class="string">"_index"</span>: <span class="string">"syslog"</span>,</div><div class="line">            <span class="string">"_type"</span>: <span class="string">"queries"</span>,</div><div class="line">            <span class="string">"_id"</span>: <span class="string">"memory"</span>,</div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line">    ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这条syslog 日志匹配上了memory内存异常。下面就可以发送给报警系统了。<br>如果syslog 索引中已经有数据了，也可以重新 Percolator 查询。比如：有一条之前已经写入到 <a href="http://localhost:9200/syslog/cisco/1234567" target="_blank" rel="external">http://localhost:9200/syslog/cisco/1234567</a> 的数据，如果把这条数据在过一次 Percolate：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPOST http://localhost:9200/syslog/_search -d '&#123;</span></div><div class="line">    <span class="string">"query"</span>: &#123;</div><div class="line">        <span class="string">"percolate"</span>: &#123;</div><div class="line">            <span class="string">"field"</span>: <span class="string">"query"</span>,</div><div class="line">            <span class="string">"document_type"</span>: <span class="string">"syslog"</span>,</div><div class="line">            <span class="string">"index"</span>: <span class="string">"syslog"</span>,</div><div class="line">            <span class="string">"type"</span>: <span class="string">"cisco"</span>,</div><div class="line">            <span class="string">"id"</span>: <span class="string">"1234567"</span>,</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure></p>
<p>更复杂的 query DSL 做 Percolator 请求示例，参考：<a href="https://www.elastic.co/blog/using-percolator-geo-tagging" target="_blank" rel="external">https://www.elastic.co/blog/using-percolator-geo-tagging</a>  </p>
<h4 id="报警机制"><a href="#报警机制" class="headerlink" title="报警机制"></a>报警机制</h4><h5 id="Watcher报警"><a href="#Watcher报警" class="headerlink" title="Watcher报警"></a>Watcher报警</h5><p>现在已经集成到X-PACK，安装X-PACK即可<br>参考：<a href="https://www.elastic.co/cn/products/x-pack/alerting" target="_blank" rel="external">https://www.elastic.co/cn/products/x-pack/alerting</a>  </p>
<h5 id="ElastAlert"><a href="#ElastAlert" class="headerlink" title="ElastAlert"></a>ElastAlert</h5><p>与 Watcher 属于同类型产品。<br>参考：<a href="http://elastalert.readthedocs.io/en/latest/" target="_blank" rel="external">http://elastalert.readthedocs.io/en/latest/</a>  </p>
<h5 id="Etsy的-Kale-异常检测"><a href="#Etsy的-Kale-异常检测" class="headerlink" title="Etsy的 Kale 异常检测"></a>Etsy的 Kale 异常检测</h5><p>Kale 系统是一个监控分析系统，分为：skyline 和 oculus。<br>参考：<a href="https://codeascraft.com/2013/06/11/introducing-kale/" target="_blank" rel="external">https://codeascraft.com/2013/06/11/introducing-kale/</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/11/14/Elasticsearch监控相关/">http://www.yfshare.vip/2017/11/14/Elasticsearch监控相关/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Elasticsearch相关监控接口&lt;br&gt;
    
    </summary>
    
      <category term="ELK" scheme="http://www.yfshare.vip/categories/ELK/"/>
    
    
      <category term="Elasticsearch" scheme="http://www.yfshare.vip/tags/Elasticsearch/"/>
    
      <category term="Monitor" scheme="http://www.yfshare.vip/tags/Monitor/"/>
    
  </entry>
  
  <entry>
    <title>部署FileBeat+logstash+elasticsearch集群+kibana</title>
    <link href="http://www.yfshare.vip/2017/11/04/%E9%83%A8%E7%BD%B2FileBeat-logstash-elasticsearch%E9%9B%86%E7%BE%A4-kibana/"/>
    <id>http://www.yfshare.vip/2017/11/04/部署FileBeat-logstash-elasticsearch集群-kibana/</id>
    <published>2017-11-04T13:48:47.000Z</published>
    <updated>2017-11-04T14:07:20.636Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/APlayer.min.js"> </script><script src="/assets/js/DPlayer.min.js"> </script><p>ELK由Elasticsearch、Logstash和Kibana三部分组件组成，这里新增了一个FileBeat，它是一个轻量级的日志收集处理工具(Agent)，Filebeat占用资源少，适合于在各个服务器上搜集日志后传输给Logstash，官方也推荐此工具<br><a id="more"></a><br>Filebeat隶属于Beats。目前Beats包含四种工具：  </p>
<ol>
<li>Packetbeat（搜集网络流量数据）  </li>
<li>Topbeat（搜集系统、进程和文件系统级别的 CPU 和内存使用情况等数据）</li>
<li>Filebeat（搜集文件数据）</li>
<li>Winlogbeat（搜集 Windows 事件日志数据）</li>
</ol>
<p>官方文档<br>Filebeat：<br><a href="https://www.elastic.co/cn/products/beats/filebeat" target="_blank" rel="external">https://www.elastic.co/cn/products/beats/filebeat</a><br><a href="https://www.elastic.co/guide/en/beats/filebeat/5.6/index.html" target="_blank" rel="external">https://www.elastic.co/guide/en/beats/filebeat/5.6/index.html</a>  </p>
<p>Logstash：<br><a href="https://www.elastic.co/cn/products/logstash" target="_blank" rel="external">https://www.elastic.co/cn/products/logstash</a><br><a href="https://www.elastic.co/guide/en/logstash/5.6/index.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/5.6/index.html</a></p>
<p>Elasticsearch：<br><a href="https://www.elastic.co/cn/products/elasticsearch" target="_blank" rel="external">https://www.elastic.co/cn/products/elasticsearch</a><br><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/index.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/reference/5.6/index.html</a>  </p>
<p>elasticsearch中文社区：<br><a href="https://elasticsearch.cn/" target="_blank" rel="external">https://elasticsearch.cn/</a> </p>
<p>官方ELK架构图：<br><img src="http://note.youdao.com/yws/api/personal/file/DCE29CF684C34FC3BA73809D566B0150?method=download&amp;shareKey=798f64543357202a0efb9a95d35c4e5b" alt="filebeat">  </p>
<p>本次环境的拓扑图：<br><img src="http://note.youdao.com/yws/api/personal/file/4772759A56704D82A3D1C6056C76613F?method=download&amp;shareKey=3c9825a509086b1a28b8ffd34aa9c6b0" alt="ELK_拓扑图">  </p>
<p>环境：<br>　　　Centos 7.3<br>　　　Filebeat 5.6.1<br>　　　Logstash 5.6.1<br>　　　Kibana 5.6.1  </p>
<p>软件下载：<br><a href="http://note.youdao.com/yws/api/personal/file/09E0C74E473348FA8DCBDB96F3AEE13D?method=download&amp;shareKey=9d9dc334d3d6c72613c00359372887a9" target="_blank" rel="external">filebeat-5.6.1-x86_64.rpm</a><br><a href="http://note.youdao.com/yws/api/personal/file/85468EC34C484B3F8D2B0AF3B7386841?method=download&amp;shareKey=e00a03bcfbc3d4b63c419ab1139a8765" target="_blank" rel="external">kibana-5.6.1-x86_64.rpm</a><br><a href="http://note.youdao.com/yws/api/personal/file/3D218AEF94474D4A9BC755B4AAADFE0B?method=download&amp;shareKey=3f79c453a9993cd899f38420983db94e" target="_blank" rel="external">logstash-5.6.1.rpm</a><br><a href="http://note.youdao.com/yws/api/personal/file/430B5F758002423A92C9023EF656C1E5?method=download&amp;shareKey=7507f90e005394aff511356bd60fc28e" target="_blank" rel="external">elasticsearch-5.6.1.rpm</a>  </p>
<h3 id="环境部署"><a href="#环境部署" class="headerlink" title="环境部署"></a>环境部署</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#环境部署（安装）</span></div><div class="line"><span class="comment">#每台机器上都需要安装JDK</span></div><div class="line">[root@DevEVN-21 ~]<span class="comment"># curl -L -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-5.6.1-x86_64.rpm</span></div><div class="line">[root@DevEVN-21 ~]<span class="comment"># rpm -ivh filebeat-5.6.1-x86_64.rpm</span></div><div class="line">[root@DevEVN-21 ~]<span class="comment"># rpm -qa | grep -i filebeat</span></div><div class="line">filebeat-5.6.1-1.x86_64</div><div class="line">[root@DevEVN-21 ~]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@ELK-test software]<span class="comment"># wget https://artifacts.elastic.co/downloads/logstash/logstash-5.6.1.rpm</span></div><div class="line">[root@ELK-test software]<span class="comment"># wget http://download.oracle.com/otn-pub/java/jdk/8u144-b01/090f390dda5b47b9b721c7dfaa008135/jdk-8u144-linux-x64.tar.gz?AuthParam=1505893074_6e8dfac4ee1e712087b65acabe8b2506 -O jdk-8u144-linux-x64.tar.gz</span></div><div class="line">[root@ELK-test software]<span class="comment"># tar -zxf jdk-8u144-linux-x64.tar.gz  -C /usr/local/</span></div><div class="line">[root@ELK-test ~]<span class="comment">#</span></div><div class="line">[root@ELK-test ~]<span class="comment"># cat /etc/profile.d/java.sh</span></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="built_in">export</span> JAVA_HOME=<span class="string">'/usr/local/jdk1.8.0_144'</span></div><div class="line"><span class="built_in">export</span> PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span></div><div class="line">[root@ELK-test ~]<span class="comment"># source /etc/profile.d/java.sh</span></div><div class="line">[root@ELK-test ~]<span class="comment"># java -version</span></div><div class="line">java version <span class="string">"1.8.0_144"</span></div><div class="line">Java(TM) SE Runtime Environment (build 1.8.0_144-b01)</div><div class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.144-b01, mixed mode)</div><div class="line">[root@ELK-test ~]<span class="comment">#</span></div><div class="line">[root@ELK-test software]<span class="comment"># rpm -ivh logstash-5.6.1.rpm</span></div><div class="line">[root@ELK-test software]<span class="comment"># rpm -qa | grep logstash</span></div><div class="line">logstash-5.6.1-1.noarch</div><div class="line">[root@ELK-test software]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@ELK-test software]<span class="comment"># wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.6.1.rpm</span></div><div class="line">[root@ELK-test software]<span class="comment"># yum install elasticsearch-5.6.1.rpm</span></div><div class="line">[root@ELK-test software]<span class="comment"># rpm -qa | grep elasticsearch</span></div><div class="line">elasticsearch-5.6.1-1.noarch</div><div class="line">[root@ELK-test software]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@ELK-test software]<span class="comment"># wget https://artifacts.elastic.co/downloads/kibana/kibana-5.6.1-x86_64.rpm</span></div><div class="line">[root@ELK-test software]<span class="comment"># rpm -ivh kibana-5.6.1-x86_64.rpm</span></div><div class="line">[root@ELK-test software]<span class="comment"># rpm -qa | grep kibana</span></div><div class="line">kibana-5.6.1-1.x86_64</div><div class="line">[root@ELK-test software]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@ELK-test ~]<span class="comment"># ll /data/ELK_data/*</span></div><div class="line">/data/ELK_data/elasticsearch:</div><div class="line">total 8</div><div class="line">drwxr-xr-x. 3 elasticsearch elasticsearch 4096 Sep 22 17:25 data</div><div class="line">drwxr-xr-x. 2 elasticsearch elasticsearch 4096 Oct 19 19:54 logs</div><div class="line"></div><div class="line">/data/ELK_data/kibana:</div><div class="line">total 8</div><div class="line">drwxr-xr-x. 2 kibana kibana 4096 Sep 22 16:50 data</div><div class="line">drwxr-xr-x. 2 kibana kibana 4096 Sep 22 16:50 logs</div><div class="line"></div><div class="line">/data/ELK_data/logstash:</div><div class="line">total 8</div><div class="line">drwxr-xr-x. 4 logstash logstash 4096 Oct 19 19:51 data_192.168.1.21</div><div class="line">drwxr-xr-x. 2 logstash logstash 4096 Oct 19 17:41 logs</div><div class="line">[root@ELK-test ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><h4 id="配置-filebeart"><a href="#配置-filebeart" class="headerlink" title="配置 filebeart"></a>配置 filebeart</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#配置filebeart</span></div><div class="line">[root@DevEVN-21 ~]<span class="comment"># grep -iv '#' /etc/filebeat/filebeat.yml | grep -iv '^$'</span></div><div class="line">filebeat.prospectors:</div><div class="line">- input_type: <span class="built_in">log</span>  <span class="comment">#指定文件的输入类型log(默认)或者stdin</span></div><div class="line">  paths:   <span class="comment">#指定要监控的日志，目前按照Go语言的glob函数处理，没有对配置目录做递归处理，如果指定的文件为/var/log/*.log的话，会读取该目录下所有以log结尾的文件，但是这样不好，在logstash上不好处理，会写到一个文件内，kibana显示会很乱，建议分开写</span></div><div class="line">    - /data/soros/logs/soros-account-service-error.log      <span class="comment">#指定filebeat读取的文件（绝对路径）</span></div><div class="line">  document_type: 192.168.1.21-account_errorlog   <span class="comment">#设定Elasticsearch输出时的document的type字段，也可以用来给日志进行分类</span></div><div class="line"></div><div class="line">- input_type: <span class="built_in">log</span></div><div class="line">  paths:</div><div class="line">    - /data/soros/logs/soros-account-service.log</div><div class="line">  document_type: 192.168.1.21-account_log</div><div class="line"></div><div class="line">output.logstash:</div><div class="line">  hosts: [<span class="string">"192.168.1.41:5044"</span>]     <span class="comment">#指定logstash服务器地址及端口，可以指定多个logstash</span></div><div class="line">[root@DevEVN-21 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>参考：<a href="http://blog.csdn.net/xiongzhichao/article/details/51783704" target="_blank" rel="external">Filebeat的高级配置</a><br><a href="http://www.cnblogs.com/zlslch/p/6622079.html" target="_blank" rel="external">filebeat.yml配置详解</a><br><a href="https://www.ibm.com/developerworks/cn/opensource/os-cn-elk-filebeat/index.html" target="_blank" rel="external">ELK+Filebeat 集中式日志解决方案详解</a>  </p>
<h4 id="配置-logstash"><a href="#配置-logstash" class="headerlink" title="配置 logstash"></a>配置 logstash</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">[root@ELK-test ~]<span class="comment"># grep -iv '#' /etc/logstash/logstash.yml | grep -iv '^$'</span></div><div class="line">path.data: /data/ELK_data/logstash/data</div><div class="line">path.config: /etc/logstash/conf.d</div><div class="line">http.host: <span class="string">"0.0.0.0"</span></div><div class="line">path.logs: /data/ELK_data/logstash/logs</div><div class="line">[root@ELK-test ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#配置logstash</span></div><div class="line">[root@ELK-test ~]<span class="comment"># grep -iv '#' /etc/logstash/conf.d/logstash_192.168.1.21.conf | grep -iv '^$'</span></div><div class="line"><span class="comment">#指定logstash监听filebeat的端口</span></div><div class="line">input &#123;</div><div class="line">  beats &#123;</div><div class="line">    port =&gt; 5044</div><div class="line">    codec =&gt; multiline &#123;</div><div class="line">         pattern =&gt; <span class="string">"^%&#123;YEAR&#125;[/-]%&#123;MONTHNUM&#125;[/-]%&#123;MONTHDAY&#125;[/_]%&#123;TIME&#125; "</span></div><div class="line">         negate =&gt; <span class="literal">true</span></div><div class="line">         what =&gt; previous</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">#pattern：多行日志开始的那一行匹配的</span></div><div class="line"><span class="comment">#pattern negate：是否需要对pattern条件转置使用，不翻转设为true，反转设置为false</span></div><div class="line"><span class="comment">#match：匹配pattern后，与前面(后面)的内容合并为一条日志</span></div><div class="line"><span class="comment">#max_lines：合并的最多行数(包含匹配pattern的那一行)，到了timeout之后，即使没有匹配一个新的pattern（发生一个新的事件），也把已经匹配的日志事件发送出去</span></div><div class="line"></div><div class="line"><span class="comment">#output测试输出到控制台</span></div><div class="line">output &#123;</div><div class="line"><span class="comment">#program logs</span></div><div class="line">    <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">'192.168.1.21-account_errorlog'</span>&#123;        <span class="comment">#'192.168.1.21-account_errorlog'为filebeat配置中由document_type定义的</span></div><div class="line">        elasticsearch &#123;          <span class="comment">#输出到elasticsearch中</span></div><div class="line">                hosts =&gt; [<span class="string">"192.168.1.41:9200"</span>,<span class="string">"192.168.1.42:9200"</span>,<span class="string">"192.168.1.43:9200"</span>]       <span class="comment">#指定elasticsearch主机</span></div><div class="line">		index =&gt; <span class="string">"%&#123;type&#125;-%&#123;+YYYY.MM.dd&#125;"</span></div><div class="line">		document_type =&gt; <span class="string">"log"</span>       <span class="comment">#设定Elasticsearch输出时的document的type字段，也可以用来给日志进行分类</span></div><div class="line">		template_overwrite =&gt; <span class="literal">true</span>       <span class="comment">#如果设置为true，模板名字一样的时候，新的模板会覆盖旧的模板</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">'192.168.1.21-account_log'</span>&#123;</div><div class="line">        elasticsearch &#123;</div><div class="line">                hosts =&gt; [<span class="string">"192.168.1.41:9200"</span>,<span class="string">"192.168.1.42:9200"</span>,<span class="string">"192.168.1.43:9200"</span>]</div><div class="line">		index =&gt; <span class="string">"%&#123;type&#125;-%&#123;+YYYY.MM.dd&#125;"</span></div><div class="line">		document_type =&gt; <span class="string">"log"</span></div><div class="line">		template_overwrite =&gt; <span class="literal">true</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">[root@ELK-test ~]<span class="comment">#</span></div><div class="line"></div><div class="line">其他机器的logstash配置同上</div></pre></td></tr></table></figure>
<p>参考：<a href="http://blog.csdn.net/shudaqi2010/article/details/53941389" target="_blank" rel="external">Elasticsearch之<em>default</em>—— 为索引添加默认映射</a><br><a href="http://blog.chinaunix.net/uid-532511-id-4845841.html" target="_blank" rel="external">logstash 多行数据合并 &amp; 日志时间字段解析</a>  </p>
<h4 id="配置-elasticsearch集群"><a href="#配置-elasticsearch集群" class="headerlink" title="配置 elasticsearch集群"></a>配置 elasticsearch集群</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Julend_es1 节点</span></div><div class="line">[root@ELK-test ~]<span class="comment"># grep -iv '#' /etc/elasticsearch/elasticsearch.yml | grep -iv '^$'</span></div><div class="line">cluster.name: <span class="string">"Julend_ES-cluster"</span></div><div class="line">node.name: Julend_es1</div><div class="line">node.data: <span class="literal">true</span></div><div class="line">http.enabled: <span class="literal">true</span></div><div class="line">path.data: /data/ELK_data/elasticsearch/data</div><div class="line">path.logs: /data/ELK_data/elasticsearch/logs</div><div class="line">network.host: 0.0.0.0</div><div class="line">http.port: 9200</div><div class="line">http.cors.enabled: <span class="literal">true</span></div><div class="line">http.cors.allow-origin: <span class="string">"*"</span></div><div class="line">discovery.zen.ping.unicast.hosts: [<span class="string">"192.168.1.41"</span>, <span class="string">"192.168.1.42"</span>, <span class="string">"192.168.1.43"</span>]</div><div class="line">discovery.zen.minimum_master_nodes: 3</div><div class="line">gateway.recover_after_nodes: 2</div><div class="line">[root@ELK-test ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Julend_es2 节点</span></div><div class="line">[root@ELK-test2 ~]<span class="comment"># grep -iv '#' /etc/elasticsearch/elasticsearch.yml | grep -iv '^$'</span></div><div class="line">cluster.name: <span class="string">"Julend_ES-cluster"</span></div><div class="line">node.name: Julend_es2</div><div class="line">node.data: <span class="literal">true</span></div><div class="line">http.enabled: <span class="literal">true</span></div><div class="line">path.data: /data/ELK_data/elasticsearch/data</div><div class="line">path.logs: /data/ELK_data/elasticsearch/logs</div><div class="line">network.host: 0.0.0.0</div><div class="line">http.port: 9200</div><div class="line">http.cors.enabled: <span class="literal">true</span></div><div class="line">http.cors.allow-origin: <span class="string">"*"</span></div><div class="line">discovery.zen.ping.unicast.hosts: [<span class="string">"192.168.1.41"</span>, <span class="string">"192.168.1.42"</span>, <span class="string">"193.168.1.43"</span>]</div><div class="line">discovery.zen.minimum_master_nodes: 3</div><div class="line">gateway.recover_after_nodes: 2</div><div class="line">[root@ELK-test2 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Julend_es3 节点</span></div><div class="line">[root@ELK-test3 ~]<span class="comment"># grep -iv '#' /etc/elasticsearch/elasticsearch.yml | grep -iv '^$'</span></div><div class="line">cluster.name: <span class="string">"Julend_ES-cluster"</span></div><div class="line">node.name: Julend_es3</div><div class="line">node.data: <span class="literal">true</span></div><div class="line">http.enabled: <span class="literal">true</span></div><div class="line">path.data: /data/ELK_data/elasticsearch/data</div><div class="line">path.logs: /data/ELK_data/elasticsearch/logs</div><div class="line">network.host: 0.0.0.0</div><div class="line">http.port: 9200</div><div class="line">http.cors.enabled: <span class="literal">true</span></div><div class="line">http.cors.allow-origin: <span class="string">"*"</span></div><div class="line">discovery.zen.ping.unicast.hosts: [<span class="string">"192.168.1.41"</span>, <span class="string">"192.168.1.42"</span>,<span class="string">"192.168.1.43"</span>]</div><div class="line">discovery.zen.minimum_master_nodes: 3</div><div class="line">gateway.recover_after_nodes: 2</div><div class="line">[root@ELK-test3 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>参考：<a href="http://blog.csdn.net/shudaqi2010/article/details/53941389" target="_blank" rel="external">http://blog.csdn.net/shudaqi2010/article/details/53941389</a><br><a href="http://blog.chinaunix.net/uid-532511-id-4854331.html" target="_blank" rel="external">http://blog.chinaunix.net/uid-532511-id-4854331.html</a><br><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/index.html" target="_blank" rel="external">https://www.elastic.co/guide/cn/elasticsearch/guide/current/index.html</a>  </p>
<h4 id="配置-Kibana"><a href="#配置-Kibana" class="headerlink" title="配置 Kibana"></a>配置 Kibana</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#kibana只是一个WEB GUI展示工具，数据均存储在elasticsearch中，故登陆任何一台kibana看到的数据都一样</span></div><div class="line"><span class="comment">#kibana1配置：</span></div><div class="line">[root@ELK-test ~]<span class="comment"># grep -iv '#' /etc/kibana/kibana.yml | grep -iv '^$'</span></div><div class="line">server.port: 5601</div><div class="line">server.host: <span class="string">"192.168.1.41"</span></div><div class="line">server.name: <span class="string">"Julend_Kibana"</span></div><div class="line">elasticsearch.url: <span class="string">"http://192.168.1.42:9200"</span></div><div class="line">[root@ELK-test ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#kibana2配置：</span></div><div class="line">[root@ELK-test2 ~]<span class="comment"># grep -iv '#' /etc/kibana/kibana.yml | grep -iv '^$'</span></div><div class="line">server.port: 5601</div><div class="line">server.host: <span class="string">"192.168.1.42"</span></div><div class="line">elasticsearch.url: <span class="string">"http://192.168.1.42:9200"</span></div><div class="line">[root@ELK-test2 ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#kibana3配置：</span></div><div class="line">[root@ELK-test3 ~]<span class="comment"># grep -iv '#' /etc/kibana/kibana.yml | grep -iv '^$'</span></div><div class="line">server.port: 5601</div><div class="line">server.host: <span class="string">"192.168.1.43"</span></div><div class="line">elasticsearch.url: <span class="string">"http://192.168.1.43:9200"</span></div><div class="line">[root@ELK-test3 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>参考：<a href="http://blog.csdn.net/ming_311/article/details/50619859" target="_blank" rel="external">Kibana基本使用</a><br><a href="https://segmentfault.com/a/1190000002972420" target="_blank" rel="external">ELK：kibana使用的lucene查询语法</a><br><a href="http://www.ttlsa.com/elk/elk-kibana-query-and-filter/" target="_blank" rel="external">ELK kibana查询与过滤</a><br><a href="http://blog.csdn.net/caisini_vc/article/details/53377756" target="_blank" rel="external">Lucene查询语法详解（Lucene query syntax）- 用于Kibana搜索语句</a>  </p>
<h4 id="配置nginx"><a href="#配置nginx" class="headerlink" title="配置nginx"></a>配置nginx</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#nginx配置</span></div><div class="line">[root@nginx ~]<span class="comment"># cat /etc/nginx/conf.d/192.168.1.41-43.conf </span></div><div class="line">server &#123;</div><div class="line">	listen       443;</div><div class="line">	server_name  domain_name;</div><div class="line">	ssl on;</div><div class="line">	include conf.d/ssl_conf;</div><div class="line"></div><div class="line">	access_log  /var/<span class="built_in">log</span>/kibana/access.log main;</div><div class="line">	error_log /var/<span class="built_in">log</span>/kibana/error.log;</div><div class="line"></div><div class="line">	location / &#123;</div><div class="line">	auth_basic <span class="string">"Restricted"</span>;</div><div class="line">	auth_basic_user_file /etc/nginx/conf.d/.site_kibana_pass;</div><div class="line">	proxy_pass http://testelk;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">server &#123;</div><div class="line">	listen 80;</div><div class="line">	server_name domain_name;</div><div class="line">	rewrite ^/(.*)$ https://domain_name permanent;</div><div class="line">&#125;</div><div class="line"></div><div class="line">upstream domain_name &#123;</div><div class="line">	ip_hash;</div><div class="line">	server 192.168.1.41:5601 max_fails=4 fail_timeout=20s weight=4;</div><div class="line">	server 192.168.1.42:5601 max_fails=4 fail_timeout=20s weight=4;</div><div class="line">	server 192.168.1.43:5601 max_fails=4 fail_timeout=20s weight=4;</div><div class="line">&#125;</div><div class="line">[root@nginx ~]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@nginx ~]<span class="comment"># nginx -t</span></div><div class="line">[root@nginx ~]<span class="comment"># nginx -s reload</span></div></pre></td></tr></table></figure>
<h4 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@DevEVN-21 ~]<span class="comment"># systemctl enable filebeat</span></div><div class="line">[root@DevEVN-21 ~]<span class="comment"># systemctl start filebeat</span></div><div class="line"></div><div class="line">[root@ELK-test ~]<span class="comment"># /usr/share/logstash/bin/logstash --path.settings /etc/logstash/ -f /etc/logstash/conf.d/logstash_192.168.1.21.conf --path.data /data/ELK_data/logstash/data_192.168.1.21</span></div><div class="line">Sending Logstash<span class="string">'s logs to /data/ELK_data/logstash/logs which is now configured via log4j2.properties</span></div><div class="line">...</div><div class="line">[root@ELK-test ~]#</div><div class="line"></div><div class="line">#启动三台elasticsearch</div><div class="line">[root@ELK-test ~]# systemctl enable elasticsearch</div><div class="line">[root@ELK-test ~]# systemctl start elasticsearch</div><div class="line"></div><div class="line">[root@ELK-test ~]# systemctl enable kibana</div><div class="line">[root@ELK-test ~]# systemctl start kibana</div></pre></td></tr></table></figure>
<h5 id="logstash-服务启动日志"><a href="#logstash-服务启动日志" class="headerlink" title="logstash 服务启动日志"></a>logstash 服务启动日志</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># tail -f /data/ELK_data/logstash/logs/logstash-plain.log </span></div><div class="line">[2017-10-19T16:35:07,048][INFO ][logstash.outputs.elasticsearch] Running health check to see <span class="keyword">if</span> an Elasticsearch connection is working &#123;:healthcheck_url=&gt;http://localhost:9</div><div class="line">200/, :path=&gt;<span class="string">"/"</span>&#125;[2017-10-19T16:35:07,146][WARN ][logstash.outputs.elasticsearch] Restored connection to ES instance &#123;:url=&gt;<span class="string">"http://localhost:9200/"</span>&#125;</div><div class="line">[2017-10-19T16:35:07,148][INFO ][logstash.outputs.elasticsearch] Using mapping template from &#123;:path=&gt;nil&#125;</div><div class="line">[2017-10-19T16:35:07,188][INFO ][logstash.outputs.elasticsearch] Attempting to install template &#123;:manage_template=&gt;&#123;<span class="string">"template"</span>=&gt;<span class="string">"logstash-*"</span>, <span class="string">"version"</span>=&gt;50001, <span class="string">"settings"</span>=&gt;</div><div class="line">&#123;<span class="string">"index.refresh_interval"</span>=&gt;<span class="string">"5s"</span>&#125;, <span class="string">"mappings"</span>=&gt;&#123;<span class="string">"_default_"</span>=&gt;&#123;<span class="string">"_all"</span>=&gt;&#123;<span class="string">"enabled"</span>=&gt;<span class="literal">true</span>, <span class="string">"norms"</span>=&gt;<span class="literal">false</span>&#125;, <span class="string">"dynamic_templates"</span>=&gt;[&#123;<span class="string">"message_field"</span>=&gt;&#123;<span class="string">"path_match"</span>=&gt;<span class="string">"message"</span>, <span class="string">"match_mapping_type"</span>=&gt;<span class="string">"string"</span>, <span class="string">"mapping"</span>=&gt;&#123;<span class="string">"type"</span>=&gt;<span class="string">"text"</span>, <span class="string">"norms"</span>=&gt;<span class="literal">false</span>&#125;&#125;&#125;, &#123;<span class="string">"string_fields"</span>=&gt;&#123;<span class="string">"match"</span>=&gt;<span class="string">"*"</span>, <span class="string">"match_mapping_type"</span>=&gt;<span class="string">"string"</span>, <span class="string">"mapping"</span>=&gt;&#123;<span class="string">"type"</span>=&gt;<span class="string">"text"</span>, <span class="string">"norms"</span>=&gt;<span class="literal">false</span>, <span class="string">"fields"</span>=&gt;&#123;<span class="string">"keyword"</span>=&gt;&#123;<span class="string">"type"</span>=&gt;<span class="string">"keyword"</span>, <span class="string">"ignore_above"</span>=&gt;256&#125;&#125;&#125;&#125;&#125;], <span class="string">"properties"</span>=&gt;&#123;<span class="string">"@timestamp"</span>=&gt;&#123;<span class="string">"type"</span>=&gt;<span class="string">"date"</span>, <span class="string">"include_in_all"</span>=&gt;<span class="literal">false</span>&#125;, <span class="string">"@version"</span>=&gt;&#123;<span class="string">"type"</span>=&gt;<span class="string">"keyword"</span>, <span class="string">"include_in_all"</span>=&gt;<span class="literal">false</span>&#125;, <span class="string">"geoip"</span>=&gt;&#123;<span class="string">"dynamic"</span>=&gt;<span class="literal">true</span>, <span class="string">"properties"</span>=&gt;&#123;<span class="string">"ip"</span>=&gt;&#123;<span class="string">"type"</span>=&gt;<span class="string">"ip"</span>&#125;, <span class="string">"location"</span>=&gt;&#123;<span class="string">"type"</span>=&gt;<span class="string">"geo_point"</span>&#125;, <span class="string">"latitude"</span>=&gt;&#123;<span class="string">"type"</span>=&gt;<span class="string">"half_float"</span>&#125;, <span class="string">"longitude"</span>=&gt;&#123;<span class="string">"type"</span>=&gt;<span class="string">"half_float"</span>&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;[2017-10-19T16:35:07,194][INFO ][logstash.outputs.elasticsearch] New Elasticsearch output &#123;:class=&gt;<span class="string">"LogStash::Outputs::ElasticSearch"</span>, :hosts=&gt;[<span class="string">"//localhost:9200"</span>]&#125;</div><div class="line">[2017-10-19T16:35:07,197][INFO ][logstash.pipeline        ] Starting pipeline &#123;<span class="string">"id"</span>=&gt;<span class="string">"main"</span>, <span class="string">"pipeline.workers"</span>=&gt;2, <span class="string">"pipeline.batch.size"</span>=&gt;125, <span class="string">"pipeline.batch.delay"</span>=&gt;5, <span class="string">"</span></div><div class="line">pipeline.max_inflight"=&gt;250&#125;[2017-10-19T16:35:07,582][INFO ][logstash.inputs.beats    ] Beats inputs: Starting input listener &#123;:address=&gt;<span class="string">"0.0.0.0:5044"</span>&#125;</div><div class="line">[2017-10-19T16:35:07,615][INFO ][logstash.pipeline        ] Pipeline main started</div><div class="line">[2017-10-19T16:35:07,623][INFO ][org.logstash.beats.Server] Starting server on port: 5044</div><div class="line">[2017-10-19T16:35:07,702][INFO ][logstash.agent           ] Successfully started Logstash API endpoint &#123;:port=&gt;9600&#125;</div></pre></td></tr></table></figure>
<h5 id="filebeat-服务启动日志"><a href="#filebeat-服务启动日志" class="headerlink" title="filebeat 服务启动日志"></a>filebeat 服务启动日志</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">[root@DevEVN-21 ~]<span class="comment"># tail -f /var/log/filebeat/filebeat</span></div><div class="line">2017-10-19T15:29:38+08:00 INFO Prospector with previous states loaded: 1</div><div class="line">2017-10-19T15:29:38+08:00 INFO Starting prospector of <span class="built_in">type</span>: <span class="built_in">log</span>; id: 14402121705362619298 </div><div class="line">2017-10-19T15:29:38+08:00 INFO Prospector with previous states loaded: 4</div><div class="line">2017-10-19T15:29:38+08:00 INFO Starting prospector of <span class="built_in">type</span>: <span class="built_in">log</span>; id: 3085250400820318742 </div><div class="line">2017-10-19T15:29:38+08:00 INFO Prospector with previous states loaded: 10</div><div class="line">2017-10-19T15:29:38+08:00 INFO Starting prospector of <span class="built_in">type</span>: <span class="built_in">log</span>; id: 9380947956116938860 </div><div class="line">2017-10-19T15:29:38+08:00 INFO Prospector with previous states loaded: 6</div><div class="line">2017-10-19T15:29:38+08:00 INFO Starting prospector of <span class="built_in">type</span>: <span class="built_in">log</span>; id: 8452203097583608250 </div><div class="line">2017-10-19T15:29:38+08:00 INFO Loading and starting Prospectors completed. Enabled prospectors: 41</div><div class="line">2017-10-19T15:29:48+08:00 INFO Harvester started <span class="keyword">for</span> file: /data/soros/logs/soros-batch.log</div><div class="line">2017-10-19T15:29:48+08:00 INFO Harvester started <span class="keyword">for</span> file: /data/soros/logs/soros-marketing-service-error.log</div><div class="line">2017-10-19T15:29:48+08:00 INFO Harvester started <span class="keyword">for</span> file: /data/soros/logs/soros-marketing-service.log</div><div class="line">2017-10-19T15:29:48+08:00 INFO Harvester started <span class="keyword">for</span> file: /data/soros/logs/soros-order-service.log</div><div class="line">2017-10-19T15:29:58+08:00 INFO Harvester started <span class="keyword">for</span> file: /data/soros/logs/soros-pay-service.log</div><div class="line">2017-10-19T15:29:58+08:00 INFO Harvester started <span class="keyword">for</span> file: /data/soros/logs/soros-risk-service.log</div><div class="line">2017-10-19T15:30:08+08:00 INFO Non-zero metrics <span class="keyword">in</span> the last 30s: filebeat.harvester.open_files=8 filebeat.harvester.running=8 filebeat.harvester.started=8 libbeat.logstash.</div><div class="line">call_count.PublishEvents=6 libbeat.logstash.publish.read_bytes=108 libbeat.logstash.publish.write_bytes=125904 libbeat.logstash.published_and_acked_events=4469 libbeat.publisher.published_events=4469 publish.events=4535 registrar.states.current=58 registrar.states.update=4535 registrar.writes=6</div><div class="line">2017-10-19T15:30:38+08:00 INFO Non-zero metrics <span class="keyword">in</span> the last 30s: filebeat.harvester.open_files=12 filebeat.harvester.running=12 filebeat.harvester.started=12 libbeat.logsta</div><div class="line">sh.call_count.PublishEvents=7 libbeat.logstash.publish.read_bytes=54 libbeat.logstash.publish.write_bytes=127592 libbeat.logstash.published_and_acked_events=4581 libbeat.publisher.published_events=4581 publish.events=4593 registrar.states.update=4593 registrar.writes=7</div><div class="line">...</div><div class="line">[root@DevEVN-21 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h5 id="elasticsearch-服务启动日志"><a href="#elasticsearch-服务启动日志" class="headerlink" title="elasticsearch 服务启动日志"></a>elasticsearch 服务启动日志</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line">[root@ELK-test logs]<span class="comment"># tail -f  Julend_ES-cluster.log</span></div><div class="line">[2017-10-19T17:45:58,104][INFO ][o.e.n.Node               ] [Julend_es1] initializing ...</div><div class="line">[2017-10-19T17:45:58,180][INFO ][o.e.e.NodeEnvironment    ] [Julend_es1] using [1] data paths, mounts [[/data (/dev/sdb1)]], net usable_space [270.3gb], net total_space [29</div><div class="line">5.1gb], spins? [possibly], types [ext4][2017-10-19T17:45:58,180][INFO ][o.e.e.NodeEnvironment    ] [Julend_es1] heap size [1.9gb], compressed ordinary object pointers [<span class="literal">true</span>]</div><div class="line">[2017-10-19T17:45:58,857][INFO ][o.e.n.Node               ] [Julend_es1] node name [Julend_es1], node ID [mXtk8dQeQh-amui<span class="_">-d</span>5pVoA]</div><div class="line">[2017-10-19T17:45:58,857][INFO ][o.e.n.Node               ] [Julend_es1] version[5.6.1], pid[8287], build[667b497/2017-09-14T19:22:05.189Z], OS[Linux/3.10.0-514.el7.x86_64/</div><div class="line">amd64], JVM[Oracle Corporation/Java HotSpot(TM) 64-Bit Server VM/1.8.0_144/25.144-b01][2017-10-19T17:45:58,857][INFO ][o.e.n.Node               ] [Julend_es1] JVM arguments [-Xms2g, -Xmx2g, -XX:+UseConcMarkSweepGC, -XX:CMSInitiatingOccupancyFraction=75, -XX:</div><div class="line">+UseCMSInitiatingOccupancyOnly, -XX:+AlwaysPreTouch, -Xss1m, -Djava.awt.headless=<span class="literal">true</span>, -Dfile.encoding=UTF-8, -Djna.nosys=<span class="literal">true</span>, -Djdk.io.permissionsUseCanonicalPath=<span class="literal">true</span>, -Dio.netty.noUnsafe=<span class="literal">true</span>, -Dio.netty.noKeySetOptimization=<span class="literal">true</span>, -Dio.netty.recycler.maxCapacityPerThread=0, -D<span class="built_in">log</span>4j.shutdownHookEnabled=<span class="literal">false</span>, -D<span class="built_in">log</span>4j2.disable.jmx=<span class="literal">true</span>, -D<span class="built_in">log</span>4j.skipJansi=<span class="literal">true</span>, -XX:+HeapDumpOnOutOfMemoryError, -Des.path.home=/usr/share/elasticsearch][2017-10-19T17:45:59,707][INFO ][o.e.p.PluginsService     ] [Julend_es1] loaded module [aggs-matrix-stats]</div><div class="line">[2017-10-19T17:45:59,707][INFO ][o.e.p.PluginsService     ] [Julend_es1] loaded module [ingest-common]</div><div class="line">[2017-10-19T17:45:59,707][INFO ][o.e.p.PluginsService     ] [Julend_es1] loaded module [lang-expression]</div><div class="line">[2017-10-19T17:45:59,707][INFO ][o.e.p.PluginsService     ] [Julend_es1] loaded module [lang-groovy]</div><div class="line">[2017-10-19T17:45:59,707][INFO ][o.e.p.PluginsService     ] [Julend_es1] loaded module [lang-mustache]</div><div class="line">[2017-10-19T17:45:59,707][INFO ][o.e.p.PluginsService     ] [Julend_es1] loaded module [lang-painless]</div><div class="line">[2017-10-19T17:45:59,707][INFO ][o.e.p.PluginsService     ] [Julend_es1] loaded module [parent-join]</div><div class="line">[2017-10-19T17:45:59,707][INFO ][o.e.p.PluginsService     ] [Julend_es1] loaded module [percolator]</div><div class="line">[2017-10-19T17:45:59,707][INFO ][o.e.p.PluginsService     ] [Julend_es1] loaded module [reindex]</div><div class="line">[2017-10-19T17:45:59,708][INFO ][o.e.p.PluginsService     ] [Julend_es1] loaded module [transport-netty3]</div><div class="line">[2017-10-19T17:45:59,708][INFO ][o.e.p.PluginsService     ] [Julend_es1] loaded module [transport-netty4]</div><div class="line">[2017-10-19T17:45:59,708][INFO ][o.e.p.PluginsService     ] [Julend_es1] no plugins loaded</div><div class="line">[2017-10-19T17:46:01,565][INFO ][o.e.d.DiscoveryModule    ] [Julend_es1] using discovery <span class="built_in">type</span> [zen]</div><div class="line">[2017-10-19T17:46:02,716][INFO ][o.e.n.Node               ] [Julend_es1] initialized</div><div class="line">[2017-10-19T17:46:02,716][INFO ][o.e.n.Node               ] [Julend_es1] starting ...</div><div class="line">[2017-10-19T17:46:02,854][INFO ][o.e.t.TransportService   ] [Julend_es1] publish_address &#123;192.168.1.41:9300&#125;, bound_addresses &#123;[::]:9300&#125;</div><div class="line">[2017-10-19T17:46:02,863][INFO ][o.e.b.BootstrapChecks    ] [Julend_es1] bound or publishing to a non-loopback or non-link-local address, enforcing bootstrap checks</div><div class="line">[2017-10-19T17:46:05,946][WARN ][o.e.d.z.ZenDiscovery     ] [Julend_es1] failed to connect to master [&#123;Julend_es3&#125;&#123;Go1e5drSSum7gbrKpIef8g&#125;&#123;KF8fUy32Q-WhSJDBCrdVrQ&#125;&#123;192.168.1</div><div class="line">.43&#125;&#123;192.168.1.43:9300&#125;], retrying...org.elasticsearch.transport.ConnectTransportException: [Julend_es3][192.168.1.43:9300] connect_timeout[30s]</div><div class="line">	at org.elasticsearch.transport.netty4.Netty4Transport.connectToChannels(Netty4Transport.java:361) ~[?:?]</div><div class="line">	at org.elasticsearch.transport.TcpTransport.openConnection(TcpTransport.java:561) ~[elasticsearch-5.6.1.jar:5.6.1]</div><div class="line">	at org.elasticsearch.transport.TcpTransport.connectToNode(TcpTransport.java:464) ~[elasticsearch-5.6.1.jar:5.6.1]</div><div class="line">	at org.elasticsearch.transport.TransportService.connectToNode(TransportService.java:332) ~[elasticsearch-5.6.1.jar:5.6.1]</div><div class="line">	at org.elasticsearch.transport.TransportService.connectToNode(TransportService.java:319) ~[elasticsearch-5.6.1.jar:5.6.1]</div><div class="line">	at org.elasticsearch.discovery.zen.ZenDiscovery.joinElectedMaster(ZenDiscovery.java:458) [elasticsearch-5.6.1.jar:5.6.1]</div><div class="line">	at org.elasticsearch.discovery.zen.ZenDiscovery.innerJoinCluster(ZenDiscovery.java:410) [elasticsearch-5.6.1.jar:5.6.1]</div><div class="line">	at org.elasticsearch.discovery.zen.ZenDiscovery.access<span class="variable">$4100</span>(ZenDiscovery.java:82) [elasticsearch-5.6.1.jar:5.6.1]</div><div class="line">	at org.elasticsearch.discovery.zen.ZenDiscovery<span class="variable">$JoinThreadControl</span><span class="variable">$1</span>.run(ZenDiscovery.java:1188) [elasticsearch-5.6.1.jar:5.6.1]</div><div class="line">	at org.elasticsearch.common.util.concurrent.ThreadContext<span class="variable">$ContextPreservingRunnable</span>.run(ThreadContext.java:569) [elasticsearch-5.6.1.jar:5.6.1]</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_144]</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor<span class="variable">$Worker</span>.run(ThreadPoolExecutor.java:624) [?:1.8.0_144]</div><div class="line">	at java.lang.Thread.run(Thread.java:748) [?:1.8.0_144]</div><div class="line">Caused by: io.netty.channel.AbstractChannel<span class="variable">$AnnotatedConnectException</span>: Connection refused: 192.168.1.43/192.168.1.43:9300</div><div class="line">	at sun.nio.ch.SocketChannelImpl.checkConnect(Native Method) ~[?:?]</div><div class="line">	at sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:717) ~[?:?]</div><div class="line">	at io.netty.channel.socket.nio.NioSocketChannel.doFinishConnect(NioSocketChannel.java:352) ~[?:?]</div><div class="line">	at io.netty.channel.nio.AbstractNioChannel<span class="variable">$AbstractNioUnsafe</span>.finishConnect(AbstractNioChannel.java:340) ~[?:?]</div><div class="line">	at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:632) ~[?:?]</div><div class="line">	at io.netty.channel.nio.NioEventLoop.processSelectedKeysPlain(NioEventLoop.java:544) ~[?:?]</div><div class="line">	at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:498) ~[?:?]</div><div class="line">	at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:458) ~[?:?]</div><div class="line">	at io.netty.util.concurrent.SingleThreadEventExecutor<span class="variable">$5</span>.run(SingleThreadEventExecutor.java:858) ~[?:?]</div><div class="line">	... 1 more</div><div class="line">Caused by: java.net.ConnectException: Connection refused</div><div class="line">	at sun.nio.ch.SocketChannelImpl.checkConnect(Native Method) ~[?:?]</div><div class="line">	at sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:717) ~[?:?]</div><div class="line">	at io.netty.channel.socket.nio.NioSocketChannel.doFinishConnect(NioSocketChannel.java:352) ~[?:?]</div><div class="line">	at io.netty.channel.nio.AbstractNioChannel<span class="variable">$AbstractNioUnsafe</span>.finishConnect(AbstractNioChannel.java:340) ~[?:?]</div><div class="line">	at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:632) ~[?:?]</div><div class="line">	at io.netty.channel.nio.NioEventLoop.processSelectedKeysPlain(NioEventLoop.java:544) ~[?:?]</div><div class="line">	at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:498) ~[?:?]</div><div class="line">	at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:458) ~[?:?]</div><div class="line">	at io.netty.util.concurrent.SingleThreadEventExecutor<span class="variable">$5</span>.run(SingleThreadEventExecutor.java:858) ~[?:?]</div><div class="line">	... 1 more</div><div class="line">[2017-10-19T17:46:08,968][WARN ][o.e.d.z.ZenDiscovery     ] [Julend_es1] not enough master nodes discovered during pinging (found [[Candidate&#123;node=&#123;Julend_es2&#125;&#123;VQf-ph7NRTei</div><div class="line">EVHqAT4pRw&#125;&#123;v2HyA4hTT0miTzlFmi1vZg&#125;&#123;192.168.1.42&#125;&#123;192.168.1.42:9300&#125;, clusterStateVersion=-1&#125;, Candidate&#123;node=&#123;Julend_es1&#125;&#123;mXtk8dQeQh-amui<span class="_">-d</span>5pVoA&#125;&#123;1f1jfhuQQCyor5YXnm8oAg&#125;&#123;192.168.1.41&#125;&#123;192.168.1.41:9300&#125;, clusterStateVersion=-1&#125;]], but needed [3]), pinging again[2017-10-19T17:46:11,971][WARN ][o.e.d.z.ZenDiscovery     ] [Julend_es1] not enough master nodes discovered during pinging (found [[Candidate&#123;node=&#123;Julend_es2&#125;&#123;VQf-ph7NRTei</div><div class="line">EVHqAT4pRw&#125;&#123;v2HyA4hTT0miTzlFmi1vZg&#125;&#123;192.168.1.42&#125;&#123;192.168.1.42:9300&#125;, clusterStateVersion=-1&#125;, Candidate&#123;node=&#123;Julend_es1&#125;&#123;mXtk8dQeQh-amui<span class="_">-d</span>5pVoA&#125;&#123;1f1jfhuQQCyor5YXnm8oAg&#125;&#123;192.168.1.41&#125;&#123;192.168.1.41:9300&#125;, clusterStateVersion=-1&#125;]], but needed [3]), pinging again[2017-10-19T17:46:15,025][INFO ][o.e.c.s.ClusterService   ] [Julend_es1] detected_master &#123;Julend_es3&#125;&#123;Go1e5drSSum7gbrKpIef8g&#125;&#123;60Fb2YJZQ0Ct2uL7PcsuRQ&#125;&#123;192.168.1.43&#125;&#123;192.168.</div><div class="line">1.43:9300&#125;, added &#123;&#123;Julend_es2&#125;&#123;VQf-ph7NRTeiEVHqAT4pRw&#125;&#123;v2HyA4hTT0miTzlFmi1vZg&#125;&#123;192.168.1.42&#125;&#123;192.168.1.42:9300&#125;,&#123;Julend_es3&#125;&#123;Go1e5drSSum7gbrKpIef8g&#125;&#123;60Fb2YJZQ0Ct2uL7PcsuRQ&#125;&#123;192.168.1.43&#125;&#123;192.168.1.43:9300&#125;,&#125;, reason: zen-disco-receive(from master [master &#123;Julend_es3&#125;&#123;Go1e5drSSum7gbrKpIef8g&#125;&#123;60Fb2YJZQ0Ct2uL7PcsuRQ&#125;&#123;192.168.1.43&#125;&#123;192.168.1.43:9300&#125; committed version [1]])[2017-10-19T17:46:15,056][INFO ][o.e.h.n.Netty4HttpServerTransport] [Julend_es1] publish_address &#123;192.168.1.41:9200&#125;, bound_addresses &#123;[::]:9200&#125;</div><div class="line">[2017-10-19T17:46:15,056][INFO ][o.e.n.Node               ] [Julend_es1] started</div><div class="line">...</div><div class="line">[root@ELK-test logs]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h4 id="查看-elasticsearch-集群状态"><a href="#查看-elasticsearch-集群状态" class="headerlink" title="查看 elasticsearch 集群状态"></a>查看 elasticsearch 集群状态</h4><h5 id="获取集群中节点列表"><a href="#获取集群中节点列表" class="headerlink" title="获取集群中节点列表"></a>获取集群中节点列表</h5><p><code>curl &#39;localhost:9200/_cat/nodes?v&#39;</code><br><img src="http://note.youdao.com/yws/api/personal/file/329B6F6EA752494CB4C4D6031C77B479?method=download&amp;shareKey=a3fee6f200f0e9d1d5f6382d823d4748" alt="获取集群中节点列表">  </p>
<h5 id="集群健康检查"><a href="#集群健康检查" class="headerlink" title="集群健康检查"></a>集群健康检查</h5><p><code>curl &#39;localhost:9200/_cat/health?v&#39;</code><br><img src="http://note.youdao.com/yws/api/personal/file/61C65EEE2B034AD09FC4AF4CF3DC3C12?method=download&amp;shareKey=b3bb5668a73fdb35647afed00419fd10" alt="集群健康检查">  </p>
<h5 id="获取ElasticSearch索引"><a href="#获取ElasticSearch索引" class="headerlink" title="获取ElasticSearch索引"></a>获取ElasticSearch索引</h5><p><code>curl &#39;localhost:9200/_cat/indices?v&#39;</code><br><img src="http://note.youdao.com/yws/api/personal/file/E862D2654364496E8474E7F44E5F09A4?method=download&amp;shareKey=6b9d3f0297cc80f23b43479a6c8a9841" alt="获取ElasticSearch索引"> </p>
<h5 id="本机节点查询"><a href="#本机节点查询" class="headerlink" title="本机节点查询"></a>本机节点查询</h5><p><code>curl -XGET &#39;localhost:9200/_nodes/_local?pretty&#39;</code><br><img src="http://note.youdao.com/yws/api/personal/file/7986E5063E69469C9C77699A37CE0244?method=download&amp;shareKey=ed6aa6f801cc993ccfd70b443772637a" alt="本机节点查询1">  </p>
<p><code>curl -XGET &#39;localhost:9200/_nodes/_local/network?pretty&#39;</code><br><img src="http://note.youdao.com/yws/api/personal/file/0E9EBB54EC8D43B7A4014DA31E70ADDE?method=download&amp;shareKey=4c3db04e15fe968eb9e9cb288a4a0069" alt="本机节点查询2">  </p>
<h5 id="节点状态"><a href="#节点状态" class="headerlink" title="节点状态"></a>节点状态</h5><p><code>curl -XGET &#39;http://localhost:9200/_nodes/stats?pretty&#39;</code><br><img src="http://note.youdao.com/yws/api/personal/file/99AAAE558FE74153914FA78F844400F9?method=download&amp;shareKey=7b22a74b7e6c7226be128574a3af75a9" alt="节点状态1">  </p>
<p><code>curl -XGET &#39;http://localhost:9200/_nodes/stats/os,process?pretty&#39;</code><br><img src="http://note.youdao.com/yws/api/personal/file/C9B6B407B93E4214B63331975EB47EF6?method=download&amp;shareKey=298f0b1e82cc9785fb9e321199bf6909" alt="节点状态2">  </p>
<p><code>curl -XGET &#39;http://localhost:9200/_nodes?pretty&#39;</code><br><img src="http://note.youdao.com/yws/api/personal/file/BB22940B585B4F90BFB2F8349A39B9FA?method=download&amp;shareKey=76c793558852d58d72fca64d37eec706" alt="节点状态3">  </p>
<p><code>curl -XGET &#39;http://localhost:9200/_nodes/process?pretty&#39;</code><br><img src="http://note.youdao.com/yws/api/personal/file/C29147AE73D345D8B50926CB00B4AF29?method=download&amp;shareKey=d32513c28c63fa9658abde8da2bde251" alt="节点状态4">  </p>
<p><code>curl -XGET &#39;http://localhost:9200/_nodes/os?pretty&#39;</code><br><img src="http://note.youdao.com/yws/api/personal/file/C7B4C4CFCCBB41C4AF799CAFE771E370?method=download&amp;shareKey=8aceb129875e52c7a00cc1b2457dabf7" alt="节点状态5">  </p>
<p><code>curl -XGET &#39;http://localhost:9200/_nodes/settings?pretty&#39;</code><br><img src="http://note.youdao.com/yws/api/personal/file/397DF0BEC4D94209B69D023C581406CA?method=download&amp;shareKey=5b2675affc9e3956f9a45fae3b45de59" alt="节点状态6">  </p>
<h5 id="获取集群健康状况"><a href="#获取集群健康状况" class="headerlink" title="获取集群健康状况"></a>获取集群健康状况</h5><p><code>curl -XGET &#39;http://localhost:9200/_cluster/health?pretty=true&#39;</code><br><img src="http://note.youdao.com/yws/api/personal/file/45011E4E313142FAB9881CB9A5C6EF25?method=download&amp;shareKey=a37a6a50b678ebc5263086dd4c695d79" alt="获取集群健康状况">  </p>
<h5 id="集群状态"><a href="#集群状态" class="headerlink" title="集群状态"></a>集群状态</h5><p><code>curl -XGET &#39;http://localhost:9200/_cluster/state?pretty&#39;</code><br><img src="http://note.youdao.com/yws/api/personal/file/002F39A9F6CC407A87CE90BEB23C2039?method=download&amp;shareKey=f406f9dad95986261270cd10be864e58" alt="集群状态1">  </p>
<p><code>curl -XGET &#39;http://localhost:9200/_cluster/stats?human&amp;pretty&#39;</code><br><img src="http://note.youdao.com/yws/api/personal/file/63BC83C64A7242F88E43DA5BAA384F58?method=download&amp;shareKey=617d72ec5682fe56ad7d59b591abc205" alt="集群状态2">  </p>
<p>详细参考：<a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/cluster-nodes-stats.html" target="_blank" rel="external">http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/cluster-nodes-stats.html</a><br><a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/cluster-nodes-info.html" target="_blank" rel="external">http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/cluster-nodes-info.html</a>  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@ELK-test ~]<span class="comment"># ls /data/ELK_data/elasticsearch/logs/</span></div><div class="line">Julend_ES-cluster-2017-10-17.log  Julend_ES-cluster_deprecation.log             Julend_ES-cluster_index_search_slowlog.log</div><div class="line">Julend_ES-cluster-2017-10-18.log  Julend_ES-cluster_index_indexing_slowlog.log  Julend_ES-cluster.log</div><div class="line">[root@ELK-test ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>elasticsearch-head安装略  </p>
<p>第三个elasticsearch节点（之前有两个）加入到elasticsearch集群后，前两个elasticsearch节点会自动迁移同步数据到第三个节点<br>elasticsearch集群开始同步<br><img src="http://note.youdao.com/yws/api/personal/file/09534A80B39F4F178B3187517DAFA898?method=download&amp;shareKey=ce322eed4929d14ee88d4c92b950b364" alt="elasticsearch_cluster_status">  </p>
<p>elasticsearch集群同步完成后，各个elasticsearch节点几乎均匀分布，允许宕机一个节点<br><img src="http://note.youdao.com/yws/api/personal/file/B40C211E50634D648CF82E54B2FCD109?method=download&amp;shareKey=00425374d1c0425cbc224b1524ea90bf" alt="elasticsearch_cluster_status">  </p>
<h5 id="kibana-状态"><a href="#kibana-状态" class="headerlink" title="kibana 状态"></a>kibana 状态</h5><p><img src="http://note.youdao.com/yws/api/personal/file/26933567953E40EE8F284794F1CB78FC?method=download&amp;shareKey=56d001acd84646148ad4c51112103c24" alt="kibana">  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/644A2A5A28A24FE1B20C5ABFD27A9CDD?method=download&amp;shareKey=3251ff9b6046a236ff91f6e157e9ad41" alt="nginx+kibana">  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/11/04/部署FileBeat-logstash-elasticsearch集群-kibana/">http://www.yfshare.vip/2017/11/04/部署FileBeat-logstash-elasticsearch集群-kibana/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ELK由Elasticsearch、Logstash和Kibana三部分组件组成，这里新增了一个FileBeat，它是一个轻量级的日志收集处理工具(Agent)，Filebeat占用资源少，适合于在各个服务器上搜集日志后传输给Logstash，官方也推荐此工具&lt;br&gt;
    
    </summary>
    
      <category term="ELK" scheme="http://www.yfshare.vip/categories/ELK/"/>
    
    
      <category term="Elasticsearch" scheme="http://www.yfshare.vip/tags/Elasticsearch/"/>
    
      <category term="Logstash" scheme="http://www.yfshare.vip/tags/Logstash/"/>
    
      <category term="Kibana" scheme="http://www.yfshare.vip/tags/Kibana/"/>
    
      <category term="Filebeat" scheme="http://www.yfshare.vip/tags/Filebeat/"/>
    
      <category term="Elasticsearch Cluster" scheme="http://www.yfshare.vip/tags/Elasticsearch-Cluster/"/>
    
  </entry>
  
  <entry>
    <title>Elasticsearch原理</title>
    <link href="http://www.yfshare.vip/2017/11/02/Elasticsearch%E5%8E%9F%E7%90%86/"/>
    <id>http://www.yfshare.vip/2017/11/02/Elasticsearch原理/</id>
    <published>2017-11-02T12:43:22.000Z</published>
    <updated>2017-11-02T12:46:05.303Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/APlayer.min.js"> </script><script src="/assets/js/DPlayer.min.js"> </script><p>Elasticsearch原理<br><a id="more"></a></p>
<h3 id="动态更新的Lucene索引"><a href="#动态更新的Lucene索引" class="headerlink" title="动态更新的Lucene索引"></a>动态更新的Lucene索引</h3><p>Lucene处理方法，新收到的数据写到新文件里<br>Lucene把每次生成的倒排索引，叫做一个段（segment）。使用一个commit文件记录索引内所有的段，生产的segment的数据来源则是放在内存的buffer  </p>
<ol>
<li>当前索引有3个segment可用</li>
<li>新接收的数据进入内存buffer</li>
<li>内存buffer刷到磁盘，生成一个新的segment，commit文件同步更新<br><img src="http://note.youdao.com/yws/api/personal/file/E0FB3DE0ED34483699E2FD08AF8B07AA?method=download&amp;shareKey=4e8edcbd0741fefc8a26222648236865" alt="动态更新的Lucene索引">  </li>
</ol>
<h3 id="利用磁盘缓存实现的准实时检索"><a href="#利用磁盘缓存实现的准实时检索" class="headerlink" title="利用磁盘缓存实现的准实时检索"></a>利用磁盘缓存实现的准实时检索</h3><p>相对来说，磁盘处理速度很慢，因此在上述第三步中还存在一个中间状态  </p>
<ol>
<li>内存buffer生成一个新的segment，刷新到文件系统缓存中，Lucene即可检索这个新的segment</li>
<li>文件系统缓存真正同步到磁盘，commit文件更新<br>这一步刷新到文件系统缓存的步骤，在Elasticsearch中默认是1秒间隔，对于大部分应用来说，几乎是实时可搜索了。Elasticsearch也提供了单独的<code>/_refresh</code>接口，用户如果不满意，可以主动调整<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#加大refresh_interval参数</span></div><div class="line"><span class="comment"># curl -XPOST http://localhost:9200/192.168.1.24-weixin_log-2017.10.28/_settings -d '</span></div><div class="line">&#123; <span class="string">"refresh_interval"</span>: <span class="string">"10s"</span> &#125;</div><div class="line"><span class="string">'</span></div></pre></td></tr></table></figure>
</li>
</ol>
<p>如果导入的是历史数据，可以关闭<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPOST http://localhost:9200/192.168.1.24-weixin_log-2017.10.28 -d '</span></div><div class="line">&#123;</div><div class="line">    <span class="string">"settings"</span>: &#123;</div><div class="line">        <span class="string">"refresh_interval"</span>: <span class="string">"-1"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="string">'</span></div></pre></td></tr></table></figure></p>
<p>在导入完成后，修改回原来的值或者手动调用一次<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPOST http://localhost:9200/192.168.1.24-weixin_log-2017.10.27/_refresh?pretty=true</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"_shards"</span> : &#123;</div><div class="line">    <span class="string">"total"</span> : 10,</div><div class="line">    <span class="string">"successful"</span> : 10,</div><div class="line">    <span class="string">"failed"</span> : 0</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/FD45A9D1BDDF4D92BFFBA09E04872591?method=download&amp;shareKey=735c6c6ebf035d8836ec5d827aa7e7fc" alt="利用磁盘缓存实现的准实时检索">  </p>
<h3 id="translog-提供的磁盘同步控制"><a href="#translog-提供的磁盘同步控制" class="headerlink" title="translog 提供的磁盘同步控制"></a>translog 提供的磁盘同步控制</h3><p>Elasticsearch在把数据写入到内存buffer时，还记录了一个translog的日志，来保证期间发生主机错误、硬件故障等异常情况时数据不会丢失<br>如果在这期间发生异常，Elasticsearch会从 commit 位置开始恢复整个translog文件中的记录<br><img src="http://note.youdao.com/yws/api/personal/file/6F91BABFB8B44FA2878D7FC4DF36EA8C?method=download&amp;shareKey=b5b3bb7b92596d736f0e8eb4b0b99079" alt="translog提供的磁盘同步控制"><br>等到真正把segment刷到磁盘，且commit 文件进行更新的时候，translog文件才清空，这一步叫flush。Elasticsearch也提供了<code>/_flush</code>接口<br>Elasticsearch默认设置为每30分钟主动执行一次flush，或者当translog文件大于512M时，两者分别可以通过<code>index.translog.flush_threshold_period</code>和<code>index.translog.flush_threshold_size</code>参数控制，Elasticsearch还可以通过<code>index.translog.flush_threshold_ops</code>参数设置每收到多少条数据后flush一次  </p>
<p>默认情况下，Elasticsearch每5秒，或每次请求操作结束前，会强制刷新 translog日志到磁盘。为了保证不丢数据 ，每次index、bulk、delete、update完成时，一定会触发新translog到磁盘，才给请求返回200 OK。这个改变提供数据安全性的同时降低了一点性能<br>可以在index template里设置如下参数来控制<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"index.translog.durability"</span>: <span class="string">"async"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="segment-merge的影响"><a href="#segment-merge的影响" class="headerlink" title="segment merge的影响"></a>segment merge的影响</h3><p>从前面看Lucene会写很多“新文件”，但这样会给服务器带来很大的负荷，每个文件都需要文件句柄，内存，CPU等各种资源，磁盘inode也有限<br>Elasticsearch通过segment merge操作将很多零散的segment做数据归并。这个过程有独立的线程来操作，并不影响新的segment的产生<br>当归并完成后，较大的segment刷到磁盘，commit文件做出相应变更，删除前面小的segment<br><img src="http://note.youdao.com/yws/api/personal/file/288CB47874D84FE5B4924D1DF06CA3A0?method=download&amp;shareKey=5cef29dfcfb7b1ed2d76c44fbe5da40d" alt="segment merge">  </p>
<p>并归线程配置<br>segment归并过程中，需要读取segment，归并计算，再写新的segment，最后还要保存到磁盘。此过程非常消耗磁盘I/O和CPU的任务。所以，Elasticsearch提供了对归并线程的限速机制，要确保这个任务不会影响到其他的任务<br>归并线程的限速配置<code>indices.store.throttle.max_bytes_per_sec</code>在Elasticsearch 5.0默认是10240MB，使用了Lucene CMS（ConcurrentMergeScheduler）的auto throttle机制，正常情况下不需要手动配置。配置参数如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPUT http://localhost:9200/_cluster/settings -d '</span></div><div class="line">&#123;</div><div class="line">        <span class="string">"persistent"</span>: &#123;</div><div class="line">            <span class="string">"indices.store.throttle.max_bytes_per_sec"</span>: <span class="string">"100mb"</span></div><div class="line">        &#125;</div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure></p>
<p>归并线程数目，Elasticsearch也通过计算公式控制：Math.min(3,Runtime.getRuntime().availableProcessors()/2)。即服务器CPU核数的一半大于3时，启用3个归并线程，否则启动跟CPU核数的一半相等的线程数。如果确定磁盘I/O不够，可以降低<code>index.merge.schedule.max_thread_count</code>配置修改  </p>
<p>归并策略主要有以下几条：  </p>
<ul>
<li><code>index.merge.policy.floor_segment</code> 默认2MB，小于这个值得segment优先被归并</li>
<li><code>index.merge.policy.max_merge_at_once</code> 默认一次归并10个segment</li>
<li><code>index.merge.policy.max_merge_at_once_explicit</code> 默认forcemerge时一次最多归并30个segment</li>
<li><code>index.merge.policy.max_merged_segment</code> 默认是5G，大于这个值得segment，不用参与归并，optimize除外</li>
</ul>
<p>forcemerge接口<br>segment最大为5G，也会存在很多的segment，但因归并任务太消耗资源，所以一般不选择加大<code>index.merge.policy.max_merged_segment</code>配置，而在较低负荷时间段，通过forcemerge接口，强行归并segment<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPOST http://localhost:9200/192.168.1.24-weixin_log-2017.10.28/_forcemerge?max_num_segments=1</span></div><div class="line">&#123;<span class="string">"_shards"</span>:&#123;<span class="string">"total"</span>:10,<span class="string">"successful"</span>:10,<span class="string">"failed"</span>:0&#125;&#125;</div></pre></td></tr></table></figure></p>
<p>forcemerge线程消耗服务器资源比普通的归并线程还大，所以不要在写入数据的热索引执行这个操作，一般索引都是按天分割的  </p>
<h3 id="routing-和-replica的读写过程"><a href="#routing-和-replica的读写过程" class="headerlink" title="routing 和 replica的读写过程"></a>routing 和 replica的读写过程</h3><p>在Elasticsearch分布层面上，当一个Elasticsearch节点收到一条数据的请求时，通过以下方式来确认数据应该存储到哪个分片的  </p>
<ol>
<li>路由计算<br>Elasticsearch没有额外的依赖，对任意一条数据计算其对应分片的方式如下  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">shard = <span class="built_in">hash</span>(routing) % number_of_primary_shards</div></pre></td></tr></table></figure>
</li>
</ol>
<p>每个数据都有一个routing参数，默认情况下，使用其<code>_id</code>值。将其<code>_id</code>值哈希计算后，对索引的主分片数取余，就是数据实际应该存储到的分片ID。<br>由于取余这种计算方式，完全依赖分母，所以不能修改索引的主分片数。一旦主分片数不一样，所有数据的存储位置计算结果都会改变，索引数据将完全不可读。  </p>
<p>副本一致性<br>数据副本是分布式系统的一个标配。数据流程如下：<br><img src="http://note.youdao.com/yws/api/personal/file/BA7FE1FF0D25420BB14CA1D7EEC67193?method=download&amp;shareKey=ac023a5a0bed3c9485219979e64ef9e3" alt="数据写入流程">  </p>
<ol>
<li>客户端请求发送给node1节点，图中node1为master节点</li>
<li>node1用数据的<code>id_</code>取余计算得到应该将数据存储到share0上，通过cluster state信息发现share0的主分片已经分配到node3上，node1将请求数据给node3  </li>
<li>node3完成请求数据的索引过程，存入主分片0，然后并行转发数据给分配由shard0的副本分片的node1和node2。当收到任一节点汇报副本分片数据写入成功，node3即返回给初始的接收节点node1，宣布数据写入成功。node1返回成功响应给客户端<br>下面几个参数可以控制这个过程：  </li>
</ol>
<ul>
<li><code>wait_for_active_shards</code>: 两个副本只要有一个成功，就返回给客户端，默认值计算如下<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">int((primary + number_of_replicas)/2 ) +1</div></pre></td></tr></table></figure>
</li>
</ul>
<p>该参数通过<code>index.write.wait_for_active_shards</code>在索引级别设置，也可以根据需要单个写入请求上作为参数使用，设置成为1仅写完主分片就返回；设置为all，表示等所有副本分片都写入完成才返回，还可以设置为介于1和<code>number_of_replicas +1</code>之间的值  </p>
<ul>
<li><code>timeout</code>: 如果集群出现异常，有些分片不可用，Elasticsearch会等待1分钟确认分片是否正常，可以用<code>?timeout=30s</code>参数来缩短这个等待的时间<br>副本配置和分片配置不一样，可以随时调整。有些较大的索引，甚至可以在做<code>optimize</code>前，先把副本全部取消，等<code>optimize</code>完成后，在重新开启副本，节约单个segment的重复归并消耗  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPUT http://localhost:9200/192.168.1.24-weixin_log-2017.10.28/_settings -d '</span></div><div class="line">&#123;</div><div class="line">    <span class="string">"index"</span>: &#123; <span class="string">"number_of_replicas"</span>: 0 &#125;</div><div class="line">&#125;</div><div class="line"><span class="string">'</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="shard-的-allocate-控制"><a href="#shard-的-allocate-控制" class="headerlink" title="shard 的 allocate 控制"></a>shard 的 allocate 控制</h3><p>Elasticsearch由以下策略来决定某个shard分配在哪个节点，是由Elasticsearch自行决定的  </p>
<ul>
<li>新索引的生成</li>
<li>索引的删除</li>
<li>新增副本分片</li>
<li>节点增减引发的数据平衡</li>
</ul>
<p>Elasticsearch控制这部分逻辑的参数如下：  </p>
<ul>
<li><code>cluster.routing.allocation.enable</code> 参数用来控制允许分配哪种分片。默认是all。可选项包含<code>primaries</code> 和<code>new_primaries</code>。<code>none</code>则彻底拒绝分片</li>
<li><code>cluster.routing.allocation.allow_rebalance</code> 参数用来控制什么时候允许数据平衡。默认是<code>indices_all_active</code>，即要求所有分片都正常启用以后，才可以进行数据平衡操作，否则在集群重启阶段，会浪费很多流量</li>
<li><code>cluster.routing.allocation.cluster_concurrent_rebalance</code> 参数用来控制集群内同时运行的数据均衡任务个数。默认是2个，如果有节点增减，且集群负载压力不高的情况下，可以适当加大</li>
<li><code>cluster.routing.allocation.node_initial_primaries_recoveries</code> 参数用来控制节点重启时，允许同时恢复几个主分片。默认是4个，如果节点是多磁盘，且I/O压力不大，可以适当增加</li>
<li><code>cluster.routing.allocation.node_concurrent_recoveries</code> 参数用来控制节点除了主分片重启恢复以外其他情况下，允许同时运行的数据恢复任务。默认是2个。所以，节点重启时，可以看到主分片通过本地恢复迅速完成，副分片通过网络复制的恢复却很慢，并发线程本身也减少了一半。在Elasticsearch 1.6后，冷索引的副本分片也可以本地恢复，可以适当加大</li>
<li><code>indices.recovery.concurrent_streams</code> 参数用来控制节点从网络复制恢复副本分片时的数据流个数。默认是3个，可以配合上一条配置一起加大  </li>
<li><code>indices.recovery.max_bytes_per_sec</code> 参数用来控制节点恢复时的速率。默认是 40MB</li>
</ul>
<p>运维人员较常见的策略有2种：  </p>
<ul>
<li><p>磁盘限额，为了保护节点数据安全。Elasticsearch会定时（<code>cluster.info.update.interval</code>默认为30秒）检查一下各节点的数据目录磁盘使用情况。在达到<code>cluster.routing.allocation.disk.watermark.low</code>（默认85%）的时候，新索引分片就不会再分配到这个节点上了。在达到<code>cluster.routing.allocation.disk.watermark.high</code>（默认90%）的时候就会触发该节点现存分片的数据平衡，把数据挪到其他节点上去。这两个值可以写成百分比或者具体字节数。可以适当修改参数配置：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPUT http://localhost:9200/_cluster/settings -d '&#123;</span></div><div class="line"><span class="string">"transient"</span>: &#123;</div><div class="line">    <span class="string">"cluster.routing.allocation.disk.watermark.low"</span>: <span class="string">"85%"</span>,</div><div class="line">    <span class="string">"cluster.routing.allocation.disk.watermark.high"</span>: <span class="string">"10gb"</span>,</div><div class="line">    <span class="string">"cluster.info.update.interval"</span>: <span class="string">"1m"</span></div><div class="line">&#125;</div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure>
</li>
<li><p>热索引分片不均。默认情况下，Elasticsearch集群的数据均衡策略是以各节点的分片总数（<code>indices_all_active</code>）作为基准的。可以提高均衡搜索压力。一般压力集群中在新索引的数据写入方面，正常运行时，没有问题的。但当集群扩容时，新加入集群的节点，分片总数远低于其他节点，如果有新的索引创建，Elasticsearch的默认策略会导致新索引的所有主分片几乎全部分配到这个新节点上。整个集群的写入压力全部在这个节点上，可以会导致这个节点出现异常，集群出现异常。<br>在ELK环境中，需要预先计算好索引的分片数，配置好单节点的分片限额。比如：一个5节点的集群，索引主分片10个，副本1个，则平均下来每个节点应该有4个分片，则应配置为：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPUT http://localhost:9200/192.168.1.24-weixin_log-2017.10.28/_settings -d '&#123;</span></div><div class="line">    <span class="string">"index"</span>: &#123; <span class="string">"routing.allocation.total_shards_per_node"</span>: <span class="string">"5"</span> &#125;</div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>这里配置的是5而不是4，需要预防有机器故障，分片发生迁移失败的情况  </p>
<p>Elasticsearch中有一系列参数互相影响，最终联合决定分片分配：  </p>
<ul>
<li><code>cluster.routing.allocation.balance.shard</code> 节点上分配分片的权重，默认值为 0.45。 数值越大越倾向于在节点层面均衡分片  </li>
<li><code>cluster.routing.allocation.balance.index</code> 每个索引往单个节点上分配分片的权重，默认值为0.55。 数值越大越倾向于在索引层面均衡分片</li>
<li><code>cluster.routing.allocation.balance.threshold</code> 大于阈值则触发均衡操作。默认值为1。 Elasticsearch计算方法是：<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(indexBalance (node.numShards(index) - avgShardsPerNode(index)) + shardBalance (node.numShards() - avgShardsPerNode)) &lt;=&gt; weightthreshold</div></pre></td></tr></table></figure>
</li>
</ul>
<p>所以，也可以采取加大<code>cluster.routing.allocation.balance.index</code>的措施，甚至设置<code>cluster.routing.allocation.balance.shard</code> 为0来尽量采用索引内的节点均衡  </p>
<h3 id="reroute-接口"><a href="#reroute-接口" class="headerlink" title="reroute 接口"></a>reroute 接口</h3><p>上述都是从策略层面控制分片的选择，在必要的时候可以通过Elasticsearch的<code>reroute</code>接口，手动完成对分片的分配选择的控制<br>reroute接口支持三种指令：<code>allocate</code>、<code>move</code>、<code>cancel</code>，常用的是<code>allocate</code>和<code>move</code>  </p>
<ul>
<li><code>allocate</code>指令：因为负载过高等原因，有时候个别分片长期处于<code>UNASSIGNED</code>状态，可以手动分配分片到指定节点上。默认情况下只允许手动分配副本分片，所以如果是主分片故障，需要单独加一个<code>allow_primary</code>选项  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPOST http://localhost:9200/_cluster/reroute -d '&#123;</span></div><div class="line"><span class="string">"commands"</span>: [&#123;</div><div class="line">    <span class="string">"allocate"</span>: &#123;</div><div class="line">        <span class="string">"index"</span>: <span class="string">"192.168.1.24-weixin_log-2017.10.28"</span>, <span class="string">"shard"</span>: 61, <span class="string">"node"</span>: <span class="string">"192.168.1.42"</span>, <span class="string">"allow_primary"</span>: <span class="literal">true</span></div><div class="line">    &#125;</div><div class="line">    &#125;]</div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>注：如果是历史数据的话，需要提前确认哪个节点上保留有这个分片的实际目录，且目录大小最大。然后手动分片到这个节点上，以此减少数据丢失。  </p>
<ul>
<li><code>move</code>指令： 因负载过高，磁盘利用率过高，服务器下线，更换磁盘等原因，可能会需要从节点上移走部分分片<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPOST http://localhost:9200/_cluster/reroute -d '&#123;</span></div><div class="line"><span class="string">"command"</span>: [&#123;</div><div class="line">    <span class="string">"move"</span>: &#123;</div><div class="line">        <span class="string">"index"</span>: <span class="string">"192.168.1.24-weixin_log-2017.10.28"</span>, <span class="string">"shard"</span>: 0, <span class="string">"from_node"</span>: <span class="string">"192.168.1.43"</span>, <span class="string">"to_node"</span>: <span class="string">"192.168.1.42"</span></div><div class="line">    &#125;</div><div class="line">    &#125;]</div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>如果自己手动reroute失败，Elasticsearch返回的响应中会带上失败的原因。从Elasticsearch 5.0开始，新增了一个<code>allocation explain</code>接口，用来解释指定分片的具体失败原因<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XGET 'http://localhost:9200/_cluster/allocation/explain' -d '&#123;</span></div><div class="line"><span class="string">"index"</span>: <span class="string">"192.168.1.24-weixin_log-2017.10.28"</span>,</div><div class="line"><span class="string">"shard"</span>: 0,</div><div class="line"><span class="string">"primary"</span>: <span class="literal">false</span></div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure></p>
<p>得到的响应如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"shard"</span>: &#123;</div><div class="line">        <span class="string">"index"</span>: <span class="string">"192.168.1.24-weixin_log-2017.10.28"</span>,</div><div class="line">        <span class="string">"index_uuid"</span>: <span class="string">"KnW0-zELRs6PK8410r38ZA"</span>,</div><div class="line">        <span class="string">"id"</span>: 0,</div><div class="line">        <span class="string">"primary"</span>: <span class="literal">false</span></div><div class="line">    &#125;,</div><div class="line">    <span class="string">"assigned"</span>: <span class="literal">false</span>,</div><div class="line">    <span class="string">"shard_state_fetch_pending"</span>: <span class="literal">false</span>,</div><div class="line">    <span class="string">"unassigned_info"</span>: &#123;</div><div class="line">        <span class="string">"reason"</span>: <span class="string">"INDEX_CREATED"</span>,</div><div class="line">        <span class="string">"at"</span>: <span class="string">"2017-10-28T20:04:23.620Z"</span></div><div class="line">    &#125;,</div><div class="line">    <span class="string">"allocation_delay_ms"</span>: 0,</div><div class="line">    <span class="string">"remaining_delay_ms"</span>: 0,</div><div class="line">    <span class="string">"nodes"</span>: &#123;</div><div class="line">        <span class="string">"V-Spi0AyRZ6ZvKbaI3691w"</span>: &#123;</div><div class="line">            <span class="string">"node_name"</span>: <span class="string">"H5dfFeA"</span>,</div><div class="line">            <span class="string">"node_attributes"</span>: &#123;</div><div class="line">                <span class="string">"bar"</span>: <span class="string">"baz"</span></div><div class="line">            &#125;,</div><div class="line">            <span class="string">"store"</span>: &#123;</div><div class="line">                <span class="string">"shard_copy"</span>: <span class="string">"NONE"</span></div><div class="line">            &#125;,</div><div class="line">            <span class="string">"final_decision"</span>: <span class="string">"NO"</span>,</div><div class="line">            <span class="string">"final_explanation"</span>: <span class="string">"the shard cannot be assigned because one or more allocation decider returns a 'NO' decision"</span>,</div><div class="line">            <span class="string">"weight"</span>: 0.06666675,</div><div class="line">            <span class="string">"decisions"</span>: [&#123;</div><div class="line">                <span class="string">"decider"</span>: <span class="string">"filter"</span>,</div><div class="line">                <span class="string">"decision"</span>: <span class="string">"NO"</span>,</div><div class="line">                <span class="string">"explanation"</span>: <span class="string">"node does not match index include filters [foo:\"bar\"]"</span></div><div class="line">                &#125;]</div><div class="line">            &#125;,</div><div class="line">            <span class="string">"Qc6VL8c5RWaw1qXZ0Rg57g"</span>: &#123;</div><div class="line">                ...</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>这是一段很长的JSON字符，会把集群里所有节点都列上来，挨个解释为什么不能分配到这个节点上  </p>
<h3 id="节点下线（迁移）"><a href="#节点下线（迁移）" class="headerlink" title="节点下线（迁移）"></a>节点下线（迁移）</h3><p>集群中个别节点出现故障预警，也是在Elasticsearch运维工作中常见的情况。如果已经稳定运行了一段时间的集群，每个节点上都保存有数量不少的分片，这时通过 reroute接口手动转移就太麻烦了，可以采取另一种方式：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPUT http://localhost:9200/_cluster/settings -d '&#123;</span></div><div class="line"><span class="string">"transient"</span>: &#123;</div><div class="line">    <span class="string">"cluster.routing.allocation.exclude._ip"</span>: <span class="string">"192.168.1.43"</span></div><div class="line">&#125;</div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure></p>
<p>Elasticsearch就会把这个IP节点上的所有分片，都自动转移到其他的节点上。等转移完成后，这个节点就可以毫无影响的下线了<br>和<code>_ip</code>类似的参数还有<code>_host</code>，<code>_name</code>等。这类参数不仅仅是cluster级别，也可以是index级别  </p>
<h3 id="冷热数据的读写分离"><a href="#冷热数据的读写分离" class="headerlink" title="冷热数据的读写分离"></a>冷热数据的读写分离</h3><p>实施步骤如下：  </p>
<ol>
<li>N台机器做热数据的存储，上面只放当天的数据。这N台数据节点上面的elasticsearch.yml中配置<code>node.tag: host</code></li>
<li>之前的数据放在另外的M台机器上，这M台机器冷数据节点中配置<code>node.tag: stale</code></li>
<li><p>模版中控制对新建索引添加<code>hot</code>标签：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"order"</span>: 0,</div><div class="line">    <span class="string">"template"</span>: <span class="string">"*"</span>,</div><div class="line">    <span class="string">"settings"</span>: &#123;</div><div class="line">        <span class="string">"index.routing.allocation.require.tag"</span>: <span class="string">"hot"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>每天计划任务更新索引的配置，将<code>tag</code>更变为<code>stale</code>，索引会自动迁移到M台冷数据节点  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPUT http://localhost:9200/indexname/_settings -d '</span></div><div class="line">&#123;</div><div class="line">    <span class="string">"index"</span>: &#123;</div><div class="line">        <span class="string">"routing"</span>: &#123;</div><div class="line">            <span class="string">"allocation"</span>: &#123;</div><div class="line">                <span class="string">"require"</span>: &#123;</div><div class="line">                    <span class="string">"tag"</span>: <span class="string">"stale"</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure>
</li>
</ol>
<p>这样，写操作就在N台热数据节点上，大范围的独操作集中在M台冷数据节点上，避免了堵塞影响<br>参考： <a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/shard-allocation-filtering.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/reference/master/shard-allocation-filtering.html</a>  </p>
<h3 id="Elasticsearch自动发现的配置"><a href="#Elasticsearch自动发现的配置" class="headerlink" title="Elasticsearch自动发现的配置"></a>Elasticsearch自动发现的配置</h3><p>Elasticsearch是P2P类型（gossip协议）的分布式系统，除了集群状态管理以外，其他所有的请求都可以发送到集群内任意一台节点上，这个节点可以自己找到需求转发给哪些节点，并且直接跟这个节点通讯。<br>在Elasticsearch 5.0以后自动发现方式为单播（unicast）方式，原来的组播（multicast）被彻底删除。<br>单播方式的配置里，提供几台节点的地址里（和可选端口），Elasticsearch将其视作 <code>gossip router</code>角色，借以完成集群的发现。由于这只是Elasticsearch内很小的一个功能，所以，<code>gossip router</code>角色并不需要单独配置，每个Elasticsearch节点都可以担任。所以采用单播方式的集群，各个节点都配置相同的几个节点列表作为<code>router</code>即可。<br>此外，考虑到节点有时候因为高负载，慢GC等原因，可能会有偶尔没有及时相应的<code>ping</code>包，一般建议稍微加大<code>Fault Detection</code>的超时时间。同样基于安全考虑做的变更，还有监听的主机名，现在默认只监听本地lo网卡上的信号。所以正式环境上需要修改配置为监听具体的网卡：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">network.host: <span class="string">"192.168.1.41"</span></div><div class="line">discovery.zen.minimum_master_nodes:3</div><div class="line">discovery.zen.ping.timeout: 100s</div><div class="line">discovery.zen.fd.ping_timeout: 100s</div><div class="line">discovery.zen.ping.multicast.enabled: <span class="literal">false</span></div><div class="line">discovery.zen.ping.unicase.hosts: [<span class="string">"192.168.1.41"</span>,<span class="string">"192.168.1.42"</span>,<span class="string">"192.168.1.43"</span>]</div></pre></td></tr></table></figure></p>
<p>上面的<code>fd</code>是<code>fault detection</code>的缩写  </p>
<ul>
<li><code>discovery.zen.ping.timeout</code> 参数仅在加入或者选举master主节点的时候才起作用</li>
<li><code>discovery.zen.fd.ping_timeout</code> 参数在稳定运行的集群中，master检测所有节点，以及节点检测master是否正常时，长期有用</li>
</ul>
<p>既然是长期使用，自然还有运行间隔和重试配置，可以根据实际情况调整：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">discovery.zen.fd.ping_intervel: 10s</div><div class="line">discovery.zen.fd.ping_retries: 10</div></pre></td></tr></table></figure></p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/11/02/Elasticsearch原理/">http://www.yfshare.vip/2017/11/02/Elasticsearch原理/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Elasticsearch原理&lt;br&gt;
    
    </summary>
    
      <category term="ELK" scheme="http://www.yfshare.vip/categories/ELK/"/>
    
    
      <category term="Elasticsearch" scheme="http://www.yfshare.vip/tags/Elasticsearch/"/>
    
  </entry>
  
  <entry>
    <title>Kibana5使用指南</title>
    <link href="http://www.yfshare.vip/2017/10/30/Kibana5%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/"/>
    <id>http://www.yfshare.vip/2017/10/30/Kibana5使用指南/</id>
    <published>2017-10-30T13:35:02.000Z</published>
    <updated>2017-11-02T12:44:39.068Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/APlayer.min.js"> </script><script src="/assets/js/DPlayer.min.js"> </script><p>ELK由Elasticsearch、Logstash和Kibana三部分组件组成，这里新增了一个FileBeat，它是一个轻量级的日志收集处理工具(Agent)，Filebeat占用资源少，适合于在各个服务器上搜集日志后传输给Logstash，官方也推荐此工具<br><a id="more"></a><br>Filebeat隶属于Beats。目前Beats包含四种工具：  </p>
<ol>
<li>Packetbeat（搜集网络流量数据）  </li>
<li>Topbeat（搜集系统、进程和文件系统级别的 CPU 和内存使用情况等数据）</li>
<li>Filebeat（搜集文件数据）</li>
<li>Winlogbeat（搜集 Windows 事件日志数据）<h3 id="测试环境ELK架构讲解"><a href="#测试环境ELK架构讲解" class="headerlink" title="测试环境ELK架构讲解"></a>测试环境ELK架构讲解</h3>官方ELK架构图：<br><img src="http://note.youdao.com/yws/api/personal/file/DCE29CF684C34FC3BA73809D566B0150?method=download&amp;shareKey=798f64543357202a0efb9a95d35c4e5b" alt="filebeat">  </li>
</ol>
<p>目前测试环境的拓扑图：<br><img src="http://note.youdao.com/yws/api/personal/file/4772759A56704D82A3D1C6056C76613F?method=download&amp;shareKey=3c9825a509086b1a28b8ffd34aa9c6b0" alt="ELK_拓扑图">  </p>
<h3 id="Elasticsearch基本原理"><a href="#Elasticsearch基本原理" class="headerlink" title="Elasticsearch基本原理"></a>Elasticsearch基本原理</h3><p><img src="http://note.youdao.com/yws/api/personal/file/FD45A9D1BDDF4D92BFFBA09E04872591?method=download&amp;shareKey=735c6c6ebf035d8836ec5d827aa7e7fc" alt="利用磁盘缓存实现的准实时检索"><br><img src="http://note.youdao.com/yws/api/personal/file/6F91BABFB8B44FA2878D7FC4DF36EA8C?method=download&amp;shareKey=b5b3bb7b92596d736f0e8eb4b0b99079" alt="translog提供的磁盘同步控制"><br><img src="http://note.youdao.com/yws/api/personal/file/288CB47874D84FE5B4924D1DF06CA3A0?method=download&amp;shareKey=5cef29dfcfb7b1ed2d76c44fbe5da40d" alt="segment merge">  </p>
<p>官方文档<br>Filebeat：<br><a href="https://www.elastic.co/cn/products/beats/filebeat" target="_blank" rel="external">https://www.elastic.co/cn/products/beats/filebeat</a><br><a href="https://www.elastic.co/guide/en/beats/filebeat/5.6/index.html" target="_blank" rel="external">https://www.elastic.co/guide/en/beats/filebeat/5.6/index.html</a>  </p>
<p>Logstash：<br><a href="https://www.elastic.co/cn/products/logstash" target="_blank" rel="external">https://www.elastic.co/cn/products/logstash</a><br><a href="https://www.elastic.co/guide/en/logstash/5.6/index.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/5.6/index.html</a>  </p>
<p>Elasticsearch：<br><a href="https://www.elastic.co/cn/products/elasticsearch" target="_blank" rel="external">https://www.elastic.co/cn/products/elasticsearch</a><br><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/index.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/reference/5.6/index.html</a>  </p>
<p>elasticsearch中文社区：<br><a href="https://elasticsearch.cn/" target="_blank" rel="external">https://elasticsearch.cn/</a>  </p>
<h3 id="Kibana使用指南"><a href="#Kibana使用指南" class="headerlink" title="Kibana使用指南"></a>Kibana使用指南</h3><p>Kibana有另一个名字 elasticsearch dashboard，设计参考了 Splunk<br>Kibana主要功能 Discover，Visualize，Dashboard，Timelion，DevTools，Management  </p>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/query-dsl-query-string-query.html#query-string-syntax" target="_blank" rel="external">lucene query syntax</a><br><img src="http://note.youdao.com/yws/api/personal/file/45BD110CD9B24ECAACC51EE54637EAB8?method=download&amp;shareKey=dd229f6cfe56bfd10396117cb4790a65" alt="kibana">  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/58CBFFB81D4941178EDE60CB254E0512?method=download&amp;shareKey=7eec44cd864fb579a5b12694c77bc52c" alt="kibana">  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/8732A5AA79B64E1F9B1A63D85CD8F330?method=download&amp;shareKey=f7d887ce2e084814367c8555c656b3c1" alt="Kibana">  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/B80830DE946244E5A0105A62FBA738D9?method=download&amp;shareKey=7b9b3a854c883ca4bc17f286c5c6c743" alt="kibana">  </p>
<h3 id="Elasticsearch查询语法"><a href="#Elasticsearch查询语法" class="headerlink" title="Elasticsearch查询语法"></a>Elasticsearch查询语法</h3><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/common-options.html#date-math" target="_blank" rel="external">Elasticsearch Query DSL查询语法</a><br><img src="http://note.youdao.com/yws/api/personal/file/3E744DB1A632475EA8D5460F76BDD6BC?method=download&amp;shareKey=8ef13860f3e3f2eb1c901e2b017dc74e" alt="kibana">  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/25D871BBDF604A1189E18F6D922C4014?method=download&amp;shareKey=7f4fcf3f5e29920e64099a8deb137757" alt="Elasticsearch Query DSL"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"query"</span>: &#123;</div><div class="line">    <span class="string">"term"</span>: &#123;</div><div class="line">      <span class="string">"_id"</span>: <span class="string">"AV9orWWLv96dGKcHDVyi"</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/DA5A626EFFE3454F922FAD2B4F0C45BF?method=download&amp;shareKey=48ce91f24595076b45122e9dea483db9" alt="kibana_search">  </p>
<p>querystring 语法<br>上例中<code>?q=</code>后面的就是querystring语法，会在kibana中经常使用  </p>
<ul>
<li><code>全文检索</code>：直接写搜索的单词。如：<code>?q=aaaa</code></li>
<li><code>单字段的全文检索</code>：在搜索单词之前加上字段名和冒号。如：<code>?q=user:jack</code></li>
<li><code>单字段的精确检索</code>：在搜索单词前加上双引号。如：<code>?q=user:&quot;jack&quot;</code></li>
<li><code>多个检索条件的组合</code>：可以使用<code>NOT</code>、<code>AND</code>、<code>OR</code>来组合检索，必须是大写的。如：<code>?q=user:(&quot;jack&quot; OR &quot;bob&quot;) AND NOT mesg:aaaa</code></li>
<li><code>字段是否存在</code>：<code>_exists_:user</code>表示要求user字段存在，<code>_missing_:user</code>表示user字段不存在。如：<code>?q=_exists_:beat.name</code></li>
<li><code>通配符</code>：用<code>?</code>表示单字母，<code>*</code>表示任意个字母。如：<code>?q=DevE?N</code>，<code>?q=DevE?N*</code></li>
<li><code>正则</code>：比通配符更复杂一点点。如：<code>?q=/dub{2}o/</code><br>注：Elasticsearch正则性能不好，尽量不要使用太复杂或不使用。参考<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/query-dsl-regexp-query.html#regexp-synntax" target="_blank" rel="external">Elasticsearch正则表达式语法</a>  </li>
<li><code>近似搜索</code>：用<code>~</code>表示搜索单词可能有一字母写的不对。如：<code>?q=dubao~</code></li>
<li><code>范围搜索</code>：对数值和时间。如：<code>?q=@timestamp:&gt;150928968615</code>，<code>?q=@timestamp:[&quot;now-1m&quot; TO &quot;now&quot;]</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -XGET http://localhost:9200/192.168.1.21-account_errorlog-2017.10.29/_search?pretty=<span class="literal">true</span>?q=<span class="string">'com.alibaba.dubbo.monitor.MonitorService'</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -XGET http://localhost:9200/192.168.1.21-account_errorlog-2017.10.29/_search?pretty=<span class="literal">true</span>?q=beat.hostname=<span class="string">'DevEVN-21'</span></div></pre></td></tr></table></figure>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/query-dsl-queries.html" target="_blank" rel="external">Elasticsearch其他查询语法</a><br><a href="http://www.yfshare.vip/2017/10/30/Elasticsearch%E6%9F%A5%E8%AF%A2%E8%AF%AD%E6%B3%95/#全文搜索">Elasticsearch全文搜索</a>  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/F9660B5ED9F2481B85888ACCF2FC11B4?method=download&amp;shareKey=328b06bb6a52b854733eb636b0938a73" alt="Kibana">  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/E39A9C72B26B4883BFE71058C40D3EF4?method=download&amp;shareKey=aaf776329e429927fe221afb5b37ecd4" alt="Kibana">  </p>
<h3 id="日志分析"><a href="#日志分析" class="headerlink" title="日志分析"></a>日志分析</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#nginx日志格式</span></div><div class="line">    log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></div><div class="line">                      <span class="string">'$status $body_bytes_sent "$http_referer" '</span></div><div class="line">                      <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</div><div class="line"></div><div class="line"><span class="comment">#nginx access日志</span></div><div class="line">192.168.1.153 - - [18/Oct/2017:21:48:00 +0800] <span class="string">"GET /ErrorPages/404.html HTTP/1.0"</span> 404 571 <span class="string">"https://devqian.julend.com/static/pageHtml/bindCardCallback.html?view=zhimaCredit&amp;params=XHk1tuyGnXS1wGSpis2PiC9UKCizLIiGIm0eJ%2Fz1lXc8JdGVXxB2Ftg9hFKZjFfwh3w%2FM6UIEpxQ11TTqXf31xNx9N%2FzGMc00rpvf6YpKEJPQFFCL4X9eLQdLJl5KaaGiK8AdNZS38dJDKEzFJP0o1523nCOhjJEtgS0394oLIB2siIqYF7RTVgBaU1xE72m3vmZcvqvgVZUH8ozt8tftXh4Wq5paf647mA%2FZZJOaXabeFEwuwa7dhtVXTT8CBdnOOiDC5WmwBCC%2FnIqKmfTI1gmFvQUobDA9RY4UcMdMY9RixLkhSdQ8k5LtpD2NVuJDLEscZAdfROhyYeEnZ7Ptg%3D%3D&amp;sign=ABeWMdLqNeFUhDYKUJsJfzLolxA%2Fo64Wl8mmgX36yqM5VWHMvB7VcpZJ3AA7WsH%2BTFe6EARuABMe2HupY6DbzuITufa9aPZX9BHbN6dLPMre0n8aHZnr59h%2FC6Us%2FAW11tu2n6l%2F1dSyCo951diQ55en%2BO%2FffRJ1ldFUwzhzNCQ%3D"</span> <span class="string">"Mozilla/5.0 (Linux; Android 7.1.1; OPPO R11t Build/NMF26X; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/55.0.2883.91 Mobile Safari/537.36"</span> <span class="string">"121.238.20.93"</span></div><div class="line"></div><div class="line"><span class="comment">#logstash grok分析nginx日志格式</span></div><div class="line">grok &#123;</div><div class="line">   match =&gt; [<span class="string">"message"</span>,<span class="string">"%&#123;IPV4:remote_addr&#125; [\-] %&#123;USERNAME:remote_user&#125; \[%&#123;DATA:time_local&#125;\] \"(?&lt;request&gt;[^\"]*)\" (?&lt;status&gt;\d+) (?&lt;body_bytes_sent&gt;\d+) \"(?&lt;http_referer&gt;[^\"]*)\" \"(?&lt;http_user_agent&gt;[^\"]*)\" \"%&#123;IPV4:http_x_forwarded_for&#125;"</span>]</div><div class="line">&#125;</div><div class="line"></div><div class="line">[root@ELK ~]<span class="comment"># /usr/share/logstash/bin/logstash --path.settings /etc/logstash/ -f /etc/logstash/conf.d/geoip.conf</span></div><div class="line">Sending Logstash<span class="string">'s logs to /var/log/logstash which is now configured via log4j2.properties</span></div><div class="line">&#123;</div><div class="line">           "geoip" =&gt; &#123;&#125;,</div><div class="line">              "ua" =&gt; "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/47.0.2526.106 Safari/537.36",</div><div class="line">            "type" =&gt; "Nginx",</div><div class="line">          "clinet" =&gt; "192.168.31.105",</div><div class="line">            "tags" =&gt; [</div><div class="line">        [0] "_geoip_lookup_failure"</div><div class="line">    ],</div><div class="line">            "path" =&gt; "/var/log/nginx/access.log",</div><div class="line">      "@timestamp" =&gt; 2016-12-15T08:13:19.000Z,</div><div class="line">            "size" =&gt; 0,</div><div class="line">          "domain" =&gt; "192.168.31.100",</div><div class="line">        "@version" =&gt; "1",</div><div class="line">            "host" =&gt; "192.168.31.100",</div><div class="line">    "responsetime" =&gt; 0.0,</div><div class="line">          "status" =&gt; "304"</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">2017-10-24_15:42:00.408 [DubboMonitorSendTimer-thread-3] ERROR [com.alibaba.dubbo.common.logger.slf4j.Slf4jLogger]  [DUBBO] Unexpected error occur at send statistic, cause:</div><div class="line"> Failed to invoke the method collect <span class="keyword">in</span> the service com.alibaba.dubbo.monitor.MonitorService. No provider available <span class="keyword">for</span> the service com.alibaba.dubbo.monitor.MonitorService from registry 192.168.1.21:2181 on the consumer 192.168.1.21 using the dubbo version 2.5.3. Please check <span class="keyword">if</span> the providers have been started and registered., dubbo version: 2.5.3, current host: 192.168.1.21com.alibaba.dubbo.rpc.RpcException: Failed to invoke the method collect <span class="keyword">in</span> the service com.alibaba.dubbo.monitor.MonitorService. No provider available <span class="keyword">for</span> the service com.a</div><div class="line">libaba.dubbo.monitor.MonitorService from registry 192.168.1.21:2181 on the consumer 192.168.1.21 using the dubbo version 2.5.3. Please check <span class="keyword">if</span> the providers have been started and registered.	at com.alibaba.dubbo.rpc.cluster.support.AbstractClusterInvoker.checkInvokers(AbstractClusterInvoker.java:246) ~[dubbo-2.5.3.jar:2.5.3]</div><div class="line">	at com.alibaba.dubbo.rpc.cluster.support.FailoverClusterInvoker.doInvoke(FailoverClusterInvoker.java:55) ~[dubbo-2.5.3.jar:2.5.3]</div><div class="line">	at com.alibaba.dubbo.rpc.cluster.support.AbstractClusterInvoker.invoke(AbstractClusterInvoker.java:227) ~[dubbo-2.5.3.jar:2.5.3]</div><div class="line">	at com.alibaba.dubbo.rpc.cluster.support.wrapper.MockClusterInvoker.invoke(MockClusterInvoker.java:72) ~[dubbo-2.5.3.jar:2.5.3]</div><div class="line">	at com.alibaba.dubbo.rpc.proxy.InvokerInvocationHandler.invoke(InvokerInvocationHandler.java:52) ~[dubbo-2.5.3.jar:2.5.3]</div><div class="line">	at com.alibaba.dubbo.common.bytecode.proxy8.collect(proxy8.java) ~[na:2.5.3]</div><div class="line">	at com.alibaba.dubbo.monitor.dubbo.DubboMonitor.send(DubboMonitor.java:113) ~[dubbo-2.5.3.jar:2.5.3]</div><div class="line">	at com.alibaba.dubbo.monitor.dubbo.DubboMonitor<span class="variable">$1</span>.run(DubboMonitor.java:70) ~[dubbo-2.5.3.jar:2.5.3]</div><div class="line">	at java.util.concurrent.Executors<span class="variable">$RunnableAdapter</span>.call(Executors.java:471) [na:1.7.0_80]</div><div class="line">	at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:304) [na:1.7.0_80]</div><div class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor<span class="variable">$ScheduledFutureTask</span>.access<span class="variable">$301</span>(ScheduledThreadPoolExecutor.java:178) [na:1.7.0_80]</div><div class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor<span class="variable">$ScheduledFutureTask</span>.run(ScheduledThreadPoolExecutor.java:293) [na:1.7.0_80]</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) [na:1.7.0_80]</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor<span class="variable">$Worker</span>.run(ThreadPoolExecutor.java:615) [na:1.7.0_80]</div><div class="line">	at java.lang.Thread.run(Thread.java:745) [na:1.7.0_80]</div><div class="line">2017-10-24_15:43:00.413 [DubboMonitorSendTimer-thread-3] INFO  [com.alibaba.dubbo.common.logger.slf4j.Slf4jLogger]  [DUBBO] Send statistics to monitor zookeeper://192.168.1</div><div class="line">.21:2181/com.alibaba.dubbo.monitor.MonitorService?dubbo=2.5.3&amp;interface=com.alibaba.dubbo.monitor.MonitorService&amp;pid=11958&amp;timestamp=1508762187622, dubbo version: 2.5.3, current host: 192.168.1.21</div></pre></td></tr></table></figure>
<ul>
<li><p>multiline</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">input &#123;</div><div class="line">  beats &#123;</div><div class="line">    port =&gt; 5044</div><div class="line">    codec =&gt; multiline &#123;</div><div class="line">         pattern =&gt; <span class="string">"^%&#123;YEAR&#125;[/-]%&#123;MONTHNUM&#125;[/-]%&#123;MONTHDAY&#125;[/_]%&#123;TIME&#125; "</span></div><div class="line">         negate =&gt; <span class="literal">true</span></div><div class="line">         what =&gt; previous</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>Log4J<br>需要配置 Java 应用的 <code>Log4J</code> 设置，启动一个内置的 <code>SocketAppender</code>。修改应用的 log4j.xml 配置文件，添加如下配置段  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;appender name=<span class="string">"LOGSTASH"</span> class=<span class="string">"org.apache.log4j.net.SocketAppender"</span>&gt;</div><div class="line">    &lt;param name=<span class="string">"RemoteHost"</span> value=<span class="string">"logstash_hostname"</span> /&gt;</div><div class="line">    &lt;param name=<span class="string">"ReconnectionDelay"</span> value=<span class="string">"60000"</span> /&gt;</div><div class="line">    &lt;param name=<span class="string">"LocationInfo"</span> value=<span class="string">"true"</span> /&gt;</div><div class="line">    &lt;param name=<span class="string">"Threshold"</span> value=<span class="string">"DEBUG"</span> /&gt;</div><div class="line">&lt;/appender&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>然后把这个新定义的 appender 对象加入到 root logger 里，可以跟其他已有 logger 共存<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;root&gt;</div><div class="line">    &lt;level value=<span class="string">"INFO"</span>/&gt;</div><div class="line">    &lt;appender-ref ref=<span class="string">"OTHERPLACE"</span>/&gt;</div><div class="line">    &lt;appender-ref ref=<span class="string">"LOGSTASH"</span>/&gt;</div><div class="line">&lt;/root&gt;</div></pre></td></tr></table></figure></p>
<p>log4j.properties 配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">log</span>4j.rootLogger=DEBUG, logstash</div><div class="line"></div><div class="line"><span class="comment">###SocketAppender###</span></div><div class="line"><span class="built_in">log</span>4j.appender.logstash=org.apache.log4j.net.SocketAppender</div><div class="line"><span class="built_in">log</span>4j.appender.logstash.Port=4560</div><div class="line"><span class="built_in">log</span>4j.appender.logstash.RemoteHost=logstash_hostname</div><div class="line"><span class="built_in">log</span>4j.appender.logstash.ReconnectionDelay=60000</div><div class="line"><span class="built_in">log</span>4j.appender.logstash.LocationInfo=<span class="literal">true</span></div></pre></td></tr></table></figure></p>
<p>Log4J 会持续尝试连接你配置的 <code>logstash_hostname</code> 这个地址，建立连接后，即开始发送日志数据  </p>
<p>Logstash，Java 应用端的配置完成以后，开始设置 Logstash 的接收端，配置如下所示，其中 4560 端口是 Log4J SocketAppender 的默认对端端口<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">input &#123;</div><div class="line">  <span class="built_in">log</span>4j &#123;</div><div class="line">    <span class="built_in">type</span> =&gt; <span class="string">"log4j-json"</span></div><div class="line">    port =&gt; 4560</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>JSON Event layout<br>如果无法采用 socketappender ，必须使用文件方式的，其实 Log4J 有一个 layout 特性，用来控制日志输出的格式。和 Nginx 日志自己拼接 JSON 输出类似，也可以通过 layout 功能，记录成 JSON 格式。</li>
</ul>
<p>参考：<a href="https://github.com/logstash/log4j-jsonevent-layout" target="_blank" rel="external">https://github.com/logstash/log4j-jsonevent-layout</a>  </p>
<p>logstash官方提供的扩展包，可以通过mvnrepository.com搜索下载<br><a href="http://central.maven.org/maven2/net/logstash/log4j/jsonevent-layout/1.7/jsonevent-layout-1.7.jar" target="_blank" rel="external">http://central.maven.org/maven2/net/logstash/log4j/jsonevent-layout/1.7/jsonevent-layout-1.7.jar</a>  </p>
<p>或者直接编辑自己项目的pom.xml添加依赖<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;net.logstash.log4j&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;jsonevent-layout&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;1.7&lt;/version&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure></p>
<p>然后修改项目的log4j.properties文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">log</span>4j.rootCategory=WARN,RollingLog</div><div class="line"><span class="built_in">log</span>4j.appender.RollingLog=org.apache.log4j.DailyRollingFileAppender</div><div class="line"><span class="built_in">log</span>4j.appender.RollingLog.Threshold=TRACE</div><div class="line"><span class="built_in">log</span>4j.appender.RollingLog.File=api.log</div><div class="line"><span class="built_in">log</span>4j.appender.RollingLog.DatePattern=.yyyy-MM-dd</div><div class="line"><span class="built_in">log</span>4j.appender.RollingLog.layout=net.logstash.log4j.JSONEventLayoutV1</div></pre></td></tr></table></figure></p>
<p>如果是log4j.xml文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;appender name=<span class="string">"Console"</span> class=<span class="string">"org.apace.log4j.ConsoleAppender"</span>&gt;</div><div class="line">    &lt;param name=<span class="string">"Threshould"</span> value=<span class="string">"TRACE"</span> /&gt;</div><div class="line">    &lt;layout class=<span class="string">"net.logstash.log4j.JSONEventLayoutV1"</span> /&gt;</div><div class="line">&lt;/appender&gt;</div></pre></td></tr></table></figure></p>
<p>生成的文件就是Logstash标准的JSON格式，logstash使用下面配置读取<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">input &#123;</div><div class="line">    file &#123;</div><div class="line">            codec =&gt; json</div><div class="line">            path =&gt; [<span class="string">"/path/to/log4j.log"</span>]</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>生成的Logstash事件如下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"mdc"</span>: &#123;&#125;,</div><div class="line">    <span class="string">"line_number"</span>: <span class="string">"29"</span>,</div><div class="line">    <span class="string">"class"</span>:<span class="string">"org.eclipse,jetty.examples.logging.EchoFormServlet"</span>,</div><div class="line">    <span class="string">"@version"</span>:1,</div><div class="line">    <span class="string">"source_host"</span>:<span class="string">"jvstratusmbp.local"</span>,</div><div class="line">    <span class="string">"thread_name"</span>:<span class="string">"qtp513694835-14"</span>,</div><div class="line">    <span class="string">"message"</span>:<span class="string">"Got request from 0:0:0:0:0:0:0:1%0 using Mozilla\/5.0 (Macintosh;Inter Mac OS X 10_9_1) AppleWebit\/537.36 (KHTML, like Gecko) Chrome \/32.0.1700.77 Safari\/537.36"</span>,</div><div class="line">    <span class="string">"@timestamp"</span>:<span class="string">"2014-01-27T19:52:35.738z"</span>,</div><div class="line">    <span class="string">"level"</span>:<span class="string">"INFO"</span>,</div><div class="line">    <span class="string">"file"</span>:<span class="string">"EchoFormServlet.java"</span>,</div><div class="line">    <span class="string">"method"</span>:<span class="string">"doPost"</span>,</div><div class="line">    <span class="string">"logger_name"</span>:<span class="string">"org.eclipse.jetty.example.logging.EchoFormServlet"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果使用的不是Log4J而是logback项目来记录JAVA日志，Logstash官方也有类似的扩展包，修改pom.xml<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;net.logstash.logback&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;logstash-logback-encoder&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;4.4&lt;/version&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure></p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/10/30/Kibana5使用指南/">http://www.yfshare.vip/2017/10/30/Kibana5使用指南/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ELK由Elasticsearch、Logstash和Kibana三部分组件组成，这里新增了一个FileBeat，它是一个轻量级的日志收集处理工具(Agent)，Filebeat占用资源少，适合于在各个服务器上搜集日志后传输给Logstash，官方也推荐此工具&lt;br&gt;
    
    </summary>
    
      <category term="ELK" scheme="http://www.yfshare.vip/categories/ELK/"/>
    
    
      <category term="Elasticsearch" scheme="http://www.yfshare.vip/tags/Elasticsearch/"/>
    
      <category term="Logstash" scheme="http://www.yfshare.vip/tags/Logstash/"/>
    
      <category term="Kibana" scheme="http://www.yfshare.vip/tags/Kibana/"/>
    
  </entry>
  
  <entry>
    <title>Elasticsearch查询语法</title>
    <link href="http://www.yfshare.vip/2017/10/30/Elasticsearch%E6%9F%A5%E8%AF%A2%E8%AF%AD%E6%B3%95/"/>
    <id>http://www.yfshare.vip/2017/10/30/Elasticsearch查询语法/</id>
    <published>2017-10-29T16:34:30.000Z</published>
    <updated>2017-11-02T12:44:27.208Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/APlayer.min.js"> </script><script src="/assets/js/DPlayer.min.js"> </script><p>Elasticsearch在很多情况下被当作一个文本型的NOSQL数据库，也有增删查改操作<br><a id="more"></a></p>
<h4 id="数据写入"><a href="#数据写入" class="headerlink" title="数据写入"></a>数据写入</h4><p>Elasticsearch的一大特点是，全是<code>RESTful</code>接口处理JSON请求<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPOST http://localhost:9200/logstash-2017.10.29/testlog -d '&#123;</span></div><div class="line">    <span class="string">"date"</span>: <span class="string">"1509271325780"</span></div><div class="line">    <span class="string">"user"</span>: <span class="string">"jack"</span></div><div class="line">    <span class="string">"mesg"</span>: <span class="string">"first message into Elasticsearch"</span></div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure></p>
<h4 id="数据获取"><a href="#数据获取" class="headerlink" title="数据获取"></a>数据获取</h4><p>在数据写入时，会返回该数据的<code>_id</code>，这是后续用来获取数据的关键：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XGET http://localhost:9200/logstash-2017.10.29/testlog/AV9nlDQhv96dGKcHC2zo</span></div><div class="line">&#123;<span class="string">"_index"</span>: <span class="string">"logstash-2017.10.29"</span>,<span class="string">"_type"</span>: <span class="string">"testlog"</span>, <span class="string">"_id"</span>: <span class="string">"AV9nlDQhv96dGKcHC2zo"</span>, <span class="string">"_version"</span>: 1, <span class="string">"found"</span>: <span class="literal">true</span>, <span class="string">"_source"</span>: &#123;</div><div class="line">    <span class="string">"date"</span>: <span class="string">"1509271325780"</span>,</div><div class="line">    <span class="string">"user"</span>: <span class="string">"jack"</span>,</div><div class="line">    <span class="string">"mesg"</span>: <span class="string">"first message into Elasticsearch"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>也可以使用下面语法来获取源数据部分<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -XGET http://localhost:9200/logstash-2017.10.29/testlog/AV9nlDQhv96dGKcHC2zo/_source</div></pre></td></tr></table></figure></p>
<p>或者使用下面语法来指明获取字段<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -XGET http://localhost:9200/logstash-2017.10.29/testlog/AV9nlDQhv96dGKcHC2zo?fields=user,mesg</div></pre></td></tr></table></figure></p>
<h4 id="数据删除"><a href="#数据删除" class="headerlink" title="数据删除"></a>数据删除</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#删除单条数据</span></div><div class="line"><span class="comment"># curl -XDELETE http://localhost:9200/logstash-2017.10.29/testlog/AV9nlDQhv96dGKcHC2zo</span></div><div class="line"></div><div class="line"><span class="comment">#删除整个type或者整个索引</span></div><div class="line"><span class="comment"># curl -XGET http://localhost:9200/logstash-2017.10.2*</span></div></pre></td></tr></table></figure>
<h4 id="数据更新"><a href="#数据更新" class="headerlink" title="数据更新"></a>数据更新</h4><p>分为两种情况：  </p>
<ol>
<li>全量提交</li>
<li>指明<code>_id</code>再发送一次写入请求<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#全部提交</span></div><div class="line"><span class="comment"># curl -XPOST http://localhost:9200/logstash-2017.10.29/testlog/AV9nlDQhv96dGKcHC2zo -d '&#123;</span></div><div class="line">    <span class="string">"date"</span>: <span class="string">"1509271325780"</span>,</div><div class="line">    <span class="string">"user"</span>: <span class="string">"jack"</span>,</div><div class="line">    <span class="string">"mesg"</span>: <span class="string">"first message into Elasticsearch but version 2"</span></div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#局部提交</span></div><div class="line"><span class="comment"># curl -XPOST http://localhost:9200/logstash-2017.10.29/testlog/AV9nlDQhv96dGKcHC2zo -d '&#123;</span></div><div class="line">    <span class="string">"doc"</span>: &#123;</div><div class="line">        <span class="string">"user"</span>: <span class="string">"jack wang"</span></div><div class="line">    &#125;</div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure>
<p>或者<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPOST http://localhost:9200/logstash-2017.10.29/testlog/AV9nlDQhv96dGKcHC2zo/_update -d '&#123;</span></div><div class="line">    <span class="string">"scripts"</span>: <span class="string">"ctx._source.user = \"someone\""</span></div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure></p>
<h4 id="全文搜索"><a href="#全文搜索" class="headerlink" title="全文搜索"></a>全文搜索</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XGET http://localhost:9200/logstash-2017.10.29/testlog/_search?pretty=true?q='first'</span></div><div class="line"></div><div class="line"><span class="comment"># curl -XGET http://localhost:9200/logstash-2017.10.29/testlog/_search?pretty=true?q=user:"jack"</span></div></pre></td></tr></table></figure>
<h5 id="querystring-语法"><a href="#querystring-语法" class="headerlink" title="querystring 语法"></a>querystring 语法</h5><p>上例中<code>?q=</code>后面的就是querystring语法，会在kibana中经常使用  </p>
<ul>
<li><code>全文检索</code>：直接写搜索的单词。如：<code>?q=aaaa</code></li>
<li><code>单字段的全文检索</code>：在搜索单词之前加上字段名和冒号。如：<code>?q=user:jack</code></li>
<li><code>单字段的精确检索</code>：在搜索单词前加上双引号。如：<code>?q=user:&quot;jack&quot;</code></li>
<li><code>多个检索条件的组合</code>：可以使用<code>NOT</code>、<code>AND</code>、<code>OR</code>来组合检索，必须是大写的。如：<code>?q=user:(&quot;jack&quot; OR &quot;bob&quot;) AND NOT mesg:aaaa</code></li>
<li><code>字段是否存在</code>：<code>_exists_:user</code>表示要求user字段存在，<code>_missing_:user</code>表示user字段不存在。如：<code>?q=_exists_:beat.name</code></li>
<li><code>通配符</code>：用<code>?</code>表示单字母，<code>*</code>表示任意个字母。如：<code>?q=DevE?N</code>，<code>?q=DevE?N*</code></li>
<li><code>正则</code>：比通配符更复杂一点点。如：<code>?q=/dub{2}o/</code><br>注：Elasticsearch正则性能不好，尽量不要使用太复杂或不使用。参考<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/query-dsl-regexp-query.html#regexp-synntax" target="_blank" rel="external">Elasticsearch正则表达式语法</a>  </li>
<li><code>近似搜索</code>：用<code>~</code>表示搜索单词可能有一字母写的不对。如：<code>?q=dubao~</code></li>
<li><code>范围搜索</code>：对数值和时间。如：<code>?q=@timestamp:&gt;150928968615</code>，<code>?q=@timestamp:[&quot;now-1m&quot; TO &quot;now&quot;]</code></li>
</ul>
<h5 id="DSL语法"><a href="#DSL语法" class="headerlink" title="DSL语法"></a>DSL语法</h5><p>Elasticsearch也支持其他查询语法，具体见：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/query-dsl-queries.html" target="_blank" rel="external">Elasticsearch其他查询语法</a>  </p>
<ul>
<li><code>term query</code><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XGET http://localhost:9200/_search -d '</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"query"</span>: &#123;</div><div class="line">    <span class="string">"term"</span>: &#123;</div><div class="line">      <span class="string">"_id"</span>: <span class="string">"AV9orWWLv96dGKcHDVyi"</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="聚合请求"><a href="#聚合请求" class="headerlink" title="聚合请求"></a>聚合请求</h5><p>在检索范围确定后，Elasticsearch还执行对结果集做聚合查询，返回更直接的聚合统计结果。<br><code>aggression</code>分为<code>bucket</code>和<code>metric</code>，分别用作词元划分和数值计算。而bucket aggression还支持在自身结果集的基础上叠加新的aggression。<br>实现一个时序的百分比统计<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPOST 'http://localhost:9200/logstash-2017.10.29/_search?size=0&amp;pretty' -d '&#123;</span></div><div class="line"><span class="string">"aggs"</span>: &#123;</div><div class="line">    <span class="string">"percentile_over_time"</span>: &#123;</div><div class="line">        <span class="string">"date_histogram"</span>: &#123;</div><div class="line">            <span class="string">"field"</span>: <span class="string">"@timestamp"</span>,</div><div class="line">            <span class="string">"interval"</span>: <span class="string">"1m"</span></div><div class="line">        &#125;,</div><div class="line">        <span class="string">"aggs"</span>: &#123;</div><div class="line">            <span class="string">"percentile_one_time"</span>: &#123;</div><div class="line">                <span class="string">"percentiles"</span>: &#123;</div><div class="line">                    <span class="string">"field"</span>: <span class="string">"requesttime"</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure></p>
<h5 id="pipeline聚合"><a href="#pipeline聚合" class="headerlink" title="pipeline聚合"></a>pipeline聚合</h5><p>Elasticsearch 2.x 新增pipeline aggression类型，再已有aggression返回的数组数据之后，再对这组数值做一次运算。在Kibana 5.0的timelion中有用到<br>常见的pipeline聚合场景，就是对时序数据求移动平均值<br>示例：<br>对响应时间设置如下：周期为7，移动窗口为30，alpa、beta、gamma参数均为0.5，holt-winters季节性预测2个未来值<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"aggs"</span>: &#123;</div><div class="line">        <span class="string">"my_date_histo"</span>: &#123;</div><div class="line">            <span class="string">"date_histogram"</span>: &#123;</div><div class="line">                <span class="string">"field"</span>: <span class="string">"@timestamp"</span>,</div><div class="line">                <span class="string">"interval"</span>: <span class="string">"1h"</span></div><div class="line">            &#125;,</div><div class="line">            <span class="string">"aggs"</span>: &#123;</div><div class="line">                <span class="string">"avgtime"</span>: &#123;</div><div class="line">                    <span class="string">"avg"</span>: &#123; <span class="string">"field"</span>: <span class="string">"requesttime"</span> &#125;</div><div class="line">                &#125;,</div><div class="line">                <span class="string">"the_movavg"</span>: &#123;</div><div class="line">                    <span class="string">"moving_avg"</span>: &#123;</div><div class="line">                        <span class="string">"buckets_path"</span>: <span class="string">"avgtime"</span>,</div><div class="line">                        <span class="string">"window"</span>: 30,</div><div class="line">                        <span class="string">"model"</span>: <span class="string">"holt_winters"</span>,</div><div class="line">                        <span class="string">"predict"</span>: 2,</div><div class="line">                        <span class="string">"settings"</span>: &#123;</div><div class="line">                            <span class="string">"type"</span>: <span class="string">"mult"</span>,</div><div class="line">                            <span class="string">"alpha"</span>: 0.5,</div><div class="line">                            <span class="string">"beat"</span>: 0.5,</div><div class="line">                            <span class="string">"gamma"</span>: 0.5,</div><div class="line">                            <span class="string">"period"</span>: 7,</div><div class="line">                            <span class="string">"pad"</span>: <span class="literal">true</span></div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="buckets-path语法"><a href="#buckets-path语法" class="headerlink" title="buckets_path语法"></a>buckets_path语法</h5><p>aggression是有堆叠层级关系的，所以pipeline aggression在引用 metric aggression时会涉及到层级的问题。在上例中，the_movavg和avgtime是同一级，所以buckets_path直接就写avgtime即可。但如果把the_movavg上提一层，跟my_date_histo同级<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">"buckets_path"</span>: <span class="string">"my_date_histo &gt; avgtime"</span></div></pre></td></tr></table></figure></p>
<p>如果用的是返回的数值有多个值的聚合，比如<code>?percentiles</code>或者<code>?extended_stats</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">"buckets_path"</span>: <span class="string">"percentile_over_time &gt; percentile_one_time.95"</span></div></pre></td></tr></table></figure></p>
<p>目前Elasticsearch支持的聚合请求列表，参考：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/search-aggregations.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/reference/5.6/search-aggregations.html</a><br>参考阅读：Holt Winters预测算法，见：<a href="https://en.wikipedia.org/wiki/Holt-Winters" target="_blank" rel="external">https://en.wikipedia.org/wiki/Holt-Winters</a>  </p>
<h5 id="搜索请求参数"><a href="#搜索请求参数" class="headerlink" title="搜索请求参数"></a>搜索请求参数</h5><p>搜索请求参数如下：  </p>
<ul>
<li><code>from</code>: 从索引的第几条数据开始返回，默认是0  </li>
<li><code>size</code>: 返回多少条数据，默认是10<br><em>Elasticsearch集群实际是需要给 coordinate node 返回 shards number x (from + size)条数据，然后在单机上进行排序，最后给客户端返回大小为 size的数据。所以请慎用 from和size参数</em><br><em>此外，Elasticsearch 2.x 还增加了一个索引级别的动态控制配置项：index.max_result_window，默认为10000，即from + size大于10000，Elasticsearch会直接拒绝这次请求不进行具体搜索，以保护节点</em><br><em>Elasticsearch 2.x 还优化了，当设置 “size”:0 时，自动改变 search_type为 count。跳过过程的 fetch 阶段</em>  </li>
<li><code>timeout</code>：coordinate node 等待超时时间。当达到阀值后，coordinate node 会直接把当前收到的数据返回个客户端，不再等待 data node后续的返回结果了。<br>注：这个参数只是为了配合客户端程序，并不能取消data node上搜索任务还在运行和占用资源  </li>
<li><code>terminate_after</code>：各data node上，扫描单个分片时找到多少记录后，就认为足够了。这个参数可以切实保护 data node 上搜索任务不会长期运行和占用资源。也就是意味着搜索范围没有覆盖全部索引，是一个抽样数据。准确率不好判断。  </li>
<li><code>request_cache</code>：各data node上，在分片级别对请求的响应（仅限于hits.total数值、 aggression 和 suggestion的结果集）做的缓存。注意，这个缓存的键值要求很严格，请求的JSON必须一字不易，缓存才能命中<br>另外，request_cache 参数不能写在请求的JSON里，只能以URL参数的形式存在，示例如下：  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -XPOST http://localhost:9200/_search?request_cache=true -d '</span></div><div class="line">&#123;</div><div class="line">    <span class="string">"size"</span>: 0,</div><div class="line">    <span class="string">"timeout"</span>: <span class="string">"120s"</span>,</div><div class="line">    <span class="string">"terminate_after"</span>: 1000000,</div><div class="line">    <span class="string">"query"</span>: &#123; <span class="string">"match_all"</span>: &#123;&#125; &#125;,</div><div class="line">    <span class="string">"aggs"</span>: &#123;<span class="string">"terms"</span>: &#123; <span class="string">"terms"</span> : &#123; <span class="string">"field"</span> : <span class="string">"keyname"</span> &#125; &#125; &#125;</div><div class="line">&#125;</div><div class="line"><span class="string">'</span></div></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/10/30/Elasticsearch查询语法/">http://www.yfshare.vip/2017/10/30/Elasticsearch查询语法/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Elasticsearch在很多情况下被当作一个文本型的NOSQL数据库，也有增删查改操作&lt;br&gt;
    
    </summary>
    
      <category term="ELK" scheme="http://www.yfshare.vip/categories/ELK/"/>
    
    
      <category term="Elasticsearch" scheme="http://www.yfshare.vip/tags/Elasticsearch/"/>
    
      <category term="查询语法" scheme="http://www.yfshare.vip/tags/%E6%9F%A5%E8%AF%A2%E8%AF%AD%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>Python 读取Mysql生成EXCEL（XLSX）</title>
    <link href="http://www.yfshare.vip/2017/10/16/Python-%E8%AF%BB%E5%8F%96Mysql%E7%94%9F%E6%88%90EXCEL%EF%BC%88XLSX%EF%BC%89/"/>
    <id>http://www.yfshare.vip/2017/10/16/Python-读取Mysql生成EXCEL（XLSX）/</id>
    <published>2017-10-16T15:17:50.000Z</published>
    <updated>2017-10-16T15:21:45.307Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/APlayer.min.js"> </script><script src="/assets/js/DPlayer.min.js"> </script><p>以前做报表从Mysql数据里面提取数据很简单，几条简单的SHELL脚本就可以实现该功能，因为是自己使用，所以对于格式无所谓，以前使用的都是<code>.csv</code>格式，因为其是以<code>逗号</code>区分的，方便脚本处理。这次不一样了，虽然这次接到需求也是从Mysql中导出数据，但是！！导出文件的格式必须是<code>.XLSX</code>这是微软EXCEL软件自有的格式，包含特殊的文件头，所以之前的方法失效了，失效了… 折腾了好久，也请教了别人，终于，终于解决了这个需求。<br><a id="more"></a><br>环境：<br>　　　Centos 7.2.1511<br>　　　Python 2.7.5 -&gt; 3.5</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># python -V</span></div><div class="line">Python 2.7.5</div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#安装easy_install命令</span></div><div class="line">[root@localhost ~]<span class="comment"># wget https://bootstrap.pypa.io/ez_setup.py -O - | python</span></div><div class="line"></div><div class="line"><span class="comment">#安装pip命令(python包管理软件)</span></div><div class="line">[root@localhost ~]<span class="comment"># wget https://pypi.python.org/packages/11/b6/abcb525026a4be042b486df43905d6893fb04f05aac21c32c638e939e447/pip-9.0.1.tar.gz#md5=35f01da33009719497f01a4ba69d63c9</span></div><div class="line">[root@localhost ~]<span class="comment"># tar -zxf pip-9.0.1.tar.gz </span></div><div class="line">[root@localhost ~]<span class="comment"># cd pip-9.0.1</span></div><div class="line">[root@localhost pip-9.0.1]<span class="comment"># python setup.py install</span></div><div class="line"></div><div class="line"><span class="comment">#安装python module</span></div><div class="line">[root@localhost ~]<span class="comment"># python select3.py </span></div><div class="line">Traceback (most recent call last):</div><div class="line">  File <span class="string">"select3.py"</span>, line 3, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    from sqlalchemy import create_engine</div><div class="line">ImportError: No module named sqlalchemy</div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#安装sqlalchemy模块</span></div><div class="line">[root@localhost ~]<span class="comment"># pip install sqlalchemy</span></div><div class="line">Collecting pymysql</div><div class="line">  Downloading PyMySQL-0.7.11-py2.py3-none-any.whl (78kB)</div><div class="line">    100% |████████████████████████████████| 81kB 48kB/s </div><div class="line">Installing collected packages: pymysql</div><div class="line">Successfully installed pymysql-0.7.11</div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#重复执行python select3.py 安装缺失的模块</span></div><div class="line">[root@localhost ~]<span class="comment"># pip install pymysql</span></div><div class="line">[root@localhost ~]<span class="comment"># pip install pandas</span></div><div class="line"></div><div class="line"><span class="comment"># Python 2.7不支持中文，报错如下，需要升级到 Python ，测试 Python 3.5.4 支持</span></div><div class="line">[root@localhost ~]<span class="comment"># python select3.py </span></div><div class="line">Traceback (most recent call last):</div><div class="line">  File <span class="string">"select3.py"</span>, line 10, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    sql.encode(<span class="string">'gb18030'</span>)</div><div class="line">UnicodeDecodeError: <span class="string">'ascii'</span> codec can<span class="string">'t decode byte 0xe6 in position 20: ordinal not in range(128)</span></div><div class="line">[root@localhost ~]#</div></pre></td></tr></table></figure>
<p>升级 Python 2.7.5 至 Python 3.5<br><strong>不要动系统自带的Python，否则系统的某些功能都无法正常使用</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># wget https://www.python.org/ftp/python/3.5.4/Python-3.5.4.tgz</span></div><div class="line">[root@localhost ~]<span class="comment"># yum install openssl-devel -y</span></div><div class="line">[root@localhost ~]<span class="comment"># tar -zxf Python-3.5.4.tgz</span></div><div class="line">[root@localhost ~]<span class="comment"># mkdir -p /usr/local/Python-3.5.4</span></div><div class="line">[root@localhost ~]<span class="comment"># cd Python-3.5.4</span></div><div class="line">[root@localhost Python-3.5.4]<span class="comment"># ./configure --prefix=/usr/local/Python-3.5.4/</span></div><div class="line">[root@localhost Python-3.5.4]<span class="comment"># make &amp;&amp; make install</span></div><div class="line">[root@localhost ~]<span class="comment"># /usr/local/Python-3.5.4/bin/python3.5 -V</span></div><div class="line">Python 3.5.4</div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment"># 现在系统同时存在两个版本的 Python，因此脚本需要的模块需要重新安装，因为Python 3.5.2之后自带 pip3 和 setuptools，因此需要使用 pip3 安装所需要的模块</span></div><div class="line">[root@localhost ~]<span class="comment"># /usr/local/Python-3.5.4/bin/python3.5 select3.py </span></div><div class="line">Traceback (most recent call last):</div><div class="line">  File <span class="string">"select3.py"</span>, line 3, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    from sqlalchemy import create_engine</div><div class="line">ImportError: No module named <span class="string">'sqlalchemy'</span></div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#安装所需要的 Python 模块</span></div><div class="line">[root@localhost ~]<span class="comment"># /usr/local/Python-3.5.4/bin/pip3.5 install sqlalchemy</span></div><div class="line">[root@localhost ~]<span class="comment"># /usr/local/Python-3.5.4/bin/pip3.5 install pymysql</span></div><div class="line">[root@localhost ~]<span class="comment"># /usr/local/Python-3.5.4/bin/pip3.5 install pandas     #这个很慢</span></div><div class="line">[root@localhost ~]<span class="comment"># /usr/local/Python-3.5.4/bin/pip3.5 install openpyxl</span></div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment"># cat /etc/profile.d/Python.sh </span></div><div class="line"><span class="meta">#!/bin/sh</span></div><div class="line">Python3_5_home=<span class="string">'/usr/local/Python-3.5.4'</span></div><div class="line"><span class="built_in">export</span> PATH=<span class="variable">$&#123;Python3_5_home&#125;</span>/bin:<span class="variable">$PATH</span></div><div class="line">[root@localhost ~]<span class="comment"># source /etc/profile.d/Python.sh</span></div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment"># /usr/local/Python-3.5.4/bin/python3.5 select3.py</span></div><div class="line">[root@localhost ~]<span class="comment"># ll | grep output.xlsx </span></div><div class="line">-rw-r--r--   1 root root      4854 Oct 15 06:37 output.xlsx</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/7B8F09CFC0CF45BCAD07916AA8A1CAFB?method=download&amp;shareKey=974173e2da4dc8ec9df2e29c1973427e" alt="Py_mysql_to_excel">  </p>
<p>如果报这个错，好像是 <code>查询SQL</code> 时超时了，在同级目录下会生成 <code>__pycache__</code>文件夹，脚本换个目录（不要在含有<code>__pycache__</code>这个目录的目录中执行 py脚本），然后删掉其父目录，再执行 py 脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">Traceback (most recent call last):</div><div class="line">  File <span class="string">"/usr/local/Python-3.5.4/lib/python3.5/site-packages/pandas/compat/__init__.py"</span>, line 47, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    import __builtin__ as builtins</div><div class="line">ImportError: No module named <span class="string">'__builtin__'</span></div><div class="line"></div><div class="line">During handling of the above exception, another exception occurred:</div><div class="line"></div><div class="line">Traceback (most recent call last):</div><div class="line">  File <span class="string">"select.py </span></div><div class="line"></div><div class="line">", line 4, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    import pymysql</div><div class="line">  File <span class="string">"/usr/local/Python-3.5.4/lib/python3.5/site-packages/pymysql/__init__.py"</span>, line 92, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    from . import connections as _orig_conn</div><div class="line">  File <span class="string">"/usr/local/Python-3.5.4/lib/python3.5/site-packages/pymysql/connections.py </span></div><div class="line"></div><div class="line">", line 13, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    import socket</div><div class="line">  File <span class="string">"/usr/local/Python-3.5.4/lib/python3.5/socket.py </span></div><div class="line"></div><div class="line">", line 52, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    import os, sys, io, selectors</div><div class="line">  File <span class="string">"/usr/local/Python-3.5.4/lib/python3.5/selectors.py </span></div><div class="line"></div><div class="line">", line 11, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    import select</div><div class="line">  File <span class="string">"/data/soros/job/report/jinrongban_data_back/test/select.py </span></div><div class="line"></div><div class="line">", line 5, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    import pandas as pd</div><div class="line">  File <span class="string">"/usr/local/Python-3.5.4/lib/python3.5/site-packages/pandas/__init__.py"</span>, line 23, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    from pandas.compat.numpy import *</div><div class="line">  File <span class="string">"/usr/local/Python-3.5.4/lib/python3.5/site-packages/pandas/compat/__init__.py"</span>, line 60, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    import http.client as httplib</div><div class="line">  File <span class="string">"/usr/local/Python-3.5.4/lib/python3.5/http/client.py </span></div><div class="line"></div><div class="line">", line 739, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    class HTTPConnection:</div><div class="line">  File <span class="string">"/usr/local/Python-3.5.4/lib/python3.5/http/client.py </span></div><div class="line"></div><div class="line">", line 749, <span class="keyword">in</span> HTTPConnection</div><div class="line">    def __init__(self, host, port=None, timeout=socket._GLOBAL_DEFAULT_TIMEOUT,</div><div class="line">AttributeError: module <span class="string">'socket'</span> has no attribute <span class="string">'_GLOBAL_DEFAULT_TIMEOUT'</span></div></pre></td></tr></table></figure></p>
<p>Python脚本：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># cat select3.py</span></div><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment">#-*- coding: utf8 -*-</span></div><div class="line">from sqlalchemy import create_engine</div><div class="line">import pymysql</div><div class="line">import pandas as pd</div><div class="line">from pandas import DataFrame,Series</div><div class="line"></div><div class="line">engine=create_engine(<span class="string">'mysql+pymysql://username:password@192.168.1.1/database_name?charset=gbk,pool_timeout=3000'</span>)</div><div class="line">sql=<span class="string">"select count(*) as '总数' from database.table1;"</span></div><div class="line">sql.encode(<span class="string">'gb18030'</span>)</div><div class="line">df=pd.read_sql(sql,engine)</div><div class="line">writer = pd.ExcelWriter(<span class="string">'/root/output.xlsx'</span>)</div><div class="line">df.to_excel(writer,<span class="string">'Sheet1'</span>,index=False)</div><div class="line">writer.save()</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>附件：<br><a href="http://note.youdao.com/yws/api/personal/file/E1F6B7761791434088E5695A6FD9F129?method=download&amp;shareKey=91d60ea9e7ec086373e91948ff2c6038" target="_blank" rel="external">Python-3.5.4.tar.gz</a><br><a href="http://note.youdao.com/yws/api/personal/file/B4252F91B6C44921BDFB59666FBB099F?method=download&amp;shareKey=3217d852ff44cf5c33a44c442eacf32c" target="_blank" rel="external">select3.py</a><br><a href="http://note.youdao.com/yws/api/personal/file/A971448108714F66B09900242EAD747D?method=download&amp;shareKey=5a644f1f069d121d8b1f356013aeb84e" target="_blank" rel="external">numpy-1.13.3-cp35-cp35m-manylinux1_x86_64.whl</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/10/16/Python-读取Mysql生成EXCEL（XLSX）/">http://www.yfshare.vip/2017/10/16/Python-读取Mysql生成EXCEL（XLSX）/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;以前做报表从Mysql数据里面提取数据很简单，几条简单的SHELL脚本就可以实现该功能，因为是自己使用，所以对于格式无所谓，以前使用的都是&lt;code&gt;.csv&lt;/code&gt;格式，因为其是以&lt;code&gt;逗号&lt;/code&gt;区分的，方便脚本处理。这次不一样了，虽然这次接到需求也是从Mysql中导出数据，但是！！导出文件的格式必须是&lt;code&gt;.XLSX&lt;/code&gt;这是微软EXCEL软件自有的格式，包含特殊的文件头，所以之前的方法失效了，失效了… 折腾了好久，也请教了别人，终于，终于解决了这个需求。&lt;br&gt;
    
    </summary>
    
      <category term="Python" scheme="http://www.yfshare.vip/categories/Python/"/>
    
    
      <category term="Mysql" scheme="http://www.yfshare.vip/tags/Mysql/"/>
    
      <category term="Python" scheme="http://www.yfshare.vip/tags/Python/"/>
    
      <category term="Excel" scheme="http://www.yfshare.vip/tags/Excel/"/>
    
      <category term="Xlsx" scheme="http://www.yfshare.vip/tags/Xlsx/"/>
    
  </entry>
  
  <entry>
    <title>Zabbix监控redis</title>
    <link href="http://www.yfshare.vip/2017/09/10/Zabbix%E7%9B%91%E6%8E%A7redis/"/>
    <id>http://www.yfshare.vip/2017/09/10/Zabbix监控redis/</id>
    <published>2017-09-10T12:55:10.000Z</published>
    <updated>2017-09-10T12:57:51.573Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/APlayer.min.js"> </script><script src="/assets/js/DPlayer.min.js"> </script><p>Zabbix监控Redis<br><a id="more"></a><br>环境：<br>　　　Centos 7.3<br>　　　Zabbix version : 3.0.2<br>　　　Redis version : 3.2.5  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#监控脚本</span></div><div class="line">[root@localhost ~]<span class="comment"># cd /etc/zabbix/scripts/</span></div><div class="line">[root@localhost scripts]<span class="comment"># ls</span></div><div class="line">check_redis.sh</div><div class="line">[root@localhost scripts]<span class="comment"># cat check_redis.sh </span></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">PORT=<span class="string">'6379'</span></div><div class="line">STATUS_redis=`/bin/redis-cli -h <span class="string">'192.168.1.1'</span> -p <span class="variable">$PORT</span> <span class="_">-a</span> redis_password ping`</div><div class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$STATUS_redis</span>"</span> == <span class="string">'PONG'</span> ];<span class="keyword">then</span></div><div class="line">	<span class="built_in">echo</span> <span class="string">'1'</span></div><div class="line"><span class="keyword">else</span></div><div class="line">	<span class="built_in">echo</span> <span class="string">'0'</span></div><div class="line"><span class="keyword">fi</span></div><div class="line">[root@localhost scripts]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#zabbix agent</span></div><div class="line">[root@localhost ~]<span class="comment"># cd /etc/zabbix/zabbix_agentd.d/</span></div><div class="line">[root@localhost zabbix_agentd.d]<span class="comment"># cat userparameter_redis.conf </span></div><div class="line">UserParameter=redis_status[*],/bin/redis-cli -h <span class="string">'192.168.1.1'</span> -p <span class="variable">$1</span> <span class="_">-a</span> redis_password info | grep -w <span class="variable">$2</span> | awk -F<span class="string">':'</span> <span class="string">'&#123;print $NF&#125;'</span></div><div class="line">UserParameter=redis_ping,sh /etc/zabbix/scripts/check_redis.sh</div><div class="line">[root@localhost zabbix_agentd.d]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment"># systemctl restart zabbix-agent</span></div><div class="line">[root@localhost ~]<span class="comment"># zabbix_get -s localhost -k redis_ping</span></div><div class="line">1</div><div class="line">[root@localhost ~]<span class="comment"># zabbix_get -s localhost -k redis_status[6379,used_memory]</span></div><div class="line">1210708664</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>把修改后的模版链接到主机上<br><img src="http://note.youdao.com/yws/api/personal/file/CC389D2BC7B64E31AC375564D51DFFDD?method=download&amp;shareKey=f62b62d5785e6b5d59091beb1a84e087" alt="Zabbix Monitor Redis"><br><img src="http://note.youdao.com/yws/api/personal/file/4B422DF4096E4BB29C95C36C94BB17A2?method=download&amp;shareKey=ed5f2e64d8d7999e4daf559e6c48c10f" alt="Zabbix Monitor Redis"><br><img src="http://note.youdao.com/yws/api/personal/file/70AC5B37AF304881A771259522ACF1AE?method=download&amp;shareKey=24338b2339b17eddff0fa60d721d07f9" alt="Zabbix Monitor Redis"><br><img src="http://note.youdao.com/yws/api/personal/file/F043F5ABCE964C9A88B7DC1D4BE4E600?method=download&amp;shareKey=78a2dd918ea6d15bbbfc7a003fd8fc1c" alt="Zabbix Monitor Redis"><br><img src="http://note.youdao.com/yws/api/personal/file/965860E7F3C343109324312F17CF0C42?method=download&amp;shareKey=58fe3b21783cc6c81cdeccbff4ffe9c8" alt="Zabbix Monitor Redis"><br><img src="http://note.youdao.com/yws/api/personal/file/6D2C578CB4C1406AB0C7201AAAF18CE8?method=download&amp;shareKey=ce1f49d596164110225afdf819ae1ca3" alt="Zabbix Monitor Redis"><br><img src="http://note.youdao.com/yws/api/personal/file/A210C26E59984F99936F36C525E225A3?method=download&amp;shareKey=a87e00f9930183e621c0300a0745a9ef" alt="Zabbix Monitor Redis">  </p>
<p>参考：<a href="http://blog.hackroad.com/operations-engineer/linux_server/11019.html" target="_blank" rel="external">http://blog.hackroad.com/operations-engineer/linux_server/11019.html</a><br><a href="http://www.cnblogs.com/gnuhpc/p/4609592.html" target="_blank" rel="external">http://www.cnblogs.com/gnuhpc/p/4609592.html</a>  </p>
<p>附件：<br><a href="http://note.youdao.com/yws/api/personal/file/E9122E61EE1E48E78C30C36C458A83FC?method=download&amp;shareKey=09aa40c7a459918803a8f76566c9865c" target="_blank" rel="external">Zabbix监控redis模版6379</a><br>注：这个redis监控脚本需要根据实际情况修改  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/09/10/Zabbix监控redis/">http://www.yfshare.vip/2017/09/10/Zabbix监控redis/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Zabbix监控Redis&lt;br&gt;
    
    </summary>
    
      <category term="Zabbix" scheme="http://www.yfshare.vip/categories/Zabbix/"/>
    
    
      <category term="zabbix" scheme="http://www.yfshare.vip/tags/zabbix/"/>
    
      <category term="redis" scheme="http://www.yfshare.vip/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Zookeeper运维经验分享[转]</title>
    <link href="http://www.yfshare.vip/2017/09/04/Zookeeper%E8%BF%90%E7%BB%B4%E7%BB%8F%E9%AA%8C%E5%88%86%E4%BA%AB-%E8%BD%AC/"/>
    <id>http://www.yfshare.vip/2017/09/04/Zookeeper运维经验分享-转/</id>
    <published>2017-09-04T14:02:10.000Z</published>
    <updated>2017-09-10T12:59:37.372Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/APlayer.min.js"> </script><script src="/assets/js/DPlayer.min.js"> </script><p>　　Zookeeper是一个分布式协调框架，有不错的性能，也经过许多公司的验证，所以在很多场景都有使用。大家一般用Zookeeper来实现服务发现(类似DNS)，配置管理，分布式锁，leader选举等。在这些场景中，Zookeeper成为了一个被依赖的核心组件，Zookeeper的稳定性是需要特别关注的<br><a id="more"></a><br>　　去哪儿网也在很多场景依赖Zookeeper，所以我们也一直在摸索怎么更好的运维稳定的Zookeeper集群。在过去的几年我们也踩过一些坑，也因为Zookeeper导致了故障。现在将我们运维Zookeeper集群的一些经验分享，也欢迎大家提供更好的建议<br>　　那么在打算运维一套Zookeeper集群之前，我们先了解一些Zookeeper的基本原理<br>　　集群里分三种角色: Leader,Follower和Observer。Leader和Follower参与投票，Observer只会『听』投票的结果，不参与投票  </p>
<p>　　投票集群里的节点数要求是奇数  </p>
<ol>
<li>一个集群容忍挂掉的节点数的等式为 <code>N=2F +1</code>，N为投票集群节点数，F为能同时容忍失败节点数。比如一个三节点集群，可以挂掉一个节点，5节点集群可以挂掉两个…  </li>
<li>一个写操作需要半数以上的节点ack，所以集群节点数越多，整个集群可以抗挂点的节点数越多(越可靠)，但是吞吐量越差  </li>
</ol>
<p>　　Zookeeper里所有节点以及节点的数据都会放在内存里，形成一棵树的数据结构。并且定时的dump snapshot到磁盘<br>　　Zookeeper的Client与Zookeeper之间维持的是长连接，并且保持心跳，Client会与Zookeeper之间协商出一个Session超时时间出来(其实就是Zookeeper Server里配置了最小值，最大值，如果client的值在这两个值之间则采用client的，小于最小值就是最小值，大于最大值就用最大值)，如果在Session超时时间内没有收到心跳，则该Session过期<br>　　Client可以watch Zookeeper那个树形数据结构里的某个节点或数据，当有变化的时候会得到通知  </p>
<p>有了这些了解后，那么我们心里其实有底了  </p>
<h2 id="最小生产集群"><a href="#最小生产集群" class="headerlink" title="最小生产集群"></a>最小生产集群</h2><p>　　要确保Zookeeper能够稳定运行，那么就需要确保投票能够正常进行，最好不要挂一个节点整个就不work了，所以我们一般要求最少5个节点部署。</p>
<h2 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h2><p>　　除了节点外，我们还要看不能一台物理机器，一个机柜或一个交换机挂掉然后影响了整个集群，所以节点的网络结构也要考虑。这个可能就比很多应用服务器的要求更加严格。</p>
<h2 id="分Group，保护核心Group"><a href="#分Group，保护核心Group" class="headerlink" title="分Group，保护核心Group"></a>分Group，保护核心Group</h2><p>　　要确保Zookeeper整个集群可靠运行，就是要确保投票集群可靠。那在我们这里，将一个Zookeeper集群划分为多个小的Group，我们称Leader+Follower为核心Group，核心Group我们一般是不向外提供服务的，然后我们会根据不同的业务再加一些Observer，比如一个Zookeeper集群为服务发现，消息，定时任务三个不同的组件提供服务，那么我们为建立三个Observer Group，分别给这三个组件使用，而Client只会连接分配给它的Observer Group，不去连接核心Group。这样核心Group就不会给Client提供长连接服务，也不负责长连接的心跳，这大大的减轻了核心Group的压力，因为在实际环境中，一个Zookeeper集群要为上万台机器提供服务，维持长连接和心跳还是要消耗一定的资源的。因为Observer是不参与投票的所以加Observer并不会降低整体的吞吐量，而且Observer挂掉不会影响整个集群的健康  </p>
<p>但是这里要注意的是，分Observer Group只能解决部分问题，因为毕竟所有的写入还是要交给核心Group来处理的，所以对于写入量特别大的应用来说，还是需要进行集群上的隔离，比如Storm和Kafka就对Zookeeper压力比较大，你就不能将其与服务发现的集群放在一起  </p>
<h2 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h2><p>因为Zookeeper将所有数据都放在内存里，所以对JVM以及机器的内存也要预先计划，如果出现Swap那将严重的影响Zookeeper集群的性能，所以我一般不怎么推荐将Zookeeper用作通用的配置管理服务。因为一般配置数据还是挺大的，这些全部放在内存里不太可控。</p>
<h2 id="日志清理"><a href="#日志清理" class="headerlink" title="日志清理"></a>日志清理</h2><p>因为Zookeeper要频繁的写txlog(Zookeeper写的一种顺序日志)以及定期dump内存snapshot到磁盘，这样磁盘占用就越来越大，所以Zookeeper提供了清理这些文件的机制，但是这种机制并不太合理，它只能设置间隔多久清理，而不能设置具体的时间段。那么就有可能碰到高峰期间清理，所以建议将其关闭:<code>autopurge.purgeInterval=0</code>。然后使用crontab等机制，在业务低谷的时候清理。</p>
<h2 id="日志，jvm配置"><a href="#日志，jvm配置" class="headerlink" title="日志，jvm配置"></a>日志，jvm配置</h2><p>从官网直接下载的包如果直接启动运行是很糟糕的，这个包默认的配置日志是不会轮转的，而且是直接输出到终端。我们最开始并不了解这点，然后运行一段时间后发现生成一个庞大的zookeeper.out的日志文件。除此之外，这个默认配置还没有设置任何jvm相关的参数(所以堆大小是个默认值)，这也是不可取的。那么有的同学说那我去修改Zookeeper的启动脚本吧。最好不要这样做，Zookeeper会加载conf文件夹下一个名为<code>zookeeper-env.sh</code>的脚本，所以你可以将一些定制化的配置写在这里，而不是直接去修改Zookeeper自带的脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">　　<span class="comment">#!/usr/bin/env bash</span></div><div class="line">　　JAVA_HOME= <span class="comment">#java home</span></div><div class="line">　　ZOO_LOG_DIR= <span class="comment">#日志文件放置的路径</span></div><div class="line">　　ZOO_LOG4J_PROP=<span class="string">"INFO,ROLLINGFILE"</span> <span class="comment">#设置日志轮转</span></div><div class="line">　　JVMFLAGS=<span class="string">"jvm的一些设置，比如堆大小，开gc log等"</span></div></pre></td></tr></table></figure></p>
<h2 id="地址"><a href="#地址" class="headerlink" title="地址"></a>地址</h2><p>在实际环境中，我们可能因为各种原因比如机器过保，硬件故障等需要迁移Zookeeper集群，所以Zookeeper的地址是一个很头痛的事情。这个地址有两方面，第一个是提供给Client的地址，建议这个地址通过配置的方式下发，不要让使用方直接使用，这一点我们前期做的不好。另外一个是集群配置里，集群之间需要通讯，也需要地址。我们的处理方式是设置hosts:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">192.168.1.20 zk1</div><div class="line">192.168.1.21 zk2</div><div class="line">192.168.1.22 zk3</div></pre></td></tr></table></figure></p>
<p>在配置里:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">server.1=zk1:2081:3801</div><div class="line">server.2=zk2:2801:3801</div><div class="line">server.3=zk3:2801:3801</div></pre></td></tr></table></figure></p>
<p>这样在需要迁移的时候，我们停老的节点，起新的节点只需要修改hosts映射就可以了。比如现在server.3需要迁移，那我们在hosts里将zk3映射到新的ip地址。但是对于java有一个问题是，java默认会永久缓存DNS cache，即使你将zk3映射到别的ip，如果并不重启server.1, server.2，它是不会解析到新的ip的，这个需要修改<code>$JAVA_HOME/jre/lib/security/java.security</code>文件里的<code>networkaddress.cache.ttl=60</code>，将其修改为一个比较小的数。<br>　　对于这个迁移的问题，我们还遇到一个比较尴尬的情况，在最后的坑里会有提及  </p>
<h2 id="日志位置"><a href="#日志位置" class="headerlink" title="日志位置"></a>日志位置</h2><p>Zookeeper主要产生三种IO:txlog(每个写操作，包括新Session都会记录一条log)，Snapshot以及运行的应用日志。一般建议将这三个IO分散到三个不同的盘上。不过我们倒是一直没有这么实验过，我们的Zookeeper也是运行在虚拟机(一般认为虚拟机IO较差)上  </p>
<h2 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h2><p>我们对Zookeeper做了这样一些监控:  </p>
<ol>
<li>是否可写。 就是一个定时任务定时的去创建节点，删节点等操作。这里要注意的是Zookeeper是一个集群，我们监控的时候我还是希望对单个节点做监控，所以这些操作的时候不要连接整个集群，而是直接去连接单个节点</li>
<li>监控watcher数和连接数，特别是这两个数据有较大波动的时候，可以发现使用方是否有误用的情况</li>
<li>网络流量以及client ip，这个会记录到监控系统里，这样很快能发现『害群之马』</li>
</ol>
<h2 id="一些使用建议"><a href="#一些使用建议" class="headerlink" title="一些使用建议"></a>一些使用建议</h2><ol>
<li>不要强依赖Zookeeper，也就是Zookeeper出现问题业务已然可以正常运行。Zookeeper是一个分布式的协调框架，主要做的事情就是分布式环境的一致性。这是一个非常苛刻的事情，所以它的稳定性受很多方面的影响。比如我们常常使用Zookeeper做服务发现，那么服务发现其实是不需要严格的一致性的，我们可以缓存server list，当Zookeeper出现问题的时候已然可以正常工作，在这方面etcd要做的更好一些，Zookeeper如果出现分区，少数派是不能提供任何服务的，读都不可以，而etcd的少数派仍然可以提供读服务，这在服务发现的时候还是不错的</li>
<li>不要将很多东西塞到Zookeeper里，这个上面已经提到过</li>
<li>不要使用Zookeeper做细粒度锁，比如很多业务在订单这个粒度上使用Zookeeper做分布式锁，这会频繁的和Zookeeper交互，对Zookeeper压力较大，而且一旦出现问题影响面广。但是可以使用粗粒度的锁(其实leader选举也是一种锁)</li>
<li>不建议做通用配置的第二个理由是，通用配置要提供给特别多特别多系统使用，而且一些公共配置甚至所有系统都会使用，一旦这样的配置发生变更，Zookeeper会广播给所有的watcher，然后所有Client都来拉取，瞬间造成非常大的网络流量，引起所谓的『惊群』。而自己实现通用配置系统的时候，一般会对这种配置采取排队或分批通知的方式</li>
</ol>
<h2 id="一些坑"><a href="#一些坑" class="headerlink" title="一些坑"></a>一些坑</h2><ol>
<li><p>zookeeper client 3.4.5 ping时间间隔算法有问题，在遇到网络抖动等原因导致一次ping失败后会断开连接。3.4.6解决了这个问题 Bug1751</p>
</li>
<li><p>zookeeper client如果因为网络抖动断开了连接，如果后来又重连上了，zookeeper client会自动的将之前订阅的watcher等又全部订阅一遍，而Zookeeper默认对单个数据包的大小有个1M的限制，这往往就会超限，最后导致一直不断地的重试。这个问题在较新的版本得到了修复。Bug706</p>
</li>
<li><p>抛出<code>UnresolvedAddressException</code>异常导致Zookeeper选举线程退出，整个集群无法再选举，处于崩溃的边缘。这个问题是，某次OPS迁移机器，将老的机器回收了，所以老的机器的IP和机器名不复存在，最后抛出UnresolvedAddressException这个异常，而Zookeeper的选举线程(<code>QuorumCnxManager类里的Listener</code>)只捕获了IOException，导致该线程退出，该线程一旦退出只要现在的leader出现问题，需要重新选举，则不会选出新的leader来，整个集群就会崩溃。Bug2319(PS，这个bug是我report的)</p>
</li>
</ol>
<p>参考：<a href="http://www.cnblogs.com/seaspring/p/6099750.html" target="_blank" rel="external">http://www.cnblogs.com/seaspring/p/6099750.html</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/09/04/Zookeeper运维经验分享-转/">http://www.yfshare.vip/2017/09/04/Zookeeper运维经验分享-转/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;　　Zookeeper是一个分布式协调框架，有不错的性能，也经过许多公司的验证，所以在很多场景都有使用。大家一般用Zookeeper来实现服务发现(类似DNS)，配置管理，分布式锁，leader选举等。在这些场景中，Zookeeper成为了一个被依赖的核心组件，Zookeeper的稳定性是需要特别关注的&lt;br&gt;
    
    </summary>
    
      <category term="WEB" scheme="http://www.yfshare.vip/categories/WEB/"/>
    
    
      <category term="Linux" scheme="http://www.yfshare.vip/tags/Linux/"/>
    
      <category term="zookeeper" scheme="http://www.yfshare.vip/tags/zookeeper/"/>
    
  </entry>
  
  <entry>
    <title>Zabbix监控磁盘IO</title>
    <link href="http://www.yfshare.vip/2017/08/28/Zabbix%E7%9B%91%E6%8E%A7%E7%A3%81%E7%9B%98IO/"/>
    <id>http://www.yfshare.vip/2017/08/28/Zabbix监控磁盘IO/</id>
    <published>2017-08-28T12:33:21.000Z</published>
    <updated>2017-08-28T12:54:57.382Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/APlayer.min.js"> </script><script src="/assets/js/DPlayer.min.js"> </script><p>IOSTAT获取磁盘性能参数后，通过Zabbix Agent传值给Zabbix Server即可<br><a id="more"></a></p>
<h1 id="IOSTAT"><a href="#IOSTAT" class="headerlink" title="IOSTAT"></a>IOSTAT</h1><p>单独执行iostat，显示的结果为从系统开机到当前执行时刻的统计信息。以上输出中，除最上面指示系统版本、主机名和日期的一行外，另有两部分：  </p>
<ul>
<li>avg-cpu: 总体cpu使用情况统计信息，对于多核cpu，这里为所有cpu的平均值;  </li>
<li>Device: 各磁盘设备的IO统计信息.  </li>
</ul>
<p>环境：<br>　　　Centos 7.3<br>　　　Zabbix 3.0<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># iostat </span></div><div class="line">Linux 3.10.0-123.9.3.el7.x86_64 (uulend-Sstones-250) 	08/27/2017 	_x86_64_	(4 CPU)</div><div class="line"></div><div class="line">avg-cpu:  %user   %nice %system %iowait  %steal   %idle</div><div class="line">           7.05    0.00    1.52    8.46    0.00   82.96</div><div class="line"></div><div class="line">Device:            tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtn</div><div class="line">vda               8.53        23.92       101.76  190838701  811715460</div><div class="line">vdb            1508.27      8334.43       896.07 66480462117 7147631044</div><div class="line">dm-0             11.32       135.41       181.72 1080084008 1449488199</div><div class="line">dm-1              0.02         0.07         0.08     563269     645028</div><div class="line">dm-2              0.04         0.35         0.45    2825226    3588173</div><div class="line">vdc               0.86        58.49        65.16  466571469  519767308</div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># iostat -dxkt</span></div><div class="line">Linux 3.10.0-123.9.3.el7.x86_64 (uulend-Sstones-250) 	08/27/2017 	_x86_64_	(4 CPU)</div><div class="line"></div><div class="line">08/27/2017 08:02:50 PM</div><div class="line">Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util</div><div class="line">vda               0.02     3.27    2.05    6.48    23.93   101.79    29.48     0.02    2.91    3.63    2.69   0.80   0.68</div><div class="line">vdb               0.10   105.55 1436.35   72.02  8334.63   896.07    12.24     0.29    0.19    0.15    1.12   0.21  31.72</div><div class="line">dm-0              0.00     0.00    3.36    7.96   135.39   181.69    56.02     0.04    3.28    2.77    3.49   0.62   0.70</div><div class="line">dm-1              0.00     0.00    0.00    0.01     0.07     0.08    18.98     0.00    4.70    2.55    5.31   3.70   0.01</div><div class="line">dm-2              0.00     0.00    0.02    0.02     0.35     0.45    38.14     0.00    3.58    1.41    6.00   2.56   0.01</div><div class="line">vdc               0.00     0.19    0.60    0.25    58.61    65.29   288.35     0.05   59.65    2.49  195.64   2.03   0.17</div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<ul>
<li>rrqm/s: 每秒对该设备的读请求被合并次数，文件系统会对读取同块(block)的请求进行合并</li>
<li>wrqm/s: 每秒对该设备的写请求被合并次数</li>
<li>r/s: 每秒完成的读次数</li>
<li>w/s: 每秒完成的写次数</li>
<li>rkB/s: 每秒读数据量(kB为单位)</li>
<li>wkB/s: 每秒写数据量(kB为单位)</li>
<li>avgrq-sz:平均每次IO操作的数据量(扇区数为单位)</li>
<li>avgqu-sz: 平均等待处理的IO请求队列长度</li>
<li>await: 平均每次IO请求等待时间(包括等待时间和处理时间，毫秒为单位)</li>
<li>svctm: 平均每次IO请求的处理时间(毫秒为单位)</li>
<li>%util: 采用周期内用于IO操作的时间比率，即IO队列非空的时间比率</li>
</ul>
<h1 id="Zabbix监控"><a href="#Zabbix监控" class="headerlink" title="Zabbix监控"></a>Zabbix监控</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#扫描磁盘</span></div><div class="line">[root@localhost ~]<span class="comment"># cd /etc/zabbix/scripts/</span></div><div class="line">[root@localhost scripts]<span class="comment"># cat disk_scan.sh </span></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">diskarray=(`cat /proc/diskstats |grep -E <span class="string">"\bvd[abcdefg]\b|\bvd[abcdefg]\b"</span>|grep -i <span class="string">"\b<span class="variable">$1</span>\b"</span>|awk <span class="string">'&#123;print $3&#125;'</span>|sort|uniq   </div><div class="line">2&gt;/dev/null`)length=<span class="variable">$&#123;#diskarray[@]&#125;</span></div><div class="line"><span class="built_in">printf</span> <span class="string">"&#123;\n"</span></div><div class="line"><span class="built_in">printf</span>  <span class="string">'\t'</span><span class="string">"\"data\":["</span></div><div class="line"><span class="keyword">for</span> ((i=0;i&lt;<span class="variable">$length</span>;i++))</div><div class="line"><span class="keyword">do</span></div><div class="line">         <span class="built_in">printf</span> <span class="string">'\n\t\t&#123;'</span></div><div class="line">         <span class="built_in">printf</span> <span class="string">"\"&#123;#DISKNAME&#125;\":\"<span class="variable">$&#123;diskarray[$i]&#125;</span>\"&#125;"</span></div><div class="line">         <span class="keyword">if</span> [ <span class="variable">$i</span> <span class="_">-lt</span> $[<span class="variable">$length</span>-1] ];<span class="keyword">then</span></div><div class="line">                 <span class="built_in">printf</span> <span class="string">','</span></div><div class="line">         <span class="keyword">fi</span></div><div class="line"><span class="keyword">done</span></div><div class="line"><span class="built_in">printf</span>  <span class="string">"\n\t]\n"</span></div><div class="line"><span class="built_in">printf</span> <span class="string">"&#125;\n"</span></div><div class="line">[root@localhost scripts]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#执行结果</span></div><div class="line">[root@localhost scripts]<span class="comment"># sh disk_scan.sh </span></div><div class="line">&#123;</div><div class="line">	<span class="string">"data"</span>:[</div><div class="line">		&#123;<span class="string">"&#123;#DISKNAME&#125;"</span>:<span class="string">"vda"</span>&#125;,</div><div class="line">		&#123;<span class="string">"&#123;#DISKNAME&#125;"</span>:<span class="string">"vdb"</span>&#125;,</div><div class="line">		&#123;<span class="string">"&#123;#DISKNAME&#125;"</span>:<span class="string">"vdc"</span>&#125;</div><div class="line">	]</div><div class="line">&#125;</div><div class="line">[root@localhost scripts]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#获取磁盘性能参数</span></div><div class="line">[root@localhost scripts]<span class="comment"># cat disk_status.sh </span></div><div class="line"><span class="comment">#/bin/sh</span></div><div class="line">device=<span class="variable">$1</span></div><div class="line">item=<span class="variable">$2</span></div><div class="line"><span class="keyword">case</span> <span class="variable">$item</span> <span class="keyword">in</span></div><div class="line">          rps)</div><div class="line">            iostat -dxkt |grep <span class="string">"\b<span class="variable">$device</span>\b"</span>|tail -1|awk <span class="string">'&#123;print $4&#125;'</span></div><div class="line">            ;;</div><div class="line">          wps)</div><div class="line">            iostat -dxkt |grep <span class="string">"\b<span class="variable">$device</span>\b"</span> |tail -1|awk <span class="string">'&#123;print $5&#125;'</span></div><div class="line">            ;;</div><div class="line">         util)</div><div class="line">            iostat -dxkt |grep <span class="string">"\b<span class="variable">$device</span>\b"</span> |tail -1|awk <span class="string">'&#123;print $NF&#125;'</span></div><div class="line">	    ;;</div><div class="line">         idle)</div><div class="line">            iostat -x | grep -iA1 <span class="string">"\b<span class="variable">$device</span>\b"</span> | tail -1 | awk <span class="string">'&#123;print $NF&#125;'</span></div><div class="line">	    ;;</div><div class="line">         iowait)</div><div class="line">	   iostat -x | grep -iA1 <span class="string">"\b<span class="variable">$device</span>\b"</span> | tail -1 | awk <span class="string">'&#123;print $(NF-2)&#125;'</span></div><div class="line">	   ;;</div><div class="line"><span class="keyword">esac</span></div><div class="line">[root@localhost scripts]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#执行结果</span></div><div class="line">[root@Localhost scripts]<span class="comment"># sh disk_status.sh vda idle</span></div><div class="line">31.72</div><div class="line">[root@Localhost scripts]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#配置Zabbix Agent</span></div><div class="line">[root@localhost ~]<span class="comment"># cd /etc/zabbix/zabbix_agentd.d/</span></div><div class="line">[root@localhost zabbix_agentd.d]<span class="comment"># cat userparameter_io.conf </span></div><div class="line">UserParameter=disk.scandisk[*],sh /etc/zabbix/scripts/disk_scan.sh <span class="variable">$1</span>     <span class="comment">#扫描磁盘</span></div><div class="line">UserParameter=disk.status[*],sh /etc/zabbix/scripts/disk_status.sh <span class="variable">$1</span> <span class="variable">$2</span></div><div class="line">[root@localhost zabbix_agentd.d]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment"># systemctl restart zabbix-agent</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#测试zabbix是否可以成功获取</span></div><div class="line">[root@localhost ~]<span class="comment"># zabbix_get -s localhost -k disk.scandisk </span></div><div class="line">&#123;</div><div class="line">	<span class="string">"data"</span>:[</div><div class="line">		&#123;<span class="string">"&#123;#DISKNAME&#125;"</span>:<span class="string">"vda"</span>&#125;,</div><div class="line">		&#123;<span class="string">"&#123;#DISKNAME&#125;"</span>:<span class="string">"vdb"</span>&#125;,</div><div class="line">		&#123;<span class="string">"&#123;#DISKNAME&#125;"</span>:<span class="string">"vdc"</span>&#125;</div><div class="line">	]</div><div class="line">&#125;</div><div class="line">[root@localhost ~]<span class="comment"># zabbix_get -s localhost -k disk.status[vdb,util]</span></div><div class="line">31.72</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h1 id="配置Zabbix-Monitor"><a href="#配置Zabbix-Monitor" class="headerlink" title="配置Zabbix Monitor"></a>配置Zabbix Monitor</h1><p><img src="http://note.youdao.com/yws/api/personal/file/302C8142A5E84F86A3CA4F2D9FE31FE3?method=download&amp;shareKey=a34e00f62d858c86e8e4cf27883183e0" alt="Zabbix_Monitor_IO"><br><img src="http://note.youdao.com/yws/api/personal/file/298BDD98D0C0492FBD8EA5F1282BCE06?method=download&amp;shareKey=62816d1fc6134ce646a1857d45eeccdc" alt="Zabbix_Monitor_IO"><br><img src="http://note.youdao.com/yws/api/personal/file/91F87F396B214134B726998F9DBDE87B?method=download&amp;shareKey=7daab8e18b9f4273ae6f1d1d7ba0aa31" alt="Zabbix_Monitor_IO"><br><img src="http://note.youdao.com/yws/api/personal/file/2AA561496DC94AC4A4EBF1B6686461E4?method=download&amp;shareKey=5e3ce4c0db0c7de96b9f6153cc3ac5ad" alt="Zabbix_Monitor_IO"><br><img src="http://note.youdao.com/yws/api/personal/file/5358F7E7605D4383A16DD2B1BC6F1D8F?method=download&amp;shareKey=dbdec5d3eee57a154f3aea78b9c98367" alt="Zabbix_Monitor_IO"><br><img src="http://note.youdao.com/yws/api/personal/file/0AE9A738B7004E5FBB81E2AF0B188EBC?method=download&amp;shareKey=cb829ffe4bfa9684c9749348a9dab05b" alt="Zabbix_Monitor_IO"><br><img src="http://note.youdao.com/yws/api/personal/file/2EFF3C30EAFB4711B0B38C0DC35DCE18?method=download&amp;shareKey=d4b74e913ed6aa7fb05792a31311c902" alt="Zabbix_Monitor_IO"><br><img src="http://note.youdao.com/yws/api/personal/file/A46A860CF9AB416CA31C51BBF3F467FE?method=download&amp;shareKey=81342d2dd0bf6aeab5e27ea956875c5d" alt="Zabbix_Monitor_IO"><br><img src="http://note.youdao.com/yws/api/personal/file/D275B83007C144E894341D7B84ADAAEA?method=download&amp;shareKey=77ebaa7110ee6fd36f1c706ebf3ecd68" alt="Zabbix_Monitor_IO"><br><img src="http://note.youdao.com/yws/api/personal/file/744E961FB3514A8F8C0400D122E88ACF?method=download&amp;shareKey=8f2c503341250d441cd819f14a812dcb" alt="Zabbix_Monitor_IO">  </p>
<p>附件：<br><a href="http://note.youdao.com/yws/api/personal/file/2652B89E0A614EC399A82437EA15228A?method=download&amp;shareKey=00a49f1f8fdc741f6ac8c0d970433235" target="_blank" rel="external">disk_scan.sh</a><br><a href="http://note.youdao.com/yws/api/personal/file/AEEFCB1FDF944D5B94ABEC19EE71EBBD?method=download&amp;shareKey=7d7afb028b4d7d8cd11891620c7cfbfd" target="_blank" rel="external">disk_status.sh</a><br><a href="http://note.youdao.com/yws/api/personal/file/5C67C7D476E14C12AA9778324C991364?method=download&amp;shareKey=c79d92d47d9953d3b5e4412a46ae611e" target="_blank" rel="external">userparameter_io.conf</a><br><a href="http://note.youdao.com/yws/api/personal/file/10B04508EE354B878454B52734B960DD?method=download&amp;shareKey=1d25232e6221be964f40d2c7103ed566" target="_blank" rel="external">Template IO status.xml</a>  </p>
<p>关于Zabbix其他监控指标，请参考：<a href="http://yfshare.blog.51cto.com/8611708/d-5" target="_blank" rel="external">http://yfshare.blog.51cto.com/8611708/d-5</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/08/28/Zabbix监控磁盘IO/">http://www.yfshare.vip/2017/08/28/Zabbix监控磁盘IO/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;IOSTAT获取磁盘性能参数后，通过Zabbix Agent传值给Zabbix Server即可&lt;br&gt;
    
    </summary>
    
      <category term="Zabbix" scheme="http://www.yfshare.vip/categories/Zabbix/"/>
    
    
      <category term="zabbix" scheme="http://www.yfshare.vip/tags/zabbix/"/>
    
      <category term="IO" scheme="http://www.yfshare.vip/tags/IO/"/>
    
      <category term="disk" scheme="http://www.yfshare.vip/tags/disk/"/>
    
  </entry>
  
  <entry>
    <title>Win2008 r2 远程桌面服务授权管理器激活方法</title>
    <link href="http://www.yfshare.vip/2017/08/24/Win2008-r2-%E8%BF%9C%E7%A8%8B%E6%A1%8C%E9%9D%A2%E6%9C%8D%E5%8A%A1%E6%8E%88%E6%9D%83%E7%AE%A1%E7%90%86%E5%99%A8%E6%BF%80%E6%B4%BB%E6%96%B9%E6%B3%95/"/>
    <id>http://www.yfshare.vip/2017/08/24/Win2008-r2-远程桌面服务授权管理器激活方法/</id>
    <published>2017-08-24T12:59:00.000Z</published>
    <updated>2017-08-25T15:12:42.630Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/APlayer.min.js"> </script><script src="/assets/js/DPlayer.min.js"> </script><p>Windows 2008在不安装远程桌面服务授权管理器下的情况，系统允许有120天的宽限期，在120天后，又不想购买授权的话，就需要按以下的步骤“折腾”一下<br><a id="more"></a></p>
<ol>
<li>在添加角色和功能向导里，先安装<code>远程桌面会话主机</code>，<code>远程桌面授权</code>，<code>远程协助</code>，<code>远程桌面授权工具</code>，<code>远程桌面许可诊断程序</code></li>
<li>首先进入”开始菜单–&gt;管理工具–&gt;远程桌面服务–&gt;远程桌面授权管理器”，开始激活。</li>
<li>如果是域控环境，需要把RD授权服务器和RD授权功能都加入到域，否则会显示感叹号。右键<code>RD-LIC授权服务器</code>–&gt;配置–&gt;加入到组，即可。参考：<a href="http://blog.csdn.net/liangdapo/article/details/49127859" target="_blank" rel="external">http://blog.csdn.net/liangdapo/article/details/49127859</a></li>
<li>在列表里选择已安装的授权服务器，此为的激活状态为“没有激活”，右击鼠标，选择“激活服务器”。</li>
<li>在弹出的对话框里点“下一步”，连接方法选择“Web 浏览器，点击“下一步”。</li>
<li>记住这个页面提供的产品ID（如：88888-888-8888888-88888），按照上面的提示，用浏览器打开“ <a href="https://activate.microsoft.com" target="_blank" rel="external">https://activate.microsoft.com</a> ”，这个页面是英文界面的，在左边的菜单中选择”Chinese(Simplified)”(简体中文)项，再点”GO”图标，切换为中文界面。</li>
<li>确保已选中”启用许可证服务器”，再单击“下一步”按钮。</li>
<li>填上上面记下来的产品ID，再填入自己的其他基本资料（输入必填项即可），然后再选”下一步”继续。</li>
<li>在这个页面显示了刚才输入的信息，点击“下一步”继续。</li>
<li>这个页面会显示：”已成功处理您的许可证服务器激活请求……。许可证服务器ID为：……“，需要把这个分为七段的35位数抄下来，里面包含有数字和大写的英文字母；下方会问你”是否希望立即在具有此产品ID的许可证服务器上安装客户端访问许可证？”，当然应该选择“是”。</li>
<li>在这个界面的”授权信息“中有个选择”许可证程序“的地方，天火选择的是“企业协议”，博主推荐选这个，然后点”下一步“继续。</li>
<li>这个页面需要选择”产品类型“，天火选择的是”Windows Server 2008 R2 RDS 每设备CAL或Windows Server 2008 TS 每设备CAL“，俺也推荐选这个，“数量”根据需要随便输，比如：50，在“协议号码”处需要输入已授权的协议号码，这个是关键，否则激活无法通过，天火在这里给大家提供四个：4954438、5256992、6565792、6879321，点“下一步”。</li>
<li>又是让你确认信息的页面，直接点“下一步”。</li>
<li>这里就是大家期待已久的页面了：已成功处理您的客户端访问许可证请求…….，需要记住中间新产生的七段35位数，这个就是“许可证密钥包ID”。点“结束”按钮，然后就可以关闭这个窗口了。</li>
<li>回到服务器激活向导中来，将前面产生的第一个七段35位数（许可证服务器ID）输入到输入框中（支持复制／粘贴），点“下一步”。</li>
<li>现在完成了授权向导，还需要”立即安装许可证”，在这个界面，默认是选中“立即启动许可证安装向导”的，点”下一步”继续。</li>
<li>确认一下连接方法使用的是“Web 浏览器”，然后继续点“下一步”。</li>
<li>在这个界面输入第二个七段35位数（许可证密钥包ID，也支持复制／粘贴），点“下一步”。</li>
<li>点击“完成”，恭喜你，完成激活和许可证的安装了！</li>
</ol>
<p>适用windows server 2012 r2  </p>
<p>参考：<a href="http://blog.sina.com.cn/s/blog_4152a9f501017asy.html" target="_blank" rel="external">http://blog.sina.com.cn/s/blog_4152a9f501017asy.html</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/08/24/Win2008-r2-远程桌面服务授权管理器激活方法/">http://www.yfshare.vip/2017/08/24/Win2008-r2-远程桌面服务授权管理器激活方法/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Windows 2008在不安装远程桌面服务授权管理器下的情况，系统允许有120天的宽限期，在120天后，又不想购买授权的话，就需要按以下的步骤“折腾”一下&lt;br&gt;
    
    </summary>
    
      <category term="Windows" scheme="http://www.yfshare.vip/categories/Windows/"/>
    
    
      <category term="RDS" scheme="http://www.yfshare.vip/tags/RDS/"/>
    
      <category term="windows server" scheme="http://www.yfshare.vip/tags/windows-server/"/>
    
      <category term="Remote Desktop" scheme="http://www.yfshare.vip/tags/Remote-Desktop/"/>
    
      <category term="远程桌面" scheme="http://www.yfshare.vip/tags/%E8%BF%9C%E7%A8%8B%E6%A1%8C%E9%9D%A2/"/>
    
  </entry>
  
  <entry>
    <title>程序启动报Illegal key size错误</title>
    <link href="http://www.yfshare.vip/2017/08/22/%E7%A8%8B%E5%BA%8F%E5%90%AF%E5%8A%A8%E6%8A%A5Illegal-key-size%E9%94%99%E8%AF%AF/"/>
    <id>http://www.yfshare.vip/2017/08/22/程序启动报Illegal-key-size错误/</id>
    <published>2017-08-22T14:29:21.000Z</published>
    <updated>2017-08-22T14:38:06.892Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/APlayer.min.js"> </script><script src="/assets/js/DPlayer.min.js"> </script><p>因业务需要，对生产应用系统进行扩容后，当启动应用(tomcat)时，其日志(catalina.out)却输出 <code>java.security.InvalidKeyException: Illegal key size</code> 这样的错误<br>开发在自测和测试在测试环境上测试时都没有遇到这个问题，而在生产上却出现了这个错误，不过生产上的这个服务器是刚部署的<br>后来就是各种查资料，原因是<code>JDK不兼容</code>，不过奇怪的是都是同样的JDK版本，刚部署的服务器却又问题，也可能是后来替换了得吧  </p>
<p>处理办法: 在官方网站下载JCE无限制权限策略文件<br>JDK7的下载地址: <a href="http://www.oracle.com/technetwork/java/javase/downloads/jce-7-download-432124.html" target="_blank" rel="external">http://www.oracle.com/technetwork/java/javase/downloads/jce-7-download-432124.html</a><br>JDK8的下载地址: <a href="http://www.oracle.com/technetwork/java/javase/downloads/jce8-download-2133166.html" target="_blank" rel="external">http://www.oracle.com/technetwork/java/javase/downloads/jce8-download-2133166.html</a><br>如果安装了JRE，将两个jar文件放到%JRE_HOME%\lib\security目录下覆盖原来的文件<br>如果安装了JDK，还要将两个jar文件也放到%JDK_HOME%\jre\lib\security目录下覆盖原来文件  </p>
<p>替换JDK<code>local_policy.jar</code>和<code>US_export_policy.jar</code>两个文件，然后重启应用即可<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># ls /usr/local/jdk/jre/lib/security/ -lrtc</span></div><div class="line">total 144</div><div class="line">-rw-r--r-- 1   10  143     0 Aug 16 22:13 trusted.libraries</div><div class="line">-rw-r--r-- 1   10  143    98 Aug 16 22:13 javaws.policy</div><div class="line">-rw-r--r-- 1   10  143  2593 Aug 16 22:13 java.policy</div><div class="line">-rw-r--r-- 1   10  143   158 Aug 16 22:13 javafx.policy</div><div class="line">-rw-r--r-- 1   10  143  4054 Aug 16 22:13 blacklist</div><div class="line">-rw-r--r-- 1   10  143 18033 Aug 16 22:13 java.security</div><div class="line">-rw-r--r-- 1   10  143 98626 Aug 16 22:13 cacerts</div><div class="line">-rw-r--r-- 1 root root  2500 Aug 17 20:54 local_policy.jar   <span class="comment">#替换这文件</span></div><div class="line">-rw-r--r-- 1 root root  2487 Aug 17 20:54 US_export_policy.jar      <span class="comment">#替换这文件</span></div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>附件：<br><a href="http://note.youdao.com/yws/api/personal/file/86096F1D533C49E983860AB8531476E0?method=download&amp;shareKey=6c993d393fc466c6f03539f61ed3d009" target="_blank" rel="external">local_policy.jar</a><br><a href="http://note.youdao.com/yws/api/personal/file/FB0E6938DEE64BA18508AAF920FD5D02?method=download&amp;shareKey=a0dd06db1ed70a2870e5ef6b847428b1" target="_blank" rel="external">US_export_policy.jar</a>  </p>
<p>参考：<a href="http://www.cnblogs.com/gdayq/p/5919252.html" target="_blank" rel="external">http://www.cnblogs.com/gdayq/p/5919252.html</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/08/22/程序启动报Illegal-key-size错误/">http://www.yfshare.vip/2017/08/22/程序启动报Illegal-key-size错误/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;script src=&quot;/assets/js/APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;script src=&quot;/assets/js/DPlayer.min.js&quot;&gt; &lt;/script&gt;&lt;p&gt;因业务需要，对生产应用系统进行扩容后，当启动应用(tomcat)时，其日志
    
    </summary>
    
      <category term="WEB" scheme="http://www.yfshare.vip/categories/WEB/"/>
    
    
      <category term="tomcat" scheme="http://www.yfshare.vip/tags/tomcat/"/>
    
      <category term="Illegal key size" scheme="http://www.yfshare.vip/tags/Illegal-key-size/"/>
    
  </entry>
  
</feed>

<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Jack Wang Blog</title>
  <subtitle>Goals determine what you are going to be</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://yfshare.github.io/"/>
  <updated>2017-04-29T07:22:55.000Z</updated>
  <id>https://yfshare.github.io/</id>
  
  <author>
    <name>Jack Wang</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>部署Grafana数据展示系统</title>
    <link href="https://yfshare.github.io/2017/04/29/%E9%83%A8%E7%BD%B2Grafana%E6%95%B0%E6%8D%AE%E5%B1%95%E7%A4%BA%E7%B3%BB%E7%BB%9F/"/>
    <id>https://yfshare.github.io/2017/04/29/部署Grafana数据展示系统/</id>
    <published>2017-04-29T05:48:37.000Z</published>
    <updated>2017-04-29T07:22:55.000Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>Grafana 是 Graphite 和 InfluxDB 仪表盘和图形编辑器。<br>Grafana 是开源的，功能齐全的度量仪表盘和图形编辑器，支持 Graphite，InfluxDB 和 OpenTSDB。<br>Grafana 主要特性：灵活丰富的图形化选项；可以混合多种风格；支持白天和夜间模式；多个数据源；Graphite 和 InfluxDB 查询编辑器等等。<br><a id="more"></a></p>
<h2 id="认识Grafana"><a href="#认识Grafana" class="headerlink" title="认识Grafana"></a>认识Grafana</h2><p><strong>Graphite 指标编辑器</strong></p>
<ul>
<li>Graphite 指标表达解析器</li>
<li>功能齐全的查询功能</li>
<li>快速添加和编辑函数和参数</li>
<li>模板化查询</li>
<li>See it in action</li>
</ul>
<p><strong>图形化</strong></p>
<ul>
<li>快速渲染，甚至是较大的时间跨度</li>
<li>点击和拖拽缩放</li>
<li>多个 Y 轴 </li>
<li>条形，折线，点 </li>
<li>智能 Y 轴格式化</li>
<li>系列切换和颜色选择 </li>
<li>Legend values 和格式化选项</li>
<li>网格阈值，轴标签</li>
<li>Annotations</li>
</ul>
<p><strong>仪表盘</strong></p>
<ul>
<li>创建，编辑，保存和搜索仪表盘</li>
<li>修改列宽和行高</li>
<li>拖拽面板重新编排</li>
<li>使用 InfluxDB 或者 Elasticsearch 作为仪表盘存储</li>
<li>导入和导出仪表盘（JSON 文件）</li>
<li>从 Graphite 导入仪表盘</li>
<li>模板</li>
<li>Scripted dashboards</li>
<li>Dashboard playlists</li>
<li>时间范围控制</li>
</ul>
<p><strong>InfluxDB</strong></p>
<ul>
<li>使用 InfluxDB 作为指标数据源，注释源和仪表盘存储</li>
<li>查询编辑器</li>
</ul>
<p><strong>OpenTSDB</strong></p>
<ul>
<li>作为指标数据源</li>
<li>查询编辑器</li>
</ul>
<h2 id="部署Grafana数据展示平台-之在线安装"><a href="#部署Grafana数据展示平台-之在线安装" class="headerlink" title="部署Grafana数据展示平台 之在线安装"></a>部署Grafana数据展示平台 之在线安装</h2><p>官网：<a href="http://grafana.org/" target="_blank" rel="external">http://grafana.org/</a><br>环境：<br>　　　Centos 6.6<br>　　　Zabbix Version 3.0.4<br>　　　grafana Version 3.1.1  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[root@Zabbix ~]<span class="comment"># wget https://grafanarel.s3.amazonaws.com/builds/grafana-3.1.1-1470047149.x86_64.rpm</span></div><div class="line">[root@Zabbix ~]<span class="comment"># yum -y install grafana-3.1.1-1470047149.x86_64.rpm</span></div><div class="line">[root@Zabbix ~]<span class="comment"># mkdir -p /var/log/grafana</span></div><div class="line">[root@Zabbix ~]<span class="comment"># cd /usr/share/grafana/conf/</span></div><div class="line">[root@Zabbix conf]<span class="comment"># grep -v '^#' defaults.ini | grep -v ^$</span></div><div class="line">···</div><div class="line">[users]</div><div class="line">allow_sign_up = <span class="literal">false</span>         <span class="comment">#关闭这个在登录界面就没有Sign Up了</span></div><div class="line">allow_org_create = <span class="literal">false</span></div><div class="line">auto_assign_org = <span class="literal">false</span></div><div class="line">auto_assign_org_role = Viewer</div><div class="line">verify_email_enabled = <span class="literal">false</span></div><div class="line">login_hint = email or username</div><div class="line">default_theme = dark</div><div class="line">···</div><div class="line">[root@Zabbix conf]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>安装Grafana插件<br>官方文档：<a href="http://docs.grafana.org/plugins/installation/" target="_blank" rel="external">http://docs.grafana.org/plugins/installation/</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#列出可用的插件</span></div><div class="line">[root@Zabbix ~]<span class="comment"># grafana-cli plugins list-remote</span></div><div class="line">id: abhisant-druid-datasource version: 0.0.2</div><div class="line">id: alexanderzobnin-zabbix-app version: 3.0.0</div><div class="line">id: bosun-app version: 0.0.25</div><div class="line">id: bosun-datasource version: 0.0.5</div><div class="line">id: crate-datasource version: 0.0.1</div><div class="line">id: fastweb-openfalcon-datasource version: 1.0.0</div><div class="line">id: fetzerch-sunandmoon-datasource version: 0.1.1</div><div class="line">id: grafana-clock-panel version: 0.0.8</div><div class="line">id: grafana-example-app version: 1.0.1</div><div class="line">id: grafana-influxdb-08-datasource version: 1.0.2</div><div class="line">id: grafana-kairosdb-datasource version: 1.0.1</div><div class="line">id: grafana-piechart-panel version: 1.1.1</div><div class="line">id: grafana-simple-json-datasource version: 1.1.2</div><div class="line">id: grafana-worldmap-panel version: 0.0.14</div><div class="line">id: kentik-app version: 1.0.4</div><div class="line">id: mtanda-heatmap-epoch-panel version: 0.1.1</div><div class="line">id: mtanda-histogram-panel version: 0.1.5</div><div class="line">id: ns1-app version: 0.0.5</div><div class="line">id: opennms-datasource version: 2.0.1</div><div class="line">id: percona-percona-app version: 1.0.0</div><div class="line">id: praj-ams-datasource version: 1.0.1</div><div class="line">id: raintank-snap-app version: 0.0.3</div><div class="line">id: raintank-worldping-app version: 1.0.10</div><div class="line">id: sileht-gnocchi-datasource version: 1.0.6</div><div class="line">id: sraoss-sunburst-panel version: 1.0</div><div class="line">id: stagemonitor-elasticsearch-app version: 0.26.0</div><div class="line">id: udoprog-heroic-datasource version: 0.1.0</div><div class="line">id: voxter-app version: 0.0.1</div><div class="line">Restart grafana after installing plugins . &lt;service grafana-server restart&gt;</div><div class="line">[root@Zabbix ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p><a href="https://grafana.com/plugins/alexanderzobnin-zabbix-app" target="_blank" rel="external">alexanderzobnin-zabbix-app</a> 插件用于Grafana通过Zabbix API获取数据并展示数据<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@Zabbix ~]<span class="comment"># grafana-cli plugins install alexanderzobnin-zabbix-app</span></div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/F9559698659841E8913649C3444C5701?method=download&amp;shareKey=2c51f44d408b1674bceee85ab5787611" alt="Grafana_install_plugins">  </p>
<p>安装Grafana其他插件<br>常用插件：<a href="https://grafana.com/plugins/grafana-clock-panel" target="_blank" rel="external">grafana-clock-panel</a>、<a href="https://grafana.com/plugins/grafana-simple-json-datasource" target="_blank" rel="external">grafana-simple-json-datasource</a>、<a href="https://grafana.com/plugins/grafana-piechart-panel" target="_blank" rel="external">grafana-piechart-panel</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@Zabbix ~]<span class="comment"># grafana-cli plugins install grafana-clock-panel</span></div><div class="line">[root@Zabbix ~]<span class="comment"># grafana-cli plugins install grafana-simple-json-datasource</span></div><div class="line">[root@Zabbix ~]<span class="comment"># grafana-cli plugins install grafana-piechart-panel</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#这三个可以不安装，这三个插件是用于检测DNS/PING等网络情况的，需要付费</span></div><div class="line">[root@Zabbix ~]<span class="comment"># grafana-cli plugins install raintank-worldping-app</span></div><div class="line">[root@Zabbix ~]<span class="comment"># grafana-cli plugins install fastweb-openfalcon-datasource</span></div><div class="line">[root@Zabbix ~]<span class="comment"># grafana-cli plugins install percona-percona-app</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#列出已安装的插件</span></div><div class="line">[root@Zabbix ~]<span class="comment"># grafana-cli plugins ls</span></div></pre></td></tr></table></figure>
<p><img src="http://note.youdao.com/yws/api/personal/file/9AA193AACC784E9DACA6C47A9162C132?method=download&amp;shareKey=d50c4fe6334663c21675454699cba3d2" alt="Grafana_plugins_list"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@Zabbix ~]<span class="comment"># ll /var/lib/grafana/plugins</span></div><div class="line">total 28</div><div class="line">drwxr-xr-x 7 root root 4096 Aug 30 10:14 alexanderzobnin-zabbix-app</div><div class="line">drwxr-xr-x 6 root root 4096 Aug 30 15:03 fastweb-openfalcon-datasource</div><div class="line">drwxr-xr-x 4 root root 4096 Aug 30 10:15 grafana-clock-panel</div><div class="line">drwxr-xr-x 4 root root 4096 Aug 30 14:40 grafana-piechart-panel</div><div class="line">drwxr-xr-x 5 root root 4096 Aug 30 10:15 grafana-simple-json-datasource</div><div class="line">drwxr-xr-x 4 root root 4096 Aug 30 15:31 percona-percona-app</div><div class="line">drwxr-xr-x 4 root root 4096 Aug 30 10:15 raintank-worldping-app</div><div class="line">[root@Zabbix ~]<span class="comment">#</span></div><div class="line">[root@Zabbix ~]<span class="comment"># /etc/init.d/grafana-server start</span></div><div class="line">Starting Grafana Server: .... OK</div><div class="line">[root@Zabbix ~]<span class="comment"># chkconfig --add grafana-server</span></div><div class="line">[root@Zabbix ~]<span class="comment"># chkconfig grafana-server on</span></div></pre></td></tr></table></figure></p>
<p>访问：<a href="http://ip:3000/" target="_blank" rel="external">http://ip:3000/</a><br><img src="http://note.youdao.com/yws/api/personal/file/C6BD03BA70054CDA86E0F06A22565CF4?method=download&amp;shareKey=4fef0d3fa79d4ddac0ddcec59cf0f324" alt="Grafana_login"><br><img src="http://note.youdao.com/yws/api/personal/file/9917D8C1D4C24100B069C89E388D6D3B?method=download&amp;shareKey=1e7ad5cb9d8a03620beebe317425fe18" alt="Grafana">  </p>
<p>安装zabbix插件<br><img src="http://note.youdao.com/yws/api/personal/file/7A07E86DB96749EFB27ED735384BA754?method=download&amp;shareKey=e81b981df1db0df3b7497548f5e3481e" alt="Grafana"><br><img src="http://note.youdao.com/yws/api/personal/file/C630210B1F1B4BF1AA0695CCBED55FC0?method=download&amp;shareKey=675682543eb92186f4ac9dc9a6f88db0" alt="Grafana"><br><img src="http://note.youdao.com/yws/api/personal/file/FB95B45975024294903C014A0EC7452E?method=download&amp;shareKey=503c506c48df2eba416b79fba9eec87b" alt="Grafana"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Zabbix的API地址为“http://192.168.31.130/zabbix/api_jsonrpc.php”，其中IP的安装zabbix-server的服务器IP</div><div class="line">Zabbix的API账号密码就是Zabbix的Web端登录账号和密码</div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/CAE0140CA04D4DF48FE71CC516745D8D?method=download&amp;shareKey=93d4114c12ef3fadfb95511cc90b3ae5" alt="Grafana_datasource"><br><img src="http://note.youdao.com/yws/api/personal/file/4D17740A04754EFD880EE5538BA68F18?method=download&amp;shareKey=90faa224c21a22ea962bca3ab69c043c" alt="Grafana_datasource"><br><img src="http://note.youdao.com/yws/api/personal/file/85BFEE13D1C9484B813E41FF4F94495F?method=download&amp;shareKey=5ab8cd7a870598acce4cc7ac0f34a619" alt="Grafana_datasource">  </p>
<p>新建一个仪表<br><img src="http://note.youdao.com/yws/api/personal/file/7A029D61C3034907A7A478057BECABB2?method=download&amp;shareKey=c01433e248d55b813bafd9932d7260cc" alt="Grafana_table"><br><img src="http://note.youdao.com/yws/api/personal/file/FD53B024CD7F40E3A3A7F4649FF93FEE?method=download&amp;shareKey=7e69a28a18f3f352ff7bb8254a2396e3" alt="Grafana_table"><br><img src="http://note.youdao.com/yws/api/personal/file/665E5D9A6E514558B862359B3DCF8D5E?method=download&amp;shareKey=1d17b900e195a92fd4d234951348dd85" alt="Grafana_table"><br><img src="http://note.youdao.com/yws/api/personal/file/DB3037B236F94787B9152D109D39205E?method=download&amp;shareKey=066caf56955144b5c2a564993d8ee54f" alt="Grafana_table"><br><img src="http://note.youdao.com/yws/api/personal/file/ACEE15EF2DA34CD0B7116DC90A9B8D73?method=download&amp;shareKey=f52e33fc6dc6721525bf5b9dfc4f4d09" alt="Grafana_table"><br><img src="http://note.youdao.com/yws/api/personal/file/82DC4AAFDF744673895B25C90706BA22?method=download&amp;shareKey=f0f36343e8c3cb04a984a98f96761f2b" alt="Grafana_table"><br>OK，Grafana在线安装完成  </p>
<p>看看效果图<br><img src="http://note.youdao.com/yws/api/personal/file/1D8445F4804C435085DE75FBDE27263E?method=download&amp;shareKey=c4fa2915a6d0c49cd5e0a6209a0fba52" alt="Grafana_view"><br><img src="http://note.youdao.com/yws/api/personal/file/8DF5C52B582F494DA2954B8D8827B204?method=download&amp;shareKey=499d5a9b47ace1047965438e21942a1d" alt="Grafana_view"><br><img src="http://note.youdao.com/yws/api/personal/file/07456EC8BB6545CCAB7D2E1318DFCBED?method=download&amp;shareKey=9ca12dd9c5eabd809762f15706fd4164" alt="Grafana_view"><br><img src="http://note.youdao.com/yws/api/personal/file/52FFAD517EBC494DA0FF0B610DCCE4B9?method=download&amp;shareKey=e483df4b036bda1cd7bab7b85caed089" alt="Grafana_view"><br><img src="http://note.youdao.com/yws/api/personal/file/C0B0D4DDAE2F4300A66D28F737E9001A?method=download&amp;shareKey=ac4613af5fcff7c55615905dca9eb00f" alt="Grafana_view">  </p>
<p>用户管理（使用管理员登录）<br><img src="http://note.youdao.com/yws/api/personal/file/D8F5502ED5EE4BC28D325D53138BEBFD?method=download&amp;shareKey=47cc76449f34b867a36f46ca898518bd" alt="Grafana_user">  </p>
<h2 id="部署Grafana数据展示平台-之离线安装"><a href="#部署Grafana数据展示平台-之离线安装" class="headerlink" title="部署Grafana数据展示平台 之离线安装"></a>部署Grafana数据展示平台 之离线安装</h2><p>官网：<a href="http://grafana.org/" target="_blank" rel="external">http://grafana.org/</a><br>环境：<br>　　　Centos 7.2<br>　　　Zabbix Version 3.0.4  </p>
<p>Grafana支持多平台安装，目前已知平台有Linux、Windows、Mac、Docker。Linux支持系统有Ubuntu &amp;Debian、Standalone Linux Binaries、Redhat &amp;Centos等等<br>Grafana下载地址：<a href="https://grafana.com/grafana/download" target="_blank" rel="external">https://grafana.com/grafana/download</a>  </p>
<p><a href="https://s3-us-west-2.amazonaws.com/grafana-releases/release/grafana-4.2.0-1.x86_64.rpm" target="_blank" rel="external">下载Grafana for Centos</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#安装Grafana</span></div><div class="line">[root@localhost ~]<span class="comment"># yum -y install grafana-4.2.0-1.x86_64.rpm</span></div><div class="line">[root@localhost ~]<span class="comment"># cd /usr/share/grafana/conf/</span></div><div class="line">[root@localhost ~]<span class="comment"># grep -v ^# /usr/share/grafana/conf/defaults.ini | grep -v ^$</span></div><div class="line">...</div><div class="line"><span class="comment">#allow_sign_up、allow_org_create、auto_assign_org值为false在登录界面就没有Sign Up了</span></div><div class="line">[users]</div><div class="line">allow_sign_up = <span class="literal">false</span></div><div class="line">allow_org_create = <span class="literal">false</span></div><div class="line">auto_assign_org = <span class="literal">false</span></div><div class="line">auto_assign_org_role = Viewer</div><div class="line">verify_email_enabled = <span class="literal">false</span></div><div class="line">login_hint = email or username</div><div class="line">default_theme = dark</div><div class="line">...</div><div class="line">[root@localhost ~]<span class="comment"># systemctl enable grafana-server</span></div><div class="line">[root@localhost ~]<span class="comment"># service grafana-server start</span></div><div class="line">[root@localhost ~]<span class="comment"># mkdir -p /var/log/grafana</span></div></pre></td></tr></table></figure></p>
<p>访问<a href="http://ip:3000" target="_blank" rel="external">http://ip:3000</a><br><img src="http://note.youdao.com/yws/api/personal/file/283EB01F3A4941E29F8AE30FD43E8775?method=download&amp;shareKey=a5c4750aa0f94fb4ef599640a08155d6" alt="Grafana_login">  </p>
<p>安装Grafana插件<br>grafana插件：<a href="https://grafana.com/plugins" target="_blank" rel="external">https://grafana.com/plugins</a> ，这里可以获取Grafana最新插件  </p>
<p>安装Grafana for Zabbix插件<br><a href="https://grafana.com/plugins/alexanderzobnin-zabbix-app" target="_blank" rel="external">alexanderzobnin-zabbix-app</a> 插件用于Grafana通过Zabbix API获取数据并展示数据<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># unzip alexanderzobnin-grafana-zabbix-v3.3.0-0-geca8096.zip</span></div><div class="line">[root@localhost ~]<span class="comment"># cp -rfp alexanderzobnin-grafana-zabbix-eca8096/ /var/lib/g</span></div><div class="line">rafana/plugins/</div><div class="line">[root@localhost ~]<span class="comment"># service grafana-server restart</span></div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/4FA3930F6A92405EA22D6615C4F27B8C?method=download&amp;shareKey=1f06986616b1ada68340d0504fdd2bd8" alt="Grafana_install_plugin"><br><img src="http://note.youdao.com/yws/api/personal/file/DDFE4FD7CED342AB888E8505A9886929?method=download&amp;shareKey=539ea2e4844cb414ca5a7c0d9e7b5801" alt="Grafana_install_plugin"><br><img src="http://note.youdao.com/yws/api/personal/file/7106F5778C6C4BCEB8EC2691F940C1FC?method=download&amp;shareKey=9dcf899b3fdc6449592318587c0f91a9" alt="Grafana_install_plugin">  </p>
<p>安装Grafana其他插件<br>常用插件：<a href="https://grafana.com/plugins/grafana-clock-panel" target="_blank" rel="external">grafana-clock-panel</a>、<a href="https://grafana.com/plugins/grafana-simple-json-datasource" target="_blank" rel="external">grafana-simple-json-datasource</a>、<a href="https://grafana.com/plugins/grafana-piechart-panel" target="_blank" rel="external">grafana-piechart-panel</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># unzip grafana-clock-panel-c5b3c7f.zip</span></div><div class="line">[root@localhost ~]<span class="comment"># cp -rfp grafana-clock-panel-c5b3c7f /var/lib/grafana/plugins/</span></div><div class="line">[root@localhost ~]<span class="comment"># unzip grafana-piechart-panel-ce2ede8.zip</span></div><div class="line">[root@localhost ~]<span class="comment"># cp grafana-piechart-panel-ce2ede8 /var/lib/grafana/plugins/ -rfp</span></div><div class="line">[root@localhost ~]<span class="comment"># unzip grafana-simple-json-datasource-49eeb6d.zip</span></div><div class="line">[root@localhost ~]<span class="comment"># cp -rfp grafana-simple-json-datasource-49eeb6d /var/lib/grafana/plugins/</span></div><div class="line">[root@localhost ~]<span class="comment"># unzip Vonage-Grafana_Status_panel-1.0.4-0-g8bf28f2.zip</span></div><div class="line">[root@localhost ~]<span class="comment"># cp -rfp Vonage-Grafana_Status_panel-8bf28f2/ /var/lib/grafana/plugins/</span></div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment"># ll /var/lib/grafana/plugins/</span></div><div class="line">total 8</div><div class="line">drwxr-xr-x 6 root root 4096 Feb 10 23:30 alexanderzobnin-grafana-zabbix-eca8096</div><div class="line">drwxr-xr-x 4 root root 4096 Mar 18 07:29 grafana-clock-panel-c5b3c7f</div><div class="line">drwxr-xr-x 4 root root  112 Sep 29  2016 grafana-piechart-panel-ce2ede8</div><div class="line">drwxr-xr-x 5 root root  156 Mar 24 00:54 grafana-simple-json-datasource-49eeb6d</div><div class="line">drwxr-xr-x 4 root root  136 Apr 27 18:02 Vonage-Grafana_Status_panel-8bf28f2</div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line">[root@localhost ~]<span class="comment"># grafana-cli plugins ls </span></div><div class="line">installed plugins:</div><div class="line">vonage-status-panel @ 1.0.4 </div><div class="line">alexanderzobnin-zabbix-app @ 3.3.0 </div><div class="line">grafana-clock-panel @ 0.0.9 </div><div class="line">grafana-piechart-panel @ 1.1.4 </div><div class="line">grafana-simple-json-datasource @ 1.3.1 </div><div class="line"></div><div class="line">Restart grafana after installing plugins . &lt;service grafana-server restart&gt;</div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment">#</span></div><div class="line"><span class="comment">#安装了新的Grafana插件需要重启Grafana</span></div><div class="line">[root@localhost ~]<span class="comment"># service grafana-server restart</span></div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/C95B8C145A5D426DA83765ABCD32AB69?method=download&amp;shareKey=cc367f5f83d84d60348a4207b4b6409b" alt="Grafana_install_plugin"><br>OK，Grafana离线安装完成  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="https://yfshare.github.io">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="https://yfshare.github.io/2017/04/29/部署Grafana数据展示系统/">https://yfshare.github.io/2017/04/29/部署Grafana数据展示系统/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Grafana 是 Graphite 和 InfluxDB 仪表盘和图形编辑器。&lt;br&gt;Grafana 是开源的，功能齐全的度量仪表盘和图形编辑器，支持 Graphite，InfluxDB 和 OpenTSDB。&lt;br&gt;Grafana 主要特性：灵活丰富的图形化选项；可以混合多种风格；支持白天和夜间模式；多个数据源；Graphite 和 InfluxDB 查询编辑器等等。&lt;br&gt;
    
    </summary>
    
      <category term="Zabbix" scheme="https://yfshare.github.io/categories/Zabbix/"/>
    
    
      <category term="Zabbix" scheme="https://yfshare.github.io/tags/Zabbix/"/>
    
      <category term="Grafana" scheme="https://yfshare.github.io/tags/Grafana/"/>
    
  </entry>
  
  <entry>
    <title>Zabbix之微信(Wechat)告警</title>
    <link href="https://yfshare.github.io/2017/04/13/Zabbix%E4%B9%8B%E5%BE%AE%E4%BF%A1-Wechat-%E5%91%8A%E8%AD%A6/"/>
    <id>https://yfshare.github.io/2017/04/13/Zabbix之微信-Wechat-告警/</id>
    <published>2017-04-13T01:41:25.000Z</published>
    <updated>2017-04-13T01:44:39.000Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>Zabbix告警可以通过邮件，微信，电话，短信等方式发送告警消息。电话和短信需要向运营商购买相应的网关，需要付费；邮件和微信是免费的，可以根据业务需要选择相应的告警模式<br><a id="more"></a></p>
<h2 id="部署前准备工作"><a href="#部署前准备工作" class="headerlink" title="部署前准备工作"></a>部署前准备工作</h2><p>先申请一个微信企业号：<a href="https://qy.weixin.qq.com" target="_blank" rel="external">https://qy.weixin.qq.com</a><br>申请通过过<a href="https://qy.weixin.qq.com" target="_blank" rel="external">登录</a>该企业号  </p>
<p>注：每个企业号有发送消息限制<br>据说是有消息数限制的  </p>
<ul>
<li>发消息频率。每企业不可超过200次/分钟；不可超过帐号上限数x30人次/天。例如：企业号的注册号的人数上限为200人，注册号一天可以发送200x30=6000人次/天，注意：1条消息发给100人算作100人次。<br>参考：<a href="http://qydev.weixin.qq.com/qa/index.php?qa=29914&amp;qa_1=企业号发布消息有条数限制吗？&amp;show=29914#q29914" target="_blank" rel="external">企业号发布消息数限制</a>  </li>
</ul>
<p>向微信企业号添加部门<br><img src="http://note.youdao.com/yws/api/personal/file/9A74C3796A06442FAB736F9293BF47C7?method=download&amp;shareKey=a9669fcd95dab5382a282862a282879b" alt="weichat_qiyehao">  </p>
<p>向微信企业号新增成员。添加成员后，会生成一个二维码，需要用户扫描关注该微信企业号<br><img src="http://note.youdao.com/yws/api/personal/file/400EBA197981491D9F820AFB94337A0F?method=download&amp;shareKey=9daf4035ea99807443e593907c2fe811" alt="qiyehao_adduser">  </p>
<p>创建应用（消息型应用），并给部门设置管理员（设置—权限管理–新建管理组）<br><img src="http://note.youdao.com/yws/api/personal/file/EE9D4CBA5E224EF6A2F4D998C923A9F3?method=download&amp;shareKey=8f9be28123bf4786673250d257bcb8cf" alt="create_application"><br><img src="http://note.youdao.com/yws/api/personal/file/7F8798ADB8064107A95F0D6B0129A952?method=download&amp;shareKey=4fbec5cec5dfc6b0194e72f1a2146678" alt="qiyehao_app_set">  </p>
<p>要确认管理员能读取通讯录，可以使用应用发送消息<br>注意：这时需要管理员的CorpID和Secret  </p>
<p>我们要准备这些东西：  </p>
<ul>
<li>一个微信企业号</li>
<li>企业号已经被部门成员关注</li>
<li>企业号里有一个可以发消息的应用</li>
<li>一个授权管理员，可以使用该应用给成员发消息</li>
</ul>
<p>我们要取到这些信息：  </p>
<ul>
<li>成员账号</li>
<li>组织部门ID</li>
<li>应用ID</li>
<li>CropID</li>
<li>Secret</li>
</ul>
<h2 id="配置Zabbix之微信告警"><a href="#配置Zabbix之微信告警" class="headerlink" title="配置Zabbix之微信告警"></a>配置Zabbix之微信告警</h2><p>调用微信接口：<br>调用微信接口需要一个调用接口的凭证：access_token<br>通过 ：CropID 、Secret才能获取到access_token，但是获取到的token有效期为两分钟<br><a href="http://qydev.weixin.qq.com/debug" target="_blank" rel="external">http://qydev.weixin.qq.com/debug</a><br><img src="http://note.youdao.com/yws/api/personal/file/FAA655931F1D439793DD0A0E85AF40F8?method=download&amp;shareKey=b5c3ea2a1d938ae1a014746df9cb2e39" alt="weichat_debug">  </p>
<p>Shell脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">curl <span class="_">-s</span> -G  url       获取 AccessToken</div><div class="line">curl --data  url     传送凭证调用企业号接口</div><div class="line">zabbix会传递三个参数给脚本，<span class="variable">$1</span>是消息接收账号，<span class="variable">$2</span>报警标题，<span class="variable">$3</span>报警内容</div></pre></td></tr></table></figure></p>
<p>把脚本放到zabbix告警脚本目录下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@localhost etc]<span class="comment"># grep -i '^AlertScriptsPath' zabbix_server.conf</span></div><div class="line">AlertScriptsPath=/usr/<span class="built_in">local</span>/zabbix/share/zabbix/alertscripts</div><div class="line">[root@CentOS etc]<span class="comment"># cd /usr/local/zabbix/share/zabbix/alertscripts</span></div><div class="line">[root@CentOS alertscripts]<span class="comment"># chmod 755 weixin.sh</span></div><div class="line">[root@CentOS alertscripts]<span class="comment"># chown zabbix:zabbix weixin.sh</span></div></pre></td></tr></table></figure></p>
<p>登录zabbix webGUI：管理–报警媒介类型–创建媒介类型<br><img src="http://note.youdao.com/yws/api/personal/file/5AE07B5F4F9442348AA652A440188C9B?method=download&amp;shareKey=054ef9e8898a679922aa9cc5ec13e59b" alt="zabbix_weichat_warnning"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;ALERT.SENDTO&#125;</div><div class="line">&#123;ALERT.SUBJECT&#125;</div><div class="line">&#123;ALERT.MESSAGE&#125;</div><div class="line">这三个参数在zabbix3.0上必须加上，否则无法发送消息</div></pre></td></tr></table></figure></p>
<p>管理–用户–admin–报警媒介–添加：<br><img src="http://note.youdao.com/yws/api/personal/file/20D63B48DC094209ADEC22BEAF762802?method=download&amp;shareKey=5f5d1d5888a3fbf7d9700977cb287a03" alt="zabbix_wechat_mess">  </p>
<p>创建Trigger和Action（略），发送选择微信<br><img src="http://note.youdao.com/yws/api/personal/file/C58EE9B446BF42CAA697DDE1217582D9?method=download&amp;shareKey=6c59c733bd45500705f106198a9cf5a1" alt="zabbix_wechat_action">  </p>
<p>当条件满足Zabbix Trigger后会触发Action，然后Action调用微信API发送告警消息：<br><img src="http://note.youdao.com/yws/api/personal/file/AA7934E296D648AABF13FF77AE79855C?method=download&amp;shareKey=82b3fc350484396c84b59117b19304c7" alt="image">  </p>
<p>zabbix Action默认消息模版<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">【告警】 &#123;TRIGGER.NAME&#125;\n</div><div class="line"></div><div class="line">告警主机：&#123;HOST.NAME&#125;\n</div><div class="line">主机IP：  &#123;HOST.IP&#125;\n</div><div class="line">告警时间：&#123;EVENT.DATE&#125;  &#123;EVENT.TIME&#125; \n</div><div class="line">告警等级：&#123;TRIGGER.SEVERITY&#125; \n</div><div class="line">告警信息：&#123;TRIGGER.NAME&#125;\n</div><div class="line">问题详情：&#123;ITEM.NAME&#125;:&#123;ITEM.VALUE&#125;\n</div><div class="line">事件ID：  &#123;EVENT.ID&#125;\n</div><div class="line">触发器URL： &#123;TRIGGER.URL&#125;\n</div><div class="line"></div><div class="line">Item values:\n</div><div class="line"></div><div class="line">1. &#123;ITEM.NAME1&#125; (&#123;HOST.NAME1&#125;:&#123;ITEM.KEY1&#125;): &#123;ITEM.VALUE1&#125;\n</div><div class="line">2. &#123;ITEM.NAME2&#125; (&#123;HOST.NAME2&#125;:&#123;ITEM.KEY2&#125;): &#123;ITEM.VALUE2&#125;\n</div><div class="line">3. &#123;ITEM.NAME3&#125; (&#123;HOST.NAME3&#125;:&#123;ITEM.KEY3&#125;): &#123;ITEM.VALUE3&#125;\n</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#微信脚本：</span></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="comment">###SCRIPT_NAME:weixin.sh###</span></div><div class="line"><span class="comment">###send message from weixin for zabbix monitor###</span></div><div class="line"><span class="comment">###wuhf###</span></div><div class="line"><span class="comment">###V1-2015-08-25###</span></div><div class="line">CropID=<span class="string">'wx6df0114cc6117cf0'</span></div><div class="line">Secret=<span class="string">'uLmErUwbzGqfWkG-pyILzo3h4p3teJZdQeMD4MITN6LoBl3ORUVpPnd9Q174mXP7'</span></div><div class="line">GURL=<span class="string">"https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=<span class="variable">$CropID</span>&amp;corpsecret=<span class="variable">$Secret</span>"</span> </div><div class="line">Gtoken=$(/usr/bin/curl <span class="_">-s</span> -G <span class="variable">$GURL</span> | awk -F\<span class="string">" '&#123;print <span class="variable">$4</span>&#125;')</span></div><div class="line">PURL="https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=<span class="variable">$Gtoken</span><span class="string">"</span></div><div class="line">function body() &#123;</div><div class="line">        local int AppID=1                        企业号中的应用id</div><div class="line">        local UserID=<span class="variable">$1</span>                          部门成员id，zabbix中定义的微信接收者</div><div class="line">        local PartyID=3                          部门id，定义了范围，组内成员都可接收到消息</div><div class="line">        local Msg=<span class="variable">$(echo "$@" | cut -d" " -f3-)</span>  过滤出zabbix中传递的第三个参数</div><div class="line">        printf '&#123;\n'</div><div class="line">        printf '\t"touser<span class="string">": "</span><span class="string">'"$User"\"",\n"</span></div><div class="line">        printf '\t<span class="string">"toparty"</span>: <span class="string">"'"</span><span class="variable">$PartyID</span><span class="string">"\""</span>,\n<span class="string">"</span></div><div class="line">        printf '\t"msgtype<span class="string">": "</span>text<span class="string">",\n'</span></div><div class="line">        printf '\t"agentid<span class="string">": "</span><span class="string">'" $AppID "\"",\n"</span></div><div class="line">        printf '\t<span class="string">"text"</span>: &#123;\n<span class="string">'</span></div><div class="line">        printf '\t\t<span class="string">"content"</span>: <span class="string">"'"</span><span class="variable">$Msg</span><span class="string">"\""</span>\n<span class="string">"</span></div><div class="line">        printf '\t&#125;,\n'</div><div class="line">        printf '\t"safe<span class="string">":"</span>0<span class="string">"\n'</span></div><div class="line">        printf '&#125;\n'</div><div class="line">&#125;</div><div class="line">/usr/bin/curl --data-ascii "$(body <span class="variable">$1</span> <span class="variable">$2</span> <span class="variable">$3</span>)<span class="string">" <span class="variable">$PURL</span></span></div></pre></td></tr></table></figure>
<h2 id="部署多人接收微信告警消息"><a href="#部署多人接收微信告警消息" class="headerlink" title="部署多人接收微信告警消息"></a>部署多人接收微信告警消息</h2><p>首先登录微信企业号（<a href="https://qy.weixin.qq.com/）" target="_blank" rel="external">https://qy.weixin.qq.com/）</a><br>向微信企业号接收Zabbix告警消息组添加成员<br><img src="http://note.youdao.com/yws/api/personal/file/68D00BECEDAF4791B33CB165276658AA?method=download&amp;shareKey=b1335d8c293e48f5f12f3da3b6b1d293" alt="weichat_qiyehao_adduser"><br><img src="http://note.youdao.com/yws/api/personal/file/1A04970180AD4D0F96B5340E974FF810?method=download&amp;shareKey=2c9224ac567e884ca3534ba97b57ea62" alt="weichat_qiyehao_adduser"><br><img src="http://note.youdao.com/yws/api/personal/file/B2772F26140749BDB402226AF66BD7C3?method=download&amp;shareKey=e23f076e044711a364e57e097e71c51d" alt="weichat_qiyehao_adduser">  </p>
<p>这里在部署时设置好后就不需要在操作了<br><img src="http://note.youdao.com/yws/api/personal/file/2E88038AF4814B7F85AB7B7A5782AC7F?method=download&amp;shareKey=e666f11a513f2926a71b28c555e0fcf6" alt="image">  </p>
<p>登录Zabbix Web Gui<br>管理–用户–admin–报警媒介–微信<br><img src="http://note.youdao.com/yws/api/personal/file/B3039377906B4D5A8DBAC67B379E9A4F?method=download&amp;shareKey=43fd59327f2a5e613bf9cb67443d3c83" alt="zabbix_weichat_mess_adduser">  </p>
<p>测试<br><img src="http://note.youdao.com/yws/api/personal/file/D974AE71BAC64D56A025543156B82354?method=download&amp;shareKey=bcd9d048f215fb8398f2c8eb5d2a638c" alt="test_weichat_mess_success"><br>成功  </p>
<p>附件：<br><a href="http://note.youdao.com/yws/api/personal/file/449F75BD69AA4C15B674BD86A5FCCDB2?method=download&amp;shareKey=15151d67315543cc69a2480e253597ec" target="_blank" rel="external">weichat.sh</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="https://yfshare.github.io">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="https://yfshare.github.io/2017/04/13/Zabbix之微信-Wechat-告警/">https://yfshare.github.io/2017/04/13/Zabbix之微信-Wechat-告警/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Zabbix告警可以通过邮件，微信，电话，短信等方式发送告警消息。电话和短信需要向运营商购买相应的网关，需要付费；邮件和微信是免费的，可以根据业务需要选择相应的告警模式&lt;br&gt;
    
    </summary>
    
      <category term="Zabbix" scheme="https://yfshare.github.io/categories/Zabbix/"/>
    
    
      <category term="zabbix" scheme="https://yfshare.github.io/tags/zabbix/"/>
    
      <category term="wechat" scheme="https://yfshare.github.io/tags/wechat/"/>
    
      <category term="warn" scheme="https://yfshare.github.io/tags/warn/"/>
    
  </entry>
  
  <entry>
    <title>部署Oracle-RAC集群</title>
    <link href="https://yfshare.github.io/2017/04/12/%E9%83%A8%E7%BD%B2Oracle-RAC%E9%9B%86%E7%BE%A4/"/>
    <id>https://yfshare.github.io/2017/04/12/部署Oracle-RAC集群/</id>
    <published>2017-04-12T01:47:00.000Z</published>
    <updated>2017-04-15T06:40:56.229Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>RAC：real application clusters introduction  </p>
<p>ORACLE RAC原理：<br>在一个应用环境当中，所有的服务器使用和管理同一个数据库，目的是为了分散每一台服务器的工作量，硬件上至少需要两台以上的服务器，而且还需一个共享存储设备。还需要两类软件，一个是集群软件，另外一个就是Oracle数据库中的RAC组件，所有服务器上的OS都应该是同一类OS。<br><a id="more"></a><br>根据负载均衡的配置策略，当一个客户端发送请求到某一台服务的listener后，这台服务器根据负载均衡策略，会把请求发送给本机的RAC组件处理，也可能会发送给另外一台服务器的RAC组件处理，处理完请求后，RAC会通过集群软件来访问我们的共享存储设备。</p>
<p>逻辑结构上，每一个参加集群的节点有一个独立的instance，这些instance访问同一个数据库。节点之间通过集群软件的通讯层（communication layer）来进行通讯。同时为了减少IO的消耗，存在了一个全局缓存服务，因此每一个数据库的instance，都保留了一份相同的数据库cache。</p>
<p>RAC中的特点是：<br>每一个节点的instance都有自己的SGA，background process，redo logs，undo表空间<br>所有节点都共享一份datafiles和controlfiles</p>
<p>Oracle缓存融合技术(Cache fusion):  </p>
<ol>
<li>保证缓存的一致性  </li>
<li>减少共享磁盘IO的消耗</li>
</ol>
<p>缓存融合原理：  </p>
<ol>
<li>其中一个节点会从共享数据库中读取一个block到db cache中</li>
<li>这个节点会在所有的节点进行交叉db block copy</li>
<li>当任何一个节点缓存被修改的时候，就会在节点之间进行缓存修改</li>
<li>为了达到存储的一致最终修改的结果也会写到磁盘上</li>
</ol>
<p>ClusterWare组件：<br>有四种服务  </p>
<ul>
<li>Crsd - 集群资源服务</li>
<li>Cssd - 集群同步服务</li>
<li>Evmd - 事件管理服务</li>
<li>oprocd - 节点检测监控</li>
</ul>
<p>三类Resource  </p>
<ul>
<li>VIP - 虚拟IP地址(Virtual IP)</li>
<li>OCR - Oracle Cluster Registry(集群注册文件),记录每个节点的相关信息</li>
<li>Voting Disk - Establishes quorum (表决磁盘),仲裁机制用于仲裁多个节点向共享节点同时写的行为，这样做是为了避免发生冲突</li>
</ul>
<p>RAC组件：<br>提供过了额外的进程，用来维护数据库  </p>
<ul>
<li>LMS - Gobal Cache Service Process 全局缓存服务进程</li>
<li>LMD - Global Enqueue Service Daemon 全局查询服务守护进程</li>
<li>LMON - Global Enqueue Service Monitor全局查询服务监视进程</li>
<li>LCK0 - Instance Enqueue Process 实例查询进程</li>
</ul>
<h2 id="规划"><a href="#规划" class="headerlink" title="规划"></a>规划</h2><p>拓扑图：<br><img src="http://note.youdao.com/yws/api/personal/file/36F1D89D60D64C6AAD28358C84DCE3BF?method=download&amp;shareKey=87cdeb07ee5b622b6164e2f6d6c746b1" alt="tuopu">  </p>
<p>IP规划</p>
<table>
<thead>
<tr>
<th style="text-align:center">Node</th>
<th style="text-align:center">Public IP(Bond0)</th>
<th style="text-align:center">Heartbeat(eth2)</th>
<th style="text-align:center">Private IP</th>
<th style="text-align:center">System</th>
<th style="text-align:center">hostname</th>
<th style="text-align:center">Memory</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">RAC1</td>
<td style="text-align:center">192.168.100.241/24</td>
<td style="text-align:center">192.168.90.1/24</td>
<td style="text-align:center">eth3：192.168.80.1/24</td>
<td style="text-align:center">Centos 6.4</td>
<td style="text-align:center">rac1.example.com</td>
<td style="text-align:center">3G</td>
</tr>
<tr>
<td style="text-align:center">RAC2</td>
<td style="text-align:center">192.168.100.242/24</td>
<td style="text-align:center">192.168.90.2/24</td>
<td style="text-align:center">eth3：192.168.80.1/24</td>
<td style="text-align:center">Centos 6.4</td>
<td style="text-align:center">rac2.example.com</td>
<td style="text-align:center">3G</td>
</tr>
<tr>
<td style="text-align:center">Storage</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">bond0：192.168.80.3/24</td>
<td style="text-align:center">CentOS 6.4</td>
<td style="text-align:center">iscsi</td>
<td style="text-align:center">512M</td>
</tr>
</tbody>
</table>
<p>Storage磁盘规划</p>
<table>
<thead>
<tr>
<th>存储组件</th>
<th>文件系统</th>
<th>卷大小</th>
<th>ASM卷组名</th>
<th>ASM冗余</th>
<th>ASM磁盘组</th>
</tr>
</thead>
<tbody>
<tr>
<td>OCR/表决磁盘</td>
<td>ASM</td>
<td>2G</td>
<td>+CRS</td>
<td>External</td>
<td>DISK1</td>
</tr>
<tr>
<td>数据库文件</td>
<td>ASM</td>
<td>40G</td>
<td>+RACDB_DATA</td>
<td>External</td>
<td>DISK2</td>
</tr>
<tr>
<td>快速恢复区</td>
<td>ASM</td>
<td>40G</td>
<td>+FRA</td>
<td>External</td>
<td>DISK3</td>
</tr>
</tbody>
</table>
<h2 id="安装前准备"><a href="#安装前准备" class="headerlink" title="安装前准备"></a>安装前准备</h2><p>环境：Centos 6.4<br>　　　Oracle 11.2.0.4  </p>
<p>附件：<br><a href="http://note.youdao.com/yws/api/personal/file/3F26DCE4F66E4A92955421AD81907702?method=download&amp;shareKey=171e55b45eb00b0b4a04c19c94713f9d" target="_blank" rel="external">hosts</a><br><a href="http://note.youdao.com/yws/api/personal/file/EBE77CFA3E284EB6B536742A65ACB240?method=download&amp;shareKey=532b531d1b9e1b365f917c08268b1058" target="_blank" rel="external">cvuqdisk-1.0.9-1.rpm</a><br><a href="http://note.youdao.com/yws/api/personal/file/E8045FCC036D451CACE873C042919AB3?method=download&amp;shareKey=c990c68ec5fe93a69e4cfd97310d9ba9" target="_blank" rel="external">pdksh-5.2.14-1.i386.rpm</a><br><a href="http://note.youdao.com/yws/api/personal/file/918F64A65F6B4723AE40E7415A0D0D97?method=download&amp;shareKey=0671839fd7336ba472007fd158a0b91c" target="_blank" rel="external">plsql+instantclient_11_2安装包</a>  </p>
<p>利用ISCSI搭建后台存储<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@iscsi ~]<span class="comment"># tgt-admin -s|grep -i target</span></div><div class="line">Target 1: iqn.disk1</div><div class="line">Target 2: iqn.disk2</div><div class="line">Target 3: iqn.disk3</div><div class="line">[root@iscsi ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>rac1和rac2挂载后分区<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@rac1 software]<span class="comment"># fdisk -l|grep sd|tail -n 3</span></div><div class="line">Disk /dev/sdb: 2147 MB, 2147483648 bytes</div><div class="line">Disk /dev/sdc: 42.9 GB, 42949672960 bytes</div><div class="line">Disk /dev/sdd: 42.9 GB, 42949672960 bytes</div><div class="line">[root@rac1 software]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@rac1 ~]<span class="comment"># hostname</span></div><div class="line">rac1.example.com</div><div class="line">[root@rac1 ~]<span class="comment">#</span></div><div class="line">[root@rac2 ~]<span class="comment"># hostname</span></div><div class="line">rac2.example.com</div><div class="line">[root@rac2 ~]<span class="comment">#</span></div><div class="line">[root@rac1 ~]<span class="comment"># ping rac2.example.com -c 3</span></div><div class="line">PING rac2 (192.168.100.242) 56(84) bytes of data.</div><div class="line">64 bytes from rac2 (192.168.100.242): icmp_seq=1 ttl=64 time=0.622 ms</div><div class="line">64 bytes from rac2 (192.168.100.242): icmp_seq=2 ttl=64 time=0.369 ms</div></pre></td></tr></table></figure>
<p>在rac1和rac2上需要做地址解析<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">[root@rac1 ~]<span class="comment"># tail -n 19 /etc/hosts</span></div><div class="line"><span class="comment">#Public Network</span></div><div class="line">192.168.100.241	rac1	rac1.example.com</div><div class="line">192.168.100.242 rac2	rac2.example.com</div><div class="line"></div><div class="line"><span class="comment">#Public Virtual IP (VIP) addresses</span></div><div class="line">192.168.100.244	rac1-vip</div><div class="line">192.168.100.245	rac2-vip</div><div class="line"></div><div class="line"><span class="comment">#Single Client Access Name (SCAN)</span></div><div class="line">192.168.100.246	racscan</div><div class="line"></div><div class="line"><span class="comment">#Private Interconnect</span></div><div class="line">192.168.90.1 rac1-priv</div><div class="line">192.168.90.2 rac2-priv</div><div class="line"></div><div class="line"><span class="comment">#Private Storage Network</span></div><div class="line">192.168.80.1 rac1<span class="_">-s</span></div><div class="line">192.168.80.2 rac2<span class="_">-s</span></div><div class="line">192.168.80.3 iscsi</div><div class="line">[root@rac1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>关闭防火墙和Selinux<br>要求：内存至少2G，swap：16GB内存以内内存的1.5或者1倍，16GB内存以上设置16GB<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@rac1 software]<span class="comment"># uname -a</span></div><div class="line">Linux rac1 2.6.32-358.el6.x86_64 <span class="comment">#1 SMP Fri Feb 22 00:31:26 UTC 2013 x86_64 x86_64 x86_64 GNU/Linux</span></div><div class="line">[root@rac1 ~]<span class="comment">#</span></div><div class="line">[root@rac1 ~]<span class="comment"># ntpdate time.windows.com</span></div><div class="line">[root@rac1 ~]<span class="comment"># df -h|grep shm</span></div><div class="line">tmpfs                  10G     0   10G   0% /dev/shm</div><div class="line">[root@rac1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/DD5C35B377C24C52BEA24662EB8338CE?method=download&amp;shareKey=b2cc6c7953190c0f83d0e38c951df89e" alt="image"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@rac1 ~]<span class="comment"># yum -y install binutils* elfutils-libelf* compat-libstdc++* compat-libcap1* gcc gcc-c++ ksh libaio* libgcc* libstdc++* make* sysstat unixODBC* glibc*</span></div><div class="line">[root@rac1 ~]<span class="comment"># rpm -ivh pdksh-5.2.14-1.i386.rpm --nodeps --force</span></div><div class="line">[root@rac1 ~]<span class="comment"># yum -y install xhost</span></div><div class="line">[root@rac1 ~]<span class="comment"># groupadd oinstall</span></div><div class="line">[root@rac1 ~]<span class="comment"># groupadd dba</span></div><div class="line">[root@rac1 ~]<span class="comment"># groupadd oper</span></div><div class="line">[root@rac1 ~]<span class="comment"># groupadd asmadmin</span></div><div class="line">[root@rac1 ~]<span class="comment"># groupadd asmoper</span></div><div class="line">[root@rac1 ~]<span class="comment"># groupadd asmdba</span></div><div class="line">[root@rac1 ~]<span class="comment"># useradd -g oinstall -G asmadmin,asmdba,asmoper,dba grid</span></div><div class="line">[root@rac1 ~]<span class="comment"># useradd -g oinstall -G dba,asmdba,oper oracle</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#资源限制</span></div><div class="line">[root@rac1 ~]<span class="comment"># tail -n 12 /etc/security/limits.conf</span></div><div class="line"><span class="comment">#for oracle</span></div><div class="line">oracle soft nproc 2047</div><div class="line">oracle hard nproc 16384</div><div class="line">oracle soft nofile 1024</div><div class="line">oracle hard nofile 65536</div><div class="line">oracle soft stack 10240</div><div class="line"><span class="comment">#for grid</span></div><div class="line">grid soft nproc 2047</div><div class="line">grid hard nproc 16384</div><div class="line">grid soft nofile 1024</div><div class="line">grid hard nofile 65536</div><div class="line">grid soft stack 10240</div><div class="line">[root@rac1 ~]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@rac1 ~]<span class="comment"># tail -n 2 /etc/pam.d/login</span></div><div class="line"><span class="comment">#oracle</span></div><div class="line">session	  required	pam_limits.so</div><div class="line">[root@rac1 ~]<span class="comment">#</span></div><div class="line">[root@rac1 ~]<span class="comment"># tail -n 12 /etc/sysctl.conf</span></div><div class="line"><span class="comment">#oracle</span></div><div class="line">fs.aio-max-nr = 1048576</div><div class="line">fs.file-max = 6815744</div><div class="line">kernel.shmall = 2097152</div><div class="line">kernel.shmmax = 4294967295</div><div class="line">kernel.shmmni = 4096</div><div class="line">kernel.sem = 250 32000 100 128</div><div class="line">net.ipv4.ip_local_port_range = 9000 65500</div><div class="line">net.core.rmem_default = 262144</div><div class="line">net.core.rmem_max = 4194304</div><div class="line">net.core.wmem_default = 262144</div><div class="line">net.core.wmem_max = 1048576</div><div class="line">[root@rac1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@rac1 ~]<span class="comment"># mkdir -p /u01/app/grid</span></div><div class="line">[root@rac1 ~]<span class="comment"># mkdir -p /u01/app/11.2.0/grid</span></div><div class="line">[root@rac1 ~]<span class="comment"># chown -R grid:oinstall /u01</span></div><div class="line">[root@rac1 ~]<span class="comment"># mkdir -p /u01/app/oracle</span></div><div class="line">[root@rac1 ~]<span class="comment"># chown -R oracle:oinstall /u01/app/oracle</span></div><div class="line">[root@rac1 ~]<span class="comment"># chmod -R 775 /u01</span></div><div class="line">[root@rac1 ~]<span class="comment"># mkdir /oradata</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#设置环境变量</span></div><div class="line">[root@rac1 ~]<span class="comment"># su - oracle</span></div><div class="line">[oracle@rac1 ~]$ tail -n 8 .bash_profile</div><div class="line"><span class="comment">#oracle</span></div><div class="line"><span class="built_in">export</span> ORACLE_BASE=/u01/app/oracle</div><div class="line"><span class="built_in">export</span> ORACLE_SID=racdb1</div><div class="line"><span class="built_in">export</span> ORACLE_HOME=<span class="variable">$ORACLE_BASE</span>/product/11.2.0/db_1</div><div class="line"><span class="built_in">export</span> LD_LIBARY_PATH=<span class="variable">$ORACLE_HOME</span>/lib</div><div class="line"><span class="built_in">export</span> PATH=<span class="variable">$ORACLE_HOME</span>/bin:<span class="variable">$PATH</span></div><div class="line"><span class="built_in">export</span> ORACLE_UNQNAME=racdb</div><div class="line"><span class="built_in">umask</span> 022</div><div class="line">[oracle@rac1 ~]$ <span class="built_in">source</span> .bash_profile</div><div class="line">[oracle@rac1 ~]$ <span class="built_in">echo</span> <span class="variable">$ORACLE_HOME</span></div><div class="line">/u01/app/oracle/product/11.2.0/db_1</div><div class="line">[oracle@rac1 ~]$ <span class="built_in">echo</span> <span class="variable">$ORACLE_BASE</span></div><div class="line">/u01/app/oracle</div><div class="line">[oracle@rac1 ~]$</div><div class="line"></div><div class="line">[grid@rac1 ~]$ tail -n 7 .bash_profile</div><div class="line"><span class="comment">#oracle</span></div><div class="line"><span class="built_in">export</span> ORACLE_BASE=/u01/app/grid</div><div class="line"><span class="built_in">export</span> ORACLE_SID=+ASM1</div><div class="line"><span class="built_in">export</span> ORACLE_HOME=/u01/app/11.2.0/grid</div><div class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=<span class="variable">$ORACLE_HOME</span>/lib</div><div class="line"><span class="built_in">export</span> PATH=<span class="variable">$ORACLE_HOME</span>/bin:<span class="variable">$PATH</span></div><div class="line"><span class="built_in">umask</span> 022</div><div class="line">[grid@rac1 ~]$ <span class="built_in">source</span> .bash_profile</div><div class="line">[gr[grid@rac1 ~]$ <span class="built_in">echo</span> <span class="variable">$ORACLE_BASE</span></div><div class="line">/u01/app/grid</div><div class="line">[grid@rac1 ~]$ <span class="built_in">echo</span> <span class="variable">$ORACLE_HOME</span></div><div class="line">/u01/app/11.2.0/grid</div><div class="line">[grid@rac1 ~]$</div><div class="line"></div><div class="line">[grid@rac2 ~]$ grep SID .bash_profile</div><div class="line"><span class="built_in">export</span> ORACLE_SID=+ASM2</div><div class="line">[grid@rac2 ~]$</div><div class="line"></div><div class="line">[oracle@rac2 ~]$ grep SID .bash_profile</div><div class="line"><span class="built_in">export</span> ORACLE_SID=racdb2</div><div class="line">[oracle@rac2 ~]$</div><div class="line">以上步骤第二个节点也同样操作</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#配置SSH互信</span></div><div class="line">[grid@rac1 sshsetup]$ <span class="built_in">pwd</span></div><div class="line">/software/grid/sshsetup</div><div class="line">[grid@rac1 sshsetup]$ ./sshUserSetup.sh -user grid -hosts rac2.example.com -advanced -exverify -confirm -noPromptPassphrase</div><div class="line">[grid@rac1 sshsetup]$</div></pre></td></tr></table></figure>
<p><img src="http://note.youdao.com/yws/api/personal/file/9118C973FE614DCCBBA3F5BA6AEB41EC?method=download&amp;shareKey=a34b7dbec01e15dcd522013c0045af23" alt="ssh互信"><br><img src="http://note.youdao.com/yws/api/personal/file/6912860CAE2C4AADB5861B26A578A7CA?method=download&amp;shareKey=f7498f91cf7007e3b73de0362548bbdf" alt="ssh互信">  </p>
<p>检查下会不会出现下面的情况。如果出现在测试SSH互信时会包INS-06006的错误<br><img src="http://note.youdao.com/yws/api/personal/file/1FD46DDB71034ACEBB41F2C3B5C16104?method=download&amp;shareKey=71aa8faaca754212dc512af07d428f1f" alt="ssh_date1"><br><img src="http://note.youdao.com/yws/api/personal/file/843B1CBBA6B149D7B10D5DACB4424B11?method=download&amp;shareKey=da67f85fc412182ed0ea0900020cedc4" alt="ssh_date2"><br><img src="http://note.youdao.com/yws/api/personal/file/4315C5D7C6604B67AF2AD4BA8EB8C182?method=download&amp;shareKey=dcdc2804e2d9e67c62675b387b03cf58" alt="image"><br><img src="http://note.youdao.com/yws/api/personal/file/DB73EC487F3B42CDA69B8F5689922938?method=download&amp;shareKey=9edb234b13e3501524f96774150519b1" alt="image">  </p>
<p>安装cvuqdisk，发现共享磁盘(rac1和rac2都安装)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@rac1 ~]<span class="comment"># CVUQDISK_GRP=oinstall &amp;&amp; export CVUQDISK_GRP</span></div><div class="line">[root@rac1 software]<span class="comment"># yum -y install smartmontools</span></div><div class="line">[root@rac1 software]<span class="comment"># yum -y install cvuqdisk-1.0.9-1.rpm</span></div></pre></td></tr></table></figure></p>
<p>使用UDEV绑定ASM<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@rac1 ~]<span class="comment"># echo "options=--whitelisted --replace-whitespace"  &gt;&gt; /etc/scsi_id.config</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#UDEV绑定ASM脚本</span></div><div class="line"><span class="built_in">declare</span> -i num =0</div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> b c d;</div><div class="line"><span class="keyword">do</span></div><div class="line"><span class="built_in">let</span> num=<span class="variable">$num</span>+1</div><div class="line"><span class="built_in">echo</span> <span class="string">"KERNEL==\"sd*\", BUS==\"scsi\", PROGRAM==\"/sbin/scsi_id --whitelisted --replace-whitespace --device=/dev/\$name\", RESULT==\"`/sbin/scsi_id --whitelisted --replace-whitespace --device=/dev/sd<span class="variable">$i</span>`\", NAME=\"asm-disk<span class="variable">$num</span>\", OWNER=\"grid\", GROUP=\"asmadmin\", MODE=\"0660\""</span> &gt;&gt; /etc/udev/rules.d/12-oracle-asmdevices.rules</div><div class="line"><span class="keyword">done</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#使用start_udev命令重新启动udev服务</span></div><div class="line">[root@rac1 ~]<span class="comment"># start_udev</span></div><div class="line">Starting udev:                                             [  OK  ]</div><div class="line">[root@rac1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#12-oracle-asmdevices.rules</span></div><div class="line"><span class="comment">#UDEV策略</span></div><div class="line">KERNEL==<span class="string">"sd*"</span>, BUS==<span class="string">"scsi"</span>, PROGRAM==<span class="string">"/sbin/scsi_id --whitelisted --replace-whitespace --device=/dev/<span class="variable">$name</span>"</span>, RESULT==<span class="string">"1IET_00010001"</span>, NAME=<span class="string">"asm-disk1"</span>, OWNER=<span class="string">"grid"</span>, GROUP=<span class="string">"asmadmin"</span>, MODE=<span class="string">"0660"</span></div><div class="line">KERNEL==<span class="string">"sd*"</span>, BUS==<span class="string">"scsi"</span>, PROGRAM==<span class="string">"/sbin/scsi_id --whitelisted --replace-whitespace --device=/dev/<span class="variable">$name</span>"</span>, RESULT==<span class="string">"1IET_00020002"</span>, NAME=<span class="string">"asm-disk2"</span>, OWNER=<span class="string">"grid"</span>, GROUP=<span class="string">"asmadmin"</span>, MODE=<span class="string">"0660"</span></div><div class="line">KERNEL==<span class="string">"sd*"</span>, BUS==<span class="string">"scsi"</span>, PROGRAM==<span class="string">"/sbin/scsi_id --whitelisted --replace-whitespace --device=/dev/<span class="variable">$name</span>"</span>, RESULT==<span class="string">"1IET_00030003"</span>, NAME=<span class="string">"asm-disk3"</span>, OWNER=<span class="string">"grid"</span>, GROUP=<span class="string">"asmadmin"</span>, MODE=<span class="string">"0660"</span></div></pre></td></tr></table></figure>
<p><img src="http://note.youdao.com/yws/api/personal/file/4968F05A3DAC4C71A8E945E8C3E6DBB3?method=download&amp;shareKey=c8d8aab71065291750db66df1e62939d" alt="image"><br>固化磁盘后Linux就无法读取到/dev/sdb、/dev/sdc、/dev/sdd了，在rac1上固化磁盘后，rac2上也需要执行下上面的脚本，注意匹配PROGRAM的值，需要与节点一的相同<br>注：如果使用UDEV绑定磁盘后所属组不是asmadmin，需要手动改下，否则在创建数据库(dbca)时会报错，如下图：<br><img src="http://note.youdao.com/yws/api/personal/file/FE485775F730495B8D65775CAF10F0A0?method=download&amp;shareKey=a48e258d0439272956fc6a1228eb14df" alt="image"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@rac1 ~]<span class="comment"># chown grid:asmadmin /dev/asm-disk*</span></div><div class="line">[root@rac1 ~]<span class="comment"># echo "chown grid:asmadmin /dev/asm-disk*" &gt;&gt;/etc/rc.local</span></div></pre></td></tr></table></figure></p>
<p>更改后：<br><img src="http://note.youdao.com/yws/api/personal/file/7D70E68FA40A4B8F9337103C37F19FD6?method=download&amp;shareKey=c2cef35b5512fbfd2fb5be4348694769" alt="image">  </p>
<h2 id="安装Grid"><a href="#安装Grid" class="headerlink" title="安装Grid"></a>安装Grid</h2><p>用grid用户登录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[grid@rac1 grid]$ <span class="built_in">export</span> DISPLAY=192.168.100.251:0.0</div><div class="line">[grid@rac1 grid]$ ./runInstaller</div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/FE8E61CC6E3E45F6A26DC92ED45D55D9?method=download&amp;shareKey=102774b58ddc8d9968ed2522a262bdd3" alt="grid_install"><br><img src="http://note.youdao.com/yws/api/personal/file/CFD0CBA42ABD4398AA646F45E51E8F3E?method=download&amp;shareKey=50203b8136874ce61978cf085e26bdc5" alt="grid_install"><br><img src="http://note.youdao.com/yws/api/personal/file/CCC009BB056645339376A817ADBBDE2C?method=download&amp;shareKey=bf0c55f1a04c50bd2ff6a191d0d29083" alt="grid_install"><br><img src="http://note.youdao.com/yws/api/personal/file/2E31CD4F29A349308C5EDE45C297C8F8?method=download&amp;shareKey=4efb135eed5c139437b4212f06e57280" alt="grid_install">  </p>
<p>需要在/etc/hosts里面解析racscan，否则会报：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[INS-40718] Single Client Access Name (SCAN):RACSCAN1 could not be resolved.</div></pre></td></tr></table></figure></p>
<p>但racscan不是真实存在的地址<br><img src="http://note.youdao.com/yws/api/personal/file/FF0748FF48B142AB859C7D9963B1B45B?method=download&amp;shareKey=b45ec81818a4873f70e445528eb77bca" alt="grid_install">  </p>
<p>Test和Setup均能通过<br><img src="http://note.youdao.com/yws/api/personal/file/17D7FE8F5E43433D8A4F8C2E3598D9EA?method=download&amp;shareKey=89108bde8e1ce16654c058b090ec0af5" alt="grid_install">  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[INS-40912] Virtual host name: rac1-vip is assigned to another system on the network.</div></pre></td></tr></table></figure>
<p>参考：<a href="https://community.oracle.com/thread/2594182" target="_blank" rel="external">https://community.oracle.com/thread/2594182</a><br>如果出现上面的报错信息，看下/etc/hosts里面的Virtual IP是否存在，ping一下<br><img src="http://note.youdao.com/yws/api/personal/file/2BDD7464264E45468E94FE7B82FE317C?method=download&amp;shareKey=9f0d48e5dbe439b46ae4e9d5fcdd0e3c" alt="rac_vip">  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/2BF28D6032274BC0935B3751AB90C015?method=download&amp;shareKey=a5ea2082ec4ad6802f2465ffa1e18f31" alt="grid_install"><br><img src="http://note.youdao.com/yws/api/personal/file/D90DA12B5BBD4EE294AE2F545BC73CF5?method=download&amp;shareKey=7b5c6c05a3a4d708b19d6347920a5de7" alt="grid_install"><br><img src="http://note.youdao.com/yws/api/personal/file/7EB263CDE75C4802AA045A3FBF22919A?method=download&amp;shareKey=7f4e16907a66e49ed5ef2a2c0e8760c4" alt="grid_install"><br><img src="http://note.youdao.com/yws/api/personal/file/900E5DE683CA470386D1F63D16A39162?method=download&amp;shareKey=9e185e802aa2c8d2b75b46d99d1ff2d3" alt="grid_install"><br><img src="http://note.youdao.com/yws/api/personal/file/8409B55D39224F64A3B631A9C38B198B?method=download&amp;shareKey=06b72a1b028c64847704e4f5334a5a09" alt="grid_install"><br><img src="http://note.youdao.com/yws/api/personal/file/9891079073064BDAA3E1D6024AAFEB87?method=download&amp;shareKey=2dfe1d8c8cc1e5fc752c489830813baf" alt="grid_install">  </p>
<p>在grid用户的环境变量，$ORACLE_HOME  不能是  $ORACLE_BASE  子目录，否则会报错：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ORACLE 11G RAC [INS-32026] The Software Location specified should not</div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/1FE9A53C986042DEAFE66CD3DD533AB9?method=download&amp;shareKey=ff9b937ad40d6907acf04fd05f8a4806" alt="grid_install"><br><img src="http://note.youdao.com/yws/api/personal/file/DC323BFFE5044728B6025E7309DF4574?method=download&amp;shareKey=f91d6af7a55af38fb301679989c79bc7" alt="grid_install">  </p>
<p>因为这里使用是的udev绑定，这个警告可以忽略<br><img src="http://note.youdao.com/yws/api/personal/file/BC0579F86B5149E693285E4523E403D2?method=download&amp;shareKey=6227b8857a1a02cf34d1dedf3b6bbbb7" alt="grid_install"><br><img src="http://note.youdao.com/yws/api/personal/file/9C7E26FF75BA443A9B82D6EA84DE664D?method=download&amp;shareKey=f022760193ab0d46240a5d51f1ff68ef" alt="grid_install">  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@rac1 ~]<span class="comment"># /u01/app/oraInventory/orainstRoot.sh</span></div><div class="line">Changing permissions of /u01/app/oraInventory.</div><div class="line">Adding <span class="built_in">read</span>,write permissions <span class="keyword">for</span> group.</div><div class="line">Removing <span class="built_in">read</span>,write,execute permissions <span class="keyword">for</span> world.</div><div class="line"></div><div class="line">Changing groupname of /u01/app/oraInventory to oinstall.</div><div class="line">The execution of the script is complete.</div><div class="line">[root@rac1 ~]<span class="comment">#</span></div><div class="line">[root@rac1 ~]<span class="comment"># /u01/app/11.2.0/grid/root.sh</span></div></pre></td></tr></table></figure>
<p>执行上面这个脚本如果报下面的错误<br><img src="http://note.youdao.com/yws/api/personal/file/A8F28B38E831479288A74182A788A7CE?method=download&amp;shareKey=258f1581e7fd15d73a768c0b1c870fbf" alt="grid_root"><br>解决方法：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@rac1 ~]<span class="comment"># yum -y install compat-libcap1*</span></div></pre></td></tr></table></figure></p>
<p>再执行/u01/app/11.2.0/grid/root.sh就没问题了<br>执行过程如下：<br><a href="http://note.youdao.com/yws/api/personal/file/5F86C7E0A3564106AAE09443614C4DB3?method=download&amp;shareKey=cd8ebff8d5e7a14cb9a5f306aced24e1" target="_blank" rel="external">rac1_u01_app_11.2.0_grid_root.sh执行过程</a><br><a href="http://note.youdao.com/yws/api/personal/file/7E8ACFD112234C4EAA6CFE3C598B81F1?method=download&amp;shareKey=b26ccf10fcffe85e535e19acb0045a8b" target="_blank" rel="external">rac1_u01_app_11.2.0_grid_root.sh执行过程</a><br>在rac1和rac2上都执行下↑↑↑(/u01/app/oraInventory/orainstRoot.sh和/u01/app/11.2.0/grid/root.sh)<br>在Install Product过程中如果出现下面的情况：(忽略）<br><img src="http://note.youdao.com/yws/api/personal/file/F91F56DC002140609177534DF6FA056D?method=download&amp;shareKey=1550687b6616e3380e772de03c512112" alt="grid_install">  </p>
<p>如果出现这个错误且能ping通racscan地址(192.168.100.246)，则可忽略<br><img src="http://note.youdao.com/yws/api/personal/file/F31B12CB31274E2CA5C7E869A0748EA9?method=download&amp;shareKey=61375d52ca2da7f0e08dd2c1e82fc6df" alt="grid_install"><br><img src="http://note.youdao.com/yws/api/personal/file/B0B0273158F3455B90DCD83990DD8F70?method=download&amp;shareKey=be794a83daed905874d9c917a85ded8d" alt="ping_racscan"><br><img src="http://note.youdao.com/yws/api/personal/file/6CC8AFF1F00D49A08ADFB36ACF617494?method=download&amp;shareKey=5ff8cb14275aba741f968b0d4f7fedf9" alt="grid_install">  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#检查crs状态</span></div><div class="line">[grid@rac1 grid]$ crsctl check crs</div><div class="line">CRS-4638: Oracle High Availability Services is online</div><div class="line">CRS-4537: Cluster Ready Services is online</div><div class="line">CRS-4529: Cluster Synchronization Services is online</div><div class="line">CRS-4533: Event Manager is online</div><div class="line"></div><div class="line"><span class="comment">#打印节点编号和节点名</span></div><div class="line">[grid@rac1 grid]$ olsnodes -n</div><div class="line">rac1	1</div><div class="line">rac2	2</div><div class="line"></div><div class="line"><span class="comment">#检测ctss状态</span></div><div class="line">[grid@rac1 grid]$ crsctl check ctss</div><div class="line">CRS-4701: The Cluster Time Synchronization Service is <span class="keyword">in</span> Active mode.</div><div class="line">CRS-4702: Offset (<span class="keyword">in</span> msec): 0</div><div class="line"></div><div class="line"><span class="comment">#显示指定数据库当前状态</span></div><div class="line">[grid@rac1 grid]$ srvctl status asm <span class="_">-a</span></div><div class="line">ASM is running on rac2,rac1</div><div class="line">ASM is enabled.</div><div class="line"></div><div class="line"><span class="comment">#显示注册Oracle集群的健康状态</span></div><div class="line">[grid@rac1 grid]$ ocrcheck</div><div class="line">Status of Oracle Cluster Registry is as follows :</div><div class="line">  Version                  :          3</div><div class="line">  Total space (kbytes)     :     262120</div><div class="line">  Used space (kbytes)      :       2592</div><div class="line">  Available space (kbytes) :     259528</div><div class="line">  ID                       : 1975731354</div><div class="line">  Device/File Name         :       +CRS</div><div class="line">                                    Device/File integrity check succeeded</div><div class="line"></div><div class="line">                                    Device/File not configured</div><div class="line"></div><div class="line">                                    Device/File not configured</div><div class="line"></div><div class="line">                                    Device/File not configured</div><div class="line"></div><div class="line">                                    Device/File not configured</div><div class="line"></div><div class="line">  Cluster registry integrity check succeeded</div><div class="line"></div><div class="line">  Logical corruption check bypassed due to non-privileged user</div><div class="line"></div><div class="line"><span class="comment">#查看votedisk磁盘位置</span></div><div class="line">[grid@rac1 grid]$ crsctl query css votedisk</div><div class="line"><span class="comment">##  STATE    File Universal Id                File Name Disk group</span></div><div class="line">--  -----    -----------------                --------- ---------</div><div class="line"> 1. ONLINE   65b9ef5913044fdbbff0d1b75e91172e (/dev/asm-disk1) [CRS]</div><div class="line">Located 1 voting disk(s).</div><div class="line">[grid@rac1 grid]$</div></pre></td></tr></table></figure>
<h2 id="创建ASM磁盘"><a href="#创建ASM磁盘" class="headerlink" title="创建ASM磁盘"></a>创建ASM磁盘</h2><p>grid用户登录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[grid@rac1 ~]$ <span class="built_in">export</span> DISPLAY=192.168.100.251:0.0</div><div class="line">[grid@rac1 ~]$ xhost +</div><div class="line">access control disabled, clients can connect from any host</div><div class="line">[grid@rac1 ~]$ asmca</div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/03C4A43AD7A64661A9D1D6F7EC185DC5?method=download&amp;shareKey=5fc81aaaeffd229cb98d98f55d4d0c4b" alt="ASM_install"><br><img src="http://note.youdao.com/yws/api/personal/file/04B843E1A9F34108BB17BF03C1C20CE8?method=download&amp;shareKey=04a0908d8bad5e7ed95fbba6cb0c0ec6" alt="ASM_install"><br><img src="http://note.youdao.com/yws/api/personal/file/094F58FBCE7C40529956B7953030953E?method=download&amp;shareKey=a08ff5ab2bfb4bb7b763ae9dc3540bd8" alt="ASM_install">  </p>
<h2 id="安装database"><a href="#安装database" class="headerlink" title="安装database"></a>安装database</h2><p>用Oracle用户登录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[oracle@rac1 ~]$ <span class="built_in">export</span> DISPLAY=192.168.100.251:0.0</div><div class="line">[oracle@rac1 ~]$ xhost +</div><div class="line">access control disabled, clients can connect from any host</div><div class="line">[oracle@rac1 ~]$ <span class="built_in">cd</span> /software/database</div><div class="line">[oracle@rac1 database]$ ./runInstaller</div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/8D27737A5648408D8BC6D65160F19FEE?method=download&amp;shareKey=89e2e512ba5492fba02750710a519142" alt="DB_install"><br><img src="http://note.youdao.com/yws/api/personal/file/E30E8704F02049D2899F64B8C813B084?method=download&amp;shareKey=3c94b82c3ac0e3332af201ba61f1db27" alt="DB_install"><br><img src="http://note.youdao.com/yws/api/personal/file/46E5A434B9FA4589A6D9B479FF4427CC?method=download&amp;shareKey=03ef98de2f76489b85cfbd737ed9d027" alt="DB_install">  </p>
<p>做Oracle用户SSH互信(按照之前grid用户一样做互信)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[oracle@rac1 sshsetup]$ ./sshUserSetup.sh -user oracle -hosts rac2.example.com -advanced -exverify -confirm -noPromptPassphrase</div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/7500B4745E454A33B8DE422A69C41EF2?method=download&amp;shareKey=cfd1df564ca56af384f33e8c2fcf4b0b" alt="DB_install"><br><img src="http://note.youdao.com/yws/api/personal/file/4667BFA405C94DC4B16EF5C0D4202277?method=download&amp;shareKey=c2518992dc8fe5fa6f655fae2090a642" alt="DB_install"><br><img src="http://note.youdao.com/yws/api/personal/file/39ECFC3C78DE48A69D133AA5852FE5DD?method=download&amp;shareKey=1d483c70b0afc1c966366af58281d6a3" alt="DB_install"><br><img src="http://note.youdao.com/yws/api/personal/file/A3BDB3519BD54AB69E30B2EB4CE9E0E4?method=download&amp;shareKey=eb593b50dd934d0059b344a95e00ea23" alt="DB_install"><br><img src="http://note.youdao.com/yws/api/personal/file/EC73246D2BA841B78357FF4028B42C55?method=download&amp;shareKey=633bca30d6a07834cbb5c757c9667e64" alt="DB_install"><br><img src="http://note.youdao.com/yws/api/personal/file/79B11710EA3145DF9EFFE4E9B2F63740?method=download&amp;shareKey=1564620f65cb5932e8f3d9527f85bd6f" alt="DB_install"><br><img src="http://note.youdao.com/yws/api/personal/file/83CB5C68B58A40999AF87472C598B7BB?method=download&amp;shareKey=276a1242d68cb6b789211c0c0d2ed032" alt="DB_install">  </p>
<p>节点rac1和节点rac2都执行下面的脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">[root@rac1 ~]<span class="comment"># /u01/app/oracle/product/11.2.0/db_1/root.sh</span></div><div class="line">Performing root user operation <span class="keyword">for</span> Oracle 11g</div><div class="line"></div><div class="line">The following environment variables are <span class="built_in">set</span> as:</div><div class="line">    ORACLE_OWNER= oracle</div><div class="line">    ORACLE_HOME=  /u01/app/oracle/product/11.2.0/db_1</div><div class="line"></div><div class="line">Enter the full pathname of the <span class="built_in">local</span> bin directory: [/usr/<span class="built_in">local</span>/bin]:</div><div class="line">The contents of <span class="string">"dbhome"</span> have not changed. No need to overwrite.</div><div class="line">The contents of <span class="string">"oraenv"</span> have not changed. No need to overwrite.</div><div class="line">The contents of <span class="string">"coraenv"</span> have not changed. No need to overwrite.</div><div class="line"></div><div class="line">Entries will be added to the /etc/oratab file as needed by</div><div class="line">Database Configuration Assistant when a database is created</div><div class="line">Finished running generic part of root script.</div><div class="line">Now product-specific root actions will be performed.</div><div class="line">Finished product-specific root actions.</div><div class="line">[root@rac1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/9329F7C332564B30A997B062FF205885?method=download&amp;shareKey=3a8b9a6fc87a80c2654ed36d4baff48a" alt="DB_install"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">[root@rac1 ~]<span class="comment"># su - grid</span></div><div class="line"></div><div class="line"><span class="comment">#RAC查看集群资源状态</span></div><div class="line">[grid@rac1 ~]$ crs_stat  -t -v</div><div class="line">Name           Type           R/RA   F/FT   Target    State     Host        </div><div class="line">----------------------------------------------------------------------</div><div class="line">ora.CRS.dg     ora....up.type 0/5    0/     ONLINE    ONLINE    rac1        </div><div class="line">ora.FRA.dg     ora....up.type 0/5    0/     ONLINE    ONLINE    rac1        </div><div class="line">ora....ER.lsnr ora....er.type 0/5    0/     ONLINE    ONLINE    rac1        </div><div class="line">ora....N1.lsnr ora....er.type 0/5    0/0    ONLINE    ONLINE    rac1        </div><div class="line">ora....DATA.dg ora....up.type 0/5    0/     ONLINE    ONLINE    rac1        </div><div class="line">ora.asm        ora.asm.type   0/5    0/     ONLINE    ONLINE    rac1        </div><div class="line">ora.cvu        ora.cvu.type   0/5    0/0    ONLINE    ONLINE    rac1        </div><div class="line">ora.gsd        ora.gsd.type   0/5    0/     OFFLINE   OFFLINE              </div><div class="line">ora....network ora....rk.type 0/5    0/     ONLINE    ONLINE    rac1        </div><div class="line">ora.oc4j       ora.oc4j.type  0/1    0/2    ONLINE    ONLINE    rac1        </div><div class="line">ora.ons        ora.ons.type   0/3    0/     ONLINE    ONLINE    rac1        </div><div class="line">ora....SM1.asm application    0/5    0/0    ONLINE    ONLINE    rac1        </div><div class="line">ora....C1.lsnr application    0/5    0/0    ONLINE    ONLINE    rac1        </div><div class="line">ora.rac1.gsd   application    0/5    0/0    OFFLINE   OFFLINE              </div><div class="line">ora.rac1.ons   application    0/3    0/0    ONLINE    ONLINE    rac1        </div><div class="line">ora.rac1.vip   ora....t1.type 0/0    0/0    ONLINE    ONLINE    rac1        </div><div class="line">ora....SM2.asm application    0/5    0/0    ONLINE    ONLINE    rac2        </div><div class="line">ora....C2.lsnr application    0/5    0/0    ONLINE    ONLINE    rac2        </div><div class="line">ora.rac2.gsd   application    0/5    0/0    OFFLINE   OFFLINE              </div><div class="line">ora.rac2.ons   application    0/3    0/0    ONLINE    ONLINE    rac2        </div><div class="line">ora.rac2.vip   ora....t1.type 0/0    0/0    ONLINE    ONLINE    rac2        </div><div class="line">ora.scan1.vip  ora....ip.type 0/0    0/0    ONLINE    ONLINE    rac1        </div><div class="line">[grid@rac1 ~]$</div></pre></td></tr></table></figure></p>
<h2 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h2><p>创建数据库：(用oracle用户登录)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[oracle@rac1 ~]$ <span class="built_in">export</span> DISPLAY=192.168.100.251:0.0</div><div class="line">[oracle@rac1 ~]$ xhost +</div><div class="line">access control disabled, clients can connect from any host</div><div class="line">[oracle@rac1 ~]$ dbca</div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/B5F8C257719340B8A22A7E6364F27547?method=download&amp;shareKey=63d9c209de07599c1bd10b4007343f63" alt="Create_db"><br><img src="http://note.youdao.com/yws/api/personal/file/EC8B5FB7119944DB985A8417C8AC1E59?method=download&amp;shareKey=724f0eec005c3979adb19d91df077d03" alt="Create_db"><br><img src="http://note.youdao.com/yws/api/personal/file/73DF5250A493444FA211D6020C326624?method=download&amp;shareKey=e247fa3a130468dc2ee84ee4f4a8f88a" alt="Create_db"><br><img src="http://note.youdao.com/yws/api/personal/file/B1BE1C1885CB4A16ADC81F38F20E7242?method=download&amp;shareKey=fc6641f76abc9af875caf458bc1e2746" alt="Create_db"><br><img src="http://note.youdao.com/yws/api/personal/file/7D1B74AFAB0D46F497211545D05ECF3C?method=download&amp;shareKey=fc72815a42af6d027683594ab2fbb73f" alt="Create_db"><br><img src="http://note.youdao.com/yws/api/personal/file/D58AEA48BC9E4D97B04148222E495319?method=download&amp;shareKey=2f06e6917fb8ff2074182837d90e68da" alt="Create_db"><br><img src="http://note.youdao.com/yws/api/personal/file/92CBFDB752DD4A689904D208044DFEFA?method=download&amp;shareKey=ebdd2834a2be2f3a7a0b25e4041212a2" alt="Create_db"><br><img src="http://note.youdao.com/yws/api/personal/file/A67BFEEE880C4702BF2651C55D307E4C?method=download&amp;shareKey=10bd73780edc1b9fcbb6ad8a016c0a1e" alt="Create_db"><br><img src="http://note.youdao.com/yws/api/personal/file/9FABA2D3265448A18CD970588B437B16?method=download&amp;shareKey=0c2f98ed195c5d596d4fe52070ce97e5" alt="Create_db">  </p>
<p>如果SGA and PGA内存不够在安装数据库时会出现下面的错误：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ORA-00838: Specified value of MEMORY_TARGET is too small, needs to be at least 1408M</div><div class="line">ORA-01078：failure <span class="keyword">in</span> processing system parameters</div></pre></td></tr></table></figure></p>
<p>参考：<a href="http://yfshare.blog.51cto.com/8611708/1671927" target="_blank" rel="external">http://yfshare.blog.51cto.com/8611708/1671927</a>  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/531024DC7DF24577AB2C6BB0BCD30BAE?method=download&amp;shareKey=3fbdddc7d6413ce9169adfd0228e6b89" alt="Create_db"><br><img src="http://note.youdao.com/yws/api/personal/file/CEC9BC8BB4F04742A29FEF372612688C?method=download&amp;shareKey=e33dbdb30ea172090cb8f9fc6fcd1f8d" alt="Create_db"><br><img src="http://note.youdao.com/yws/api/personal/file/8A035EEF0C50450FBBF7B9B481B88CBC?method=download&amp;shareKey=3c735d9f58384633630df499b1f2843c" alt="Create_db"><br><img src="http://note.youdao.com/yws/api/personal/file/7FD8667B1D0A4F8A87ADE703925F0A25?method=download&amp;shareKey=85ff3fbdf736b2d2626bbc150f4bdb39" alt="Create_db"><br><img src="http://note.youdao.com/yws/api/personal/file/5DB3EE5CC1CB45299BDA03903CBDB517?method=download&amp;shareKey=4e5c5765cd6599136bf009a05ed5c5d7" alt="Create_db"><br><img src="http://note.youdao.com/yws/api/personal/file/985657944EA94DFFA419BFFCD59A48C1?method=download&amp;shareKey=7974beee807487207bc56da4e21ecd1c" alt="Create_db"><br><img src="http://note.youdao.com/yws/api/personal/file/D23B5E2CC2ED41848A392A7161ADA0CD?method=download&amp;shareKey=c46d6a21c0b78c4262095ae90b08464a" alt="Create_db"><br><img src="http://note.youdao.com/yws/api/personal/file/3758624B77A64DCB950BF4A1C1E3D28E?method=download&amp;shareKey=40fcf6de27d69bb64ce4101f7eb8f07d" alt="Create_db">  </p>
<p>如果安装到85%报上面这个错，查看到闪回区没空间了<br><img src="http://note.youdao.com/yws/api/personal/file/449AB7641BCF4D4FBF9E6D67A7D9F380?method=download&amp;shareKey=70a203188b5aa20546e05cca5fb1d348" alt="recovery_file_dest"><br>解决方法：删除多余的归档文件，或设置较大的db_recovery_file_dest_size  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/F0B6421ECD50485CBDB77BA985609B22?method=download&amp;shareKey=a113a3ab29f750841e6e0c4480b7bb2c" alt="Create_db">  </p>
<p>检查集群运行状态<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">srvctl status database <span class="_">-d</span> racdb</div><div class="line">crs_stat -t -v</div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/87EB8740870045F880745C052AADEC76?method=download&amp;shareKey=6217fb496f2a634eccc760a25e42fdd9" alt="srvctl_status"><br><img src="http://note.youdao.com/yws/api/personal/file/805DC37BDB8D4CDC9D5951AF65B7D384?method=download&amp;shareKey=d11a2ec0e6cccacaea3a25d97a54b9f0" alt="crs_stat"><br><img src="http://note.youdao.com/yws/api/personal/file/6147B920E8B24AC5AE2CC3CF28A31008?method=download&amp;shareKey=80671286ac0a8d3d7a742b47cb00e012" alt="crs_stat">  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">[oracle@rac1 ~]$ lsnrctl status</div><div class="line">LSNRCTL <span class="keyword">for</span> Linux: Version 11.2.0.4.0 - Production on 11-JUL-2015 01:07:17</div><div class="line">Copyright (c) 1991, 2013, Oracle.  All rights reserved.</div><div class="line">Connecting to (ADDRESS=(PROTOCOL=tcp)(HOST=)(PORT=1521))</div><div class="line">STATUS of the LISTENER</div><div class="line">------------------------</div><div class="line">Alias                     LISTENER</div><div class="line">Version                   TNSLSNR <span class="keyword">for</span> Linux: Version 11.2.0.4.0 - Production</div><div class="line">Start Date                10-JUL-2015 15:38:11</div><div class="line">Uptime                    0 days 9 hr. 29 min. 6 sec</div><div class="line">Trace Level               off</div><div class="line">Security                  ON: Local OS Authentication</div><div class="line">SNMP                      OFF</div><div class="line">Listener Parameter File   /u01/app/11.2.0/grid/network/admin/listener.ora</div><div class="line">Listener Log File         /u01/app/grid/diag/tnslsnr/rac1/listener/alert/log.xml</div><div class="line">Listening Endpoints Summary...</div><div class="line">  (DESCRIPTION=(ADDRESS=(PROTOCOL=ipc)(KEY=LISTENER)))</div><div class="line">  (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=192.168.100.244)(PORT=1521)))</div><div class="line">  (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=192.168.100.241)(PORT=1521)))</div><div class="line">Services Summary...</div><div class="line">Service <span class="string">"+ASM"</span> has 1 instance(s).</div><div class="line">  Instance <span class="string">"+ASM1"</span>, status READY, has 1 handler(s) <span class="keyword">for</span> this service...</div><div class="line">Service <span class="string">"racdb"</span> has 1 instance(s).</div><div class="line">  Instance <span class="string">"racdb1"</span>, status READY, has 1 handler(s) <span class="keyword">for</span> this service...</div><div class="line">Service <span class="string">"racdbXDB"</span> has 1 instance(s).</div><div class="line">  Instance <span class="string">"racdb1"</span>, status READY, has 1 handler(s) <span class="keyword">for</span> this service...</div><div class="line">The <span class="built_in">command</span> completed successfully</div><div class="line">[oracle@rac1 ~]$</div><div class="line"></div><div class="line">[oracle@rac1 ~]$ sqlplus / as sysdba</div><div class="line">SQL&gt; select status from v<span class="variable">$instance</span>;</div><div class="line"></div><div class="line">STATUS</div><div class="line">------------</div><div class="line">OPEN</div><div class="line"></div><div class="line">SQL&gt;</div></pre></td></tr></table></figure>
<h2 id="配置EM管理器"><a href="#配置EM管理器" class="headerlink" title="配置EM管理器"></a>配置EM管理器</h2><p>如果启动EM web界面管理工具，出现下面的问题，则使用emca -config dbcontrol db重建EM<br><img src="http://note.youdao.com/yws/api/personal/file/8B81A3F8C4F24FB9AE76BF17483C6F24?method=download&amp;shareKey=6b4edfb25a8cb71d7b6288a8f042509a" alt="em_start"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#删除集群EM</span></div><div class="line">[oracle@rac1 ~]$ emca -deconfig dbcontrol db -cluster</div></pre></td></tr></table></figure></p>
<p><a href="http://note.youdao.com/yws/api/personal/file/E97CE99D29F74E0088BE1DD1BB2D2450?method=download&amp;shareKey=41edb04ba2cb25d35c10dbd851abae7e" target="_blank" rel="external">删除集群EM执行过程</a><br><a href="http://note.youdao.com/yws/api/personal/file/BEB6B2ECD5764208B17893513F26C6F4?method=download&amp;shareKey=de30b1edb7fa40d9a8debc87f710c3c9" target="_blank" rel="external">emctl命令</a>  </p>
<p>重建EM<br>用oracle用户登录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[oracle@rac1 ~]$ <span class="built_in">export</span> DISPLAY=192.168.100.251:0.0</div><div class="line">[oracle@rac1 ~]$ xhost +</div><div class="line">access control disabled, clients can connect from any host</div><div class="line">[oracle@rac1 ~]$ dbca</div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/30AFD56186C94798BB9C494321EB5726?method=download&amp;shareKey=57185649b2653571b6315665457cb16d" alt="em_rebuild"><br><img src="http://note.youdao.com/yws/api/personal/file/51E12844D74A4A30BFA5DADD15726A93?method=download&amp;shareKey=175017e912a9c48781c67aa217eff47d" alt="em_rebuild"><br><img src="http://note.youdao.com/yws/api/personal/file/493A3B0E2F8D4E9C961BDCD561D0505D?method=download&amp;shareKey=a1a86d942a22150f0d9c2de0cd638ccb" alt="em_rebuild1"><br><img src="http://note.youdao.com/yws/api/personal/file/0AD996F1EF3B41E9BAE257B8AFC672E2?method=download&amp;shareKey=2b72b9ca1ee1a07a4f9c01f70ba06fc7" alt="em_rebuild1"><br><img src="http://note.youdao.com/yws/api/personal/file/7741542BB1EA4F4FB275E832A9873C38?method=download&amp;shareKey=92ca47c9566794f50e193f25ce76f837" alt="em_rebuild1"><br><img src="http://note.youdao.com/yws/api/personal/file/257D3B750D7C4F5596F1735FA72EC76E?method=download&amp;shareKey=6674f78d0c6326e122c29bd35b41111a" alt="em_rebuild1"><br><img src="http://note.youdao.com/yws/api/personal/file/ED32CFCE3ABE4CDA9EF15CD56D8BB4F0?method=download&amp;shareKey=b657a58df51961db1a7659dacf2bc2a0" alt="em_rebuild1"><br><img src="http://note.youdao.com/yws/api/personal/file/B8EEDAD45D0E46D5805F15D08184C674?method=download&amp;shareKey=017dd6a0aaae1277a86ccc1cfb5ab336" alt="em_rebuild1"><br><img src="http://note.youdao.com/yws/api/personal/file/85797754B44B4C71978F6EE9C8ADFD8F?method=download&amp;shareKey=29ee7750d8e9c3109152c327ae5efcb6" alt="em_rebuild1"><br><img src="http://note.youdao.com/yws/api/personal/file/9D6F942B32264A1C8402C2755AD5E9BB?method=download&amp;shareKey=739fd735cf7d39d55b3914fdd5183234" alt="em_rebuild1"><br>注：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[oracle@rac1 ~]<span class="variable">$emctl</span> status dbconsole</div><div class="line">Environment variable ORACLE_UNQNAME not defined. Please <span class="built_in">set</span> ORACLE_UNQNAME to database unique name.</div><div class="line">[oracle@rac1 ~]$</div></pre></td></tr></table></figure></p>
<p>如果报上面的错误，是oracle用户的ORACLE_UNQNAME环境变量未设置。如果报下面的错误，则是ORACLE_UNQNAME设置不正确<br><img src="http://note.youdao.com/yws/api/personal/file/A410DFF1803F48B0A87A26CAC027CADA?method=download&amp;shareKey=a7658d2940b902f565cda2f6d2421497" alt="ORACLE_UNQNAME_error"><br>正确设置<br><img src="http://note.youdao.com/yws/api/personal/file/9F50F62A73104E2DA0BDB9531EE8DA48?method=download&amp;shareKey=9e765fb734dd34be7488ef2b86c891f5" alt="ORACLE_UNQNAME_true"><br><img src="http://note.youdao.com/yws/api/personal/file/79479FA7AE684FF9845E3780F7592B2D?method=download&amp;shareKey=c1bca3ac67335417a2964b46797597f8" alt="em_status"><br>oracle RAC集群默认是开机自启。根据配置不同，花费的时间不一样  </p>
<h2 id="配置PL-SQL"><a href="#配置PL-SQL" class="headerlink" title="配置PL/SQL"></a>配置PL/SQL</h2><p>使用PL/SQL登录oracle RAC<br>安装plsql+ora10client<br><a href="http://note.youdao.com/yws/api/personal/file/918F64A65F6B4723AE40E7415A0D0D97?method=download&amp;shareKey=0671839fd7336ba472007fd158a0b91c" target="_blank" rel="external">plsql+instantclient_11_2安装包</a><br>C:\Ora10InstantClient\network\admin\tnsnames.ora（在ora10client安装目录下新建network/admin目录，在RAC服务器上把$ORACLE_HOME/network/admin/tnsnames.ora文件放到ora10client安装目录下的admin目录下）<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@rac1 ~]<span class="comment"># grep racscan /etc/hosts</span></div><div class="line">192.168.100.246	racscan</div><div class="line">[root@rac1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>格式为：把HOST = racscan改为HOST = racscan对应的地址<br><figure class="highlight nix"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#监听文件</span></div><div class="line"><span class="attr">RACDB</span> =</div><div class="line">  (<span class="attr">DESCRIPTION</span> =</div><div class="line">    (<span class="attr">ADDRESS</span> = (<span class="attr">PROTOCOL</span> =TCP)(<span class="attr">HOST</span> = <span class="number">192.168</span>.<span class="number">100.246</span>)(<span class="attr">PORT=</span> <span class="number">1521</span>))</div><div class="line">    (<span class="attr">CONNECT_DATA</span> =</div><div class="line">      (<span class="attr">SERVER</span> = DEDICATED)</div><div class="line">      (<span class="attr">SERVICE_NAME</span> = racdb)</div><div class="line">    )</div><div class="line">  )</div></pre></td></tr></table></figure></p>
<p>打开PL/SQL—&gt;Tools—&gt;Preferences—&gt;Connection<br><img src="http://note.youdao.com/yws/api/personal/file/3C5FEB3B813C4EA1A23B8A2E3E184287?method=download&amp;shareKey=c2f4cd579bde7bb8c3b59610d79b7960" alt="plsql_preferences"><br><img src="http://note.youdao.com/yws/api/personal/file/867F08CA18E941CAA87DEFDB628EF9C8?method=download&amp;shareKey=97463fbbab49dd3a6b770c739d4ef260" alt="plsql_login"><br><img src="http://note.youdao.com/yws/api/personal/file/1D8F9F0F64554F5D94881F4491B030AC?method=download&amp;shareKey=7fa82a30a8bcd139dfa6e28467d7e849" alt="plsql_connected">  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="https://yfshare.github.io">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="https://yfshare.github.io/2017/04/12/部署Oracle-RAC集群/">https://yfshare.github.io/2017/04/12/部署Oracle-RAC集群/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;RAC：real application clusters introduction  &lt;/p&gt;
&lt;p&gt;ORACLE RAC原理：&lt;br&gt;在一个应用环境当中，所有的服务器使用和管理同一个数据库，目的是为了分散每一台服务器的工作量，硬件上至少需要两台以上的服务器，而且还需一个共享存储设备。还需要两类软件，一个是集群软件，另外一个就是Oracle数据库中的RAC组件，所有服务器上的OS都应该是同一类OS。&lt;br&gt;
    
    </summary>
    
      <category term="oracle" scheme="https://yfshare.github.io/categories/oracle/"/>
    
    
      <category term="oracle" scheme="https://yfshare.github.io/tags/oracle/"/>
    
      <category term="RAC" scheme="https://yfshare.github.io/tags/RAC/"/>
    
  </entry>
  
  <entry>
    <title>Ansible常用模块</title>
    <link href="https://yfshare.github.io/2017/04/05/Ansible%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9D%97/"/>
    <id>https://yfshare.github.io/2017/04/05/Ansible常用模块/</id>
    <published>2017-04-05T03:26:10.000Z</published>
    <updated>2017-04-05T03:40:05.000Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>模块(也被称为 “task plugins” 或 “library plugins”)，可以在Ansible-playbooks和Ansible命令中运用它们。</p>
<p>官方文档：<br>Ansible所有模块列表：<a href="https://docs.ansible.com/ansible/list_of_all_modules.html" target="_blank" rel="external">https://docs.ansible.com/ansible/list_of_all_modules.html</a><br><a id="more"></a><br>环境：Centos 6.6<br>　　　ansible 2.2.1.0  </p>
<h2 id="Command模块"><a href="#Command模块" class="headerlink" title="Command模块"></a>Command模块</h2><p>Ansible command模块：<a href="https://docs.ansible.com/ansible/list_of_commands_modules.html" target="_blank" rel="external">https://docs.ansible.com/ansible/list_of_commands_modules.html</a><br>在远程主机上执行命令<br>常用选项：<br><strong>creates</strong>：判断，当该文件存在时，则该命令不执行<br><strong>free_form</strong>：需要执行的Linux指令<br><strong>chdir</strong>：在执行命令之前，先切换到该指定的目录<br><strong>removes</strong>：判断，当该文件不存在时，则该选项不执行<br><strong>executable</strong>：切换shell来执行命令，该执行路径必须是一个绝对路径<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#查看test_hosts组主机的主机名</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible -i /etc/ansible/hosts test_hosts -u root -m command -a 'hostname' -k</span></div><div class="line">SSH password: </div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">host1</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div><div class="line"><span class="comment"># -i：specify inventory host path</span></div><div class="line"><span class="comment"># -u：Remote User</span></div><div class="line"><span class="comment"># -m：Module name</span></div><div class="line"><span class="comment"># -a：Module Args</span></div><div class="line"><span class="comment"># -k：ask for privilege escalation password。在Inventory(/etc/ansible/hosts)中配置ansible_ssh_user和ansible_ssh_pass后可实现Ansible免密连接或者使用证书实现免密连接，即不使用-k参数</span></div><div class="line"><span class="comment"># test_hosts：/etc/ansible/hosts指定的主机组</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#creates判断一个文件，当该文件存在时，则不执行后面的命令</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'creates=/tmp/aaa.txt ls /home'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">lost+found</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'creates=/tmp/ansible_test_cpoy.txt ls /home'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">skipped, since /tmp/ansible_test_cpoy.txt exists</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#removes当文件不存在时，不执行后面的命令</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'removes=/tmp/ansible_test_cpoy.txt ls /home'</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS | rc=0 &gt;</span>&gt;</div><div class="line">lost+found</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'removes=/tmp/bbb.txt.txt ls /home'</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS | rc=0 &gt;</span>&gt;</div><div class="line">skipped, since /tmp/bbb.txt.txt does not exist</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#chdir在执行命令前，先切换到指定的目录</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'chdir=/usr/local/games tar -czf game1.tar.gz game1'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'chdir=/usr/local/games ls -l'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">total 20500</div><div class="line">-rw-r--r-- 1 root root 20971520 Feb  6 15:42 game1</div><div class="line">-rw-r--r-- 1 root root    20458 Feb  6 15:43 game1.tar.gz</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h2 id="Shell模块"><a href="#Shell模块" class="headerlink" title="Shell模块"></a>Shell模块</h2><p>Ansible shell模块：<a href="https://docs.ansible.com/ansible/shell_module.html" target="_blank" rel="external">https://docs.ansible.com/ansible/shell_module.html</a><br>Ansible raw：<a href="https://docs.ansible.com/ansible/raw_module.html" target="_blank" rel="external">https://docs.ansible.com/ansible/raw_module.html</a><br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#shell模块可以使用command模块所有选项，但功能比command模块更强大，因为其支持“|”管道符。</span></div><div class="line"><span class="comment">#使用raw模块也可。执行ansible-doc -s raw查看帮助</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m shell -a 'ps -ef | grep crond | grep -v grep'</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS | rc=0 &gt;</span>&gt;</div><div class="line">root       <span class="number">1013</span>      <span class="number">1</span>  <span class="number">0</span> <span class="number">10</span><span class="symbol">:</span><span class="number">36</span> ?        <span class="number">00</span><span class="symbol">:</span><span class="number">00</span><span class="symbol">:</span><span class="number">00</span> crond</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m raw -a 'ps -ef | grep crond | grep -v grep'</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS | rc=0 &gt;</span>&gt;</div><div class="line">root       <span class="number">1013</span>      <span class="number">1</span>  <span class="number">0</span> <span class="number">10</span><span class="symbol">:</span><span class="number">36</span> ?        <span class="number">00</span><span class="symbol">:</span><span class="number">00</span><span class="symbol">:</span><span class="number">00</span> crond</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m shell -a "aaa.sh &gt;&gt; /tmp/output.txt"</span></div></pre></td></tr></table></figure></p>
<h2 id="File模块"><a href="#File模块" class="headerlink" title="File模块"></a>File模块</h2><p>Ansible File模块：<a href="https://docs.ansible.com/ansible/list_of_files_modules.html" target="_blank" rel="external">https://docs.ansible.com/ansible/list_of_files_modules.html</a><br>file - Sets attributes of file：<a href="https://docs.ansible.com/ansible/file_module.html" target="_blank" rel="external">https://docs.ansible.com/ansible/file_module.html</a></p>
<p>常用选项：<br><strong>force</strong>：在两种情况下强制创建软链接。1、源文件不存在但之后会建立的情况；2、目标软件已存在，需要先取消之前的软链接，然后创建新的软链接。选项：yes|no<br><strong>group</strong>：定义文件/目录的属组<br><strong>mode</strong>：定义文件/目录的权限<br><strong>path</strong>：必选项，定义文件/目录的路径<br><strong>recurse</strong>：递归的设置文件的属性，只对目录有效<br><strong>src</strong>：要被链接到的路径，只应用于state=link的情况<br><strong>dest</strong>：被链接到的路径，只应用于state=link的情况<br><strong>state</strong>：  </p>
<ul>
<li>directory：如果目录不存在，创建目录</li>
<li>file：即使文件不存在，也不会被创建</li>
<li>link：创建软链接；hard：创建硬链接</li>
<li>touch：如果文件不存在，则会创建一个新的文件，如果已存在，则更新其最后修改时间</li>
<li>absent：删除目录/文件或者取消链接文件  <figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Ansible创建文件：</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m file -a 'path=/tmp/test.txt state=touch'</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS =&gt;</span> &#123;</div><div class="line">    <span class="string">"changed"</span>: true, </div><div class="line">    <span class="string">"dest"</span>: <span class="string">"/tmp/test.txt"</span>, </div><div class="line">    <span class="string">"gid"</span>: <span class="number">0</span>, </div><div class="line">    <span class="string">"group"</span>: <span class="string">"root"</span>, </div><div class="line">    <span class="string">"mode"</span>: <span class="string">"0644"</span>, </div><div class="line">    <span class="string">"owner"</span>: <span class="string">"root"</span>, </div><div class="line">    <span class="string">"size"</span>: <span class="number">0</span>, </div><div class="line">    <span class="string">"state"</span>: <span class="string">"file"</span>, </div><div class="line">    <span class="string">"uid"</span>: <span class="number">0</span></div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m command -a 'ls -l /tmp/test.txt'</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS | rc=0 &gt;</span>&gt;</div><div class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">0</span> Feb  <span class="number">6</span> <span class="number">10</span><span class="symbol">:</span><span class="number">38</span> /tmp/test.txt</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div><div class="line"><span class="comment">#Ansible删除文件，文件状态改成absent；使用command模块执行rm命令也可</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m file -a 'path=/tmp/test.txt state=absent'</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS =&gt;</span> &#123;</div><div class="line">    <span class="string">"changed"</span>: true, </div><div class="line">    <span class="string">"path"</span>: <span class="string">"/tmp/test.txt"</span>, </div><div class="line">    <span class="string">"state"</span>: <span class="string">"absent"</span></div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Ansible创建目录：</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m file -a 'path=/tmp/test_dir state=directory owner=root group=mail mode=777'</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS =&gt;</span> &#123;</div><div class="line">    <span class="string">"changed"</span>: true, </div><div class="line">    <span class="string">"gid"</span>: <span class="number">12</span>, </div><div class="line">    <span class="string">"group"</span>: <span class="string">"mail"</span>, </div><div class="line">    <span class="string">"mode"</span>: <span class="string">"0777"</span>, </div><div class="line">    <span class="string">"owner"</span>: <span class="string">"root"</span>, </div><div class="line">    <span class="string">"path"</span>: <span class="string">"/tmp/test_dir"</span>, </div><div class="line">    <span class="string">"size"</span>: <span class="number">4096</span>, </div><div class="line">    <span class="string">"state"</span>: <span class="string">"directory"</span>, </div><div class="line">    <span class="string">"uid"</span>: <span class="number">0</span></div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m command -a 'ls -ld /tmp/test_dir'</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS | rc=0 &gt;</span>&gt;</div><div class="line">drwxrwxrwx <span class="number">2</span> root mail <span class="number">4096</span> Feb  <span class="number">6</span> <span class="number">10</span><span class="symbol">:</span><span class="number">47</span> /tmp/test_dir</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h2 id="Copy模块："><a href="#Copy模块：" class="headerlink" title="Copy模块："></a>Copy模块：</h2><p>Ansible copy模块：<a href="https://docs.ansible.com/ansible/copy_module.html" target="_blank" rel="external">https://docs.ansible.com/ansible/copy_module.html</a><br>复制文件到远程主机<br>常用选项<br><strong>backup</strong>：在覆盖之前将源文件备份，备份文件包含时间信息，选项：yes|no<br><strong>content</strong>：用于替代”src”，可以直接设定文件的值<br><strong>directory_node</strong>：递归的设定目录权限，默认为系统默认权限<br><strong>force</strong>：如果目标主机包含该文件，但内容不同，如果设置为yes，则强制覆盖；如果设置为no，则只有当目标主机的目标位置不存在该文件时，才复制。默认为yes<br><strong>others</strong>：所有file模块里的选项都可以在这里使用<br><strong>src</strong>：要复制到远程主机的文件在本地的地址，可以是绝对路径，也可以是相对路径。如果路径是一个目录，它将递归复制。在这种情况下，如果路径使用“/”来结尾，则只复制目录里的内容，如果没有使用“/”来结尾，则包含目录在内的整个内容全部复制，类似于rsync<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m copy -a 'src=/root/test_file.txt dest=/tmp/ansible_test_cpoy.txt owner=root group=mail mode=0600'</span></div><div class="line">192.168.31.110 | SUCCESS =&gt; &#123;</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </div><div class="line">    <span class="string">"checksum"</span>: <span class="string">"e6c4fbd4fe7607f3e6ebf68b2ea4ef694da7b4fe"</span>, </div><div class="line">    <span class="string">"dest"</span>: <span class="string">"/tmp/ansible_test_cpoy.txt"</span>, </div><div class="line">    <span class="string">"gid"</span>: 12, </div><div class="line">    <span class="string">"group"</span>: <span class="string">"mail"</span>, </div><div class="line">    <span class="string">"md5sum"</span>: <span class="string">"2d282102fa671256327d4767ec23bc6b"</span>, </div><div class="line">    <span class="string">"mode"</span>: <span class="string">"0600"</span>, </div><div class="line">    <span class="string">"owner"</span>: <span class="string">"root"</span>, </div><div class="line">    <span class="string">"size"</span>: 21, </div><div class="line">    <span class="string">"src"</span>: <span class="string">"/root/.ansible/tmp/ansible-tmp-1486364820.02-66604881581156/source"</span>, </div><div class="line">    <span class="string">"state"</span>: <span class="string">"file"</span>, </div><div class="line">    <span class="string">"uid"</span>: 0</div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m command -a 'ls -l /tmp/ansible_test_cpoy.txt'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">-rw------- 1 root mail 21 Feb  6 15:07 /tmp/ansible_test_cpoy.txt</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<h2 id="Service模块"><a href="#Service模块" class="headerlink" title="Service模块"></a>Service模块</h2><p>Ansible service模块：<a href="https://docs.ansible.com/ansible/service_module.html" target="_blank" rel="external">https://docs.ansible.com/ansible/service_module.html</a><br>用于管理服务<br>常用选项：<br><strong>arguments</strong>：为命令提供一些附加参数<br><strong>enabled</strong>：是否开机启动，选项 yes|no<br><strong>name</strong>：必选项，服务名称<br><strong>pattern</strong>：定义一个模式，如果通过status指令来查看服务状态时，没有响应，它会通过ps命令在进程中根据该模式进行查找，如果匹配到，则认为该服务依然运行<br><strong>runlevel</strong>：运行级别<br><strong>sleep</strong>：如果执行了restarted，则在stop和start之间等待几秒钟<br><strong>state</strong>：对当前服务执行启动/停止/重启/重新加载等操作(started/stopped/restarted/reloaded)<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m service -a 'name=nginx state=started enabled=yes'</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS =&gt;</span> &#123;</div><div class="line">    <span class="string">"changed"</span>: true, </div><div class="line">    <span class="string">"enabled"</span>: true, </div><div class="line">    <span class="string">"name"</span>: <span class="string">"nginx"</span>, </div><div class="line">    <span class="string">"state"</span>: <span class="string">"started"</span></div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m shell -a 'ps -ef | grep nginx | grep -v grep'</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS | rc=0 &gt;</span>&gt;</div><div class="line">root       <span class="number">2638</span>      <span class="number">1</span>  <span class="number">0</span> <span class="number">17</span><span class="symbol">:</span><span class="number">40</span> ?        <span class="number">00</span><span class="symbol">:</span><span class="number">00</span><span class="symbol">:</span><span class="number">00</span> <span class="symbol">nginx:</span> master process /usr/sbin/nginx -c /etc/nginx/nginx.conf</div><div class="line">nginx      <span class="number">2640</span>   <span class="number">2638</span>  <span class="number">0</span> <span class="number">17</span><span class="symbol">:</span><span class="number">40</span> ?        <span class="number">00</span><span class="symbol">:</span><span class="number">00</span><span class="symbol">:</span><span class="number">00</span> <span class="symbol">nginx:</span> worker process                   </div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m shell -a 'chkconfig --list | egrep -w nginx'</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS | rc=0 &gt;</span>&gt;</div><div class="line">nginx          	<span class="number">0</span><span class="symbol">:off</span>	<span class="number">1</span><span class="symbol">:off</span>	<span class="number">2</span><span class="symbol">:on</span>	<span class="number">3</span><span class="symbol">:on</span>	<span class="number">4</span><span class="symbol">:on</span>	<span class="number">5</span><span class="symbol">:on</span>	<span class="number">6</span><span class="symbol">:off</span></div><div class="line">nginx-debug    	<span class="number">0</span><span class="symbol">:off</span>	<span class="number">1</span><span class="symbol">:off</span>	<span class="number">2</span><span class="symbol">:off</span>	<span class="number">3</span><span class="symbol">:off</span>	<span class="number">4</span><span class="symbol">:off</span>	<span class="number">5</span><span class="symbol">:off</span>	<span class="number">6</span><span class="symbol">:off</span></div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#Ansible会匹配nginx服务，如果存在/usr/sbin/nginx这个进程时，认为其已经启动，则不执行后面的started操作</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m service -a 'name=nginx pattern=/usr/sbin/nginx state=started'</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS =&gt;</span> &#123;</div><div class="line">    <span class="string">"changed"</span>: false, </div><div class="line">    <span class="string">"name"</span>: <span class="string">"nginx"</span>, </div><div class="line">    <span class="string">"state"</span>: <span class="string">"started"</span></div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m service -a 'name=network state=restarted args=eth0'</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS =&gt;</span> &#123;</div><div class="line">    <span class="string">"changed"</span>: true, </div><div class="line">    <span class="string">"name"</span>: <span class="string">"network"</span>, </div><div class="line">    <span class="string">"state"</span>: <span class="string">"started"</span></div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<h2 id="Cron模块"><a href="#Cron模块" class="headerlink" title="Cron模块"></a>Cron模块</h2><p>Ansible cron模块：<a href="https://docs.ansible.com/ansible/cron_module.html" target="_blank" rel="external">https://docs.ansible.com/ansible/cron_module.html</a><br>用于管理计划任务<br>常用参数：<br><strong>backup</strong>：对远程主机上的原计划任务内容修改之前做备份<br><strong>cron_file</strong>：如果指定该选项，则用该文件替换远程主机上cron.d目录下的用户的任务计划<br><strong>day</strong>：日(1-31,*,*/2,…)<br><strong>hour</strong>：小时(0-23,*,*/2,…)<br><strong>minute</strong>:分钟(0-59,*,*/2,…)<br><strong>month</strong>：月(0-12,*,…)<br><strong>weekday</strong>：周(0-7,*,…)<br><strong>job</strong>：要执行的任务，依赖于state=present<br><strong>name</strong>：该任务的描述<br><strong>special_time</strong>：指定什么时候执行，参数：reboot,yearly,annually,monthly,weekly,daily,hourly<br><strong>state</strong>：确认该任务计划是创建还是删除<br><strong>user</strong>：以哪个用户身份执行<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m cron -a 'name="reboot system" minute=0 hour=5 user=root job="/sbin/reboot" state=present'</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS =&gt;</span> &#123;</div><div class="line">    <span class="string">"changed"</span>: true, </div><div class="line">    <span class="string">"envs"</span>: [], </div><div class="line">    <span class="string">"jobs"</span>: [</div><div class="line">        <span class="string">"reboot system"</span></div><div class="line">    ]</div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m shell -a "crontab -l"</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS | rc=0 &gt;</span>&gt;</div><div class="line"><span class="comment">#Ansible: reboot system</span></div><div class="line"><span class="number">0</span> <span class="number">5</span> * * * <span class="regexp">/sbin/reboot</span></div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m cron -a 'name="reboot system" state=absent'</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS =&gt;</span> &#123;</div><div class="line">    <span class="string">"changed"</span>: true, </div><div class="line">    <span class="string">"envs"</span>: [], </div><div class="line">    <span class="string">"jobs"</span>: []</div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#每隔5分钟查看home目录,state=present可省略</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m cron -a 'name="check home directory" minute=*/5 job="ls -lht /home"'</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS =&gt;</span> &#123;</div><div class="line">    <span class="string">"changed"</span>: true, </div><div class="line">    <span class="string">"envs"</span>: [], </div><div class="line">    <span class="string">"jobs"</span>: [</div><div class="line">        <span class="string">"check home directory"</span></div><div class="line">    ]</div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m shell -a "crontab -l"</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS | rc=0 &gt;</span>&gt;</div><div class="line"><span class="comment">#Ansible: check home directory</span></div><div class="line">*<span class="regexp">/5 * * * * ls -lht /home</span></div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m cron -a 'name="echo reboot" special_time=reboot job="echo reboot_successful" state=present'</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS =&gt;</span> &#123;</div><div class="line">    <span class="string">"changed"</span>: true, </div><div class="line">    <span class="string">"envs"</span>: [], </div><div class="line">    <span class="string">"jobs"</span>: [</div><div class="line">        <span class="string">"echo reboot"</span></div><div class="line">    ]</div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m shell -a "crontab -l"</span></div><div class="line"><span class="meta">192.168.31.110 | SUCCESS | rc=0 &gt;</span>&gt;</div><div class="line"><span class="comment">#Ansible: echo reboot</span></div><div class="line">@reboot echo reboot_successful</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<h2 id="FileSystem"><a href="#FileSystem" class="headerlink" title="FileSystem"></a>FileSystem</h2><p>Ansible FileSystem模块：<a href="https://docs.ansible.com/ansible/filesystem_module.html" target="_blank" rel="external">https://docs.ansible.com/ansible/filesystem_module.html</a><br>块设备上创建文件系统<br>选项：<br><strong>dev</strong>：目标块设备<br><strong>force</strong>：在一个已有文件系统的设备上强制创建<br><strong>fstype</strong>：文件系统的类型<br><strong>opts</strong>：传递给mkfs命令的选项<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Filesystem模块只能对整个块设备操作，不能分区</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m filesystem -a 'dev=/dev/sdb fstype=ext4'</span></div><div class="line">192.168.31.110 | SUCCESS =&gt; &#123;</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">true</span></div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'fdisk -l /dev/sdb'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line"></div><div class="line">Disk /dev/sdb: 107.4 GB, 107374182400 bytes</div><div class="line">255 heads, 63 sectors/track, 13054 cylinders</div><div class="line">Units = cylinders of 16065 * 512 = 8225280 bytes</div><div class="line">Sector size (logical/physical): 512 bytes / 512 bytes</div><div class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</div><div class="line">Disk identifier: 0x00000000</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#如果需要像平时样对块设备进行分区操作，则需要编写脚本让Ansible执行。这里用到了copy和command模块</span></div><div class="line">[root@Ansible ~]<span class="comment"># cat fdisk.sh </span></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="comment">#make partition</span></div><div class="line">fdisk /dev/sdb &lt;&lt;EOF</div><div class="line">n</div><div class="line">p</div><div class="line">1</div><div class="line"></div><div class="line">+10G</div><div class="line">p</div><div class="line">w</div><div class="line">EOF</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m copy -a 'src=/root/fdisk.sh dest=/tmp/'</span></div><div class="line">192.168.31.110 | SUCCESS =&gt; &#123;</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </div><div class="line">    <span class="string">"checksum"</span>: <span class="string">"f265923f0a4578e36c82418df1a068a55867c1b1"</span>, </div><div class="line">    <span class="string">"dest"</span>: <span class="string">"/tmp/fdisk.sh"</span>, </div><div class="line">    <span class="string">"gid"</span>: 0, </div><div class="line">    <span class="string">"group"</span>: <span class="string">"root"</span>, </div><div class="line">    <span class="string">"md5sum"</span>: <span class="string">"87c9e0b074e4828b37d6e334d1cf7ce1"</span>, </div><div class="line">    <span class="string">"mode"</span>: <span class="string">"0644"</span>, </div><div class="line">    <span class="string">"owner"</span>: <span class="string">"root"</span>, </div><div class="line">    <span class="string">"size"</span>: 71, </div><div class="line">    <span class="string">"src"</span>: <span class="string">"/root/.ansible/tmp/ansible-tmp-1486437971.22-237961786906240/source"</span>, </div><div class="line">    <span class="string">"state"</span>: <span class="string">"file"</span>, </div><div class="line">    <span class="string">"uid"</span>: 0</div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m command -a 'sh /tmp/fdisk.sh'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">...</div><div class="line">Disk /dev/sdb: 107.4 GB, 107374182400 bytes</div><div class="line">255 heads, 63 sectors/track, 13054 cylinders</div><div class="line">Units = cylinders of 16065 * 512 = 8225280 bytes</div><div class="line">Sector size (logical/physical): 512 bytes / 512 bytes</div><div class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</div><div class="line">Disk identifier: 0x166637ee</div><div class="line"></div><div class="line">   Device Boot      Start         End      Blocks   Id  System</div><div class="line">/dev/sdb1               1        1306    10490413+  83  Linux</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'mkfs.ext4 /dev/sdb1'</span></div><div class="line"><span class="comment">#格式化分区</span></div></pre></td></tr></table></figure>
<h2 id="Mount模块"><a href="#Mount模块" class="headerlink" title="Mount模块"></a>Mount模块</h2><p>Ansible mount模块：<a href="https://docs.ansible.com/ansible/mount_module.html" target="_blank" rel="external">https://docs.ansible.com/ansible/mount_module.html</a><br><strong>dump</strong>：存储(见fstab文件第5列)。注意，如果设置为null并且状态设置为present，它将停止工作，并且将在后续运行中进行重复条目。对Solaris系统没有影响。<br><strong>fstype</strong>：必选项，文件系统类型，要求状态是present或mounted<br><strong>name</strong>：必选项，挂载点<br><strong>opts</strong>：传递给mount命令的参数<br><strong>src</strong>：必选项，要挂载的设备路径。要求状态是present或mounted<br><strong>state</strong>：必选项。选项为present/absent/mounted/unmounted  </p>
<ul>
<li>present：只处理fstab中的配置</li>
<li>absent：删除挂载点  </li>
<li>mounted：自动创建挂载点并挂载  </li>
<li>unmounted：卸载  <figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#挂载分区</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m mount -a 'name=/mnt src=/dev/sdb1 fstype=ext4 state=mounted opts=rw'</span></div><div class="line"><span class="number">192.168</span><span class="number">.31</span><span class="number">.110</span> | SUCCESS =&gt; &#123;</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </div><div class="line">    <span class="string">"dump"</span>: <span class="string">"0"</span>, </div><div class="line">    <span class="string">"fstab"</span>: <span class="string">"/etc/fstab"</span>, </div><div class="line">    <span class="string">"fstype"</span>: <span class="string">"ext4"</span>, </div><div class="line">    <span class="string">"name"</span>: <span class="string">"/mnt"</span>, </div><div class="line">    <span class="string">"opts"</span>: <span class="string">"rw"</span>, </div><div class="line">    <span class="string">"passno"</span>: <span class="string">"0"</span>, </div><div class="line">    <span class="string">"src"</span>: <span class="string">"/dev/sdb1"</span></div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'df -h /dev/sdb1'</span></div><div class="line"><span class="number">192.168</span><span class="number">.31</span><span class="number">.110</span> | SUCCESS | rc=<span class="number">0</span> &gt;&gt;</div><div class="line">Filesystem      Size  Used Avail Use% Mounted <span class="literal">on</span></div><div class="line">/dev/sdb1       <span class="number">9.8</span>G   <span class="number">23</span>M  <span class="number">9.3</span>G   <span class="number">1</span>% /mnt</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'tail -1 /etc/fstab'</span></div><div class="line"><span class="number">192.168</span><span class="number">.31</span><span class="number">.110</span> | SUCCESS | rc=<span class="number">0</span> &gt;&gt;</div><div class="line">/dev/sdb1 /mnt ext4 rw <span class="number">0</span> <span class="number">0</span></div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#state=mounted，如果挂载点不存在会自动创建</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'dd if=/dev/zero of=/mnt/disk.img bs=1M count=100'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">100+0 records <span class="keyword">in</span></div><div class="line">100+0 records out</div><div class="line">104857600 bytes (105 MB) copied, 0.241784 s, 434 MB/s</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'losetup /dev/loop0 /mnt/disk.img'  #关联设备</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m filesystem -a 'dev=/mnt/disk.img fstype=ext4 opts=-F'  #格式化块设备</span></div><div class="line">192.168.31.110 | SUCCESS =&gt; &#123;</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">true</span></div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m mount -a 'src=/dev/loop0 name=/yfshare fstype=ext4 state=mounted'</span></div><div class="line">192.168.31.110 | SUCCESS =&gt; &#123;</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </div><div class="line">    <span class="string">"dump"</span>: <span class="string">"0"</span>, </div><div class="line">    <span class="string">"fstab"</span>: <span class="string">"/etc/fstab"</span>, </div><div class="line">    <span class="string">"fstype"</span>: <span class="string">"ext4"</span>, </div><div class="line">    <span class="string">"name"</span>: <span class="string">"/yfshare"</span>, </div><div class="line">    <span class="string">"opts"</span>: <span class="string">"defaults"</span>, </div><div class="line">    <span class="string">"passno"</span>: <span class="string">"0"</span>, </div><div class="line">    <span class="string">"src"</span>: <span class="string">"/dev/loop0"</span></div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m shell -a 'df -h | grep -w loop0'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">/dev/loop0             93M  1.6M   87M   2% /yfshare</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m shell -a 'grep -w loop0 /etc/fstab'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">/dev/loop0 /yfshare ext4 defaults 0 0</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m file -a 'path=/yfshare/test.txt state=touch mode=0600'</span></div></pre></td></tr></table></figure>
<h2 id="Yum模块"><a href="#Yum模块" class="headerlink" title="Yum模块"></a>Yum模块</h2><p>Ansible Packaging Modules：<a href="https://docs.ansible.com/ansible/list_of_packaging_modules.html" target="_blank" rel="external">https://docs.ansible.com/ansible/list_of_packaging_modules.html</a><br>Ansible yum模块：<a href="https://docs.ansible.com/ansible/yum_module.html" target="_blank" rel="external">https://docs.ansible.com/ansible/yum_module.html</a><br>使用yum包管理器来管理软件包<br>选项：<br><strong>conf_file</strong>：yum的配置文件<br><strong>disable_gpg_check</strong>：关闭gpg_check<br><strong>disablerepo</strong>：不启用某个源<br><strong>enablerepo</strong>：启用某个源<br><strong>list</strong>：查看yum列表<br><strong>name</strong>：要进行操作的软件包名字，也可以传递一个url或者一个本地的rpm包的路径<br><strong>state</strong>：状态(present/installed/absent/removed/latest)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#卸载nginx软件包</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m yum -a 'name=nginx state=absent'</span></div><div class="line">192.168.31.110 | SUCCESS =&gt; &#123;</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </div><div class="line">    <span class="string">"msg"</span>: <span class="string">""</span>, </div><div class="line">    <span class="string">"rc"</span>: 0, </div><div class="line">    <span class="string">"results"</span>: [</div><div class="line">    <span class="string">"Loaded plugins: fastestmirror\nSetting up Remove Process\nResolving Dependencies\n--&gt; Running transaction check\n---&gt; Package nginx.x86_64 0:1.10.3-1.el6.ngx will be erased\n--&gt; Finished Dependency Resolution\n\nDependencies Resolved\n\n</span></div><div class="line">    ...</div><div class="line">        ]</div><div class="line">&#125;</div><div class="line">[root@Ansible ~]#</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#更新nginx软件包</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m yum -a 'name=nginx update_cache=yes'</span></div><div class="line">192.168.31.110 | SUCCESS =&gt; &#123;</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>, </div><div class="line">    <span class="string">"msg"</span>: <span class="string">""</span>, </div><div class="line">    <span class="string">"rc"</span>: 0, </div><div class="line">    <span class="string">"results"</span>: [</div><div class="line">        <span class="string">"nginx-1.10.3-1.el6.ngx.x86_64 providing nginx is already installed"</span></div><div class="line">    ]</div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h2 id="User模块"><a href="#User模块" class="headerlink" title="User模块"></a>User模块</h2><p>Ansible User模块：<a href="https://docs.ansible.com/ansible/user_module.html" target="_blank" rel="external">https://docs.ansible.com/ansible/user_module.html</a><br>常用参数：<br><strong>home</strong>：指定用户家目录<br><strong>group</strong>：设置用户主组<br><strong>groups</strong>：设置用户的附属组<br><strong>uid</strong>：设置用户的UID<br><strong>password</strong>：设置用户的密码，密码必须为加密后的值<br><strong>name</strong>：创建用户的用户名<br><strong>createhhome</strong>：选项yes|no，值为yes时才创建用户家目录<br><strong>system</strong>：选项yes|no，默认为no，值为yes时创建的用户为系统用户<br><strong>remove</strong>：当state=absent时，remove=yes则表示连同家目录一起删除，等价于userdel -r<br><strong>state</strong>：选项present|absent，创建用户或删除用户<br><strong>shell</strong>：设置用户的shell环境<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#生成用户的密码</span></div><div class="line">[root@Ansible ~]<span class="comment"># echo "123456" | openssl passwd -1 -salt $(&lt; /dev/urandom tr -dc '[:alnum:]' | head -c 32) -stdin</span></div><div class="line"><span class="variable">$1</span><span class="variable">$K28XAyId</span><span class="variable">$YUKHvYzbbO9C8RkzGIzNo1</span></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#group为指定用户的主组</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m user -a 'name=user1 uid=1001 group=yfshare createhome=yes home=/home/user1 password="$1$K28XAyId$YUKHvYzbbO9C8RkzGIzNo1" shell=/bin/bash state=present'</span></div><div class="line">192.168.31.110 | SUCCESS =&gt; &#123;</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </div><div class="line">    <span class="string">"comment"</span>: <span class="string">""</span>, </div><div class="line">    <span class="string">"createhome"</span>: <span class="literal">true</span>, </div><div class="line">    <span class="string">"group"</span>: 1000, </div><div class="line">    <span class="string">"home"</span>: <span class="string">"/home/user1"</span>, </div><div class="line">    <span class="string">"name"</span>: <span class="string">"user1"</span>, </div><div class="line">    <span class="string">"password"</span>: <span class="string">"NOT_LOGGING_PASSWORD"</span>, </div><div class="line">    <span class="string">"shell"</span>: <span class="string">"/bin/bash"</span>, </div><div class="line">    <span class="string">"state"</span>: <span class="string">"present"</span>, </div><div class="line">    <span class="string">"system"</span>: <span class="literal">false</span>, </div><div class="line">    <span class="string">"uid"</span>: 1001</div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'id user1'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">uid=1001(user1) gid=1000(yfshare) groups=1000(yfshare)</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#groups为指定用户的附属组</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m user -a 'name=user2 uid=1002 groups=yfshare createhome=yes home=/home/user2 password="$1$K28XAyId$YUKHvYzbbO9C8RkzGIzNo1" shell=/bin/bash state=present'</span></div><div class="line">192.168.31.110 | SUCCESS =&gt; &#123;</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </div><div class="line">    <span class="string">"comment"</span>: <span class="string">""</span>, </div><div class="line">    <span class="string">"createhome"</span>: <span class="literal">true</span>, </div><div class="line">    <span class="string">"group"</span>: 1002, </div><div class="line">    <span class="string">"groups"</span>: <span class="string">"yfshare"</span>, </div><div class="line">    <span class="string">"home"</span>: <span class="string">"/home/user2"</span>, </div><div class="line">    <span class="string">"name"</span>: <span class="string">"user2"</span>, </div><div class="line">    <span class="string">"password"</span>: <span class="string">"NOT_LOGGING_PASSWORD"</span>, </div><div class="line">    <span class="string">"shell"</span>: <span class="string">"/bin/bash"</span>, </div><div class="line">    <span class="string">"state"</span>: <span class="string">"present"</span>, </div><div class="line">    <span class="string">"system"</span>: <span class="literal">false</span>, </div><div class="line">    <span class="string">"uid"</span>: 1002</div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'id user2'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">uid=1002(user2) gid=1002(user2) groups=1002(user2),1000(yfshare)</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#删除user1用户</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m user -a 'name=user1 remove=yes state=absent'</span></div><div class="line">192.168.31.110 | SUCCESS =&gt; &#123;</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </div><div class="line">    <span class="string">"force"</span>: <span class="literal">false</span>, </div><div class="line">    <span class="string">"name"</span>: <span class="string">"user1"</span>, </div><div class="line">    <span class="string">"remove"</span>: <span class="literal">true</span>, </div><div class="line">    <span class="string">"state"</span>: <span class="string">"absent"</span></div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'id user1'</span></div><div class="line">192.168.31.110 | FAILED | rc=1 &gt;&gt;</div><div class="line">id: user1: No such user</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h2 id="Group模块"><a href="#Group模块" class="headerlink" title="Group模块"></a>Group模块</h2><p>Ansible group模块：<a href="https://docs.ansible.com/ansible/group_module.html" target="_blank" rel="external">https://docs.ansible.com/ansible/group_module.html</a><br>选项：<br><strong>gid</strong>：设置组的GID<br><strong>name</strong>：组名<br><strong>state</strong>：选项为present|absent，创建组或删除组<br><strong>system</strong>：选项为yes|no，值为yes，则创建系统组<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#创建yfshare组</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m group -a 'name=yfshare gid=1000 state=present'</span></div><div class="line">192.168.31.110 | SUCCESS =&gt; &#123;</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </div><div class="line">    <span class="string">"gid"</span>: 1000, </div><div class="line">    <span class="string">"name"</span>: <span class="string">"yfshare"</span>, </div><div class="line">    <span class="string">"state"</span>: <span class="string">"present"</span>, </div><div class="line">    <span class="string">"system"</span>: <span class="literal">false</span></div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'grep yfshare /etc/group'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">yfshare:x:1000:</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#删除yfshare组</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m group -a 'name=yfshare gid=1000 state=absent'</span></div><div class="line">192.168.31.110 | SUCCESS =&gt; &#123;</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </div><div class="line">    <span class="string">"name"</span>: <span class="string">"yfshare"</span>, </div><div class="line">    <span class="string">"state"</span>: <span class="string">"absent"</span></div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'grep yfshare /etc/group'</span></div><div class="line">192.168.31.110 | FAILED | rc=1 &gt;&gt;</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h2 id="Synchronize模块"><a href="#Synchronize模块" class="headerlink" title="Synchronize模块"></a>Synchronize模块</h2><p>Ansible synchronize模块：<a href="https://docs.ansible.com/ansible/synchronize_module.html" target="_blank" rel="external">https://docs.ansible.com/ansible/synchronize_module.html</a><br><strong>archive</strong>：归档，相当于同时开启recursive(递归)、links、perms、times、owner、group、-D选项都为yes ，默认该项为开启<br><strong>checksum</strong>：跳过检测sum值，默认关闭<br><strong>delete</strong>：删除不存在的文件(源主机没有但目标主机中存在的文件)，默认no<br><strong>dest</strong>：从源同步到目的主机的路径，可以为绝对路径或相对路径<br><strong>src</strong>：在源主机上将要同步到目的主机的路径，可为绝对路径或相对路径<br><strong>dest_port</strong>：目标主机上的SSH端口号，在Ansible 2.0之前，ansible_ssh_port变量值优先于此变量<br><strong>existing_only</strong>：在目的主机上不创建新文件<br><strong>links</strong>：将符号链接复制为符号链接<br><strong>copy_links</strong>：复制链接文件，默认为no<br><strong>owner</strong>：保留所有者（仅超级用户）<br><strong>mode</strong>：选项push和pull。push模式，从本机向远程主机传送文件；pull模式从远程主机上取文件<br><strong>recursive</strong>：递归到目录<br><strong>rsync_path</strong>：指定在远程主机上运行rsync命令<br><strong>times</strong>：保留修改时间<br><strong>compress</strong>：在传输过程中是否压缩文件，选项yes|no<br><strong>dirs</strong>：传速目录不进行递归，默认为no，即进行目录递归<br><strong>rsync_opts</strong>：指定rsync参数选项<br><strong>set_remote_user</strong>：主要用于/etc/ansible/hosts中定义或默认使用的用户与rsync使用的用户不同的情况<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="string">"msg"</span>: <span class="string">"Failed to find required executable ssh"</span>  <span class="comment">#出现这个报错，需要安装openssh-clients</span></div><div class="line"><span class="string">"msg"</span>: <span class="string">"Failed to find required executable rsync"</span>  <span class="comment">#出现这个问题，需要安装rsync</span></div><div class="line"></div><div class="line"><span class="comment">#synchronize同步文件</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m synchronize -a 'src=/tmp/helloworld.txt dest=/tmp/'</span></div><div class="line">root@192.168.31.110<span class="string">'s password: </span></div><div class="line">192.168.31.110 | SUCCESS =&gt; &#123;</div><div class="line">    "changed": true, </div><div class="line">    "cmd": "/usr/bin/rsync --delay-updates -F --compress --archive --rsh 'ssh  -S none -o StrictHostKeyChecking=no<span class="string">' --out-format='</span>&lt;&lt;CHANGED&gt;&gt;%i %n%L<span class="string">' \"/tmp/helloworld.txt\" \"root@192.168.31.110:/tmp/\"", </span></div><div class="line">    "msg": "&lt;f+++++++++ helloworld.txt\n", </div><div class="line">    "rc": 0, </div><div class="line">    "stdout_lines": [</div><div class="line">        "&lt;f+++++++++ helloworld.txt"</div><div class="line">    ]</div><div class="line">&#125;</div><div class="line">[root@Ansible ~]# ansible test_hosts -a 'cat /tmp/helloworld.txt<span class="string">'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">hello world</div><div class="line"></div><div class="line">[root@Ansible ~]#</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#synchronize同步目录。如果synchronize同步到目的服务器的目录不存在，则会创建该目录后同步到该目录，rsync_path可以指定rsync的路径(如果是源码安装的)</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m synchronize -a 'src=/tmp/test dest=/tmp/synchronize_test delete=yes mode=push owner=yes rsync_path=/usr/bin/rsync rsync_opts="-avz,--exclude=.git"'</span></div><div class="line">root@192.168.31.110<span class="string">'s password: </span></div><div class="line">192.168.31.110 | SUCCESS =&gt; &#123;</div><div class="line">    "changed": true, </div><div class="line">    "cmd": "/usr/bin/rsync --delay-updates -F --compress --delete-after --archive --rsh 'ssh  -S none -o StrictHostKeyChecking=no<span class="string">' --out-format='</span>&lt;&lt;CHANGED&gt;&gt;%i %n%L<span class="string">' \"/tmp/test\" \"root@192.168.31.110:/tmp/synchronize_test\"", </span></div><div class="line">    "msg": "cd+++++++++ test/\n</div><div class="line">    ···</div><div class="line">        ]</div><div class="line">&#125;</div><div class="line">[root@Ansible ~]#</div><div class="line">[root@Ansible ~]# ansible test_hosts -a 'ls /tmp/synchronize_test<span class="string">'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">test</div><div class="line"></div><div class="line">[root@Ansible ~]#</div></pre></td></tr></table></figure>
<h2 id="get-url模块"><a href="#get-url模块" class="headerlink" title="get_url模块"></a>get_url模块</h2><p>主要用于从http、ftp、https服务器上下载文件（类似于wget）<br>Ansible get_url模块：<a href="https://docs.ansible.com/ansible/get_url_module.html" target="_blank" rel="external">https://docs.ansible.com/ansible/get_url_module.html</a><br>选项：<br><strong>checksum</strong>：文件下载完成后进行校验<br><strong>timeout</strong>：请求超时时间，默认为10s<br><strong>url</strong>：文件下载地址<br><strong>url_username</strong>：用户名，基于HTTP的基本认证<br><strong>url_password</strong>：密码<br><strong>use_proxy</strong>：选项yes|no，默认为yes，即使用代理<br><strong>dest</strong>：下载文件存储的绝对路径<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#下载文件并下载完成后进行sha256sum校验</span></div><div class="line"><span class="comment">#支持加密算法：sha1, sha224, sha384, sha256, sha512, md5</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m get_url -a 'dest=/tmp/ url="http://archive.kernel.org/centos-vault/6.7/isos/x86_64/0_README.txt" checksum="sha256:f98849cdc1b3dee8cf47cfcf2a2fe2fb8e8e69426157a47d20a3005693fd3e1c"'</span></div><div class="line">192.168.31.110 | SUCCESS =&gt; &#123;</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </div><div class="line">    <span class="string">"checksum_dest"</span>: null, </div><div class="line">    <span class="string">"checksum_src"</span>: <span class="string">"a1b756c6a431552e5012a9332c68dc1ef3ec463c"</span>, </div><div class="line">    <span class="string">"dest"</span>: <span class="string">"/tmp/0_README.txt"</span>, </div><div class="line">    <span class="string">"gid"</span>: 0, </div><div class="line">    <span class="string">"group"</span>: <span class="string">"root"</span>, </div><div class="line">    <span class="string">"md5sum"</span>: <span class="string">"99bc97977d71be899bef0c5664fae3fb"</span>, </div><div class="line">    <span class="string">"mode"</span>: <span class="string">"0644"</span>, </div><div class="line">    <span class="string">"msg"</span>: <span class="string">"OK (2210 bytes)"</span>, </div><div class="line">    <span class="string">"owner"</span>: <span class="string">"root"</span>, </div><div class="line">    <span class="string">"size"</span>: 2210, </div><div class="line">    <span class="string">"src"</span>: <span class="string">"/tmp/tmp8GUXc4"</span>, </div><div class="line">    <span class="string">"state"</span>: <span class="string">"file"</span>, </div><div class="line">    <span class="string">"uid"</span>: 0, </div><div class="line">    <span class="string">"url"</span>: <span class="string">"http://archive.kernel.org/centos-vault/6.7/isos/x86_64/0_README.txt"</span></div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'ls /tmp/0_README.txt -l'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">-rw-r--r-- 1 root root 2210 Feb  8 19:33 /tmp/0_README.txt</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<h2 id="unarchive模块"><a href="#unarchive模块" class="headerlink" title="unarchive模块"></a>unarchive模块</h2><p>Ansible unarchive模块：<a href="https://docs.ansible.com/ansible/unarchive_module.html" target="_blank" rel="external">https://docs.ansible.com/ansible/unarchive_module.html</a><br>用于解压文件<br>选项：<br><strong>remote_src</strong>：选项yes|no，默认为no，值为yes表示文件已复制到远程主机，added in Ansible 2.2<br><strong>creates</strong>：如果文件存在，则不执行解压命令<br><strong>dest</strong>：在远程主机上解压的绝对路径<br><strong>group</strong>：设置解压后文件/目录的属组<br><strong>owner</strong>：设置解压后文件/目录的属主<br><strong>list_files</strong>：选项yes|no，默认为no，值为yes，解压后列出压缩包的文件，added in Ansible 2.0<br><strong>mode</strong>：解压后文件的权限<br><strong>src</strong>：值为yes，如果remote_src=no (default)，本地压缩文件复制到目的服务器，绝对路径相对路径均可；如果remote_src=yes，直接在目标服务器上解压文件；如果remote_src=yes和src包含URL，则先下载文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m unarchive -a 'creates=NewSid.zip src=/tmp/NewSid.zip dest=/tmp/ mode=0600 owner=yfshare list_files=yes'</span></div><div class="line">192.168.31.110 | SUCCESS =&gt; &#123;</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </div><div class="line">    <span class="string">"dest"</span>: <span class="string">"/tmp/"</span>, </div><div class="line">    <span class="string">"extract_results"</span>: &#123;</div><div class="line">        <span class="string">"cmd"</span>: [</div><div class="line">            <span class="string">"/usr/bin/unzip"</span>, </div><div class="line">            <span class="string">"-o"</span>, </div><div class="line">            <span class="string">"/root/.ansible/tmp/ansible-tmp-1486610818.84-40104290759151/source"</span>, </div><div class="line">            <span class="string">"-d"</span>, </div><div class="line">            <span class="string">"/tmp/"</span></div><div class="line">        ], </div><div class="line">        <span class="string">"err"</span>: <span class="string">""</span>, </div><div class="line">        <span class="string">"out"</span>: <span class="string">"Archive:  /root/.ansible/tmp/ansible-tmp-1486610818.84-40104290759151/source\n  inflating: /tmp/newsid.exe         \n  inflating: /tmp/Eula.txt           \n"</span>, </div><div class="line">        <span class="string">"rc"</span>: 0</div><div class="line">    &#125;, </div><div class="line">    <span class="string">"files"</span>: [   <span class="comment">#列出解压文件列表</span></div><div class="line">        <span class="string">"newsid.exe"</span>, </div><div class="line">        <span class="string">"Eula.txt"</span></div><div class="line">    ], </div><div class="line">    <span class="string">"gid"</span>: 0, </div><div class="line">    <span class="string">"group"</span>: <span class="string">"root"</span>, </div><div class="line">    <span class="string">"handler"</span>: <span class="string">"ZipArchive"</span>, </div><div class="line">    <span class="string">"mode"</span>: <span class="string">"01777"</span>, </div><div class="line">    <span class="string">"owner"</span>: <span class="string">"root"</span>, </div><div class="line">    <span class="string">"size"</span>: 4096, </div><div class="line">    <span class="string">"src"</span>: <span class="string">"/root/.ansible/tmp/ansible-tmp-1486610818.84-40104290759151/source"</span>, </div><div class="line">    <span class="string">"state"</span>: <span class="string">"directory"</span>, </div><div class="line">    <span class="string">"uid"</span>: 0</div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a 'ls -l /tmp'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">total 240</div><div class="line">drwx------ 2 root    root   4096 Feb  9 11:28 ansible_zimVwy</div><div class="line">-rw------- 1 yfshare root   7005 Jul 28  2006 Eula.txt</div><div class="line">-rw------- 1 yfshare root 228152 Nov  1  2006 newsid.exe</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<h2 id="Setup模块"><a href="#Setup模块" class="headerlink" title="Setup模块"></a>Setup模块</h2><p>Ansible Setup模块：<a href="https://docs.ansible.com/ansible/setup_module.html" target="_blank" rel="external">https://docs.ansible.com/ansible/setup_module.html</a><br>playbooks自动收集远程主机上可用变量，这些变量用于playbooks<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m setup</span></div><div class="line">192.168.31.110 | SUCCESS =&gt; &#123;</div><div class="line">    <span class="string">"ansible_facts"</span>: &#123;</div><div class="line">        <span class="string">"ansible_all_ipv4_addresses"</span>: [</div><div class="line">            <span class="string">"192.168.31.110"</span></div><div class="line">        ], </div><div class="line">        <span class="string">"ansible_all_ipv6_addresses"</span>: [</div><div class="line">            <span class="string">"fe80::20c:29ff:fe5c:dc6d"</span></div><div class="line">        ], </div><div class="line">        <span class="string">"ansible_architecture"</span>: <span class="string">"x86_64"</span>,</div><div class="line">...</div></pre></td></tr></table></figure></p>
<h2 id="Template模块"><a href="#Template模块" class="headerlink" title="Template模块"></a>Template模块</h2><p>Ansible Template模块：<a href="https://docs.ansible.com/ansible/template_module.html" target="_blank" rel="external">https://docs.ansible.com/ansible/template_module.html</a><br>模版由<a href="http://jinja.pocoo.org/docs" target="_blank" rel="external">jinja2模版语言</a>处理，模版设计文档参考<a href="http://jinja.pocoo.org/docs/templates/" target="_blank" rel="external">这里</a><br>模版中可以使用六个附加变量：  </p>
<ul>
<li>ansible_managed(通过ansible.cfg的defaults部分配置)包含一个字符串，可用户描述模版名称，主机，模版文件修改时间和所有者uid</li>
<li>template_host包含模版机器的节点名称</li>
<li>template_uid所有者的用户ID</li>
<li>template_path模版路径</li>
<li>template_fullpath模版的绝对路径</li>
<li>telmpate_run_date模版显示日期</li>
</ul>
<p>常用选项：<br><strong>backup</strong>：选项yes|no，默认为no，创建一个包含时间戳的备份文件<br><strong>src</strong>：本地文件的路径<br><strong>dest</strong>：远程主机的文件位置<br><strong>force</strong>：选项yes|no，默认为yes，覆盖远程主机上的同名文件，如果为否，只有当远程主机上不存在此文件时，才传输文件<br><strong>owner</strong>：文件/目录的所有者，chown<br><strong>group</strong>：文件/目录的所属组，chown<br><strong>mode</strong>：文件/目录的权限，chmod<br><strong>validate</strong>：在复制之前需要验证命令，要验证的文件的路径通过“%s”传递<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">- template:</div><div class="line">    src: etc/ssh/sshd_config.j2</div><div class="line">    dest: /etc/ssh/sshd_config</div><div class="line">    owner: root</div><div class="line">    group: root</div><div class="line">    mode: <span class="string">'0600'</span></div><div class="line">    validate: /usr/sbin/sshd -t <span class="_">-f</span> %s</div><div class="line">    backup: yes</div></pre></td></tr></table></figure></p>
<h2 id="script模块"><a href="#script模块" class="headerlink" title="script模块"></a>script模块</h2><p>Ansible script模块：<a href="http://docs.ansible.com/ansible/script_module.html" target="_blank" rel="external">http://docs.ansible.com/ansible/script_module.html</a><br>在远程主机上执行脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@Ansible ~]<span class="comment"># chmod +x /tmp/script.sh </span></div><div class="line">[root@Ansible ~]<span class="comment"># cat /tmp/script.sh </span></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="built_in">echo</span> <span class="string">'This is a test script'</span> &gt; /tmp/script.ansible</div><div class="line">useradd Jack_wang</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m script -a '/tmp/script.sh'</span></div><div class="line">Enter passphrase <span class="keyword">for</span> key <span class="string">'/root/.ssh/id_rsa'</span>: </div><div class="line">192.168.31.110 | SUCCESS =&gt; &#123;</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </div><div class="line">    <span class="string">"rc"</span>: 0, </div><div class="line">    <span class="string">"stderr"</span>: <span class="string">"Shared connection to 192.168.31.110 closed.\r\n"</span>, </div><div class="line">    <span class="string">"stdout"</span>: <span class="string">""</span>, </div><div class="line">    <span class="string">"stdout_lines"</span>: []</div><div class="line">&#125;</div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a "id Jack_wang"</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">uid=502(Jack_wang) gid=502(Jack_wang) groups=502(Jack_wang)</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a "cat /tmp/script.ansible"</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">This is a <span class="built_in">test</span> script</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>参考文档：<a href="http://breezey.blog.51cto.com/2400275/1555530/" target="_blank" rel="external">http://breezey.blog.51cto.com/2400275/1555530/</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="https://yfshare.github.io">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="https://yfshare.github.io/2017/04/05/Ansible常用模块/">https://yfshare.github.io/2017/04/05/Ansible常用模块/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;模块(也被称为 “task plugins” 或 “library plugins”)，可以在Ansible-playbooks和Ansible命令中运用它们。&lt;/p&gt;
&lt;p&gt;官方文档：&lt;br&gt;Ansible所有模块列表：&lt;a href=&quot;https://docs.ansible.com/ansible/list_of_all_modules.html&quot;&gt;https://docs.ansible.com/ansible/list_of_all_modules.html&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
      <category term="Ansible" scheme="https://yfshare.github.io/categories/Ansible/"/>
    
    
      <category term="ansible" scheme="https://yfshare.github.io/tags/ansible/"/>
    
      <category term="Modules" scheme="https://yfshare.github.io/tags/Modules/"/>
    
  </entry>
  
  <entry>
    <title>Ansible-Playbooks之安装Zabbix</title>
    <link href="https://yfshare.github.io/2017/03/20/Ansible-Playbooks%E4%B9%8B%E5%AE%89%E8%A3%85Zabbix/"/>
    <id>https://yfshare.github.io/2017/03/20/Ansible-Playbooks之安装Zabbix/</id>
    <published>2017-03-20T10:50:41.000Z</published>
    <updated>2017-03-21T11:50:15.000Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>playbooks 是一种简单的配置管理系统与多机器部署系统的基础。与现有的其他系统有不同之处,且非常适合于复杂应用的批量部署<br>Playbooks 的格式是YAML，语法做到最小化  </p>
<p>这里讲述的是使用ansible-playbooks的roles安装Zabbix应用<br><a id="more"></a></p>
<h2 id="Ansible之源码安装Zabbix-sever"><a href="#Ansible之源码安装Zabbix-sever" class="headerlink" title="Ansible之源码安装Zabbix-sever"></a>Ansible之源码安装Zabbix-sever</h2><ul>
<li>Zabbix_Server结构目录</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#结构目录</span></div><div class="line">[root@Ansible ~]<span class="comment"># tree /etc/ansible/</span></div><div class="line">/etc/ansible/</div><div class="line">├── ansible.cfg</div><div class="line">├── hosts</div><div class="line">├── roles</div><div class="line">│   └── source_zabbix_server</div><div class="line">│       ├── files</div><div class="line">│       │   ├── authorization.sql</div><div class="line">│       │   ├── initialize.sql</div><div class="line">│       │   ├── yum.repo</div><div class="line">│       │   └── zabbix-3.2.4.tar.gz</div><div class="line">│       ├── handlers</div><div class="line">│       │   └── main.yml</div><div class="line">│       ├── tasks</div><div class="line">│       │   └── main.yml</div><div class="line">│       ├── templates</div><div class="line">│       │   ├── fastcgi.conf.j2</div><div class="line">│       │   ├── zabbix_agentd.conf</div><div class="line">│       │   ├── zabbix.conf</div><div class="line">│       │   └── zabbix_server.conf</div><div class="line">│       └── vars</div><div class="line">│           └── main.yml</div><div class="line">└── site.yml</div><div class="line"></div><div class="line">7 directories, 14 files</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>环境：<br>　　　ansible 2.2.1.0<br>　　　Centos 6.6<br>　　　zabbix-3.2.4  </p>
<p>参考：<br><a href="http://www.yfshare.vip/2017/03/20/Ansible-Playbooks之安装LNMP/" target="_blank" rel="external">Ansible-Playbooks之安装LNMP</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#入口文件</span></div><div class="line">[root@Ansible ~]<span class="comment"># cd /etc/ansible/</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat site.yml </span></div><div class="line">- hosts: test_hosts</div><div class="line">  user: root</div><div class="line">  roles:</div><div class="line">    - yum_mysql</div><div class="line">    - yum_php</div><div class="line">    - source_nginx</div><div class="line">    - source_zabbix_server</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#tasks</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat roles/source_zabbix_server/tasks/main.yml</span></div><div class="line">- name: disabled iptables</div><div class="line">  service: name=iptables state=stopped</div><div class="line">- name: Set the selinux value to Permissive</div><div class="line">  shell: setenforce 0</div><div class="line"></div><div class="line">- name: Install libselinux-python package</div><div class="line">  yum: name=libselinux-python state=installed</div><div class="line"></div><div class="line">- name: Check whether yum.repo file exist</div><div class="line">  shell: ls /etc/yum.repos.d/yum.repo</div><div class="line">  register: result</div><div class="line">  ignore_errors: True</div><div class="line">- name: Copy yum.repo file</div><div class="line">  copy: src=<span class="string">"files/yum.repo"</span> dest=<span class="string">"/etc/yum.repos.d/yum.repo"</span> mode=0644 owner=root group=root</div><div class="line">  when: result|failed</div><div class="line">- name: Rebuild the yum cache</div><div class="line">  shell: yum clean all &amp;&amp; yum makecache</div><div class="line">  when: result|failed</div><div class="line"></div><div class="line">- name: Install same devel packages</div><div class="line">  yum: name=<span class="string">"&#123;&#123;item.name&#125;&#125;"</span></div><div class="line">  with_items:</div><div class="line">    - name: <span class="string">"net-snmp"</span></div><div class="line">    - name: <span class="string">"net-snmp-devel"</span></div><div class="line">    - name: <span class="string">"libxml2-devel"</span></div><div class="line">    - name: <span class="string">"libcurl-devel"</span></div><div class="line">    - name: <span class="string">"java-devel"</span></div><div class="line">    - name: <span class="string">"unixODBC"</span></div><div class="line">    - name: <span class="string">"unixODBC-devel"</span></div><div class="line">    - name: <span class="string">"OpenIPMI-devel"</span></div><div class="line">    - name: <span class="string">"curl-devel"</span></div><div class="line">    - name: <span class="string">"libssh2-devel"</span></div><div class="line">    - name: <span class="string">"MySQL-python"</span></div><div class="line"></div><div class="line">- name: Check whether jdk-7u79-linux-x64.tar.gz file exist</div><div class="line">  shell: ls /tmp/jdk-7u79-linux-x64.tar.gz</div><div class="line">  register: result</div><div class="line">  ignore_errors: True</div><div class="line">- name: download jdk-7u79 <span class="built_in">source</span> package</div><div class="line">  get_url: url=<span class="string">"http://note.youdao.com/yws/api/personal/file/B6CC3F0E2AED4E51B16CE7FAF865A81B?method=download&amp;shareKey=8bce5fcc4e54f5295476a3be85eb16d5"</span> dest=<span class="string">"/tmp"</span></div><div class="line">  when: result|failed</div><div class="line"></div><div class="line">- name: Check whether <span class="string">'/usr/local/jdk1.7.0_79'</span> file exist</div><div class="line">  shell: ls /usr/<span class="built_in">local</span>/jdk1.7.0_79</div><div class="line">  register: result</div><div class="line">  ignore_errors: True</div><div class="line">- name: unarchive jdk-7u79 <span class="built_in">source</span> package</div><div class="line">  unarchive: src=<span class="string">"/tmp/jdk-7u79-linux-x64.tar.gz"</span> dest=<span class="string">"/usr/local/"</span> remote_src=yes</div><div class="line">  when: result|failed</div><div class="line">- name: Configure java variable</div><div class="line">  shell: <span class="built_in">echo</span> <span class="string">'export JAVA_HOME=/usr/local/jdk1.7.0_79'</span> &gt;&gt; /etc/profile &amp;&amp; <span class="built_in">echo</span> <span class="string">'export PATH=$&#123;JAVA_HOME&#125;/bin/:$PATH'</span> &gt;&gt; /etc/profile &amp;&amp; <span class="built_in">source</span> /etc/profile</div><div class="line">  when: result|failed</div><div class="line"></div><div class="line">- name: unarchive zabbix-3.2.4 <span class="built_in">source</span> package</div><div class="line">  unarchive: src=<span class="string">"files/zabbix-3.2.4.tar.gz"</span> dest=<span class="string">"/tmp"</span> remote_src=no</div><div class="line">- name: Install zabbix <span class="built_in">source</span> package</div><div class="line">  shell: <span class="built_in">cd</span> /tmp/zabbix-3.2.4 &amp;&amp; ./configure --prefix=&#123;&#123;zabbix_install_path&#125;&#125; --enable-server --enable-agent --with-mysql --with-net-snmp --with-libcurl --with-libxml2  --enable-java &amp;&amp; make &amp;&amp; make install</div><div class="line"></div><div class="line">- name: Check whether zabbix users exist</div><div class="line">  shell: id zabbix</div><div class="line">  register: result</div><div class="line">  ignore_errors: True</div><div class="line">- name: The zabbix user does not exist, so we need to create it.</div><div class="line">  user: name=zabbix createhome=yes home=/home/zabbix shell=/sbin/nologin  state=present</div><div class="line">  when: result|failed</div><div class="line"></div><div class="line">- name: Replace some files</div><div class="line">  lineinfile: dest=<span class="string">"&#123;&#123;item.dest&#125;&#125;"</span> regexp=<span class="string">"&#123;&#123;item.reg&#125;&#125;"</span> line=<span class="string">"&#123;&#123;item.line&#125;&#125;"</span> backrefs=yes</div><div class="line">  with_items:</div><div class="line">    - dest: <span class="string">'/etc/php.ini'</span></div><div class="line">      reg: <span class="string">'^max_execution_time'</span></div><div class="line">      line: <span class="string">'max_execution_time = 300'</span></div><div class="line">    - dest: <span class="string">'/etc/php.ini'</span></div><div class="line">      reg: <span class="string">'^post_max_size'</span></div><div class="line">      line: <span class="string">'post_max_size = 16M'</span></div><div class="line">    - dest: <span class="string">'/etc/php.ini'</span></div><div class="line">      reg: <span class="string">'^max_input_time'</span></div><div class="line">      line: <span class="string">'max_input_time = 300'</span></div><div class="line">    - dest: <span class="string">'/etc/php.ini'</span></div><div class="line">      reg: <span class="string">'^;date.timezone'</span></div><div class="line">      line: <span class="string">'date.timezone = "Asia/Shanghai"'</span></div><div class="line">    - dest: <span class="string">'/etc/php-fpm.conf'</span></div><div class="line">      reg: <span class="string">'^;pid ='</span></div><div class="line">      line: <span class="string">'pid = /var/run/php-fpm/php-fpm.pid'</span></div><div class="line">    - dest: <span class="string">'/etc/php-fpm.d/www.conf'</span></div><div class="line">      reg: <span class="string">'^;pm.min_spare_servers'</span></div><div class="line">      line: <span class="string">'pm.min_spare_servers = 5'</span></div><div class="line">    - dest: <span class="string">'/etc/php-fpm.d/www.conf'</span></div><div class="line">      reg: <span class="string">'^;pm.max_spare_servers'</span></div><div class="line">      line: <span class="string">'pm.max_spare_servers = 35'</span></div><div class="line">    - dest: <span class="string">'/etc/php-fpm.d/www.conf'</span></div><div class="line">      reg: <span class="string">'^;^pm.start_servers'</span></div><div class="line">      line: <span class="string">'pm.start_servers = 5'</span></div><div class="line"></div><div class="line">- name: Copy authorization.sql file</div><div class="line">  template: src=<span class="string">"&#123;&#123;item.name&#125;&#125;"</span> dest=<span class="string">"/tmp/"</span></div><div class="line">  with_items:</div><div class="line">    - name: <span class="string">"files/authorization.sql"</span></div><div class="line">    - name: <span class="string">"files/initialize.sql"</span></div><div class="line"></div><div class="line">- name: Set up mysql database authorization</div><div class="line">  shell: mysql -u&#123;&#123;mysql_user&#125;&#125; -p&#123;&#123;mysql_pass&#125;&#125; -P&#123;&#123;mysql_port&#125;&#125; &lt; <span class="string">"/tmp/authorization.sql"</span></div><div class="line">- name: Authorize Zabbix users</div><div class="line">  shell: mysql -u&#123;&#123;mysql_user&#125;&#125; -p&#123;&#123;mysql_pass&#125;&#125; -P&#123;&#123;mysql_port&#125;&#125; &lt; <span class="string">"/tmp/initialize.sql"</span></div><div class="line">- name: Initialize the zabbix database</div><div class="line">  shell: <span class="built_in">cd</span> /tmp/zabbix-3.2.4 &amp;&amp; mysql -u&#123;&#123;mysql_zbx_user&#125;&#125; -p&#123;&#123;mysql_zbx_pass&#125;&#125; -P&#123;&#123;mysql_port&#125;&#125; &#123;&#123;mysql_zbx_db&#125;&#125; &lt; database/mysql/schema.sql &amp;&amp; mysql -u&#123;&#123;mysql_zbx_user&#125;&#125; -p&#123;&#123;mysql_zbx_pass&#125;&#125; -P&#123;&#123;mysql_port&#125;&#125; &#123;&#123;mysql_zbx_db&#125;&#125; &lt; database/mysql/images.sql &amp;&amp; mysql -u&#123;&#123;mysql_zbx_user&#125;&#125; -p&#123;&#123;mysql_zbx_pass&#125;&#125; -P&#123;&#123;mysql_port&#125;&#125; &#123;&#123;mysql_zbx_db&#125;&#125; &lt; database/mysql/data.sql</div><div class="line"></div><div class="line">- name: Configure zabbix</div><div class="line">  shell: <span class="built_in">cd</span> /tmp/zabbix-3.2.4 &amp;&amp; cp misc/init.d/fedora/core/zabbix_* /etc/init.d/ &amp;&amp; chmod 775 /etc/init.d/zabbix_*</div><div class="line">- name: Copy zabbix configure</div><div class="line">  template: src=<span class="string">"&#123;&#123;item.src&#125;&#125;"</span> dest=<span class="string">"&#123;&#123;item.dest&#125;&#125;"</span></div><div class="line">  with_items:</div><div class="line">    - src: <span class="string">"templates/zabbix_server.conf"</span></div><div class="line">      dest: <span class="string">"&#123;&#123;zabbix_install_path&#125;&#125;/etc/zabbix_server.conf"</span></div><div class="line">    - src: <span class="string">"templates/zabbix_agentd.conf"</span></div><div class="line">      dest: <span class="string">"&#123;&#123;zabbix_install_path&#125;&#125;/etc/zabbix_agentd.conf"</span></div><div class="line"></div><div class="line">- name: Create some directory</div><div class="line">  file: path=<span class="string">"&#123;&#123;item.path&#125;&#125;"</span> state=directory mode=0755</div><div class="line">  with_items:</div><div class="line">    - path: <span class="string">"&#123;&#123;nginx_install_path&#125;&#125;/html/zabbix"</span></div><div class="line">    - path: <span class="string">"&#123;&#123;zabbix_log_path&#125;&#125;"</span></div><div class="line">    - path: <span class="string">"&#123;&#123;nginx_log_path&#125;&#125;/zabbix"</span></div><div class="line"></div><div class="line">- name: Copy zabbix pages</div><div class="line">  shell: cp -rpf /tmp/zabbix-3.2.4/frontends/php/* &#123;&#123;nginx_install_path&#125;&#125;/html/zabbix/ &amp;&amp; chown zabbix:zabbix &#123;&#123;nginx_install_path&#125;&#125;/html/zabbix/</div><div class="line">- name: Modify file permissions</div><div class="line">  file: path=<span class="string">"&#123;&#123;nginx_install_path&#125;&#125;/html/zabbix/conf"</span> state=directory owner=zabbix group=zabbix mode=0777</div><div class="line">- name: Command Links</div><div class="line">  file: src=<span class="string">"&#123;&#123;item.src&#125;&#125;"</span> dest=<span class="string">"&#123;&#123;item.dest&#125;&#125;"</span> state=link remote_src=True</div><div class="line">  with_items:</div><div class="line">    - src: <span class="string">"&#123;&#123;zabbix_install_path&#125;&#125;/sbin/zabbix_server"</span></div><div class="line">      dest: <span class="string">"/usr/local/sbin/zabbix_server"</span></div><div class="line">    - src: <span class="string">"&#123;&#123;zabbix_install_path&#125;&#125;/sbin/zabbix_agentd"</span></div><div class="line">      dest: <span class="string">"/usr/local/sbin/zabbix_agentd"</span></div><div class="line">- name: touch zabbix <span class="built_in">log</span> file</div><div class="line">  file: path=&#123;&#123;item.path&#125;&#125; state=touch owner=zabbix group=zabbix mode=0755</div><div class="line">  with_items:</div><div class="line">    - path: <span class="string">"&#123;&#123;zabbix_log_path&#125;&#125;/zabbix_server.log"</span></div><div class="line">    - path: <span class="string">"&#123;&#123;zabbix_log_path&#125;&#125;/zabbix_agentd.log"</span></div><div class="line"></div><div class="line">- name: Configure nginx <span class="keyword">for</span> Zabbix</div><div class="line">  template: src=<span class="string">"templates/zabbix.conf"</span> dest=<span class="string">"&#123;&#123;nginx_install_path&#125;&#125;/conf/vhosts/zabbix.conf"</span> mode=0644 owner=nginx group=nginx</div><div class="line">- name: Check whether fastcgi.conf file exist</div><div class="line">  shell: ls &#123;&#123;nginx_install_path&#125;&#125;/conf/vhosts/fastcgi.conf</div><div class="line">  register: result</div><div class="line">  ignore_errors: True</div><div class="line">- name: Copy fastcgi.conf file</div><div class="line">  copy: src=<span class="string">"templates/fastcgi.conf.j2"</span> dest=<span class="string">"&#123;&#123;nginx_install_path&#125;&#125;/conf/vhosts/fastcgi.conf"</span> mode=0644 owner=nginx group=nginx mode=0644</div><div class="line">  when: result|failed</div><div class="line">- name: Add zabbix to chkconfig</div><div class="line">  shell: chkconfig --add zabbix_server &amp;&amp; chkconfig --add zabbix_agentd</div><div class="line">  notify: restart zabbix server</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#handlers</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat roles/source_zabbix_server/handlers/main.yml</span></div><div class="line">- name: restart zabbix server</div><div class="line">  service: name=&#123;&#123;item.name&#125;&#125; state=restarted enabled=yes</div><div class="line">  with_items:</div><div class="line">    - name: <span class="string">"zabbix_server"</span></div><div class="line">    - name: <span class="string">"zabbix_agentd"</span></div><div class="line">    - name: <span class="string">"php-fpm"</span></div><div class="line">    - name: <span class="string">"nginx"</span></div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#变量</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat roles/source_zabbix_server/vars/main.yml</span></div><div class="line">mysql_user: root</div><div class="line">mysql_host: 192.168.31.110</div><div class="line">mysql_pass: 123456</div><div class="line">mysql_zbx_db: zabbix</div><div class="line">mysql_zbx_user: zabbix</div><div class="line">mysql_zbx_pass: zabbix</div><div class="line">mysql_zbx_hosts: 192.168.31.%</div><div class="line">mysql_port: 3306</div><div class="line"></div><div class="line">zabbix_install_path: /usr/<span class="built_in">local</span>/zabbix</div><div class="line">zabbix_log_path: /var/<span class="built_in">log</span>/zabbix</div><div class="line">zabbix_server_ip: 192.168.31.110</div><div class="line"></div><div class="line">nginx_install_path: /usr/<span class="built_in">local</span>/nginx-1.11.7</div><div class="line">nginx_log_path: /var/<span class="built_in">log</span>/nginx</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#执行过程</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible-playbook /etc/ansible/site.yml </span></div><div class="line"></div><div class="line">PLAY [test_hosts] **************************************************************</div><div class="line"></div><div class="line">TASK [setup] *******************************************************************</div><div class="line">ok: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : disabled iptables] ********************************</div><div class="line">ok: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Set the selinux value to Permissive] **************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Install libselinux-python package] ****************</div><div class="line">ok: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Check whether yum.repo file exist] ****************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Copy yum.repo file] *******************************</div><div class="line">skipping: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Rebuild the yum cache] ****************************</div><div class="line">skipping: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Install same devel packages] **********************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'net-snmp'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'net-snmp-devel'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'libxml2-devel'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'libcurl-devel'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'java-devel'</span>&#125;)</div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'unixODBC'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'unixODBC-devel'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'OpenIPMI-devel'</span>&#125;)</div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'curl-devel'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'libssh2-devel'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'MySQL-python'</span>&#125;)</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Check whether jdk-7u79-linux-x64.tar.gz file exist] ***</div><div class="line">fatal: [192.168.31.110]: FAILED! =&gt; &#123;<span class="string">"changed"</span>: <span class="literal">true</span>, <span class="string">"cmd"</span>: <span class="string">"ls /tmp/jdk-7u79-linux-x64.tar.gz"</span>, <span class="string">"delta"</span>: <span class="string">"0:00:00.006056"</span>, <span class="string">"end"</span>: <span class="string">"2017-03-21 10:42:08.254025"</span>, <span class="string">"failed"</span>: <span class="literal">true</span>, <span class="string">"rc"</span>: 2, <span class="string">"start"</span>: <span class="string">"2017-03-21 10:42:08.247969"</span>, <span class="string">"stderr"</span>: <span class="string">"ls: cannot access /tmp/jdk-7u79-linux-x64.tar.gz: No such file or directory"</span>, <span class="string">"stdout"</span>: <span class="string">""</span>, <span class="string">"stdout_lines"</span>: [], <span class="string">"warnings"</span>: []&#125;</div><div class="line">...ignoring</div><div class="line"></div><div class="line">TASK [source_zabbix_server : download jdk-7u79 <span class="built_in">source</span> package] *****************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Check whether <span class="string">'/usr/local/jdk1.7.0_79'</span> file exist] </div><div class="line">fatal: [192.168.31.110]: FAILED! =&gt; &#123;<span class="string">"changed"</span>: <span class="literal">true</span>, <span class="string">"cmd"</span>: <span class="string">"ls /usr/local/jdk1.7.0_79"</span>, <span class="string">"delta"</span>: <span class="string">"0:00:00.004081"</span>, <span class="string">"end"</span>: <span class="string">"2017-03-21 10:45:48.414682"</span>, <span class="string">"failed"</span>: <span class="literal">true</span>, <span class="string">"rc"</span>: 2, <span class="string">"start"</span>: <span class="string">"2017-03-21 10:45:48.410601"</span>, <span class="string">"stderr"</span>: <span class="string">"ls: cannot access /usr/local/jdk1.7.0_79: No such file or directory"</span>, <span class="string">"stdout"</span>: <span class="string">""</span>, <span class="string">"stdout_lines"</span>: [], <span class="string">"warnings"</span>: []&#125;</div><div class="line">...ignoring</div><div class="line"></div><div class="line">TASK [source_zabbix_server : unarchive jdk-7u79 <span class="built_in">source</span> package] ****************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Configure java variable] **************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : unarchive zabbix-3.2.4 <span class="built_in">source</span> package] ************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Install zabbix <span class="built_in">source</span> package] ********************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Check whether zabbix users exist] *****************</div><div class="line">fatal: [192.168.31.110]: FAILED! =&gt; &#123;<span class="string">"changed"</span>: <span class="literal">true</span>, <span class="string">"cmd"</span>: <span class="string">"id zabbix"</span>, <span class="string">"delta"</span>: <span class="string">"0:00:00.004139"</span>, <span class="string">"end"</span>: <span class="string">"2017-03-21 10:46:58.885950"</span>, <span class="string">"failed"</span>: <span class="literal">true</span>, <span class="string">"rc"</span>: 1, <span class="string">"start"</span>: <span class="string">"2017-03-21 10:46:58.881811"</span>, <span class="string">"stderr"</span>: <span class="string">"id: zabbix: No such user"</span>, <span class="string">"stdout"</span>: <span class="string">""</span>, <span class="string">"stdout_lines"</span>: [], <span class="string">"warnings"</span>: []&#125;</div><div class="line">...ignoring</div><div class="line"></div><div class="line">TASK [source_zabbix_server : The zabbix user does not exist, so we need to create it.] ***</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Replace some files] *******************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/etc/php.ini'</span>, u<span class="string">'line'</span>: u<span class="string">'max_execution_time = 300'</span>, u<span class="string">'reg'</span>: u<span class="string">'^max_execution_time'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/etc/php.ini'</span>, u<span class="string">'line'</span>: u<span class="string">'post_max_size = 16M'</span>, u<span class="string">'reg'</span>: u<span class="string">'^post_max_size'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/etc/php.ini'</span>, u<span class="string">'line'</span>: u<span class="string">'max_input_time = 300'</span>, u<span class="string">'reg'</span>: u<span class="string">'^max_input_time'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/etc/php.ini'</span>, u<span class="string">'line'</span>: u<span class="string">'date.timezone = "Asia/Shanghai"'</span>, u<span class="string">'reg'</span>: u<span class="string">'^;date.timezone'</span>&#125;)</div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/etc/php-fpm.conf'</span>, u<span class="string">'line'</span>: u<span class="string">'pid = /var/run/php-fpm/php-fpm.pid'</span>, u<span class="string">'reg'</span>: u<span class="string">'^;pid ='</span>&#125;)</div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/etc/php-fpm.d/www.conf'</span>, u<span class="string">'line'</span>: u<span class="string">'pm.min_spare_servers = 5'</span>, u<span class="string">'reg'</span>: u<span class="string">'^;pm.min_spare_servers'</span>&#125;)</div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/etc/php-fpm.d/www.conf'</span>, u<span class="string">'line'</span>: u<span class="string">'pm.max_spare_servers = 35'</span>, u<span class="string">'reg'</span>: u<span class="string">'^;pm.max_spare_servers'</span>&#125;)</div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/etc/php-fpm.d/www.conf'</span>, u<span class="string">'line'</span>: u<span class="string">'pm.start_servers = 5'</span>, u<span class="string">'reg'</span>: u<span class="string">'^;^pm.start_servers'</span>&#125;)</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Copy authorization.sql file] **********************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'files/authorization.sql'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'files/initialize.sql'</span>&#125;)</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Set up mysql database authorization] **************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Authorize Zabbix users] ***************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Initialize the zabbix database] *******************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Configure zabbix] *********************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Copy zabbix configure] ****************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/usr/local/zabbix/etc/zabbix_server.conf'</span>, u<span class="string">'src'</span>: u<span class="string">'templates/zabbix_server.conf'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/usr/local/zabbix/etc/zabbix_agentd.conf'</span>, u<span class="string">'src'</span>: u<span class="string">'templates/zabbix_agentd.conf'</span>&#125;)</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Create some directory] ****************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'path'</span>: u<span class="string">'/usr/local/nginx-1.11.7/html/zabbix'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'path'</span>: u<span class="string">'/var/log/zabbix'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'path'</span>: u<span class="string">'/var/log/nginx/zabbix'</span>&#125;)</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Copy zabbix pages] ********************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Modify file permissions] **************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Command Links] ************************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/usr/local/sbin/zabbix_server'</span>, u<span class="string">'src'</span>: u<span class="string">'/usr/local/zabbix/sbin/zabbix_server'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/usr/local/sbin/zabbix_agentd'</span>, u<span class="string">'src'</span>: u<span class="string">'/usr/local/zabbix/sbin/zabbix_agentd'</span>&#125;)</div><div class="line"></div><div class="line">TASK [source_zabbix_server : touch zabbix <span class="built_in">log</span> file] ****************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'path'</span>: u<span class="string">'/var/log/zabbix/zabbix_server.log'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'path'</span>: u<span class="string">'/var/log/zabbix/zabbix_agentd.log'</span>&#125;)</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Configure nginx <span class="keyword">for</span> Zabbix] ***********************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Check whether fastcgi.conf file exist] ************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Copy fastcgi.conf file] ***************************</div><div class="line">skipping: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_zabbix_server : Add zabbix to chkconfig] **************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">RUNNING HANDLER [source_zabbix_server : restart zabbix server] *****************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'zabbix_server'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'zabbix_agentd'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'php-fpm'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'nginx'</span>&#125;)</div><div class="line"></div><div class="line">PLAY RECAP *********************************************************************</div><div class="line">192.168.31.110             : ok=31   changed=28   unreachable=0    failed=0   </div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p><img src="http://note.youdao.com/yws/api/personal/file/1B3E3B138F6F4BD2BD3F7EE4A611B33C?method=download&amp;shareKey=15995fa7cd9fd6515aa8b95ea4712f07" alt="image">  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m shell -a 'ps -ef | grep zabbix | grep -v grep'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">zabbix    11586      1  0 18:01 ?        00:00:00 /usr/<span class="built_in">local</span>/sbin/zabbix_server</div><div class="line">zabbix    11593  11586  0 18:01 ?        00:00:00 /usr/<span class="built_in">local</span>/sbin/zabbix_server: configuration syncer [synced configuration <span class="keyword">in</span> 0.006998 sec, idle 60 sec]</div><div class="line">zabbix    11594  11586  0 18:01 ?        00:00:00 /usr/<span class="built_in">local</span>/sbin/zabbix_server: db watchdog [synced alerts config <span class="keyword">in</span> 0.001220 sec, idle 60 sec]</div><div class="line">zabbix    11595  11586  0 18:01 ?        00:00:00 /usr/<span class="built_in">local</span>/sbin/zabbix_server: poller <span class="comment">#1 [got 0 values in 0.000101 sec, idle 5 sec]</span></div><div class="line">···</div></pre></td></tr></table></figure>
<p><img src="http://note.youdao.com/yws/api/personal/file/F586BD68280D4E8281FF40208BB99318?method=download&amp;shareKey=2547559de07cb0792ac84676339ec885" alt="image"><br><img src="http://note.youdao.com/yws/api/personal/file/AAB04280F3D5480098F3560BA6ACCBD6?method=download&amp;shareKey=22bd12e0ba86ebb7b6f545ca6debaea7" alt="image">  </p>
<h2 id="Ansible之源码安装Zabbix-agent"><a href="#Ansible之源码安装Zabbix-agent" class="headerlink" title="Ansible之源码安装Zabbix-agent"></a>Ansible之源码安装Zabbix-agent</h2><ul>
<li>Zabbix_Agent结构目录  </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#结构目录</span></div><div class="line">[root@Ansible ~]<span class="comment"># tree /etc/ansible/</span></div><div class="line">/etc/ansible/</div><div class="line">├── ansible.cfg</div><div class="line">├── hosts</div><div class="line">├── roles</div><div class="line">│   └── source_zabbix_agent</div><div class="line">│       ├── files</div><div class="line">│       │   ├── yum.repo</div><div class="line">│       │   └── zabbix-3.2.4.tar.gz</div><div class="line">│       ├── handlers</div><div class="line">│       │   └── main.yml</div><div class="line">│       ├── tasks</div><div class="line">│       │   └── main.yml</div><div class="line">│       ├── templates</div><div class="line">│       │   └── zabbix_agentd.conf</div><div class="line">│       └── vars</div><div class="line">│           └── main.yml</div><div class="line">└── site.yml</div><div class="line"></div><div class="line">7 directories, 9 files</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>环境：<br>　　　ansible 2.2.1.0<br>　　　Centos 6.6<br>　　　zabbix-3.2.4  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#入口文件</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat site.yml </span></div><div class="line">- hosts: test_hosts2</div><div class="line">  user: root</div><div class="line">  roles:</div><div class="line">    - source_zabbix_agent</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#tasks</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat roles/source_zabbix_agent/tasks/main.yml </span></div><div class="line">- name: Install libselinux-python package</div><div class="line">  yum: name=libselinux-python state=installed</div><div class="line"></div><div class="line">- name: Check whether yum.repo file exist</div><div class="line">  shell: ls /etc/yum.repos.d/yum.repo</div><div class="line">  register: result</div><div class="line">  ignore_errors: True</div><div class="line">- name: Copy yum.repo file</div><div class="line">  copy: src=<span class="string">"files/yum.repo"</span> dest=<span class="string">"/etc/yum.repos.d/yum.repo"</span> mode=0644 owner=root group=root</div><div class="line">  when: result|failed</div><div class="line">- name: Rebuild the yum cache</div><div class="line">  shell: yum clean all &amp;&amp; yum makecache</div><div class="line">  when: result|failed</div><div class="line"></div><div class="line">- name: Install same devel packages</div><div class="line">  yum: name=<span class="string">"&#123;&#123;item.name&#125;&#125;"</span></div><div class="line">  with_items:</div><div class="line">    - name: <span class="string">"net-snmp"</span></div><div class="line">    - name: <span class="string">"net-snmp-devel"</span></div><div class="line">    - name: <span class="string">"libxml2-devel"</span></div><div class="line">    - name: <span class="string">"libcurl-devel"</span></div><div class="line">    - name: <span class="string">"java-devel"</span></div><div class="line">    - name: <span class="string">"unixODBC"</span></div><div class="line">    - name: <span class="string">"unixODBC-devel"</span></div><div class="line">    - name: <span class="string">"OpenIPMI-devel"</span></div><div class="line">    - name: <span class="string">"curl-devel"</span></div><div class="line">    - name: <span class="string">"libssh2-devel"</span></div><div class="line">    - name: <span class="string">"MySQL-python"</span></div><div class="line"></div><div class="line">- name: unarchive zabbix-3.2.4 <span class="built_in">source</span> package</div><div class="line">  unarchive: src=<span class="string">"files/zabbix-3.2.4.tar.gz"</span> dest=<span class="string">"/tmp"</span> remote_src=no</div><div class="line">- name: Install zabbix <span class="built_in">source</span> package</div><div class="line">  shell: <span class="built_in">cd</span> /tmp/zabbix-3.2.4 &amp;&amp; ./configure --prefix=&#123;&#123;zabbix_install_path&#125;&#125; --enable-agent  &amp;&amp; make &amp;&amp; make install</div><div class="line">- name: Configure zabbix</div><div class="line">  copy: src=<span class="string">"/tmp/zabbix-3.2.4/misc/init.d/fedora/core/zabbix_agentd"</span> dest=<span class="string">"/etc/init.d/zabbix_agentd"</span> mode=0755 remote_src=True</div><div class="line"></div><div class="line">- name: Check whether zabbix users exist</div><div class="line">  shell: id zabbix</div><div class="line">  register: result</div><div class="line">  ignore_errors: True</div><div class="line">- name: The zabbix user does not exist, so we need to create it.</div><div class="line">  user: name=zabbix createhome=yes home=/home/zabbix shell=/sbin/nologin  state=present</div><div class="line">  when: result|failed</div><div class="line"></div><div class="line">- name: Configure zabbix agent</div><div class="line">  template: src=<span class="string">"templates/zabbix_agentd.conf"</span> dest=<span class="string">"&#123;&#123;zabbix_install_path&#125;&#125;/etc/zabbix_agentd.conf"</span></div><div class="line"></div><div class="line">- name: Command Links</div><div class="line">  file: src=<span class="string">"&#123;&#123;zabbix_install_path&#125;&#125;/sbin/zabbix_agentd"</span> dest=<span class="string">"/usr/local/sbin/zabbix_agentd"</span> state=link remote_src=True</div><div class="line"></div><div class="line">- name: touch zabbix <span class="built_in">log</span> file</div><div class="line">  file: path=&#123;&#123;item.path&#125;&#125; state=<span class="string">"&#123;&#123;item.state|default("</span>touch<span class="string">")&#125;&#125;"</span> owner=zabbix group=zabbix mode=0755</div><div class="line">  with_items:</div><div class="line">    - path: <span class="string">"&#123;&#123;zabbix_log_path&#125;&#125;"</span></div><div class="line">      state: <span class="string">"directory"</span></div><div class="line">    - path: <span class="string">"&#123;&#123;zabbix_log_path&#125;&#125;/zabbix_agentd.log"</span></div><div class="line">- name: Add zabbix_agent to chkconfig</div><div class="line">  shell: chkconfig --add zabbix_agentd</div><div class="line">  notify: restart zabbix agent</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#handlers</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat roles/source_zabbix_agent/handlers/main.yml </span></div><div class="line">- name: restart zabbix agent</div><div class="line">  service: name=<span class="string">"zabbix_agentd"</span> state=restarted enabled=yes</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#变量</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat roles/source_zabbix_agent/vars/main.yml </span></div><div class="line">zabbix_install_path: /usr/<span class="built_in">local</span>/zabbix</div><div class="line">zabbix_log_path: /var/<span class="built_in">log</span>/zabbix</div><div class="line">zabbix_server_ip: 192.168.31.110</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#执行过程</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible-playbook /etc/ansible/site.yml </span></div><div class="line"></div><div class="line">PLAY [test_hosts2] *************************************************************</div><div class="line"></div><div class="line">TASK [setup] *******************************************************************</div><div class="line">ok: [192.168.31.120]</div><div class="line"></div><div class="line">TASK [source_zabbix_agent : Install libselinux-python package] *****************</div><div class="line">changed: [192.168.31.120]</div><div class="line"></div><div class="line">TASK [source_zabbix_agent : Check whether yum.repo file exist] *****************</div><div class="line">fatal: [192.168.31.120]: FAILED! =&gt; &#123;<span class="string">"changed"</span>: <span class="literal">true</span>, <span class="string">"cmd"</span>: <span class="string">"ls /etc/yum.repos.d/yum.repo"</span>, <span class="string">"delta"</span>: <span class="string">"0:00:00.004811"</span>, <span class="string">"end"</span>: <span class="string">"2017-03-21 18:22:42.833895"</span>, <span class="string">"failed"</span>: <span class="literal">true</span>, <span class="string">"rc"</span>: 2, <span class="string">"start"</span>: <span class="string">"2017-03-21 18:22:42.829084"</span>, <span class="string">"stderr"</span>: <span class="string">"ls: cannot access /etc/yum.repos.d/yum.repo: No such file or directory"</span>, <span class="string">"stdout"</span>: <span class="string">""</span>, <span class="string">"stdout_lines"</span>: [], <span class="string">"warnings"</span>: []&#125;</div><div class="line">...ignoring</div><div class="line"></div><div class="line">TASK [source_zabbix_agent : Copy yum.repo file] ********************************</div><div class="line">changed: [192.168.31.120]</div><div class="line"></div><div class="line">TASK [source_zabbix_agent : Rebuild the yum cache] *****************************</div><div class="line">changed: [192.168.31.120]</div><div class="line"> [WARNING]: Consider using yum module rather than running yum</div><div class="line"></div><div class="line"></div><div class="line">TASK [source_zabbix_agent : Install same devel packages] ***********************</div><div class="line">changed: [192.168.31.120] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'net-snmp'</span>&#125;)</div><div class="line">changed: [192.168.31.120] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'net-snmp-devel'</span>&#125;)</div><div class="line">changed: [192.168.31.120] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'libxml2-devel'</span>&#125;)</div><div class="line">changed: [192.168.31.120] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'libcurl-devel'</span>&#125;)</div><div class="line">changed: [192.168.31.120] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'java-devel'</span>&#125;)</div><div class="line">changed: [192.168.31.120] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'unixODBC'</span>&#125;)</div><div class="line">changed: [192.168.31.120] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'unixODBC-devel'</span>&#125;)</div><div class="line">changed: [192.168.31.120] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'OpenIPMI-devel'</span>&#125;)</div><div class="line">ok: [192.168.31.120] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'curl-devel'</span>&#125;)</div><div class="line">changed: [192.168.31.120] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'libssh2-devel'</span>&#125;)</div><div class="line">changed: [192.168.31.120] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'MySQL-python'</span>&#125;)</div><div class="line"></div><div class="line">TASK [source_zabbix_agent : unarchive zabbix-3.2.4 <span class="built_in">source</span> package] *************</div><div class="line">changed: [192.168.31.120]</div><div class="line"></div><div class="line">TASK [source_zabbix_agent : Install zabbix <span class="built_in">source</span> package] *********************</div><div class="line">changed: [192.168.31.120]</div><div class="line"></div><div class="line">TASK [source_zabbix_agent : Configure zabbix] **********************************</div><div class="line">changed: [192.168.31.120]</div><div class="line"></div><div class="line">TASK [source_zabbix_agent : Check whether zabbix users exist] ******************</div><div class="line">fatal: [192.168.31.120]: FAILED! =&gt; &#123;<span class="string">"changed"</span>: <span class="literal">true</span>, <span class="string">"cmd"</span>: <span class="string">"id zabbix"</span>, <span class="string">"delta"</span>: <span class="string">"0:00:00.005663"</span>, <span class="string">"end"</span>: <span class="string">"2017-03-21 18:35:09.861371"</span>, <span class="string">"failed"</span>: <span class="literal">true</span>, <span class="string">"rc"</span>: 1, <span class="string">"start"</span>: <span class="string">"2017-03-21 18:35:09.855708"</span>, <span class="string">"stderr"</span>: <span class="string">"id: zabbix: No such user"</span>, <span class="string">"stdout"</span>: <span class="string">""</span>, <span class="string">"stdout_lines"</span>: [], <span class="string">"warnings"</span>: []&#125;</div><div class="line">...ignoring</div><div class="line"></div><div class="line">TASK [source_zabbix_agent : The zabbix user does not exist, so we need to create it.] ***</div><div class="line">changed: [192.168.31.120]</div><div class="line"></div><div class="line">TASK [source_zabbix_agent : Configure zabbix agent] ****************************</div><div class="line">changed: [192.168.31.120]</div><div class="line"></div><div class="line">TASK [source_zabbix_agent : Command Links] *************************************</div><div class="line">changed: [192.168.31.120]</div><div class="line"></div><div class="line">TASK [source_zabbix_agent : touch zabbix <span class="built_in">log</span> file] *****************************</div><div class="line">changed: [192.168.31.120] =&gt; (item=&#123;u<span class="string">'path'</span>: u<span class="string">'/var/log/zabbix'</span>, u<span class="string">'state'</span>: u<span class="string">'directory'</span>&#125;)</div><div class="line">changed: [192.168.31.120] =&gt; (item=&#123;u<span class="string">'path'</span>: u<span class="string">'/var/log/zabbix/zabbix_agentd.log'</span>&#125;)</div><div class="line"></div><div class="line">TASK [source_zabbix_agent : Add zabbix_agent to chkconfig] *********************</div><div class="line">changed: [192.168.31.120]</div><div class="line"></div><div class="line">RUNNING HANDLER [source_zabbix_agent : restart zabbix agent] *******************</div><div class="line">changed: [192.168.31.120]</div><div class="line"></div><div class="line">PLAY RECAP *********************************************************************</div><div class="line">192.168.31.120             : ok=16   changed=15   unreachable=0    failed=0   </div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts2 -m shell -a 'ps -ef | grep zabbix_agentd  | grep -v grep'</span></div><div class="line">192.168.31.120 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">zabbix     9164      1  0 18:35 ?        00:00:00 /usr/<span class="built_in">local</span>/sbin/zabbix_agentd</div><div class="line">zabbix     9167   9164  0 18:35 ?        00:00:00 /usr/<span class="built_in">local</span>/sbin/zabbix_agentd: collector [idle 1 sec]</div><div class="line">zabbix     9168   9164  0 18:35 ?        00:00:00 /usr/<span class="built_in">local</span>/sbin/zabbix_agentd: listener <span class="comment">#1 [waiting for connection]</span></div><div class="line">zabbix     9169   9164  0 18:35 ?        00:00:00 /usr/<span class="built_in">local</span>/sbin/zabbix_agentd: listener <span class="comment">#2 [waiting for connection]</span></div><div class="line">zabbix     9170   9164  0 18:35 ?        00:00:00 /usr/<span class="built_in">local</span>/sbin/zabbix_agentd: listener <span class="comment">#3 [waiting for connection]</span></div><div class="line">zabbix     9171   9164  0 18:35 ?        00:00:00 /usr/<span class="built_in">local</span>/sbin/zabbix_agentd: active checks <span class="comment">#1 [idle 1 sec]</span></div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p><img src="http://note.youdao.com/yws/api/personal/file/5D828A8CCD3643EB8F083F1CCF8C71EB?method=download&amp;shareKey=0810956092871cfbe13f70370cb0395c" alt="image">  </p>
<p>附件：<br><a href="http://note.youdao.com/yws/api/personal/file/554F1EB189BD49ACBDAD71A8B003AC3F?method=download&amp;shareKey=be625cbe4ce873c616ff86f32ea8763b" target="_blank" rel="external">ansible_install_zabbix_server3.2.tar.gz</a><br><a href="http://note.youdao.com/yws/api/personal/file/A9AAE22EB1F64A01B780344178710FAD?method=download&amp;shareKey=6a6454485d9104a40c2fccaffeb33473" target="_blank" rel="external">ansible_install_zabbix_agent3.2.tar.gz</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="https://yfshare.github.io">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="https://yfshare.github.io/2017/03/20/Ansible-Playbooks之安装Zabbix/">https://yfshare.github.io/2017/03/20/Ansible-Playbooks之安装Zabbix/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;playbooks 是一种简单的配置管理系统与多机器部署系统的基础。与现有的其他系统有不同之处,且非常适合于复杂应用的批量部署&lt;br&gt;Playbooks 的格式是YAML，语法做到最小化  &lt;/p&gt;
&lt;p&gt;这里讲述的是使用ansible-playbooks的roles安装Zabbix应用&lt;br&gt;
    
    </summary>
    
      <category term="Ansible" scheme="https://yfshare.github.io/categories/Ansible/"/>
    
    
      <category term="ansible" scheme="https://yfshare.github.io/tags/ansible/"/>
    
      <category term="Zabbix" scheme="https://yfshare.github.io/tags/Zabbix/"/>
    
  </entry>
  
  <entry>
    <title>Ansible-Playbooks之安装LNMP</title>
    <link href="https://yfshare.github.io/2017/03/20/Ansible-Playbooks%E4%B9%8B%E5%AE%89%E8%A3%85LNMP/"/>
    <id>https://yfshare.github.io/2017/03/20/Ansible-Playbooks之安装LNMP/</id>
    <published>2017-03-20T07:27:40.000Z</published>
    <updated>2017-03-21T01:56:53.000Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>playbooks 是一种简单的配置管理系统与多机器部署系统的基础。与现有的其他系统有不同之处,且非常适合于复杂应用的批量部署<br>Playbooks 的格式是YAML，语法做到最小化  </p>
<p>这里讲述的是使用ansible-playbooks的roles安装LNMP应用<br><a id="more"></a></p>
<h2 id="结构目录"><a href="#结构目录" class="headerlink" title="结构目录"></a>结构目录</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">[root@Ansible ~]<span class="comment"># tree /etc/ansible/</span></div><div class="line">/etc/ansible/</div><div class="line">├── ansible.cfg</div><div class="line">├── hosts</div><div class="line">├── roles</div><div class="line">│   ├── source_nginx</div><div class="line">│   │   ├── files</div><div class="line">│   │   │   ├── <span class="built_in">echo</span>-nginx-module-0.59.tar.gz</div><div class="line">│   │   │   ├── gperftools-2.0.zip</div><div class="line">│   │   │   ├── nginx-1.11.7.tar.gz</div><div class="line">│   │   │   ├── nginx_tcp_proxy_module_nginx1.11.7.zip</div><div class="line">│   │   │   ├── nginx-upstream-jvm-route-nginx1.11.7.zip</div><div class="line">│   │   │   ├── ngx_cache_purge-2.3.tar.gz</div><div class="line">│   │   │   ├── openssl-1.1.0e.tar.gz</div><div class="line">│   │   │   ├── pcre-8.40.zip</div><div class="line">│   │   │   ├── yum.repo</div><div class="line">│   │   │   └── zlib-1.2.11.tar.gz</div><div class="line">│   │   ├── handlers</div><div class="line">│   │   │   └── main.yml</div><div class="line">│   │   ├── tasks</div><div class="line">│   │   │   └── main.yml</div><div class="line">│   │   ├── templates</div><div class="line">│   │   │   ├── comm.conf.j2</div><div class="line">│   │   │   ├── etc_init.d_nginx.txt</div><div class="line">│   │   │   ├── fastcgi.conf.j2</div><div class="line">│   │   │   ├── nginx.conf.j2</div><div class="line">│   │   │   ├── proxy.conf.j2</div><div class="line">│   │   │   └── static.conf.j2</div><div class="line">│   │   └── vars</div><div class="line">│   │       └── main.yml</div><div class="line">│   ├── yum_mysql</div><div class="line">│   │   ├── files</div><div class="line">│   │   │   └── yum.repo</div><div class="line">│   │   ├── handlers</div><div class="line">│   │   │   └── main.yml</div><div class="line">│   │   ├── tasks</div><div class="line">│   │   │   └── main.yml</div><div class="line">│   │   ├── templates</div><div class="line">│   │   │   └── my.cnf.j2</div><div class="line">│   │   └── vars</div><div class="line">│   │       └── main.yml</div><div class="line">│   └── yum_php</div><div class="line">│       ├── files</div><div class="line">│       │   └── yum.repo</div><div class="line">│       ├── handlers</div><div class="line">│       │   └── main.yml</div><div class="line">│       ├── tasks</div><div class="line">│       │   └── main.yml</div><div class="line">│       ├── templates</div><div class="line">│       │   └── www.conf.j2</div><div class="line">│       └── vars</div><div class="line">│           └── main.yml</div><div class="line">└── site.yml</div><div class="line"></div><div class="line">19 directories, 32 files</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h2 id="Ansible之安装LNMP"><a href="#Ansible之安装LNMP" class="headerlink" title="Ansible之安装LNMP"></a>Ansible之安装LNMP</h2><p>参考：<br><a href="http://www.yfshare.vip/2017/03/11/Ansible-Playbooks之安装Nginx/" target="_blank" rel="external">Ansible-Playbooks之安装Nginx</a><br><a href="HTTP://WWW.YFSHARE.VIP/2017/03/15/ANSIBLE-PLAYBOOKS之安装PHP/" target="_blank" rel="external">Ansible-Playbooks之安装PHP</a><br><a href="http://www.yfshare.vip/2017/03/16/Ansible-Playbooks之安装Mysql/" target="_blank" rel="external">Ansible-Playbooks之安装Mysql</a><br>环境：<br>　　　ansible 2.2.1.0<br>　　　Centos 6.6<br>　　　PHP 7.0.16 (fpm-fcgi)<br>　　　Nginx 1.11.7<br>　　　Mysql 5.5.54 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#入口文件</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat site.yml </span></div><div class="line">- hosts: test_hosts</div><div class="line">  user: root</div><div class="line">  roles:</div><div class="line">    - yum_mysql</div><div class="line">    - yum_php</div><div class="line">    - source_nginx</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>注：之前可能是在最后安装的mysql，把之前在PHP上安装的一个插件(php70w-mysql)弄丢了，所以就把mysql放最前面安装了<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div></pre></td><td class="code"><pre><div class="line">[root@Ansible ~]<span class="comment"># ansible-playbook /etc/ansible/site.yml </span></div><div class="line"></div><div class="line">PLAY [test_hosts] **************************************************************</div><div class="line"></div><div class="line">TASK [setup] *******************************************************************</div><div class="line">ok: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_mysql : Install libselinux-python package] ***************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_mysql : Check whether yum.repo file exist] ***************************</div><div class="line">fatal: [192.168.31.110]: FAILED! =&gt; &#123;<span class="string">"changed"</span>: <span class="literal">true</span>, <span class="string">"cmd"</span>: <span class="string">"ls /etc/yum.repos.d/yum.repo"</span>, <span class="string">"delta"</span>: <span class="string">"0:00:00.004362"</span>, <span class="string">"end"</span>: <span class="string">"2017-03-20 12:01:43.959441"</span>, <span class="string">"failed"</span>: <span class="literal">true</span>, <span class="string">"rc"</span>: 2, <span class="string">"start"</span>: <span class="string">"2017-03-20 12:01:43.955079"</span>, <span class="string">"stderr"</span>: <span class="string">"ls: cannot access /etc/yum.repos.d/yum.repo: No such file or directory"</span>, <span class="string">"stdout"</span>: <span class="string">""</span>, <span class="string">"stdout_lines"</span>: [], <span class="string">"warnings"</span>: []&#125;</div><div class="line">...ignoring</div><div class="line"></div><div class="line">TASK [yum_mysql : Copy yum.repo file] ******************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_mysql : Rebuild the yum cache] ***************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"> [WARNING]: Consider using yum module rather than running yum</div><div class="line"></div><div class="line"></div><div class="line">TASK [yum_mysql : Install Mysql Packages] **************************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'state'</span>: u<span class="string">'absent'</span>, u<span class="string">'name'</span>: u<span class="string">'mysql*'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'mysql.x86_64'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'mysql-devel.x86_64'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'mysql-server.x86_64'</span>&#125;)</div><div class="line"></div><div class="line">TASK [yum_mysql : Configure Mysql file] ****************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_php : Install libselinux-python package] *****************************</div><div class="line">ok: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_php : Check whether yum.repo file exist] *****************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_php : Copy yum.repo file] ********************************************</div><div class="line">skipping: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_php : Rebuild the yum cache] *****************************************</div><div class="line">skipping: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_php : Check whether nginx users exist] *******************************</div><div class="line">fatal: [192.168.31.110]: FAILED! =&gt; &#123;<span class="string">"changed"</span>: <span class="literal">true</span>, <span class="string">"cmd"</span>: <span class="string">"id nginx"</span>, <span class="string">"delta"</span>: <span class="string">"0:00:00.005955"</span>, <span class="string">"end"</span>: <span class="string">"2017-03-20 12:14:49.015479"</span>, <span class="string">"failed"</span>: <span class="literal">true</span>, <span class="string">"rc"</span>: 1, <span class="string">"start"</span>: <span class="string">"2017-03-20 12:14:49.009524"</span>, <span class="string">"stderr"</span>: <span class="string">"id: nginx: No such user"</span>, <span class="string">"stdout"</span>: <span class="string">""</span>, <span class="string">"stdout_lines"</span>: [], <span class="string">"warnings"</span>: []&#125;</div><div class="line">...ignoring</div><div class="line"></div><div class="line">TASK [yum_php : The nginx user does not exist, so we need to create it.[The nginx user<span class="string">'s password is 123456]] ***</span></div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_php : Install PHP packages] ******************************************</div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'state<span class="string">': u'</span>absent<span class="string">', u'</span>name<span class="string">': u'</span>php*<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-gd<span class="string">'&#125;)</span></div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>libjpeg*<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-imap<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-ldap<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-odbc<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-pear<span class="string">'&#125;)</span></div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-xml<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-xmlrpc<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-mbstring<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-mcrypt<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-bcmath<span class="string">'&#125;)</span></div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>libmcrypt<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>libmcrypt-devel<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-fpm<span class="string">'&#125;)</span></div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-cli<span class="string">'&#125;)</span></div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-pdo<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-tidy<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-mysql<span class="string">'&#125;)</span></div><div class="line"></div><div class="line">TASK [yum_php : Configure PHP] *************************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_php : Modify file permissions] ***************************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'path<span class="string">': u'</span>/etc/httpd/conf.d/php.conf<span class="string">', u'</span>state<span class="string">': u'</span>file<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'path<span class="string">': u'</span>/var/lib/php/session<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'path<span class="string">': u'</span>/var/lib/php/wsdlcache<span class="string">'&#125;)</span></div><div class="line"></div><div class="line">TASK [source_nginx : disabled iptables] ****************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Set the selinux value to Permissive] **********************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Create download directory] ********************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Install the some tools] ***********************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>unzip<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>zip<span class="string">'&#125;)</span></div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>tar<span class="string">'&#125;)</span></div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>libselinux-python<span class="string">'&#125;)</span></div><div class="line"></div><div class="line">TASK [source_nginx : download some source packages] ****************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'url<span class="string">': u'</span>https://ftp.pcre.org/pub/pcre/pcre-8.40.zip<span class="string">', u'</span>validate_certs<span class="string">': u'</span>no<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'url<span class="string">': u'</span>http://nginx.org/download/nginx-1.11.7.tar.gz<span class="string">'&#125;)</span></div><div class="line"></div><div class="line">TASK [source_nginx : unarchive some source packages] ***************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'src<span class="string">': u'</span>/tmp/download/nginx-1.11.7.tar.gz<span class="string">', u'</span>remote_src<span class="string">': u'</span>yes<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'src<span class="string">': u'</span>/tmp/download/pcre-8.40.zip<span class="string">', u'</span>remote_src<span class="string">': u'</span>yes<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'src<span class="string">': u'</span>files/zlib-1.2.11.tar.gz<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'src<span class="string">': u'</span>files/openssl-1.1.0e.tar.gz<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'src<span class="string">': u'</span>files/gperftools-2.0.zip<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'src<span class="string">': u'</span>files/<span class="built_in">echo</span>-nginx-module-0.59.tar.gz<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'src<span class="string">': u'</span>files/nginx-upstream-jvm-route-nginx1.11.7.zip<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'src<span class="string">': u'</span>files/ngx_cache_purge-2.3.tar.gz<span class="string">'&#125;)</span></div><div class="line"></div><div class="line">TASK [source_nginx : Check whether nginx users exist] **************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : The nginx user does not exist, so we need to create it.[The nginx user's password is 123456]] ***</div><div class="line">skipping: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Install the pcre-8.40 <span class="built_in">source</span> package] *********************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Install the zlib-1.2.11 <span class="built_in">source</span> package] *******************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Install the openssl-1.1.0e <span class="built_in">source</span> package] ****************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Install the some devel packages] **************************</div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'rpm'</span>: u<span class="string">'openssl-devel'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'rpm'</span>: u<span class="string">'pcre-devel'</span>&#125;)</div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'rpm'</span>: u<span class="string">'zlib-devel'</span>&#125;)</div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'rpm'</span>: u<span class="string">'gcc'</span>&#125;)</div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'rpm'</span>: u<span class="string">'gcc-c++'</span>&#125;)</div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'rpm'</span>: u<span class="string">'make'</span>&#125;)</div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'rpm'</span>: u<span class="string">'perl'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'rpm'</span>: u<span class="string">'perl-devel'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'rpm'</span>: u<span class="string">'perl-ExtUtils-Embed'</span>&#125;)</div><div class="line"></div><div class="line">TASK [source_nginx : Install the gperftools-2.0 <span class="built_in">source</span> package] ****************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Install patch package] ************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Play nginx-upstream-jvm-route patche] *********************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Install the Nginx package] ********************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Create some directory] ************************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'path'</span>: u<span class="string">'/tmp/tcmalloc'</span>, u<span class="string">'mode'</span>: u<span class="string">'0777'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'path'</span>: u<span class="string">'/var/proxy_cache/temp'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'path'</span>: u<span class="string">'/var/proxy_cache/cache'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'path'</span>: u<span class="string">'/var/log/nginx'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'path'</span>: u<span class="string">'/usr/local/nginx-1.11.7/conf/vhosts'</span>&#125;)</div><div class="line"></div><div class="line">TASK [source_nginx : <span class="built_in">set</span> nginx parameter] **************************************</div><div class="line">ok: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Copy same files] ******************************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/etc/init.d/nginx'</span>, u<span class="string">'src'</span>: u<span class="string">'templates/etc_init.d_nginx.txt'</span>, u<span class="string">'mode'</span>: u<span class="string">'0755'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/usr/local/nginx-1.11.7/conf/nginx.conf'</span>, u<span class="string">'src'</span>: u<span class="string">'templates/nginx.conf.j2'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/usr/local/nginx-1.11.7/conf/vhosts/proxy.conf'</span>, u<span class="string">'src'</span>: u<span class="string">'templates/proxy.conf.j2'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/usr/local/nginx-1.11.7/conf/vhosts/comm.conf'</span>, u<span class="string">'src'</span>: u<span class="string">'templates/comm.conf.j2'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/usr/local/nginx-1.11.7/conf/vhosts/static.conf'</span>, u<span class="string">'src'</span>: u<span class="string">'templates/static.conf.j2'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/usr/local/nginx-1.11.7/conf/vhosts/fastcgi.conf'</span>, u<span class="string">'src'</span>: u<span class="string">'templates/fastcgi.conf.j2'</span>&#125;)</div><div class="line"></div><div class="line">RUNNING HANDLER [yum_mysql : restart mysql] ************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">RUNNING HANDLER [yum_mysql : Set the mysql database password] ******************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">RUNNING HANDLER [yum_php : restart php-fpm] ************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">RUNNING HANDLER [source_nginx : restart nginx] *********************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">PLAY RECAP *********************************************************************</div><div class="line">192.168.31.110             : ok=36   changed=33   unreachable=0    failed=0   </div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m shell -a '/etc/init.d/nginx status'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">nginx (pid  78698) is running...</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m shell -a '/etc/init.d/php-fpm status'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">php-fpm (pid  78539) is running...</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m shell -a '/etc/init.d/mysqld status'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">mysqld (pid 78413) is running...</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p><img src="http://note.youdao.com/yws/api/personal/file/994FFC90CD3947DE8ED1E8BF19428A63?method=download&amp;shareKey=7e2c02f801b5e0f73c8054dfddbb8474" alt="image">  </p>
<p>附件：<a href="http://note.youdao.com/yws/api/personal/file/6E4594BA860B4DEC8CFE212B8869807A?method=download&amp;shareKey=3e0078221cc76b7e52f5c1e063e3c218" target="_blank" rel="external">ansible_install_LNMP.tar.gz</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="https://yfshare.github.io">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="https://yfshare.github.io/2017/03/20/Ansible-Playbooks之安装LNMP/">https://yfshare.github.io/2017/03/20/Ansible-Playbooks之安装LNMP/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;playbooks 是一种简单的配置管理系统与多机器部署系统的基础。与现有的其他系统有不同之处,且非常适合于复杂应用的批量部署&lt;br&gt;Playbooks 的格式是YAML，语法做到最小化  &lt;/p&gt;
&lt;p&gt;这里讲述的是使用ansible-playbooks的roles安装LNMP应用&lt;br&gt;
    
    </summary>
    
      <category term="Ansible" scheme="https://yfshare.github.io/categories/Ansible/"/>
    
    
      <category term="ansible" scheme="https://yfshare.github.io/tags/ansible/"/>
    
      <category term="LNMP" scheme="https://yfshare.github.io/tags/LNMP/"/>
    
  </entry>
  
  <entry>
    <title>Ansible-Playbooks之安装Mysql</title>
    <link href="https://yfshare.github.io/2017/03/16/Ansible-Playbooks%E4%B9%8B%E5%AE%89%E8%A3%85Mysql/"/>
    <id>https://yfshare.github.io/2017/03/16/Ansible-Playbooks之安装Mysql/</id>
    <published>2017-03-16T11:49:11.000Z</published>
    <updated>2017-03-20T07:03:56.000Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>playbooks 是一种简单的配置管理系统与多机器部署系统的基础。与现有的其他系统有不同之处,且非常适合于复杂应用的批量部署<br>Playbooks 的格式是YAML，语法做到最小化  </p>
<p>这里讲述的是使用ansible-playbooks的roles安装Mysql应用<br><a id="more"></a></p>
<h2 id="结构目录"><a href="#结构目录" class="headerlink" title="结构目录"></a>结构目录</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">[root@Ansible ~]<span class="comment"># tree /etc/ansible/</span></div><div class="line">/etc/ansible/</div><div class="line">├── ansible.cfg</div><div class="line">├── hosts</div><div class="line">├── roles</div><div class="line">│   └── yum_mysql</div><div class="line">│       ├── files</div><div class="line">│       │   └── yum.repo</div><div class="line">│       ├── handlers</div><div class="line">│       │   └── main.yml</div><div class="line">│       ├── tasks</div><div class="line">│       │   └── main.yml</div><div class="line">│       ├── templates</div><div class="line">│       │   └── my.cnf.j2</div><div class="line">│       └── vars</div><div class="line">│           └── main.yml</div><div class="line">└── site.yml</div><div class="line"></div><div class="line">7 directories, 8 files</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h2 id="Ansible之安装mysql"><a href="#Ansible之安装mysql" class="headerlink" title="Ansible之安装mysql"></a>Ansible之安装mysql</h2><p>环境：<br>　　　ansible 2.2.1.0<br>　　　Centos 6.6<br>　　　Mysql 5.5.54</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#入口文件</span></div><div class="line">[root@Ansible ~]<span class="comment"># cd /etc/ansible/</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat site.yml </span></div><div class="line">- hosts: test_hosts</div><div class="line">  user: root</div><div class="line">  roles:</div><div class="line">    - yum_mysql</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#tasks文件</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat roles/yum_mysql/tasks/main.yml </span></div><div class="line">- name: Install libselinux-python package</div><div class="line">  yum: name=libselinux-python state=installed</div><div class="line"></div><div class="line">- name: Check whether yum.repo file exist</div><div class="line">  shell: ls /etc/yum.repos.d/yum.repo</div><div class="line">  register: result</div><div class="line">  ignore_errors: True</div><div class="line">- name: Copy yum.repo file</div><div class="line">  copy: src=yum.repo dest=/etc/yum.repos.d/ mode=0644 owner=root group=root</div><div class="line">  when: result|failed</div><div class="line">- name: Rebuild the yum cache</div><div class="line">  shell: yum clean all &amp;&amp; yum makecache</div><div class="line">  when: result|failed</div><div class="line"></div><div class="line">- name: Install Mysql Packages</div><div class="line">  yum: name=&#123;&#123;item.name&#125;&#125; state=&#123;&#123;item.state|default(<span class="string">"installed"</span>)&#125;&#125;</div><div class="line">  with_items:</div><div class="line">    - name: <span class="string">"mysql*"</span></div><div class="line">      state: <span class="string">"absent"</span></div><div class="line">    - name: <span class="string">"mysql.x86_64"</span></div><div class="line">    - name: <span class="string">"mysql-devel.x86_64"</span></div><div class="line">    - name: <span class="string">"mysql-server.x86_64"</span></div><div class="line">- name: Configure Mysql file</div><div class="line">  template: src=<span class="string">"templates/my.cnf.j2"</span> dest=<span class="string">"/etc/my.cnf"</span> owner=root group=root mode=0644</div><div class="line">  notify: restart mysql</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#handlers</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat roles/yum_mysql/handlers/main.yml </span></div><div class="line">- name: restart mysql</div><div class="line">  service: name=mysqld state=restarted enabled=yes</div><div class="line">  notify: <span class="string">"Set the mysql database password"</span></div><div class="line">- name: Set the mysql database password</div><div class="line">  shell: /usr/bin/mysqladmin -u root password <span class="string">'123456'</span></div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#变量</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat roles/yum_mysql/vars/main.yml </span></div><div class="line">data_dir: /var/lib/mysql</div><div class="line">socket_dir: /var/lib/mysql/mysql.sock</div><div class="line">mysql_user: mysql</div><div class="line">log_error_dir: /var/<span class="built_in">log</span>/mysqld.log</div><div class="line">pid_dir: /var/run/mysqld/mysqld.pid</div><div class="line">port: 3306</div><div class="line">log_bin: mysql_bin</div><div class="line">binlog_format: mixed</div><div class="line">server_id: 1</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#执行过程</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible-playbook /etc/ansible/site.yml </span></div><div class="line"></div><div class="line">PLAY [test_hosts] **************************************************************</div><div class="line"></div><div class="line">TASK [setup] *******************************************************************</div><div class="line">ok: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_mysql : Install libselinux-python package] ***************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_mysql : Check whether yum.repo file exist] ***************************</div><div class="line">fatal: [192.168.31.110]: FAILED! =&gt; &#123;<span class="string">"changed"</span>: <span class="literal">true</span>, <span class="string">"cmd"</span>: <span class="string">"ls /etc/yum.repos.d/yum.repo"</span>, <span class="string">"delta"</span>: <span class="string">"0:00:00.004198"</span>, <span class="string">"end"</span>: <span class="string">"2017-03-19 21:22:56.861926"</span>, <span class="string">"failed"</span>: <span class="literal">true</span>, <span class="string">"rc"</span>: 2, <span class="string">"start"</span>: <span class="string">"2017-03-19 21:22:56.857728"</span>, <span class="string">"stderr"</span>: <span class="string">"ls: cannot access /etc/yum.repos.d/yum.repo: No such file or directory"</span>, <span class="string">"stdout"</span>: <span class="string">""</span>, <span class="string">"stdout_lines"</span>: [], <span class="string">"warnings"</span>: []&#125;</div><div class="line">...ignoring</div><div class="line"></div><div class="line">TASK [yum_mysql : Copy yum.repo file] ******************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_mysql : Rebuild the yum cache] ***************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"> [WARNING]: Consider using yum module rather than running yum</div><div class="line"></div><div class="line"></div><div class="line">TASK [yum_mysql : Install Mysql Packages] **************************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'state'</span>: u<span class="string">'absent'</span>, u<span class="string">'name'</span>: u<span class="string">'mysql*'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'mysql.x86_64'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'mysql-devel.x86_64'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'mysql-server.x86_64'</span>&#125;)</div><div class="line"></div><div class="line">TASK [yum_mysql : Configure Mysql file] ****************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">RUNNING HANDLER [yum_mysql : restart mysql] ************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">RUNNING HANDLER [yum_mysql : Set the mysql database password] ******************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">PLAY RECAP *********************************************************************</div><div class="line">192.168.31.110             : ok=9    changed=8    unreachable=0    failed=0   </div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m shell -a 'netstat -tunlp | grep 3306'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">tcp        0      0 0.0.0.0:3306                0.0.0.0:*                   LISTEN      2086/mysqld         </div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p><img src="http://note.youdao.com/yws/api/personal/file/033A818FA06C4C438C94678F41FCF2A8?method=download&amp;shareKey=4ede3267cc0b52bd9910fb50efc511a1" alt="image">  </p>
<p>附件：<a href="http://note.youdao.com/yws/api/personal/file/0E0DBA17682F4CF3A42A64675C1198A4?method=download&amp;shareKey=7820632c487fc34e0cf892d0b9dddc55" target="_blank" rel="external">ansible_yum_install_mysql.tar.gz</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="https://yfshare.github.io">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="https://yfshare.github.io/2017/03/16/Ansible-Playbooks之安装Mysql/">https://yfshare.github.io/2017/03/16/Ansible-Playbooks之安装Mysql/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;playbooks 是一种简单的配置管理系统与多机器部署系统的基础。与现有的其他系统有不同之处,且非常适合于复杂应用的批量部署&lt;br&gt;Playbooks 的格式是YAML，语法做到最小化  &lt;/p&gt;
&lt;p&gt;这里讲述的是使用ansible-playbooks的roles安装Mysql应用&lt;br&gt;
    
    </summary>
    
      <category term="Ansible" scheme="https://yfshare.github.io/categories/Ansible/"/>
    
    
      <category term="ansible" scheme="https://yfshare.github.io/tags/ansible/"/>
    
      <category term="Mysql" scheme="https://yfshare.github.io/tags/Mysql/"/>
    
  </entry>
  
  <entry>
    <title>Ansible Template处理含特殊字符的文件</title>
    <link href="https://yfshare.github.io/2017/03/16/Ansible%20Template%E5%A4%84%E7%90%86%E5%90%AB%E7%89%B9%E6%AE%8A%E5%AD%97%E7%AC%A6%E7%9A%84%E6%96%87%E4%BB%B6/"/>
    <id>https://yfshare.github.io/2017/03/16/Ansible Template处理含特殊字符的文件/</id>
    <published>2017-03-16T02:26:00.000Z</published>
    <updated>2017-03-16T02:29:30.000Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>Ansible Template模块推送文件时，当遇到含有特殊字符的配置文件，如：”;” “#”等，如果不加处理，在执行Ansible-playbooks时会报错，因为这些模块不能被正确解析，如下图所示：<br><a id="more"></a><br><img src="http://note.youdao.com/yws/api/personal/file/28574AC5961C438A82BD5C9D5F0DEA6F?method=download&amp;shareKey=d20001a1397d3ef28cc8717f156ae8ec" alt="image">  </p>
<h2 id="解决办法一"><a href="#解决办法一" class="headerlink" title="解决办法一"></a>解决办法一</h2><p>使用jinja2的Comments，注释掉那些特殊字符，语法：“”，参考：<a href="http://jinja.pocoo.org/docs/2.9/templates/#comments" target="_blank" rel="external">http://jinja.pocoo.org/docs/2.9/templates/#comments</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sed -i <span class="string">'/^;/s/^;/&#123;#;/g'</span> www.conf.j2</div><div class="line">sed -i <span class="string">'/^&#123;#/s/$/#&#125;/g'</span> www.conf.j2</div></pre></td></tr></table></figure></p>
<p>Jinja2分隔符配置如下：<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;% ... %&#125; for Statements</div><div class="line">&#123;&#123; ... &#125;&#125; for Expressions</div><div class="line">&#123;# ... #&#125; for Comments</div><div class="line"># ... ## for Line Statements</div></pre></td></tr></table></figure></p>
<p>参考：<br><a href="http://jinja.pocoo.org/docs/2.9/templates/#list-of-control-structures" target="_blank" rel="external">Statements</a><br><a href="http://jinja.pocoo.org/docs/2.9/templates/#expressions" target="_blank" rel="external">Expressions</a> to print to the template output<br><a href="http://jinja.pocoo.org/docs/2.9/templates/#comments" target="_blank" rel="external">Comments</a> not included in the template output<br><a href="http://jinja.pocoo.org/docs/2.9/templates/#line-statements" target="_blank" rel="external">Line Statements</a></p>
<p>效果图：<br><img src="http://note.youdao.com/yws/api/personal/file/51BAF10EBF3D4355943E9ACFECA5B9F8?method=download&amp;shareKey=32d4520faea8ab17a302998120552bc6" alt="image"><br><img src="http://note.youdao.com/yws/api/personal/file/C2B5E663959A44B5AB4320C4E8172D73?method=download&amp;shareKey=6d22de4ba9bfab8692c051448501ea71" alt="image">  </p>
<h2 id="解决办法二"><a href="#解决办法二" class="headerlink" title="解决办法二"></a>解决办法二</h2><p>使用jinja2的Escaping，把这些特殊字符转义，语法：“ ... ”，参考：<a href="http://jinja.pocoo.org/docs/2.9/templates/#escaping" target="_blank" rel="external">http://jinja.pocoo.org/docs/2.9/templates/#escaping</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sed -i <span class="string">'/^;/s/^;/&#123;% raw %&#125;;/g'</span> www.conf.j2</div><div class="line">sed -i <span class="string">'/^&#123;% raw %&#125;/s/$/&#123;% endraw %&#125;\n/g'</span> www.conf.j2</div></pre></td></tr></table></figure></p>
<p>Jinja2转义符：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">#被raw包含起来的部分被转义，不会被解析</div><div class="line">&#123;% raw %&#125;</div><div class="line">;aaa</div><div class="line">#bbb</div><div class="line">&#123;% endraw %&#125;</div></pre></td></tr></table></figure></p>
<p>效果图：<br><img src="http://note.youdao.com/yws/api/personal/file/126EB155FA6449EDB258833E0F27D85C?method=download&amp;shareKey=220f4e2a393cb1b04dbade233e0e26ad" alt="image"><br><img src="http://note.youdao.com/yws/api/personal/file/B452A096237B456387B5B6FFF734C3BB?method=download&amp;shareKey=b997881e55fa03ad69d78ea8df53a5c8" alt="image">  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="https://yfshare.github.io">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="https://yfshare.github.io/2017/03/16/Ansible">https://yfshare.github.io/2017/03/16/Ansible</a> Template处理含特殊字符的文件/</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Ansible Template模块推送文件时，当遇到含有特殊字符的配置文件，如：”;” “#”等，如果不加处理，在执行Ansible-playbooks时会报错，因为这些模块不能被正确解析，如下图所示：&lt;br&gt;
    
    </summary>
    
      <category term="Ansible" scheme="https://yfshare.github.io/categories/Ansible/"/>
    
    
      <category term="ansible" scheme="https://yfshare.github.io/tags/ansible/"/>
    
      <category term="Template" scheme="https://yfshare.github.io/tags/Template/"/>
    
  </entry>
  
  <entry>
    <title>Ansible-Playbooks之安装PHP</title>
    <link href="https://yfshare.github.io/2017/03/15/Ansible-Playbooks%E4%B9%8B%E5%AE%89%E8%A3%85PHP/"/>
    <id>https://yfshare.github.io/2017/03/15/Ansible-Playbooks之安装PHP/</id>
    <published>2017-03-15T10:32:55.000Z</published>
    <updated>2017-03-20T07:02:06.000Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>playbooks 是一种简单的配置管理系统与多机器部署系统的基础。与现有的其他系统有不同之处,且非常适合于复杂应用的批量部署<br>Playbooks 的格式是YAML，语法做到最小化  </p>
<p>这里讲述的是使用ansible-playbooks的roles安装PHP应用<br><a id="more"></a></p>
<h2 id="结构目录"><a href="#结构目录" class="headerlink" title="结构目录"></a>结构目录</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#目录结构</span></div><div class="line">[root@Ansible ~]<span class="comment"># tree /etc/ansible/</span></div><div class="line">/etc/ansible/</div><div class="line">├── ansible.cfg</div><div class="line">├── hosts</div><div class="line">├── roles</div><div class="line">│   └── yum_php</div><div class="line">│       ├── files</div><div class="line">│       │   └── yum.repo</div><div class="line">│       ├── handlers</div><div class="line">│       │   └── main.yml</div><div class="line">│       ├── tasks</div><div class="line">│       │   └── main.yml</div><div class="line">│       ├── templates</div><div class="line">│       │   └── www.conf.j2</div><div class="line">│       └── vars</div><div class="line">│           └── main.yml</div><div class="line">└── site.yml</div><div class="line"></div><div class="line">7 directories, 8 files</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h2 id="Ansible之Yum安装PHP"><a href="#Ansible之Yum安装PHP" class="headerlink" title="Ansible之Yum安装PHP"></a>Ansible之Yum安装PHP</h2><p>环境：<br>　　　ansible 2.2.1.0<br>　　　Centos 6.6<br>　　　PHP 7.0.16 (fpm-fcgi) (built: Feb 18 2017 10:46:38)  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#入口文件</span></div><div class="line">[root@Ansible ~]<span class="comment"># cd /etc/ansible/</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat site.yml </span></div><div class="line">- hosts: test_hosts</div><div class="line">  user: root</div><div class="line">  roles:</div><div class="line">    - yum_php</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#tasks</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat roles/yum_php/tasks/main.yml </span></div><div class="line">- name: Install libselinux-python package</div><div class="line">  yum: name=libselinux-python state=installed</div><div class="line"></div><div class="line">- name: Check whether yum.repo file exist</div><div class="line">  shell: ls /etc/yum.repos.d/yum.repo</div><div class="line">  register: result</div><div class="line">  ignore_errors: True</div><div class="line">- name: Copy yum.repo file</div><div class="line">  copy: src=yum.repo dest=/etc/yum.repos.d/ mode=0644 owner=root group=root</div><div class="line">  when: result|failed</div><div class="line">- name: Rebuild the yum cache</div><div class="line">  shell: yum clean all &amp;&amp; yum makecache</div><div class="line">  when: result|failed</div><div class="line"></div><div class="line">- name: Check whether nginx users exist</div><div class="line">  shell: id nginx</div><div class="line">  register: result</div><div class="line">  ignore_errors: True</div><div class="line">- name: The nginx user does not exist, so we need to create it.[The nginx user<span class="string">'s password is 123456]</span></div><div class="line">  user: name=nginx createhome=yes home=/home/nginx shell=/bin/bash password="$1$K28XAyId$YUKHvYzbbO9C8RkzGIzNo1" state=present</div><div class="line">  when: result|failed</div><div class="line"></div><div class="line">- name: Install PHP packages</div><div class="line">  yum: name=&#123;&#123;item.name&#125;&#125; state=&#123;&#123;item.state|default("installed")&#125;&#125;</div><div class="line">  with_items:</div><div class="line">    - name: "php*"</div><div class="line">      state: "absent"</div><div class="line">    - name: "php70w"</div><div class="line">    - name: "php70w-gd"</div><div class="line">    - name: "libjpeg*"</div><div class="line">    - name: "php70w-imap"</div><div class="line">    - name: "php70w-ldap"</div><div class="line">    - name: "php70w-odbc"</div><div class="line">    - name: "php70w-pear"</div><div class="line">    - name: "php70w-xml"</div><div class="line">    - name: "php70w-xmlrpc"</div><div class="line">    - name: "php70w-mbstring"</div><div class="line">    - name: "php70w-mcrypt"</div><div class="line">    - name: "php70w-bcmath"</div><div class="line">    - name: "libmcrypt"</div><div class="line">    - name: "libmcrypt-devel"</div><div class="line">    - name: "php70w-fpm"</div><div class="line">    - name: "php70w-cli"</div><div class="line">    - name: "php70w-pdo"</div><div class="line">    - name: "php70w-tidy"</div><div class="line">    - name: "php70w-mysql"</div><div class="line">- name: Configure PHP</div><div class="line">  template: src="templates/www.conf.j2" dest="/etc/php-fpm.d/www.conf" owner=root group=root mode=0644</div><div class="line">- name: Modify file permissions</div><div class="line">  file: path="&#123;&#123;item.path&#125;&#125;" state="&#123;&#123;item.state|default("directory")&#125;&#125;" owner=&#123;&#123;php_user&#125;&#125; group=&#123;&#123;php_group&#125;&#125;</div><div class="line">  with_items:</div><div class="line">    - path: "/etc/httpd/conf.d/php.conf"</div><div class="line">      state: "file"</div><div class="line">    - path: "/var/lib/php/session"</div><div class="line">    - path: "/var/lib/php/wsdlcache"</div><div class="line">  notify: restart php-fpm</div><div class="line">[root@Ansible ansible]#</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#handlers</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat roles/yum_php/handlers/main.yml </span></div><div class="line">- name: restart php-fpm</div><div class="line">  service: name=<span class="string">"php-fpm"</span> state=restarted enabled=yes</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#执行结果</span></div><div class="line">root@Ansible ~]<span class="comment"># ansible-playbook /etc/ansible/site.yml </span></div><div class="line"></div><div class="line">PLAY [test_hosts] **************************************************************</div><div class="line"></div><div class="line">TASK [setup] *******************************************************************</div><div class="line">ok: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_php : Install libselinux-python package] *****************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_php : Check whether yum.repo file exist] *****************************</div><div class="line">fatal: [192.168.31.110]: FAILED! =&gt; &#123;<span class="string">"changed"</span>: <span class="literal">true</span>, <span class="string">"cmd"</span>: <span class="string">"ls /etc/yum.repos.d/yum.repo"</span>, <span class="string">"delta"</span>: <span class="string">"0:00:00.004034"</span>, <span class="string">"end"</span>: <span class="string">"2017-03-20 10:01:53.732814"</span>, <span class="string">"failed"</span>: <span class="literal">true</span>, <span class="string">"rc"</span>: 2, <span class="string">"start"</span>: <span class="string">"2017-03-20 10:01:53.728780"</span>, <span class="string">"stderr"</span>: <span class="string">"ls: cannot access /etc/yum.repos.d/yum.repo: No such file or directory"</span>, <span class="string">"stdout"</span>: <span class="string">""</span>, <span class="string">"stdout_lines"</span>: [], <span class="string">"warnings"</span>: []&#125;</div><div class="line">...ignoring</div><div class="line"></div><div class="line">TASK [yum_php : Copy yum.repo file] ********************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_php : Rebuild the yum cache] *****************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"> [WARNING]: Consider using yum module rather than running yum</div><div class="line"></div><div class="line"></div><div class="line">TASK [yum_php : Check whether nginx users exist] *******************************</div><div class="line">fatal: [192.168.31.110]: FAILED! =&gt; &#123;<span class="string">"changed"</span>: <span class="literal">true</span>, <span class="string">"cmd"</span>: <span class="string">"id nginx"</span>, <span class="string">"delta"</span>: <span class="string">"0:00:00.004049"</span>, <span class="string">"end"</span>: <span class="string">"2017-03-20 10:06:02.226964"</span>, <span class="string">"failed"</span>: <span class="literal">true</span>, <span class="string">"rc"</span>: 1, <span class="string">"start"</span>: <span class="string">"2017-03-20 10:06:02.222915"</span>, <span class="string">"stderr"</span>: <span class="string">"id: nginx: No such user"</span>, <span class="string">"stdout"</span>: <span class="string">""</span>, <span class="string">"stdout_lines"</span>: [], <span class="string">"warnings"</span>: []&#125;</div><div class="line">...ignoring</div><div class="line"></div><div class="line">TASK [yum_php : The nginx user does not exist, so we need to create it.[The nginx user<span class="string">'s password is 123456]] ***</span></div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_php : Install PHP packages] ******************************************</div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'state<span class="string">': u'</span>absent<span class="string">', u'</span>name<span class="string">': u'</span>php*<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-gd<span class="string">'&#125;)</span></div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>libjpeg*<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-imap<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-ldap<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-odbc<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-pear<span class="string">'&#125;)</span></div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-xml<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-xmlrpc<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-mbstring<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-mcrypt<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-bcmath<span class="string">'&#125;)</span></div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>libmcrypt<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>libmcrypt-devel<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-fpm<span class="string">'&#125;)</span></div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-cli<span class="string">'&#125;)</span></div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-pdo<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-tidy<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'name<span class="string">': u'</span>php70w-mysql<span class="string">'&#125;)</span></div><div class="line"></div><div class="line">TASK [yum_php : Configure PHP] *************************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_php : Modify file permissions] ***************************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'path<span class="string">': u'</span>/etc/httpd/conf.d/php.conf<span class="string">', u'</span>state<span class="string">': u'</span>file<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'path<span class="string">': u'</span>/var/lib/php/session<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'path<span class="string">': u'</span>/var/lib/php/wsdlcache<span class="string">'&#125;)</span></div><div class="line"></div><div class="line">RUNNING HANDLER [yum_php : restart php-fpm] ************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">PLAY RECAP *********************************************************************</div><div class="line">192.168.31.110             : ok=11   changed=10   unreachable=0    failed=0   </div><div class="line">[root@Ansible ~]#</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m shell -a 'netstat -tunlp | grep 9000'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">tcp        0      0 127.0.0.1:9000              0.0.0.0:*                   LISTEN      2197/php-fpm        </div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -m shell -a 'ps -ef | grep php-fpm | grep -v grep'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">root       2197      1  0 17:22 ?        00:00:00 php-fpm: master process (/etc/php-fpm.conf)</div><div class="line">nginx      2198   2197  0 17:22 ?        00:00:00 php-fpm: pool www            </div><div class="line">nginx      2199   2197  0 17:22 ?        00:00:00 php-fpm: pool www            </div><div class="line">nginx      2200   2197  0 17:22 ?        00:00:00 php-fpm: pool www            </div><div class="line">nginx      2201   2197  0 17:22 ?        00:00:00 php-fpm: pool www            </div><div class="line">nginx      2203   2197  0 17:22 ?        00:00:00 php-fpm: pool www            </div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p><img src="http://note.youdao.com/yws/api/personal/file/88454320448641189B9E3A30BEC4302D?method=download&amp;shareKey=7eb73e965ae38963c70873cf17a2cadd" alt="image">  </p>
<h2 id="Template遇到特殊字符处理"><a href="#Template遇到特殊字符处理" class="headerlink" title="Template遇到特殊字符处理"></a>Template遇到特殊字符处理</h2><p>注：如果推送的配置文件里含有特殊字符，如：”;” “#”等，是不能用Template模块直接推送的，因为这些不能被解析会报错，如下：<br><img src="http://note.youdao.com/yws/api/personal/file/28574AC5961C438A82BD5C9D5F0DEA6F?method=download&amp;shareKey=d20001a1397d3ef28cc8717f156ae8ec" alt="image">  </p>
<h2 id="解决办法一"><a href="#解决办法一" class="headerlink" title="解决办法一"></a>解决办法一</h2><p>使用jinja2的Comments，注释掉那些特殊字符，语法：“”，参考：<a href="http://jinja.pocoo.org/docs/2.9/templates/#comments" target="_blank" rel="external">http://jinja.pocoo.org/docs/2.9/templates/#comments</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sed -i <span class="string">'/^;/s/^;/&#123;#;/g'</span> www.conf.j2</div><div class="line">sed -i <span class="string">'/^&#123;#/s/$/#&#125;/g'</span> www.conf.j2</div></pre></td></tr></table></figure></p>
<p>Jinja2分隔符配置如下：<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;% ... %&#125; for Statements</div><div class="line">&#123;&#123; ... &#125;&#125; for Expressions</div><div class="line">&#123;# ... #&#125; for Comments</div><div class="line"># ... ## for Line Statements</div></pre></td></tr></table></figure></p>
<p>参考：<br><a href="http://jinja.pocoo.org/docs/2.9/templates/#list-of-control-structures" target="_blank" rel="external">Statements</a><br><a href="http://jinja.pocoo.org/docs/2.9/templates/#expressions" target="_blank" rel="external">Expressions</a> to print to the template output<br><a href="http://jinja.pocoo.org/docs/2.9/templates/#comments" target="_blank" rel="external">Comments</a> not included in the template output<br><a href="http://jinja.pocoo.org/docs/2.9/templates/#line-statements" target="_blank" rel="external">Line Statements</a></p>
<p>效果图：<br><img src="http://note.youdao.com/yws/api/personal/file/51BAF10EBF3D4355943E9ACFECA5B9F8?method=download&amp;shareKey=32d4520faea8ab17a302998120552bc6" alt="image"><br><img src="http://note.youdao.com/yws/api/personal/file/C2B5E663959A44B5AB4320C4E8172D73?method=download&amp;shareKey=6d22de4ba9bfab8692c051448501ea71" alt="image">  </p>
<h2 id="解决办法二"><a href="#解决办法二" class="headerlink" title="解决办法二"></a>解决办法二</h2><p>使用jinja2的Escaping，把这些特殊字符转义，语法：“ ... ”，参考：<a href="http://jinja.pocoo.org/docs/2.9/templates/#escaping" target="_blank" rel="external">http://jinja.pocoo.org/docs/2.9/templates/#escaping</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sed -i <span class="string">'/^;/s/^;/&#123;% raw %&#125;;/g'</span> www.conf.j2</div><div class="line">sed -i <span class="string">'/^&#123;% raw %&#125;/s/$/&#123;% endraw %&#125;\n/g'</span> www.conf.j2</div></pre></td></tr></table></figure></p>
<p>Jinja2转义符：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">#被raw包含起来的部分被转义，不会被解析</div><div class="line">&#123;% raw %&#125;</div><div class="line">;aaa</div><div class="line">#bbb</div><div class="line">&#123;% endraw %&#125;</div></pre></td></tr></table></figure></p>
<p>效果图：<br><img src="http://note.youdao.com/yws/api/personal/file/126EB155FA6449EDB258833E0F27D85C?method=download&amp;shareKey=220f4e2a393cb1b04dbade233e0e26ad" alt="image"><br><img src="http://note.youdao.com/yws/api/personal/file/B452A096237B456387B5B6FFF734C3BB?method=download&amp;shareKey=b997881e55fa03ad69d78ea8df53a5c8" alt="image">  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/8A2FEEE468F34A9CB9F450053DDFD6D6?method=download&amp;shareKey=b18545e048a05feac1536a89b7b897a8" alt="image"></p>
<p>附件：<a href="http://note.youdao.com/yws/api/personal/file/2AD3956E5411473FA5564F584B6B4D30?method=download&amp;shareKey=1c3b772f10c30b6894f116d843676f39" target="_blank" rel="external">ansible_yum_install_php.tar.gz</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="https://yfshare.github.io">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="https://yfshare.github.io/2017/03/15/Ansible-Playbooks之安装PHP/">https://yfshare.github.io/2017/03/15/Ansible-Playbooks之安装PHP/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;playbooks 是一种简单的配置管理系统与多机器部署系统的基础。与现有的其他系统有不同之处,且非常适合于复杂应用的批量部署&lt;br&gt;Playbooks 的格式是YAML，语法做到最小化  &lt;/p&gt;
&lt;p&gt;这里讲述的是使用ansible-playbooks的roles安装PHP应用&lt;br&gt;
    
    </summary>
    
      <category term="Ansible" scheme="https://yfshare.github.io/categories/Ansible/"/>
    
    
      <category term="ansible" scheme="https://yfshare.github.io/tags/ansible/"/>
    
      <category term="php" scheme="https://yfshare.github.io/tags/php/"/>
    
  </entry>
  
  <entry>
    <title>Ansible-Playbooks之安装Nginx</title>
    <link href="https://yfshare.github.io/2017/03/11/Ansible-Playbooks%E4%B9%8B%E5%AE%89%E8%A3%85Nginx/"/>
    <id>https://yfshare.github.io/2017/03/11/Ansible-Playbooks之安装Nginx/</id>
    <published>2017-03-11T15:17:41.000Z</published>
    <updated>2017-03-27T15:24:15.000Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>playbooks 是一种简单的配置管理系统与多机器部署系统的基础。与现有的其他系统有不同之处,且非常适合于复杂应用的批量部署<br>Playbooks 的格式是YAML，语法做到最小化  </p>
<p>这里讲述的是使用ansible-playbooks的roles安装Nginx应用<br><a id="more"></a></p>
<h2 id="结构目录"><a href="#结构目录" class="headerlink" title="结构目录"></a>结构目录</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#结构目录</span></div><div class="line">[root@Ansible ansible]<span class="comment"># tree /etc/ansible/</span></div><div class="line">/etc/ansible/</div><div class="line">├── ansible.cfg</div><div class="line">├── hosts</div><div class="line">├── roles</div><div class="line">│   ├── source_nginx</div><div class="line">│   │   ├── files</div><div class="line">│   │   │   ├── <span class="built_in">echo</span>-nginx-module-0.59.tar.gz</div><div class="line">│   │   │   ├── gperftools-2.0.zip</div><div class="line">│   │   │   ├── nginx-1.11.7.tar.gz</div><div class="line">│   │   │   ├── nginx_tcp_proxy_module_nginx1.11.7.zip</div><div class="line">│   │   │   ├── nginx-upstream-jvm-route-nginx1.11.7.zip</div><div class="line">│   │   │   ├── ngx_cache_purge-2.3.tar.gz</div><div class="line">│   │   │   ├── openssl-1.1.0e.tar.gz</div><div class="line">│   │   │   ├── pcre-8.40.zip</div><div class="line">│   │   │   ├── yum.repo</div><div class="line">│   │   │   └── zlib-1.2.11.tar.gz</div><div class="line">│   │   ├── handlers</div><div class="line">│   │   │   └── main.yml</div><div class="line">│   │   ├── tasks</div><div class="line">│   │   │   └── main.yml</div><div class="line">│   │   ├── templates</div><div class="line">│   │   │   ├── comm.conf.j2</div><div class="line">│   │   │   ├── etc_init.d_nginx.txt</div><div class="line">│   │   │   ├── fastcgi.conf.j2</div><div class="line">│   │   │   ├── nginx.conf.j2</div><div class="line">│   │   │   ├── proxy.conf.j2</div><div class="line">│   │   │   └── static.conf.j2</div><div class="line">│   │   └── vars</div><div class="line">│   │       └── main.yml</div><div class="line">│   └── yum_nginx</div><div class="line">│       ├── files</div><div class="line">│       │   ├── comm.conf.j2</div><div class="line">│       │   ├── fastcgi.conf.j2</div><div class="line">│       │   ├── nginx.conf.j2</div><div class="line">│       │   ├── proxy.conf.j2</div><div class="line">│       │   ├── static.conf.j2</div><div class="line">│       │   └── yum.repo</div><div class="line">│       ├── handlers</div><div class="line">│       │   └── main.yml</div><div class="line">│       ├── tasks</div><div class="line">│       │   └── main.yml</div><div class="line">│       ├── templates</div><div class="line">│       └── vars</div><div class="line">│           └── main.yml</div><div class="line">└── site.yml</div><div class="line"></div><div class="line">13 directories, 31 files</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h2 id="Ansible之Yum安装Nginx"><a href="#Ansible之Yum安装Nginx" class="headerlink" title="Ansible之Yum安装Nginx"></a>Ansible之Yum安装Nginx</h2><p>环境：<br>　　　ansible 2.2.1.0<br>　　　Centos 6.6<br>　　　Nginx 1.11.7<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#结构目录</span></div><div class="line">[root@Ansible ansible]<span class="comment"># tree roles/yum_nginx/</span></div><div class="line">roles/yum_nginx/</div><div class="line">├── files</div><div class="line">│   ├── comm.conf.j2</div><div class="line">│   ├── fastcgi.conf.j2</div><div class="line">│   ├── nginx.conf.j2</div><div class="line">│   ├── proxy.conf.j2</div><div class="line">│   ├── static.conf.j2</div><div class="line">│   └── yum.repo</div><div class="line">├── handlers</div><div class="line">│   └── main.yml</div><div class="line">├── tasks</div><div class="line">│   └── main.yml</div><div class="line">├── templates</div><div class="line">└── vars</div><div class="line">    └── main.yml</div><div class="line"></div><div class="line">5 directories, 9 files</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#入口文件</span></div><div class="line">[root@Ansible ~]<span class="comment"># cd /etc/ansible/</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat site.yml </span></div><div class="line">- hosts: test_hosts</div><div class="line">  user: root</div><div class="line">  roles:</div><div class="line">    - yum_nginx</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#变量</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat roles/yum_nginx/vars/main.yml</span></div><div class="line">error_log_path: /var/<span class="built_in">log</span>/nginx/error.log</div><div class="line">error_log_level: warn</div><div class="line">access_log_path: /var/<span class="built_in">log</span>/nginx/access.log</div><div class="line">nginx_pid_path: /var/run/nginx.pid</div><div class="line">worker_connections_size: 10240</div><div class="line">keys_zone: one_cache</div><div class="line">keys_zone_size: 1024m</div><div class="line">inactive_day: 1d</div><div class="line">max_size: 10g</div><div class="line"></div><div class="line">proxy_cache_path: /var/proxy_cache</div><div class="line">nginx_log_path: /var/<span class="built_in">log</span>/nginx</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#tasks文件</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat roles/yum_nginx/tasks/main.yml </span></div><div class="line">- name: disabled iptables</div><div class="line">  service: name=iptables state=stopped</div><div class="line">- name: Set the selinux value to Permissive</div><div class="line">  shell: setenforce 0</div><div class="line"></div><div class="line">- name: Install libselinux-python package</div><div class="line">  yum: name=libselinux-python state=installed</div><div class="line"></div><div class="line">- name: Check whether yum.repo file exist</div><div class="line">  shell: ls /etc/yum.repos.d/yum.repo</div><div class="line">  register: result</div><div class="line">  ignore_errors: True</div><div class="line">- name: Copy yum.repo file</div><div class="line">  copy: src=yum.repo dest=/etc/yum.repos.d/ mode=0644 owner=root group=root</div><div class="line">  when: result|failed</div><div class="line">- name: Rebuild the yum cache</div><div class="line">  shell: yum clean all &amp;&amp; yum makecache</div><div class="line">  when: result|failed</div><div class="line"></div><div class="line">- name: Install nginx package</div><div class="line">  yum: name=nginx state=&#123;&#123;item.state&#125;&#125;</div><div class="line">  with_items:</div><div class="line">    - state: <span class="string">"absent"</span></div><div class="line">    - state: <span class="string">"installed"</span></div><div class="line">- name: <span class="built_in">set</span> nginx parameter</div><div class="line">  set_fact: worker_processes=<span class="string">"&#123;&#123;ansible_processor_cores&#125;&#125;"</span></div><div class="line"></div><div class="line">- name: Configure some files</div><div class="line">  template: src=&#123;&#123;item.src&#125;&#125; dest=&#123;&#123;item.dest&#125;&#125; owner=nginx group=nginx mode=0644</div><div class="line">  with_items:</div><div class="line">    - src: <span class="string">"files/nginx.conf.j2"</span></div><div class="line">      dest: <span class="string">"/etc/nginx/nginx.conf"</span></div><div class="line">    - src: <span class="string">"files/proxy.conf.j2"</span></div><div class="line">      dest: <span class="string">"/etc/nginx/conf.d/proxy.conf"</span></div><div class="line">    - src: <span class="string">"files/comm.conf.j2"</span></div><div class="line">      dest: <span class="string">"/etc/nginx/conf.d/comm.conf"</span></div><div class="line">    - src: <span class="string">"files/static.conf.j2"</span></div><div class="line">      dest: <span class="string">"/etc/nginx/conf.d/static.conf"</span></div><div class="line">    - src: <span class="string">"files/fastcgi.conf.j2"</span></div><div class="line">      dest: <span class="string">"/etc/nginx/conf.d/fastcgi.conf"</span></div><div class="line"></div><div class="line">- name: Create some directory</div><div class="line">  file: path=&#123;&#123;item.path&#125;&#125; state=directory owner=nginx group=nginx mode=0755</div><div class="line">  with_items:</div><div class="line">    - path: <span class="string">"&#123;&#123;proxy_cache_path&#125;&#125;/temp"</span></div><div class="line">    - path: <span class="string">"&#123;&#123;proxy_cache_path&#125;&#125;/cache"</span></div><div class="line">    - path: <span class="string">"&#123;&#123;nginx_log_path&#125;&#125;"</span></div><div class="line">  notify: restart nginx</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#handlers</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat roles/yum_nginx/handlers/main.yml </span></div><div class="line">- name: restart nginx</div><div class="line">  service: name=nginx state=restarted enabled=yes</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#files文件</span></div><div class="line">[root@Ansible ansible]<span class="comment"># ls roles/yum_nginx/files/</span></div><div class="line">comm.conf.j2  fastcgi.conf.j2  nginx.conf.j2  proxy.conf.j2  static.conf.j2  yum.repo</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#执行结果</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible-playbook /etc/ansible/site.yml </span></div><div class="line"></div><div class="line">PLAY [test_hosts] **************************************************************</div><div class="line"></div><div class="line">TASK [setup] *******************************************************************</div><div class="line">ok: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_nginx : disabled iptables] *******************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_nginx : Set the selinux value to Permissive] *************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_nginx : Install libselinux-python package] ***************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_nginx : Check whether yum.repo file exist] ***************************</div><div class="line">fatal: [192.168.31.110]: FAILED! =&gt; &#123;<span class="string">"changed"</span>: <span class="literal">true</span>, <span class="string">"cmd"</span>: <span class="string">"ls /etc/yum.repos.d/yum.repo"</span>, <span class="string">"delta"</span>: <span class="string">"0:00:00.004099"</span>, <span class="string">"end"</span>: <span class="string">"2017-03-19 20:49:37.832598"</span>, <span class="string">"failed"</span>: <span class="literal">true</span>, <span class="string">"rc"</span>: 2, <span class="string">"start"</span>: <span class="string">"2017-03-19 20:49:37.828499"</span>, <span class="string">"stderr"</span>: <span class="string">"ls: cannot access /etc/yum.repos.d/yum.repo: No such file or directory"</span>, <span class="string">"stdout"</span>: <span class="string">""</span>, <span class="string">"stdout_lines"</span>: [], <span class="string">"warnings"</span>: []&#125;</div><div class="line">...ignoring</div><div class="line"></div><div class="line">TASK [yum_nginx : Copy yum.repo file] ******************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_nginx : Rebuild the yum cache] ***************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"> [WARNING]: Consider using yum module rather than running yum</div><div class="line"></div><div class="line"></div><div class="line">TASK [yum_nginx : Install nginx package] ***************************************</div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'state'</span>: u<span class="string">'absent'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'state'</span>: u<span class="string">'installed'</span>&#125;)</div><div class="line"></div><div class="line">TASK [yum_nginx : <span class="built_in">set</span> nginx parameter] *****************************************</div><div class="line">ok: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [yum_nginx : Configure some files] ****************************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/etc/nginx/nginx.conf'</span>, u<span class="string">'src'</span>: u<span class="string">'files/nginx.conf.j2'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/etc/nginx/conf.d/proxy.conf'</span>, u<span class="string">'src'</span>: u<span class="string">'files/proxy.conf.j2'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/etc/nginx/conf.d/comm.conf'</span>, u<span class="string">'src'</span>: u<span class="string">'files/comm.conf.j2'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/etc/nginx/conf.d/static.conf'</span>, u<span class="string">'src'</span>: u<span class="string">'files/static.conf.j2'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'dest'</span>: u<span class="string">'/etc/nginx/conf.d/fastcgi.conf'</span>, u<span class="string">'src'</span>: u<span class="string">'files/fastcgi.conf.j2'</span>&#125;)</div><div class="line"></div><div class="line">TASK [yum_nginx : Create some directory] ***************************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'path'</span>: u<span class="string">'/var/proxy_cache/temp'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'path'</span>: u<span class="string">'/var/proxy_cache/cache'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'path'</span>: u<span class="string">'/var/log/nginx'</span>&#125;)</div><div class="line"></div><div class="line">RUNNING HANDLER [yum_nginx : restart nginx] ************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">PLAY RECAP *********************************************************************</div><div class="line">192.168.31.110             : ok=12   changed=10   unreachable=0    failed=0   </div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p><img src="http://note.youdao.com/yws/api/personal/file/F9627F7DD8B043BD975D98B4BC5C20CE?method=download&amp;shareKey=55ec04d11f44dafc5cc94f172fa98c6a" alt="image"><br><img src="http://note.youdao.com/yws/api/personal/file/994FFC90CD3947DE8ED1E8BF19428A63?method=download&amp;shareKey=7e2c02f801b5e0f73c8054dfddbb8474" alt="image">  </p>
<h2 id="Ansible之源码安装Nginx"><a href="#Ansible之源码安装Nginx" class="headerlink" title="Ansible之源码安装Nginx"></a>Ansible之源码安装Nginx</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#结构目录</span></div><div class="line">[root@Ansible ansible]<span class="comment"># tree roles/source_nginx/</span></div><div class="line">roles/source_nginx/</div><div class="line">├── files</div><div class="line">│   ├── <span class="built_in">echo</span>-nginx-module-0.59.tar.gz</div><div class="line">│   ├── gperftools-2.0.zip</div><div class="line">│   ├── nginx-1.11.7.tar.gz</div><div class="line">│   ├── nginx_tcp_proxy_module_nginx1.11.7.zip</div><div class="line">│   ├── nginx-upstream-jvm-route-nginx1.11.7.zip</div><div class="line">│   ├── ngx_cache_purge-2.3.tar.gz</div><div class="line">│   ├── openssl-1.1.0e.tar.gz</div><div class="line">│   ├── pcre-8.40.zip</div><div class="line">│   ├── yum.repo</div><div class="line">│   └── zlib-1.2.11.tar.gz</div><div class="line">├── handlers</div><div class="line">│   └── main.yml</div><div class="line">├── tasks</div><div class="line">│   └── main.yml</div><div class="line">├── templates</div><div class="line">│   ├── comm.conf.j2</div><div class="line">│   ├── etc_init.d_nginx.txt</div><div class="line">│   ├── fastcgi.conf.j2</div><div class="line">│   ├── nginx.conf.j2</div><div class="line">│   ├── proxy.conf.j2</div><div class="line">│   └── static.conf.j2</div><div class="line">└── vars</div><div class="line">    └── main.yml</div><div class="line"></div><div class="line">5 directories, 19 files</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#变量</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat roles/source_nginx/vars/main.yml </span></div><div class="line">nginx_path: /usr/<span class="built_in">local</span>/nginx-1.11.7/sbin/nginx</div><div class="line">nginx_conf_file: /usr/<span class="built_in">local</span>/nginx-1.11.7/conf/nginx.conf</div><div class="line">nginx_conf_dir: /usr/<span class="built_in">local</span>/nginx-1.11.7/conf</div><div class="line"></div><div class="line">error_log_path: /var/<span class="built_in">log</span>/nginx/error.log</div><div class="line">error_log_level: warn</div><div class="line">access_log_path: /var/<span class="built_in">log</span>/nginx/access.log</div><div class="line">nginx_pid_path: /var/run/nginx.pid</div><div class="line">worker_connections_size: 1024</div><div class="line">google_perftools_path: /var/tmp/nginx_profile</div><div class="line">proxy_temp_path: /var/proxy_cache/temp</div><div class="line">proxy_cache_path: /var/proxy_cache/cache</div><div class="line">keys_zone: one_cache</div><div class="line">keys_zone_size: 1024m</div><div class="line">inactive_day: 1d</div><div class="line">max_size: 10g</div><div class="line"></div><div class="line">rewrite_path: http://www.qq.com</div><div class="line">access_zabbix_log_path: /var/<span class="built_in">log</span>/zabbix/access.log</div><div class="line">error_zabbix_log_path: /var/<span class="built_in">log</span>/zabbix/error.log</div><div class="line"></div><div class="line">remote_download_path: /tmp/download</div><div class="line">nginx_install_path: /usr/<span class="built_in">local</span>/nginx-1.11.7</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#tasks</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat roles/source_nginx/tasks/main.yml</span></div><div class="line">- name: disabled iptables</div><div class="line">  shell: /etc/init.d/iptables stop</div><div class="line">- name: Set the selinux value to Permissive</div><div class="line">  shell: setenforce 0</div><div class="line"></div><div class="line">- name: Create download directory</div><div class="line">  file: path=&#123;&#123;remote_download_path&#125;&#125; mode=0755 state=directory</div><div class="line">- name: Install the some tools</div><div class="line">  yum: name=&#123;&#123;item.name&#125;&#125; state=installed</div><div class="line">  with_items:</div><div class="line">    - name: unzip</div><div class="line">    - name: zip</div><div class="line">    - name: tar</div><div class="line">    - name: libselinux-python</div><div class="line"></div><div class="line">- name: download some <span class="built_in">source</span> packages</div><div class="line">  get_url: url=&#123;&#123;item.url&#125;&#125; dest=&#123;&#123;remote_download_path&#125;&#125; validate_certs=&#123;&#123;item.validate_certs|default(<span class="string">"yes"</span>)&#125;&#125;</div><div class="line">  with_items:</div><div class="line">    - url: <span class="string">"https://ftp.pcre.org/pub/pcre/pcre-8.40.zip"</span></div><div class="line">      validate_certs: <span class="string">"no"</span></div><div class="line">    - url: <span class="string">"http://nginx.org/download/nginx-1.11.7.tar.gz"</span></div><div class="line"></div><div class="line">- name: unarchive some <span class="built_in">source</span> packages</div><div class="line">  unarchive: src=&#123;&#123;item.src&#125;&#125; dest=&#123;&#123;remote_download_path&#125;&#125; remote_src=&#123;&#123;item.remote_src|default(<span class="string">"no"</span>)&#125;&#125;</div><div class="line">  with_items: </div><div class="line">    - src: <span class="string">"&#123;&#123;remote_download_path&#125;&#125;/nginx-1.11.7.tar.gz"</span></div><div class="line">      remote_src: <span class="string">"yes"</span></div><div class="line">    - src: <span class="string">"&#123;&#123;remote_download_path&#125;&#125;/pcre-8.40.zip"</span></div><div class="line">      remote_src: <span class="string">"yes"</span></div><div class="line">    - src: <span class="string">"files/zlib-1.2.11.tar.gz"</span></div><div class="line">    - src: <span class="string">"files/openssl-1.1.0e.tar.gz"</span></div><div class="line">    - src: <span class="string">"files/gperftools-2.0.zip"</span></div><div class="line">    - src: <span class="string">"files/echo-nginx-module-0.59.tar.gz"</span></div><div class="line">    - src: <span class="string">"files/nginx-upstream-jvm-route-nginx1.11.7.zip"</span></div><div class="line">    - src: <span class="string">"files/ngx_cache_purge-2.3.tar.gz"</span></div><div class="line"></div><div class="line">- name: Check whether nginx users exist</div><div class="line">  shell: id nginx</div><div class="line">  register: result</div><div class="line">  ignore_errors: True</div><div class="line">- name: The nginx user does not exist, so we need to create it.[The nginx user<span class="string">'s password is 123456]</span></div><div class="line">  user: name=nginx createhome=yes home=/home/nginx shell=/bin/bash password="$1$K28XAyId$YUKHvYzbbO9C8RkzGIzNo1" state=present</div><div class="line">  when: result|failed</div><div class="line"></div><div class="line">- name: Install the pcre-8.40 source package</div><div class="line">  shell: cd &#123;&#123;remote_download_path&#125;&#125;/pcre-8.40/ &amp;&amp; sh ./configure &amp;&amp; make &amp;&amp; make install</div><div class="line">- name: Install the zlib-1.2.11 source package</div><div class="line">  shell: cd &#123;&#123;remote_download_path&#125;&#125;/zlib-1.2.11/ &amp;&amp; sh ./configure &amp;&amp; make &amp;&amp; make install</div><div class="line">- name: Install the openssl-1.1.0e source package</div><div class="line">  shell: cd &#123;&#123;remote_download_path&#125;&#125;/openssl-1.1.0e/ &amp;&amp; sh ./config &amp;&amp; make &amp;&amp; make install</div><div class="line">- name: Install the some devel packages</div><div class="line">  yum: name=&#123;&#123;item.rpm&#125;&#125; state=installed</div><div class="line">  with_items:</div><div class="line">    - rpm: "openssl-devel"</div><div class="line">    - rpm: "pcre-devel"</div><div class="line">    - rpm: "zlib-devel"</div><div class="line">    - rpm: "gcc"</div><div class="line">    - rpm: "gcc-c++"</div><div class="line">    - rpm: "make"</div><div class="line">    - rpm: "perl"</div><div class="line">    - rpm: "perl-devel"</div><div class="line">    - rpm: "perl-ExtUtils-Embed"</div><div class="line">- name: Install the gperftools-2.0 source package</div><div class="line">  shell: cd &#123;&#123;remote_download_path&#125;&#125;/gperftools-2.0/ &amp;&amp; sh ./configure --enable-frame-pointers &amp;&amp; make &amp;&amp; make install &amp;&amp; echo "/usr/local/lib" &gt; /etc/ld.so.conf.d/usr_local_lib.conf &amp;&amp; ldconfig</div><div class="line">- name: Install patch package</div><div class="line">  yum: name=patch state=installed</div><div class="line">- name: Play nginx-upstream-jvm-route patche</div><div class="line">  shell: cd &#123;&#123;remote_download_path&#125;&#125;/nginx-1.11.7/ &amp;&amp; patch -p0 &lt; ../nginx-upstream-jvm-route/jvm_route.patch</div><div class="line">- name: Install the Nginx package</div><div class="line">  shell: cd &#123;&#123;remote_download_path&#125;&#125;/nginx-1.11.7/ &amp;&amp; sh ./configure --prefix=&#123;&#123;nginx_install_path&#125;&#125; --user=nginx --group=nginx --with-http_gzip_static_module --with-http_stub_status_module --with-google_perftools_module --add-module=../echo-nginx-module-0.59 --add-module=../nginx-upstream-jvm-route --with-pcre=../pcre-8.40 --without-http_ssi_module --without-http_autoindex_module --without-mail_pop3_module --without-mail_imap_module --without-mail_smtp_module --add-module=../ngx_cache_purge-2.3 --with-http_ssl_module --with-openssl=../openssl-1.1.0e --with-stream --with-http_mp4_module &amp;&amp; make &amp;&amp; make install</div><div class="line"></div><div class="line">- name: Create some directory</div><div class="line">  file: path=&#123;&#123;item.path&#125;&#125; state=directory mode=&#123;&#123;item.mode|default("0755")&#125;&#125; owner=nginx group=nginx</div><div class="line">  with_items:</div><div class="line">    - path: "/tmp/tcmalloc"</div><div class="line">      mode: "0777"</div><div class="line">    - path: "/var/proxy_cache/temp"</div><div class="line">    - path: "/var/proxy_cache/cache"</div><div class="line">    - path: "/var/log/nginx"</div><div class="line">    - path: "&#123;&#123;nginx_conf_dir&#125;&#125;/vhosts"</div><div class="line"></div><div class="line">- name: set nginx parameter</div><div class="line">  set_fact: worker_processes="&#123;&#123;ansible_processor_cores&#125;&#125;"</div><div class="line">- name: Copy same files</div><div class="line">  template: src=&#123;&#123;item.src&#125;&#125; dest=&#123;&#123;item.dest&#125;&#125; owner=nginx group=nginx mode=&#123;&#123;item.mode|default("0644")&#125;&#125;</div><div class="line">  with_items: </div><div class="line">    - src: "templates/etc_init.d_nginx.txt"</div><div class="line">      dest: "/etc/init.d/nginx"</div><div class="line">      mode: "0755"</div><div class="line">    - src: "templates/nginx.conf.j2"</div><div class="line">      dest: "&#123;&#123;nginx_conf_dir&#125;&#125;/nginx.conf"</div><div class="line">    - src: "templates/proxy.conf.j2"</div><div class="line">      dest: "&#123;&#123;nginx_conf_dir&#125;&#125;/vhosts/proxy.conf"</div><div class="line">    - src: "templates/comm.conf.j2"</div><div class="line">      dest: "&#123;&#123;nginx_conf_dir&#125;&#125;/vhosts/comm.conf"</div><div class="line">    - src: "templates/static.conf.j2"</div><div class="line">      dest: "&#123;&#123;nginx_conf_dir&#125;&#125;/vhosts/static.conf"</div><div class="line">    - src: "templates/fastcgi.conf.j2"</div><div class="line">      dest: "&#123;&#123;nginx_conf_dir&#125;&#125;/vhosts/fastcgi.conf"</div><div class="line">  notify: restart nginx</div><div class="line">[root@Ansible ansible]#</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#handlers</span></div><div class="line">[root@Ansible ansible]<span class="comment"># cat roles/source_nginx/handlers/main.yml </span></div><div class="line">- name: restart nginx</div><div class="line">  service: name=nginx state=restarted enabled=yes</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#files</span></div><div class="line">[root@Ansible ansible]<span class="comment"># ls roles/source_nginx/files/</span></div><div class="line"><span class="built_in">echo</span>-nginx-module-0.59.tar.gz  nginx_tcp_proxy_module_nginx1.11.7.zip    openssl-1.1.0e.tar.gz  zlib-1.2.11.tar.gz</div><div class="line">gperftools-2.0.zip             nginx-upstream-jvm-route-nginx1.11.7.zip  pcre-8.40.zip</div><div class="line">nginx-1.11.7.tar.gz            ngx_cache_purge-2.3.tar.gz                yum.repo</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#templates</span></div><div class="line">[root@Ansible ansible]<span class="comment"># ls roles/source_nginx/templates/</span></div><div class="line">comm.conf.j2  etc_init.d_nginx.txt  fastcgi.conf.j2  nginx.conf.j2  proxy.conf.j2  static.conf.j2</div><div class="line">[root@Ansible ansible]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#执行结果</span></div><div class="line">[root@Ansible ~]<span class="comment"># ansible-playbook /etc/ansible/site.yml </span></div><div class="line"></div><div class="line">PLAY [test_hosts] **************************************************************</div><div class="line"></div><div class="line">TASK [setup] *******************************************************************</div><div class="line">ok: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : disabled iptables] ****************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Set the selinux value to Permissive] **********************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Create download directory] ********************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Install the some tools] ***********************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'unzip'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'zip'</span>&#125;)</div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'tar'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'name'</span>: u<span class="string">'libselinux-python'</span>&#125;)</div><div class="line"></div><div class="line">TASK [source_nginx : download some <span class="built_in">source</span> packages] ****************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'url'</span>: u<span class="string">'https://ftp.pcre.org/pub/pcre/pcre-8.40.zip'</span>, u<span class="string">'validate_certs'</span>: u<span class="string">'no'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'url'</span>: u<span class="string">'http://nginx.org/download/nginx-1.11.7.tar.gz'</span>&#125;)</div><div class="line"></div><div class="line">TASK [source_nginx : unarchive some <span class="built_in">source</span> packages] ***************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'src'</span>: u<span class="string">'/tmp/download/nginx-1.11.7.tar.gz'</span>, u<span class="string">'remote_src'</span>: u<span class="string">'yes'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'src'</span>: u<span class="string">'/tmp/download/pcre-8.40.zip'</span>, u<span class="string">'remote_src'</span>: u<span class="string">'yes'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'src'</span>: u<span class="string">'files/zlib-1.2.11.tar.gz'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'src'</span>: u<span class="string">'files/openssl-1.1.0e.tar.gz'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'src'</span>: u<span class="string">'files/gperftools-2.0.zip'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'src'</span>: u<span class="string">'files/echo-nginx-module-0.59.tar.gz'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'src'</span>: u<span class="string">'files/nginx-upstream-jvm-route-nginx1.11.7.zip'</span>&#125;)</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u<span class="string">'src'</span>: u<span class="string">'files/ngx_cache_purge-2.3.tar.gz'</span>&#125;)</div><div class="line"></div><div class="line">TASK [source_nginx : Check whether nginx users exist] **************************</div><div class="line">fatal: [192.168.31.110]: FAILED! =&gt; &#123;<span class="string">"changed"</span>: <span class="literal">true</span>, <span class="string">"cmd"</span>: <span class="string">"id nginx"</span>, <span class="string">"delta"</span>: <span class="string">"0:00:00.003932"</span>, <span class="string">"end"</span>: <span class="string">"2017-03-19 20:29:56.963783"</span>, <span class="string">"failed"</span>: <span class="literal">true</span>, <span class="string">"rc"</span>: 1, <span class="string">"start"</span>: <span class="string">"2017-03-19 20:29:56.959851"</span>, <span class="string">"stderr"</span>: <span class="string">"id: nginx: No such user"</span>, <span class="string">"stdout"</span>: <span class="string">""</span>, <span class="string">"stdout_lines"</span>: [], <span class="string">"warnings"</span>: []&#125;</div><div class="line">...ignoring</div><div class="line"></div><div class="line">TASK [source_nginx : The nginx user does not exist, so we need to create it.[The nginx user<span class="string">'s password is 123456]] ***</span></div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Install the pcre-8.40 source package] *********************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Install the zlib-1.2.11 source package] *******************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Install the openssl-1.1.0e source package] ****************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Install the some devel packages] **************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'rpm<span class="string">': u'</span>openssl-devel<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'rpm<span class="string">': u'</span>pcre-devel<span class="string">'&#125;)</span></div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'rpm<span class="string">': u'</span>zlib-devel<span class="string">'&#125;)</span></div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'rpm<span class="string">': u'</span>gcc<span class="string">'&#125;)</span></div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'rpm<span class="string">': u'</span>gcc-c++<span class="string">'&#125;)</span></div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'rpm<span class="string">': u'</span>make<span class="string">'&#125;)</span></div><div class="line">ok: [192.168.31.110] =&gt; (item=&#123;u'rpm<span class="string">': u'</span>perl<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'rpm<span class="string">': u'</span>perl-devel<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'rpm<span class="string">': u'</span>perl-ExtUtils-Embed<span class="string">'&#125;)</span></div><div class="line"></div><div class="line">TASK [source_nginx : Install the gperftools-2.0 source package] ****************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Install patch package] ************************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Play nginx-upstream-jvm-route patche] *********************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Install the Nginx package] ********************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Create some directory] ************************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'path<span class="string">': u'</span>/tmp/tcmalloc<span class="string">', u'</span>mode<span class="string">': u'</span>0777<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'path<span class="string">': u'</span>/var/proxy_cache/temp<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'path<span class="string">': u'</span>/var/proxy_cache/cache<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'path<span class="string">': u'</span>/var/<span class="built_in">log</span>/nginx<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'path<span class="string">': u'</span>/usr/<span class="built_in">local</span>/nginx-1.11.7/conf/vhosts<span class="string">'&#125;)</span></div><div class="line"></div><div class="line">TASK [source_nginx : set nginx parameter] **************************************</div><div class="line">ok: [192.168.31.110]</div><div class="line"></div><div class="line">TASK [source_nginx : Copy same files] ******************************************</div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'dest<span class="string">': u'</span>/etc/init.d/nginx<span class="string">', u'</span>src<span class="string">': u'</span>templates/etc_init.d_nginx.txt<span class="string">', u'</span>mode<span class="string">': u'</span>0755<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'dest<span class="string">': u'</span>/usr/<span class="built_in">local</span>/nginx-1.11.7/conf/nginx.conf<span class="string">', u'</span>src<span class="string">': u'</span>templates/nginx.conf.j2<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'dest<span class="string">': u'</span>/usr/<span class="built_in">local</span>/nginx-1.11.7/conf/vhosts/proxy.conf<span class="string">', u'</span>src<span class="string">': u'</span>templates/proxy.conf.j2<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'dest<span class="string">': u'</span>/usr/<span class="built_in">local</span>/nginx-1.11.7/conf/vhosts/comm.conf<span class="string">', u'</span>src<span class="string">': u'</span>templates/comm.conf.j2<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'dest<span class="string">': u'</span>/usr/<span class="built_in">local</span>/nginx-1.11.7/conf/vhosts/static.conf<span class="string">', u'</span>src<span class="string">': u'</span>templates/static.conf.j2<span class="string">'&#125;)</span></div><div class="line">changed: [192.168.31.110] =&gt; (item=&#123;u'dest<span class="string">': u'</span>/usr/<span class="built_in">local</span>/nginx-1.11.7/conf/vhosts/fastcgi.conf<span class="string">', u'</span>src<span class="string">': u'</span>templates/fastcgi.conf.j2<span class="string">'&#125;)</span></div><div class="line"></div><div class="line">RUNNING HANDLER [source_nginx : restart nginx] *********************************</div><div class="line">changed: [192.168.31.110]</div><div class="line"></div><div class="line">PLAY RECAP *********************************************************************</div><div class="line">192.168.31.110             : ok=21   changed=19   unreachable=0    failed=0   </div><div class="line"></div><div class="line">[root@Ansible ~]#</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@Ansible ~]<span class="comment"># ansible test_hosts -a '/etc/init.d/nginx status'</span></div><div class="line">192.168.31.110 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">nginx (pid  76973) is running...</div><div class="line"></div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p><img src="http://note.youdao.com/yws/api/personal/file/5F4B8CAE60154D52839B376BFA939C44?method=download&amp;shareKey=803852b9567b3abe6cc336ec5e16294e" alt="image"><br><img src="http://note.youdao.com/yws/api/personal/file/994FFC90CD3947DE8ED1E8BF19428A63?method=download&amp;shareKey=7e2c02f801b5e0f73c8054dfddbb8474" alt="image">  </p>
<p>附件：<a href="http://note.youdao.com/yws/api/personal/file/4BEFB9060722495E8757D94F41FF68DA?method=download&amp;shareKey=a87dc09c478c8fdd5f540b3c6da7d397" target="_blank" rel="external">ansible_install_nginx1.11.7.tar.gz</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="https://yfshare.github.io">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="https://yfshare.github.io/2017/03/11/Ansible-Playbooks之安装Nginx/">https://yfshare.github.io/2017/03/11/Ansible-Playbooks之安装Nginx/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;playbooks 是一种简单的配置管理系统与多机器部署系统的基础。与现有的其他系统有不同之处,且非常适合于复杂应用的批量部署&lt;br&gt;Playbooks 的格式是YAML，语法做到最小化  &lt;/p&gt;
&lt;p&gt;这里讲述的是使用ansible-playbooks的roles安装Nginx应用&lt;br&gt;
    
    </summary>
    
      <category term="Ansible" scheme="https://yfshare.github.io/categories/Ansible/"/>
    
    
      <category term="ansible" scheme="https://yfshare.github.io/tags/ansible/"/>
    
      <category term="nginx" scheme="https://yfshare.github.io/tags/nginx/"/>
    
  </entry>
  
  <entry>
    <title>Mysql备份恢复</title>
    <link href="https://yfshare.github.io/2017/03/08/Mysql%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D/"/>
    <id>https://yfshare.github.io/2017/03/08/Mysql备份恢复/</id>
    <published>2017-03-08T10:59:30.000Z</published>
    <updated>2017-03-21T10:25:14.000Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>开启mysql的binlog功能可以有效防止在日常mysql操作过程中因操作失误而导致的数据丢失问题<br>但是，对于DBA来说，第一准则就是<strong>备份重于一切</strong>。<a href="http://www.eygle.com/" target="_blank" rel="external">eygle</a>在DBA<a href="http://www.eygle.com/archives/2006/03/the_four_rule_for_dba.html" target="_blank" rel="external">四大生存法则</a>中也有提到<br><em>我们必需知道,系统总是要崩溃的，没有有效的备份只是等哪一天死！我经常开玩笑的说,唯一会使DBA在梦中惊醒的就是,没有有效的备份.</em><br><a id="more"></a></p>
<h2 id="binlog"><a href="#binlog" class="headerlink" title="binlog"></a>binlog</h2><p>binlog，也称为二进制日志，记录对数据发生或潜在发生更改的SQL语句，并以二进制的形式保存在磁盘中，可以用来查看数据库的变更历史（具体的时间点所有的SQL操作）、数据库增量备份和恢复（增量备份和基于时间点的恢复）、Mysql的复制（主主数据库的复制、主从数据库的复制）</p>
<h2 id="开启binlog"><a href="#开启binlog" class="headerlink" title="开启binlog"></a>开启binlog</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">mysql&gt; show variables like <span class="string">'%log_bin%'</span>;</div><div class="line">+---------------------------------+-------+</div><div class="line">| Variable_name                   | Value |</div><div class="line">+---------------------------------+-------+</div><div class="line">| log_bin                         | ON    |</div><div class="line">| log_bin_trust_function_creators | OFF   |</div><div class="line">| sql_log_bin                     | ON    |</div><div class="line">+---------------------------------+-------+</div><div class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt;</div><div class="line"></div><div class="line">[root@host1 ~]<span class="comment"># grep -i 'bin' /etc/my.cnf | grep -i 'log'</span></div><div class="line">log_bin=mysql_bin</div><div class="line">binlog_format=Mixed</div><div class="line">[root@host1 ~]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@host1 ~]<span class="comment"># /etc/init.d/mysqld restart</span></div><div class="line"></div><div class="line">[root@host1 ~]<span class="comment"># ls /var/lib/mysql | grep 'mysql_bin' | tail -3</span></div><div class="line">mysql_bin.000032</div><div class="line">mysql_bin.000033</div><div class="line">mysql_bin.index</div><div class="line">[root@host1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h2 id="Mysql备份恢复"><a href="#Mysql备份恢复" class="headerlink" title="Mysql备份恢复"></a>Mysql备份恢复</h2><p>环境：Centos 6.6<br>　　　Mysql version： 5.5.54<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#先执行全备操作</span></div><div class="line">[root@host1 ~]<span class="comment"># sh mysql_back.sh </span></div><div class="line">Usage: please input Mysql_Fullbackup|Mysql_Incbackup</div><div class="line"></div><div class="line">[root@host1 ~]<span class="comment"># sh mysql_back.sh Mysql_Fullbackup</span></div><div class="line">Full backup of MySQL database... Please wait.</div><div class="line"></div><div class="line">Mysql database full backup success.</div><div class="line">[root@host1 ~]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@host1 ~]<span class="comment"># tree /backup/mysql_backup/</span></div><div class="line">/backup/mysql_backup/</div><div class="line">├── backup_20170308.log</div><div class="line">├── Full_backup</div><div class="line">│   └── 20170308</div><div class="line">│       ├── all_databases_backup_20170308_17:06:08.sql.gz</div><div class="line">│       └── jack_backup_20170308_17:06:08.sql.gz</div><div class="line">├── Full_backup_time.txt</div><div class="line">├── Inc_backup</div><div class="line">└── mysql_db.txt</div><div class="line"></div><div class="line">3 directories, 5 files</div><div class="line">[root@host1 ~]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@host1 mysql_backup]<span class="comment"># cat backup_20170308.log </span></div><div class="line">[ 2017-03-08 17:06:08 ] - Databases all-databases has been backup successful.</div><div class="line"></div><div class="line">[ 2017-03-08 17:06:08 ] - Databases jack has been backup successful.</div><div class="line">----------------------------------------</div><div class="line"></div><div class="line">[root@host1 mysql_backup]<span class="comment"># cat Full_backup_time.txt </span></div><div class="line">2017-03-08 17:06:08</div><div class="line">[root@host1 mysql_backup]<span class="comment"># cat mysql_db.txt </span></div><div class="line">jack</div><div class="line">[root@host1 mysql_backup]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>向jack库的yfshare表插入几条数据<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">mysql&gt; use jack;</div><div class="line">mysql&gt; select * from yfshare;</div><div class="line">+------+---------+</div><div class="line">| id   | name    |</div><div class="line">+------+---------+</div><div class="line">| 1    | jack    |</div><div class="line">| 2    | yfshare |</div><div class="line">| 3    | tom     |</div><div class="line">| 4    | jerry   |</div><div class="line">| 5    | bob     |</div><div class="line">+------+---------+</div><div class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</div><div class="line">mysql&gt; INSERT INTO yfshare values(6,<span class="string">'aaa'</span>);</div><div class="line">mysql&gt; INSERT INTO yfshare values(7,<span class="string">'bbb'</span>);</div><div class="line">mysql&gt; commit;</div><div class="line">mysql&gt; select * from yfshare;</div><div class="line">+------+---------+</div><div class="line">| id   | name    |</div><div class="line">+------+---------+</div><div class="line">| 1    | jack    |</div><div class="line">| 2    | yfshare |</div><div class="line">| 3    | tom     |</div><div class="line">| 4    | jerry   |</div><div class="line">| 5    | bob     |</div><div class="line">| 6    | aaa     |</div><div class="line">| 7    | bbb     |</div><div class="line">+------+---------+</div><div class="line">7 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt;</div></pre></td></tr></table></figure></p>
<p>然后做增量备份<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@host1 ~]<span class="comment"># sh mysql_back.sh Mysql_Incbackup</span></div><div class="line">Increment backup of MySQL database... Please wait.</div><div class="line"></div><div class="line">Mysql database Increment backup success.</div><div class="line">[root@host1 ~]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@host1 ~]<span class="comment"># tree /backup/mysql_backup/Inc_backup/</span></div><div class="line">/backup/mysql_backup/Inc_backup/</div><div class="line">└── 20170308</div><div class="line">    └── jack_Inc_20170308_17:15:27.zip</div><div class="line"></div><div class="line">1 directory, 1 file</div><div class="line">[root@host1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">再向jack库和yfshare表插入几条数据后，不做备份，假设不小心删除了库jack    </div><div class="line"><span class="code">```</span>bash</div><div class="line">mysql&gt; INSERT INTO yfshare values(8,<span class="emphasis">'ccc'</span>);</div><div class="line">mysql&gt; INSERT INTO yfshare values(9,<span class="emphasis">'ddd'</span>);</div><div class="line">mysql&gt; commit;</div><div class="line"><span class="section">mysql&gt; select * from yfshare;</span></div><div class="line">+------+---------+</div><div class="line"><span class="section">| id   | name    |</span></div><div class="line">+------+---------+</div><div class="line">| 1    | jack    |</div><div class="line">| 2    | yfshare |</div><div class="line">| 3    | tom     |</div><div class="line">| 4    | jerry   |</div><div class="line">| 5    | bob     |</div><div class="line">| 6    | aaa     |</div><div class="line">| 7    | bbb     |</div><div class="line">| 8    | ccc     |</div><div class="line"><span class="section">| 9    | ddd     |</span></div><div class="line">+------+---------+</div><div class="line">9 rows in set (0.00 sec)</div><div class="line">mysql&gt; drop database jack;</div><div class="line">mysql&gt; commit;</div><div class="line">mysql&gt; desc yfshare;</div><div class="line">ERROR 1046 (3D000): No database selected</div><div class="line">mysql&gt; use jack;</div><div class="line">ERROR 1049 (42000): Unknown database <span class="emphasis">'jack'</span></div><div class="line">mysql&gt;</div></pre></td></tr></table></figure>
<p>下面来开始恢复jack库的yfshare表<br>恢复步骤：  </p>
<ol>
<li>恢复jack库的全量备份</li>
<li>恢复jack库的增量备份</li>
<li>通过binlog恢复数据库到删除前</li>
</ol>
<p>恢复思路：先在mysql中新建一个测试库，在测试库导入误删除表所在的库全量增量备份，然后通过binlog恢复到该表删除前一刻，并导入测试库，然后从测试库导出该表的sql，最后导入到正式库<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@host1 mysql_backup]<span class="comment"># mysql -uroot -p123456 jack --one-database &lt; Full_backup/20170308/jack_backup_20170308_17\:06\:08.sql </span></div><div class="line">ERROR 1049 (42000): Unknown database <span class="string">'jack'</span></div><div class="line">[root@host1 mysql_backup]<span class="comment">#</span></div><div class="line"></div><div class="line">这时是因为没有库，所以需要先创建对应的库名，再执行全备恢复操作</div><div class="line">mysql&gt; create database jack;</div><div class="line">mysql&gt; commit;</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#全量备份恢复</span></div><div class="line">[root@host1 mysql_backup]<span class="comment"># gunzip Full_backup/20170308/jack_backup_20170308_17\:06\:08.sql.gz</span></div><div class="line">[root@host1 mysql_backup]<span class="comment"># mysql -uroot -p123456 jack --one-database &lt; Full_backup/20170308/jack_backup_20170308_17\:06\:08.sql</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#增量备份恢复</span></div><div class="line">[root@host1 mysql_backup]<span class="comment"># unzip Inc_backup/20170308/jack_Inc_20170308_17\:15\:27.zip -d Inc_backup/20170308/</span></div><div class="line">[root@host1 mysql_backup]<span class="comment"># mysql -uroot -p123456 jack --one-database &lt; Inc_backup/20170308/jack_Inc_20170308_17\:15\:27.sql</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#先看看恢复的情况</span></div><div class="line">mysql&gt; use jack;</div><div class="line">mysql&gt; show tables;</div><div class="line">+----------------+</div><div class="line">| Tables_in_jack |</div><div class="line">+----------------+</div><div class="line">| aaa            |</div><div class="line">| yfshare        |</div><div class="line">+----------------+</div><div class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; select * from yfshare;</div><div class="line">+------+---------+</div><div class="line">| id   | name    |</div><div class="line">+------+---------+</div><div class="line">| 1    | jack    |</div><div class="line">| 2    | yfshare |</div><div class="line">| 3    | tom     |</div><div class="line">| 4    | jerry   |</div><div class="line">| 5    | bob     |</div><div class="line">| 6    | aaa     |</div><div class="line">| 7    | bbb     |</div><div class="line">+------+---------+</div><div class="line">7 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt;</div></pre></td></tr></table></figure>
<p>现在yfshare表里面只有7条数据，删除前是有9条数据的，而后边的数据没有备份，所以只能通过mysqlbinlog恢复了</p>
<p>增量备份时间是20170308_17:15:27，所以需要把从这个时间点到删除前的操作导出成一个sql文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@host1 mysql_backup]<span class="comment"># tail -3 /var/lib/mysql/mysql_bin.index </span></div><div class="line">./mysql_bin.000031</div><div class="line">./mysql_bin.000032</div><div class="line">./mysql_bin.000033</div><div class="line">[root@host1 mysql_backup]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>binlog的时间格式是：170308 17:15:27<br>mysqlbinlog恢复的时间格式：2017-03-08 17:15:27<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#查找增量备份时记录到了哪个binlog文件</span></div><div class="line"><span class="comment">#因为我们在增量备份文件中记录了备份时间，所以能很快找到是从mysql_bin.000032开始的</span></div><div class="line">[root@host1 tmp]<span class="comment"># mysqlbinlog --no-defaults /var/lib/mysql/mysql_bin.000032 | grep -i '170308 17:15:27'</span></div></pre></td></tr></table></figure></p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#查找删除的时间点</span></div><div class="line"><span class="meta">#可以考虑把所有mysql_bin文件导成sql文件后过滤查找</span></div><div class="line">[root@host1 ~]# mysqlbinlog -d jack /<span class="keyword">var</span>/lib/mysql/mysql_bin<span class="number">.000033</span> &gt; test.sql</div><div class="line"></div><div class="line"><span class="meta">#发现误删除操作的时间是170308 17:18:29</span></div><div class="line"><span class="meta">#170308 17:18:29 server id 1  end_log_pos 602   Query   thread_id=117   exec_time=0     error_code=0</span></div><div class="line">SET TIMESTAMP=<span class="number">1488964709</span><span class="comment">/*!*/</span>;</div><div class="line">DROP TABLE `yfshare` <span class="comment">/* generated by server */</span></div><div class="line"><span class="comment">/*!*/</span>;</div><div class="line"><span class="meta"># at 602</span></div><div class="line"><span class="meta">#170308 17:24:43 server id 1  end_log_pos 683   Query   thread_id=117   exec_time=0     error_code=0</span></div><div class="line">SET TIMESTAMP=<span class="number">1488965083</span><span class="comment">/*!*/</span>;</div><div class="line">drop database jack</div></pre></td></tr></table></figure>
<p>通过查找binlog发现，我们需要恢复的时间是170308 17:18:29<br>这时候我们就可以恢复了<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#因为找到具体的binlog文件和误删除操作时间，所以我们要把期间所有的操作导成一个sql文件，然后恢复</span></div><div class="line">[root<span class="meta">@host1</span> ~]<span class="comment"># mysqlbinlog -d jack --start-datetime="2017-03-08 17:15:27" /var/lib/mysql/mysql_bin.000032 &gt; recover.sql</span></div><div class="line">[root<span class="meta">@host1</span> ~]<span class="comment"># mysqlbinlog -d jack --stop-datetime="2017-03-08 17:18:29" /var/lib/mysql/mysql_bin.000033 &gt;&gt; recover.sql</span></div><div class="line">mysql&gt; use jack;</div><div class="line">mysql&gt; source ~/recover.sql</div><div class="line">mysql&gt; commit;</div><div class="line">mysql&gt; select <span class="symbol">*</span> from yfshare;</div><div class="line">+------+---------+</div><div class="line">|<span class="string"> id   </span>|<span class="string"> name    </span>|</div><div class="line">+------+---------+</div><div class="line">|<span class="string"> 1    </span>|<span class="string"> jack    </span>|</div><div class="line">|<span class="string"> 2    </span>|<span class="string"> yfshare </span>|</div><div class="line">|<span class="string"> 3    </span>|<span class="string"> tom     </span>|</div><div class="line">|<span class="string"> 4    </span>|<span class="string"> jerry   </span>|</div><div class="line">|<span class="string"> 5    </span>|<span class="string"> bob     </span>|</div><div class="line">|<span class="string"> 6    </span>|<span class="string"> aaa     </span>|</div><div class="line">|<span class="string"> 7    </span>|<span class="string"> bbb     </span>|</div><div class="line">|<span class="string"> 8    </span>|<span class="string"> ccc     </span>|</div><div class="line">|<span class="string"> 9    </span>|<span class="string"> ddd     </span>|</div><div class="line">+------+---------+</div><div class="line">9 rows in set (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt;</div></pre></td></tr></table></figure></p>
<p>OK，恢复成功  </p>
<h2 id="Mysql备份恢复脚本"><a href="#Mysql备份恢复脚本" class="headerlink" title="Mysql备份恢复脚本"></a>Mysql备份恢复脚本</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#mysql备份脚本目录结构</span></div><div class="line">[root@host1 ~]<span class="comment"># tree /backup/mysql_backup/</span></div><div class="line">/backup/mysql_backup/</div><div class="line">├── backup_20170308.log</div><div class="line">├── Full_backup</div><div class="line">│   └── 20170308</div><div class="line">│       ├── all_databases_backup_20170308_17:06:08.sql.gz</div><div class="line">│       └── jack_backup_20170308_17:06:08.sql</div><div class="line">├── Full_backup_time.txt</div><div class="line">├── Inc_backup</div><div class="line">│   └── 20170308</div><div class="line">│       ├── jack_Inc_20170308_17:15:27.sql</div><div class="line">│       └── jack_Inc_20170308_17:15:27.zip</div><div class="line">├── mysql_db.txt</div><div class="line">└── mysql_index.txt</div><div class="line"></div><div class="line">4 directories, 8 files</div><div class="line">[root@host1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div></pre></td><td class="code"><pre><div class="line">[root@host1 ~]<span class="comment"># cat mysql_back.sh</span></div><div class="line"><span class="comment">#mysql全量增量备份脚本</span></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="comment"># create user 'mysqlback'@'localhost' identified by '123456';</span></div><div class="line"><span class="comment"># grant select,lock tables,reload,super,file,show view on *.* to 'mysqlback'@'localhost' identified by '123456';</span></div><div class="line"><span class="comment"># flush privileges;</span></div><div class="line"><span class="comment"># \q</span></div><div class="line">DATE=`date <span class="string">'+%Y%m%d'</span>`</div><div class="line">DATE_log=`date <span class="string">'+%Y-%m-%d %H:%M:%S'</span>`</div><div class="line">DATE_filename=`date <span class="string">'+%Y%m%d_%H:%M:%S'</span>`</div><div class="line">DATE_backup_time=`date <span class="string">'+%Y-%m-%d %H:%M:%S'</span>`</div><div class="line"></div><div class="line">mysql_host=<span class="string">"192.168.31.110"</span></div><div class="line">mysql_user=<span class="string">"root"</span></div><div class="line">mysql_pass=<span class="string">"123456"</span></div><div class="line"></div><div class="line">Mysql_Backup=<span class="string">"/backup/mysql_backup"</span></div><div class="line">Full_Backup=<span class="string">"<span class="variable">$Mysql_Backup</span>/Full_backup"</span></div><div class="line">Inc_Backup=<span class="string">"<span class="variable">$Mysql_Backup</span>/Inc_backup"</span></div><div class="line">Mysql_index=<span class="string">"<span class="variable">$Mysql_Backup</span>/mysql_index.txt"</span></div><div class="line"></div><div class="line">Mysql_data=<span class="string">"/var/lib/mysql"</span></div><div class="line">Mysql_bin=<span class="string">"/usr/bin"</span></div><div class="line">Mysql_db=<span class="string">"<span class="variable">$Mysql_Backup</span>/mysql_db.txt"</span></div><div class="line">Mysql_logbin_name=<span class="string">"mysql_bin"</span></div><div class="line">Mysql_binlog=<span class="string">"/usr/bin/mysqlbinlog"</span></div><div class="line"></div><div class="line">MYSQL=<span class="string">"/usr/bin/mysql"</span></div><div class="line">MYSQLDUMP=<span class="string">"/usr/bin/mysqldump"</span></div><div class="line">MYSQLADMIN=<span class="string">"/usr/bin/mysqladmin"</span></div><div class="line">SOCKET=<span class="string">"/var/lib/mysql/mysql.sock"</span></div><div class="line"></div><div class="line">Error_log=<span class="string">"<span class="variable">$Mysql_Backup</span>/backup_error_<span class="variable">$&#123;DATE&#125;</span>.log"</span></div><div class="line">Backup_log=<span class="string">"<span class="variable">$Mysql_Backup</span>/backup_<span class="variable">$&#123;DATE&#125;</span>.log"</span></div><div class="line"></div><div class="line">[ ! <span class="_">-d</span> <span class="string">"<span class="variable">$Mysql_Backup</span>"</span> ] &amp;&amp; mkdir -p <span class="string">"<span class="variable">$Mysql_Backup</span>"</span></div><div class="line">[ ! <span class="_">-d</span> <span class="string">"<span class="variable">$Full_Backup</span>"</span> ] &amp;&amp; mkdir -p <span class="string">"<span class="variable">$Full_Backup</span>"</span></div><div class="line">[ ! <span class="_">-d</span> <span class="string">"<span class="variable">$Inc_Backup</span>"</span> ] &amp;&amp; mkdir -p <span class="string">"<span class="variable">$Inc_Backup</span>"</span></div><div class="line"></div><div class="line"><span class="built_in">cd</span> <span class="variable">$Mysql_Backup</span></div><div class="line"><span class="variable">$MYSQL</span> -u<span class="string">"<span class="variable">$mysql_user</span>"</span> -p<span class="string">"<span class="variable">$mysql_pass</span>"</span> -Ne <span class="string">'show databases'</span> | grep -vw <span class="string">'test'</span> | grep -vw <span class="string">'performance_schema'</span> | grep -vw <span class="string">'information_schema'</span> | grep -vw <span class="string">'mysql'</span> &gt; <span class="variable">$Mysql_db</span></div><div class="line"></div><div class="line"><span class="keyword">function</span> <span class="function"><span class="title">Full</span></span>() &#123;</div><div class="line"><span class="built_in">echo</span> <span class="_">-e</span> <span class="string">'Full backup of MySQL database... Please wait.\n'</span></div><div class="line"><span class="built_in">cd</span> <span class="variable">$Mysql_Backup</span></div><div class="line">[ ! <span class="_">-d</span> <span class="string">"<span class="variable">$Full_Backup</span>"</span>/<span class="string">"<span class="variable">$DATE</span>"</span> ] &amp;&amp; mkdir -p <span class="string">"<span class="variable">$Full_Backup</span>"</span>/<span class="string">"<span class="variable">$DATE</span>"</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$DATE_backup_time</span>"</span> &gt; <span class="string">"<span class="variable">$Mysql_Backup</span>"</span>/Full_backup_time.txt</div><div class="line"></div><div class="line"><span class="comment">#backup all-databases</span></div><div class="line"><span class="variable">$MYSQLDUMP</span> --flush-logs --quick --opt --master-data=2 --tz-utc=<span class="literal">true</span> --ignore-table=mysql.event -u<span class="string">"<span class="variable">$mysql_user</span>"</span> -p<span class="string">"<span class="variable">$mysql_pass</span>"</span> --all-databases | gzip &gt; <span class="string">"<span class="variable">$Full_Backup</span>"</span>/<span class="string">"<span class="variable">$DATE</span>"</span>/all_databases_backup_<span class="string">"<span class="variable">$DATE_filename</span>"</span>.sql.gz</div><div class="line"><span class="keyword">if</span> [ $? <span class="_">-eq</span> 0 ];<span class="keyword">then</span></div><div class="line">  /bin/logger <span class="string">"[ "</span><span class="variable">$DATE_log</span><span class="string">" ] - Databases all-databases has been backup successful."</span></div><div class="line">  <span class="built_in">echo</span> <span class="_">-e</span> <span class="string">"[ "</span><span class="variable">$DATE_log</span><span class="string">" ] - Databases all-databases has been backup successful.\n"</span> &gt;&gt; <span class="string">"<span class="variable">$Backup_log</span>"</span></div><div class="line">  /bin/sleep 5</div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="comment">#Backup a single database</span></div><div class="line">[ ! <span class="_">-s</span> <span class="string">"<span class="variable">$Mysql_db</span>"</span> ] &amp;&amp; <span class="built_in">echo</span> <span class="_">-e</span> <span class="string">'Error: Backup a single database. Do not back up mysql system database.[test|performance_schema|information_schema|mysql]\n'</span> &amp;&amp; <span class="built_in">echo</span> <span class="_">-e</span> <span class="string">'Mysql database full backup success.'</span> &amp;&amp; <span class="built_in">exit</span> 1</div><div class="line"><span class="keyword">for</span> DBNAME <span class="keyword">in</span> `cat <span class="variable">$Mysql_db</span>`</div><div class="line"><span class="keyword">do</span></div><div class="line">  <span class="variable">$MYSQLDUMP</span> --ignore-table=mysql.event --skip-lock-tables --quick --opt --master-data=2 --tz-utc=<span class="literal">true</span> -u<span class="string">"<span class="variable">$mysql_user</span>"</span> -p<span class="string">"<span class="variable">$mysql_pass</span>"</span> -S <span class="string">"<span class="variable">$SOCKET</span>"</span> <span class="string">"<span class="variable">$DBNAME</span>"</span> | gzip &gt; <span class="string">"<span class="variable">$Full_Backup</span>"</span>/<span class="string">"<span class="variable">$DATE</span>"</span>/<span class="string">"<span class="variable">$DBNAME</span>"</span>_backup_<span class="string">"<span class="variable">$DATE_filename</span>"</span>.sql.gz</div><div class="line">  <span class="keyword">if</span> [ $? <span class="_">-eq</span> 0 ];<span class="keyword">then</span></div><div class="line">    /bin/logger <span class="string">"[ "</span><span class="variable">$DATE_log</span><span class="string">" ] - Databases "</span><span class="variable">$&#123;DBNAME&#125;</span><span class="string">" has been backup successful."</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">"[ "</span><span class="variable">$DATE_log</span><span class="string">" ] - Databases "</span><span class="variable">$&#123;DBNAME&#125;</span><span class="string">" has been backup successful."</span> &gt;&gt; <span class="string">"<span class="variable">$Backup_log</span>"</span></div><div class="line">    /bin/sleep 5</div><div class="line">  <span class="keyword">fi</span></div><div class="line"><span class="keyword">done</span></div><div class="line"><span class="built_in">echo</span> <span class="_">-e</span> <span class="string">'----------------------------------------\n'</span> &gt;&gt; <span class="string">"<span class="variable">$Backup_log</span>"</span></div><div class="line"></div><div class="line"><span class="built_in">cd</span> <span class="variable">$Mysql_Backup</span></div><div class="line">find <span class="string">"<span class="variable">$Full_Backup</span>"</span> -mtime +10 | xargs rm -rf &#123;&#125; \; &amp;&gt; /dev/null</div><div class="line"><span class="built_in">echo</span> <span class="string">'Mysql database full backup success.'</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">function</span> <span class="function"><span class="title">Inc</span></span>() &#123;</div><div class="line"><span class="built_in">echo</span> <span class="_">-e</span> <span class="string">'Increment backup of MySQL database... Please wait.\n'</span></div><div class="line">[ ! <span class="_">-f</span> <span class="string">"<span class="variable">$Mysql_Backup</span>"</span>/Full_backup_time.txt ] &amp;&amp; <span class="built_in">echo</span> <span class="_">-e</span> <span class="string">'Error: Please perform a full backup first. command: sh mysql_back.sh Mysql_Fullbackup'</span> &amp;&amp; <span class="built_in">exit</span> 1</div><div class="line"></div><div class="line">[ ! <span class="_">-s</span> <span class="string">"<span class="variable">$Mysql_db</span>"</span> ] &amp;&amp; <span class="built_in">echo</span> <span class="_">-e</span> <span class="string">"Error: file <span class="variable">$Mysql_db</span> is empey. There may only be a system database[test|performance_schema|information_schema|mysql]."</span> &amp;&amp; <span class="built_in">exit</span> 1</div><div class="line"></div><div class="line"><span class="built_in">cd</span> <span class="variable">$Mysql_Backup</span></div><div class="line"></div><div class="line"><span class="string">"<span class="variable">$MYSQLADMIN</span>"</span> -u<span class="string">"<span class="variable">$mysql_user</span>"</span> -p<span class="string">"<span class="variable">$mysql_pass</span>"</span> flush-logs</div><div class="line">awk -F<span class="string">'/'</span> <span class="string">'&#123;print $NF&#125;'</span> <span class="string">"<span class="variable">$Mysql_data</span>"</span>/mysql_bin.index &gt; <span class="string">"<span class="variable">$Mysql_index</span>"</span></div><div class="line"></div><div class="line">[ ! <span class="_">-s</span> <span class="string">"<span class="variable">$Mysql_index</span>"</span> ] &amp;&amp; <span class="built_in">echo</span> <span class="_">-e</span> <span class="string">"Error: Please open the mysql binlog log. The command in the my.cnf file: log_bin=mysql_bin and binlog_format=Mixed"</span> &amp;&amp; <span class="built_in">exit</span> 1</div><div class="line">[ ! <span class="_">-d</span> <span class="string">"<span class="variable">$Inc_Backup</span>"</span>/<span class="string">"<span class="variable">$DATE</span>"</span> ] &amp;&amp; mkdir -p <span class="string">"<span class="variable">$Inc_Backup</span>"</span>/<span class="string">"<span class="variable">$DATE</span>"</span></div><div class="line"></div><div class="line">DATE_starttime=`cat <span class="string">"<span class="variable">$Mysql_Backup</span>"</span>/Full_backup_time.txt`</div><div class="line">start=<span class="string">'--start-datetime'</span></div><div class="line"><span class="keyword">for</span> DBNAME <span class="keyword">in</span> `cat <span class="variable">$Mysql_db</span>`</div><div class="line"><span class="keyword">do</span></div><div class="line">  <span class="keyword">for</span> index <span class="keyword">in</span> `cat <span class="variable">$Mysql_index</span>`</div><div class="line">  <span class="keyword">do</span></div><div class="line">    <span class="string">"<span class="variable">$Mysql_binlog</span>"</span> -u<span class="string">"<span class="variable">$mysql_user</span>"</span> -p<span class="string">"<span class="variable">$mysql_pass</span>"</span> <span class="_">-d</span> <span class="string">"<span class="variable">$DBNAME</span>"</span> <span class="string">"<span class="variable">$start</span>"</span>=<span class="string">"<span class="variable">$DATE_starttime</span>"</span> <span class="string">"<span class="variable">$Mysql_data</span>"</span>/<span class="string">"<span class="variable">$index</span>"</span> &gt;&gt; <span class="string">"<span class="variable">$Inc_Backup</span>"</span>/<span class="string">"<span class="variable">$DATE</span>"</span>/<span class="string">"<span class="variable">$DBNAME</span>"</span>_Inc_<span class="string">"<span class="variable">$DATE_filename</span>"</span>.sql</div><div class="line">    /bin/sleep 1</div><div class="line">  <span class="keyword">done</span></div><div class="line">  <span class="keyword">if</span> [ $? <span class="_">-eq</span> 0 ];<span class="keyword">then</span></div><div class="line">      <span class="built_in">cd</span> <span class="string">"<span class="variable">$Inc_Backup</span>"</span>/<span class="string">"<span class="variable">$DATE</span>"</span></div><div class="line">      /usr/bin/zip -q <span class="string">"<span class="variable">$DBNAME</span>"</span>_Inc_<span class="string">"<span class="variable">$DATE_filename</span>"</span>.zip <span class="string">"<span class="variable">$DBNAME</span>"</span>_Inc_<span class="string">"<span class="variable">$DATE_filename</span>"</span>.sql</div><div class="line">      /bin/logger <span class="string">"[ "</span><span class="variable">$DATE_log</span><span class="string">" ] - Databases "</span><span class="variable">$&#123;DBNAME&#125;</span><span class="string">" has been Inc_backup successful."</span></div><div class="line">      <span class="built_in">echo</span> <span class="string">"[ "</span><span class="variable">$DATE_log</span><span class="string">" ] - Databases "</span><span class="variable">$&#123;DBNAME&#125;</span><span class="string">" has been Inc_backup successful."</span> &gt;&gt; <span class="string">"<span class="variable">$Backup_log</span>"</span></div><div class="line">      rm -rf <span class="string">"<span class="variable">$DBNAME</span>"</span>_Inc_<span class="string">"<span class="variable">$DATE_filename</span>"</span>.sql</div><div class="line">    <span class="keyword">fi</span></div><div class="line"><span class="keyword">done</span></div><div class="line"><span class="built_in">echo</span> <span class="_">-e</span> <span class="string">'----------------------------------------\n'</span> &gt;&gt; <span class="string">"<span class="variable">$Backup_log</span>"</span></div><div class="line"><span class="built_in">cd</span> <span class="variable">$Mysql_Backup</span></div><div class="line">find <span class="string">"<span class="variable">$Inc_Backup</span>"</span> -mtime +10 | xargs rm -rf &#123;&#125; \; &amp;&gt; /dev/null</div><div class="line"><span class="built_in">echo</span> <span class="string">'Mysql database Increment backup success.'</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span> </div><div class="line">	Mysql_Fullbackup)</div><div class="line">		Full;;</div><div class="line">	Mysql_Incbackup)</div><div class="line">		Inc;;</div><div class="line">	*)</div><div class="line">		<span class="built_in">echo</span> <span class="_">-e</span> <span class="string">"Usage: please input Mysql_Fullbackup|Mysql_Incbackup\n"</span>;;</div><div class="line"><span class="keyword">esac</span></div><div class="line">[root@host1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="https://yfshare.github.io">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="https://yfshare.github.io/2017/03/08/Mysql备份恢复/">https://yfshare.github.io/2017/03/08/Mysql备份恢复/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;开启mysql的binlog功能可以有效防止在日常mysql操作过程中因操作失误而导致的数据丢失问题&lt;br&gt;但是，对于DBA来说，第一准则就是&lt;strong&gt;备份重于一切&lt;/strong&gt;。&lt;a href=&quot;http://www.eygle.com/&quot;&gt;eygle&lt;/a&gt;在DBA&lt;a href=&quot;http://www.eygle.com/archives/2006/03/the_four_rule_for_dba.html&quot;&gt;四大生存法则&lt;/a&gt;中也有提到&lt;br&gt;&lt;em&gt;我们必需知道,系统总是要崩溃的，没有有效的备份只是等哪一天死！我经常开玩笑的说,唯一会使DBA在梦中惊醒的就是,没有有效的备份.&lt;/em&gt;&lt;br&gt;
    
    </summary>
    
      <category term="mysql" scheme="https://yfshare.github.io/categories/mysql/"/>
    
    
      <category term="mysql" scheme="https://yfshare.github.io/tags/mysql/"/>
    
      <category term="mysql备份恢复" scheme="https://yfshare.github.io/tags/mysql%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D/"/>
    
  </entry>
  
  <entry>
    <title>部署Ansible Tower</title>
    <link href="https://yfshare.github.io/2017/03/07/%E9%83%A8%E7%BD%B2Ansible-Tower/"/>
    <id>https://yfshare.github.io/2017/03/07/部署Ansible-Tower/</id>
    <published>2017-03-07T09:05:18.000Z</published>
    <updated>2017-03-07T09:12:03.000Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>Ansible Tower (以前叫’AWX’)是能够帮助任何IT团队更容易使用Ansible的解决方案。该方案基于web<br>Tower允许对用户进行权限控制，即使某用户不能传送某SSH凭证，你也可以通过Tower来对该用户共享该凭证。我们可以通过图形化界面来管理Inventory，也可以对各种各样的云资源做同步。Tower可以记录所有job的日志，也可以与LDAP集成，并且拥有强大的可浏览的REST API。Tower也提供了命令行工具，可以与Jenkins轻松集成。Provisioning回调对自动伸缩拓扑图提供了强大的支持<br><a id="more"></a><br>Tower的免费版本最多支持10个节点，并且Ansible公司会提供强大的支持。可以用Ansible playbook来安装Tower，ansible的版本为1.7x或更高版本<br>安装要求：内存&gt;=2GB,/var &gt;=10GB。否则会安装失败  </p>
<p>官网地址：<a href="https://www.ansible.com/tower" target="_blank" rel="external">https://www.ansible.com/tower</a><br>下载地址(下载免费控制10个机器的授权)：<a href="https://www.ansible.com/license" target="_blank" rel="external">https://www.ansible.com/license</a><br><a href="https://releases.ansible.com/awx/setup/" target="_blank" rel="external">ansible-tower各个版本下载地址</a><br>目前最新版为3.1.0要求：RHEL 7, CentOS 7, or Ubuntu 14.04 LTS or 16.04 LTS, and requires Ansible Core 2.1.X or later.<br>我这里系统是Centos 6.6，所以只能用Tower-3.0.3及以前的版本  </p>
<p>安装前检查：  </p>
<ol>
<li>python版本为2.6</li>
<li>保持网络畅通</li>
<li>内存预留充足，内存&gt;=2GB,/var &gt;=10GB</li>
<li>安装用户为root</li>
</ol>
<p>环境：Centos 6.6<br>　　　ansible 2.2.1.0</p>
<p>安装Tower<br>Ansible tower包含一个简单的基于文本的配置向导来配置安装你的tower，安装Tower需要使用到postgresql数据库<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#配置yum源</span></div><div class="line">注意:除了光盘源外还需要extra(CentOS-Base.repo)</div><div class="line"></div><div class="line"><span class="comment">#CentOS-Base.repo源</span></div><div class="line">[root@Ansible ~]<span class="comment"># cd /etc/yum.repos.d/</span></div><div class="line">[root@Ansible yum.repos.d]<span class="comment"># cat CentOS-Base.repo </span></div><div class="line">[base]</div><div class="line">name=CentOS-<span class="variable">$releasever</span> - Base</div><div class="line">mirrorlist=http://mirrorlist.centos.org/?release=<span class="variable">$releasever</span>&amp;arch=<span class="variable">$basearch</span>&amp;repo=os&amp;infra=<span class="variable">$infra</span></div><div class="line"><span class="comment">#baseurl=http://mirror.centos.org/centos/$releasever/os/$basearch/</span></div><div class="line">gpgcheck=0</div><div class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-6</div><div class="line"></div><div class="line"><span class="comment">#released updates </span></div><div class="line">[updates]</div><div class="line">name=CentOS-<span class="variable">$releasever</span> - Updates</div><div class="line">mirrorlist=http://mirrorlist.centos.org/?release=<span class="variable">$releasever</span>&amp;arch=<span class="variable">$basearch</span>&amp;repo=updates&amp;infra=<span class="variable">$infra</span></div><div class="line"><span class="comment">#baseurl=http://mirror.centos.org/centos/$releasever/updates/$basearch/</span></div><div class="line">gpgcheck=1</div><div class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-6</div><div class="line"></div><div class="line"><span class="comment">#additional packages that may be useful</span></div><div class="line">[extras]</div><div class="line">name=CentOS-<span class="variable">$releasever</span> - Extras</div><div class="line">mirrorlist=http://mirrorlist.centos.org/?release=<span class="variable">$releasever</span>&amp;arch=<span class="variable">$basearch</span>&amp;repo=extras&amp;infra=<span class="variable">$infra</span></div><div class="line"><span class="comment">#baseurl=http://mirror.centos.org/centos/$releasever/extras/$basearch/</span></div><div class="line">gpgcheck=1</div><div class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-6</div><div class="line"></div><div class="line"><span class="comment">#additional packages that extend functionality of existing packages</span></div><div class="line">[centosplus]</div><div class="line">name=CentOS-<span class="variable">$releasever</span> - Plus</div><div class="line">mirrorlist=http://mirrorlist.centos.org/?release=<span class="variable">$releasever</span>&amp;arch=<span class="variable">$basearch</span>&amp;repo=centosplus&amp;infra=<span class="variable">$infra</span></div><div class="line"><span class="comment">#baseurl=http://mirror.centos.org/centos/$releasever/centosplus/$basearch/</span></div><div class="line">gpgcheck=1</div><div class="line">enabled=0</div><div class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-6</div><div class="line"></div><div class="line"><span class="comment">#contrib - packages by Centos Users</span></div><div class="line">[contrib]</div><div class="line">name=CentOS-<span class="variable">$releasever</span> - Contrib</div><div class="line">mirrorlist=http://mirrorlist.centos.org/?release=<span class="variable">$releasever</span>&amp;arch=<span class="variable">$basearch</span>&amp;repo=contrib&amp;infra=<span class="variable">$infra</span></div><div class="line"><span class="comment">#baseurl=http://mirror.centos.org/centos/$releasever/contrib/$basearch/</span></div><div class="line">gpgcheck=1</div><div class="line">enabled=0</div><div class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-6</div><div class="line">[root@Ansible yum.repos.d]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Ansible-Tower的yum源</span></div><div class="line">[root@Ansible yum.repos.d]<span class="comment"># cat Ansible-Tower.repo </span></div><div class="line">[Ansible-Tower]</div><div class="line">name=Ansible Tower Repository - <span class="variable">$releasever</span> <span class="variable">$basearch</span></div><div class="line">baseurl=http://releases.ansible.com/ansible-tower/rpm/epel-6-<span class="variable">$basearch</span></div><div class="line">enabled=1</div><div class="line">gpgcheck=0</div><div class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-ansible-release</div><div class="line">[root@Ansible yum.repos.d]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">[root@Ansible yum.repos.d]<span class="comment"># cat yum.repo </span></div><div class="line">[nginx]</div><div class="line">name=nginx repo</div><div class="line">baseurl=http://nginx.org/packages/centos/6/<span class="variable">$basearch</span>/</div><div class="line">gpgcheck=0</div><div class="line">enabled=1</div><div class="line">  </div><div class="line">[webtatic]</div><div class="line">name=Webtatic Repository EL6 - <span class="variable">$basearch</span></div><div class="line">baseurl=http://repo.webtatic.com/yum/el6/<span class="variable">$basearch</span>/</div><div class="line"><span class="comment">#mirrorlist=http://mirror.webtatic.com/yum/el6/$basearch/mirrorlist</span></div><div class="line">failovermethod=priority</div><div class="line">enabled=1</div><div class="line">gpgcheck=0</div><div class="line"></div><div class="line">[epel] </div><div class="line">name=Extra Packages <span class="keyword">for</span> Enterprise Linux 6 - <span class="variable">$basearch</span> </div><div class="line">baseurl=http://mirrors.aliyun.com/epel/6/<span class="variable">$basearch</span> </div><div class="line">http://mirrors.aliyuncs.com/epel/6/<span class="variable">$basearch</span> </div><div class="line">mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-6&amp;arch=<span class="variable">$basearch</span> </div><div class="line">failovermethod=priority </div><div class="line">enabled=1 </div><div class="line">gpgcheck=0</div><div class="line"></div><div class="line">[remi]</div><div class="line">name=Les RPM de remi pour Enterprise Linux 6 - <span class="variable">$basearch</span></div><div class="line"><span class="comment">#baseurl=http://rpms.famillecollet.com/enterprise/6/remi/$basearch/</span></div><div class="line">mirrorlist=http://rpms.famillecollet.com/enterprise/6/remi/mirror</div><div class="line">enabled=1</div><div class="line">gpgcheck=0</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#安装Tower</span></div><div class="line">[root@Ansible ~]<span class="comment"># wget https://releases.ansible.com/awx/setup/ansible-tower-setup-3.0.3.tar.gz</span></div><div class="line">[root@Ansible ~]<span class="comment"># tar -zxf ansible-tower-setup-3.0.3.tar.gz</span></div><div class="line">[root@Ansible ~]<span class="comment"># cd ansible-tower-setup-3.0.3</span></div><div class="line">[root@Ansible ansible-tower-setup-3.0.3]<span class="comment"># ./setup.sh</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#安装到一半如果在这里报错，是因为连不上数据库，启动postgresql即可</span></div><div class="line">TASK [awx_install : Migrate the Tower database schema (may take awhile when upgrading).] ***</div><div class="line"></div><div class="line"><span class="comment">#解决办法</span></div><div class="line">[root@Ansible ~]<span class="comment"># service postgresql-9.4 initdb</span></div><div class="line">[root@Ansible ~]<span class="comment"># service postgresql-9.4 start</span></div><div class="line">[root@Ansible ~]<span class="comment"># chkconfig postgresql on</span></div><div class="line"></div><div class="line"><span class="comment">#创建用户</span></div><div class="line">[root@Ansible ~]<span class="comment"># id postgres</span></div><div class="line">uid=26(postgres) gid=26(postgres) groups=26(postgres)</div><div class="line">[root@Ansible ~]<span class="comment"># su - postgres</span></div><div class="line">-bash-4.1$ psql</div><div class="line">psql (9.4.11)</div><div class="line">Type <span class="string">"help"</span> <span class="keyword">for</span> help.</div><div class="line"></div><div class="line">postgres=<span class="comment"># CREATE ROLE awx CREATEDB PASSWORD 'admin' LOGIN; </span></div><div class="line">CREATE ROLE</div><div class="line">postgres=<span class="comment"># \q</span></div><div class="line">-bash-4.1$ <span class="built_in">exit</span></div><div class="line"><span class="built_in">logout</span></div><div class="line">[root@Ansible ~]<span class="comment"># sed -i 's#peer#md5#g' /var/lib/pgsql/9.4/data/pg_hba.conf</span></div><div class="line">[root@Ansible ~]<span class="comment"># sed -i 's#ident#md5#g' /var/lib/pgsql/9.4/data/pg_hba.conf</span></div><div class="line">[root@Ansible ~]<span class="comment"># service postgresql-9.4 restart</span></div><div class="line">Stopping postgresql-9.4 service:                           [  OK  ]</div><div class="line">Starting postgresql-9.4 service:                           [  OK  ]</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">测试awx用户连接，输入密码连接，并创建数据库</div><div class="line">[root@Ansible ~]<span class="comment"># psql -U awx -d postgres -h 127.0.0.1</span></div><div class="line">Password <span class="keyword">for</span> user awx: </div><div class="line">psql (9.4.11)</div><div class="line">Type <span class="string">"help"</span> <span class="keyword">for</span> help.</div><div class="line"></div><div class="line">postgres=&gt; create database awx;</div><div class="line">CREATE DATABASE</div><div class="line">postgres=&gt; \q</div><div class="line">[root@Ansible ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>再次./setup.sh进行安装tower<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#inventory配置</span></div><div class="line">[root@Ansible ansible-tower-setup-3.0.3]<span class="comment"># grep -v ^$ inventory</span></div><div class="line">[primary]</div><div class="line">localhost ansible_connection=<span class="built_in">local</span></div><div class="line">[secondary]</div><div class="line">[database]</div><div class="line">[all:vars]</div><div class="line">admin_password=<span class="string">'admin'</span></div><div class="line">redis_password=<span class="string">'1234567'</span></div><div class="line">pg_host=<span class="string">'127.0.0.1'</span></div><div class="line">pg_port=<span class="string">'5432'</span></div><div class="line">pg_database=<span class="string">'awx'</span></div><div class="line">pg_username=<span class="string">'awx'</span></div><div class="line">pg_password=<span class="string">'admin'</span></div><div class="line">[root@Ansible ansible-tower-setup-3.0.3]<span class="comment">#</span></div><div class="line"></div><div class="line">[root@Ansible ansible-tower-setup-3.0.3]<span class="comment"># ./setup.sh</span></div><div class="line">···</div><div class="line">The setup process completed successfully.</div></pre></td></tr></table></figure></p>
<p>访问<a href="http://ip/" target="_blank" rel="external">http://ip/</a> 打开Ansible Tower Dashboard<br><img src="http://note.youdao.com/yws/api/personal/file/2F9139842F074D2BB72B5489E557F6E1?method=download&amp;shareKey=00f221946a4cbec628661e1b4e47529e" alt="image">  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/6E0779F0097A4E50BCB1180C06BC4B5E?method=download&amp;shareKey=4bfd38e9671683e36b4438b0e5f5421d" alt="image">  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/C6B06B214ECF42F89AC434B10E906B05?method=download&amp;shareKey=012de0283dbb99bbc60d74040de5e7dd" alt="image"><br>安装成功  </p>
<p>参考：<a href="http://www.jianshu.com/p/1c6aa6ceeca6" target="_blank" rel="external">http://www.jianshu.com/p/1c6aa6ceeca6</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="https://yfshare.github.io">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="https://yfshare.github.io/2017/03/07/部署Ansible-Tower/">https://yfshare.github.io/2017/03/07/部署Ansible-Tower/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Ansible Tower (以前叫’AWX’)是能够帮助任何IT团队更容易使用Ansible的解决方案。该方案基于web&lt;br&gt;Tower允许对用户进行权限控制，即使某用户不能传送某SSH凭证，你也可以通过Tower来对该用户共享该凭证。我们可以通过图形化界面来管理Inventory，也可以对各种各样的云资源做同步。Tower可以记录所有job的日志，也可以与LDAP集成，并且拥有强大的可浏览的REST API。Tower也提供了命令行工具，可以与Jenkins轻松集成。Provisioning回调对自动伸缩拓扑图提供了强大的支持&lt;br&gt;
    
    </summary>
    
      <category term="Ansible" scheme="https://yfshare.github.io/categories/Ansible/"/>
    
    
      <category term="Ansible" scheme="https://yfshare.github.io/tags/Ansible/"/>
    
      <category term="Tower" scheme="https://yfshare.github.io/tags/Tower/"/>
    
  </entry>
  
  <entry>
    <title>Oracle数据库备份与恢复 - RMAN备份</title>
    <link href="https://yfshare.github.io/2017/02/28/Oracle%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D-RMAN%E5%A4%87%E4%BB%BD/"/>
    <id>https://yfshare.github.io/2017/02/28/Oracle数据库备份与恢复-RMAN备份/</id>
    <published>2017-02-28T02:42:42.000Z</published>
    <updated>2017-02-28T06:37:34.000Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>如果要说DBA工作中最重要的职责（没有之一），那无疑就是保证客户数据的安全和完整，可以看到几乎任何一本Oracle DBA的技术书籍一定都会把大篇幅来介绍数据库的备份与恢复，从中也可以看到备份和恢复的重要程度。<a href="http://www.eygle.com/" target="_blank" rel="external">eygle</a>曾经总结了<a href="http://www.eygle.com/archives/2006/03/the_four_rule_for_dba.html" target="_blank" rel="external">DBA生存之四大守则</a>的第一条就是：备份重于一切<br><em>我们必需知道,系统总是要崩溃的，没有有效的备份只是等哪一天死！我经常开玩笑的说,唯一会使DBA在梦中惊醒的就是,没有有效的备份.</em><br><a id="more"></a></p>
<h2 id="RMAN概览"><a href="#RMAN概览" class="headerlink" title="RMAN概览"></a>RMAN概览</h2><p>RMAN是Oracle数据库软件自带的备份/恢复工具。RMAN只能用于9i或更高的版本中。它能够备份整个数据库或数据库部件，如表空间、数据文件、控制文件、归档文件以及Spfile参数文件。通过RMAN的方式无论是要备份还是要恢复，都必须先启动实例并加载数据库。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">From Wiki：RMAN (Recovery Manager) is a backup and recovery manager supplied <span class="keyword">for</span> Oracle databases (from version 8) created by the Oracle Corporation. It provides database backup, restore, and recovery capabilities addressing high availability and disaster recovery concerns. Oracle Corporation recommends RMAN as its preferred method <span class="keyword">for</span> backup and recovery and has written <span class="built_in">command</span>-line and graphical (via Oracle Enterprise Manager) interfaces <span class="keyword">for</span> the product.</div></pre></td></tr></table></figure></p>
<h2 id="RMAN之备份"><a href="#RMAN之备份" class="headerlink" title="RMAN之备份"></a>RMAN之备份</h2><p>连接数据库<br>很简单，进入到命令提示符界面：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[oracle@orcl ~]$ rman target /</div><div class="line">Recovery Manager: Release 11.2.0.4.0 - Production on Tue Feb 28 10:51:34 2017</div><div class="line">Copyright (c) 1982, 2011, Oracle and/or its affiliates.  All rights reserved.</div><div class="line">connected to target database: ORCL (DBID=1455780274)</div><div class="line">RMAN&gt;</div></pre></td></tr></table></figure></p>
<p>也可以先启动RMAN，然后再通过CONNECT命令来连接目标数据库：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[oracle@orcl ~]$ rman</div><div class="line">Recovery Manager: Release 11.2.0.4.0 - Production on Tue Feb 28 10:52:45 2017</div><div class="line">Copyright (c) 1982, 2011, Oracle and/or its affiliates.  All rights reserved.</div><div class="line">RMAN&gt; connect target /</div><div class="line">connected to target database: ORCL (DBID=1455780274)</div><div class="line">RMAN&gt;</div></pre></td></tr></table></figure></p>
<p>使用RMAN来做各种类型的备份</p>
<ol>
<li>整库备份<br>整库备份的命令很简单，就是backup database<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; backup database;</div><div class="line"></div><div class="line">Starting backup at 28-FEB-17</div><div class="line">using target database control file instead of recovery catalog</div><div class="line">allocated channel: ORA_DISK_1</div><div class="line">channel ORA_DISK_1: SID=1717 device <span class="built_in">type</span>=DISK</div><div class="line">channel ORA_DISK_1: starting full datafile backup <span class="built_in">set</span></div><div class="line">channel ORA_DISK_1: specifying datafile(s) <span class="keyword">in</span> backup <span class="built_in">set</span></div><div class="line">input datafile file number=00001 name=/u01/data/orcl/system01.dbf</div><div class="line">input datafile file number=00002 name=/u01/data/orcl/sysaux01.dbf</div><div class="line">input datafile file number=00003 name=/u01/data/orcl/undotbs01.dbf</div><div class="line">input datafile file number=00004 name=/u01/data/orcl/users01.dbf</div><div class="line">input datafile file number=00007 name=/u01/data/orcl/dev_paydb.dbf</div><div class="line">input datafile file number=00008 name=/u01/data/orcl/dev_payboxdb.dbf</div><div class="line">input datafile file number=00009 name=/u01/data/orcl/ticket.dbf</div><div class="line">input datafile file number=00005 name=/u01/data/orcl/PAYBOX_FG_PRO.dbf</div><div class="line">input datafile file number=00006 name=/u01/data/orcl/PAYBOX_TEST2SP.dbf</div><div class="line">channel ORA_DISK_1: starting piece 1 at 28-FEB-17</div><div class="line">channel ORA_DISK_1: finished piece 1 at 28-FEB-17</div><div class="line">piece handle=/u01/app/oracle/product/11.2.0.4/db_1/dbs/01rtn1md_1_1 tag=TAG20170228T105613 comment=NONE</div><div class="line">channel ORA_DISK_1: backup <span class="built_in">set</span> complete, elapsed time: 00:40:26</div><div class="line">channel ORA_DISK_1: starting full datafile backup <span class="built_in">set</span></div><div class="line">channel ORA_DISK_1: specifying datafile(s) <span class="keyword">in</span> backup <span class="built_in">set</span></div><div class="line">including current control file <span class="keyword">in</span> backup <span class="built_in">set</span></div><div class="line">including current SPFILE <span class="keyword">in</span> backup <span class="built_in">set</span></div><div class="line">channel ORA_DISK_1: starting piece 1 at 28-FEB-17</div><div class="line">channel ORA_DISK_1: finished piece 1 at 28-FEB-17</div><div class="line">piece handle=/u01/app/oracle/product/11.2.0.4/db_1/dbs/02rtn428_1_1 tag=TAG20170228T105613 comment=NONE</div><div class="line">channel ORA_DISK_1: backup <span class="built_in">set</span> complete, elapsed time: 00:00:01</div><div class="line">Finished backup at 28-FEB-17</div><div class="line"></div><div class="line">RMAN&gt;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>整库备份集生成了两个备份片段：一个存储数据文件，另一个存储控制文件和SPFILE（服务器端初始化参数文件），都被保存到Oracle软件的安装目录下，这是因为没有为备份集指定存储路径，默认情况下就会存储到Oracle软件的安装目录中</p>
<p>真正的备份操作，你肯定希望能够指定备份集的存储位置，没问题，最简单的方式是在执行BACKUP命令时，指定FORMAT参数来自定义备份片段的路径和命令规则<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; BACKUP DATABASE FORMAT <span class="string">'/u01/data/db_bk/bak_%U'</span>;</div></pre></td></tr></table></figure></p>
<p>查看创建的全库备份<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; LIST BACKUP OF DATABASE;</div><div class="line"></div><div class="line">List of Backup Sets</div><div class="line">===================</div><div class="line"></div><div class="line">BS Key  Type LV Size       Device Type Elapsed Time Completion Time</div><div class="line">------- ---- -- ---------- ----------- ------------ ---------------</div><div class="line">1       Full    4.99G      DISK        00:40:17     28-FEB-17      </div><div class="line">        BP Key: 1   Status: AVAILABLE  Compressed: NO  Tag: TAG20170228T105613</div><div class="line">        Piece Name: /u01/app/oracle/product/11.2.0.4/db_1/dbs/01rtn1md_1_1</div><div class="line">  List of Datafiles <span class="keyword">in</span> backup <span class="built_in">set</span> 1</div><div class="line">  File LV Type Ckp SCN    Ckp Time  Name</div><div class="line">  ---- -- ---- ---------- --------- ----</div><div class="line">  1       Full 37643780   28-FEB-17 /u01/data/orcl/system01.dbf</div><div class="line">  2       Full 37643780   28-FEB-17 /u01/data/orcl/sysaux01.dbf</div><div class="line">  3       Full 37643780   28-FEB-17 /u01/data/orcl/undotbs01.dbf</div><div class="line">  4       Full 37643780   28-FEB-17 /u01/data/orcl/users01.dbf</div><div class="line">  5       Full 37643780   28-FEB-17 /u01/data/orcl/PAYBOX_FG_PRO.dbf</div><div class="line">  6       Full 37643780   28-FEB-17 /u01/data/orcl/PAYBOX_TEST2SP.dbf</div><div class="line">  7       Full 37643780   28-FEB-17 /u01/data/orcl/dev_paydb.dbf</div><div class="line">  8       Full 37643780   28-FEB-17 /u01/data/orcl/dev_payboxdb.dbf</div><div class="line">  9       Full 37643780   28-FEB-17 /u01/data/orcl/ticket.dbf</div><div class="line"></div><div class="line">RMAN&gt;</div></pre></td></tr></table></figure></p>
<ol>
<li>表空间的备份<br>rman还可以针对表空间备份<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; BACKUP TABLESPACE USERS;</div><div class="line"></div><div class="line">Starting backup at 28-FEB-17</div><div class="line">using channel ORA_DISK_1</div><div class="line">channel ORA_DISK_1: starting full datafile backup <span class="built_in">set</span></div><div class="line">channel ORA_DISK_1: specifying datafile(s) <span class="keyword">in</span> backup <span class="built_in">set</span></div><div class="line">input datafile file number=00004 name=/u01/data/orcl/users01.dbf</div><div class="line">channel ORA_DISK_1: starting piece 1 at 28-FEB-17</div><div class="line">channel ORA_DISK_1: finished piece 1 at 28-FEB-17</div><div class="line">piece handle=/u01/app/oracle/product/11.2.0.4/db_1/dbs/03rtn5li_1_1 tag=TAG20170228T120402 comment=NONE</div><div class="line">channel ORA_DISK_1: backup <span class="built_in">set</span> complete, elapsed time: 00:01:05</div><div class="line">Finished backup at 28-FEB-17</div><div class="line"></div><div class="line">RMAN&gt;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>查看表空间的备份<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; LIST BACKUP OF TABLESPACE USERS;</div><div class="line"></div><div class="line">List of Backup Sets</div><div class="line">===================</div><div class="line"></div><div class="line">BS Key  Type LV Size       Device Type Elapsed Time Completion Time</div><div class="line">------- ---- -- ---------- ----------- ------------ ---------------</div><div class="line">1       Full    4.99G      DISK        00:40:17     28-FEB-17      </div><div class="line">        BP Key: 1   Status: AVAILABLE  Compressed: NO  Tag: TAG20170228T105613</div><div class="line">        Piece Name: /u01/app/oracle/product/11.2.0.4/db_1/dbs/01rtn1md_1_1</div><div class="line">  List of Datafiles <span class="keyword">in</span> backup <span class="built_in">set</span> 1</div><div class="line">  File LV Type Ckp SCN    Ckp Time  Name</div><div class="line">  ---- -- ---- ---------- --------- ----</div><div class="line">  4       Full 37643780   28-FEB-17 /u01/data/orcl/users01.dbf</div><div class="line"></div><div class="line">BS Key  Type LV Size       Device Type Elapsed Time Completion Time</div><div class="line">------- ---- -- ---------- ----------- ------------ ---------------</div><div class="line">3       Full    415.72M    DISK        00:00:59     28-FEB-17      </div><div class="line">        BP Key: 3   Status: AVAILABLE  Compressed: NO  Tag: TAG20170228T120402</div><div class="line">        Piece Name: /u01/app/oracle/product/11.2.0.4/db_1/dbs/03rtn5li_1_1</div><div class="line">  List of Datafiles <span class="keyword">in</span> backup <span class="built_in">set</span> 3</div><div class="line">  File LV Type Ckp SCN    Ckp Time  Name</div><div class="line">  ---- -- ---- ---------- --------- ----</div><div class="line">  4       Full 37647157   28-FEB-17 /u01/data/orcl/users01.dbf</div><div class="line"></div><div class="line">RMAN&gt;</div></pre></td></tr></table></figure></p>
<p>这里发现USER表空间存在2份备份（因为之前做过一次全量备份）</p>
<p>删除指定的BACKUPSET<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; DELETE BACKUPSET 3;</div><div class="line">using channel ORA_DISK_1</div><div class="line"></div><div class="line">List of Backup Pieces</div><div class="line">BP Key  BS Key  Pc<span class="comment"># Cp# Status      Device Type Piece Name</span></div><div class="line">------- ------- --- --- ----------- ----------- ----------</div><div class="line">3       3       1   1   AVAILABLE   DISK        /u01/app/oracle/product/11.2.0.4/db_1/dbs/03rtn5li_1_1</div><div class="line"></div><div class="line">Do you really want to delete the above objects (enter YES or NO)? YES</div><div class="line">deleted backup piece</div><div class="line">backup piece handle=/u01/app/oracle/product/11.2.0.4/db_1/dbs/03rtn5li_1_1 RECID=3 STAMP=937137843</div><div class="line">Deleted 1 objects</div><div class="line"></div><div class="line">RMAN&gt;</div></pre></td></tr></table></figure></p>
<ol>
<li>数据文件的备份<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">SQL&gt; select file<span class="comment">#,name from v$datafile;</span></div><div class="line"></div><div class="line">     FILE<span class="comment"># NAME</span></div><div class="line">---------- --------------------------------------------------</div><div class="line">	 1 /u01/data/orcl/system01.dbf</div><div class="line">	 2 /u01/data/orcl/sysaux01.dbf</div><div class="line">	 3 /u01/data/orcl/undotbs01.dbf</div><div class="line">	 4 /u01/data/orcl/users01.dbf</div><div class="line">	 5 /u01/data/orcl/PAYBOX_FG_PRO.dbf</div><div class="line">	 6 /u01/data/orcl/PAYBOX_TEST2SP.dbf</div><div class="line">	 7 /u01/data/orcl/dev_paydb.dbf</div><div class="line">	 8 /u01/data/orcl/dev_payboxdb.dbf</div><div class="line">	 9 /u01/data/orcl/ticket.dbf</div><div class="line"></div><div class="line">9 rows selected.</div><div class="line"></div><div class="line">SQL&gt;</div></pre></td></tr></table></figure>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; BACKUP DATAFILE <span class="string">'/u01/data/orcl/users01.dbf'</span>;</div><div class="line"></div><div class="line">Starting backup at 28-FEB-17</div><div class="line">using channel ORA_DISK_1</div><div class="line">channel ORA_DISK_1: starting full datafile backup <span class="built_in">set</span></div><div class="line">channel ORA_DISK_1: specifying datafile(s) <span class="keyword">in</span> backup <span class="built_in">set</span></div><div class="line">input datafile file number=00004 name=/u01/data/orcl/users01.dbf</div><div class="line">channel ORA_DISK_1: starting piece 1 at 28-FEB-17</div><div class="line">channel ORA_DISK_1: finished piece 1 at 28-FEB-17</div><div class="line">piece handle=/u01/app/oracle/product/11.2.0.4/db_1/dbs/04rtn83l_1_1 tag=TAG20170228T124540 comment=NONE</div><div class="line">channel ORA_DISK_1: backup <span class="built_in">set</span> complete, elapsed time: 00:00:07</div><div class="line">Finished backup at 28-FEB-17</div><div class="line"></div><div class="line">RMAN&gt;</div></pre></td></tr></table></figure>
<ol>
<li>控制文件备份<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; BACKUP CURRENT CONTROLFILE;</div><div class="line"></div><div class="line">Starting backup at 28-FEB-17</div><div class="line">using channel ORA_DISK_1</div><div class="line">channel ORA_DISK_1: starting full datafile backup <span class="built_in">set</span></div><div class="line">channel ORA_DISK_1: specifying datafile(s) <span class="keyword">in</span> backup <span class="built_in">set</span></div><div class="line">including current control file <span class="keyword">in</span> backup <span class="built_in">set</span></div><div class="line">channel ORA_DISK_1: starting piece 1 at 28-FEB-17</div><div class="line">channel ORA_DISK_1: finished piece 1 at 28-FEB-17</div><div class="line">piece handle=/u01/app/oracle/product/11.2.0.4/db_1/dbs/05rtn873_1_1 tag=TAG20170228T124731 comment=NONE</div><div class="line">channel ORA_DISK_1: backup <span class="built_in">set</span> complete, elapsed time: 00:00:01</div><div class="line">Finished backup at 28-FEB-17</div><div class="line"></div><div class="line">RMAN&gt;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>查看控制文件备份<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; LIST BACKUP OF CONTROLFILE;</div><div class="line"></div><div class="line">List of Backup Sets</div><div class="line">===================</div><div class="line"></div><div class="line">BS Key  Type LV Size       Device Type Elapsed Time Completion Time</div><div class="line">------- ---- -- ---------- ----------- ------------ ---------------</div><div class="line">2       Full    9.39M      DISK        00:00:05     28-FEB-17      </div><div class="line">        BP Key: 2   Status: AVAILABLE  Compressed: NO  Tag: TAG20170228T105613</div><div class="line">        Piece Name: /u01/app/oracle/product/11.2.0.4/db_1/dbs/02rtn428_1_1</div><div class="line">  Control File Included: Ckp SCN: 37645877     Ckp time: 28-FEB-17</div><div class="line"></div><div class="line">BS Key  Type LV Size       Device Type Elapsed Time Completion Time</div><div class="line">------- ---- -- ---------- ----------- ------------ ---------------</div><div class="line">5       Full    9.36M      DISK        00:00:01     28-FEB-17      </div><div class="line">        BP Key: 5   Status: AVAILABLE  Compressed: NO  Tag: TAG20170228T124731</div><div class="line">        Piece Name: /u01/app/oracle/product/11.2.0.4/db_1/dbs/05rtn873_1_1</div><div class="line">  Control File Included: Ckp SCN: 37648397     Ckp time: 28-FEB-17</div><div class="line"></div><div class="line">RMAN&gt;</div></pre></td></tr></table></figure></p>
<ol>
<li>归档文件的备份<br>归档日志对于数据库介质恢复相当关键，只要拥有相应的归档日志文件，就能确保我们将数据库恢复到备份之后的任意时刻。在RMAN中备份归档日志有以下两种方式：</li>
</ol>
<ul>
<li>利用BACKUP ARCHIVELOG命令备份<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; BACKUP ARCHIVELOG ALL;</div><div class="line"></div><div class="line">Starting backup at 28-FEB-17</div><div class="line">current <span class="built_in">log</span> archived</div><div class="line">using channel ORA_DISK_1</div><div class="line">channel ORA_DISK_1: starting archived <span class="built_in">log</span> backup <span class="built_in">set</span></div><div class="line">channel ORA_DISK_1: specifying archived <span class="built_in">log</span>(s) <span class="keyword">in</span> backup <span class="built_in">set</span></div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=868 RECID=1 STAMP=937050974</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=871 RECID=2 STAMP=937050978</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=872 RECID=3 STAMP=937050981</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=873 RECID=4 STAMP=937052764</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=874 RECID=5 STAMP=937052771</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=875 RECID=6 STAMP=937073029</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=876 RECID=7 STAMP=937079244</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=877 RECID=8 STAMP=937087288</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=878 RECID=9 STAMP=937108830</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=879 RECID=10 STAMP=937124801</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=880 RECID=11 STAMP=937140632</div><div class="line">channel ORA_DISK_1: starting piece 1 at 28-FEB-17</div><div class="line">channel ORA_DISK_1: finished piece 1 at 28-FEB-17</div><div class="line">piece handle=/u01/app/oracle/product/11.2.0.4/db_1/dbs/06rtn8cp_1_1 tag=TAG20170228T125032 comment=NONE</div><div class="line">channel ORA_DISK_1: backup <span class="built_in">set</span> complete, elapsed time: 00:00:15</div><div class="line">Finished backup at 28-FEB-17</div><div class="line"></div><div class="line">RMAN&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>BACKUP ARCHIVELOG命令比较灵活，ALL是指备份当前所有可访问到的归档文件，你还可以通过UNTIL、SCN、TIME、SEQUENCE等参数灵活指定要备份的归档区间。</p>
<ul>
<li>执行BACKUP命令时指定PLUS ARCHIVELOG子句<br>在备份控制文件之前<strong>首先对所有归档文件进行备份</strong>，BACKUP…PLUS ARCHIVELOG命令在备份过程中会依次执行下列步骤:</li>
</ul>
<ol>
<li>运行ALTER SYSTEM ARCHIVE LOG CURRENT语句对当前 Redolog 进行归档</li>
<li>执行BACKUP ARCHIVELOG ALL命令备份所有已归档日志</li>
<li>执行BACKUP命令对指定项进行备份</li>
<li>再次运行ALTER SYSTEM ARCHIVE LOG CURRENT对当前 Redolog 归档</li>
<li>对新生成的尚未备份的归档文件进行备份<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; BACKUP CURRENT CONTROLFILE PLUS ARCHIVELOG;</div><div class="line"></div><div class="line">Starting backup at 28-FEB-17</div><div class="line">current <span class="built_in">log</span> archived</div><div class="line">using channel ORA_DISK_1</div><div class="line">channel ORA_DISK_1: starting archived <span class="built_in">log</span> backup <span class="built_in">set</span></div><div class="line">channel ORA_DISK_1: specifying archived <span class="built_in">log</span>(s) <span class="keyword">in</span> backup <span class="built_in">set</span></div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=868 RECID=1 STAMP=937050974</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=871 RECID=2 STAMP=937050978</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=872 RECID=3 STAMP=937050981</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=873 RECID=4 STAMP=937052764</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=874 RECID=5 STAMP=937052771</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=875 RECID=6 STAMP=937073029</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=876 RECID=7 STAMP=937079244</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=877 RECID=8 STAMP=937087288</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=878 RECID=9 STAMP=937108830</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=879 RECID=10 STAMP=937124801</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=880 RECID=11 STAMP=937140632</div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=881 RECID=12 STAMP=937140870</div><div class="line">channel ORA_DISK_1: starting piece 1 at 28-FEB-17</div><div class="line">channel ORA_DISK_1: finished piece 1 at 28-FEB-17</div><div class="line">piece handle=/u01/app/oracle/product/11.2.0.4/db_1/dbs/07rtn8k6_1_1 tag=TAG20170228T125430 comment=NONE</div><div class="line">channel ORA_DISK_1: backup <span class="built_in">set</span> complete, elapsed time: 00:00:03</div><div class="line">Finished backup at 28-FEB-17</div><div class="line"></div><div class="line">Starting backup at 28-FEB-17</div><div class="line">using channel ORA_DISK_1</div><div class="line">channel ORA_DISK_1: starting full datafile backup <span class="built_in">set</span></div><div class="line">channel ORA_DISK_1: specifying datafile(s) <span class="keyword">in</span> backup <span class="built_in">set</span></div><div class="line">including current control file <span class="keyword">in</span> backup <span class="built_in">set</span></div><div class="line">channel ORA_DISK_1: starting piece 1 at 28-FEB-17</div><div class="line">channel ORA_DISK_1: finished piece 1 at 28-FEB-17</div><div class="line">piece handle=/u01/app/oracle/product/11.2.0.4/db_1/dbs/08rtn8ka_1_1 tag=TAG20170228T125434 comment=NONE</div><div class="line">channel ORA_DISK_1: backup <span class="built_in">set</span> complete, elapsed time: 00:00:01</div><div class="line">Finished backup at 28-FEB-17</div><div class="line"></div><div class="line">Starting backup at 28-FEB-17</div><div class="line">current <span class="built_in">log</span> archived</div><div class="line">using channel ORA_DISK_1</div><div class="line">channel ORA_DISK_1: starting archived <span class="built_in">log</span> backup <span class="built_in">set</span></div><div class="line">channel ORA_DISK_1: specifying archived <span class="built_in">log</span>(s) <span class="keyword">in</span> backup <span class="built_in">set</span></div><div class="line">input archived <span class="built_in">log</span> thread=1 sequence=882 RECID=13 STAMP=937140878</div><div class="line">channel ORA_DISK_1: starting piece 1 at 28-FEB-17</div><div class="line">channel ORA_DISK_1: finished piece 1 at 28-FEB-17</div><div class="line">piece handle=/u01/app/oracle/product/11.2.0.4/db_1/dbs/09rtn8ke_1_1 tag=TAG20170228T125438 comment=NONE</div><div class="line">channel ORA_DISK_1: backup <span class="built_in">set</span> complete, elapsed time: 00:00:01</div><div class="line">Finished backup at 28-FEB-17</div><div class="line"></div><div class="line">RMAN&gt;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>完成备份之后，可以通过下列命令查看已备份的归档日志片段<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; LIST BACKUP OF ARCHIVELOG ALL;</div><div class="line"></div><div class="line">List of Backup Sets</div><div class="line">===================</div><div class="line"></div><div class="line">BS Key  Size       Device Type Elapsed Time Completion Time</div><div class="line">------- ---------- ----------- ------------ ---------------</div><div class="line">6       319.98M    DISK        00:00:07     28-FEB-17      </div><div class="line">        BP Key: 6   Status: AVAILABLE  Compressed: NO  Tag: TAG20170228T125032</div><div class="line">        Piece Name: /u01/app/oracle/product/11.2.0.4/db_1/dbs/06rtn8cp_1_1</div><div class="line"></div><div class="line">  List of Archived Logs <span class="keyword">in</span> backup <span class="built_in">set</span> 6</div><div class="line">  Thrd Seq     Low SCN    Low Time  Next SCN   Next Time</div><div class="line">  ---- ------- ---------- --------- ---------- ---------</div><div class="line">  1    868     37498935   24-FEB-17 37505736   24-FEB-17</div><div class="line">  1    871     37537046   25-FEB-17 37548296   25-FEB-17</div><div class="line">  1    872     37548296   25-FEB-17 37574822   27-FEB-17</div><div class="line">  1    873     37574822   27-FEB-17 37577191   27-FEB-17</div><div class="line">  1    874     37577191   27-FEB-17 37577232   27-FEB-17</div><div class="line">  1    875     37577232   27-FEB-17 37592150   27-FEB-17</div><div class="line">  1    876     37592150   27-FEB-17 37596510   27-FEB-17</div><div class="line">  1    877     37596510   27-FEB-17 37607071   27-FEB-17</div><div class="line">  1    878     37607071   27-FEB-17 37631135   28-FEB-17</div><div class="line">  1    879     37631135   28-FEB-17 37638288   28-FEB-17</div><div class="line">  1    880     37638288   28-FEB-17 37648486   28-FEB-17</div><div class="line"></div><div class="line">BS Key  Size       Device Type Elapsed Time Completion Time</div><div class="line">------- ---------- ----------- ------------ ---------------</div><div class="line">7       319.98M    DISK        00:00:03     28-FEB-17      </div><div class="line">        BP Key: 7   Status: AVAILABLE  Compressed: NO  Tag: TAG20170228T125430</div><div class="line">        Piece Name: /u01/app/oracle/product/11.2.0.4/db_1/dbs/07rtn8k6_1_1</div><div class="line"></div><div class="line">  List of Archived Logs <span class="keyword">in</span> backup <span class="built_in">set</span> 7</div><div class="line">  Thrd Seq     Low SCN    Low Time  Next SCN   Next Time</div><div class="line">  ---- ------- ---------- --------- ---------- ---------</div><div class="line">  1    868     37498935   24-FEB-17 37505736   24-FEB-17</div><div class="line">  1    871     37537046   25-FEB-17 37548296   25-FEB-17</div><div class="line">  1    872     37548296   25-FEB-17 37574822   27-FEB-17</div><div class="line">  1    873     37574822   27-FEB-17 37577191   27-FEB-17</div><div class="line">  1    874     37577191   27-FEB-17 37577232   27-FEB-17</div><div class="line">  1    875     37577232   27-FEB-17 37592150   27-FEB-17</div><div class="line">  1    876     37592150   27-FEB-17 37596510   27-FEB-17</div><div class="line">  1    877     37596510   27-FEB-17 37607071   27-FEB-17</div><div class="line">  1    878     37607071   27-FEB-17 37631135   28-FEB-17</div><div class="line">  1    879     37631135   28-FEB-17 37638288   28-FEB-17</div><div class="line">  1    880     37638288   28-FEB-17 37648486   28-FEB-17</div><div class="line">  1    881     37648486   28-FEB-17 37648591   28-FEB-17</div><div class="line"></div><div class="line">BS Key  Size       Device Type Elapsed Time Completion Time</div><div class="line">------- ---------- ----------- ------------ ---------------</div><div class="line">9       2.50K      DISK        00:00:00     28-FEB-17      </div><div class="line">        BP Key: 9   Status: AVAILABLE  Compressed: NO  Tag: TAG20170228T125438</div><div class="line">        Piece Name: /u01/app/oracle/product/11.2.0.4/db_1/dbs/09rtn8ke_1_1</div><div class="line"></div><div class="line">  List of Archived Logs <span class="keyword">in</span> backup <span class="built_in">set</span> 9</div><div class="line">  Thrd Seq     Low SCN    Low Time  Next SCN   Next Time</div><div class="line">  ---- ------- ---------- --------- ---------- ---------</div><div class="line">  1    882     37648591   28-FEB-17 37648602   28-FEB-17</div><div class="line"></div><div class="line">RMAN&gt;</div></pre></td></tr></table></figure></p>
<ol>
<li><p>初始化参数文件的备份</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; BACKUP SPFILE;</div><div class="line"></div><div class="line">Starting backup at 28-FEB-17</div><div class="line">using channel ORA_DISK_1</div><div class="line">channel ORA_DISK_1: starting full datafile backup <span class="built_in">set</span></div><div class="line">channel ORA_DISK_1: specifying datafile(s) <span class="keyword">in</span> backup <span class="built_in">set</span></div><div class="line">including current SPFILE <span class="keyword">in</span> backup <span class="built_in">set</span></div><div class="line">channel ORA_DISK_1: starting piece 1 at 28-FEB-17</div><div class="line">channel ORA_DISK_1: finished piece 1 at 28-FEB-17</div><div class="line">piece handle=/u01/app/oracle/product/11.2.0.4/db_1/dbs/0artn91l_1_1 tag=TAG20170228T130141 comment=NONE</div><div class="line">channel ORA_DISK_1: backup <span class="built_in">set</span> complete, elapsed time: 00:00:01</div><div class="line">Finished backup at 28-FEB-17</div><div class="line"></div><div class="line">RMAN&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>对备份集备份</p>
</li>
</ol>
<ul>
<li><p>备份所有备份集</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; BACKUP BACKUPSET ALL;</div></pre></td></tr></table></figure>
</li>
<li><p>备份指定的备份集</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#n=备份集ID，可以同时指定多个，相互间以逗号分隔即可</span></div><div class="line">RMAN&gt; BACKUP BACKUPSET n;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>参考：<a href="http://blog.csdn.net/pan_tian/article/details/46766985" target="_blank" rel="external">http://blog.csdn.net/pan_tian/article/details/46766985</a></p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="https://yfshare.github.io">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="https://yfshare.github.io/2017/02/28/Oracle数据库备份与恢复-RMAN备份/">https://yfshare.github.io/2017/02/28/Oracle数据库备份与恢复-RMAN备份/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;如果要说DBA工作中最重要的职责（没有之一），那无疑就是保证客户数据的安全和完整，可以看到几乎任何一本Oracle DBA的技术书籍一定都会把大篇幅来介绍数据库的备份与恢复，从中也可以看到备份和恢复的重要程度。&lt;a href=&quot;http://www.eygle.com/&quot;&gt;eygle&lt;/a&gt;曾经总结了&lt;a href=&quot;http://www.eygle.com/archives/2006/03/the_four_rule_for_dba.html&quot;&gt;DBA生存之四大守则&lt;/a&gt;的第一条就是：备份重于一切&lt;br&gt;&lt;em&gt;我们必需知道,系统总是要崩溃的，没有有效的备份只是等哪一天死！我经常开玩笑的说,唯一会使DBA在梦中惊醒的就是,没有有效的备份.&lt;/em&gt;&lt;br&gt;
    
    </summary>
    
      <category term="oracle" scheme="https://yfshare.github.io/categories/oracle/"/>
    
    
      <category term="oracle" scheme="https://yfshare.github.io/tags/oracle/"/>
    
      <category term="RMAN" scheme="https://yfshare.github.io/tags/RMAN/"/>
    
  </entry>
  
  <entry>
    <title>Oracle数据库备份与恢复 - RMAN恢复</title>
    <link href="https://yfshare.github.io/2017/02/28/Oracle%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D-RMAN%E6%81%A2%E5%A4%8D/"/>
    <id>https://yfshare.github.io/2017/02/28/Oracle数据库备份与恢复-RMAN恢复/</id>
    <published>2017-02-28T02:06:46.000Z</published>
    <updated>2017-02-28T07:32:24.000Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><h2 id="RMAN恢复原理"><a href="#RMAN恢复原理" class="headerlink" title="RMAN恢复原理"></a>RMAN恢复原理</h2><p>首先还是得理解Oracle数据库恢复的一个原理。数据库恢复是指将数据库恢复到一个一致性的状态，整个恢复操作可以分为两个步骤，数据库修复（RESTORE）和恢复（RECOVER）<br><a href="https://docs.oracle.com/cd/B19306_01/backup.102/b14192/recov001.htm" target="_blank" rel="external">Oracle官方文档</a>上关于Restore和Recover的解释：<br> The two most important RMAN commands used in database recovery are:  </p>
<ul>
<li>RESTORE, which retrieves files from RMAN backups based on the contents of the RMAN repository</li>
<li><p>RECOVER, which performs complete or point-in-time media recovery using available datafiles and redo logs.<br>Restore是指将要恢复的文件从备份集中读取出来。<br>Recover是指应用所有重做日志，将数据库恢复到崩溃前的状态，或者应用部分REDO，将数据库恢复到指定的时间点。<br><img src="http://note.youdao.com/yws/api/personal/file/1D33C7DE579145B8A0B4B2527036349C?method=download&amp;shareKey=839a02001f760c7413f2370bc57a0092" alt="image"><br>上图是一个最典型的恢复过程，数据库在SCN=100时执行了数据库备份，在SCN=500时数据库出现介质错误，需要通过备份进行恢复  </p>
<p>操作步骤：  </p>
</li>
</ul>
<ol>
<li>首先使用SCN=100时创建的数据库备份将数据库恢复到备份时的状态，这个操作就是修复（RESTORE）</li>
<li>然后重新应用SCN 100～500之间生成的所有重做日志，这个操作就是恢复（RECOVER），最后数据库被恢复到崩溃前的状态。<br>由上可知，Oracle数据库中的备份恢复必然是先有备份，然后才能做恢复的操作。不管是RMAN备份恢复，或者是用户管理的备份和恢复，恢复操作都是从备份时间点向前进行恢复，不可能直接将当前状态向后恢复到之前的某个时间点（Oracle 10g R2新推出的Flashback Database特性开始支持，直接从当前时间点向之前的时间点恢复）</li>
</ol>
<h2 id="RMAN如何选择备份集"><a href="#RMAN如何选择备份集" class="headerlink" title="RMAN如何选择备份集"></a>RMAN如何选择备份集</h2><p>很多新接触RMAN的朋友都会有这样的疑问：我执行过很多次备份，早也备份是晚也备份，昨天也备份今天也备份，在恢复的时候，RMAN怎么知道从哪个备份集中选择文件用来恢复呢？<br>答案其实很简单，RMAN一开始也不知道，它只是遵循固定的规则，按照你的要求去寻找合适的备份集罢了，<strong>首先是寻找最近的可用的备份集</strong>（如果没有指定UNTIL子句则从最近的备份开始，如果指定了UNTIL，则从满足UNTIL的备份集开始），<strong>如果能找到，那么运气不错，恢复将会继续正常进行，如果找到了多个，还有更加细致的规则，从中选择一个RMAN觉着最优的备份集来做恢复</strong>（如优先选择镜像复制，因为RMAN认为这样恢复时会更快）。如果最终一个备份集都没找到，嘿嘿，那就只有一个选择了：报错  </p>
<h2 id="RMAN能做哪些恢复"><a href="#RMAN能做哪些恢复" class="headerlink" title="RMAN能做哪些恢复"></a>RMAN能做哪些恢复</h2><p>之前的文章<a href="https://yfshare.github.io/2017/02/28/Oracle数据库备份与恢复-RMAN备份/">Oracle数据库备份与恢复 - RMAN备份</a>里有写到RMAN可以做多种备份，包括：</p>
<ol>
<li>整库备份；</li>
<li>表空间的备份；</li>
<li>数据文件的备份；</li>
<li>控制文件备份；</li>
<li>归档文件的备份；</li>
<li>初始化参数文件的备份；  </li>
<li>对备份集备份；  </li>
</ol>
<p>对于恢复，RMAN中提供了多种不同级别的恢复方式，可以恢复整个数据库，恢复某个或某几个表空间，某个或某几个数据文件，单独恢复控制文件，初始化参数文件，或者归档文件等等。能用RMAN备份的都能恢复</p>
<h2 id="RMAN之恢复"><a href="#RMAN之恢复" class="headerlink" title="RMAN之恢复"></a>RMAN之恢复</h2><ol>
<li>对数据库进行完全恢复  </li>
</ol>
<p>如果当前数据库只剩下控制文件和SPFILE，其他数据文件因为某些原因导致全部丢失，不过幸运的是之前创建过整库的备份，并且执行备份操作之后，所有的归档文件和重做日志文件都还在，这种情况下你就可以将数据库恢复到崩溃前那一刻的状态，而这种恢复方式，就叫做完全介质恢复。<br>做数据库完全恢复，需要数据库处于MOUNT状态（如果数据库处于OPEN状态会报ORA-19573错误）<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#启动数据库到加载状态：</span></div><div class="line">RMAN&gt; STARTUP MOUNT;</div><div class="line"></div><div class="line">connected to target database (not started)</div><div class="line">Oracle instance started</div><div class="line">database mounted</div><div class="line"></div><div class="line">Total System Global Area    1071333376 bytes</div><div class="line"></div><div class="line">Fixed Size                     1375792 bytes</div><div class="line">Variable Size                637534672 bytes</div><div class="line">Database Buffers             427819008 bytes</div><div class="line">Redo Buffers                   4603904 bytes</div></pre></td></tr></table></figure></p>
<p>执行恢复操作(恢复分两步，先执行RESTORE DATABASE;，在执行RECOVER DATABASE;)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; restore database;</div><div class="line"></div><div class="line">Starting restore at 15-JUL-15</div><div class="line">allocated channel: ORA_DISK_1</div><div class="line">channel ORA_DISK_1: SID=63 device <span class="built_in">type</span>=DISK</div><div class="line"></div><div class="line">channel ORA_DISK_1: restoring datafile 00001</div><div class="line">input datafile copy RECID=2 STAMP=884555266 file name=E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\DATAFILE\O1_MF_SYSTEM_BSTBH904_.DBF</div><div class="line">destination <span class="keyword">for</span> restore of datafile 00001: E:\APP\TIANPAN\ORADATA\PTIAN\SYSTEM01.DBF</div><div class="line">channel ORA_DISK_1: copied datafile copy of datafile 00001</div><div class="line">output file name=E:\APP\TIANPAN\ORADATA\PTIAN\SYSTEM01.DBF RECID=0 STAMP=0</div><div class="line">channel ORA_DISK_1: restoring datafile 00002</div><div class="line">input datafile copy RECID=3 STAMP=884555292 file name=E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\DATAFILE\O1_MF_SYSAUX_BSTBJDFQ_.DBF</div><div class="line">destination <span class="keyword">for</span> restore of datafile 00002: E:\APP\TIANPAN\ORADATA\PTIAN\SYSAUX01.DBF</div><div class="line">channel ORA_DISK_1: copied datafile copy of datafile 00002</div><div class="line">output file name=E:\APP\TIANPAN\ORADATA\PTIAN\SYSAUX01.DBF RECID=0 STAMP=0</div><div class="line">channel ORA_DISK_1: restoring datafile 00003</div><div class="line">input datafile copy RECID=4 STAMP=884555305 file name=E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\DATAFILE\O1_MF_UNDOTBS1_BSTBK5V1_.DBF</div><div class="line">destination <span class="keyword">for</span> restore of datafile 00003: E:\APP\TIANPAN\ORADATA\PTIAN\UNDOTBS01.DBF</div><div class="line">channel ORA_DISK_1: copied datafile copy of datafile 00003</div><div class="line">output file name=E:\APP\TIANPAN\ORADATA\PTIAN\UNDOTBS01.DBF RECID=0 STAMP=0</div><div class="line">channel ORA_DISK_1: restoring datafile 00004</div><div class="line">input datafile copy RECID=7 STAMP=884555314 file name=E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\DATAFILE\O1_MF_USERS_BSTBKKVB_.DBF</div><div class="line">destination <span class="keyword">for</span> restore of datafile 00004: E:\APP\TIANPAN\ORADATA\PTIAN\USERS01.DBF</div><div class="line">channel ORA_DISK_1: copied datafile copy of datafile 00004</div><div class="line">output file name=E:\APP\TIANPAN\ORADATA\PTIAN\USERS01.DBF RECID=0 STAMP=0</div><div class="line">channel ORA_DISK_1: restoring datafile 00005</div><div class="line">input datafile copy RECID=5 STAMP=884555312 file name=E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\DATAFILE\O1_MF_EXAMPLE_BSTBKF80_.DBF</div><div class="line">destination <span class="keyword">for</span> restore of datafile 00005: E:\APP\TIANPAN\ORADATA\PTIAN\EXAMPLE01.DBF</div><div class="line">channel ORA_DISK_1: copied datafile copy of datafile 00005</div><div class="line">output file name=E:\APP\TIANPAN\ORADATA\PTIAN\EXAMPLE01.DBF RECID=0 STAMP=0</div><div class="line">Finished restore at 15-JUL-15</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; RECOVER DATABASE;</div><div class="line"></div><div class="line">Starting recover at 15-JUL-15</div><div class="line">using channel ORA_DISK_1</div><div class="line"></div><div class="line">starting media recovery</div><div class="line"></div><div class="line">archived <span class="built_in">log</span> <span class="keyword">for</span> thread 1 with sequence 105 is already on disk as file E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_09\O1_MF_1_105_BSWC39YH_.ARC</div><div class="line">archived <span class="built_in">log</span> <span class="keyword">for</span> thread 1 with sequence 106 is already on disk as file E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_10\O1_MF_1_106_BSYCRLNG_.ARC</div><div class="line">archived <span class="built_in">log</span> <span class="keyword">for</span> thread 1 with sequence 107 is already on disk as file E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_11\O1_MF_1_107_BT10F9Y9_.ARC</div><div class="line">archived <span class="built_in">log</span> <span class="keyword">for</span> thread 1 with sequence 108 is already on disk as file E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_11\O1_MF_1_108_BT1M9PW5_.ARC</div><div class="line">archived <span class="built_in">log</span> <span class="keyword">for</span> thread 1 with sequence 109 is already on disk as file E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_15\O1_MF_1_109_BTCH29LR_.ARC</div><div class="line">archived <span class="built_in">log</span> file name=E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_09\O1_MF_1_105_BSWC39YH_.ARC thread=1 sequence=105</div><div class="line">archived <span class="built_in">log</span> file name=E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_10\O1_MF_1_106_BSYCRLNG_.ARC thread=1 sequence=106</div><div class="line">archived <span class="built_in">log</span> file name=E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_11\O1_MF_1_107_BT10F9Y9_.ARC thread=1 sequence=107</div><div class="line">media recovery complete, elapsed time: 00:00:22</div><div class="line">Finished recover at 15-JUL-15</div><div class="line"></div><div class="line">RMAN&gt;</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#打开数据库： </span></div><div class="line">RMAN&gt;  ALTER DATABASE OPEN;</div><div class="line"></div><div class="line">database opened</div><div class="line"></div><div class="line">RMAN&gt;</div></pre></td></tr></table></figure>
<ol>
<li>表空间恢复  </li>
</ol>
<p>在执行恢复之前，如果被操作的表空间未处于OFFLINE状态，必须首先通过ALTER TABLESPACE tablespace_name OFFLINE语句将其置为脱机<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">SQL&gt; select * from v<span class="variable">$tablespace</span>;</div><div class="line">       TS<span class="comment"># NAME                           INCLUDED_IN_DATABASE_BACKUP BIGFILE FLASHBACK_ON ENCRYPT_IN_BACKUP</span></div><div class="line">---------- ------------------------------ --------------------------- ------- ------------ -----------------</div><div class="line">         0 SYSTEM                         YES                         NO      YES          </div><div class="line">         1 SYSAUX                         YES                         NO      YES          </div><div class="line">         2 UNDOTBS1                       YES                         NO      YES          </div><div class="line">         4 USERS                          YES                         NO      YES          </div><div class="line">         3 TEMP                           NO                          NO      YES          </div><div class="line">         6 EXAMPLE                        YES                         NO      YES          </div><div class="line">6 rows selected</div><div class="line">SQL&gt;</div></pre></td></tr></table></figure></p>
<p>以恢复Example表空间为例<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">操作步骤如下： </div><div class="line">RMAN&gt; SQL <span class="string">'ALTER TABLESPACE EXAMPLE OFFLINE IMMEDIATE'</span>; </div><div class="line">RMAN&gt; RESTORE TABLESPACE EXAMPLE; </div><div class="line">RMAN&gt; RECOVER TABLESPACE EXAMPLE; </div><div class="line">RMAN&gt; SQL <span class="string">'ALTER TABLESPACE  EXAMPLE ONLINE'</span>;</div></pre></td></tr></table></figure></p>
<p>上述执行的四个脚本，表示将表空间置于OFFLINE状态，执行RESTORE命令，执行RECOVER命令，最后将表空间置为ONLINE状态<br>示例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; SQL <span class="string">'ALTER TABLESPACE EXAMPLE OFFLINE IMMEDIATE'</span>;</div><div class="line"></div><div class="line">sql statement: ALTER TABLESPACE EXAMPLE OFFLINE IMMEDIATE</div><div class="line"></div><div class="line">RMAN&gt; RESTORE TABLESPACE EXAMPLE;</div><div class="line"></div><div class="line">Starting restore at 15-JUL-15</div><div class="line">using channel ORA_DISK_1</div><div class="line"></div><div class="line">channel ORA_DISK_1: restoring datafile 00005</div><div class="line">input datafile copy RECID=5 STAMP=884555312 file name=E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\DATAFILE\O1_MF_EXAMPLE_BSTBKF80_.DBF</div><div class="line">destination <span class="keyword">for</span> restore of datafile 00005: E:\APP\TIANPAN\ORADATA\PTIAN\EXAMPLE01.DBF</div><div class="line">channel ORA_DISK_1: copied datafile copy of datafile 00005</div><div class="line">output file name=E:\APP\TIANPAN\ORADATA\PTIAN\EXAMPLE01.DBF RECID=0 STAMP=0</div><div class="line">Finished restore at 15-JUL-15</div><div class="line"></div><div class="line">RMAN&gt; RECOVER TABLESPACE EXAMPLE;</div><div class="line"></div><div class="line">Starting recover at 15-JUL-15</div><div class="line">using channel ORA_DISK_1</div><div class="line"></div><div class="line">starting media recovery</div><div class="line"></div><div class="line">archived <span class="built_in">log</span> <span class="keyword">for</span> thread 1 with sequence 105 is already on disk as file E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_09\O1_MF_1_105_BSWC39YH_.ARC</div><div class="line">archived <span class="built_in">log</span> <span class="keyword">for</span> thread 1 with sequence 106 is already on disk as file E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_10\O1_MF_1_106_BSYCRLNG_.ARC</div><div class="line">archived <span class="built_in">log</span> <span class="keyword">for</span> thread 1 with sequence 107 is already on disk as file E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_11\O1_MF_1_107_BT10F9Y9_.ARC</div><div class="line">archived <span class="built_in">log</span> <span class="keyword">for</span> thread 1 with sequence 108 is already on disk as file E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_11\O1_MF_1_108_BT1M9PW5_.ARC</div><div class="line">archived <span class="built_in">log</span> <span class="keyword">for</span> thread 1 with sequence 109 is already on disk as file E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_15\O1_MF_1_109_BTCH29LR_.ARC</div><div class="line">archived <span class="built_in">log</span> file name=E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_09\O1_MF_1_105_BSWC39YH_.ARC thread=1 sequence=105</div><div class="line">archived <span class="built_in">log</span> file name=E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_10\O1_MF_1_106_BSYCRLNG_.ARC thread=1 sequence=106</div><div class="line">archived <span class="built_in">log</span> file name=E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_11\O1_MF_1_107_BT10F9Y9_.ARC thread=1 sequence=107</div><div class="line">media recovery complete, elapsed time: 00:00:03</div><div class="line">Finished recover at 15-JUL-15</div><div class="line"></div><div class="line">RMAN&gt; SQL <span class="string">'ALTER TABLESPACE  EXAMPLE ONLINE'</span>;</div><div class="line"></div><div class="line">sql statement: ALTER TABLESPACE  EXAMPLE ONLINE</div><div class="line"></div><div class="line">RMAN&gt;</div></pre></td></tr></table></figure></p>
<ol>
<li>数据文件的恢复  </li>
</ol>
<p>恢复表空间实际就是恢复其所对应的数据文件（一个表空间可能对应多个数据文件），因此恢复数据文件的操作步骤与上极其相似<br>同样在恢复操作之前，如果需要被恢复的数据文件未处于OFFLINE状态，需要通过ALTER DATABASE DATAFILE … OFFLINE语句将其置为脱机。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">SQL&gt;  select file<span class="comment">#, name,status, enabled from v$datafile;</span></div><div class="line">     FILE<span class="comment"># NAME                                                                             STATUS  ENABLED</span></div><div class="line">---------- -------------------------------------------------------------------------------- ------- ----------</div><div class="line">         1 E:\APP\TIANPAN\ORADATA\PTIAN\SYSTEM01.DBF                                        SYSTEM  READ WRITE</div><div class="line">         2 E:\APP\TIANPAN\ORADATA\PTIAN\SYSAUX01.DBF                                        ONLINE  READ WRITE</div><div class="line">         3 E:\APP\TIANPAN\ORADATA\PTIAN\UNDOTBS01.DBF                                       ONLINE  READ WRITE</div><div class="line">         4 E:\APP\TIANPAN\ORADATA\PTIAN\USERS01.DBF                                         ONLINE  READ WRITE</div><div class="line">         5 E:\APP\TIANPAN\ORADATA\PTIAN\EXAMPLE01.DBF                                       ONLINE  READ WRITE</div><div class="line"></div><div class="line">SQL&gt;</div></pre></td></tr></table></figure></p>
<p>以恢复datafile 5为例<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; SQL <span class="string">'ALTER DATABASE DATAFILE 5 OFFLINE'</span>; </div><div class="line">RMAN&gt; RESTORE DATAFILE 5; </div><div class="line">RMAN&gt; RECOVER DATAFILE 5; </div><div class="line">RMAN&gt; SQL <span class="string">'ALTER DATABASE DATAFILE 5 ONLINE'</span>;</div></pre></td></tr></table></figure></p>
<p>示例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; SQL <span class="string">'ALTER DATABASE DATAFILE 5 OFFLINE'</span>;</div><div class="line"></div><div class="line">sql statement: ALTER DATABASE DATAFILE 5 OFFLINE</div><div class="line"></div><div class="line">RMAN&gt; RESTORE DATAFILE 5;</div><div class="line"></div><div class="line">Starting restore at 15-JUL-15</div><div class="line">using channel ORA_DISK_1</div><div class="line"></div><div class="line">channel ORA_DISK_1: restoring datafile 00005</div><div class="line">input datafile copy RECID=5 STAMP=884555312 file name=E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\DATAFILE\O1_MF_EXAMPLE_BSTBKF80_.DBF</div><div class="line">destination <span class="keyword">for</span> restore of datafile 00005: E:\APP\TIANPAN\ORADATA\PTIAN\EXAMPLE01.DBF</div><div class="line">channel ORA_DISK_1: copied datafile copy of datafile 00005</div><div class="line">output file name=E:\APP\TIANPAN\ORADATA\PTIAN\EXAMPLE01.DBF RECID=0 STAMP=0</div><div class="line">Finished restore at 15-JUL-15</div><div class="line"></div><div class="line">RMAN&gt; RECOVER DATAFILE 5;</div><div class="line"></div><div class="line">Starting recover at 15-JUL-15</div><div class="line">using channel ORA_DISK_1</div><div class="line"></div><div class="line">starting media recovery</div><div class="line"></div><div class="line">archived <span class="built_in">log</span> <span class="keyword">for</span> thread 1 with sequence 105 is already on disk as file E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_09\O1_MF_1_105_BSWC39YH_.ARC</div><div class="line">archived <span class="built_in">log</span> <span class="keyword">for</span> thread 1 with sequence 106 is already on disk as file E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_10\O1_MF_1_106_BSYCRLNG_.ARC</div><div class="line">archived <span class="built_in">log</span> <span class="keyword">for</span> thread 1 with sequence 107 is already on disk as file E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_11\O1_MF_1_107_BT10F9Y9_.ARC</div><div class="line">archived <span class="built_in">log</span> <span class="keyword">for</span> thread 1 with sequence 108 is already on disk as file E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_11\O1_MF_1_108_BT1M9PW5_.ARC</div><div class="line">archived <span class="built_in">log</span> <span class="keyword">for</span> thread 1 with sequence 109 is already on disk as file E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_15\O1_MF_1_109_BTCH29LR_.ARC</div><div class="line">archived <span class="built_in">log</span> file name=E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_09\O1_MF_1_105_BSWC39YH_.ARC thread=1 sequence=105</div><div class="line">archived <span class="built_in">log</span> file name=E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_10\O1_MF_1_106_BSYCRLNG_.ARC thread=1 sequence=106</div><div class="line">archived <span class="built_in">log</span> file name=E:\APP\TIANPAN\FLASH_RECOVERY_AREA\PTIAN\ARCHIVELOG\2015_07_11\O1_MF_1_107_BT10F9Y9_.ARC thread=1 sequence=107</div><div class="line">media recovery complete, elapsed time: 00:00:04</div><div class="line">Finished recover at 15-JUL-15</div><div class="line"></div><div class="line">RMAN&gt; SQL <span class="string">'ALTER DATABASE DATAFILE 5 ONLINE'</span>;</div><div class="line"></div><div class="line">sql statement: ALTER DATABASE DATAFILE 5 ONLINE</div><div class="line"></div><div class="line">RMAN&gt;</div></pre></td></tr></table></figure></p>
<ol>
<li>归档日志文件的恢复  </li>
</ol>
<p>恢复归档文件也是使用RESTORE命令，如果只是为了在恢复数据文件后应用归档文件，那并不需要手动对归档文件进行恢复，RMAN会在RECOVER的时候自动对适当的归档进行恢复<br>恢复归档文件也非常灵活，RMAN的RECOVER命令中提供了多种限定条件，可以精确指定恢复哪些备份的归档文件，例如，恢复归档序号为20到30之间的归档文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; RESTORE ARCHIVELOG SEQUENCE BETWEEN 20 AND 30;</div></pre></td></tr></table></figure></p>
<p>示例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; RUN&#123; </div><div class="line">2&gt; SET ARCHIVELOG DESTINATION TO <span class="string">'F:\ORACLE\BACKUP\ARCLOG1'</span>; </div><div class="line">3&gt; RESTORE ARCHIVELOG SEQUENCE BETWEEN 15 AND 20; </div><div class="line">4&gt; SET ARCHIVELOG DESTINATION TO <span class="string">'F:\ORACLE\BACKUP\ARCLOG2'</span>; </div><div class="line">5&gt; RESTORE ARCHIVELOG SEQUENCE BETWEEN 21 AND 30; </div><div class="line">6&gt; SET ARCHIVELOG DESTINATION TO <span class="string">'F:\ORACLE\BACKUP\ARCLOG3'</span>; </div><div class="line">7&gt; RESTORE ARCHIVELOG SEQUENCE BETWEEN 31 AND 40;  </div><div class="line">8&gt; &#125;</div></pre></td></tr></table></figure></p>
<ol>
<li>控制文件的恢复  </li>
</ol>
<p>Oracle数据库的控制文件个头不大（最大不超过20000个数据块），Oracle数据库实例启动后（即启动到NOMOUNT模式），要通过加载控制文件确定数据文件、重做日志文件的路径（进入到MOUNT模式），然后才能打开数据库（Finally，OPEN数据库）。因此，没有了控制文件，想顺利启动Oracle数据库是不可能的。<br>控制文件中并不是只有数据文件和重做日志文件的路径，还包括数据库名称、数据库创建信息、表空间信息、数据文件状态、日志文件信息、备份信息、检查点信息等。<br>该文件不仅在数据库启动过程中需要，在Oracle数据库运行过程中，控制文件也需要发挥重要作用，如记录检查点的相关信息、归档文件路径、备份信息（假如采用RMAN执行备份的话），以及数据库发生结构修改（流行词汇形容叫领导班子调整，类似添加删除表空间、数据文件、日志文件）等操作都需要同步到控制文件。如果在Oracle数据库运行过程中，由于某些原因导致控制文件无法访问，则数据库也无法继续正常工作。<br>控制文件是一个二进制文件，不能直接通过文本编辑工具修改，一般这个文件中的内容都是由Oracle自行维护。一个Oracle数据库至少要拥有一个控制文件，鉴于其重要地位，Oracle对其的保护有加，在默认情况下，控制文件就会有两、三份冗余（就是一模一样的文件存在两、三份），这几份文件的一致性由Oracle自动维护，冗余的数量和冗余文件的位置可以由DBA指定，Oracle建议控制文件至少要有两份冗余，并且存储在不同的磁盘中，以提高该文件的可用性。  </p>
<p>查询当前数据库拥有的控制文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">SQL&gt; SELECT NAME FROM V<span class="variable">$CONTROLFILE</span>; </div><div class="line"></div><div class="line">NAME</div><div class="line">--------------------------------------------------------------------------------</div><div class="line">/u01/data/orcl/control01.ctl</div><div class="line">/u01/data/orcl/control02.ctl</div><div class="line"></div><div class="line">SQL&gt; SHOW PARAMETER CONTROL_FILES;</div><div class="line"></div><div class="line">NAME				     TYPE	 VALUE</div><div class="line">------------------------------------ ----------- ------------------------------</div><div class="line">control_files			     string	 /u01/data/orcl/control01.ctl,</div><div class="line">						 /u01/data/orcl/control02.ctl</div><div class="line">SQL&gt;</div></pre></td></tr></table></figure></p>
<p>如果通知文件丢失，可以通过以下集中方式恢复：</p>
<ul>
<li>从自动备份中恢复  </li>
</ul>
<p>由于没有了控制文件，目标数据库只能启动到NOMOUNT状态，不过在启动数据库之前，必须首先通过SET命令设置DBID：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#获取数据库的DBID</span></div><div class="line">SQL&gt; SELECT DBID FROM V<span class="variable">$DATABASE</span>;</div><div class="line"></div><div class="line">      DBID</div><div class="line">----------</div><div class="line">1455780274</div><div class="line"></div><div class="line">SQL&gt;</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; SET DBID=1455780274;</div><div class="line">RMAN&gt; STARTUP NOMOUNT;</div><div class="line">RMAN&gt; RESTORE CONTROLFILE FROM AUTOBACKUP;</div></pre></td></tr></table></figure>
<ul>
<li>从备份集中恢复</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#在启动数据库之前，必须首先通过SET命令设置DBID</span></div><div class="line">RMAN&gt; SET DBID=1415261003;</div><div class="line">RMAN&gt; STARTUP NOMOUNT;</div><div class="line"><span class="comment">#指定控制文件所在备份片段的详细路径</span></div><div class="line">RMAN&gt; RESTORE CONTROLFILE FROM <span class="string">'/u01/app/oracle/product/11.2.0.4/db_1/dbs/05rtn873_1_1'</span>;</div></pre></td></tr></table></figure>
<ul>
<li>还有一种极端的情况，没有备份过控制文件，这时不凑巧的是，控制文件居然坏了。这时我们可以采用<a href="https://yfshare.github.io/2017/02/27/重建oracle控制文件/">重构oracle的控制文件来恢复，参考这里</a></li>
</ul>
<ol>
<li>SPFILE初始化参数文件  </li>
</ol>
<p>虽然DBA可以通过BACKUP SPFILE命令手动备份服务器端的初始化参数文件，不过一般都不会主动执行，因为RMAN在备份控制文件时会自动备份SPFILE<br>相对于其他文件的备份，SPFILE最不重要（或者说最容易被恢复）。除了可以通过备份方式保障拥有可用的SPFILE外，数据库在运行过程中也会在Alert文件中留下数据库启动时的初始化参数信息。甚至即使这些都丢失了也没有关系，如果你对数据库足够了解，还是能够手动地创建出一份SPFILE出来，只是麻烦一些罢了。即使是运行中的数据库丢失了SPFILE也不会导致数据库崩溃（只不过下次启动时如果还没有能创建出一份来，数据库就起不来。</p>
<p>通过RMAN恢复初始化参数的过程与恢复控制文件极其类似<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; SET DBID=1415261003;</div><div class="line">RMAN&gt; STARTUP NOMOUNT;</div><div class="line"><span class="comment">#执行恢复命令，将SPFILE恢复到默认路径下</span></div><div class="line">RMAN&gt; RESTORE SPFILE FROM AUTOBACKUP;</div></pre></td></tr></table></figure></p>
<p>参考：<a href="http://blog.csdn.net/pan_tian/article/details/46896017" target="_blank" rel="external">http://blog.csdn.net/pan_tian/article/details/46896017</a></p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="https://yfshare.github.io">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="https://yfshare.github.io/2017/02/28/Oracle数据库备份与恢复-RMAN恢复/">https://yfshare.github.io/2017/02/28/Oracle数据库备份与恢复-RMAN恢复/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;script src=&quot;/assets/js/DPlayer.min.js&quot;&gt; &lt;/script&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;h2 id=&quot;RMAN恢复原理&quot;&gt;&lt;a href=&quot;#RMAN恢复原理&quot; cl
    
    </summary>
    
      <category term="oracle" scheme="https://yfshare.github.io/categories/oracle/"/>
    
    
      <category term="oracle" scheme="https://yfshare.github.io/tags/oracle/"/>
    
      <category term="RMAN" scheme="https://yfshare.github.io/tags/RMAN/"/>
    
  </entry>
  
  <entry>
    <title>重建oracle控制文件</title>
    <link href="https://yfshare.github.io/2017/02/27/%E9%87%8D%E5%BB%BAoracle%E6%8E%A7%E5%88%B6%E6%96%87%E4%BB%B6/"/>
    <id>https://yfshare.github.io/2017/02/27/重建oracle控制文件/</id>
    <published>2017-02-27T07:24:08.000Z</published>
    <updated>2017-02-27T07:32:32.896Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>环境：CentOS 6.6<br>　　　oracle 11.2.0.4.0  </p>
<p>前几天开发一都比调试存储过程时开了DEBUG，把测试服务器直接搞挂了，最后把测试服务器搞起来了，结果发现oracle数据库也挂了，原因是oracle的控制文件 control02.ctl 损坏了，因为是测试环境，所以没有备份…xxx<br><a id="more"></a><br>控制文件（control file）是一个相当小的文件（最多能增长到64M左右），其中包含Oracle需要的其他文件的一个目录。参数文件告知实例控制文件的位置，控制文件则告知示例数据库和在线重做日志文件的位置。控制文件还告知了Oracle其他一些事情，如已发生检查点的有关信息、数据库名（必须和db_name参数匹配）、创建数据库的时间戳、归档重做日志的历史（有时这会让控制文件变大）、RMAN信息等。<br>控制文件应该通过硬件（RAID）多路保存，如果不支持镜像，则要通过Oracle多路保存。应该有不止一个副本，而且它们应该保存在不同的磁盘上，以防止万一出现磁盘故障而丢失控制文件。丢失控制文件并不是致命的，但是会使恢复变得困难很多。<br>如果丢失了所有的控制文件并且没有任何的备份，我们可以通过重建控制文件来打开数据库。其中，重建控制文件至少需要以下信息：  </p>
<ol>
<li>数据库名</li>
<li>字符集</li>
<li>数据文件名称</li>
<li>初始化参数，包括MAXLOGFILES、MAXLOGMEMBERS、MAXDATAFILES、MAXINSTANCES、MAXLOGHISTORY等；  </li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#查看oracle版本信息</span></div><div class="line">SQL&gt; select * from v<span class="variable">$version</span>;</div><div class="line"></div><div class="line">BANNER</div><div class="line">-----------------------------------------------------------------------------</div><div class="line">Oracle Database 11g Enterprise Edition Release 11.2.0.4.0 - 64bit Production</div><div class="line">PL/SQL Release 11.2.0.4.0 - Production</div><div class="line">CORE	11.2.0.4.0	Production</div><div class="line">TNS <span class="keyword">for</span> Linux: Version 11.2.0.4.0 - Production</div><div class="line">NLSRTL Version 11.2.0.4.0 - Production</div><div class="line"></div><div class="line">SQL&gt;</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#查看oracle控制文件位置</span></div><div class="line">SQL&gt; show parameter control_files</div><div class="line"></div><div class="line">NAME				     TYPE	 VALUE</div><div class="line">------------------------------------ ------- -----------</div><div class="line">control_files			     string	 /u01/data/orcl/control01.ctl,</div><div class="line">						 /u01/data/orcl/control02.ctl</div><div class="line">SQL&gt;</div></pre></td></tr></table></figure>
<p>如果oracle控制文件损坏，强制关闭数据库，然后重启数据库，报ORA-00205错误。需要注意的是，此时执行shutdown immediate命令，数据库无法正常关闭，只能关闭到mounted状态；需要使用shutdown abort命令强制关闭数据库。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">SQL&gt; shutdown immediate</div><div class="line">Database closed.</div><div class="line">ORA-00210: cannot open the specified control file</div><div class="line">ORA-00202: control file: <span class="string">'/u01/data/orcl/control02.ctl'</span></div><div class="line">ORA-27041: unable to open file</div><div class="line">Linux Error: 2: No such file or directory</div><div class="line">Additional information: 3</div><div class="line"></div><div class="line">SQL&gt; select status from v<span class="variable">$instance</span>;</div><div class="line"></div><div class="line">STATUS</div><div class="line">------------</div><div class="line">MOUNTED</div><div class="line"></div><div class="line">SQL&gt; shutdown abort</div><div class="line">ORACLE instance shut down.</div><div class="line">SQL&gt; </div><div class="line">SQL&gt; startup</div><div class="line">ORACLE instance started.</div><div class="line"></div><div class="line">Total System Global Area 941600768 bytes</div><div class="line">Fixed Size 1348860 bytes</div><div class="line">Variable Size 515902212 bytes</div><div class="line">Database Buffers 419430400 bytes</div><div class="line">Redo Buffers 4919296 bytes</div><div class="line">ORA-00205: error <span class="keyword">in</span> identifying control file, check alert <span class="built_in">log</span> <span class="keyword">for</span> more info</div><div class="line"></div><div class="line">SQL&gt;</div></pre></td></tr></table></figure></p>
<p>获取数据库名<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#生成文本格式的参数文件</span></div><div class="line">$ sqlplus / as sysdba</div><div class="line">SQL&gt; create pfile from spfile;</div><div class="line">File created.</div><div class="line">SQL&gt;</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#打开参数文件，查看db_name参数值，即为数据库名称  </span></div><div class="line">[oracle@orcl ~]$ <span class="built_in">cd</span> <span class="variable">$ORACLE_HOME</span>/dbs</div><div class="line">[oracle@orcl dbs]$ cat initorcl.ora </div><div class="line">orcl.__db_cache_size=1107296256</div><div class="line">orcl.__java_pool_size=16777216</div><div class="line">orcl.__large_pool_size=33554432</div><div class="line">orcl.__oracle_base=<span class="string">'/u01/app/oracle'</span><span class="comment">#ORACLE_BASE set from environment</span></div><div class="line">orcl.__pga_aggregate_target=1140850688</div><div class="line">orcl.__sga_target=2130706432</div><div class="line">orcl.__shared_io_pool_size=0</div><div class="line">orcl.__shared_pool_size=369098752</div><div class="line">orcl.__streams_pool_size=0</div><div class="line">*.audit_file_dest=<span class="string">'/u01/app/oracle/admin/orcl/adump'</span></div><div class="line">*.audit_trail=<span class="string">'db'</span></div><div class="line">*.compatible=<span class="string">'11.2.0.4.0'</span></div><div class="line">*.control_files=<span class="string">'/u01/data/orcl/control01.ctl'</span>,<span class="string">'/u01/data/orcl/control02.ctl'</span></div><div class="line">*.db_block_size=8192</div><div class="line">*.db_domain=<span class="string">''</span></div><div class="line">*.db_name=<span class="string">'orcl'</span>   <span class="comment">#oracle数据库名称</span></div><div class="line">*.diagnostic_dest=<span class="string">'/u01/app/oracle'</span></div><div class="line">*.dispatchers=<span class="string">'(PROTOCOL=TCP) (SERVICE=orclXDB)'</span></div><div class="line">*.memory_target=3267362816</div><div class="line">*.nls_language=<span class="string">'SIMPLIFIED CHINESE'</span></div><div class="line">*.open_cursors=300</div><div class="line">*.processes=1500</div><div class="line">*.remote_login_passwordfile=<span class="string">'EXCLUSIVE'</span></div><div class="line">*.sessions=1655</div><div class="line">*.undo_tablespace=<span class="string">'UNDOTBS1'</span></div><div class="line">[oracle@orcl dbs]$</div></pre></td></tr></table></figure>
<p>启动到nomount状态，获取字符集<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#需要执行查询语句select userenv('language') from dual;来获取字符集，因此需要将数据库启动到nomount状态</span></div><div class="line">SQL&gt; startup nomount</div><div class="line">ORACLE instance started.</div><div class="line"></div><div class="line">Total System Global Area 941600768 bytes</div><div class="line">Fixed Size 1348860 bytes</div><div class="line">Variable Size 515902212 bytes</div><div class="line">Database Buffers 419430400 bytes</div><div class="line">Redo Buffers 4919296 bytes</div><div class="line">SQL&gt; </div><div class="line">SQL&gt; select userenv(<span class="string">'language'</span>) from dual;   </div><div class="line"></div><div class="line">USERENV(<span class="string">'LANGUAGE'</span>)</div><div class="line">----------------------------------------------------</div><div class="line">SIMPLIFIED CHINESE_CHINA.US7ASCII</div><div class="line"></div><div class="line">SQL&gt;</div></pre></td></tr></table></figure></p>
<p>获取数据文件名称<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">SQL&gt; select FILE_NAME,TABLESPACE_NAME from dba_data_files;</div><div class="line"></div><div class="line">FILE_NAME			    TABLESPACE_NAME</div><div class="line">----------------------------------- ------------------------------</div><div class="line">/u01/data/orcl/dev_payboxdb.dbf     DEV_PAYBOXDB</div><div class="line">/u01/data/orcl/dev_paydb.dbf	    DEV_PAYDB</div><div class="line">/u01/data/orcl/PAYBOX_FG_PRO.dbf    PAYBOX_FG_PRO</div><div class="line">/u01/data/orcl/PAYBOX_TEST2SP.dbf   PAYBOX_TEST2SP</div><div class="line">/u01/data/orcl/ticket.dbf	    LOTTERYDB</div><div class="line">/u01/data/orcl/users01.dbf	    USERS</div><div class="line">/u01/data/orcl/undotbs01.dbf	    UNDOTBS1</div><div class="line">/u01/data/orcl/sysaux01.dbf	    SYSAUX</div><div class="line">/u01/data/orcl/system01.dbf	    SYSTEM</div><div class="line"></div><div class="line">9 rows selected.</div><div class="line"></div><div class="line">SQL&gt;</div><div class="line"><span class="comment">#获取数据库文件列表</span></div><div class="line">[oracle@orcl orcl]$ ls -lth</div><div class="line">总用量 8.1G</div><div class="line">-rw-r----- 1 oracle oinstall  51M 2月  27 15:09 redo02.log</div><div class="line">-rw-r----- 1 oracle oinstall 503M 2月  27 15:09 users01.dbf</div><div class="line">-rw-r----- 1 oracle oinstall 511M 2月  27 15:09 undotbs01.dbf</div><div class="line">-rw-r----- 1 oracle oinstall 3.7G 2月  27 15:07 system01.dbf</div><div class="line">-rw-r----- 1 oracle oinstall 1.3G 2月  27 15:06 sysaux01.dbf</div><div class="line">-rw-r----- 1 oracle oinstall 513M 2月  27 15:00 temp01.dbf</div><div class="line">-rw-r----- 1 oracle oinstall 501M 2月  27 12:31 ticket.dbf</div><div class="line">-rw-r----- 1 oracle oinstall 501M 2月  27 12:31 dev_payboxdb.dbf</div><div class="line">-rw-r----- 1 oracle oinstall 501M 2月  27 12:31 dev_paydb.dbf</div><div class="line">-rw-r----- 1 oracle oinstall 201M 2月  27 12:31 PAYBOX_TEST2SP.dbf</div><div class="line">-rw-r----- 1 oracle oinstall 201M 2月  27 12:31 PAYBOX_FG_PRO.dbf</div><div class="line">-rw-r----- 1 oracle oinstall  51M 2月  27 12:26 redo01.log</div><div class="line">-rw-r----- 1 oracle oinstall  51M 2月  27 12:26 redo03.log</div><div class="line">-rw-r----- 1 oracle oinstall  51M 2月  25 08:05 redo05.log</div><div class="line">-rw-r----- 1 oracle oinstall  51M 2月  25 06:00 redo04.log</div><div class="line">[oracle@orcl orcl]$</div></pre></td></tr></table></figure></p>
<p>生成创建控制文件脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#DATABASE后面的orcl是示例名，正确设置LOGFILE和DATAFILE的路径及名称，字符集</span></div><div class="line">[oracle@orcl orcl]$ cat create_control.sql </div><div class="line">STARTUP NOMOUNT</div><div class="line">CREATE CONTROLFILE REUSE DATABASE orcl NORESETLOGS ARCHIVELOG</div><div class="line">    MAXLOGFILES 5</div><div class="line">    MAXLOGMEMBERS 3</div><div class="line">    MAXDATAFILES 100</div><div class="line">    MAXINSTANCES 1</div><div class="line">    MAXLOGHISTORY 226</div><div class="line">LOGFILE</div><div class="line">  GROUP 1 <span class="string">'/u01/data/orcl/redo01.log'</span> SIZE 50M,</div><div class="line">  GROUP 2 <span class="string">'/u01/data/orcl/redo02.log'</span> SIZE 50M,</div><div class="line">  GROUP 3 <span class="string">'/u01/data/orcl/redo03.log'</span> SIZE 50M</div><div class="line">DATAFILE</div><div class="line">  <span class="string">'/u01/data/orcl/system01.dbf'</span>,</div><div class="line">  <span class="string">'/u01/data/orcl/sysaux01.dbf'</span>,</div><div class="line">  <span class="string">'/u01/data/orcl/undotbs01.dbf'</span>,</div><div class="line">  <span class="string">'/u01/data/orcl/users01.dbf'</span>,</div><div class="line">  <span class="string">'/u01/data/orcl/ticket.dbf'</span>,</div><div class="line">  <span class="string">'/u01/data/orcl/PAYBOX_TEST2SP.dbf'</span>,</div><div class="line">  <span class="string">'/u01/data/orcl/PAYBOX_FG_PRO.dbf'</span>,</div><div class="line">  <span class="string">'/u01/data/orcl/dev_paydb.dbf'</span>,</div><div class="line">  <span class="string">'/u01/data/orcl/dev_payboxdb.dbf'</span></div><div class="line">CHARACTER SET US7ASCII</div><div class="line">;</div><div class="line">[oracle@orcl orcl]$</div></pre></td></tr></table></figure></p>
<p>重建控制文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#如果上述创建控制文件的脚本的DATAFILE中有系统临时文件，则会报下面的错误：</span></div><div class="line"><span class="comment">#创建控制文件脚本里面不能有左斜杠(\)，否则报错</span></div><div class="line"><span class="comment">#DATAFILE中不能有临时文件/u01/data/orcl/temp01.dbf</span></div><div class="line"><span class="comment">#如果执行出错，执行shutdown abort关闭数据库后，再执行创建控制文件的sql，因为执行了创建控制文件的sql会让oracle处理mount状态</span></div><div class="line">SQL&gt; @/u01/data/orcl/create_control.sql</div><div class="line">ORA-01081: cannot start already-running ORACLE - shut it down first</div><div class="line">CREATE CONTROLFILE REUSE DATABASE \<span class="string">"oracle\" NORESETLOGS ARCHIVELOG</span></div><div class="line">*</div><div class="line">ERROR at line 1:</div><div class="line">ORA-01503: CREATE CONTROLFILE failed</div><div class="line">ORA-01160: file is not a data file</div><div class="line">ORA-01110: data file : '/u01/data/orcl/temp01.dbf'</div><div class="line"></div><div class="line">SQL&gt;</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">SQL&gt; @/u01/data/orcl/create_control.sql</div><div class="line">ORACLE instance started.</div><div class="line"></div><div class="line">Total System Global Area 941600768 bytes</div><div class="line">Fixed Size 1348860 bytes</div><div class="line">Variable Size 515902212 bytes</div><div class="line">Database Buffers 419430400 bytes</div><div class="line">Redo Buffers 4919296 bytes</div><div class="line"></div><div class="line">Control file created.</div><div class="line"></div><div class="line">SQL&gt; </div><div class="line">SQL&gt; select status from v<span class="variable">$instance</span>;</div><div class="line"></div><div class="line">STATUS</div><div class="line">------------</div><div class="line">MOUNTED</div><div class="line"></div><div class="line">SQL&gt;</div></pre></td></tr></table></figure>
<p>打开数据库<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#在打开数据库时，会报错，提示system01数据文件需要执行介质恢复，我们执行recover database即可</span></div><div class="line">SQL&gt; alter database open;</div><div class="line">alter database open</div><div class="line">*</div><div class="line">ERROR at line 1:</div><div class="line">ORA-01113: file 1 needs media recovery</div><div class="line">ORA-01110: data file 1: \<span class="string">'/u01/app/oracle/oradata/HOEGH/system01.dbf\'</span></div><div class="line">SQL&gt; </div><div class="line">SQL&gt; recover database;</div><div class="line">Media recovery complete.</div><div class="line">SQL&gt; </div><div class="line">SQL&gt; alter database open;</div><div class="line"></div><div class="line">Database altered.</div><div class="line"></div><div class="line">SQL&gt; </div><div class="line">SQL&gt; select * from v<span class="variable">$version</span>;</div><div class="line"></div><div class="line">BANNER</div><div class="line">-----------------------------------------------------------------------------</div><div class="line">Oracle Database 11g Enterprise Edition Release 11.2.0.4.0 - 64bit Production</div><div class="line">PL/SQL Release 11.2.0.4.0 - Production</div><div class="line">CORE	11.2.0.4.0	Production</div><div class="line">TNS <span class="keyword">for</span> Linux: Version 11.2.0.4.0 - Production</div><div class="line">NLSRTL Version 11.2.0.4.0 - Production</div><div class="line"></div><div class="line">SQL&gt;</div><div class="line"></div><div class="line">SQL&gt; select tablespace_name from dba_tablespaces;</div><div class="line"></div><div class="line">TABLESPACE_NAME</div><div class="line">------------------------------</div><div class="line">SYSTEM</div><div class="line">SYSAUX</div><div class="line">UNDOTBS1</div><div class="line">TEMP</div><div class="line">USERS</div><div class="line">PAYBOX_FG_PRO</div><div class="line">PAYBOX_TEST2SP</div><div class="line">DEV_PAYDB</div><div class="line">DEV_PAYBOXDB</div><div class="line">LOTTERYDB</div><div class="line"></div><div class="line">10 rows selected.</div><div class="line"></div><div class="line">SQL&gt;</div></pre></td></tr></table></figure></p>
<p>总结<br>下面总结一下重建控制文件的步骤：  </p>
<ol>
<li>获取数据库名；</li>
<li>获取字符集名；</li>
<li>获取数据文件名；</li>
<li>重建控制文件；</li>
<li>执行介质恢复；</li>
<li>打开数据库。</li>
</ol>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="https://yfshare.github.io">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="https://yfshare.github.io/2017/02/27/重建oracle控制文件/">https://yfshare.github.io/2017/02/27/重建oracle控制文件/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;环境：CentOS 6.6&lt;br&gt;　　　oracle 11.2.0.4.0  &lt;/p&gt;
&lt;p&gt;前几天开发一都比调试存储过程时开了DEBUG，把测试服务器直接搞挂了，最后把测试服务器搞起来了，结果发现oracle数据库也挂了，原因是oracle的控制文件 control02.ctl 损坏了，因为是测试环境，所以没有备份…xxx&lt;br&gt;
    
    </summary>
    
      <category term="oracle" scheme="https://yfshare.github.io/categories/oracle/"/>
    
    
      <category term="oracle" scheme="https://yfshare.github.io/tags/oracle/"/>
    
      <category term="control" scheme="https://yfshare.github.io/tags/control/"/>
    
  </entry>
  
  <entry>
    <title>Zabbix安装Graphtree</title>
    <link href="https://yfshare.github.io/2017/02/22/Zabbix%E5%AE%89%E8%A3%85Graphtree/"/>
    <id>https://yfshare.github.io/2017/02/22/Zabbix安装Graphtree/</id>
    <published>2017-02-22T09:01:32.000Z</published>
    <updated>2017-02-22T09:37:54.461Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><h2 id="Graphtree功能概述"><a href="#Graphtree功能概述" class="headerlink" title="Graphtree功能概述"></a>Graphtree功能概述</h2><p>Graphtree 由OneOaaS开发并开源出来，OneOaaS专注于国内Zabbix监控技术(包括二次开发)服务，为Zabbix官方中国区合作伙伴  </p>
<ol>
<li>集中展示所有分组设备</li>
<li>集中展示一个分组图像</li>
<li>集中展示一个设备图像<a id="more"></a></li>
<li>展示设备下的Application</li>
<li>展示每个应用下的图像</li>
<li>展示每个应用下的日志</li>
<li>对原声无图的监控项进行绘图</li>
<li>注意事项：主机和组级别下，默认只显示系统初始的图形</li>
</ol>
<h2 id="Zabbix版本要求：3-0-x"><a href="#Zabbix版本要求：3-0-x" class="headerlink" title="Zabbix版本要求：3.0.x"></a>Zabbix版本要求：3.0.x</h2><p>附件：<a href="http://note.youdao.com/yws/api/personal/file/DAB415BB243542CF8CF075B8907EF081?method=download&amp;shareKey=7ade1a3e929ca16ac394d1429a7152ba" target="_blank" rel="external">graphtree3-0-1.patch</a>  </p>
<ol>
<li><p>插件安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#进入zabbix web目录</span></div><div class="line">[root@localhost ~]<span class="comment"># cd /opt/server/nginx-1.2.5/html/zabbix</span></div><div class="line">[root@localhost zabbix]<span class="comment"># wget --no-check-certificate https://raw.githubusercontent.com/OneOaaS/graphtrees/master/graphtree3-0-1.patch</span></div><div class="line">[root@localhost zabbix]<span class="comment"># yum -y install patch  #安装Linux下打补丁的命令</span></div><div class="line">[root@localhost zabbix]<span class="comment"># patch -Np0 &lt; graphtree3-0-1.patch</span></div></pre></td></tr></table></figure>
</li>
<li><p>Graphtree效果图  </p>
</li>
</ol>
<ul>
<li>打开zabbix web界面，找到Graphtrees选项卡</li>
<li>删除提示信息。编辑/opt/server/nginx-1.2.5/html/zabbix/graphtree.right.php 344-350行。具体请参考zabbix web界面的提示信息，如下图：<br><img src="http://note.youdao.com/yws/api/personal/file/ABB674CC417E41D2A3D27F0E4E984C19?method=download&amp;shareKey=46a8a5e4bb870899bc6855316b83e595" alt="image">  </li>
<li>删除上述提示信息后，重新刷新zabbix web界面，即可看到效果<br><img src="http://note.youdao.com/yws/api/personal/file/E000C80252634DFA9A6EE39813914F33?method=download&amp;shareKey=930aa2a35216b44a5a23f62ff9dc2b79" alt="image">  </li>
</ul>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="https://yfshare.github.io">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="https://yfshare.github.io/2017/02/22/Zabbix安装Graphtree/">https://yfshare.github.io/2017/02/22/Zabbix安装Graphtree/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Graphtree功能概述&quot;&gt;&lt;a href=&quot;#Graphtree功能概述&quot; class=&quot;headerlink&quot; title=&quot;Graphtree功能概述&quot;&gt;&lt;/a&gt;Graphtree功能概述&lt;/h2&gt;&lt;p&gt;Graphtree 由OneOaaS开发并开源出来，OneOaaS专注于国内Zabbix监控技术(包括二次开发)服务，为Zabbix官方中国区合作伙伴  &lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;集中展示所有分组设备&lt;/li&gt;
&lt;li&gt;集中展示一个分组图像&lt;/li&gt;
&lt;li&gt;集中展示一个设备图像
    
    </summary>
    
      <category term="Zabbix" scheme="https://yfshare.github.io/categories/Zabbix/"/>
    
    
      <category term="zabbix" scheme="https://yfshare.github.io/tags/zabbix/"/>
    
      <category term="Graphtree" scheme="https://yfshare.github.io/tags/Graphtree/"/>
    
  </entry>
  
  <entry>
    <title>Hexo+Github绑定域名</title>
    <link href="https://yfshare.github.io/2017/02/16/Hexo-Github%E7%BB%91%E5%AE%9A%E5%9F%9F%E5%90%8D/"/>
    <id>https://yfshare.github.io/2017/02/16/Hexo-Github绑定域名/</id>
    <published>2017-02-16T03:41:33.000Z</published>
    <updated>2017-02-16T03:47:56.501Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>绑定域名  </p>
<p>首先去购买一个域名，<a href="https://www.godaddy.com/" target="_blank" rel="external">godaddy</a>或<a href="www.net.cn">万网</a>，听说万网比godaddy买域名便宜些  </p>
<p>效果图：<br><a id="more"></a><br><img src="http://note.youdao.com/yws/api/personal/file/84A29BD1472F43538084B5D94330CC97?method=download&amp;shareKey=57fc58d40de9aac2b6ab49ea3c19f1a4" alt="image"><br>提交资料审核通过后，需要修改域名的DNS地址<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#修改成dnspod的DNS地址</span></div><div class="line">f1g1ns1.dnspod.net</div><div class="line">f1g1ns2.dnspod.net</div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/46849CEF99294860A7696C77176F0CC4?method=download&amp;shareKey=f604e9ed6bd9698bb6447089c76ca2c2" alt="image">  </p>
<p>注册 <a href="https://www.dnspod.cn/SignUp" target="_blank" rel="external">dnspod</a> 在dnspod域名解析添加域名，添加记录<br><img src="http://note.youdao.com/yws/api/personal/file/56E163D5B60C4A5BA0B4B3D78FF36914?method=download&amp;shareKey=88b1692a151014c739bc7f9446329fb1" alt="image">  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/5092974CA79D4889B36CA1BB02DA048B?method=download&amp;shareKey=b45d293e5c715abbd34f57c6dee09f4b" alt="image"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">pwd</span></div><div class="line">/e/GitHup_Data/Hexo_B<span class="built_in">log</span></div><div class="line">$ <span class="built_in">cd</span> <span class="built_in">source</span>/</div><div class="line">$ cat CNAME</div><div class="line">www.yfshare.vip</div></pre></td></tr></table></figure>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ </span>hexo clean</div><div class="line"><span class="variable">$ </span>hexo g</div><div class="line"><span class="variable">$ </span>hexo d</div></pre></td></tr></table></figure>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="https://yfshare.github.io">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="https://yfshare.github.io/2017/02/16/Hexo-Github绑定域名/">https://yfshare.github.io/2017/02/16/Hexo-Github绑定域名/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;绑定域名  &lt;/p&gt;
&lt;p&gt;首先去购买一个域名，&lt;a href=&quot;https://www.godaddy.com/&quot;&gt;godaddy&lt;/a&gt;或&lt;a href=&quot;www.net.cn&quot;&gt;万网&lt;/a&gt;，听说万网比godaddy买域名便宜些  &lt;/p&gt;
&lt;p&gt;效果图：&lt;br&gt;
    
    </summary>
    
      <category term="Hexo" scheme="https://yfshare.github.io/categories/Hexo/"/>
    
    
      <category term="hexo" scheme="https://yfshare.github.io/tags/hexo/"/>
    
      <category term="domain" scheme="https://yfshare.github.io/tags/domain/"/>
    
  </entry>
  
  <entry>
    <title>Hexo maupassant主题音乐小工具</title>
    <link href="https://yfshare.github.io/2017/02/16/Hexo-maupassant%E4%B8%BB%E9%A2%98%E9%9F%B3%E4%B9%90%E5%B0%8F%E5%B7%A5%E5%85%B7/"/>
    <id>https://yfshare.github.io/2017/02/16/Hexo-maupassant主题音乐小工具/</id>
    <published>2017-02-16T02:40:00.000Z</published>
    <updated>2017-02-16T02:54:45.114Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>maupassant主题音乐小工具实现blog背景音乐的功能  </p>
<p>自己研究的哈，我完全没有学过js脚本，经过我2小时的摸索，我发现可以在侧边栏添加音乐小工具，实现背景音乐的效果<br>灵感来源于官方Githup这句话：<a href="https://www.haomwei.com/technology/maupassant-hexo.html#功能配置" target="_blank" rel="external">https://www.haomwei.com/technology/maupassant-hexo.html#功能配置</a>  </p>
<ul>
<li>widgets - 选择和排列希望使用的侧边栏小工具。</li>
</ul>
<p><a href="https://yfshare.github.io">效果图</a>：<br><a id="more"></a><br><img src="http://note.youdao.com/yws/api/personal/file/23FAA10CE84C4441A83A9FEC1C01E2E7?method=download&amp;shareKey=5f8e308c71a0ebed208fafbfddec7c1b" alt="image">  </p>
<p>打开<a href="http://music.163.com/" target="_blank" rel="external">网页云音乐</a>寻找外链播放器代码<br>随便搜索一首歌，我这里用<a href="http://music.163.com/#/song?id=371362" target="_blank" rel="external">小跳蛙</a><br><img src="http://note.youdao.com/yws/api/personal/file/CE00D1E3EBF54F65B5C6925AF8332857?method=download&amp;shareKey=3ca948fa349b1b7eadb5c626cfdfce00" alt="image">  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/4A28038769D14E7C8B57CE19BFB8CAB9?method=download&amp;shareKey=5adab296ead0ff9c5fee07f60393a48e" alt="image"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#网易云音乐HTML代码,把这段代码放到music.jade最下面</span></div><div class="line">&lt;iframe frameborder=<span class="string">"no"</span> border=<span class="string">"0"</span> marginwidth=<span class="string">"0"</span> marginheight=<span class="string">"0"</span> width=330 height=86 src=<span class="string">"//music.163.com/outchain/player?type=2&amp;id=371362&amp;auto=1&amp;height=66"</span>&gt;&lt;/iframe&gt;</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">pwd</span></div><div class="line">Hexo_B<span class="built_in">log</span>/themes/maupassant/layout/_widget</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#创建音乐侧边栏脚本</span></div><div class="line">$ touch music.jade</div><div class="line">$ cat music.jade</div><div class="line">.widget</div><div class="line">  .widget-title</div><div class="line">    i(class=<span class="string">'fa fa-external-music'</span>)= <span class="string">' '</span> + __(<span class="string">'music'</span>)</div><div class="line">  - <span class="keyword">for</span> (var i <span class="keyword">in</span> theme.music)</div><div class="line">    ul</div><div class="line">    a(href=<span class="string">'#&#123;theme.music[i].url&#125;'</span> title=<span class="string">'#&#123;theme.music[i].title&#125;'</span> target=<span class="string">'_blank'</span>) <span class="comment">#&#123;theme.music[i].title&#125;</span></div><div class="line"><span class="comment">#网易云音乐HTML代码</span></div><div class="line">&lt;iframe frameborder=<span class="string">"no"</span> border=<span class="string">"0"</span> marginwidth=<span class="string">"0"</span> marginheight=<span class="string">"0"</span> width=330 height=86 src=<span class="string">"//music.163.com/outchain/player?type=2&amp;id=371362&amp;auto=1&amp;height=66"</span>&gt;&lt;/iframe&gt;</div></pre></td></tr></table></figure>
<p>因为上面一个js脚本用到了music字段(我不懂js脚本，姑且这样称呼吧)，“+ __(‘music’)”，这里的music字段是调用下面的配置文件中的music字段<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#添加侧边栏标签</span></div><div class="line">$ <span class="built_in">pwd</span></div><div class="line">Hexo_B<span class="built_in">log</span>/themes/maupassant</div><div class="line">$ cat languages/zh-CN.yml</div><div class="line">reading_label: 正在查看 %s 下的文章</div><div class="line">blog: 博客</div><div class="line">albums: 相册</div><div class="line">categories: 分类</div><div class="line">tags: 标签</div><div class="line">archive: 归档</div><div class="line">links: 链接</div><div class="line">about: 关于</div><div class="line">recent: 最新文章</div><div class="line">next: 下一页</div><div class="line">previous: 上一页</div><div class="line">notitle: 无题</div><div class="line">blogroll: 友情链接</div><div class="line">music: 音乐   <span class="comment">#添加music字段汉字翻译</span></div><div class="line"><span class="built_in">history</span>: 历史</div><div class="line">rss: 订阅</div><div class="line">guestbook: 留言</div><div class="line">home: 首页</div><div class="line">recent_comments: 最近评论</div><div class="line">Readmore: 阅读更多</div><div class="line">belongsto: 分类于</div><div class="line">contents: 文章目录</div><div class="line">shareto: 分享到</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#在主题配置文件_config.yml中添加侧边栏工具music，在这里配置了才表示启用这个工具</span></div><div class="line">$ <span class="built_in">pwd</span></div><div class="line">Hexo_B<span class="built_in">log</span>/themes/maupassant</div><div class="line">$ head -39 _config.yml | tail</div><div class="line">widgets: <span class="comment">## Six widgets in sidebar provided: search, category, tag, recent_posts, rencent_comments and links.</span></div><div class="line">  - search</div><div class="line">  - category</div><div class="line">  - tag</div><div class="line">  - recent_posts</div><div class="line">  - recent_comments</div><div class="line">  - links</div><div class="line">  - music    <span class="comment">#添加music工具</span></div><div class="line"></div><div class="line">music:</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ hexo clean    <span class="comment">#修改配置文件后需要清空缓存，否则可能修改无效</span></div><div class="line">$ hexo g</div><div class="line">$ hexo d</div></pre></td></tr></table></figure>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="https://yfshare.github.io">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="https://yfshare.github.io/2017/02/16/Hexo-maupassant主题音乐小工具/">https://yfshare.github.io/2017/02/16/Hexo-maupassant主题音乐小工具/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;maupassant主题音乐小工具实现blog背景音乐的功能  &lt;/p&gt;
&lt;p&gt;自己研究的哈，我完全没有学过js脚本，经过我2小时的摸索，我发现可以在侧边栏添加音乐小工具，实现背景音乐的效果&lt;br&gt;灵感来源于官方Githup这句话：&lt;a href=&quot;https://www.haomwei.com/technology/maupassant-hexo.html#功能配置&quot;&gt;https://www.haomwei.com/technology/maupassant-hexo.html#功能配置&lt;/a&gt;  &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;widgets - 选择和排列希望使用的侧边栏小工具。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;a href=&quot;https://yfshare.github.io&quot;&gt;效果图&lt;/a&gt;：&lt;br&gt;
    
    </summary>
    
      <category term="Hexo" scheme="https://yfshare.github.io/categories/Hexo/"/>
    
    
      <category term="hexo" scheme="https://yfshare.github.io/tags/hexo/"/>
    
      <category term="music" scheme="https://yfshare.github.io/tags/music/"/>
    
  </entry>
  
  <entry>
    <title>Hexo接入B站html5播放器</title>
    <link href="https://yfshare.github.io/2017/02/15/Hexo%E6%8E%A5%E5%85%A5B%E7%AB%99html5%E6%92%AD%E6%94%BE%E5%99%A8/"/>
    <id>https://yfshare.github.io/2017/02/15/Hexo接入B站html5播放器/</id>
    <published>2017-02-15T03:44:53.000Z</published>
    <updated>2017-02-15T04:45:01.253Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>2016年8月15日，B站推出了HTML5播放器，自此，B站成为国内原生支持全平台的HTML5播放器的视频网站<br>2017年1月19日，B站推出了HTML5播放器已支持https<br><a id="more"></a></p>
<p>效果：  </p>
<iframe src="https://www.bilibili.com/html/html5player.html?cid=10046207&aid=6184828" width="680" height="480" frameborder="0" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen></iframe>  


<p>Hexo插入B站播放器代码：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;iframe src=<span class="string">"https://www.bilibili.com/html/html5player.html?cid=10046207&amp;aid=6184828"</span> width=<span class="string">"700"</span> height=<span class="string">"450"</span> frameborder=<span class="string">"0"</span> webkitallowfullscreen mozallowfullscreen allowfullscreen&gt;&lt;/iframe&gt;</div></pre></td></tr></table></figure></p>
<p>注：在<a href="https://www.bilibili.com/" target="_blank" rel="external">B站</a>找到一个自己喜欢的视频，缓存完成后，浏览器右键查看源代码，ctrl+f搜索 cid 或 aid，大概在源代码的380行左右。B 站每个视频都有对应的 aid 和 cid 值<br><img src="http://note.youdao.com/yws/api/personal/file/5D4552C0A7834D93879588D9BF893E5D?method=download&amp;shareKey=22f22e353b99a28c25a9f3f2e3742cd0" alt="image">  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="https://yfshare.github.io">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="https://yfshare.github.io/2017/02/15/Hexo接入B站html5播放器/">https://yfshare.github.io/2017/02/15/Hexo接入B站html5播放器/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;2016年8月15日，B站推出了HTML5播放器，自此，B站成为国内原生支持全平台的HTML5播放器的视频网站&lt;br&gt;2017年1月19日，B站推出了HTML5播放器已支持https&lt;br&gt;
    
    </summary>
    
      <category term="Hexo" scheme="https://yfshare.github.io/categories/Hexo/"/>
    
    
      <category term="hexo" scheme="https://yfshare.github.io/tags/hexo/"/>
    
      <category term="B站" scheme="https://yfshare.github.io/tags/B%E7%AB%99/"/>
    
      <category term="html5" scheme="https://yfshare.github.io/tags/html5/"/>
    
  </entry>
  
  <entry>
    <title>Hexo插件之音乐视频</title>
    <link href="https://yfshare.github.io/2017/02/15/Hexo%E6%8F%92%E4%BB%B6%E4%B9%8B%E9%9F%B3%E4%B9%90%E8%A7%86%E9%A2%91/"/>
    <id>https://yfshare.github.io/2017/02/15/Hexo插件之音乐视频/</id>
    <published>2017-02-15T02:59:55.000Z</published>
    <updated>2017-02-15T03:18:43.898Z</updated>
    
    <content type="html"><![CDATA[<script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>效果：<br><div id="aplayer0" class="aplayer" style="margin-bottom: 20px;"></div>
		<script>
			new APlayer({
				element: document.getElementById("aplayer0"),
				narrow: false,
				autoplay: true,
				showlrc: 0,
				music: {
					title: "You Raise Me Up",
					author: "Westlife",
					url: "http://other.web.ra01.sycdn.kuwo.cn/d5a898b9c8d91e8e4486011b7baccdb4/58a3c3b8/resource/n3/128/69/68/992887695.mp3",
					pic: "",
				}
			});
		</script><br><a id="more"></a><br><div id="dplayer0" class="dplayer" style="margin-bottom: 20px;"></div><script>var dplayer0 = new DPlayer({"element":document.getElementById("dplayer0"),"autoplay":false,"theme":"#FADFA3","loop":true,"video":{"url":"http://devtest.qiniudn.com/若能绽放光芒.mp4","pic":"http://devtest.qiniudn.com/若能绽放光芒.png"},"danmaku":{"api":"http://dplayer.daoapp.io","id":"9E2E3368B56CDBB4","token":"tokendemo"}});</script></p>
<p>Hexo官方插件：<a href="https://hexo.io/plugins/" target="_blank" rel="external">https://hexo.io/plugins/</a>  </p>
<p>需要用到两个播放器插件  </p>
<ul>
<li>hexo-tag-aplayer：<a href="https://github.com/grzhan/hexo-tag-aplayer#upstream-issue" target="_blank" rel="external">https://github.com/grzhan/hexo-tag-aplayer#upstream-issue</a>  </li>
<li>hexo-tag-dplayer：<a href="https://github.com/NextMoe/hexo-tag-dplayer" target="_blank" rel="external">https://github.com/NextMoe/hexo-tag-dplayer</a>  </li>
</ul>
<p>两款插件基于 <a href="https://github.com/DIYgod" target="_blank" rel="external">DIYgod</a> 编写的 html5 播放器 <a href="https://github.com/DIYgod/APlayer" target="_blank" rel="external">APlayer</a> 和 <a href="https://github.com/DIYgod/DPlayer" target="_blank" rel="external">DPlayer</a> 开发  </p>
<p>安装插件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">pwd</span></div><div class="line">/e/GitHup_Data/Hexo_B<span class="built_in">log</span></div><div class="line">$ npm install hexo-tag-dplayer --save</div><div class="line">$ npm install hexo-tag-aplayer --save</div></pre></td></tr></table></figure></p>
<p>安装成功后，在Markdown文档中添加 APlayer 和 DPlayer 标签即可  </p>
<p>APlayer和DPlayer代码：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#APlayer Usage:</span></div><div class="line">&#123;% aplayer title author url [picture_url, narrow, autoplay, width:xxx, lrc:xxx] %&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&#123;% aplayer <span class="string">"You Raise Me Up"</span> <span class="string">"Westlife"</span> <span class="string">"http://other.web.ra01.sycdn.kuwo.cn/d5a898b9c8d91e8e4486011b7baccdb4/58a3c3b8/resource/n3/128/69/68/992887695.mp3"</span> <span class="string">"autoplay"</span> %&#125;</div><div class="line">&#123;% dplayer <span class="string">"url=http://devtest.qiniudn.com/若能绽放光芒.mp4"</span> <span class="string">"api=http://dplayer.daoapp.io"</span> <span class="string">"pic=http://devtest.qiniudn.com/若能绽放光芒.png"</span> <span class="string">"id=9E2E3368B56CDBB4"</span> <span class="string">"loop=yes"</span> <span class="string">"theme=#FADFA3"</span> <span class="string">"autoplay=false"</span> <span class="string">"token=tokendemo"</span> %&#125;</div></pre></td></tr></table></figure>
<p>注：dplayer存在BUG，研究了会但还是不会咋整，就把官方的贴出来了，嘿<br>参考：<a href="https://dplayer.js.org/docs/#/?id=usage" target="_blank" rel="external">https://dplayer.js.org/docs/#/?id=usage</a><br><a href="https://github.com/NextMoe/hexo-tag-dplayer" target="_blank" rel="external">https://github.com/NextMoe/hexo-tag-dplayer</a><br><a href="https://github.com/DIYgod/DPlayer" target="_blank" rel="external">https://github.com/DIYgod/DPlayer</a><br><a href="https://login926.top/2016/07/20/HexoMedia/" target="_blank" rel="external">https://login926.top/2016/07/20/HexoMedia/</a>  </p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="https://yfshare.github.io">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="https://yfshare.github.io/2017/02/15/Hexo插件之音乐视频/">https://yfshare.github.io/2017/02/15/Hexo插件之音乐视频/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;效果：&lt;br&gt;&lt;div id=&quot;aplayer0&quot; class=&quot;aplayer&quot; style=&quot;margin-bottom: 20px;&quot;&gt;&lt;/div&gt;
		&lt;script&gt;
			new APlayer({
				element: document.getElementById(&quot;aplayer0&quot;),
				narrow: false,
				autoplay: true,
				showlrc: 0,
				music: {
					title: &quot;You Raise Me Up&quot;,
					author: &quot;Westlife&quot;,
					url: &quot;http://other.web.ra01.sycdn.kuwo.cn/d5a898b9c8d91e8e4486011b7baccdb4/58a3c3b8/resource/n3/128/69/68/992887695.mp3&quot;,
					pic: &quot;&quot;,
				}
			});
		&lt;/script&gt;&lt;br&gt;
    
    </summary>
    
      <category term="Hexo" scheme="https://yfshare.github.io/categories/Hexo/"/>
    
    
      <category term="Hexo" scheme="https://yfshare.github.io/tags/Hexo/"/>
    
      <category term="music" scheme="https://yfshare.github.io/tags/music/"/>
    
      <category term="video" scheme="https://yfshare.github.io/tags/video/"/>
    
  </entry>
  
</feed>

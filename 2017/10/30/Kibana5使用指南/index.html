<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Blog"><title>Kibana5使用指南 | Jack Wang Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Kibana5使用指南</h1><a id="logo" href="/.">Jack Wang Blog</a><p class="description">Goals determine what you are going to be</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa icon-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Kibana5使用指南</h1><div class="post-meta">Oct 30, 2017<span> | </span><span class="category"><a href="/categories/ELK/">ELK</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2017/10/30/Kibana5使用指南/" href="/2017/10/30/Kibana5使用指南/#disqus_thread" class="disqus-comment-count"></a><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#测试环境ELK架构讲解"><span class="toc-number">1.</span> <span class="toc-text">测试环境ELK架构讲解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Elasticsearch基本原理"><span class="toc-number">2.</span> <span class="toc-text">Elasticsearch基本原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kibana使用指南"><span class="toc-number">3.</span> <span class="toc-text">Kibana使用指南</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Elasticsearch查询语法"><span class="toc-number">4.</span> <span class="toc-text">Elasticsearch查询语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#日志分析"><span class="toc-number">5.</span> <span class="toc-text">日志分析</span></a></li></ol></div></div><div class="post-content"><script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>ELK由Elasticsearch、Logstash和Kibana三部分组件组成，这里新增了一个FileBeat，它是一个轻量级的日志收集处理工具(Agent)，Filebeat占用资源少，适合于在各个服务器上搜集日志后传输给Logstash，官方也推荐此工具<br><a id="more"></a><br>Filebeat隶属于Beats。目前Beats包含四种工具：  </p>
<ol>
<li>Packetbeat（搜集网络流量数据）  </li>
<li>Topbeat（搜集系统、进程和文件系统级别的 CPU 和内存使用情况等数据）</li>
<li>Filebeat（搜集文件数据）</li>
<li>Winlogbeat（搜集 Windows 事件日志数据）<h3 id="测试环境ELK架构讲解"><a href="#测试环境ELK架构讲解" class="headerlink" title="测试环境ELK架构讲解"></a>测试环境ELK架构讲解</h3>官方ELK架构图：<br><img src="http://note.youdao.com/yws/api/personal/file/DCE29CF684C34FC3BA73809D566B0150?method=download&amp;shareKey=798f64543357202a0efb9a95d35c4e5b" alt="filebeat">  </li>
</ol>
<p>目前测试环境的拓扑图：<br><img src="http://note.youdao.com/yws/api/personal/file/4772759A56704D82A3D1C6056C76613F?method=download&amp;shareKey=3c9825a509086b1a28b8ffd34aa9c6b0" alt="ELK_拓扑图">  </p>
<h3 id="Elasticsearch基本原理"><a href="#Elasticsearch基本原理" class="headerlink" title="Elasticsearch基本原理"></a>Elasticsearch基本原理</h3><p><img src="http://note.youdao.com/yws/api/personal/file/FD45A9D1BDDF4D92BFFBA09E04872591?method=download&amp;shareKey=735c6c6ebf035d8836ec5d827aa7e7fc" alt="利用磁盘缓存实现的准实时检索"><br><img src="http://note.youdao.com/yws/api/personal/file/6F91BABFB8B44FA2878D7FC4DF36EA8C?method=download&amp;shareKey=b5b3bb7b92596d736f0e8eb4b0b99079" alt="translog提供的磁盘同步控制"><br><img src="http://note.youdao.com/yws/api/personal/file/288CB47874D84FE5B4924D1DF06CA3A0?method=download&amp;shareKey=5cef29dfcfb7b1ed2d76c44fbe5da40d" alt="segment merge">  </p>
<p>官方文档<br>Filebeat：<br><a href="https://www.elastic.co/cn/products/beats/filebeat" target="_blank" rel="external">https://www.elastic.co/cn/products/beats/filebeat</a><br><a href="https://www.elastic.co/guide/en/beats/filebeat/5.6/index.html" target="_blank" rel="external">https://www.elastic.co/guide/en/beats/filebeat/5.6/index.html</a>  </p>
<p>Logstash：<br><a href="https://www.elastic.co/cn/products/logstash" target="_blank" rel="external">https://www.elastic.co/cn/products/logstash</a><br><a href="https://www.elastic.co/guide/en/logstash/5.6/index.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/5.6/index.html</a>  </p>
<p>Elasticsearch：<br><a href="https://www.elastic.co/cn/products/elasticsearch" target="_blank" rel="external">https://www.elastic.co/cn/products/elasticsearch</a><br><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/index.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/reference/5.6/index.html</a>  </p>
<p>elasticsearch中文社区：<br><a href="https://elasticsearch.cn/" target="_blank" rel="external">https://elasticsearch.cn/</a>  </p>
<h3 id="Kibana使用指南"><a href="#Kibana使用指南" class="headerlink" title="Kibana使用指南"></a>Kibana使用指南</h3><p>Kibana有另一个名字 elasticsearch dashboard，设计参考了 Splunk<br>Kibana主要功能 Discover，Visualize，Dashboard，Timelion，DevTools，Management  </p>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/query-dsl-query-string-query.html#query-string-syntax" target="_blank" rel="external">lucene query syntax</a><br><img src="http://note.youdao.com/yws/api/personal/file/45BD110CD9B24ECAACC51EE54637EAB8?method=download&amp;shareKey=dd229f6cfe56bfd10396117cb4790a65" alt="kibana">  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/58CBFFB81D4941178EDE60CB254E0512?method=download&amp;shareKey=7eec44cd864fb579a5b12694c77bc52c" alt="kibana">  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/8732A5AA79B64E1F9B1A63D85CD8F330?method=download&amp;shareKey=f7d887ce2e084814367c8555c656b3c1" alt="Kibana">  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/B80830DE946244E5A0105A62FBA738D9?method=download&amp;shareKey=7b9b3a854c883ca4bc17f286c5c6c743" alt="kibana">  </p>
<h3 id="Elasticsearch查询语法"><a href="#Elasticsearch查询语法" class="headerlink" title="Elasticsearch查询语法"></a>Elasticsearch查询语法</h3><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/common-options.html#date-math" target="_blank" rel="external">Elasticsearch Query DSL查询语法</a><br><img src="http://note.youdao.com/yws/api/personal/file/3E744DB1A632475EA8D5460F76BDD6BC?method=download&amp;shareKey=8ef13860f3e3f2eb1c901e2b017dc74e" alt="kibana">  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/25D871BBDF604A1189E18F6D922C4014?method=download&amp;shareKey=7f4fcf3f5e29920e64099a8deb137757" alt="Elasticsearch Query DSL"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"query"</span>: &#123;</div><div class="line">    <span class="string">"term"</span>: &#123;</div><div class="line">      <span class="string">"_id"</span>: <span class="string">"AV9orWWLv96dGKcHDVyi"</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/api/personal/file/DA5A626EFFE3454F922FAD2B4F0C45BF?method=download&amp;shareKey=48ce91f24595076b45122e9dea483db9" alt="kibana_search">  </p>
<p>querystring 语法<br>上例中<code>?q=</code>后面的就是querystring语法，会在kibana中经常使用  </p>
<ul>
<li><code>全文检索</code>：直接写搜索的单词。如：<code>?q=aaaa</code></li>
<li><code>单字段的全文检索</code>：在搜索单词之前加上字段名和冒号。如：<code>?q=user:jack</code></li>
<li><code>单字段的精确检索</code>：在搜索单词前加上双引号。如：<code>?q=user:&quot;jack&quot;</code></li>
<li><code>多个检索条件的组合</code>：可以使用<code>NOT</code>、<code>AND</code>、<code>OR</code>来组合检索，必须是大写的。如：<code>?q=user:(&quot;jack&quot; OR &quot;bob&quot;) AND NOT mesg:aaaa</code></li>
<li><code>字段是否存在</code>：<code>_exists_:user</code>表示要求user字段存在，<code>_missing_:user</code>表示user字段不存在。如：<code>?q=_exists_:beat.name</code></li>
<li><code>通配符</code>：用<code>?</code>表示单字母，<code>*</code>表示任意个字母。如：<code>?q=DevE?N</code>，<code>?q=DevE?N*</code></li>
<li><code>正则</code>：比通配符更复杂一点点。如：<code>?q=/dub{2}o/</code><br>注：Elasticsearch正则性能不好，尽量不要使用太复杂或不使用。参考<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/query-dsl-regexp-query.html#regexp-synntax" target="_blank" rel="external">Elasticsearch正则表达式语法</a>  </li>
<li><code>近似搜索</code>：用<code>~</code>表示搜索单词可能有一字母写的不对。如：<code>?q=dubao~</code></li>
<li><code>范围搜索</code>：对数值和时间。如：<code>?q=@timestamp:&gt;150928968615</code>，<code>?q=@timestamp:[&quot;now-1m&quot; TO &quot;now&quot;]</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -XGET http://localhost:9200/192.168.1.21-account_errorlog-2017.10.29/_search?pretty=<span class="literal">true</span>?q=<span class="string">'com.alibaba.dubbo.monitor.MonitorService'</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -XGET http://localhost:9200/192.168.1.21-account_errorlog-2017.10.29/_search?pretty=<span class="literal">true</span>?q=beat.hostname=<span class="string">'DevEVN-21'</span></div></pre></td></tr></table></figure>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/query-dsl-queries.html" target="_blank" rel="external">Elasticsearch其他查询语法</a><br><a href="http://www.yfshare.vip/2017/10/30/Elasticsearch%E6%9F%A5%E8%AF%A2%E8%AF%AD%E6%B3%95/#全文搜索">Elasticsearch全文搜索</a>  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/F9660B5ED9F2481B85888ACCF2FC11B4?method=download&amp;shareKey=328b06bb6a52b854733eb636b0938a73" alt="Kibana">  </p>
<p><img src="http://note.youdao.com/yws/api/personal/file/E39A9C72B26B4883BFE71058C40D3EF4?method=download&amp;shareKey=aaf776329e429927fe221afb5b37ecd4" alt="Kibana">  </p>
<h3 id="日志分析"><a href="#日志分析" class="headerlink" title="日志分析"></a>日志分析</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#nginx日志格式</span></div><div class="line">    log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></div><div class="line">                      <span class="string">'$status $body_bytes_sent "$http_referer" '</span></div><div class="line">                      <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</div><div class="line"></div><div class="line"><span class="comment">#nginx access日志</span></div><div class="line">192.168.1.153 - - [18/Oct/2017:21:48:00 +0800] <span class="string">"GET /ErrorPages/404.html HTTP/1.0"</span> 404 571 <span class="string">"https://devqian.julend.com/static/pageHtml/bindCardCallback.html?view=zhimaCredit&amp;params=XHk1tuyGnXS1wGSpis2PiC9UKCizLIiGIm0eJ%2Fz1lXc8JdGVXxB2Ftg9hFKZjFfwh3w%2FM6UIEpxQ11TTqXf31xNx9N%2FzGMc00rpvf6YpKEJPQFFCL4X9eLQdLJl5KaaGiK8AdNZS38dJDKEzFJP0o1523nCOhjJEtgS0394oLIB2siIqYF7RTVgBaU1xE72m3vmZcvqvgVZUH8ozt8tftXh4Wq5paf647mA%2FZZJOaXabeFEwuwa7dhtVXTT8CBdnOOiDC5WmwBCC%2FnIqKmfTI1gmFvQUobDA9RY4UcMdMY9RixLkhSdQ8k5LtpD2NVuJDLEscZAdfROhyYeEnZ7Ptg%3D%3D&amp;sign=ABeWMdLqNeFUhDYKUJsJfzLolxA%2Fo64Wl8mmgX36yqM5VWHMvB7VcpZJ3AA7WsH%2BTFe6EARuABMe2HupY6DbzuITufa9aPZX9BHbN6dLPMre0n8aHZnr59h%2FC6Us%2FAW11tu2n6l%2F1dSyCo951diQ55en%2BO%2FffRJ1ldFUwzhzNCQ%3D"</span> <span class="string">"Mozilla/5.0 (Linux; Android 7.1.1; OPPO R11t Build/NMF26X; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/55.0.2883.91 Mobile Safari/537.36"</span> <span class="string">"121.238.20.93"</span></div><div class="line"></div><div class="line"><span class="comment">#logstash grok分析nginx日志格式</span></div><div class="line">grok &#123;</div><div class="line">   match =&gt; [<span class="string">"message"</span>,<span class="string">"%&#123;IPV4:remote_addr&#125; [\-] %&#123;USERNAME:remote_user&#125; \[%&#123;DATA:time_local&#125;\] \"(?&lt;request&gt;[^\"]*)\" (?&lt;status&gt;\d+) (?&lt;body_bytes_sent&gt;\d+) \"(?&lt;http_referer&gt;[^\"]*)\" \"(?&lt;http_user_agent&gt;[^\"]*)\" \"%&#123;IPV4:http_x_forwarded_for&#125;"</span>]</div><div class="line">&#125;</div><div class="line"></div><div class="line">[root@ELK ~]<span class="comment"># /usr/share/logstash/bin/logstash --path.settings /etc/logstash/ -f /etc/logstash/conf.d/geoip.conf</span></div><div class="line">Sending Logstash<span class="string">'s logs to /var/log/logstash which is now configured via log4j2.properties</span></div><div class="line">&#123;</div><div class="line">           "geoip" =&gt; &#123;&#125;,</div><div class="line">              "ua" =&gt; "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/47.0.2526.106 Safari/537.36",</div><div class="line">            "type" =&gt; "Nginx",</div><div class="line">          "clinet" =&gt; "192.168.31.105",</div><div class="line">            "tags" =&gt; [</div><div class="line">        [0] "_geoip_lookup_failure"</div><div class="line">    ],</div><div class="line">            "path" =&gt; "/var/log/nginx/access.log",</div><div class="line">      "@timestamp" =&gt; 2016-12-15T08:13:19.000Z,</div><div class="line">            "size" =&gt; 0,</div><div class="line">          "domain" =&gt; "192.168.31.100",</div><div class="line">        "@version" =&gt; "1",</div><div class="line">            "host" =&gt; "192.168.31.100",</div><div class="line">    "responsetime" =&gt; 0.0,</div><div class="line">          "status" =&gt; "304"</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">2017-10-24_15:42:00.408 [DubboMonitorSendTimer-thread-3] ERROR [com.alibaba.dubbo.common.logger.slf4j.Slf4jLogger]  [DUBBO] Unexpected error occur at send statistic, cause:</div><div class="line"> Failed to invoke the method collect <span class="keyword">in</span> the service com.alibaba.dubbo.monitor.MonitorService. No provider available <span class="keyword">for</span> the service com.alibaba.dubbo.monitor.MonitorService from registry 192.168.1.21:2181 on the consumer 192.168.1.21 using the dubbo version 2.5.3. Please check <span class="keyword">if</span> the providers have been started and registered., dubbo version: 2.5.3, current host: 192.168.1.21com.alibaba.dubbo.rpc.RpcException: Failed to invoke the method collect <span class="keyword">in</span> the service com.alibaba.dubbo.monitor.MonitorService. No provider available <span class="keyword">for</span> the service com.a</div><div class="line">libaba.dubbo.monitor.MonitorService from registry 192.168.1.21:2181 on the consumer 192.168.1.21 using the dubbo version 2.5.3. Please check <span class="keyword">if</span> the providers have been started and registered.	at com.alibaba.dubbo.rpc.cluster.support.AbstractClusterInvoker.checkInvokers(AbstractClusterInvoker.java:246) ~[dubbo-2.5.3.jar:2.5.3]</div><div class="line">	at com.alibaba.dubbo.rpc.cluster.support.FailoverClusterInvoker.doInvoke(FailoverClusterInvoker.java:55) ~[dubbo-2.5.3.jar:2.5.3]</div><div class="line">	at com.alibaba.dubbo.rpc.cluster.support.AbstractClusterInvoker.invoke(AbstractClusterInvoker.java:227) ~[dubbo-2.5.3.jar:2.5.3]</div><div class="line">	at com.alibaba.dubbo.rpc.cluster.support.wrapper.MockClusterInvoker.invoke(MockClusterInvoker.java:72) ~[dubbo-2.5.3.jar:2.5.3]</div><div class="line">	at com.alibaba.dubbo.rpc.proxy.InvokerInvocationHandler.invoke(InvokerInvocationHandler.java:52) ~[dubbo-2.5.3.jar:2.5.3]</div><div class="line">	at com.alibaba.dubbo.common.bytecode.proxy8.collect(proxy8.java) ~[na:2.5.3]</div><div class="line">	at com.alibaba.dubbo.monitor.dubbo.DubboMonitor.send(DubboMonitor.java:113) ~[dubbo-2.5.3.jar:2.5.3]</div><div class="line">	at com.alibaba.dubbo.monitor.dubbo.DubboMonitor<span class="variable">$1</span>.run(DubboMonitor.java:70) ~[dubbo-2.5.3.jar:2.5.3]</div><div class="line">	at java.util.concurrent.Executors<span class="variable">$RunnableAdapter</span>.call(Executors.java:471) [na:1.7.0_80]</div><div class="line">	at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:304) [na:1.7.0_80]</div><div class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor<span class="variable">$ScheduledFutureTask</span>.access<span class="variable">$301</span>(ScheduledThreadPoolExecutor.java:178) [na:1.7.0_80]</div><div class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor<span class="variable">$ScheduledFutureTask</span>.run(ScheduledThreadPoolExecutor.java:293) [na:1.7.0_80]</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) [na:1.7.0_80]</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor<span class="variable">$Worker</span>.run(ThreadPoolExecutor.java:615) [na:1.7.0_80]</div><div class="line">	at java.lang.Thread.run(Thread.java:745) [na:1.7.0_80]</div><div class="line">2017-10-24_15:43:00.413 [DubboMonitorSendTimer-thread-3] INFO  [com.alibaba.dubbo.common.logger.slf4j.Slf4jLogger]  [DUBBO] Send statistics to monitor zookeeper://192.168.1</div><div class="line">.21:2181/com.alibaba.dubbo.monitor.MonitorService?dubbo=2.5.3&amp;interface=com.alibaba.dubbo.monitor.MonitorService&amp;pid=11958&amp;timestamp=1508762187622, dubbo version: 2.5.3, current host: 192.168.1.21</div></pre></td></tr></table></figure>
<ul>
<li><p>multiline</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">input &#123;</div><div class="line">  beats &#123;</div><div class="line">    port =&gt; 5044</div><div class="line">    codec =&gt; multiline &#123;</div><div class="line">         pattern =&gt; <span class="string">"^%&#123;YEAR&#125;[/-]%&#123;MONTHNUM&#125;[/-]%&#123;MONTHDAY&#125;[/_]%&#123;TIME&#125; "</span></div><div class="line">         negate =&gt; <span class="literal">true</span></div><div class="line">         what =&gt; previous</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>Log4J<br>需要配置 Java 应用的 <code>Log4J</code> 设置，启动一个内置的 <code>SocketAppender</code>。修改应用的 log4j.xml 配置文件，添加如下配置段  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;appender name=<span class="string">"LOGSTASH"</span> class=<span class="string">"org.apache.log4j.net.SocketAppender"</span>&gt;</div><div class="line">    &lt;param name=<span class="string">"RemoteHost"</span> value=<span class="string">"logstash_hostname"</span> /&gt;</div><div class="line">    &lt;param name=<span class="string">"ReconnectionDelay"</span> value=<span class="string">"60000"</span> /&gt;</div><div class="line">    &lt;param name=<span class="string">"LocationInfo"</span> value=<span class="string">"true"</span> /&gt;</div><div class="line">    &lt;param name=<span class="string">"Threshold"</span> value=<span class="string">"DEBUG"</span> /&gt;</div><div class="line">&lt;/appender&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>然后把这个新定义的 appender 对象加入到 root logger 里，可以跟其他已有 logger 共存<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;root&gt;</div><div class="line">    &lt;level value=<span class="string">"INFO"</span>/&gt;</div><div class="line">    &lt;appender-ref ref=<span class="string">"OTHERPLACE"</span>/&gt;</div><div class="line">    &lt;appender-ref ref=<span class="string">"LOGSTASH"</span>/&gt;</div><div class="line">&lt;/root&gt;</div></pre></td></tr></table></figure></p>
<p>log4j.properties 配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">log</span>4j.rootLogger=DEBUG, logstash</div><div class="line"></div><div class="line"><span class="comment">###SocketAppender###</span></div><div class="line"><span class="built_in">log</span>4j.appender.logstash=org.apache.log4j.net.SocketAppender</div><div class="line"><span class="built_in">log</span>4j.appender.logstash.Port=4560</div><div class="line"><span class="built_in">log</span>4j.appender.logstash.RemoteHost=logstash_hostname</div><div class="line"><span class="built_in">log</span>4j.appender.logstash.ReconnectionDelay=60000</div><div class="line"><span class="built_in">log</span>4j.appender.logstash.LocationInfo=<span class="literal">true</span></div></pre></td></tr></table></figure></p>
<p>Log4J 会持续尝试连接你配置的 <code>logstash_hostname</code> 这个地址，建立连接后，即开始发送日志数据  </p>
<p>Logstash，Java 应用端的配置完成以后，开始设置 Logstash 的接收端，配置如下所示，其中 4560 端口是 Log4J SocketAppender 的默认对端端口<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">input &#123;</div><div class="line">  <span class="built_in">log</span>4j &#123;</div><div class="line">    <span class="built_in">type</span> =&gt; <span class="string">"log4j-json"</span></div><div class="line">    port =&gt; 4560</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>JSON Event layout<br>如果无法采用 socketappender ，必须使用文件方式的，其实 Log4J 有一个 layout 特性，用来控制日志输出的格式。和 Nginx 日志自己拼接 JSON 输出类似，也可以通过 layout 功能，记录成 JSON 格式。</li>
</ul>
<p>参考：<a href="https://github.com/logstash/log4j-jsonevent-layout" target="_blank" rel="external">https://github.com/logstash/log4j-jsonevent-layout</a>  </p>
<p>logstash官方提供的扩展包，可以通过mvnrepository.com搜索下载<br><a href="http://central.maven.org/maven2/net/logstash/log4j/jsonevent-layout/1.7/jsonevent-layout-1.7.jar" target="_blank" rel="external">http://central.maven.org/maven2/net/logstash/log4j/jsonevent-layout/1.7/jsonevent-layout-1.7.jar</a>  </p>
<p>或者直接编辑自己项目的pom.xml添加依赖<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;net.logstash.log4j&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;jsonevent-layout&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;1.7&lt;/version&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure></p>
<p>然后修改项目的log4j.properties文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">log</span>4j.rootCategory=WARN,RollingLog</div><div class="line"><span class="built_in">log</span>4j.appender.RollingLog=org.apache.log4j.DailyRollingFileAppender</div><div class="line"><span class="built_in">log</span>4j.appender.RollingLog.Threshold=TRACE</div><div class="line"><span class="built_in">log</span>4j.appender.RollingLog.File=api.log</div><div class="line"><span class="built_in">log</span>4j.appender.RollingLog.DatePattern=.yyyy-MM-dd</div><div class="line"><span class="built_in">log</span>4j.appender.RollingLog.layout=net.logstash.log4j.JSONEventLayoutV1</div></pre></td></tr></table></figure></p>
<p>如果是log4j.xml文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;appender name=<span class="string">"Console"</span> class=<span class="string">"org.apace.log4j.ConsoleAppender"</span>&gt;</div><div class="line">    &lt;param name=<span class="string">"Threshould"</span> value=<span class="string">"TRACE"</span> /&gt;</div><div class="line">    &lt;layout class=<span class="string">"net.logstash.log4j.JSONEventLayoutV1"</span> /&gt;</div><div class="line">&lt;/appender&gt;</div></pre></td></tr></table></figure></p>
<p>生成的文件就是Logstash标准的JSON格式，logstash使用下面配置读取<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">input &#123;</div><div class="line">    file &#123;</div><div class="line">            codec =&gt; json</div><div class="line">            path =&gt; [<span class="string">"/path/to/log4j.log"</span>]</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>生成的Logstash事件如下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"mdc"</span>: &#123;&#125;,</div><div class="line">    <span class="string">"line_number"</span>: <span class="string">"29"</span>,</div><div class="line">    <span class="string">"class"</span>:<span class="string">"org.eclipse,jetty.examples.logging.EchoFormServlet"</span>,</div><div class="line">    <span class="string">"@version"</span>:1,</div><div class="line">    <span class="string">"source_host"</span>:<span class="string">"jvstratusmbp.local"</span>,</div><div class="line">    <span class="string">"thread_name"</span>:<span class="string">"qtp513694835-14"</span>,</div><div class="line">    <span class="string">"message"</span>:<span class="string">"Got request from 0:0:0:0:0:0:0:1%0 using Mozilla\/5.0 (Macintosh;Inter Mac OS X 10_9_1) AppleWebit\/537.36 (KHTML, like Gecko) Chrome \/32.0.1700.77 Safari\/537.36"</span>,</div><div class="line">    <span class="string">"@timestamp"</span>:<span class="string">"2014-01-27T19:52:35.738z"</span>,</div><div class="line">    <span class="string">"level"</span>:<span class="string">"INFO"</span>,</div><div class="line">    <span class="string">"file"</span>:<span class="string">"EchoFormServlet.java"</span>,</div><div class="line">    <span class="string">"method"</span>:<span class="string">"doPost"</span>,</div><div class="line">    <span class="string">"logger_name"</span>:<span class="string">"org.eclipse.jetty.example.logging.EchoFormServlet"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果使用的不是Log4J而是logback项目来记录JAVA日志，Logstash官方也有类似的扩展包，修改pom.xml<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;net.logstash.logback&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;logstash-logback-encoder&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;4.4&lt;/version&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure></p>
<hr>
<p>本作品采用<a href="https://creativecommons.org/licenses/by/2.5/cn/" target="_blank" rel="external">知识共享署名 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但转载请注明来自<a href="http://www.yfshare.vip">Jack Wang Blog</a>，并保持转载后文章内容的完整。本人保留所有版权相关权利。<br><img src="http://note.youdao.com/yws/api/personal/file/FE3C6F68961F4541AF284E5F346FC3CA?method=download&amp;shareKey=c5e4c3ca81daa6e908d5630f8c6ec242" alt="打赏"><br>本文出自”Jack Wang Blog”：<a href="http://www.yfshare.vip/2017/10/30/Kibana5使用指南/">http://www.yfshare.vip/2017/10/30/Kibana5使用指南/</a></p>
</div><script type="text/javascript" src="/js/share.js?v=2.0.0" async></script><a data-url="http://www.yfshare.vip/2017/10/30/Kibana5使用指南/" data-id="cjbf4nwg7002hn8m5vxazrd7g" class="article-share-link">分享到</a><div class="tags"><a href="/tags/Elasticsearch/">Elasticsearch</a><a href="/tags/Logstash/">Logstash</a><a href="/tags/Kibana/">Kibana</a></div><div class="post-nav"><a href="/2017/11/02/Elasticsearch原理/" class="pre">Elasticsearch原理</a><a href="/2017/10/30/Elasticsearch查询语法/" class="next">Elasticsearch查询语法</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论 「请确保 disqus.com 可以正常加载」</button></div><script>var disqus_shortname = 'yfshare';
var disqus_identifier = '2017/10/30/Kibana5使用指南/';
var disqus_title = 'Kibana5使用指南';
var disqus_url = 'http://www.yfshare.vip/2017/10/30/Kibana5使用指南/';
$('.btn_click_load').click(function() {
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  $('.btn_click_load').css('display','none');
});
$.ajax({
  url: 'https://disqus.com/favicon.ico',
  timeout: 3000,
  type: 'GET',
  success: (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    $('.btn_click_load').css('display','none');
  })(),
  error: function() {
    $('.btn_click_load').css('display','block');
  }
});</script><script id="dsq-count-scr" src="//yfshare.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Ansible/">Ansible</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Atlassian/">Atlassian</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Database/">Database</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ELK/">ELK</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Jenkins/">Jenkins</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Security/">Security</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Virtualization/">Virtualization</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/WEB/">WEB</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Windows/">Windows</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Zabbix/">Zabbix</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/版本控制系统/">版本控制系统</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/12/20/The-Docker-of-Jira7-2-0-and-Confluence6-0-0/">The Docker of Jira7.2.0 and Confluence6.0.0</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/20/自建docker私有仓库-Registry/">自建docker私有仓库(Registry)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/14/The-Redmine-svn-of-docker/">The Redmine_svn of docker</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/05/关于kernel-nf-conntrack-table-full-dropping-packet问题/">关于kernel: nf_conntrack: table full, dropping packet问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/04/ElasticSearch集群-基础/">ElasticSearch集群(基础)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/04/timelion请求语法/">timelion请求语法</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/04/Logstash监控/">Logstash监控</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/22/Grok正则语法/">Grok正则语法</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/22/Logstash配置语法/">Logstash配置语法</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/22/ELK安装-基础/">ELK安装(基础)</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://yfshare.blog.51cto.com/" title="酱油瓶 博客" target="_blank">酱油瓶 博客</a><ul></ul><a href="http://zerosre.com/" title="龙哥zero 博客" target="_blank">龙哥zero 博客</a><ul></ul><a href="http://renzhiyuan.blog.51cto.com/" title="任志远Ray 博客" target="_blank">任志远Ray 博客</a><ul></ul><a href="http://rongrong.njdgwl.com" title="浩子的 博客" target="_blank">浩子的 博客</a><ul></ul><a href="http://www.cnblogs.com/aresxin/" title="欣哥aresxin 博客" target="_blank">欣哥aresxin 博客</a><ul></ul><a href="http://securityit.cn/" title="万马奔腾" target="_blank">万马奔腾</a></div><div class="widget"><div class="widget-title"><i class="fa fa-external-resources"> 资源站</i></div><ul></ul><a href="http://mirror.symnds.com/distributions/CentOS-vault/" title="Centos镜像站" target="_blank">Centos镜像站</a><ul></ul><a href="http://www.rpmfind.net/" title="rpmfind mirror" target="_blank">rpmfind mirror</a><ul></ul><a href="http://rpm.org/" title="rpm.org" target="_blank">rpm.org</a><ul></ul><a href="http://rpm.pbone.net/" title="rpm search" target="_blank">rpm search</a><ul></ul><a href="http://download.chinaunix.net/" title="chinaunix download" target="_blank">chinaunix download</a><ul></ul><a href="http://www.anquanquan.info/" title="安全圈info" target="_blank">安全圈info</a><ul></ul><a href="http://source.tosimp.net/" title="Tosimp 资源站" target="_blank">Tosimp 资源站</a></div><div class="widget"><div class="widget-title"><i class="fa fa-external-music"> 音乐</i></div></div><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=371362&auto=1&height=66"></iframe><div class="widget"><div class="widget-title"><i class="fa fa-external-game"> 游戏</i></div><ul></ul><a href="/2048" title="2048小游戏" target="_blank">2048小游戏</a><ul></ul><a href="/tantanqiu" title="变色弹球跳台阶小游戏" target="_blank">变色弹球跳台阶小游戏</a></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//yfshare.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">Jack Wang Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=2.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=2.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=2.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?3890bdc1bfaccae9364479b65f36fbd2";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=2.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=2.0.0"></script></div></body></html>